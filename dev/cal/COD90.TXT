OBJECT Codeunit 90 Purch.-Post
{
  OBJECT-PROPERTIES
  {
    Date=;
    Time=;
    Version List=NAVW114.04,4PS14.00,NAVSE.FI.DK.NO,4PSSE,EXF420000,PE8.00;
  }
  PROPERTIES
  {
    TableNo=38;
    Permissions=TableData 17=r,
                TableData 25=m,
                TableData 36=m,
                TableData 37=m,
                TableData 38=md,
                TableData 39=imd,
                TableData 49=imd,
                TableData 93=imd,
                TableData 94=imd,
                TableData 110=imd,
                TableData 111=imd,
                TableData 120=imd,
                TableData 121=imd,
                TableData 122=imd,
                TableData 123=imd,
                TableData 124=imd,
                TableData 125=imd,
                TableData 223=imd,
                TableData 5805=imd,
                TableData 6507=ri,
                TableData 6508=rid,
                TableData 6650=imd,
                TableData 6651=imd,
                TableData 2000000068=rimd;
    OnRun=VAR
            PurchHeader@1005 : Record 38;
            TempInvoicePostBuffer@1003 : TEMPORARY Record 49;
            TempVATAmountLine@1036 : TEMPORARY Record 290;
            TempVATAmountLineRemainder@1037 : TEMPORARY Record 290;
            TempDropShptPostBuffer@1000 : TEMPORARY Record 223;
            UpdateAnalysisView@1002 : Codeunit 410;
            UpdateItemAnalysisView@1008 : Codeunit 7150;
            EverythingInvoiced@1026 : Boolean;
            SavedPreviewMode@1043 : Boolean;
            SavedSuppressCommit@1042 : Boolean;
            BiggestLineNo@1021 : Integer;
            ICGenJnlLineNo@1004 : Integer;
            LineCount@1027 : Integer;
          BEGIN
            OnBeforePostPurchaseDoc(Rec,PreviewMode,SuppressCommit,HideProgressWindow);

            ValidatePostingAndDocumentDate(Rec);

            SavedPreviewMode := PreviewMode;
            SavedSuppressCommit := SuppressCommit;
            ClearAllVariables;
            PreviewMode := SavedPreviewMode;
            SuppressCommit := SavedSuppressCommit;

            //**4PS.sn
            "Receipts in Bundles" := ReceiptsInBundles;
            SetReceiveMarkedOnly(Rec);
            //**4PS.en

            GetGLSetup;
            GetCurrency("Currency Code");

            PurchSetup.GET;
            PurchHeader := Rec;
            FillTempLines(PurchHeader,TempPurchLineGlobal);

            //**4PS.sn
            PutPromisedReceiveDateFilter(TempPurchLineGlobal);
            PutReceiveMarkedOnlyFilter(TempPurchLineGlobal);
            //**4PS.en

            // Header
            CheckAndUpdate(PurchHeader);

            TempDeferralHeader.DELETEALL;
            TempDeferralLine.DELETEALL;

            // ExFlow
            CLEAR(ExFlowSetup);
            ExFlowSetupExists := ExFlowSetup.GET;
            IF ExFlowSetupExists THEN
              //ExFlow 190401
              IF ExFlowPurchPost.GetExflowPurchPost THEN
                EXIT;
              //ExFlow 190401
            // ExFlow

            TempInvoicePostBuffer.DELETEALL;
            TempDropShptPostBuffer.DELETEALL;
            //**4PS.sn
            TempSurchargePostingBuffer[1].DELETEALL;
            TempRequisitionPostingBuffer[1].DELETEALL;
            TempComplWIPPostingBuffer[1].DELETEALL;
            TempRetentionPostingBuffer[1].DELETEALL;
            //**4PS.en
            EverythingInvoiced := TRUE;

            //**4PS.sn, RFC 337
            IF ("Document Type" = "Document Type"::Invoice) AND ("Related Purch. Order No." <> '') THEN
              FillRetentionPostingBufferWar(PurchHeader);
            //**4PS.en

            // Lines
            OnBeforePostLines(TempPurchLineGlobal,PurchHeader,PreviewMode,SuppressCommit);

            LineCount := 0;
            RoundingLineInserted := FALSE;
            AdjustFinalInvWith100PctPrepmt(TempPurchLineGlobal);

            TempVATAmountLineRemainder.DELETEALL;
            TempPurchLineGlobal.CalcVATAmountLines(1,PurchHeader,TempPurchLineGlobal,TempVATAmountLine);

            PurchaseLinesProcessed := FALSE;
            IF TempPurchLineGlobal.FINDSET THEN
              REPEAT
                ItemJnlRollRndg := FALSE;
                LineCount := LineCount + 1;
                IF GUIALLOWED AND NOT HideProgressWindow THEN
                  Window.UPDATE(2,LineCount);

                PostPurchLine(
                  PurchHeader,TempPurchLineGlobal,TempInvoicePostBuffer,TempVATAmountLine,TempVATAmountLineRemainder,
                  TempDropShptPostBuffer,EverythingInvoiced,ICGenJnlLineNo);

                IF RoundingLineInserted THEN
                  LastLineRetrieved := TRUE
                ELSE BEGIN
                  BiggestLineNo := MAX(BiggestLineNo,TempPurchLineGlobal."Line No.");
                  LastLineRetrieved := TempPurchLineGlobal.NEXT = 0;

                  // ExFlow
                  //IF LastLineRetrieved AND PurchSetup."Invoice Rounding" THEN
                  //>>141117
                  //IF NOT ExFlowSetup.GET(COMPANYNAME,0) THEN
                  IF (NOT ExFlowSetup.READPERMISSION) OR (NOT ExFlowSetup.GET) THEN
                  //<<141117
                    CLEAR(ExFlowSetup);
                  IF LastLineRetrieved AND (PurchSetup."Invoice Rounding" OR ExFlowSetup."Invoice Rounding") THEN
                  // ExFlow

                    InvoiceRounding(PurchHeader,TempPurchLineGlobal,FALSE,BiggestLineNo);
                END;
              UNTIL LastLineRetrieved;

            OnAfterPostPurchLines(
              PurchHeader,PurchRcptHeader,PurchInvHeader,PurchCrMemoHeader,ReturnShptHeader,WhseShip,WhseReceive,PurchaseLinesProcessed,
              SuppressCommit,EverythingInvoiced);

            PostPlantOrderChargePurch(); //**4PS.n (C001519)

            IF PurchHeader.IsCreditDocType THEN BEGIN
              ReverseAmount(TotalPurchLine);
              ReverseAmount(TotalPurchLineLCY);
            END;

            // Post combine shipment of sales order
            PostCombineSalesOrderShipment(PurchHeader,TempDropShptPostBuffer);

            IF PurchHeader.Invoice THEN
              PostGLAndVendor(PurchHeader,TempInvoicePostBuffer);

            IF ICGenJnlLineNo > 0 THEN
              PostICGenJnl;

            //**4PS.sn
            PostSurchargePostingBuffer(PurchHeader);
            PostRequisitionPostingBuffer(PurchHeader);
            PostComplWIPPostingBuffer(PurchHeader);
            //**4PS.en

            MakeInventoryAdjustment;
            UpdateLastPostingNos(PurchHeader);

            OnRunOnBeforeFinalizePosting(
              PurchHeader,PurchRcptHeader,PurchInvHeader,PurchCrMemoHeader,ReturnShptHeader,GenJnlPostLine,SuppressCommit);

            FinalizePosting(PurchHeader,TempDropShptPostBuffer,EverythingInvoiced);

            Rec := PurchHeader;

            IF NOT (InvtPickPutaway OR SuppressCommit) THEN BEGIN
              COMMIT;
              UpdateAnalysisView.UpdateAll(0,TRUE);
              UpdateItemAnalysisView.UpdateAll(0,TRUE);
            END;

            OnAfterPostPurchaseDoc(
              Rec,GenJnlPostLine,PurchRcptHeader."No.",ReturnShptHeader."No.",PurchInvHeader."No.",PurchCrMemoHeader."No.",
              SuppressCommit);
            OnAfterPostPurchaseDocDropShipment(SalesShptHeader."No.",SuppressCommit);
          END;

  }
  CODE
  {
    VAR
      NothingToPostErr@1000 : TextConst 'ENU=There is nothing to post.;NOR=Det finnes ingenting † bokf›re.;SVE=Det finns inget att bokf”ra.';
      DropShipmentErr@1001 : TextConst 'ENU=A drop shipment from a purchase order cannot be received and invoiced at the same time.;NOR=En direkte levering av en bestilling kan ikke mottas og faktureres samtidig.;SVE=En direktutleverans fr†n en ink”psorder kan inte samtidigt inlevereras och faktureras.';
      PostingLinesMsg@1004 : TextConst '@@@=Counter;ENU=Posting lines              #2######\;NOR=Bokf›rer linjer            #2######\;SVE=Bokf”ring rader            #2######\';
      PostingPurchasesAndVATMsg@1005 : TextConst '@@@=Counter;ENU=Posting purchases and VAT  #3######\;NOR=Bokf›rer kj›p og mva.      #3######\;SVE=Bokf. ink”p och moms       #3######\';
      PostingVendorsMsg@1006 : TextConst '@@@=Counter;ENU=Posting to vendors         #4######\;NOR=Bokf›rer til leverand›rer  #4######\;SVE=Bokf. till leverant”rer    #4######\';
      PostingBalAccountMsg@1007 : TextConst '@@@=Counter;ENU=Posting to bal. account    #5######;NOR=Bokf›rer til motkonto      #5######;SVE=Bokf”ring till motkonto    #5######';
      PostingLines2Msg@1008 : TextConst '@@@=Counter;ENU=Posting lines         #2######;NOR=Bokf›rer linjer            #2######;SVE=Bokf”ring rader            #2######';
      InvoiceNoMsg@1009 : TextConst '@@@="%1 = Document Type, %2 = Document No, %3 = Invoice No.";ENU=%1 %2 -> Invoice %3;NOR=%1 %2 -> Faktura %3;SVE=%1 %2 -> Faktura %3';
      CreditMemoNoMsg@1010 : TextConst '@@@="%1 = Document Type, %2 = Document No, %3 = Credit Memo No.";ENU=%1 %2 -> Credit Memo %3;NOR=%1 %2 -> Kreditnota %3;SVE=%1 %2 -> Kreditnota %3';
      CannotInvoiceBeforeAssocSalesOrderErr@1002 : TextConst '@@@="%1 = Document No.";ENU=You cannot invoice this purchase order before the associated sales orders have been invoiced. Please invoice sales order %1 before invoicing this purchase order.;NOR=Du kan ikke fakturere denne bestillingen f›r de tilh›rende ordrene er fakturert. Fakturer ordre %1 f›r du fakturerer denne bestillingen.;SVE=Du kan inte fakturera ink”psordern innan associerade f”rs„ljningsorder har fakturerats. Fakturera f”rs„ljningsorder %1 innan du fakturerar ink”psordern.';
      ReceiptSameSignErr@1011 : TextConst 'ENU=must have the same sign as the receipt;NOR=m† ha samme fortegn som mottaket;SVE=m†ste ha samma tecken som inleveransen';
      ReceiptLinesDeletedErr@1012 : TextConst 'ENU=Receipt lines have been deleted.;NOR=Mottakslinjer er slettet.;SVE=Inleveransraderna har tagits bort.';
      CannotPurchaseResourcesErr@1013 : TextConst 'ENU=You cannot purchase resources.;NOR=Du kan ikke kj›pe ressurser.;SVE=Du kan inte k”pa in resurser.';
      PurchaseAlreadyExistsErr@1014 : TextConst '@@@="%1 = Document Type, %2 = Document No.";ENU=Purchase %1 %2 already exists for this vendor.;NOR=Kj›p %1 %2 finnes allerede for denne leverand›ren.;SVE=Ink”pet %1 %2 finns redan f”r leverant”ren.';
      InvoiceMoreThanReceivedErr@1015 : TextConst '@@@="%1 = Order No.";ENU=You cannot invoice order %1 for more than you have received.;NOR=Du kan ikke fakturere bestilling %1 for mer enn du har mottatt.;SVE=Du kan inte fakturera order %1 f”r mer „n vad du har erh†llit.';
      CannotPostBeforeAssosSalesOrderErr@1016 : TextConst '@@@="%1 = Sales Order No.";ENU=You cannot post this purchase order before the associated sales orders have been invoiced. Post sales order %1 before posting this purchase order.;NOR=Du kan ikke bokf›re denne bestillingen f›r de tilh›rende ordrene er fakturert. Bokf›r ordre %1 f›r du bokf›rer denne bestillingen.;SVE=Du kan inte bokf”ra ink”psordern innan associerade f”rs„ljningsorder har fakturerats. Bokf”r f”rs„ljningsorder %1 innan du bokf”r ink”psordern.';
      ExtDocNoNeededErr@1183 : TextConst '@@@="%1 = Field caption of e.g. Vendor Invoice No.";ENU=You need to enter the document number of the document from the vendor in the %1 field, so that this document stays linked to the original.;NOR=Du m† angi dokumentnummeret for dokumentet fra leverand›ren i feltet %1, slik at dette dokumentet forblir tilknyttet originalen.;SVE=Du m†ste ange dokumentnumret f”r dokumentet fr†n leverant”ren i f„ltet %1, s† att det h„r dokumentet f”rblir kopplat till det ursprungliga.';
      VATAmountTxt@1017 : TextConst 'ENU=VAT Amount;NOR=Mva-bel›p;SVE=Momsbelopp';
      VATRateTxt@1018 : TextConst '@@@="%1 = VAT Rate";ENU=%1% VAT;NOR=%1% Mva.;SVE=%1% moms';
      BlanketOrderQuantityGreaterThanErr@1019 : TextConst '@@@="%1 = Quantity";ENU=in the associated blanket order must not be greater than %1;NOR=i tilh›rende rammebestilling kan ikke v‘re st›rre enn %1;SVE=i den kopplade avropsordern, f†r inte vara st”rre „n %1';
      BlanketOrderQuantityReducedErr@1020 : TextConst 'ENU=in the associated blanket order must be reduced;NOR=i tilh›rende rammebestilling m† reduseres;SVE=i den kopplade avropsordern, m†ste reduceras';
      ReceiveInvoiceShipErr@1021 : TextConst 'ENU=Please enter "Yes" in Receive and/or Invoice and/or Ship.;NOR=Skriv Ja i Motta og/eller Faktura og/eller Levere.;SVE=Ange "Ja" i Inleverera och/eller Faktura och/eller Leverera.';
      WarehouseRequiredErr@1022 : TextConst '@@@="%1/%2 = Document Type, %3/%4 - Document No.,%5/%6 = Line No.";ENU="Warehouse handling is required for %1 = %2, %3 = %4, %5 = %6.";NOR="Det kreves lagerh†ndtering for %1 = %2, %3 = %4, %5 = %6.";SVE="Dist.lager hantering kr„vs f”r %1 = %2, %3 = %4, %5 = %6."';
      ReturnShipmentSamesSignErr@1024 : TextConst 'ENU=must have the same sign as the return shipment;NOR=m† ha samme fortegn som returforsendelsen;SVE=m†ste ha samma tecken som returutleveransen';
      ReturnShipmentInvoicedErr@1025 : TextConst '@@@="%1 = Line No., %2 = Document No.";ENU=Line %1 of the return shipment %2, which you are attempting to invoice, has already been invoiced.;NOR=Linje %1 i returforsendelse %2, som du fors›ker † fakturere, er allerede bokf›rt.;SVE=Rad %1 i returutleveransen %2 som du f”rs”ker att fakturera har redan fakturerats.';
      ReceiptInvoicedErr@1026 : TextConst '@@@="%1 = Line No., %2 = Document No.";ENU=Line %1 of the receipt %2, which you are attempting to invoice, has already been invoiced.;NOR=Linje %1 p† mottaksseddel %2, som du pr›ver † fakturere, er allerede fakturert.;SVE=Rad %1 p† inleveransen %2 som du f”rs”ker att fakturera har redan fakturerats.';
      QuantityToInvoiceGreaterErr@1027 : TextConst '@@@="%1 = Receipt No.";ENU=The quantity you are attempting to invoice is greater than the quantity in receipt %1.;NOR=Antallet du fors›ker † fakturere, er st›rre enn antallet i mottaksseddel %1.;SVE=Antalet som du f”rs”ker fakturera „r st”rre „n antalet i inleveransen %1.';
      CannotAssignMoreErr@1032 : TextConst '@@@="%1 = Quantity, %2/%3 = Document Type, %4/%5 - Document No.,%6/%7 = Line No.";ENU="You cannot assign more than %1 units in %2 = %3,%4 = %5,%6 = %7.";NOR="Du kan ikke tilordne mer enn %1 enheter til %2 = %3,%4 = %5,%6 = %7.";SVE="Du kan inte tilldela mer „n %1 enheter i %2 = %3,%4 = %5,%6 = %7."';
      MustAssignErr@1033 : TextConst 'ENU=You must assign all item charges, if you invoice everything.;NOR=Du m† tilordne alle varegebyr hvis du fakturerer alt.;SVE=Du m†ste f”rdela alla artikelomkostnader om du fakturerar allt.';
      CannotAssignInvoicedErr@1034 : TextConst '@@@="%1 = Purchase Line, %2/%3 = Document Type, %4/%5 - Document No.,%6/%7 = Line No.";ENU="You cannot assign item charges to the %1 %2 = %3,%4 = %5, %6 = %7, because it has been invoiced.";NOR="Du kan ikke tilordne varegebyr til %1 %2 = %3,%4 = %5, %6 = %7, fordi faktureringen er ferdig.";SVE="Du kan inte f”rdela artikelomkostnader till %1 %2 = %3,%4 = %5, %6 = %7, d„rf”r att den har fakturerats."';
      PurchSetup@1037 : Record 312;
      GLSetup@1038 : Record 98;
      GLEntry@1039 : Record 17;
      TempPurchLineGlobal@1040 : TEMPORARY Record 39;
      JobPurchLine@1169 : Record 39;
      TotalPurchLine@1043 : Record 39;
      TotalPurchLineLCY@1044 : Record 39;
      xPurchLine@1046 : Record 39;
      PurchLineACY@1047 : Record 39;
      PurchRcptHeader@1048 : Record 120;
      PurchInvHeader@1050 : Record 122;
      PurchCrMemoHeader@1052 : Record 124;
      ReturnShptHeader@1054 : Record 6650;
      SalesShptHeader@1058 : Record 110;
      TempItemChargeAssgntPurch@1060 : TEMPORARY Record 5805;
      SourceCodeSetup@1065 : Record 242;
      Currency@1073 : Record 4;
      VendLedgEntry@1075 : Record 25;
      WhseRcptHeader@1023 : Record 7316;
      TempWhseRcptHeader@1142 : TEMPORARY Record 7316;
      WhseShptHeader@1143 : Record 7320;
      TempWhseShptHeader@1145 : TEMPORARY Record 7320;
      PostedWhseRcptHeader@1140 : Record 7318;
      PostedWhseRcptLine@1146 : Record 7319;
      PostedWhseShptHeader@1147 : Record 7322;
      PostedWhseShptLine@1151 : Record 7323;
      Location@1085 : Record 14;
      TempHandlingSpecification@1094 : TEMPORARY Record 336;
      TempTrackingSpecification@1137 : TEMPORARY Record 336;
      TempTrackingSpecificationInv@1158 : TEMPORARY Record 336;
      TempWhseSplitSpecification@1160 : TEMPORARY Record 336;
      TempValueEntryRelation@5555 : TEMPORARY Record 6508;
      Job@1093 : Record 11072003;
      TempICGenJnlLine@11093 : TEMPORARY Record 81;
      TempPrepmtDeductLCYPurchLine@1190 : TEMPORARY Record 39;
      TempSKU@1081 : TEMPORARY Record 5700;
      DeferralPostBuffer@1049 : Record 1706;
      TempDeferralHeader@1003 : TEMPORARY Record 1701;
      TempDeferralLine@1035 : TEMPORARY Record 1702;
      ErrorMessageMgt@1061 : Codeunit 28;
      GenJnlPostLine@1087 : Codeunit 12;
      ItemJnlPostLine@1089 : Codeunit 22;
      SalesTaxCalculate@1091 : Codeunit 398;
      ReservePurchLine@1092 : Codeunit 99000834;
      ApprovalsMgmt@1250 : Codeunit 1535;
      WhsePurchRelease@1097 : Codeunit 5772;
      SalesPost@1101 : Codeunit 80;
      ItemTrackingMgt@1138 : Codeunit 6500;
      WhseJnlPostLine@1100 : Codeunit 7301;
      WhsePostRcpt@1148 : Codeunit 5760;
      WhsePostShpt@1149 : Codeunit 5763;
      CostCalcMgt@1162 : Codeunit 5836;
      JobPostLine@1172 : Codeunit 11072006;
      ServItemMgt@1063 : Codeunit 5920;
      DeferralUtilities@1051 : Codeunit 1720;
      UOMMgt@1028 : Codeunit 5402;
      Window@1102 : Dialog;
      Usedate@1104 : Date;
      GenJnlLineDocNo@1105 : Code[20];
      GenJnlLineExtDocNo@1106 : Code[35];
      SrcCode@1107 : Code[10];
      ItemLedgShptEntryNo@1108 : Integer;
      GenJnlLineDocType@1110 : Integer;
      FALineNo@1111 : Integer;
      RoundingLineNo@1112 : Integer;
      DeferralLineNo@1053 : Integer;
      InvDefLineNo@1064 : Integer;
      RemQtyToBeInvoiced@1114 : Decimal;
      RemQtyToBeInvoicedBase@1115 : Decimal;
      RemAmt@1135 : Decimal;
      RemDiscAmt@1136 : Decimal;
      TotalChargeAmt@1042 : Decimal;
      TotalChargeAmtLCY@1041 : Decimal;
      LastLineRetrieved@1119 : Boolean;
      RoundingLineInserted@1120 : Boolean;
      DropShipOrder@1121 : Boolean;
      GLSetupRead@1130 : Boolean;
      InvoiceGreaterThanReturnShipmentErr@1098 : TextConst '@@@="%1 = Return Shipment No.";ENU=The quantity you are attempting to invoice is greater than the quantity in return shipment %1.;NOR=Antallet du fors›ker † fakturere, er st›rre enn antallet i returforsendelse %1.;SVE=Antalet som du f”rs”ker fakturera „r st”rre „n antalet i returutleveransen %1.';
      ReturnShipmentLinesDeletedErr@1099 : TextConst 'ENU=Return shipment lines have been deleted.;NOR=Returforsendelseslinjene er slettet.;SVE=Returutleveransraderna har tagits bort.';
      InvoiceMoreThanShippedErr@1132 : TextConst '@@@="%1 = Order No.";ENU=You cannot invoice return order %1 for more than you have shipped.;NOR=Du kan ikke fakturere bestillingsretur %1 for mer enn du har levert.;SVE=Du kan inte fakturera returorder %1 f”r mer „n vad du har levererat.';
      RelatedItemLedgEntriesNotFoundErr@1165 : TextConst 'ENU=Related item ledger entries cannot be found.;NOR=Finner ikke relaterte vareposter.;SVE=Knutna artikeltransaktioner kan inte hittas.';
      ItemTrackingWrongSignErr@1173 : TextConst 'ENU=Item Tracking is signed wrongly.;NOR=Varesporing er feil signert.;SVE=Artikelsp†rning „r felaktigt signerat.';
      ItemTrackingMismatchErr@1163 : TextConst 'ENU=Item Tracking does not match.;NOR=Varesporingen har ingen treff.;SVE=Artikelsp†rning matchar inte.';
      PostingDateNotAllowedErr@1155 : TextConst '@@@=%1 - Posting Date field caption;ENU=%1 is not within your range of allowed posting dates.;NOR=%1 er ikke innenfor omr†det for tillatte bokf›ringsdatoer.;SVE=„r inte i ditt till†tna intervall f”r bokf”ringsdatum';
      ItemTrackQuantityMismatchErr@1144 : TextConst 'ENU=The %1 does not match the quantity defined in item tracking for item %2.;NOR=%1 samsvarer ikke med antallet som er definert i varesporing.;SVE=%1 st„mmer inte med det antal som har angetts vid artikelsp†rning.';
      CannotBeGreaterThanErr@1141 : TextConst '@@@="%1 = Amount";ENU=cannot be more than %1.;NOR=kan ikke v‘re mer enn %1.;SVE=f†r inte vara st”rre „n %1';
      CannotBeSmallerThanErr@1129 : TextConst '@@@="%1 = Amount";ENU=must be at least %1.;NOR=m† v‘re minst %1.;SVE=m†ste vara minst %1.';
      ItemJnlRollRndg@1134 : Boolean;
      WhseReceive@1113 : Boolean;
      WhseShip@1150 : Boolean;
      InvtPickPutaway@1154 : Boolean;
      PositiveWhseEntrycreated@1191 : Boolean;
      PrepAmountToDeductToBigErr@1177 : TextConst '@@@="%1 = Prepmt Amt to Deduct, %2 = Max Amount";ENU=The total %1 cannot be more than %2.;NOR=Totalen %1 kan ikke v‘re mer enn %2.;SVE=Summan %1 kan inte vara mer „n %2.';
      PrepAmountToDeductToSmallErr@1178 : TextConst '@@@="%1 = Prepmt Amt to Deduct, %2 = Max Amount";ENU=The total %1 must be at least %2.;NOR=Totalen %1 m† v‘re minst %2.;SVE=Summan %1 m†ste vara minst %2.';
      UnpostedInvoiceDuplicateQst@1175 : TextConst '@@@="%1 = Order No.,%2 = Invoice No.";ENU=An unposted invoice for order %1 exists. To avoid duplicate postings, delete order %1 or invoice %2.\Do you still want to post order %1?;NOR=Det finnes en ikke-bokf›rt faktura for ordren %1. Slett ordren %1 eller fakturaen %2 for † unng† duplikatbokf›ringer.\Vil du likevel bokf›re ordren %1?;SVE=Det finns en ej bokf”rd faktura f”r ordern %1. Ta bort ordern %1 eller fakturan %2 om du vill undvika dubbla bokf”ringar.\Vill du fortfarande bokf”ra ordern %1?';
      InvoiceDuplicateInboxQst@1176 : TextConst '@@@="%1 = Order No.";ENU=An invoice for order %1 exists in the IC inbox. To avoid duplicate postings, cancel invoice %2 in the IC inbox.\Do you still want to post order %1?;NOR=Det finnes allerede en faktura for ordren %1 i KI-innboksen. Kanseller fakturaen %2 i KI-innboksen for † unng† duplikatbokf›ringer.\Vil du likevel bokf›re ordren %1?;SVE=Det finns en faktura f”r ordern %1 i den koncerninterna inkorgen. Annullera fakturan %2 i den koncerninterna inkorgen om du vill undvika dubbla bokf”ringar.\Vill du fortfarande bokf”ra ordern %1?';
      PostedInvoiceDuplicateQst@1179 : TextConst '@@@="%1 = Invoice No., %2 = Order No.";ENU=Posted invoice %1 already exists for order %2. To avoid duplicate postings, do not post order %2.\Do you still want to post order %2?;NOR=Den bokf›rte fakturaen %1 finnes allerede for ordren %2. La v‘re † bokf›re ordren %2 for † unng† duplikatbokf›ringer.\Vil du likevel bokf›re ordren %2?;SVE=Den bokf”rda fakturan %1 finns redan f”r ordern %2. Bokf”r inte ordern %2 om du vill undvika dubbla bokf”ringar.\Vill du fortfarande bokf”ra ordern %2?';
      OrderFromSameTransactionQst@1180 : TextConst '@@@="%1 = Order No., %2 = Invoice No.";ENU=Order %1 originates from the same IC transaction as invoice %2. To avoid duplicate postings, delete order %1 or invoice %2.\Do you still want to post invoice %2?;NOR=Ordren %1 stammer fra den samme KI-transaksjonen som fakturaen %2. Slett ordren %1 eller fakturaen %2 for † unng† duplikatbokf›ringer.\Vil du likevel bokf›re fakturaen %2?;SVE=Ordern %1 h„rstammar fr†n samma koncerninterna transaktion som fakturan %2. Ta bort ordern %1 eller fakturan %2 om du vill undvika dubbla bokf”ringar.\Vill du fortfarande bokf”ra fakturan %2?';
      DocumentFromSameTransactionQst@1181 : TextConst '@@@="%1 and %2 = Document No.";ENU=A document originating from the same IC transaction as document %1 exists in the IC inbox. To avoid duplicate postings, cancel document %2 in the IC inbox.\Do you still want to post document %1?;NOR=Det finnes allerede et dokument som stammer fra den samme KI-transaksjonen som dokumentet %1 i KI-innboksen. Kanseller dokumentet %2 i KI-innboksen for † unng† duplikatbokf›ringer.\Vil du likevel bokf›re dokumentet %1?;SVE=Ett dokument som h„rstammar fr†n samma transaktion som dokumentet %1 finns i den koncerninterna inkorgen. Annullera dokumentet %2 i den koncerninterna inkorgen om du vill undvika dubbla bokf”ringar.\Vill du fortfarande bokf”ra dokumentet %1?';
      PostedInvoiceFromSameTransactionQst@1182 : TextConst '@@@="%1 and %2 = Invoice No.";ENU=Posted invoice %1 originates from the same IC transaction as invoice %2. To avoid duplicate postings, do not post invoice %2.\Do you still want to post invoice %2?;NOR=Den bokf›rte fakturaen %1 stammer fra den samme KI-transaksjonen som fakturaen %2. La v‘re † bokf›re fakturaen %2 for † unng† duplikatbokf›ringer.\Vil du likevel bokf›re fakturaen %2?;SVE=Den bokf”rda fakturan %1 h„rstammar fr†n samma koncerninterna transaktion som fakturan %2. Bokf”r inte fakturan %2 om du vill undvika dubbla bokf”ringar.\Vill du fortfarande bokf”ra fakturan %2?';
      MustAssignItemChargeErr@1102601000 : TextConst '@@@="%1 = Item Charge No.";ENU=You must assign item charge %1 if you want to invoice it.;NOR=Du m† tilordne varegebyret %1 hvis du vil fakturere det.;SVE=Du m†ste tilldela artikelomkostnaden %1 om du vill fakturera den.';
      CannotInvoiceItemChargeErr@1102601001 : TextConst '@@@="%1 = Item Charge No.";ENU=You can not invoice item charge %1 because there is no item ledger entry to assign it to.;NOR=Du kan ikke fakturere varegebyret %1 fordi det ikke finnes noen tilordnet varepost.;SVE=Du kan inte fakturera artikelomkostnaden %1 eftersom det inte finns n†gon artikeltransaktion att tilldela den till.';
      PurchaseLinesProcessed@1080 : Boolean;
      ReservationDisruptedQst@1200 : TextConst '@@@="One or more reservation entries exist for the item with No. = 1000, Location Code = SILVER, Variant Code = NEW which may be disrupted if you post this negative adjustment. Do you want to continue?";ENU="One or more reservation entries exist for the item with %1 = %2, %3 = %4, %5 = %6 which may be disrupted if you post this negative adjustment. Do you want to continue?";NOR="n eller flere reservasjonsposter finnes for varen med %1 = %2, %3 = %4, %5 = %6, som kan avbrutt hvis du bokf›rer denne nedjusteringen. Vil du fortsette?";SVE="Det finns en eller flera reservationstransaktioner f”r artikeln med %1 = %2, %3 = %4, %5 = %6 som kan avbrytas om du bokf”r den h„r negativa justeringen. Vill du forts„tta?"';
      ReassignItemChargeErr@1199 : TextConst 'ENU=The order line that the item charge was originally assigned to has been fully posted. You must reassign the item charge to the posted receipt or shipment.;NOR=Ordrelinjen som varegebyret opprinnelig ble tilordnet til, er fullstendig bokf›rt. Du m† tilordne varegebyret p† nytt til det bokf›rte mottaket eller den bokf›rte f›lgeseddelen.;SVE=Orderraden som artikelomkostnaden ursprungligen tilldelades har bokf”rts. Du m†ste omtilldela artikelomkostnaden till den bokf”rda in- eller utleveransen.';
      PreviewMode@1036 : Boolean;
      NoDeferralScheduleErr@1068 : TextConst '@@@="%1=The item number of the sales transaction line, %2=The Deferral Template Code";ENU=You must create a deferral schedule because you have specified the deferral code %2 in line %1.;NOR=Du m† opprette en tidsplan for periodisering fordi du har angitt periodiseringskoden %2 i linje %1.;SVE=Du m†ste skapa ett periodiseringsschema eftersom du har angett periodiseringskod %2 p† rad %1.';
      ZeroDeferralAmtErr@1067 : TextConst '@@@="%1=The item number of the sales transaction line, %2=The Deferral Template Code";ENU=Deferral amounts cannot be 0. Line: %1, Deferral Template: %2.;NOR=Periodiseringsbel›p kan ikke v‘re 0. Linje: %1, periodiseringsmal: %2.;SVE=Periodiseringsbelopp f†r inte vara 0. Rad: %1, Periodiseringsmall: %2.';
      MixedDerpFAUntilPostingDateErr@1268 : TextConst '@@@=%1 - Fixed Asset No.;ENU=The value in the Depr. Until FA Posting Date field must be the same on lines for the same fixed asset %1.;NOR=Verdien i feltet Avskr. frem til aktivabokf.dato skal v‘re lik p† linjer for samme aktiva %1.';
      CannotPostSameMultipleFAWhenDeprBookValueZeroErr@1274 : TextConst '@@@=%1 - Fixed Asset No.;ENU=You cannot select the Depr. Until FA Posting Date check box because there is no previous acquisition entry for fixed asset %1.\\If you want to depreciate new acquisitions, you can select the Depr. Acquisition Cost check box instead.;NOR=Du kan ikke merke av for Avskr. frem til aktivabokf.dato fordi det ikke finnes en tidligere anskaffelsespost for aktivaet %1.\\Hvis du vil skrive av nye anskaffelser, merker du av for Avskr.anskaffelseskost i stedet.';
      PostingPreviewNoTok@1241 : TextConst '@@@={Locked};ENU=***;NOR=***';
      InvPickExistsErr@1057 : TextConst 'ENU=One or more related inventory picks must be registered before you can post the shipment.;NOR=n eller flere relaterte lagerplukkinger m† registreres f›r du kan bokf›re leveringen.';
      InvPutAwayExistsErr@1056 : TextConst 'ENU=One or more related inventory put-aways must be registered before you can post the receipt.;NOR=n eller flere relaterte lagerplasseringer m† registreres f›r du kan bokf›re kvitteringen.';
      SuppressCommit@1062 : Boolean;
      CheckPurchHeaderMsg@1066 : TextConst 'ENU=Check purchase document fields.;NOR=Kontroller felt i kj›psdokument.';
      HideProgressWindow@1029 : Boolean;
      Text11012000@1100525014 : TextConst 'ENU=must be WIP Account %1;NOR=m† v‘re konto for arbeidskapital %1;SVE=m†ste vara kontot f”r p†g†ende arbeten %1';
      Text11012002@1100525013 : TextConst 'ENU=%1 may not exceed %2 in %3 %4;NOR=%1 kan ikke overstige %2 i %3 %4;SVE=%1 f†r inte ”verstiga %2 i %3 %4';
      Text11012004@1100525011 : TextConst 'ENU=(%1) is not equal to entries balance (%2)';
      Text11012005@1100525010 : TextConst 'ENU=%1 must be specified.;NOR=%1 m† spesifiseres.;SVE=%1 m†ste specificeras.';
      Text11012006@1100525009 : TextConst 'ENU=Account at Bank Account %1 from Vendor %2 is empty.;NOR=Bankkonto %1 fra leverand›r %2 er tom.;SVE=Bankkontot %1 fr†n leverant”ren %2 „r tomt.';
      Text11012007@1100525008 : TextConst 'ENU=Bank Account does not match with Bank No. Check.;NOR=Bankkonto matcher ikke Banknr. Kontroller.;SVE=Bankkonto matchar inte banknr. M†ste kontrolleras.';
      Text11012008@1100525007 : TextConst 'ENU=must be negative for a return order;NOR=m† v‘re negativ for en returordre;SVE=m†ste vara negativt f”r en returorder';
      Text11012009@1100525006 : TextConst 'ENU=Note: There are receipts posted for Plant Order(s): %1.;NOR=Obs! Det finnes inng†ende leveranser som er bokf›rt for maskinordre: %1.;SVE=Obs! Det finns inleveranser som har bokf”rts f”r Maskinsorder: %1.';
      Text11012010@1100525005 : TextConst 'ENU=Order %2 already has an invoice (%1). For this order you can only post receipts.;NOR=Ordre %2 har allerede en faktura (%1). For denne ordren kan du kun bokf›re inng†ende leveranser.;SVE=Order %2 har redan en faktura (%1). F”r denna order kan du endast bokf”ra inleveranser.';
      Text11012013@1100525004 : TextConst 'ENU=%1 %2: %3;NOR=%1 %2: %3;SVE=%1 %2: %3';
      Text11012019@1100525002 : TextConst 'ENU=You must specify either %1 or %2.;NOR=Du m† angi %1 eller %2.;SVE=Du m†ste ange %1 eller %2.';
      Text11012020@1100525001 : TextConst 'ENU=Posting receipt is not allowed. %1 is empty in %2 %3.';
      PurchaseHeaderExtension@1100525015 : Record 11020398;
      NoErrorNothingToPost@1100525016 : Boolean;
      RemAmntToBeInvoiced@1100525017 : Decimal;
      OnHoldRec@1100525018 : Record 11012031;
      RetentionType@1100525021 : 'No Retention,Contract,Warranty';
      DocumentRetentionAmount@1100525022 : Decimal;
      CurrExchRate@1100525023 : Record 330;
      Project@1100525024 : Record 11072003;
      ProjectType@1100525025 : Record 11012009;
      PurchHeaderInvToApprove@1100525026 : Record 38;
      ReplaceDocLink@1100525027 : Boolean;
      ReceiptForPlantOrders@1100525028 : Text[250];
      PlotNoReceipts@1100525029 : Code[10];
      PostPlantEntry@1100525030 : Codeunit 11012569;
      ReceiptsInBundles@1100525031 : Boolean;
      JobLedgEntryNo@1100525032 : Integer;
      ServLedgEntryNo@1100525033 : Integer;
      JobJnlPostLine@1100525034 : Codeunit 11072003;
      ServJnlPostLine@1100525035 : Codeunit 11012802;
      ProjectInventoryPostLine@1100525040 : Codeunit 11012670;
      TempSurchargePostingBuffer@1100525038 : ARRAY [2] OF TEMPORARY Record 49;
      TempRequisitionPostingBuffer@1100525037 : ARRAY [2] OF TEMPORARY Record 49;
      TempComplWIPPostingBuffer@1100525036 : ARRAY [2] OF TEMPORARY Record 49;
      TempRetentionPostingBuffer@1100525043 : ARRAY [2] OF TEMPORARY Record 49;
      TempPlantLocChargePO@1100525039 : TEMPORARY Record 11012579;
      SkipClearAll@1100525041 : Boolean;
      UptoPromisedReceiveDate@1100525042 : Date;
      NSItemTrackingEntriesApply@1100525044 : Codeunit 11012352;
      ReceiveMarkedOnly@1100525046 : Boolean;
      Text11012021@1100529600 : TextConst 'ENU=Deferral Code must not be specified when the document is an intercompany transaction.;SVE=Kod f”r periodisering f†r inte anges vid koncernintern transaktion.';
      NothingToPostFlag@1100529601 : Boolean;
      InwRegHeader@1070001 : Record 11128010;
      InwRegReverse@1070000 : Codeunit 11128013;
      "*** ExFlow ***"@12013587 : Integer;
      ExFlowPurchPost@12013588 : Codeunit 12013603;
      ExFlowSetup@12013589 : Record 12013601;
      ExFlowSetupExists@12013590 : Boolean;
      FPSLicenseManagement@1100527400 : Codeunit 11229289;
      LoanJnlPostLine@1100528500 : Codeunit 11012627;
      NegativeOrderQuantity@1100528200 : Boolean;

    [External]
    PROCEDURE CopyToTempLines@174(PurchHeader@1001 : Record 38;VAR TempPurchLine@1002 : TEMPORARY Record 39);
    VAR
      PurchLine@1000 : Record 39;
    BEGIN
      PurchLine.SETRANGE("Document Type",PurchHeader."Document Type");
      PurchLine.SETRANGE("Document No.",PurchHeader."No.");
      OnCopyToTempLinesOnAfterSetFilters(PurchLine,PurchHeader);
      IF PurchLine.FINDSET THEN
        REPEAT
          TempPurchLine := PurchLine;
          TempPurchLine.INSERT;
        UNTIL PurchLine.NEXT = 0;
    END;

    [External]
    PROCEDURE FillTempLines@36(PurchHeader@1000 : Record 38;VAR TempPurchLine@1001 : TEMPORARY Record 39);
    BEGIN
      TempPurchLine.RESET;
      //>> 190509 ORANGO.SB
      TempPurchLineGlobal.DELETEALL(FALSE);
      //<<
      IF TempPurchLine.ISEMPTY THEN
        CopyToTempLines(PurchHeader,TempPurchLine);
    END;

    LOCAL PROCEDURE ModifyTempLine@171(VAR TempPurchLineLocal@1000 : TEMPORARY Record 39);
    VAR
      PurchLine@1001 : Record 39;
    BEGIN
      //**4PS.so
      //TempPurchLineLocal.MODIFY;
      //PurchLine := TempPurchLineLocal;
      //PurchLine.MODIFY;
      //**4PS.eo

      //**4PS.sn
      PurchLine.GET(TempPurchLineLocal."Document Type", TempPurchLineLocal."Document No.", TempPurchLineLocal."Line No.");
      RestorePurchLineFixedAssetNo(PurchLine, TempPurchLineLocal );
      TempPurchLineLocal.MODIFY;
      PurchLine.TRANSFERFIELDS(TempPurchLineLocal, FALSE);
      PurchLine.MODIFY;
      CheckCloseHeader(PurchLine); //**4PS01.n
      UpdateReceiptBalance(PurchLine);
      //**4PS.en
    END;

    [External]
    PROCEDURE RefreshTempLines@172(PurchHeader@1000 : Record 38;VAR TempPurchLine@1001 : TEMPORARY Record 39);
    BEGIN
      TempPurchLine.RESET;
      TempPurchLine.SETRANGE("Prepayment Line",FALSE);
      TempPurchLine.DELETEALL;
      TempPurchLine.RESET;
      CopyToTempLines(PurchHeader,TempPurchLine);
    END;

    LOCAL PROCEDURE ResetTempLines@131(VAR TempPurchLineLocal@1000 : TEMPORARY Record 39);
    BEGIN
      TempPurchLineLocal.RESET;
      TempPurchLineLocal.COPY(TempPurchLineGlobal,TRUE);

      OnAfterResetTempLines(TempPurchLineGlobal);
    END;

    LOCAL PROCEDURE CalcInvoice@118(VAR PurchHeader@1000 : Record 38) NewInvoice : Boolean;
    VAR
      TempPurchLine@1001 : TEMPORARY Record 39;
    BEGIN
      WITH PurchHeader DO BEGIN
        ResetTempLines(TempPurchLine);
        //**4PS.sn
        PutPromisedReceiveDateFilter(TempPurchLine);
        PutReceiveMarkedOnlyFilter(TempPurchLine); //**4PS.n DP00556
        IF "Amounts only" THEN
          TempPurchLine.SETFILTER("Line Amount",'<>0')
        ELSE
        //**4PS.en
          TempPurchLine.SETFILTER(Quantity,'<>0');
        IF "Document Type" IN ["Document Type"::Order,"Document Type"::"Return Order"] THEN
        //**4PS.sn
          IF "Amounts only" THEN
            TempPurchLine.SETFILTER("Amnt. to Invoice",'<>0')
          ELSE
        //**4PS.en
            TempPurchLine.SETFILTER("Qty. to Invoice",'<>0');
        NewInvoice := NOT TempPurchLine.ISEMPTY;
        IF NewInvoice THEN
          CASE "Document Type" OF
            "Document Type"::Order:
              IF NOT Receive THEN BEGIN
                //**4PS.sn
                IF "Amounts only" THEN
                  TempPurchLine.SETFILTER("Amt. Rcd. Not Invoiced",'<>0')
                ELSE
                //**4PS.en
                  TempPurchLine.SETFILTER("Qty. Rcd. Not Invoiced",'<>0');
                NewInvoice := NOT TempPurchLine.ISEMPTY;
              END;
            "Document Type"::"Return Order":
              IF NOT Ship THEN BEGIN
                TempPurchLine.SETFILTER("Return Qty. Shipped Not Invd.",'<>0');
                NewInvoice := NOT TempPurchLine.ISEMPTY;
              END;
          END;
      END;
      EXIT(NewInvoice);
    END;

    LOCAL PROCEDURE CalcInvDiscount@134(VAR PurchHeader@1000 : Record 38);
    VAR
      PurchaseHeaderCopy@1005 : Record 38;
      PurchLine@1001 : Record 39;
    BEGIN
      WITH PurchHeader DO BEGIN
        IF NOT (PurchSetup."Calc. Inv. Discount" AND (Status <> Status::Open)) THEN
          EXIT;

        PurchaseHeaderCopy := PurchHeader;
        PurchLine.RESET;
        PurchLine.SETRANGE("Document Type","Document Type");
        PurchLine.SETRANGE("Document No.","No.");
        PurchLine.FINDFIRST;
        CODEUNIT.RUN(CODEUNIT::"Purch.-Calc.Discount",PurchLine);
        RefreshTempLines(PurchHeader,TempPurchLineGlobal);
        GET("Document Type","No.");
        RestorePurchaseHeader(PurchHeader,PurchaseHeaderCopy);
        IF NOT PreviewMode THEN
          COMMIT;
      END;
      EXIT;
    END;

    LOCAL PROCEDURE RestorePurchaseHeader@232(VAR PurchaseHeader@1000 : Record 38;PurchaseHeaderCopy@1002 : Record 38);
    BEGIN
      WITH PurchaseHeader DO BEGIN
        Invoice := PurchaseHeaderCopy.Invoice;
        Receive := PurchaseHeaderCopy.Receive;
        Ship := PurchaseHeaderCopy.Ship;
        "Posting No." := PurchaseHeaderCopy."Posting No.";
        "Receiving No." := PurchaseHeaderCopy."Receiving No.";
        "Return Shipment No." := PurchaseHeaderCopy."Return Shipment No.";
      END;

      OnAfterRestorePurchaseHeader(PurchaseHeader,PurchaseHeaderCopy);
    END;

    LOCAL PROCEDURE CheckAndUpdate@147(VAR PurchHeader@1000 : Record 38);
    VAR
      GenJnlCheckLine@1001 : Codeunit 11;
      CheckDimensions@1004 : Codeunit 481;
      SetupRecID@1002 : RecordID;
      ModifyHeader@1003 : Boolean;
      RefreshTempLinesNeeded@1005 : Boolean;
      PurchLine@1100525003 : Record 39;
      Vendor@1100525004 : Record 23;
      AmountHeader@1100525000 : Decimal;
      AmountLines@1100525001 : Decimal;
      WKA@1100525005 : Boolean;
    BEGIN
      WITH PurchHeader DO BEGIN
        // Check
        ErrorMessageMgt.PushContext(RECORDID,0,CheckPurchHeaderMsg);
        CheckMandatoryHeaderFields(PurchHeader);
        IF GenJnlCheckLine.IsDateNotAllowed("Posting Date",SetupRecID) THEN
          ErrorMessageMgt.LogContextFieldError(
            FIELDNO("Posting Date"),STRSUBSTNO(PostingDateNotAllowedErr,FIELDCAPTION("Posting Date")),
            SetupRecID,ErrorMessageMgt.GetFieldNo(SetupRecID.TABLENO,GLSetup.FIELDNAME("Allow Posting From")),
            ErrorMessageMgt.GetHelpCodeForAllowedPostingDate);

        //**4PS.sn
        IF "Register Invoice" AND ("Last Posting No." <> '') THEN
          ERROR(Text11012010,"Last Posting No.","No.");

        IF ("Wage Charge (to B Account)" <> 0) AND
           (("Document Type" = "Document Type"::Invoice)) THEN
          TESTFIELD("Bank Account Code B Payments");
        IF Status = Status::Closed THEN
          FIELDERROR(Status);
        PurchaseHeaderExtension.GetPurchHeadExtension("Document Type","No.");
        //**4PS.en

        SetPostingFlags(PurchHeader);
        InitProgressWindow(PurchHeader);

        InvtPickPutaway := "Posting from Whse. Ref." <> 0;
        "Posting from Whse. Ref." := 0;

        CheckDimensions.CheckPurchDim(PurchHeader,TempPurchLineGlobal);

        IF Invoice THEN
          CheckFAPostingPossibility(PurchHeader);

        CheckPostRestrictions(PurchHeader);

        CheckICDocumentDuplicatePosting(PurchHeader);

        // ExFlow
        CLEAR(ExFlowSetup);
        ExFlowSetupExists := ExFlowSetup.GET;
        IF ExFlowSetupExists THEN
          IF ExFlowPurchPost.ExFlowPost(PurchHeader) THEN
            EXIT;
        // ExFlow

        IF Invoice THEN
          Invoice := CalcInvoice(PurchHeader);

        IF Invoice THEN
          CopyAndCheckItemCharge(PurchHeader);

        IF Invoice AND NOT IsCreditDocType THEN
          TESTFIELD("Due Date");

        IF Receive THEN BEGIN
          Receive := CheckTrackingAndWarehouseForReceive(PurchHeader);
          IF NOT InvtPickPutaway THEN
            IF CheckIfInvPutawayExists(PurchHeader) THEN
              ERROR(InvPutAwayExistsErr);
        END;

        IF Ship THEN BEGIN
          Ship := CheckTrackingAndWarehouseForShip(PurchHeader);
          IF NOT InvtPickPutaway THEN
            IF CheckIfInvPickExists THEN
              ERROR(InvPickExistsErr);
        END;

        IF NOT (Receive OR Invoice OR Ship) THEN
          //**4PS.sn
          IF NoErrorNothingToPost THEN BEGIN
            NothingToPostFlag := TRUE;
            EXIT;
          END ELSE
          //**4PS.en
            ERROR(NothingToPostErr);

        CheckAssociatedOrderLines(PurchHeader);

        IF Invoice AND PurchSetup."Ext. Doc. No. Mandatory" THEN
          CheckExtDocNo(PurchHeader);

        //**4PS.sn
        IF Receive AND ("Document Type" =  "Document Type"::Order) THEN
          CheckFinalInstallmentAllowed(PurchHeader);
        //**4PS.en

        OnAfterCheckPurchDoc(PurchHeader,SuppressCommit,WhseShip,WhseReceive);
        ErrorMessageMgt.Finish;

        //**4PS.sn
        IF Invoice THEN BEGIN
          Vendor.GET("Buy-from Vendor No.");
          WKA := "Subcontracting Invoice" AND NOT Vendor."Security Fund";
          CheckAndUpdateOnHoldCode(PurchHeader,Vendor,ModifyHeader);
          CheckWKAAmount(PurchHeader,Vendor,WKA);
          CheckIntrastat(PurchHeader);
        END;
        //**4PS.en

        // Update
        IF Invoice THEN
          CreatePrepmtLines(PurchHeader,TRUE);

        //ModifyHeader := UpdatePostingNos(PurchHeader); //**4PS.o
        //**4PS.sn
        IF UpdatePostingNos(PurchHeader) THEN
          ModifyHeader := TRUE;

        IF "Receipts in Bundles" THEN
          ModifyHeader := TRUE;
        //**4PS.en

        DropShipOrder := UpdateAssosOrderPostingNos(PurchHeader);

        OnBeforePostCommitPurchaseDoc(PurchHeader,GenJnlPostLine,PreviewMode,ModifyHeader,SuppressCommit,TempPurchLineGlobal);
        IF NOT PreviewMode AND ModifyHeader THEN BEGIN
          MODIFY;
          COMMIT;
        END;

        OnCheckAndUpdateOnBeforeCalcInvDiscount(
          PurchHeader,TempWhseRcptHeader,TempWhseShptHeader,WhseReceive,WhseShip,RefreshTempLinesNeeded);
        IF RefreshTempLinesNeeded THEN
          RefreshTempLines(PurchHeader,TempPurchLineGlobal);
        CalcInvDiscount(PurchHeader);
        ReleasePurchDocument(PurchHeader);

        IF Receive OR Ship THEN
          ArchiveUnpostedOrder(PurchHeader);

        CheckICPartnerBlocked(PurchHeader);
        SendICDocument(PurchHeader,ModifyHeader);
        UpdateHandledICInboxTransaction(PurchHeader);

        IF Invoice THEN
          IF "Document Type" IN ["Document Type"::Invoice,"Document Type"::"Credit Memo"] THEN BEGIN
            CALCFIELDS(Amount,"Amount Including VAT");

            PrePostRoundingOff(PurchHeader); //4PSSE

            //**4PS.so   Setup and Doc. Amounts (Incl. VAT / VAT) not used by 4PS
            {
            IF PurchSetup."Check Doc. Total Amounts" AND (NOT PreviewMode) THEN BEGIN
              IF "Amount Including VAT" <> "Doc. Amount Incl. VAT" THEN
                ERROR(Text11300,"Doc. Amount Incl. VAT","Amount Including VAT");
              IF ("Amount Including VAT" - Amount) <> "Doc. Amount VAT" THEN
                ERROR(
                  Text11301,FIELDCAPTION("Doc. Amount VAT"),"Doc. Amount VAT","Amount Including VAT" - Amount);
            END;
            } //**4PS.eo

            //**4PS.sn
            IF NOT InvoiceMarginCheck(PurchHeader,AmountHeader,AmountLines) THEN
              FIELDERROR("Amount incl. VAT",STRSUBSTNO(Text11012004,FORMAT(AmountHeader, 0, '<Precision,2:2><Standard Format,0>'),FORMAT(AmountLines, 0, '<Precision,2:2><Standard Format,0>')));
            IF "Manually VAT Posting" THEN BEGIN
              PurchLine."Document Type" := "Document Type";
              PurchLine."Document No." := "No.";
              PurchLine.CALCFIELDS("Balance Excl. VAT");
              IF "Amount excl. VAT" <> PurchLine."Balance Excl. VAT" THEN
                FIELDERROR("Amount excl. VAT",STRSUBSTNO(Text11012004,"Amount excl. VAT",PurchLine."Balance Excl. VAT"));
            END;
            //**4PS.en
          END;

        LockTables(PurchHeader);

        SourceCodeSetup.GET;
        SrcCode := SourceCodeSetup.Purchases;

        // ExFlow
        IF ExFlowSetupExists THEN BEGIN
          ExFlowPurchPost.DeletePrePaymentTempLine(PurchHeader);
          ExFlowPurchPost.TestAmount(PurchHeader);
        END;
        // ExFlow
        OnBeforeInsertPostedHeaders(PurchHeader,TempWhseRcptHeader,TempWhseShptHeader);
      //InsertPostedHeaders(PurchHeader); //**4PS.o
        InsertPostedHeaders(PurchHeader,ModifyHeader); //**4PS.n

        UpdateIncomingDocument("Incoming Document Entry No.","Posting Date",GenJnlLineDocNo);
      END;

      OnAfterCheckAndUpdate(PurchHeader,SuppressCommit,PreviewMode);
    END;

    LOCAL PROCEDURE CheckExtDocNo@179(PurchaseHeader@1000 : Record 38);
    BEGIN
      WITH PurchaseHeader DO
        CASE "Document Type" OF
          "Document Type"::Order,
          "Document Type"::Invoice:
            IF "Vendor Invoice No." = '' THEN
              ERROR(ExtDocNoNeededErr,FIELDCAPTION("Vendor Invoice No."));
          ELSE
            IF "Vendor Cr. Memo No." = '' THEN
              ERROR(ExtDocNoNeededErr,FIELDCAPTION("Vendor Cr. Memo No."));
        END;
    END;

    LOCAL PROCEDURE PostPurchLine@152(VAR PurchHeader@1001 : Record 38;VAR PurchLine@1000 : Record 39;VAR TempInvoicePostBuffer@1006 : TEMPORARY Record 49;VAR TempVATAmountLine@1005 : TEMPORARY Record 290;VAR TempVATAmountLineRemainder@1004 : TEMPORARY Record 290;VAR TempDropShptPostBuffer@1009 : TEMPORARY Record 223;VAR EverythingInvoiced@1003 : Boolean;VAR ICGenJnlLineNo@1008 : Integer);
    VAR
      PurchRcptLine@1012 : Record 121;
      PurchInvLine@1010 : Record 123;
      PurchCrMemoLine@1011 : Record 125;
      InvoicePostBuffer@1007 : Record 49;
      CostBaseAmount@1002 : Decimal;
      PurchRcptLine1@1100525008 : Record 121;
      PurchaseLineExtension@1100525002 : Record 11020644;
      SavePurchLine@1100525003 : Record 39;
      LastRefNo@1100525001 : Code[20];
      CreatePlantNo@1100525004 : Boolean;
      RcptCounter@1100525005 : Integer;
      lvI@1100525006 : Integer;
      NextRcptLineNo@1100525007 : Integer;
      PlantNo@1100525009 : Code[20];
    BEGIN
      WITH PurchLine DO BEGIN
        IF Type = Type::Item THEN
          CostBaseAmount := "Line Amount";
        UpdateQtyPerUnitOfMeasure(PurchLine);

        TestPurchLine(PurchHeader,PurchLine);
        UpdatePurchLineBeforePost(PurchHeader,PurchLine);

        //**4PS.sn
        IF PurchHeader."Amounts only" THEN BEGIN
          IF "Amnt. to Invoice" + "Amnt. Invoiced" <> Amount THEN
            EverythingInvoiced := FALSE;
        END ELSE
        //**4PS.en
          IF "Qty. to Invoice" + "Quantity Invoiced" <> Quantity THEN
            EverythingInvoiced := FALSE;

        OnPostPurchLineOnAfterSetEverythingInvoiced(PurchLine,EverythingInvoiced);

        //**4PS.so
        //IF Quantity <> 0 THEN BEGIN
        //  TESTFIELD("No.");
        //**4PS.eo
        IF (Quantity <> 0) OR (PurchHeader."Amounts only" AND ("Line Amount" <> 0) ) THEN BEGIN  //**4PS.n
          TESTFIELD(Type);
          //**4PS.sn
          IF (NOT CheckPlantCreateFAOnReceipt) AND (NOT PlantReceivedAndCreatedOnOrder(PurchLine)) THEN BEGIN //26690.n
            TESTFIELD("No.");
          //**4PS.en
            TESTFIELD("Gen. Bus. Posting Group");
            TESTFIELD("Gen. Prod. Posting Group");
          END; //**4PS.n
          DivideAmount(PurchHeader,PurchLine,1,"Qty. to Invoice",TempVATAmountLine,TempVATAmountLineRemainder);
        END ELSE
          IF NOT PurchHeader."Amounts only" THEN //**4PS.n
            TESTFIELD(Amount,0);

        CheckItemReservDisruption(PurchLine);
        RoundAmount(PurchHeader,PurchLine,"Qty. to Invoice");

        IF IsCreditDocType THEN BEGIN
          ReverseAmount(PurchLine);
          ReverseAmount(PurchLineACY);
        END;

        //**4PS.sn
        IF ("Job No." <> '') AND ( ("Qty. to Receive" <> 0) OR ("Amnt. to Receive" <> 0) ) THEN BEGIN
          IF (PurchSetup."Preregister WIP Purch. Inv.") AND
              (PurchSetup."Preregistration WIP Account" = "No.") AND
              (Type = Type::"G/L Account")
          THEN
            TESTFIELD("Shortcut Dimension 2 Code",'')
          ELSE
            TESTFIELD("Shortcut Dimension 2 Code");
        END;
        RemAmntToBeInvoiced := "Amnt. to Invoice";
        //**4PS.en

        RemQtyToBeInvoiced := "Qty. to Invoice";
        RemQtyToBeInvoicedBase := "Qty. to Invoice (Base)";

        // Job Credit Memo Item Qty Check
        IF IsCreditDocType THEN
          IF ("Job No." <> '') AND (Type = Type::Item) AND ("Qty. to Invoice" <> 0) THEN
            JobPostLine.CheckItemQuantityPurchCredit(PurchHeader,PurchLine);

        PostItemTrackingLine(PurchHeader,PurchLine);

        // ExFlow
        IF ExFlowSetupExists THEN
          ExFlowPurchPost.UpdateDefJobTaskNo(PurchLine,PurchLine,JobPurchLine);
        // ExFlow

        CASE Type OF
          Type::"G/L Account":
            PostGLAccICLine(PurchHeader,PurchLine,ICGenJnlLineNo);
          Type::Item:
            PostItemLine(PurchHeader,PurchLine,TempDropShptPostBuffer);
          3:
            PostResourceLine(PurchHeader,PurchLine);
          Type::"Charge (Item)":
            PostItemChargeLine(PurchHeader,PurchLine);
        END;

        //**4PS.so
        //IF (Type >= Type::"G/L Account") AND ("Qty. to Invoice" <> 0) THEN BEGIN THEN BEGIN
        //**4PS.eo
        //**4PS.sn
        IF (PurchLine.Type >= PurchLine.Type::"G/L Account") AND
           (PurchHeader."Amounts only" AND (PurchLine."Amnt. to Invoice" <> 0) OR
            NOT PurchHeader."Amounts only" AND (PurchLine."Qty. to Invoice" <> 0)) THEN BEGIN
        //**4PS.en
          AdjustPrepmtAmountLCY(PurchHeader,PurchLine);
          FillInvoicePostBuffer(PurchHeader,PurchLine,PurchLineACY,TempInvoicePostBuffer,InvoicePostBuffer);
          InsertPrepmtAdjInvPostingBuf(PurchHeader,PurchLine,TempInvoicePostBuffer,InvoicePostBuffer);
        END;

        //**4PS.sn
        UpdateHeadersForApproval(PurchHeader,PurchLine);
        PostJobServicePlant(PurchHeader,PurchLine,InvoicePostBuffer);
        PostSurchargeForExternalIndirectHours(PurchHeader,PurchLine);
        PostLoan(PurchHeader,PurchLine,InvoicePostBuffer);
        //**4PS.en

        IF (PurchRcptHeader."No." <> '') AND ("Receipt No." = '') AND
           NOT RoundingLineInserted AND NOT "Prepayment Line"
           //**4PS.sn
           AND (("Document Type" <> "Document Type"::Order) OR
                (PurchHeader."Amounts only" AND (PurchLine."Amnt. to Receive" <> 0) OR
                 NOT PurchHeader."Amounts only" AND (PurchLine."Qty. to Receive" <> 0)))
           //**4PS.en
        THEN
        //InsertReceiptLine(PurchRcptHeader,PurchLine,CostBaseAmount); //**4PS.o
          //**4PS.sn
          BEGIN
            SavePurchLine := PurchLine;
            LastRefNo := '';
            CreatePlantNo := CheckGeneratePlantNoOnReceipt(PurchHeader,PurchLine,RcptCounter);
            FOR lvI := 1 TO RcptCounter DO BEGIN
              IF lvI = 1 THEN
                NextRcptLineNo := PurchLine."Line No."
              ELSE BEGIN
                PurchLine := SavePurchLine;
                NextRcptLineNo := NextRcptLineNo + 1;
              END;
              IF PurchRcptLine1.GET(PurchRcptHeader."No.",NextRcptLineNo) THEN
                NextRcptLineNo := -1;
              IF (PurchHeader."Receipts in Bundles") OR (NextRcptLineNo < 0) THEN BEGIN
                PurchRcptLine1.SETRANGE("Document No.",PurchRcptHeader."No.");
                IF PurchRcptLine1.FINDLAST THEN
                  NextRcptLineNo := PurchRcptLine1."Line No." + 10000;
              END;
              IF CreatePlantNo THEN BEGIN
                PlantNo := GeneratePlantNoOnReceipt(PurchHeader,PurchLine,PurchRcptHeader."No.",NextRcptLineNo);
                PurchLine."Plant No." := PlantNo;
                IF (RcptCounter > 1) THEN BEGIN
                  IF (PurchLine."Qty. per Unit of Measure" = 0) OR (PurchLine."Qty. per Unit of Measure" = 1) THEN
                    PurchLine.VALIDATE("Qty. to Receive", 1)
                  ELSE
                    PurchLine.VALIDATE("Qty. to Receive", (1 / PurchLine."Qty. per Unit of Measure"));
                  PurchLine."Qty. to Receive (Base)" := 1; //* Don't use 'Validate'.
                  IF SavePurchLine."Qty. to Invoice" = 0 THEN BEGIN
                    PurchLine."Qty. to Invoice" := 0;
                    PurchLine."Qty. to Invoice (Base)" := 0;
                  END;
                END;
              END ELSE BEGIN
                CheckPostPlantNoOnReceipt(PurchHeader,PurchLine, PurchRcptHeader."No.",NextRcptLineNo);
                IF PurchLine.Type = PurchLine.Type::"Fixed Asset" THEN
                  PurchLine.TESTFIELD("No.");
              END;
              IF (PurchLine."Item No." <> '') AND (PurchLine."Plant Order No." <> '') THEN
                ItemReceiptOnPlantOrder(PurchLine);
              InsertReceiptLine(PurchRcptHeader,PurchLine,CostBaseAmount,PurchHeader,NextRcptLineNo,PurchRcptLine,LastRefNo);
            END;
          END;
          //**4PS.en

        IF (ReturnShptHeader."No." <> '') AND ("Return Shipment No." = '') AND
           NOT RoundingLineInserted
        THEN
          InsertReturnShipmentLine(ReturnShptHeader,PurchLine,CostBaseAmount);

        IF PurchHeader.Invoice THEN
          IF "Document Type" IN ["Document Type"::Order,"Document Type"::Invoice] THEN BEGIN
            PurchInvLine.InitFromPurchLine(PurchInvHeader,xPurchLine);

            //**4PS.sn
            IF "Document Type" = "Document Type"::Order THEN BEGIN
              PurchInvLine."Receipt No." := PurchRcptLine."Document No.";
              PurchInvLine."Receipt Line No." := PurchRcptLine."Line No.";
            END ELSE BEGIN
              PurchInvLine."Receipt No." := xPurchLine."Receipt No.";
              PurchInvLine."Receipt Line No." := xPurchLine."Receipt Line No.";
            END;
            IF (PurchInvHeader."Currency Code" = '') OR (PurchInvLine.Amount = 0) THEN
              PurchInvLine."Amount (LCY)" := PurchInvLine.Amount
            ELSE
              PurchInvLine."Amount (LCY)" :=
                ROUND(
                  CurrExchRate.ExchangeAmtFCYToLCY(
                    //0, '', //C038025.o
                    1, PurchInvHeader."Job No.", //C038025.n
                    PurchInvHeader."Posting Date", PurchInvHeader."Currency Code",
                    PurchInvLine.Amount, PurchInvHeader."Currency Factor",FALSE));
            IF "Document Type" = "Document Type"::Order THEN
              PurchInvLine."Line VAT Amount" := PurchInvLine."Amount Including VAT" - PurchInvLine.Amount;
            PurchaseLineExtension.GetPurchLineExtension(
              xPurchLine."Document Type",xPurchLine."Document No.",xPurchLine."Line No.");
            PurchInvLine."Expense Allowance Scheme" := PurchaseLineExtension."Expense Allowance Scheme";
            //**4PS.en

            ItemJnlPostLine.CollectValueEntryRelation(TempValueEntryRelation,COPYSTR(PurchInvLine.RowID1,1,100));
            IF "Document Type" = "Document Type"::Order THEN BEGIN
              PurchInvLine."Order No." := "Document No.";
              PurchInvLine."Order Line No." := "Line No.";
            END ELSE
              IF PurchRcptLine.GET("Receipt No.","Receipt Line No.") THEN BEGIN
                PurchInvLine."Order No." := PurchRcptLine."Order No.";
                PurchInvLine."Order Line No." := PurchRcptLine."Order Line No.";
              END;
            OnBeforePurchInvLineInsert(PurchInvLine,PurchInvHeader,PurchLine,SuppressCommit);
            PurchInvLine.INSERT(TRUE);
            OnAfterPurchInvLineInsert(
              PurchInvLine,PurchInvHeader,PurchLine,ItemLedgShptEntryNo,WhseShip,WhseReceive,SuppressCommit);

            //**4PS.sn
            InsertNSItemTrackingRelation(PurchHeader,xPurchLine,PurchRcptLine,PurchInvLine.RowID1); //DP00121
            //**4PS.en

            CreatePostedDeferralScheduleFromPurchDoc(xPurchLine,PurchInvLine.GetDocumentType,
              PurchInvHeader."No.",PurchInvLine."Line No.",PurchInvHeader."Posting Date");

            //**4PS.n
            IF "Document Type" = "Document Type"::Order THEN
              CreatePurchaseOrderControl(xPurchLine);
            //**4PS.en
          END ELSE BEGIN // Credit Memo
            PurchCrMemoLine.InitFromPurchLine(PurchCrMemoHeader,xPurchLine);

            //**4PS.sn
            PurchCrMemoLine."Receipt No." := xPurchLine."Receipt No.";
            PurchCrMemoLine."Receipt Line No." := xPurchLine."Receipt Line No.";
            IF PurchCrMemoHeader."Currency Code" = '' THEN
              PurchCrMemoLine."Amount (LCY)" := PurchCrMemoLine.Amount
            ELSE
              PurchCrMemoLine."Amount (LCY)" :=
                ROUND(
                  CurrExchRate.ExchangeAmtFCYToLCY(
                  //0, '', //C038025.o
                  1, PurchCrMemoHeader."Job No.", //C038025.n
                  PurchCrMemoHeader."Posting Date", PurchCrMemoHeader."Currency Code",
                  PurchCrMemoLine.Amount, PurchCrMemoHeader."Currency Factor",FALSE));
            PurchaseLineExtension.GetPurchLineExtension(
              xPurchLine."Document Type",xPurchLine."Document No.",xPurchLine."Line No.");
            PurchCrMemoLine."Expense Allowance Scheme" := PurchaseLineExtension."Expense Allowance Scheme";
            //**4PS.en

            ItemJnlPostLine.CollectValueEntryRelation(TempValueEntryRelation,COPYSTR(PurchCrMemoLine.RowID1,1,100));
            IF "Document Type" = "Document Type"::"Return Order" THEN BEGIN
              PurchCrMemoLine."Order No." := "Document No.";
              PurchCrMemoLine."Order Line No." := "Line No.";
            END;
            OnBeforePurchCrMemoLineInsert(PurchCrMemoLine,PurchCrMemoHeader,PurchLine,SuppressCommit);
            PurchCrMemoLine.INSERT(TRUE);
            OnAfterPurchCrMemoLineInsert(PurchCrMemoLine,PurchCrMemoHeader,PurchLine,SuppressCommit);

            //**4PS.sn
            InsertNSItemTrackingRelation(PurchHeader,xPurchLine,PurchRcptLine,PurchCrMemoLine.RowID1); //DP00121
            //**4PS.en

            CreatePostedDeferralScheduleFromPurchDoc(xPurchLine,PurchCrMemoLine.GetDocumentType,
              PurchCrMemoHeader."No.",PurchCrMemoLine."Line No.",PurchCrMemoHeader."Posting Date");
          END;
      END;

      OnAfterPostPurchLine(PurchHeader,PurchLine,SuppressCommit);
    END;

    LOCAL PROCEDURE PostGLAndVendor@157(VAR PurchHeader@1000 : Record 38;VAR TempInvoicePostBuffer@1001 : TEMPORARY Record 49);
    BEGIN
      OnBeforePostGLAndVendor(PurchHeader,TempInvoicePostBuffer,PreviewMode,SuppressCommit,GenJnlPostLine);

      WITH PurchHeader DO BEGIN
        PostRetentionPostingBuffer(PurchHeader); //**4PS.n
        // Post purchase and VAT to G/L entries from buffer
        PostInvoicePostingBuffer(PurchHeader,TempInvoicePostBuffer);

        // Check External Document number
        IF PurchSetup."Ext. Doc. No. Mandatory" OR (GenJnlLineExtDocNo <> '') THEN
          CheckExternalDocumentNumber(VendLedgEntry,PurchHeader);

        // Post vendor entries
        IF GUIALLOWED AND NOT HideProgressWindow THEN
          Window.UPDATE(4,1);

        //**4PS.sn Warranty Retention
        IF (RetentionType = RetentionType::Warranty) AND (DocumentRetentionAmount <> 0) THEN BEGIN
          TotalPurchLine."Amount Including VAT" := TotalPurchLine."Amount Including VAT" + DocumentRetentionAmount; //C037315.n
          IF "Currency Code" = '' THEN
            TotalPurchLineLCY."Amount Including VAT" := TotalPurchLineLCY."Amount Including VAT" + DocumentRetentionAmount
          ELSE
            TotalPurchLineLCY."Amount Including VAT" := TotalPurchLineLCY."Amount Including VAT" +
              ROUND(
                CurrExchRate.ExchangeAmtFCYToLCY(
                  //0, '', //C038025.o
                  1, PurchHeader."Job No.", //C038025.n
                  PurchHeader."Posting Date",PurchHeader."Currency Code",
                  DocumentRetentionAmount,PurchHeader."Currency Factor",FALSE));
        END;
        //**4PS.en

        PostVendorEntry(
          PurchHeader,TotalPurchLine,TotalPurchLineLCY,GenJnlLineDocType,GenJnlLineDocNo,GenJnlLineExtDocNo,SrcCode);

        UpdatePurchaseHeader(VendLedgEntry);

        // Balancing account
        IF "Bal. Account No." <> '' THEN BEGIN
          IF GUIALLOWED AND NOT HideProgressWindow THEN
            Window.UPDATE(5,1);
          PostBalancingEntry(
            PurchHeader,TotalPurchLine,TotalPurchLineLCY,GenJnlLineDocType,GenJnlLineDocNo,GenJnlLineExtDocNo,SrcCode);
        END;
      END;

      OnAfterPostGLAndVendor(PurchHeader,GenJnlPostLine,TotalPurchLine,TotalPurchLineLCY,SuppressCommit);
    END;

    LOCAL PROCEDURE PostGLAccICLine@154(PurchHeader@1002 : Record 38;PurchLine@1000 : Record 39;VAR ICGenJnlLineNo@1003 : Integer);
    VAR
      GLAcc@1001 : Record 15;
      IsHandled@1004 : Boolean;
    BEGIN
      IsHandled := FALSE;
      OnBeforePostGLAccICLine(PurchHeader,PurchLine,ICGenJnlLineNo,IsHandled);
      IF IsHandled THEN
        EXIT;

      IF (PurchLine."No." <> '') AND NOT PurchLine."System-Created Entry" THEN BEGIN
        GLAcc.CHANGECOMPANY(PurchLine."Receiving Company"); //**4PS.n
        GLAcc.GET(PurchLine."No.");
        GLAcc.TESTFIELD("Direct Posting");
      //**4PS.so DP01406
      //  IF (PurchLine."Job No." <> '') AND (PurchLine."Qty. to Invoice" <> 0) THEN BEGIN
      //    CreateJobPurchLine(JobPurchLine,PurchLine,PurchHeader."Prices Including VAT");
      //    JobPostLine.PostJobOnPurchaseLine(PurchHeader,PurchInvHeader,PurchCrMemoHeader,JobPurchLine,SrcCode);
      //  END;
      //**4PS.eo
        IF (PurchLine."IC Partner Code" <> '') AND PurchHeader.Invoice THEN
          InsertICGenJnlLine(PurchHeader,xPurchLine,ICGenJnlLineNo);

        OnAfterPostAccICLine(PurchLine,SuppressCommit);
      END;
      CheckUpdateItemPrice(PurchLine); //**4PS.n (call 4392)
    END;

    LOCAL PROCEDURE PostItemLine@135(PurchHeader@1000 : Record 38;VAR PurchLine@1001 : Record 39;VAR TempDropShptPostBuffer@1003 : TEMPORARY Record 223);
    VAR
      DummyTrackingSpecification@1002 : Record 336;
    BEGIN
      ItemLedgShptEntryNo := 0;
      WITH PurchHeader DO BEGIN
        IF RemQtyToBeInvoiced <> 0 THEN
          ItemLedgShptEntryNo :=
            PostItemJnlLine(
              PurchHeader,PurchLine,
              RemQtyToBeInvoiced,RemQtyToBeInvoicedBase,
              RemQtyToBeInvoiced,RemQtyToBeInvoicedBase,
              0,'',DummyTrackingSpecification);
      //IF IsCreditDocType THEN BEGIN //**4PS.o
        IF "Document Type" = "Document Type"::"Return Order" THEN BEGIN //**4PS.n
          IF ABS(PurchLine."Return Qty. to Ship") > ABS(RemQtyToBeInvoiced) THEN
            ItemLedgShptEntryNo :=
              PostItemJnlLine(
                PurchHeader,PurchLine,
                PurchLine."Return Qty. to Ship" - RemQtyToBeInvoiced,
                PurchLine."Return Qty. to Ship (Base)" - RemQtyToBeInvoicedBase,
                0,0,0,'',DummyTrackingSpecification);
        END ELSE BEGIN
          IF ABS(PurchLine."Qty. to Receive") > ABS(RemQtyToBeInvoiced) THEN
            ItemLedgShptEntryNo :=
              PostItemJnlLine(
                PurchHeader,PurchLine,
                PurchLine."Qty. to Receive" - RemQtyToBeInvoiced,
                PurchLine."Qty. to Receive (Base)" - RemQtyToBeInvoicedBase,
                0,0,0,'',DummyTrackingSpecification);
          IF (PurchLine."Qty. to Receive" <> 0) AND (PurchLine."Sales Order Line No." <> 0) THEN BEGIN
            TempDropShptPostBuffer."Order No." := PurchLine."Sales Order No.";
            TempDropShptPostBuffer."Order Line No." := PurchLine."Sales Order Line No.";
            TempDropShptPostBuffer.Quantity := PurchLine."Qty. to Receive";
            TempDropShptPostBuffer."Quantity (Base)" := PurchLine."Qty. to Receive (Base)";
            TempDropShptPostBuffer."Item Shpt. Entry No." :=
              PostAssocItemJnlLine(PurchHeader,PurchLine,TempDropShptPostBuffer.Quantity,TempDropShptPostBuffer."Quantity (Base)");
            OnBeforeTempDropShptPostBufferInsert(TempDropShptPostBuffer,PurchLine);
            TempDropShptPostBuffer.INSERT;
          END;
        END;

        OnAfterPostItemLine(PurchLine,SuppressCommit);
      END;
    END;

    LOCAL PROCEDURE PostItemChargeLine@146(PurchHeader@1002 : Record 38;PurchLine@1000 : Record 39);
    VAR
      PurchaseLineBackup@1001 : Record 39;
    BEGIN
      IF NOT (PurchHeader.Invoice AND (PurchLine."Qty. to Invoice" <> 0)) THEN
        EXIT;

      ItemJnlRollRndg := TRUE;
      PurchaseLineBackup.COPY(PurchLine);
      IF FindTempItemChargeAssgntPurch(PurchaseLineBackup."Line No.") THEN
        REPEAT
          CASE TempItemChargeAssgntPurch."Applies-to Doc. Type" OF
            TempItemChargeAssgntPurch."Applies-to Doc. Type"::Receipt:
              BEGIN
                PostItemChargePerRcpt(PurchHeader,PurchaseLineBackup);
                TempItemChargeAssgntPurch.MARK(TRUE);
              END;
            TempItemChargeAssgntPurch."Applies-to Doc. Type"::"Transfer Receipt":
              BEGIN
                PostItemChargePerTransfer(PurchHeader,PurchaseLineBackup);
                TempItemChargeAssgntPurch.MARK(TRUE);
              END;
            TempItemChargeAssgntPurch."Applies-to Doc. Type"::"Return Shipment":
              BEGIN
                PostItemChargePerRetShpt(PurchHeader,PurchaseLineBackup);
                TempItemChargeAssgntPurch.MARK(TRUE);
              END;
            TempItemChargeAssgntPurch."Applies-to Doc. Type"::"Sales Shipment":
              BEGIN
                PostItemChargePerSalesShpt(PurchHeader,PurchaseLineBackup);
                TempItemChargeAssgntPurch.MARK(TRUE);
              END;
            TempItemChargeAssgntPurch."Applies-to Doc. Type"::"Return Receipt":
              BEGIN
                PostItemChargePerRetRcpt(PurchHeader,PurchaseLineBackup);
                TempItemChargeAssgntPurch.MARK(TRUE);
              END;
            TempItemChargeAssgntPurch."Applies-to Doc. Type"::Order,
            TempItemChargeAssgntPurch."Applies-to Doc. Type"::Invoice,
            TempItemChargeAssgntPurch."Applies-to Doc. Type"::"Return Order",
            TempItemChargeAssgntPurch."Applies-to Doc. Type"::"Credit Memo":
              CheckItemCharge(TempItemChargeAssgntPurch);
          END;
        UNTIL TempItemChargeAssgntPurch.NEXT = 0;
    END;

    LOCAL PROCEDURE PostItemTrackingLine@159(PurchHeader@1000 : Record 38;PurchLine@1001 : Record 39);
    VAR
      TempTrackingSpecification@1003 : TEMPORARY Record 336;
      TrackingSpecificationExists@1002 : Boolean;
    BEGIN
      IF PurchLine."Prepayment Line" THEN
        EXIT;

      IF PurchHeader.Invoice THEN
        IF PurchLine."Qty. to Invoice" = 0 THEN
          TrackingSpecificationExists := FALSE
        ELSE
          TrackingSpecificationExists :=
            ReservePurchLine.RetrieveInvoiceSpecification(PurchLine,TempTrackingSpecification);

      PostItemTracking(PurchHeader,PurchLine,TempTrackingSpecification,TrackingSpecificationExists);

      IF TrackingSpecificationExists THEN
        SaveInvoiceSpecification(TempTrackingSpecification);

      OnAfterPostItemTrackingLine(PurchHeader,PurchLine,WhseReceive,WhseShip,InvtPickPutaway);
    END;

    LOCAL PROCEDURE PostItemJnlLine@2(PurchHeader@1019 : Record 38;PurchLine@1000 : Record 39;QtyToBeReceived@1001 : Decimal;QtyToBeReceivedBase@1002 : Decimal;QtyToBeInvoiced@1003 : Decimal;QtyToBeInvoicedBase@1004 : Decimal;ItemLedgShptEntryNo@1005 : Integer;ItemChargeNo@1006 : Code[20];TrackingSpecification@1010 : Record 336) : Integer;
    VAR
      ItemJnlLine@1008 : Record 83;
      OriginalItemJnlLine@1014 : Record 83;
      TempWhseJnlLine@1012 : TEMPORARY Record 7311;
      TempWhseTrackingSpecification@1016 : TEMPORARY Record 336;
      TempTrackingSpecificationChargeAssmt@1030 : TEMPORARY Record 336;
      CurrExchRate@1007 : Record 330;
      TempReservationEntry@1011 : TEMPORARY Record 337;
      Factor@1009 : Decimal;
      PostWhseJnlLine@1013 : Boolean;
      CheckApplToItemEntry@1015 : Boolean;
      PostJobConsumptionBeforePurch@1018 : Boolean;
      IsHandled@1017 : Boolean;
    BEGIN
      IF NOT ItemJnlRollRndg THEN BEGIN
        RemAmt := 0;
        RemDiscAmt := 0;
      END;

      OnBeforePostItemJnlLine(
        PurchHeader,PurchLine,QtyToBeReceived,QtyToBeReceivedBase,QtyToBeInvoiced,QtyToBeInvoicedBase,
        ItemLedgShptEntryNo,ItemChargeNo,TrackingSpecification,SuppressCommit);

      WITH ItemJnlLine DO BEGIN
        INIT;
        CopyFromPurchHeader(PurchHeader);
        CopyFromPurchLine(PurchLine);

        PostItemJnlLineCopyDocumentFields(ItemJnlLine,PurchHeader,PurchLine,QtyToBeInvoiced,QtyToBeReceived);

        IF QtyToBeInvoiced <> 0 THEN
          "Invoice No." := GenJnlLineDocNo;

        CopyTrackingFromSpec(TrackingSpecification);
        "Item Shpt. Entry No." := ItemLedgShptEntryNo;

        Quantity := QtyToBeReceived;
        "Quantity (Base)" := QtyToBeReceivedBase;
        "Invoiced Quantity" := QtyToBeInvoiced;
        "Invoiced Qty. (Base)" := QtyToBeInvoicedBase;

        IF ItemChargeNo <> '' THEN BEGIN
          "Item Charge No." := ItemChargeNo;
          PurchLine."Qty. to Invoice" := QtyToBeInvoiced;
        END;
        IF QtyToBeInvoiced <> 0 THEN BEGIN
          IF (QtyToBeInvoicedBase <> 0) AND (PurchLine.Type = PurchLine.Type::Item)THEN
            Factor := QtyToBeInvoicedBase / PurchLine."Qty. to Invoice (Base)"
          ELSE
            Factor := QtyToBeInvoiced / PurchLine."Qty. to Invoice";
          OnPostItemJnlLineOnAfterSetFactor(PurchLine,Factor);
          Amount := PurchLine.Amount * Factor + RemAmt;
          IF PurchHeader."Prices Including VAT" THEN
            "Discount Amount" :=
              (PurchLine."Line Discount Amount" + PurchLine."Inv. Discount Amount") /
              (1 + PurchLine."VAT %" / 100) * Factor + RemDiscAmt
          ELSE
            "Discount Amount" :=
              (PurchLine."Line Discount Amount" + PurchLine."Inv. Discount Amount") * Factor + RemDiscAmt;
          RemAmt := Amount - ROUND(Amount);
          RemDiscAmt := "Discount Amount" - ROUND("Discount Amount");
          Amount := ROUND(Amount);
          "Discount Amount" := ROUND("Discount Amount");
        END ELSE BEGIN
          IF PurchHeader."Prices Including VAT" THEN
            Amount :=
              (QtyToBeReceived * PurchLine."Direct Unit Cost" * (1 - PurchLine."Line Discount %" / 100) /
               (1 + PurchLine."VAT %" / 100)) + RemAmt
          ELSE
            Amount :=
              (QtyToBeReceived * PurchLine."Direct Unit Cost" * (1 - PurchLine."Line Discount %" / 100)) + RemAmt;
          RemAmt := Amount - ROUND(Amount);
          IF PurchHeader."Currency Code" <> '' THEN
            Amount :=
              ROUND(
                CurrExchRate.ExchangeAmtFCYToLCY(
                  1, PurchHeader."Job No.", //**4PS.n
                  PurchHeader."Posting Date",PurchHeader."Currency Code",
      //          Amount,PurchHeader."Currency Factor")) //**4PS.o
                  Amount,PurchHeader."Currency Factor",FALSE)) //**4PS.n
          ELSE
            Amount := ROUND(Amount);
        END;

        OnPostItemJnlLineOnAfterPrepareItemJnlLine(ItemJnlLine,PurchLine,PurchHeader);

        IF PurchLine."Prod. Order No." <> '' THEN
          PostItemJnlLineCopyProdOrder(PurchLine,ItemJnlLine,QtyToBeReceived,QtyToBeInvoiced);

        CheckApplToItemEntry := SetCheckApplToItemEntry(PurchLine);

        PostWhseJnlLine := ShouldPostWhseJnlLine(PurchLine,ItemJnlLine,TempWhseJnlLine);

        IF QtyToBeReceivedBase <> 0 THEN BEGIN
          IF PurchLine.IsCreditDocType THEN
            ReservePurchLine.TransferPurchLineToItemJnlLine(
              PurchLine,ItemJnlLine,-QtyToBeReceivedBase,CheckApplToItemEntry)
          ELSE
            ReservePurchLine.TransferPurchLineToItemJnlLine(
              PurchLine,ItemJnlLine,QtyToBeReceivedBase,CheckApplToItemEntry);

          IF CheckApplToItemEntry AND PurchLine.IsInventoriableItem THEN
            PurchLine.TESTFIELD("Appl.-to Item Entry");
        END;

        CollectPurchaseLineReservEntries(TempReservationEntry,ItemJnlLine);
        OriginalItemJnlLine := ItemJnlLine;

        TempHandlingSpecification.RESET;
        TempHandlingSpecification.DELETEALL;

        IsHandled := FALSE;
        OnBeforeItemJnlPostLine(ItemJnlLine,PurchLine,PurchHeader,SuppressCommit,IsHandled);
        IF NOT IsHandled THEN
          IF PurchLine."Job No." <> '' THEN BEGIN
            PostJobConsumptionBeforePurch := IsPurchaseReturn;
            IF PostJobConsumptionBeforePurch THEN
              PostItemJnlLineJobConsumption(
                PurchHeader,PurchLine,OriginalItemJnlLine,TempReservationEntry,QtyToBeInvoiced,QtyToBeReceived,
                TempHandlingSpecification,0);
          END;

        ItemJnlPostLine.RunWithCheck(ItemJnlLine);
        CheckUpdateItemPrice(PurchLine); //**4PS.n (call 11930)
        IF NOT Subcontracting THEN
          PostItemJnlLineTracking(
            PurchLine,TempWhseTrackingSpecification,TempTrackingSpecificationChargeAssmt,PostWhseJnlLine,QtyToBeInvoiced);

        OnBeforePostItemJnlLineJobConsumption(
          ItemJnlLine,PurchLine,PurchInvHeader,PurchCrMemoHeader,QtyToBeInvoiced,QtyToBeInvoicedBase,SrcCode);

        IF PurchLine."Job No." <> '' THEN
          IF NOT PostJobConsumptionBeforePurch THEN
            PostItemJnlLineJobConsumption(
              PurchHeader,PurchLine,OriginalItemJnlLine,TempReservationEntry,QtyToBeInvoiced,QtyToBeReceived,
              TempHandlingSpecification,"Item Shpt. Entry No.");

        IF PostWhseJnlLine THEN BEGIN
          PostItemJnlLineWhseLine(TempWhseJnlLine,TempWhseTrackingSpecification,PurchLine,PostJobConsumptionBeforePurch);
          OnAfterPostWhseJnlLine(PurchLine,ItemLedgShptEntryNo,WhseShip,WhseReceive,SuppressCommit);
        END;
        IF (PurchLine.Type = PurchLine.Type::Item) AND PurchHeader.Invoice THEN
          PostItemJnlLineItemCharges(
            PurchHeader,PurchLine,OriginalItemJnlLine,"Item Shpt. Entry No.",TempTrackingSpecificationChargeAssmt);
      END;

      OnAfterPostItemJnlLine(ItemJnlLine,PurchLine,PurchHeader,ItemJnlPostLine);

      EXIT(ItemJnlLine."Item Shpt. Entry No.");
    END;

    LOCAL PROCEDURE PostItemJnlLineCopyDocumentFields@308(VAR ItemJnlLine@1000 : Record 83;PurchHeader@1001 : Record 38;PurchLine@1002 : Record 39;QtyToBeInvoiced@1003 : Decimal;QtyToBeReceived@1004 : Decimal);
    BEGIN
      OnPostItemJnlLineOnBeforeCopyDocumentFields(ItemJnlLine,PurchHeader,PurchLine,WhseReceive,WhseShip,InvtPickPutaway);

      WITH ItemJnlLine DO
        IF QtyToBeReceived = 0 THEN
          IF PurchLine.IsCreditDocType THEN
            CopyDocumentFields(
              "Document Type"::"Purchase Credit Memo",GenJnlLineDocNo,GenJnlLineExtDocNo,SrcCode,PurchHeader."Posting No. Series")
          ELSE
            CopyDocumentFields(
              "Document Type"::"Purchase Invoice",GenJnlLineDocNo,GenJnlLineExtDocNo,SrcCode,PurchHeader."Posting No. Series")
        ELSE BEGIN
          IF PurchLine.IsCreditDocType THEN
            CopyDocumentFields(
              "Document Type"::"Purchase Return Shipment",
              ReturnShptHeader."No.",ReturnShptHeader."Vendor Authorization No.",SrcCode,ReturnShptHeader."No. Series")
          ELSE
            CopyDocumentFields(
              "Document Type"::"Purchase Receipt",
              PurchRcptHeader."No.",PurchRcptHeader."Vendor Shipment No.",SrcCode,PurchRcptHeader."No. Series");
          IF QtyToBeInvoiced <> 0 THEN BEGIN
            IF "Document No." = '' THEN
              IF PurchLine."Document Type" = PurchLine."Document Type"::"Credit Memo" THEN
                CopyDocumentFields(
                  "Document Type"::"Purchase Credit Memo",GenJnlLineDocNo,GenJnlLineExtDocNo,SrcCode,PurchHeader."Posting No. Series")
              ELSE
                CopyDocumentFields(
                  "Document Type"::"Purchase Invoice",GenJnlLineDocNo,GenJnlLineExtDocNo,SrcCode,PurchHeader."Posting No. Series");
          END;
        END;

      OnPostItemJnlLineOnAfterCopyDocumentFields(ItemJnlLine,PurchLine,TempWhseRcptHeader,TempWhseShptHeader);
    END;

    LOCAL PROCEDURE PostItemJnlLineCopyProdOrder@166(PurchLine@1000 : Record 39;VAR ItemJnlLine@1001 : Record 83;QtyToBeReceived@1002 : Decimal;QtyToBeInvoiced@1003 : Decimal);
    BEGIN
      WITH PurchLine DO BEGIN
        ItemJnlLine.Subcontracting := TRUE;
        ItemJnlLine."Quantity (Base)" := CalcBaseQty("No.","Unit of Measure Code",QtyToBeReceived);
        ItemJnlLine."Invoiced Qty. (Base)" := CalcBaseQty("No.","Unit of Measure Code",QtyToBeInvoiced);
        ItemJnlLine."Unit Cost" := "Unit Cost (LCY)";
        ItemJnlLine."Unit Cost (ACY)" := "Unit Cost";
        ItemJnlLine."Output Quantity (Base)" := ItemJnlLine."Quantity (Base)";
        ItemJnlLine."Output Quantity" := QtyToBeReceived;
        ItemJnlLine."Entry Type" := ItemJnlLine."Entry Type"::Output;
        ItemJnlLine.Type := ItemJnlLine.Type::"Work Center";
        ItemJnlLine."No." := "Work Center No.";
        ItemJnlLine."Routing No." := "Routing No.";
        ItemJnlLine."Routing Reference No." := "Routing Reference No.";
        ItemJnlLine."Operation No." := "Operation No.";
        ItemJnlLine."Work Center No." := "Work Center No.";
        ItemJnlLine."Unit Cost Calculation" := ItemJnlLine."Unit Cost Calculation"::Units;
        IF Finished THEN
          ItemJnlLine.Finished := Finished;
      END;
      OnAfterPostItemJnlLineCopyProdOrder(ItemJnlLine,PurchLine,PurchRcptHeader,QtyToBeReceived,SuppressCommit);
    END;

    LOCAL PROCEDURE PostItemJnlLineItemCharges@161(PurchHeader@1000 : Record 38;PurchLine@1001 : Record 39;VAR OriginalItemJnlLine@1003 : Record 83;ItemShptEntryNo@1004 : Integer;VAR TempTrackingSpecificationChargeAssmt@1005 : TEMPORARY Record 336);
    VAR
      ItemChargePurchLine@1002 : Record 39;
    BEGIN
      WITH PurchLine DO BEGIN
        ClearItemChargeAssgntFilter;
        TempItemChargeAssgntPurch.SETCURRENTKEY(
          "Applies-to Doc. Type","Applies-to Doc. No.","Applies-to Doc. Line No.");
        TempItemChargeAssgntPurch.SETRANGE("Applies-to Doc. Type","Document Type");
        TempItemChargeAssgntPurch.SETRANGE("Applies-to Doc. No.","Document No.");
        TempItemChargeAssgntPurch.SETRANGE("Applies-to Doc. Line No.","Line No.");
        IF TempItemChargeAssgntPurch.FIND('-') THEN
          REPEAT
            TESTFIELD("Allow Item Charge Assignment");
            GetItemChargeLine(PurchHeader,ItemChargePurchLine);
            ItemChargePurchLine.CALCFIELDS("Qty. Assigned");
            IF (ItemChargePurchLine."Qty. to Invoice" <> 0) OR
               (ABS(ItemChargePurchLine."Qty. Assigned") < ABS(ItemChargePurchLine."Quantity Invoiced"))
            THEN BEGIN
              OriginalItemJnlLine."Item Shpt. Entry No." := ItemShptEntryNo;
              PostItemChargePerOrder(
                PurchHeader,PurchLine,OriginalItemJnlLine,ItemChargePurchLine,TempTrackingSpecificationChargeAssmt);
              TempItemChargeAssgntPurch.MARK(TRUE);
            END;
          UNTIL TempItemChargeAssgntPurch.NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE PostItemJnlLineTracking@162(PurchLine@1000 : Record 39;VAR TempWhseTrackingSpecification@1002 : TEMPORARY Record 336;VAR TempTrackingSpecificationChargeAssmt@1004 : TEMPORARY Record 336;PostWhseJnlLine@1001 : Boolean;QtyToBeInvoiced@1003 : Decimal);
    BEGIN
      IF ItemJnlPostLine.CollectTrackingSpecification(TempHandlingSpecification) THEN
        IF TempHandlingSpecification.FIND('-') THEN
          REPEAT
            TempTrackingSpecification := TempHandlingSpecification;
            TempTrackingSpecification.SetSourceFromPurchLine(PurchLine);
            IF TempTrackingSpecification.INSERT THEN;
            IF QtyToBeInvoiced <> 0 THEN BEGIN
              TempTrackingSpecificationInv := TempTrackingSpecification;
              IF TempTrackingSpecificationInv.INSERT THEN;
            END;
            IF PostWhseJnlLine THEN BEGIN
              TempWhseTrackingSpecification := TempTrackingSpecification;
              IF TempWhseTrackingSpecification.INSERT THEN;
            END;
            TempTrackingSpecificationChargeAssmt := TempTrackingSpecification;
            TempTrackingSpecificationChargeAssmt.INSERT;
          UNTIL TempHandlingSpecification.NEXT = 0;
    END;

    LOCAL PROCEDURE PostItemJnlLineWhseLine@165(VAR TempWhseJnlLine@1000 : TEMPORARY Record 7311;VAR TempWhseTrackingSpecification@1002 : TEMPORARY Record 336;PurchLine@1003 : Record 39;PostBefore@1004 : Boolean);
    VAR
      TempWhseJnlLine2@1001 : TEMPORARY Record 7311;
    BEGIN
      ItemTrackingMgt.SplitWhseJnlLine(TempWhseJnlLine,TempWhseJnlLine2,TempWhseTrackingSpecification,FALSE);
      IF TempWhseJnlLine2.FIND('-') THEN
        REPEAT
          IF PurchLine.IsCreditDocType AND (PurchLine.Quantity > 0) OR
             PurchLine.IsInvoiceDocType AND (PurchLine.Quantity < 0)
          THEN
            CreatePositiveEntry(TempWhseJnlLine2,PurchLine."Job No.",PostBefore);
          WhseJnlPostLine.RUN(TempWhseJnlLine2);
          IF RevertWarehouseEntry(TempWhseJnlLine2,PurchLine."Job No.",PostBefore) THEN
            WhseJnlPostLine.RUN(TempWhseJnlLine2);
        UNTIL TempWhseJnlLine2.NEXT = 0;
      TempWhseTrackingSpecification.DELETEALL;
    END;

    LOCAL PROCEDURE ShouldPostWhseJnlLine@167(PurchLine@1000 : Record 39;VAR ItemJnlLine@1001 : Record 83;VAR TempWhseJnlLine@1002 : TEMPORARY Record 7311) : Boolean;
    BEGIN
      WITH PurchLine DO
        IF ("Location Code" <> '') AND (Type = Type::Item) AND (ItemJnlLine.Quantity <> 0) AND
           NOT ItemJnlLine.Subcontracting
        THEN BEGIN
          GetLocation("Location Code");
          IF (("Document Type" IN ["Document Type"::Invoice,"Document Type"::"Credit Memo"]) AND
              Location."Directed Put-away and Pick") OR
             (Location."Bin Mandatory" AND NOT (WhseReceive OR WhseShip OR InvtPickPutaway OR "Drop Shipment"))
          THEN BEGIN
            CreateWhseJnlLine(ItemJnlLine,PurchLine,TempWhseJnlLine);
            EXIT(TRUE);
          END;
        END;
    END;

    LOCAL PROCEDURE PostItemChargePerOrder@5801(PurchHeader@1013 : Record 38;PurchLine@1014 : Record 39;ItemJnlLine2@1001 : Record 83;ItemChargePurchLine@1002 : Record 39;VAR TempTrackingSpecificationChargeAssmt@1030 : TEMPORARY Record 336);
    VAR
      NonDistrItemJnlLine@1000 : Record 83;
      CurrExchRate@1003 : Record 330;
      OriginalAmt@1007 : Decimal;
      OriginalAmtACY@1008 : Decimal;
      OriginalDiscountAmt@1009 : Decimal;
      OriginalQty@1010 : Decimal;
      QtyToInvoice@1004 : Decimal;
      Factor@1005 : Decimal;
      TotalChargeAmt2@1011 : Decimal;
      TotalChargeAmtLCY2@1012 : Decimal;
      SignFactor@1006 : Integer;
    BEGIN
      OnBeforePostItemChargePerOrder(
        PurchHeader,PurchLine,ItemJnlLine2,ItemChargePurchLine,TempTrackingSpecificationChargeAssmt,SuppressCommit,
        TempItemChargeAssgntPurch);

      WITH TempItemChargeAssgntPurch DO BEGIN
        PurchLine.TESTFIELD("Allow Item Charge Assignment",TRUE);
        ItemJnlLine2."Document No." := GenJnlLineDocNo;
        ItemJnlLine2."External Document No." := GenJnlLineExtDocNo;
        ItemJnlLine2."Item Charge No." := "Item Charge No.";
        ItemJnlLine2.Description := ItemChargePurchLine.Description;
        ItemJnlLine2."Description 2" := ItemChargePurchLine."Description 2"; //**4PS01.n
        ItemJnlLine2."Document Line No." := ItemChargePurchLine."Line No.";
        ItemJnlLine2."Unit of Measure Code" := '';
        ItemJnlLine2."Qty. per Unit of Measure" := 1;
        IF "Document Type" IN ["Document Type"::"Return Order","Document Type"::"Credit Memo"] THEN
          QtyToInvoice :=
            CalcQtyToInvoice(PurchLine."Return Qty. to Ship (Base)",PurchLine."Qty. to Invoice (Base)")
        ELSE
          QtyToInvoice :=
            CalcQtyToInvoice(PurchLine."Qty. to Receive (Base)",PurchLine."Qty. to Invoice (Base)");
        IF ItemJnlLine2."Invoiced Quantity" = 0 THEN BEGIN
          ItemJnlLine2."Invoiced Quantity" := ItemJnlLine2.Quantity;
          ItemJnlLine2."Invoiced Qty. (Base)" := ItemJnlLine2."Quantity (Base)";
        END;
        ItemJnlLine2.Amount := "Amount to Assign" * ItemJnlLine2."Invoiced Qty. (Base)" / QtyToInvoice;
        IF "Document Type" IN ["Document Type"::"Return Order","Document Type"::"Credit Memo"] THEN
          ItemJnlLine2.Amount := -ItemJnlLine2.Amount;
        ItemJnlLine2."Unit Cost (ACY)" :=
          ROUND(
            ItemJnlLine2.Amount / ItemJnlLine2."Invoiced Qty. (Base)",
            Currency."Unit-Amount Rounding Precision");

        TotalChargeAmt2 := TotalChargeAmt2 + ItemJnlLine2.Amount;
        IF PurchHeader."Currency Code" <> '' THEN
          ItemJnlLine2.Amount :=
            CurrExchRate.ExchangeAmtFCYToLCY(
              1, PurchHeader."Job No.", //**4PS.n
        //    Usedate,PurchHeader."Currency Code",TotalChargeAmt2 + TotalPurchLine.Amount,PurchHeader."Currency Factor") - //**4PS.o
              Usedate,PurchHeader."Currency Code",TotalChargeAmt2 + TotalPurchLine.Amount,PurchHeader."Currency Factor",FALSE) - //**4PS.n
            TotalChargeAmtLCY2 - TotalPurchLineLCY.Amount
        ELSE
          ItemJnlLine2.Amount := TotalChargeAmt2 - TotalChargeAmtLCY2;

        TotalChargeAmtLCY2 := TotalChargeAmtLCY2 + ItemJnlLine2.Amount;
        ItemJnlLine2."Unit Cost" := ROUND(
            ItemJnlLine2.Amount / ItemJnlLine2."Invoiced Qty. (Base)",GLSetup."Unit-Amount Rounding Precision");
        ItemJnlLine2."Applies-to Entry" := ItemJnlLine2."Item Shpt. Entry No.";
        ItemJnlLine2."Overhead Rate" := 0;

        IF PurchHeader."Currency Code" <> '' THEN
          ItemJnlLine2."Discount Amount" := ROUND(
              CurrExchRate.ExchangeAmtFCYToLCY(
                1, PurchHeader."Job No.", //**4PS.n
                Usedate,PurchHeader."Currency Code",(ItemChargePurchLine."Inv. Discount Amount" +
                                                     ItemChargePurchLine."Line Discount Amount") *
                ItemJnlLine2."Invoiced Qty. (Base)" /
                ItemChargePurchLine."Quantity (Base)" * "Qty. to Assign" / QtyToInvoice,
              //PurchHeader."Currency Factor"),GLSetup."Amount Rounding Precision") //**4PS.o
                PurchHeader."Currency Factor",FALSE),GLSetup."Amount Rounding Precision") //**4PS.n
        ELSE
          ItemJnlLine2."Discount Amount" := ROUND(
              (ItemChargePurchLine."Line Discount Amount" + ItemChargePurchLine."Inv. Discount Amount") *
              ItemJnlLine2."Invoiced Qty. (Base)" /
              ItemChargePurchLine."Quantity (Base)" * "Qty. to Assign" / QtyToInvoice,
              GLSetup."Amount Rounding Precision");

        ItemJnlLine2."Shortcut Dimension 1 Code" := ItemChargePurchLine."Shortcut Dimension 1 Code";
        ItemJnlLine2."Shortcut Dimension 2 Code" := ItemChargePurchLine."Shortcut Dimension 2 Code";
        ItemJnlLine2."Dimension Set ID" := ItemChargePurchLine."Dimension Set ID";
        ItemJnlLine2."Gen. Prod. Posting Group" := ItemChargePurchLine."Gen. Prod. Posting Group";

        ItemJnlLine2."Cost Component" := ItemChargePurchLine."Cost Component"; //**4PS.n

        OnPostItemChargePerOrderOnAfterCopyToItemJnlLine(
          ItemJnlLine2,ItemChargePurchLine,GLSetup,QtyToInvoice,TempItemChargeAssgntPurch);
      END;

      WITH TempTrackingSpecificationChargeAssmt DO BEGIN
        RESET;
        SETRANGE("Source Type",DATABASE::"Purchase Line");
        SETRANGE("Source ID",TempItemChargeAssgntPurch."Applies-to Doc. No.");
        SETRANGE("Source Ref. No.",TempItemChargeAssgntPurch."Applies-to Doc. Line No.");
        IF ISEMPTY THEN
          ItemJnlPostLine.RunWithCheck(ItemJnlLine2)
        ELSE BEGIN
          FINDSET;
          NonDistrItemJnlLine := ItemJnlLine2;
          OriginalAmt := NonDistrItemJnlLine.Amount;
          OriginalAmtACY := NonDistrItemJnlLine."Amount (ACY)";
          OriginalDiscountAmt := NonDistrItemJnlLine."Discount Amount";
          OriginalQty := NonDistrItemJnlLine."Quantity (Base)";
          IF ("Quantity (Base)" / OriginalQty) > 0 THEN
            SignFactor := 1
          ELSE
            SignFactor := -1;
          REPEAT
            Factor := "Quantity (Base)" / OriginalQty * SignFactor;
            IF ABS("Quantity (Base)") < ABS(NonDistrItemJnlLine."Quantity (Base)") THEN BEGIN
              ItemJnlLine2."Quantity (Base)" := "Quantity (Base)";
              ItemJnlLine2."Invoiced Qty. (Base)" := ItemJnlLine2."Quantity (Base)";
              ItemJnlLine2."Amount (ACY)" :=
                ROUND(OriginalAmtACY * Factor,GLSetup."Amount Rounding Precision");
              ItemJnlLine2.Amount :=
                ROUND(OriginalAmt * Factor,GLSetup."Amount Rounding Precision");
              ItemJnlLine2."Unit Cost (ACY)" :=
                ROUND(ItemJnlLine2.Amount / ItemJnlLine2."Invoiced Qty. (Base)",
                  Currency."Unit-Amount Rounding Precision") * SignFactor;
              ItemJnlLine2."Unit Cost" :=
                ROUND(ItemJnlLine2.Amount / ItemJnlLine2."Invoiced Qty. (Base)",
                  GLSetup."Unit-Amount Rounding Precision") * SignFactor;
              ItemJnlLine2."Discount Amount" :=
                ROUND(OriginalDiscountAmt * Factor,GLSetup."Amount Rounding Precision");
              ItemJnlLine2."Item Shpt. Entry No." := "Item Ledger Entry No.";
              ItemJnlLine2."Applies-to Entry" := "Item Ledger Entry No.";
              ItemJnlLine2.CopyTrackingFromSpec(TempTrackingSpecificationChargeAssmt);
              ItemJnlPostLine.RunWithCheck(ItemJnlLine2);
              ItemJnlLine2."Location Code" := NonDistrItemJnlLine."Location Code";
              NonDistrItemJnlLine."Quantity (Base)" -= "Quantity (Base)";
              NonDistrItemJnlLine.Amount -= (ItemJnlLine2.Amount * SignFactor);
              NonDistrItemJnlLine."Amount (ACY)" -= (ItemJnlLine2."Amount (ACY)" * SignFactor);
              NonDistrItemJnlLine."Discount Amount" -= (ItemJnlLine2."Discount Amount" * SignFactor);
            END ELSE BEGIN
              NonDistrItemJnlLine."Quantity (Base)" := "Quantity (Base)";
              NonDistrItemJnlLine."Invoiced Qty. (Base)" := "Quantity (Base)";
              NonDistrItemJnlLine."Unit Cost" :=
                ROUND(NonDistrItemJnlLine.Amount / NonDistrItemJnlLine."Invoiced Qty. (Base)",
                  GLSetup."Unit-Amount Rounding Precision") * SignFactor;
              NonDistrItemJnlLine."Unit Cost (ACY)" :=
                ROUND(NonDistrItemJnlLine.Amount / NonDistrItemJnlLine."Invoiced Qty. (Base)",
                  Currency."Unit-Amount Rounding Precision") * SignFactor;
              NonDistrItemJnlLine."Item Shpt. Entry No." := "Item Ledger Entry No.";
              NonDistrItemJnlLine."Applies-to Entry" := "Item Ledger Entry No.";
              NonDistrItemJnlLine.CopyTrackingFromSpec(TempTrackingSpecificationChargeAssmt);
              ItemJnlPostLine.RunWithCheck(NonDistrItemJnlLine);
              NonDistrItemJnlLine."Location Code" := ItemJnlLine2."Location Code";
            END;
          UNTIL NEXT = 0;
        END;
      END;
    END;

    LOCAL PROCEDURE PostItemChargePerRcpt@5807(PurchHeader@1012 : Record 38;VAR PurchLine@1000 : Record 39);
    VAR
      PurchRcptLine@1002 : Record 121;
      TempItemLedgEntry@1003 : TEMPORARY Record 32;
      ItemTrackingMgt@1005 : Codeunit 6500;
      Sign@1011 : Decimal;
      DistributeCharge@1001 : Boolean;
    BEGIN
      IF NOT PurchRcptLine.GET(
           TempItemChargeAssgntPurch."Applies-to Doc. No.",TempItemChargeAssgntPurch."Applies-to Doc. Line No.")
      THEN
        ERROR(ReceiptLinesDeletedErr);

      Sign := GetSign(PurchRcptLine."Quantity (Base)");

      IF PurchRcptLine."Item Rcpt. Entry No." <> 0 THEN
        DistributeCharge :=
          CostCalcMgt.SplitItemLedgerEntriesExist(
            TempItemLedgEntry,PurchRcptLine."Quantity (Base)",PurchRcptLine."Item Rcpt. Entry No.")
      ELSE BEGIN
        DistributeCharge := TRUE;
        ItemTrackingMgt.CollectItemEntryRelation(TempItemLedgEntry,
          DATABASE::"Purch. Rcpt. Line",0,PurchRcptLine."Document No.",
          '',0,PurchRcptLine."Line No.",PurchRcptLine."Quantity (Base)");
      END;

      IF DistributeCharge THEN
        PostDistributeItemCharge(
          PurchHeader,PurchLine,TempItemLedgEntry,PurchRcptLine."Quantity (Base)",
          TempItemChargeAssgntPurch."Qty. to Assign",TempItemChargeAssgntPurch."Amount to Assign",
          Sign,PurchRcptLine."Indirect Cost %")
      ELSE
        PostItemCharge(PurchHeader,PurchLine,
          PurchRcptLine."Item Rcpt. Entry No.",PurchRcptLine."Quantity (Base)",
          TempItemChargeAssgntPurch."Amount to Assign" * Sign,
          TempItemChargeAssgntPurch."Qty. to Assign",
          PurchRcptLine."Indirect Cost %");
    END;

    LOCAL PROCEDURE PostItemChargePerRetShpt@5811(PurchHeader@1012 : Record 38;VAR PurchLine@1000 : Record 39);
    VAR
      ReturnShptLine@1002 : Record 6651;
      TempItemLedgEntry@1010 : TEMPORARY Record 32;
      ItemTrackingMgt@1009 : Codeunit 6500;
      Sign@1011 : Decimal;
      DistributeCharge@1001 : Boolean;
      IsHandled@1003 : Boolean;
    BEGIN
      ReturnShptLine.GET(
        TempItemChargeAssgntPurch."Applies-to Doc. No.",TempItemChargeAssgntPurch."Applies-to Doc. Line No.");

      IsHandled := FALSE;
      OnPostItemChargePerRetShptOnBeforeTestJobNo(ReturnShptLine,IsHandled);
      IF NOT IsHandled THEN
        ReturnShptLine.TESTFIELD("Job No.",'');

      Sign := GetSign(PurchLine."Line Amount");
      IF PurchLine.IsCreditDocType THEN
        Sign := -Sign;

      IF ReturnShptLine."Item Shpt. Entry No." <> 0 THEN
        DistributeCharge :=
          CostCalcMgt.SplitItemLedgerEntriesExist(
            TempItemLedgEntry,-ReturnShptLine."Quantity (Base)",ReturnShptLine."Item Shpt. Entry No.")
      ELSE BEGIN
        DistributeCharge := TRUE;
        ItemTrackingMgt.CollectItemEntryRelation(TempItemLedgEntry,
          DATABASE::"Return Shipment Line",0,ReturnShptLine."Document No.",
          '',0,ReturnShptLine."Line No.",ReturnShptLine."Quantity (Base)");
      END;

      IF DistributeCharge THEN
        PostDistributeItemCharge(
          PurchHeader,PurchLine,TempItemLedgEntry,-ReturnShptLine."Quantity (Base)",
          TempItemChargeAssgntPurch."Qty. to Assign",ABS(TempItemChargeAssgntPurch."Amount to Assign"),
          Sign,ReturnShptLine."Indirect Cost %")
      ELSE
        PostItemCharge(PurchHeader,PurchLine,
          ReturnShptLine."Item Shpt. Entry No.",-ReturnShptLine."Quantity (Base)",
          ABS(TempItemChargeAssgntPurch."Amount to Assign") * Sign,
          TempItemChargeAssgntPurch."Qty. to Assign",
          ReturnShptLine."Indirect Cost %");
    END;

    LOCAL PROCEDURE PostItemChargePerTransfer@23(PurchHeader@1018 : Record 38;VAR PurchLine@1000 : Record 39);
    VAR
      TransRcptLine@1002 : Record 5747;
      ItemApplnEntry@1003 : Record 339;
      DummyTrackingSpecification@1001 : Record 336;
      PurchLine2@1016 : Record 39;
      CurrExchRate@1017 : Record 330;
      TotalAmountToPostFCY@1004 : Decimal;
      TotalAmountToPostLCY@1005 : Decimal;
      TotalDiscAmountToPost@1006 : Decimal;
      AmountToPostFCY@1007 : Decimal;
      AmountToPostLCY@1008 : Decimal;
      DiscAmountToPost@1009 : Decimal;
      RemAmountToPostFCY@1010 : Decimal;
      RemAmountToPostLCY@1011 : Decimal;
      RemDiscAmountToPost@1012 : Decimal;
      CalcAmountToPostFCY@1013 : Decimal;
      CalcAmountToPostLCY@1014 : Decimal;
      CalcDiscAmountToPost@1015 : Decimal;
    BEGIN
      WITH TempItemChargeAssgntPurch DO BEGIN
        TransRcptLine.GET("Applies-to Doc. No.","Applies-to Doc. Line No.");
        PurchLine2 := PurchLine;
        PurchLine2."No." := "Item No.";
        PurchLine2."Variant Code" := TransRcptLine."Variant Code";
        PurchLine2."Location Code" := TransRcptLine."Transfer-to Code";
        PurchLine2."Bin Code" := '';
        PurchLine2."Line No." := "Document Line No.";

        IF TransRcptLine."Item Rcpt. Entry No." = 0 THEN
          PostItemChargePerITTransfer(PurchHeader,PurchLine,TransRcptLine)
        ELSE BEGIN
          TotalAmountToPostFCY := "Amount to Assign";
          IF PurchHeader."Currency Code" <> '' THEN
            TotalAmountToPostLCY :=
              CurrExchRate.ExchangeAmtFCYToLCY(
               1, PurchHeader."Job No.", //**4PS.n
                Usedate,PurchHeader."Currency Code",
      //        TotalAmountToPostFCY,PurchHeader."Currency Factor") //**4PS.o
                TotalAmountToPostFCY,PurchHeader."Currency Factor",FALSE) //**4PS.n
          ELSE
            TotalAmountToPostLCY := TotalAmountToPostFCY;

          TotalDiscAmountToPost :=
            ROUND(
              PurchLine2."Inv. Discount Amount" / PurchLine2.Quantity * "Qty. to Assign",
              GLSetup."Amount Rounding Precision");
          TotalDiscAmountToPost :=
            TotalDiscAmountToPost +
            ROUND(
              PurchLine2."Line Discount Amount" * ("Qty. to Assign" / PurchLine2."Qty. to Invoice"),
              GLSetup."Amount Rounding Precision");

          TotalAmountToPostLCY := ROUND(TotalAmountToPostLCY,GLSetup."Amount Rounding Precision");

          ItemApplnEntry.SETCURRENTKEY("Outbound Item Entry No.","Item Ledger Entry No.","Cost Application");
          ItemApplnEntry.SETRANGE("Outbound Item Entry No.",TransRcptLine."Item Rcpt. Entry No.");
          ItemApplnEntry.SETFILTER("Item Ledger Entry No.",'<>%1',TransRcptLine."Item Rcpt. Entry No.");
          ItemApplnEntry.SETRANGE("Cost Application",TRUE);
          IF ItemApplnEntry.FINDSET THEN
            REPEAT
              PurchLine2."Appl.-to Item Entry" := ItemApplnEntry."Item Ledger Entry No.";
              CalcAmountToPostFCY :=
                ((TotalAmountToPostFCY / TransRcptLine."Quantity (Base)") * ItemApplnEntry.Quantity) +
                RemAmountToPostFCY;
              AmountToPostFCY := ROUND(CalcAmountToPostFCY);
              RemAmountToPostFCY := CalcAmountToPostFCY - AmountToPostFCY;
              CalcAmountToPostLCY :=
                ((TotalAmountToPostLCY / TransRcptLine."Quantity (Base)") * ItemApplnEntry.Quantity) +
                RemAmountToPostLCY;
              AmountToPostLCY := ROUND(CalcAmountToPostLCY);
              RemAmountToPostLCY := CalcAmountToPostLCY - AmountToPostLCY;
              CalcDiscAmountToPost :=
                ((TotalDiscAmountToPost / TransRcptLine."Quantity (Base)") * ItemApplnEntry.Quantity) +
                RemDiscAmountToPost;
              DiscAmountToPost := ROUND(CalcDiscAmountToPost);
              RemDiscAmountToPost := CalcDiscAmountToPost - DiscAmountToPost;
              PurchLine2.Amount := AmountToPostLCY;
              PurchLine2."Inv. Discount Amount" := DiscAmountToPost;
              PurchLine2."Line Discount Amount" := 0;
              PurchLine2."Unit Cost" :=
                ROUND(AmountToPostFCY / ItemApplnEntry.Quantity,GLSetup."Unit-Amount Rounding Precision");
              PurchLine2."Unit Cost (LCY)" :=
                ROUND(AmountToPostLCY / ItemApplnEntry.Quantity,GLSetup."Unit-Amount Rounding Precision");
              IF "Document Type" IN ["Document Type"::"Return Order","Document Type"::"Credit Memo"] THEN
                PurchLine2.Amount := -PurchLine2.Amount;
              PostItemJnlLine(
                PurchHeader,PurchLine2,
                0,0,
                ItemApplnEntry.Quantity,ItemApplnEntry.Quantity,
                PurchLine2."Appl.-to Item Entry","Item Charge No.",DummyTrackingSpecification);
            UNTIL ItemApplnEntry.NEXT = 0;
        END;
      END;
    END;

    LOCAL PROCEDURE PostItemChargePerITTransfer@43(PurchHeader@1002 : Record 38;VAR PurchLine@1000 : Record 39;TransRcptLine@1017 : Record 5747);
    VAR
      TempItemLedgEntry@1016 : TEMPORARY Record 32;
      ItemTrackingMgt@1001 : Codeunit 6500;
    BEGIN
      WITH TempItemChargeAssgntPurch DO BEGIN
        ItemTrackingMgt.CollectItemEntryRelation(TempItemLedgEntry,
          DATABASE::"Transfer Receipt Line",0,TransRcptLine."Document No.",
          '',0,TransRcptLine."Line No.",TransRcptLine."Quantity (Base)");
        PostDistributeItemCharge(
          PurchHeader,PurchLine,TempItemLedgEntry,TransRcptLine."Quantity (Base)",
          "Qty. to Assign","Amount to Assign",1,0);
      END;
    END;

    LOCAL PROCEDURE PostItemChargePerSalesShpt@41(PurchHeader@1012 : Record 38;VAR PurchLine@1000 : Record 39);
    VAR
      SalesShptLine@1002 : Record 111;
      TempItemLedgEntry@1010 : TEMPORARY Record 32;
      ItemTrackingMgt@1009 : Codeunit 6500;
      Sign@1001 : Decimal;
      DistributeCharge@1011 : Boolean;
      IsHandled@1003 : Boolean;
    BEGIN
      IF NOT SalesShptLine.GET(
           TempItemChargeAssgntPurch."Applies-to Doc. No.",TempItemChargeAssgntPurch."Applies-to Doc. Line No.")
      THEN
        ERROR(RelatedItemLedgEntriesNotFoundErr);

      IsHandled := FALSE;
      OnPostItemChargePerSalesShptOnBeforeTestJobNo(SalesShptLine,IsHandled);
      IF NOT IsHandled THEN
        SalesShptLine.TESTFIELD("Job No.",'');

      Sign := -GetSign(SalesShptLine."Quantity (Base)");

      IF SalesShptLine."Item Shpt. Entry No." <> 0 THEN
        DistributeCharge :=
          CostCalcMgt.SplitItemLedgerEntriesExist(
            TempItemLedgEntry,-SalesShptLine."Quantity (Base)",SalesShptLine."Item Shpt. Entry No.")
      ELSE BEGIN
        DistributeCharge := TRUE;
        ItemTrackingMgt.CollectItemEntryRelation(TempItemLedgEntry,
          DATABASE::"Sales Shipment Line",0,SalesShptLine."Document No.",
          '',0,SalesShptLine."Line No.",SalesShptLine."Quantity (Base)");
      END;

      IF DistributeCharge THEN
        PostDistributeItemCharge(
          PurchHeader,PurchLine,TempItemLedgEntry,-SalesShptLine."Quantity (Base)",
          TempItemChargeAssgntPurch."Qty. to Assign",TempItemChargeAssgntPurch."Amount to Assign",Sign,0)
      ELSE
        PostItemCharge(PurchHeader,PurchLine,
          SalesShptLine."Item Shpt. Entry No.",-SalesShptLine."Quantity (Base)",
          TempItemChargeAssgntPurch."Amount to Assign" * Sign,
          TempItemChargeAssgntPurch."Qty. to Assign",0)
    END;

    LOCAL PROCEDURE PostItemChargePerRetRcpt@37(PurchHeader@1012 : Record 38;VAR PurchLine@1001 : Record 39);
    VAR
      ReturnRcptLine@1000 : Record 6661;
      TempItemLedgEntry@1011 : TEMPORARY Record 32;
      ItemTrackingMgt@1010 : Codeunit 6500;
      Sign@1003 : Decimal;
      DistributeCharge@1002 : Boolean;
      IsHandled@1004 : Boolean;
    BEGIN
      IF NOT ReturnRcptLine.GET(
           TempItemChargeAssgntPurch."Applies-to Doc. No.",TempItemChargeAssgntPurch."Applies-to Doc. Line No.")
      THEN
        ERROR(RelatedItemLedgEntriesNotFoundErr);

      IsHandled := FALSE;
      OnPostItemChargePerSalesRetRcptOnBeforeTestJobNo(ReturnRcptLine,IsHandled);
      IF NOT IsHandled THEN
        ReturnRcptLine.TESTFIELD("Job No.",'');

      Sign := GetSign(ReturnRcptLine."Quantity (Base)");

      IF ReturnRcptLine."Item Rcpt. Entry No." <> 0 THEN
        DistributeCharge :=
          CostCalcMgt.SplitItemLedgerEntriesExist(
            TempItemLedgEntry,ReturnRcptLine."Quantity (Base)",ReturnRcptLine."Item Rcpt. Entry No.")
      ELSE BEGIN
        DistributeCharge := TRUE;
        ItemTrackingMgt.CollectItemEntryRelation(TempItemLedgEntry,
          DATABASE::"Return Receipt Line",0,ReturnRcptLine."Document No.",
          '',0,ReturnRcptLine."Line No.",ReturnRcptLine."Quantity (Base)");
      END;

      IF DistributeCharge THEN
        PostDistributeItemCharge(
          PurchHeader,PurchLine,TempItemLedgEntry,ReturnRcptLine."Quantity (Base)",
          TempItemChargeAssgntPurch."Qty. to Assign",TempItemChargeAssgntPurch."Amount to Assign",Sign,0)
      ELSE
        PostItemCharge(PurchHeader,PurchLine,
          ReturnRcptLine."Item Rcpt. Entry No.",ReturnRcptLine."Quantity (Base)",
          TempItemChargeAssgntPurch."Amount to Assign" * Sign,
          TempItemChargeAssgntPurch."Qty. to Assign",0)
    END;

    LOCAL PROCEDURE PostDistributeItemCharge@66(PurchHeader@1000 : Record 38;PurchLine@1001 : Record 39;VAR TempItemLedgEntry@1002 : TEMPORARY Record 32;NonDistrQuantity@1003 : Decimal;NonDistrQtyToAssign@1004 : Decimal;NonDistrAmountToAssign@1005 : Decimal;Sign@1009 : Decimal;IndirectCostPct@1010 : Decimal);
    VAR
      Factor@1006 : Decimal;
      QtyToAssign@1007 : Decimal;
      AmountToAssign@1008 : Decimal;
    BEGIN
      IF TempItemLedgEntry.FINDSET THEN BEGIN
        REPEAT
          Factor := TempItemLedgEntry.Quantity / NonDistrQuantity;
          QtyToAssign := NonDistrQtyToAssign * Factor;
          AmountToAssign := ROUND(NonDistrAmountToAssign * Factor,GLSetup."Amount Rounding Precision");
          IF Factor < 1 THEN BEGIN
            PostItemCharge(PurchHeader,PurchLine,
              TempItemLedgEntry."Entry No.",TempItemLedgEntry.Quantity,
              AmountToAssign * Sign,QtyToAssign,IndirectCostPct);
            NonDistrQuantity := NonDistrQuantity - TempItemLedgEntry.Quantity;
            NonDistrQtyToAssign := NonDistrQtyToAssign - QtyToAssign;
            NonDistrAmountToAssign := NonDistrAmountToAssign - AmountToAssign;
          END ELSE // the last time
            PostItemCharge(PurchHeader,PurchLine,
              TempItemLedgEntry."Entry No.",TempItemLedgEntry.Quantity,
              NonDistrAmountToAssign * Sign,NonDistrQtyToAssign,IndirectCostPct);
        UNTIL TempItemLedgEntry.NEXT = 0;
      END ELSE
        ERROR(RelatedItemLedgEntriesNotFoundErr)
    END;

    LOCAL PROCEDURE PostAssocItemJnlLine@3(PurchHeader@1003 : Record 38;PurchLine@1004 : Record 39;QtyToBeShipped@1000 : Decimal;QtyToBeShippedBase@1001 : Decimal) : Integer;
    VAR
      ItemJnlLine@1009 : Record 83;
      TempHandlingSpecification2@1005 : TEMPORARY Record 336;
      ItemEntryRelation@1006 : Record 6507;
      SalesOrderHeader@1008 : Record 36;
      SalesOrderLine@1007 : Record 37;
    BEGIN
      SalesOrderHeader.GET(
        SalesOrderHeader."Document Type"::Order,PurchLine."Sales Order No.");
      SalesOrderLine.GET(
        SalesOrderLine."Document Type"::Order,PurchLine."Sales Order No.",PurchLine."Sales Order Line No.");

      InitAssocItemJnlLine(ItemJnlLine,SalesOrderHeader,SalesOrderLine,PurchHeader,QtyToBeShipped,QtyToBeShippedBase);

      IF SalesOrderLine."Job Contract Entry No." = 0 THEN BEGIN
        TransferReservToItemJnlLine(SalesOrderLine,ItemJnlLine,PurchLine,QtyToBeShippedBase,TRUE);
        OnBeforePostAssocItemJnlLine(ItemJnlLine,SalesOrderLine,SuppressCommit,PurchLine);
        ItemJnlPostLine.RunWithCheck(ItemJnlLine);
        // Handle Item Tracking
        IF ItemJnlPostLine.CollectTrackingSpecification(TempHandlingSpecification2) THEN BEGIN
          IF TempHandlingSpecification2.FINDSET THEN
            REPEAT
              TempTrackingSpecification := TempHandlingSpecification2;
              TempTrackingSpecification.SetSourceFromSalesLine(SalesOrderLine);
              IF TempTrackingSpecification.INSERT THEN;
              ItemEntryRelation.InitFromTrackingSpec(TempHandlingSpecification2);
              ItemEntryRelation.SetSource(DATABASE::"Sales Shipment Line",0,SalesOrderHeader."Shipping No.",SalesOrderLine."Line No.");
              ItemEntryRelation.SetOrderInfo(SalesOrderLine."Document No.",SalesOrderLine."Line No.");
              ItemEntryRelation.INSERT;
            UNTIL TempHandlingSpecification2.NEXT = 0;
          EXIT(0);
        END;
      END;

      EXIT(ItemJnlLine."Item Shpt. Entry No.");
    END;

    LOCAL PROCEDURE PostResourceLine@329(PurchaseHeader@1000 : Record 38;VAR PurchaseLine@1001 : Record 39);
    VAR
      IsHandled@1002 : Boolean;
    BEGIN
      IsHandled := FALSE;
      OnBeforePostResourceLine(PurchaseHeader,PurchaseLine,IsHandled);
      IF NOT IsHandled THEN
        ERROR(CannotPurchaseResourcesErr);
    END;

    LOCAL PROCEDURE InitAssocItemJnlLine@271(VAR ItemJnlLine@1000 : Record 83;SalesOrderHeader@1001 : Record 36;SalesOrderLine@1002 : Record 37;PurchHeader@1003 : Record 38;QtyToBeShipped@1004 : Decimal;QtyToBeShippedBase@1005 : Decimal);
    VAR
      CurrExchRate@1006 : Record 330;
    BEGIN
      OnBeforeInitAssocItemJnlLine(ItemJnlLine,SalesOrderHeader,SalesOrderLine,PurchHeader);

      WITH ItemJnlLine DO BEGIN
        INIT;
        CopyDocumentFields(
          "Document Type"::"Sales Shipment",SalesOrderHeader."Shipping No.",'',SrcCode,SalesOrderHeader."Posting No. Series");

        CopyFromSalesHeader(SalesOrderHeader);
        "Country/Region Code" := GetCountryCode(SalesOrderLine,SalesOrderHeader);
        "Posting Date" := PurchHeader."Posting Date";
        "Document Date" := PurchHeader."Document Date";

        CopyFromSalesLine(SalesOrderLine);
        "Derived from Blanket Order" := SalesOrderLine."Blanket Order No." <> '';
        "Applies-to Entry" := ItemLedgShptEntryNo;

        Quantity := QtyToBeShipped;
        "Quantity (Base)" := QtyToBeShippedBase;
        "Invoiced Quantity" := 0;
        "Invoiced Qty. (Base)" := 0;
        "Source Currency Code" := PurchHeader."Currency Code";

        Amount := SalesOrderLine.Amount * QtyToBeShipped / SalesOrderLine.Quantity;
        IF SalesOrderHeader."Currency Code" <> '' THEN BEGIN
          Amount :=
            ROUND(
              CurrExchRate.ExchangeAmtFCYToLCY(
                0, '', //**4PS.n
                SalesOrderHeader."Posting Date",SalesOrderHeader."Currency Code",
        //      Amount,SalesOrderHeader."Currency Factor")); //**4PS.o
                Amount,SalesOrderHeader."Currency Factor",TRUE)); //**4PS.n
          "Discount Amount" :=
            ROUND(
              CurrExchRate.ExchangeAmtFCYToLCY(
                0, '', //**4PS.n
                SalesOrderHeader."Posting Date",SalesOrderHeader."Currency Code",
        //      SalesOrderLine."Line Discount Amount",SalesOrderHeader."Currency Factor")); //**4PS.o
                SalesOrderLine."Line Discount Amount",SalesOrderHeader."Currency Factor",TRUE)); //**4PS.n
        END ELSE BEGIN
          Amount := ROUND(Amount);
          "Discount Amount" := SalesOrderLine."Line Discount Amount";
        END;
      END;

      OnAfterInitAssocItemJnlLine(ItemJnlLine,SalesOrderHeader,SalesOrderLine,PurchHeader);
    END;

    LOCAL PROCEDURE ReleasePurchDocument@136(VAR PurchHeader@1000 : Record 38);
    VAR
      PurchaseHeaderCopy@1007 : Record 38;
      ReleasePurchaseDocument@1005 : Codeunit 415;
      LinesWereModified@1006 : Boolean;
      PrevStatus@1001 : Option;
      IsHandled@1002 : Boolean;
    BEGIN
      WITH PurchHeader DO BEGIN
        IF NOT (Status = Status::Open) OR (Status = Status::"Pending Prepayment") THEN
          EXIT;

        PurchaseHeaderCopy := PurchHeader;
        PrevStatus := Status;
        LinesWereModified := ReleasePurchaseDocument.ReleasePurchaseHeader(PurchHeader,PreviewMode);
        IF LinesWereModified THEN
          RefreshTempLines(PurchHeader,TempPurchLineGlobal);
        TESTFIELD(Status,Status::Released);
        Status := PrevStatus;
        RestorePurchaseHeader(PurchHeader,PurchaseHeaderCopy);
        IF NOT PreviewMode THEN BEGIN
          MODIFY;
          COMMIT;
        END;
        IsHandled := FALSE;
        OnReleasePurchDocumentOnBeforeSetStatus(PurchHeader,IsHandled);
        IF NOT IsHandled THEN
          Status := Status::Released;
      END;
    END;

    LOCAL PROCEDURE TestPurchLine@139(PurchHeader@1004 : Record 38;PurchLine@1000 : Record 39);
    VAR
      DummyTrackingSpecification@1005 : Record 336;
      ErrorCounter@1100525001 : Integer;
      ErrorTxt@1100525002 : ARRAY [99] OF Text[250];
    BEGIN
      OnBeforeTestPurchLine(PurchLine,PurchHeader,SuppressCommit);

      WITH PurchLine DO BEGIN
        CASE Type OF
          Type::Item:
            DummyTrackingSpecification.CheckItemTrackingQuantity(
              DATABASE::"Purchase Line","Document Type","Document No.","Line No.",
              "Qty. to Receive (Base)","Qty. to Invoice (Base)",PurchHeader.Receive,PurchHeader.Invoice);
          Type::"Charge (Item)":
            TestPurchLineItemCharge(PurchLine);
          Type::"Fixed Asset":
            TestPurchLineFixedAsset(PurchLine);
          ELSE
            TestPurchLineOthers(PurchLine);
        END;
        TestPurchLineJob(PurchLine);

        //**4PS.sn
        IF "Qty. to Receive" <> 0 THEN
          CheckSigns;

        IF "Job No." <> '' THEN BEGIN
          Project.CHANGECOMPANY("Receiving Company");
          ProjectType.CHANGECOMPANY("Receiving Company");
          Project.GET("Job No.");
          Project.TESTFIELD("Project Type");
          ProjectType.GET(Project."Project Type");
          IF CheckStatusProjectAndService(PurchHeader,PurchLine) THEN
            CheckProjectStatus(TRUE);
          IF (Project."Posting Element Mandatory") AND ("No." <> '') THEN
            TESTFIELD(Element);
        END;
        IF "Service Order No." <> '' THEN
          IF CheckStatusProjectAndService(PurchHeader,PurchLine) THEN
            CheckServiceOrderStatus(TRUE);
        IF ("Plant Type" <> '') THEN BEGIN  //*33895.n
          TESTFIELD("Cost Component Plant");
          ValidatePlantNo(); //**4PS,SR, 05-12-13 Call C004021
        END;
        IF ("Deferral Code" <> '') AND ("Receiving Company" <> '') THEN
          ERROR(Text11012021);
        //**4PS.en

        CASE "Document Type" OF
          "Document Type"::Order:
            TESTFIELD("Return Qty. to Ship",0);
          "Document Type"::Invoice:
            BEGIN
              IF "Receipt No." = '' THEN
                TESTFIELD("Qty. to Receive",Quantity);
              TESTFIELD("Return Qty. to Ship",0);
              TESTFIELD("Qty. to Invoice",Quantity);
            END;
          "Document Type"::"Return Order":
            TESTFIELD("Qty. to Receive",0);
          "Document Type"::"Credit Memo":
            BEGIN
              IF "Return Shipment No." = '' THEN
                TESTFIELD("Return Qty. to Ship",Quantity);
            //TESTFIELD("Qty. to Receive",0); //**4PS.o
              TESTFIELD("Qty. to Invoice",Quantity);
            END;
        END;

        //**4PS.sn
        IF ("Document Type" = "Document Type"::Order) AND
            ("Purchase Order Type" = "Purchase Order Type"::"Return Order") AND
            (Type <> Type::" ")
        THEN BEGIN
          IF NOT PurchHeader."Amounts only" THEN BEGIN
            IF Quantity >= 0 THEN BEGIN
              IF NOT CheckReturnOrderAdminCostLine(PurchHeader,PurchLine) THEN
                FIELDERROR(Quantity,Text11012008);
            END;
            IF (Quantity < 0) AND (NOT "Vendor Charge") THEN
              IF NOT PurchSetup."Return Reason Not Mandatory" THEN
                TESTFIELD("Return Reason Code");
          END ELSE BEGIN
            IF "Line Amount" >= 0 THEN
              FIELDERROR("Line Amount", Text11012008);
            IF (NOT "Vendor Charge") THEN
              IF NOT PurchSetup."Return Reason Not Mandatory" THEN
                TESTFIELD("Return Reason Code");
          END;
        END;

        CompletionControl(PurchLine,ErrorCounter,ErrorTxt);
        IF ErrorCounter > 0 THEN
          ERROR(Text11012013,"Document No.","Line No.",ErrorTxt[1]);
        //**4PS.sn

      END;

      OnAfterTestPurchLine(PurchHeader,PurchLine,WhseReceive,WhseShip);
    END;

    LOCAL PROCEDURE TestPurchLineItemCharge@301(PurchaseLine@1000 : Record 39);
    VAR
      IsHandled@1001 : Boolean;
    BEGIN
      IsHandled := FALSE;
      OnBeforeTestPurchLineItemCharge(PurchaseLine,IsHandled);
      IF IsHandled THEN
        EXIT;

      WITH PurchaseLine DO BEGIN
        TESTFIELD(Amount);
        TESTFIELD("Job No.",'');
      END;
    END;

    LOCAL PROCEDURE TestPurchLineJob@304(PurchaseLine@1000 : Record 39);
    VAR
      IsHandled@1001 : Boolean;
    BEGIN
      IsHandled := FALSE;
      OnBeforeTestPurchLineJob(PurchaseLine,IsHandled);
      IF IsHandled THEN
        EXIT;

      WITH PurchaseLine DO
        IF "Job No." <> '' THEN
        //**4PS.so
        //  TESTFIELD("Job Task No.");
        //**4PS.eo
        ;
    END;

    LOCAL PROCEDURE TestPurchLineFixedAsset@302(PurchaseLine@1000 : Record 39);
    VAR
      FixedAsset@1001 : Record 5600;
      DeprBook@1002 : Record 5611;
      FASetup@1003 : Record 5603;
      IsHandled@1004 : Boolean;
    BEGIN
      IsHandled := FALSE;
      OnBeforeTestPurchLineFixedAsset(PurchaseLine,IsHandled);
      IF IsHandled THEN
        EXIT;

      WITH PurchaseLine DO BEGIN
        TESTFIELD("Job No.",'');

        //**4PS.sn
        TESTFIELD("Receiving Company",'');
        IF (("No." = '') AND CheckPlantCreateFAOnReceipt()) OR
            (("No." <> '') AND PlantReceivedAndCreatedOnOrder(PurchaseLine))
        THEN BEGIN
          IF "Depreciation Book Code" = '' THEN BEGIN
            DeprBook.INIT;
            DeprBook.Code := ''
          END ELSE BEGIN
            TESTFIELD("Depreciation Book Code");
            TESTFIELD("FA Posting Type");
            DeprBook.GET("Depreciation Book Code");
          END;
        END ELSE BEGIN
        //**4PS.en
          TESTFIELD("Depreciation Book Code");
          TESTFIELD("FA Posting Type");
          FixedAsset.GET("No.");
          FixedAsset.TESTFIELD("Budgeted Asset",FALSE);
          DeprBook.GET("Depreciation Book Code");
          IF "Budgeted FA No." <> '' THEN BEGIN
            FixedAsset.GET("Budgeted FA No.");
            FixedAsset.TESTFIELD("Budgeted Asset",TRUE);
          END;
        END; //**4PS.n

        IF "FA Posting Type" = "FA Posting Type"::Maintenance THEN BEGIN
          TESTFIELD("Insurance No.",'');
          TESTFIELD("Depr. until FA Posting Date",FALSE);
          TESTFIELD("Depr. Acquisition Cost",FALSE);
          DeprBook.TESTFIELD("G/L Integration - Maintenance",TRUE);
        END;
        IF "FA Posting Type" = "FA Posting Type"::"Acquisition Cost" THEN BEGIN
          TESTFIELD("Maintenance Code",'');
          IF DeprBook.Code <> '' THEN  //**4PS.n
            DeprBook.TESTFIELD("G/L Integration - Acq. Cost",TRUE);
        END;
        IF "Insurance No." <> '' THEN BEGIN
          FASetup.GET;
          FASetup.TESTFIELD("Insurance Depr. Book","Depreciation Book Code");
        END;
      END;
    END;

    LOCAL PROCEDURE TestPurchLineOthers@303(PurchaseLine@1000 : Record 39);
    VAR
      IsHandled@1001 : Boolean;
    BEGIN
      IsHandled := FALSE;
      OnBeforeTestPurchLineOthers(PurchaseLine,IsHandled);
      IF IsHandled THEN
        EXIT;

      WITH PurchaseLine DO BEGIN
        TESTFIELD("Depreciation Book Code",'');
        TESTFIELD("FA Posting Type",0);
        TESTFIELD("Maintenance Code",'');
        TESTFIELD("Insurance No.",'');
        TESTFIELD("Depr. until FA Posting Date",FALSE);
        TESTFIELD("Depr. Acquisition Cost",FALSE);
        TESTFIELD("Budgeted FA No.",'');
        TESTFIELD("FA Posting Date",0D);
        TESTFIELD("Salvage Value",0);
        TESTFIELD("Duplicate in Depreciation Book",'');
        TESTFIELD("Use Duplication List",FALSE);
      END;
    END;

    LOCAL PROCEDURE UpdateAssocOrder@4(VAR TempDropShptPostBuffer@1002 : TEMPORARY Record 223);
    VAR
      SalesSetup@1001 : Record 311;
      SalesOrderHeader@1004 : Record 36;
      SalesOrderLine@1003 : Record 37;
      ReserveSalesLine@1000 : Codeunit 99000832;
    BEGIN
      TempDropShptPostBuffer.RESET;
      IF TempDropShptPostBuffer.ISEMPTY THEN
        EXIT;
      SalesSetup.GET;
      IF TempDropShptPostBuffer.FINDSET THEN BEGIN
        REPEAT
          SalesOrderHeader.GET(
            SalesOrderHeader."Document Type"::Order,
            TempDropShptPostBuffer."Order No.");
          SalesOrderHeader."Last Shipping No." := SalesOrderHeader."Shipping No.";
          SalesOrderHeader."Shipping No." := '';
          SalesOrderHeader.MODIFY;
          ReserveSalesLine.UpdateItemTrackingAfterPosting(SalesOrderHeader);
          TempDropShptPostBuffer.SETRANGE("Order No.",TempDropShptPostBuffer."Order No.");
          REPEAT
            SalesOrderLine.GET(
              SalesOrderLine."Document Type"::Order,
              TempDropShptPostBuffer."Order No.",TempDropShptPostBuffer."Order Line No.");
            SalesOrderLine."Quantity Shipped" := SalesOrderLine."Quantity Shipped" + TempDropShptPostBuffer.Quantity;
            SalesOrderLine."Qty. Shipped (Base)" := SalesOrderLine."Qty. Shipped (Base)" + TempDropShptPostBuffer."Quantity (Base)";
            SalesOrderLine.InitOutstanding;
            IF SalesSetup."Default Quantity to Ship" <> SalesSetup."Default Quantity to Ship"::Blank THEN
              SalesOrderLine.InitQtyToShip
            ELSE BEGIN
              SalesOrderLine."Qty. to Ship" := 0;
              SalesOrderLine."Qty. to Ship (Base)" := 0;
            END;
            SalesOrderLine.MODIFY;
            OnUpdateAssocOrderOnAfterSalesOrderLineModify(SalesOrderLine,TempDropShptPostBuffer);
          UNTIL TempDropShptPostBuffer.NEXT = 0;
          TempDropShptPostBuffer.SETRANGE("Order No.");
        UNTIL TempDropShptPostBuffer.NEXT = 0;
        TempDropShptPostBuffer.DELETEALL;
      END;
    END;

    LOCAL PROCEDURE UpdateAssosOrderPostingNos@121(PurchHeader@1000 : Record 38) DropShipment : Boolean;
    VAR
      TempPurchLine@1001 : TEMPORARY Record 39;
      SalesOrderHeader@1002 : Record 36;
      NoSeriesMgt@1003 : Codeunit 396;
      ReleaseSalesDocument@1004 : Codeunit 414;
    BEGIN
      WITH PurchHeader DO BEGIN
        ResetTempLines(TempPurchLine);
        //**4PS.sn
        PutPromisedReceiveDateFilter(TempPurchLine);
        PutReceiveMarkedOnlyFilter(TempPurchLine); //DP00556
        //**4PS.en
        TempPurchLine.SETFILTER("Sales Order Line No.",'<>0');
        DropShipment := NOT TempPurchLine.ISEMPTY;

        TempPurchLine.SETFILTER("Qty. to Receive",'<>0');
        IF DropShipment AND Receive THEN
          IF TempPurchLine.FINDSET THEN
            REPEAT
              IF SalesOrderHeader."No." <> TempPurchLine."Sales Order No." THEN BEGIN
                SalesOrderHeader.GET(SalesOrderHeader."Document Type"::Order,TempPurchLine."Sales Order No.");
                SalesOrderHeader.TESTFIELD("Bill-to Customer No.");
                SalesOrderHeader.Ship := TRUE;
                ReleaseSalesDocument.ReleaseSalesHeader(SalesOrderHeader,PreviewMode);
                IF SalesOrderHeader."Shipping No." = '' THEN BEGIN
                  SalesOrderHeader.TESTFIELD("Shipping No. Series");
                  SalesOrderHeader."Shipping No." :=
                    NoSeriesMgt.GetNextNo(SalesOrderHeader."Shipping No. Series","Posting Date",TRUE);
                  SalesOrderHeader.MODIFY;
                END;
              END;
            UNTIL TempPurchLine.NEXT = 0;

        EXIT(DropShipment);
      END;
    END;

    LOCAL PROCEDURE UpdateAfterPosting@137(PurchHeader@1001 : Record 38);
    VAR
      TempPurchLine@1002 : TEMPORARY Record 39;
    BEGIN
      WITH TempPurchLine DO BEGIN
        ResetTempLines(TempPurchLine);
        SETFILTER("Blanket Order Line No.",'<>0');
        IF FINDSET THEN
          REPEAT
            UpdateBlanketOrderLine(TempPurchLine,PurchHeader.Receive,PurchHeader.Ship,PurchHeader.Invoice);
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE UpdateLastPostingNos@153(VAR PurchHeader@1000 : Record 38);
    BEGIN
      WITH PurchHeader DO BEGIN
        IF Receive THEN BEGIN
          "Last Receiving No." := "Receiving No.";
          "Receiving No." := '';
        END;
      //IF Invoice THEN BEGIN //**4PS.o
        IF Invoice OR "Register Invoice" THEN BEGIN //**4PS.n
          "Last Posting No." := "Posting No.";
          "Posting No." := '';
        END;
        IF Ship THEN BEGIN
          "Last Return Shipment No." := "Return Shipment No.";
          "Return Shipment No." := '';
        END;
      END;
    END;

    LOCAL PROCEDURE UpdatePostingNos@125(VAR PurchHeader@1000 : Record 38) ModifyHeader : Boolean;
    VAR
      NoSeriesMgt@1001 : Codeunit 396;
    BEGIN
      WITH PurchHeader DO BEGIN
        IF Receive AND ("Receiving No." = '') THEN
          IF ("Document Type" = "Document Type"::Order) OR
             (("Document Type" = "Document Type"::Invoice) AND PurchSetup."Receipt on Invoice")
          THEN
            IF NOT PreviewMode THEN BEGIN
              TESTFIELD("Receiving No. Series");
              "Receiving No." := NoSeriesMgt.GetNextNo("Receiving No. Series","Posting Date",TRUE);
              ModifyHeader := TRUE;
            END ELSE
              "Receiving No." := PostingPreviewNoTok;

        IF Ship AND ("Return Shipment No." = '') THEN
          IF ("Document Type" = "Document Type"::"Return Order") OR
             (("Document Type" = "Document Type"::"Credit Memo") AND PurchSetup."Return Shipment on Credit Memo")
          THEN
            IF NOT PreviewMode THEN BEGIN
              TESTFIELD("Return Shipment No. Series");
              "Return Shipment No." := NoSeriesMgt.GetNextNo("Return Shipment No. Series","Posting Date",TRUE);
              ModifyHeader := TRUE;
            END ELSE
              "Return Shipment No." := PostingPreviewNoTok;

      //IF Invoice AND ("Posting No." = '') THEN BEGIN //**4PS.o
        IF (Invoice OR "Register Invoice") AND ("Posting No." = '') THEN BEGIN //**4PS.n
          IF ("No. Series" <> '') OR
             ("Document Type" IN ["Document Type"::Order,"Document Type"::"Return Order"])
          THEN
            TESTFIELD("Posting No. Series");
          IF ("No. Series" <> "Posting No. Series") OR
             ("Document Type" IN ["Document Type"::Order,"Document Type"::"Return Order"])
          THEN BEGIN
            IF NOT PreviewMode THEN BEGIN
              "Posting No." := NoSeriesMgt.GetNextNo("Posting No. Series","Posting Date",TRUE);
              ModifyHeader := TRUE;
            END ELSE
              "Posting No." := PostingPreviewNoTok;
          END;
        END;
      END;

      OnAfterUpdatePostingNos(PurchHeader,NoSeriesMgt,SuppressCommit);
    END;

    LOCAL PROCEDURE UpdatePurchLineBeforePost@138(PurchHeader@1000 : Record 38;VAR PurchLine@1001 : Record 39);
    VAR
      GenJnlCheckLine@1100525000 : Codeunit 11;
    BEGIN
      OnBeforeUpdatePurchLineBeforePost(PurchLine,PurchHeader,WhseShip,WhseReceive,RoundingLineInserted,SuppressCommit);

      WITH PurchLine DO BEGIN
        IF NOT (PurchHeader.Receive OR RoundingLineInserted) THEN BEGIN
          "Qty. to Receive" := 0;
          "Qty. to Receive (Base)" := 0;
        END;

        IF NOT (PurchHeader.Ship OR RoundingLineInserted) THEN BEGIN
          "Return Qty. to Ship" := 0;
          "Return Qty. to Ship (Base)" := 0;
        END;

        //**4PS.so
        //IF (PurchHeader."Document Type" = PurchHeader."Document Type"::Invoice) AND ("Receipt No." <> '') THEN BEGIN
        //**4PS.eo
        //**4PS.sn
        IF (("Document Type" IN ["Document Type"::Invoice,"Document Type"::"Credit Memo"]) AND
            ("Receipt No." <> '')) THEN
        BEGIN
          "Amnt. to Receive" := 0;
        //**4PS.en
          "Quantity Received" := Quantity;
          "Qty. Received (Base)" := "Quantity (Base)";
          "Qty. to Receive" := 0;
          "Qty. to Receive (Base)" := 0;
        END;

        IF (PurchHeader."Document Type" = PurchHeader."Document Type"::"Credit Memo") AND ("Return Shipment No." <> '')
        THEN BEGIN
          "Return Qty. Shipped" := Quantity;
          "Return Qty. Shipped (Base)" := "Quantity (Base)";
          "Return Qty. to Ship" := 0;
          "Return Qty. to Ship (Base)" := 0;
        END;

        IF PurchHeader.Invoice THEN BEGIN
          //**4PS.sn
          //No Test for credit memo's or Amounts only.
          IF ("Document Type" <> "Document Type"::"Credit Memo") AND NOT PurchHeader."Amounts only" THEN
          //**4PS.en
            IF ABS("Qty. to Invoice") > ABS(MaxQtyToInvoice) THEN
              InitQtyToInvoice;
        END ELSE BEGIN
          "Qty. to Invoice" := 0;
          "Qty. to Invoice (Base)" := 0;
          "Amnt. to Invoice" := 0; //**4PS.n
        END;

        //**4PS.sn
        IF ("Document Type" = "Document Type"::Order) AND ("Employee No." <> '') THEN BEGIN
          //For (rental)orders use posting date of line instead of posting date in header
          IF GenJnlCheckLine.DateNotAllowed("Posting Date") THEN
            FIELDERROR("Posting Date",PostingDateNotAllowedErr);
        END ELSE
          IF PurchLine."Posting Date" <> PurchHeader."Posting Date" THEN BEGIN
            //Always copy posting date header
            PurchLine."Posting Date" := PurchHeader."Posting Date";
            IF NOT RoundingLineInserted THEN BEGIN
              PurchLine."Modified by" := USERID; //DP00469
              PurchLine."Last Date Modified" := TODAY;//DP00469
            END;
          END;
        //**4PS.en
      END;

      OnAfterUpdatePurchLineBeforePost(PurchLine,WhseShip,WhseReceive);
    END;

    LOCAL PROCEDURE UpdateWhseDocuments@156();
    BEGIN
      IF WhseReceive THEN BEGIN
        WhsePostRcpt.PostUpdateWhseDocuments(WhseRcptHeader);
        TempWhseRcptHeader.DELETE;
        OnUpdateWhseDocumentsOnAfterUpdateWhseRcpt(WhseRcptHeader);
      END;
      IF WhseShip THEN BEGIN
        WhsePostShpt.PostUpdateWhseDocuments(WhseShptHeader);
        TempWhseShptHeader.DELETE;
        OnUpdateWhseDocumentsOnAfterUpdateWhseShpt(WhseShptHeader);
      END;
    END;

    LOCAL PROCEDURE DeleteAfterPosting@158(VAR PurchHeader@1000 : Record 38);
    VAR
      PurchCommentLine@1001 : Record 43;
      PurchLine@1004 : Record 39;
      TempPurchLine@1003 : TEMPORARY Record 39;
      WarehouseRequest@1002 : Record 5765;
      SkipDelete@1005 : Boolean;
    BEGIN
      OnBeforeDeleteAfterPosting(PurchHeader,PurchInvHeader,PurchCrMemoHeader,SkipDelete,SuppressCommit);
      IF SkipDelete THEN
        EXIT;

      WITH PurchHeader DO BEGIN
        IF HASLINKS THEN
          DELETELINKS;
        // ExFlow
        IF ExFlowSetupExists THEN BEGIN
          IF "Document Type" = "Document Type"::"Credit Memo" THEN
            ExFlowPurchPost.FinishUpdateOfExDoc(PurchHeader,PurchCrMemoHeader."No.")
          ELSE
            ExFlowPurchPost.FinishUpdateOfExDoc(PurchHeader,PurchInvHeader."No.");
        END;
        // ExFlow
        DELETE;

        ReservePurchLine.DeleteInvoiceSpecFromHeader(PurchHeader);
        ResetTempLines(TempPurchLine);
        IF TempPurchLine.FINDFIRST THEN
          REPEAT
            IF TempPurchLine."Deferral Code" <> '' THEN
              DeferralUtilities.RemoveOrSetDeferralSchedule(
                '',DeferralUtilities.GetPurchDeferralDocType,'','',
                TempPurchLine."Document Type",
                TempPurchLine."Document No.",
                TempPurchLine."Line No.",0,0D,
                TempPurchLine.Description,
                '',
                TRUE);
            IF TempPurchLine.HASLINKS THEN
              TempPurchLine.DELETELINKS;
          UNTIL TempPurchLine.NEXT = 0;

        PurchLine.SETRANGE("Document Type","Document Type");
        PurchLine.SETRANGE("Document No.","No.");
        OnBeforePurchLineDeleteAll(PurchLine,SuppressCommit);
        PurchLine.DELETEALL;

        DeleteInwardHeader;  //NAVSE

        DeleteItemChargeAssgnt(PurchHeader);
        PurchCommentLine.DeleteComments("Document Type","No.");
        WarehouseRequest.DeleteRequest(DATABASE::"Purchase Line","Document Type","No.");
      END;

      OnAfterDeleteAfterPosting(PurchHeader,PurchInvHeader,PurchCrMemoHeader,SuppressCommit);
    END;

    LOCAL PROCEDURE FinalizePosting@155(VAR PurchHeader@1000 : Record 38;VAR TempDropShptPostBuffer@1003 : TEMPORARY Record 223;EverythingInvoiced@1001 : Boolean);
    VAR
      TempPurchLine@1002 : TEMPORARY Record 39;
      GenJnlPostPreview@1004 : Codeunit 19;
      ArchiveManagement@1005 : Codeunit 5063;
      PurchRcptLine@1100525001 : Record 121;
      PurchGetReceipt@1100525000 : Codeunit 74;
      SourceLink@1100525003 : RecordRef;
      TargetLink@1100525002 : RecordRef;
      DocumentLinkMgt@1100525004 : Codeunit 11012401;
      ApprovalManagement4PSConstr@1100528500 : Codeunit 11125349;
    BEGIN
      OnBeforeFinalizePosting(PurchHeader,TempPurchLineGlobal,EverythingInvoiced,SuppressCommit,GenJnlPostLine);

      //in 4PS Construct orders are not removed automatically
      WITH PurchHeader DO BEGIN
        //**4PS.so
        //IF ("Document Type" IN ["Document Type"::Order,"Document Type"::"Return Order"]) AND
        //   (NOT EverythingInvoiced)
        //**4PS.eo
        IF ("Document Type" IN ["Document Type"::Order,"Document Type"::"Return Order"]) //**4PS.n
        THEN BEGIN
          MODIFY;
          InsertTrackingSpecification(PurchHeader);
          PostUpdateOrderLine(PurchHeader);
          UpdateAssocOrder(TempDropShptPostBuffer);
          UpdateWhseDocuments;
          // ExFlow
          IF ExFlowSetupExists THEN
            ExFlowPurchPost.SetStatusToReceived(PurchHeader);
          // ExFlow
          WhsePurchRelease.Release(PurchHeader);
          UpdateItemChargeAssgnt;
        END ELSE BEGIN
          CASE "Document Type" OF
            "Document Type"::Invoice:
              BEGIN
              //PostUpdateInvoiceLine; //**4PS.o
                PostUpdateInvoiceLine(PurchHeader); //**4PS.n
                InsertTrackingSpecification(PurchHeader);
              END;
            "Document Type"::"Credit Memo":
              BEGIN
                //PostUpdateCreditMemoLine; //**4PS.o
                PostUpdateInvoiceLine(PurchHeader); //**4PS.n
                InsertTrackingSpecification(PurchHeader);
              END;
            ELSE BEGIN
              ResetTempLines(TempPurchLine);
              TempPurchLine.SETFILTER("Prepayment %",'<>0');
              IF TempPurchLine.FINDSET THEN
                REPEAT
                  DecrementPrepmtAmtInvLCY(
                    TempPurchLine,TempPurchLine."Prepmt. Amount Inv. (LCY)",TempPurchLine."Prepmt. VAT Amount Inv. (LCY)");
                UNTIL TempPurchLine.NEXT = 0;
            END;
          END;
          UpdateAfterPosting(PurchHeader);
          UpdateWhseDocuments;
        //NTR Start
          PurchHeader.DeleteInwardHeader;
        //NTR End
          ArchiveManagement.AutoArchivePurchDocument(PurchHeader);
          //**4PS.sn
          IF NOT ("Document Type" IN ["Document Type"::Order,"Document Type"::"Return Order"]) THEN BEGIN
            CASE "Document Type" OF
              "Document Type"::Invoice:
                 ApprovalManagement4PSConstr.CopyApprovalCommentsPurchaseHeaderToPostedDoc(PurchHeader,PurchInvHeader);
              "Document Type"::"Credit Memo":
                 ApprovalManagement4PSConstr.CopyApprovalCommentsPurchaseHeaderToPostedDoc(PurchHeader,PurchCrMemoHeader);
            END;
          //**4PS.en
            ApprovalsMgmt.DeleteApprovalEntries(RECORDID);
            IF NOT PreviewMode THEN
              DeleteAfterPosting(PurchHeader);
          END; //**4PS.n

          InsertValueEntryRelation;
        END;

        //**4PS.sn
        IF "Register Invoice" AND ("Document Type" = "Document Type"::Order) THEN BEGIN
          PurchGetReceipt.SetPurchHeader(PurchHeaderInvToApprove);
          PurchRcptLine.RESET;
          PurchRcptLine.SETFILTER("Order No.",PurchHeader."No.");
          PurchGetReceipt.CreateInvLines(PurchRcptLine);
        END;

        IF Receive THEN
          IF PurchRcptHeader."No." <> '' THEN BEGIN
            PurchRcptHeader.CALCFIELDS(Received, Invoiced);
            PurchRcptHeader."Received Not Invoiced" := PurchRcptHeader.Received - PurchRcptHeader.Invoiced;
            PurchRcptHeader.MODIFY;
            IF ("Document Type" = "Document Type"::Order) THEN
              CopyAndDeleteSubcontractHours(2, 3, "No.", PurchRcptHeader."No.");
          END;

        IF ReplaceDocLink THEN BEGIN
          SourceLink.GETTABLE(PurchHeader);
          IF "Document Type" IN ["Document Type"::Order, "Document Type"::Invoice] THEN
            TargetLink.GETTABLE(PurchInvHeader)
          ELSE
            TargetLink.GETTABLE(PurchCrMemoHeader);
          DocumentLinkMgt.ReplaceDocLink(SourceLink,TargetLink);
        END;
        //**4PS.en
      END;

      OnAfterFinalizePostingOnBeforeCommit(
        PurchHeader,PurchRcptHeader,PurchInvHeader,PurchCrMemoHeader,ReturnShptHeader,GenJnlPostLine,PreviewMode,SuppressCommit);

      IF PreviewMode THEN BEGIN
        Window.CLOSE;
        GenJnlPostPreview.ThrowError;
      END;

      //**4PS.sn
      OnAfterPostBeforeCommitPurchaseDoc(
        PurchHeader,GenJnlPostLine,PurchRcptHeader."No.",ReturnShptHeader."No.",PurchInvHeader."No.",PurchCrMemoHeader."No.");
      //**4PS.en

      IF NOT InvtPickPutaway THEN
        COMMIT;

      IF GUIALLOWED THEN
        Window.CLOSE;

      OnAfterFinalizePosting(
        PurchHeader,PurchRcptHeader,PurchInvHeader,PurchCrMemoHeader,ReturnShptHeader,GenJnlPostLine,PreviewMode,SuppressCommit);

      ClearPostBuffers;

      //**4PS.sn
      IF GUIALLOWED THEN
        IF ReceiptForPlantOrders <> '' THEN
          MESSAGE(Text11012009, ReceiptForPlantOrders);
      //**4PS.en
    END;

    LOCAL PROCEDURE FillInvoicePostBuffer@5804(PurchHeader@1012 : Record 38;PurchLine@1000 : Record 39;PurchLineACY@1001 : Record 39;VAR TempInvoicePostBuffer@1014 : TEMPORARY Record 49;VAR InvoicePostBuffer@1013 : Record 49);
    VAR
      GenPostingSetup@1007 : Record 252;
      TotalVAT@1005 : Decimal;
      TotalVATACY@1004 : Decimal;
      TotalAmount@1003 : Decimal;
      TotalAmountACY@1002 : Decimal;
      AmtToDefer@1011 : Decimal;
      AmtToDeferACY@1010 : Decimal;
      TotalVATBase@1015 : Decimal;
      TotalVATBaseACY@1006 : Decimal;
      DeferralAccount@1009 : Code[20];
      PurchAccount@1008 : Code[20];
      lvAccountNo@1100525000 : Code[20];
      IntercompanyRelation@1100525001 : Record 11012057;
      PurchaseLineExtension@1100525002 : Record 11020644;
      JobLoc@1100527300 : Record 11072003;
      VATIndicator@1100527301 : 'VAT,No VAT';
    BEGIN
      GenPostingSetup.GET(PurchLine."Gen. Bus. Posting Group",PurchLine."Gen. Prod. Posting Group");
      InvoicePostBuffer.PreparePurchase(PurchLine);
      //**4PS.sn
      lvAccountNo := PurchLine."No.";
      WITH InvoicePostBuffer DO BEGIN
        Description := PurchLineACY.Description;
        "Description 2" := PurchLineACY."Description 2";
        IF PurchLineACY.Type = PurchLineACY.Type::"G/L Account" THEN BEGIN
          IF PurchLineACY."Receiving Company" <> '' THEN BEGIN
            PurchLine.TESTFIELD("No.");
            IntercompanyRelation.GET(COMPANYNAME, PurchLineACY."Receiving Company");
            IntercompanyRelation.TESTFIELD("Receiving Company IC Account");
            IF PurchLine."Job No." <> '' THEN
              PurchLine.TESTFIELD("Shortcut Dimension 2 Code");
            "Intercompany Transaction" := TRUE;
            "Receiving Company" := PurchLineACY."Receiving Company";
            lvAccountNo := IntercompanyRelation.GetICAccountOfCurrentCompany;
            "G/L Account" := lvAccountNo;
            "Job No." := '';
            "Global Dimension 1 Code" := '';
            "Global Dimension 2 Code" := '';
            "Dimension Set ID" := 0;
            //T007402.sn
            IntercompanyRelation.AddICRelationDimsOfCurrentCompany(
              "Dimension Set ID","Global Dimension 1 Code","Global Dimension 2 Code");
            //T007402.en
            "Cost Component" := '';
            "System-Created Entry" := TRUE;
            CreateICEntry(PurchHeader,PurchLine,IntercompanyRelation);
          END;
        END;
        "Applies-to Retention ID" := PurchLine."Applies-to Retention ID"; //DP01406.n
      END;
      //**4PS.en
      InitAmounts(PurchLine,TotalVAT,TotalVATACY,TotalAmount,TotalAmountACY,AmtToDefer,AmtToDeferACY,DeferralAccount);
      InitVATBase(PurchLine,TotalVATBase,TotalVATBaseACY);

      //**4PS.sn
      WITH PurchLine DO BEGIN
        IF (PurchLine."Job No." <> '') AND JobLoc.GET(PurchLine."Job No.") THEN
          VATIndicator := JobLoc."VAT Indicator (Purchase)"
        ELSE
          VATIndicator := PurchSetup."VAT Indicator (Purchase)";

        IF VATIndicator = VATIndicator::"No VAT" THEN BEGIN
          IF (Type = Type::"G/L Account") AND
             ("Document Type" IN ["Document Type"::Invoice,"Document Type"::"Credit Memo"]) THEN BEGIN
            IF "VAT Calculation Type" <> "VAT Calculation Type"::"Reverse Charge VAT" THEN BEGIN
              TotalAmount := TotalAmount + TotalVAT;
              TotalAmountACY := TotalAmountACY + TotalVATACY;
              TotalVAT := 0;
              TotalVATACY := 0;
            END;
            InvoicePostBuffer."Block VAT Posting" := TRUE;
          END;
        END;
      END;
      //**4PS.en

      OnFillInvoicePostBufferOnAfterInitAmounts(
        PurchHeader,PurchLine,PurchLineACY,TempInvoicePostBuffer,InvoicePostBuffer,TotalAmount,TotalAmountACY);

      IF PurchSetup."Discount Posting" IN
         [PurchSetup."Discount Posting"::"Invoice Discounts",PurchSetup."Discount Posting"::"All Discounts"]
      THEN BEGIN
        CalcInvoiceDiscountPosting(PurchHeader,PurchLine,PurchLineACY,InvoicePostBuffer);

        IF PurchLine."VAT Calculation Type" = PurchLine."VAT Calculation Type"::"Sales Tax" THEN
          InvoicePostBuffer.SetSalesTaxForPurchLine(PurchLine);

        IF (InvoicePostBuffer.Amount <> 0) OR (InvoicePostBuffer."Amount (ACY)" <> 0) THEN BEGIN
          GenPostingSetup.TESTFIELD("Purch. Inv. Disc. Account");
          IF InvoicePostBuffer.Type = InvoicePostBuffer.Type::"Fixed Asset" THEN BEGIN
            FillInvoicePostBufferFADiscount(
      //      TempInvoicePostBuffer,InvoicePostBuffer,GenPostingSetup,PurchLine."No.", //**4PS.o
              TempInvoicePostBuffer,InvoicePostBuffer,GenPostingSetup,lvAccountNo, //**4PS.n
              TotalVAT,TotalVATACY,TotalAmount,TotalAmountACY,TotalVATBase,TotalVATBaseACY);
            InvoicePostBuffer.SetAccount(
              GenPostingSetup.GetPurchInvDiscAccount,TotalVAT,TotalVATACY,TotalAmount,TotalAmountACY);
            InvoicePostBuffer.UpdateVATBase(TotalVATBase,TotalVATBaseACY);
            InvoicePostBuffer.Type := InvoicePostBuffer.Type::"G/L Account";
            UpdateInvoicePostBuffer(TempInvoicePostBuffer,InvoicePostBuffer);
            InvoicePostBuffer.Type := InvoicePostBuffer.Type::"Fixed Asset";
          END ELSE BEGIN
            InvoicePostBuffer.SetAccount(
              GenPostingSetup.GetPurchInvDiscAccount,TotalVAT,TotalVATACY,TotalAmount,TotalAmountACY);
            InvoicePostBuffer.UpdateVATBase(TotalVATBase,TotalVATBaseACY);
            UpdateInvoicePostBuffer(TempInvoicePostBuffer,InvoicePostBuffer);
          END;
        END;
      END;

      IF PurchSetup."Discount Posting" IN
         [PurchSetup."Discount Posting"::"Line Discounts",PurchSetup."Discount Posting"::"All Discounts"]
      THEN BEGIN
        CalcLineDiscountPosting(PurchHeader,PurchLine,PurchLineACY,InvoicePostBuffer);

        IF PurchLine."VAT Calculation Type" = PurchLine."VAT Calculation Type"::"Sales Tax" THEN
          InvoicePostBuffer.SetSalesTaxForPurchLine(PurchLine);

        IF (InvoicePostBuffer.Amount <> 0) OR (InvoicePostBuffer."Amount (ACY)" <> 0) THEN BEGIN
          GenPostingSetup.TESTFIELD("Purch. Line Disc. Account");
          IF InvoicePostBuffer.Type = InvoicePostBuffer.Type::"Fixed Asset" THEN BEGIN
            FillInvoicePostBufferFADiscount(
      //      TempInvoicePostBuffer,InvoicePostBuffer,GenPostingSetup,PurchLine."No.", //**4PS.o
              TempInvoicePostBuffer,InvoicePostBuffer,GenPostingSetup,lvAccountNo, //**4PS.n
              TotalVAT,TotalVATACY,TotalAmount,TotalAmountACY,TotalVATBase,TotalVATBaseACY);
            InvoicePostBuffer.SetAccount(
              GenPostingSetup.GetPurchLineDiscAccount,TotalVAT,TotalVATACY,TotalAmount,TotalAmountACY);
            InvoicePostBuffer.UpdateVATBase(TotalVATBase,TotalVATBaseACY);
            InvoicePostBuffer.Type := InvoicePostBuffer.Type::"G/L Account";
            UpdateInvoicePostBuffer(TempInvoicePostBuffer,InvoicePostBuffer);
            InvoicePostBuffer.Type := InvoicePostBuffer.Type::"Fixed Asset";
          END ELSE BEGIN
            InvoicePostBuffer.SetAccount(
              GenPostingSetup.GetPurchLineDiscAccount,TotalVAT,TotalVATACY,TotalAmount,TotalAmountACY);
            InvoicePostBuffer.UpdateVATBase(TotalVATBase,TotalVATBaseACY);
            UpdateInvoicePostBuffer(TempInvoicePostBuffer,InvoicePostBuffer);
          END;
        END;
      END;

      DeferralUtilities.AdjustTotalAmountForDeferralsNoBase(
        PurchLine."Deferral Code",AmtToDefer,AmtToDeferACY,TotalAmount,TotalAmountACY);

      OnBeforeInvoicePostingBufferSetAmounts(
        PurchLine,TempInvoicePostBuffer,InvoicePostBuffer,
        TotalVAT,TotalVATACY,TotalAmount,TotalAmountACY,TotalVATBase,TotalVATBaseACY);

      IF PurchLine."VAT Calculation Type" = PurchLine."VAT Calculation Type"::"Reverse Charge VAT" THEN BEGIN
        IF PurchLine."Deferral Code" <> '' THEN
          InvoicePostBuffer.SetAmounts(
            TotalVAT,TotalVATACY,TotalAmount,TotalAmountACY,PurchLine."VAT Difference",TotalVATBase,TotalVATBaseACY)
        ELSE
          InvoicePostBuffer.SetAmountsNoVAT(TotalAmount,TotalAmountACY,PurchLine."VAT Difference")
      END ELSE
        IF (NOT PurchLine."Use Tax") OR (PurchLine."VAT Calculation Type" <> PurchLine."VAT Calculation Type"::"Sales Tax") THEN
          InvoicePostBuffer.SetAmounts(
            TotalVAT,TotalVATACY,TotalAmount,TotalAmountACY,PurchLine."VAT Difference",TotalVATBase,TotalVATBaseACY)
        ELSE
          InvoicePostBuffer.SetAmountsNoVAT(TotalAmount,TotalAmountACY,PurchLine."VAT Difference");

      IF PurchLine."VAT Calculation Type" = PurchLine."VAT Calculation Type"::"Sales Tax" THEN
        InvoicePostBuffer.SetSalesTaxForPurchLine(PurchLine);

      IF (PurchLine.Type = PurchLine.Type::"G/L Account") OR (PurchLine.Type = PurchLine.Type::"Fixed Asset") THEN
      //PurchAccount := PurchLine."No."; //**4PS.o
        PurchAccount := lvAccountNo //**4PS.n
      ELSE
        IF PurchLine.IsCreditDocType THEN
          PurchAccount := GenPostingSetup.GetPurchCrMemoAccount
        ELSE
          PurchAccount := GenPostingSetup.GetPurchAccount;

      InvoicePostBuffer.SetAccount(PurchAccount,TotalVAT,TotalVATACY,TotalAmount,TotalAmountACY);
      InvoicePostBuffer.UpdateVATBase(TotalVATBase,TotalVATBaseACY);
      InvoicePostBuffer."Auto. Acc. Group" := PurchLine."Auto. Acc. Group";  //NAVSE
      InvoicePostBuffer."Deferral Code" := PurchLine."Deferral Code";

      //**4PS.sn
      PurchaseLineExtension.GetPurchLineExtension(PurchLine."Document Type",PurchLine."Document No.",PurchLine."Line No.");
      InvoicePostBuffer."Expense Allowance Scheme" := PurchaseLineExtension."Expense Allowance Scheme";
      //**4PS.en

      //NTR Start
      InvoicePostBuffer."Auto. Acc. Group" := PurchLine."Auto. Acc. Group";  //NAVSE
      //NTR End

      OnAfterFillInvoicePostBuffer(InvoicePostBuffer,PurchLine,TempInvoicePostBuffer,SuppressCommit);
      UpdateInvoicePostBuffer(TempInvoicePostBuffer,InvoicePostBuffer);

      OnFillInvoicePostingBufferOnAfterUpdateInvoicePostBuffer(PurchHeader,PurchLine,InvoicePostBuffer,TempInvoicePostBuffer);

      IF PurchLine."Deferral Code" <> '' THEN BEGIN
        OnBeforeFillDeferralPostingBuffer(
          PurchLine,InvoicePostBuffer,TempInvoicePostBuffer,Usedate,InvDefLineNo,DeferralLineNo,SuppressCommit);
        FillDeferralPostingBuffer(PurchHeader,PurchLine,InvoicePostBuffer,AmtToDefer,AmtToDeferACY,DeferralAccount,PurchAccount);
      END;
    END;

    LOCAL PROCEDURE FillInvoicePostBufferFADiscount@81(VAR TempInvoicePostBuffer@1007 : TEMPORARY Record 49;VAR InvoicePostBuffer@1000 : Record 49;GenPostingSetup@1002 : Record 252;AccountNo@1008 : Code[20];TotalVAT@1003 : Decimal;TotalVATACY@1004 : Decimal;TotalAmount@1005 : Decimal;TotalAmountACY@1006 : Decimal;TotalVATBase@1009 : Decimal;TotalVATBaseACY@1010 : Decimal);
    VAR
      DeprBook@1001 : Record 5611;
    BEGIN
      DeprBook.GET(InvoicePostBuffer."Depreciation Book Code");
      IF DeprBook."Subtract Disc. in Purch. Inv." THEN BEGIN
        InvoicePostBuffer.SetAccount(AccountNo,TotalVAT,TotalVATACY,TotalAmount,TotalAmountACY);
        InvoicePostBuffer.UpdateVATBase(TotalVATBase,TotalVATBaseACY);
        UpdateInvoicePostBuffer(TempInvoicePostBuffer,InvoicePostBuffer);
        InvoicePostBuffer.ReverseAmounts;
        InvoicePostBuffer.SetAccount(
          GenPostingSetup.GetPurchFADiscAccount,TotalVAT,TotalVATACY,TotalAmount,TotalAmountACY);
        InvoicePostBuffer.UpdateVATBase(TotalVATBase,TotalVATBaseACY);
        InvoicePostBuffer.Type := InvoicePostBuffer.Type::"G/L Account";
        UpdateInvoicePostBuffer(TempInvoicePostBuffer,InvoicePostBuffer);
        InvoicePostBuffer.ReverseAmounts;
      END;
    END;

    LOCAL PROCEDURE UpdateInvoicePostBuffer@5(VAR TempInvoicePostBuffer@1001 : TEMPORARY Record 49;InvoicePostBuffer@1002 : Record 49);
    BEGIN
      IF InvoicePostBuffer.Type = InvoicePostBuffer.Type::"Fixed Asset" THEN BEGIN
        FALineNo := FALineNo + 1;
        InvoicePostBuffer."Fixed Asset Line No." := FALineNo;
      END;

      TempInvoicePostBuffer.Update(InvoicePostBuffer,InvDefLineNo,DeferralLineNo);
    END;

    LOCAL PROCEDURE InsertPrepmtAdjInvPostingBuf@79(PurchHeader@1003 : Record 38;PrepmtPurchLine@1000 : Record 39;VAR TempInvoicePostBuffer@1005 : TEMPORARY Record 49;InvoicePostBuffer@1006 : Record 49);
    VAR
      PurchPostPrepayments@1002 : Codeunit 444;
      AdjAmount@1001 : Decimal;
    BEGIN
      WITH PrepmtPurchLine DO
        IF "Prepayment Line" THEN
          IF "Prepmt. Amount Inv. (LCY)" <> 0 THEN BEGIN
            AdjAmount := -"Prepmt. Amount Inv. (LCY)";
            TempInvoicePostBuffer.FillPrepmtAdjBuffer(TempInvoicePostBuffer,InvoicePostBuffer,
              "No.",AdjAmount,PurchHeader."Currency Code" = '');
            TempInvoicePostBuffer.FillPrepmtAdjBuffer(TempInvoicePostBuffer,InvoicePostBuffer,
              PurchPostPrepayments.GetCorrBalAccNo(PurchHeader,AdjAmount > 0),
              -AdjAmount,
              PurchHeader."Currency Code" = '');
          END ELSE
            IF ("Prepayment %" = 100) AND ("Prepmt. VAT Amount Inv. (LCY)" <> 0) THEN
              TempInvoicePostBuffer.FillPrepmtAdjBuffer(TempInvoicePostBuffer,InvoicePostBuffer,
                PurchPostPrepayments.GetInvRoundingAccNo(PurchHeader."Vendor Posting Group"),
                "Prepmt. VAT Amount Inv. (LCY)",PurchHeader."Currency Code" = '');
    END;

    LOCAL PROCEDURE GetCurrency@17(CurrencyCode@1000 : Code[10]);
    BEGIN
      IF CurrencyCode = '' THEN
        Currency.InitRoundingPrecision
      ELSE BEGIN
        Currency.GET(CurrencyCode);
        Currency.TESTFIELD("Amount Rounding Precision");
      END;
    END;

    LOCAL PROCEDURE DivideAmount@8(PurchHeader@1004 : Record 38;VAR PurchLine@1005 : Record 39;QtyType@1000 : 'General,Invoicing,Shipping';PurchLineQty@1001 : Decimal;VAR TempVATAmountLine@1002 : TEMPORARY Record 290;VAR TempVATAmountLineRemainder@1003 : TEMPORARY Record 290);
    VAR
      OriginalDeferralAmount@1006 : Decimal;
    BEGIN
      IF RoundingLineInserted AND (RoundingLineNo = PurchLine."Line No.") THEN
        EXIT;

      OnBeforeDivideAmount(PurchHeader,PurchLine,QtyType,PurchLineQty,TempVATAmountLine,TempVATAmountLineRemainder);

      WITH PurchLine DO
        //**4PS.sn
        BEGIN
          IF PurchHeader."Amounts only" THEN BEGIN
            PurchLineQty := 0;
            CASE QtyType OF
              QtyType::General:
                PurchLineQty := 1;
              QtyType::Invoicing:
                IF (PurchLine.Amount <> 0) AND (PurchLine."Amnt. to Invoice" <> 0) THEN
                  PurchLineQty := PurchLine."Amnt. to Invoice" / PurchLine.Amount;
              QtyType::Shipping:
                IF (PurchLine.Amount <> 0) AND (PurchLine."Amnt. to Receive" <> 0) THEN
                  PurchLineQty := PurchLine."Amnt. to Receive" / PurchLine.Amount;
            END;
          END;
        //**4PS.en
      //IF (PurchLineQty = 0) OR ("Direct Unit Cost" = 0) THEN BEGIN //**4PS.o
        IF (PurchLineQty = 0) OR (("Direct Unit Cost" = 0) AND ("Amount Including VAT" = 0)) THEN BEGIN //**4PS.n
          "Line Amount" := 0;
          "Line Discount Amount" := 0;
          "Inv. Discount Amount" := 0;
          "VAT Base Amount" := 0;
          Amount := 0;
          "Amount Including VAT" := 0;
        END ELSE BEGIN
          OriginalDeferralAmount := GetDeferralAmount;
          //**4PS.so
          //TempVATAmountLine.GET(
          //  "VAT Identifier","VAT Calculation Type","Tax Group Code","Use Tax","Line Amount" >= 0);
          //**4PS.eo
          //**4PS.sn
          //Call C023302: This is probably a solution for a problem we cannot reproduce at 4PS.
          //Because after the Error on 'GET' some other functions are not handled in a correct manner anymore.
          IF NOT TempVATAmountLine.GET(
             "VAT Identifier","VAT Calculation Type","Tax Group Code","Use Tax","Line Amount" >= 0)
          THEN
            EXIT;
          //**4PS.en
          IF "VAT Calculation Type" = "VAT Calculation Type"::"Sales Tax" THEN
            "VAT %" := TempVATAmountLine."VAT %";
          TempVATAmountLineRemainder := TempVATAmountLine;
          IF NOT TempVATAmountLineRemainder.FIND THEN BEGIN
            TempVATAmountLineRemainder.INIT;
            TempVATAmountLineRemainder.INSERT;
          END;
          "Line Amount" := GetLineAmountToHandleInclPrepmt(PurchLineQty) + GetPrepmtDiffToLineAmount(PurchLine);
          IF PurchLineQty <> Quantity THEN
            //**4PS.sn PS 12-06-13
            IF PurchHeader."Amounts only" THEN
              "Line Discount Amount" :=
                ROUND("Line Discount Amount" * PurchLineQty,Currency."Amount Rounding Precision")
            ELSE
            //**4PS.en
              "Line Discount Amount" :=
                ROUND("Line Discount Amount" * PurchLineQty / Quantity,Currency."Amount Rounding Precision");

          IF "Allow Invoice Disc." AND (TempVATAmountLine."Inv. Disc. Base Amount" <> 0) THEN
            IF QtyType = QtyType::Invoicing THEN
              "Inv. Discount Amount" := "Inv. Disc. Amount to Invoice"
            ELSE BEGIN
              TempVATAmountLineRemainder."Invoice Discount Amount" :=
                TempVATAmountLineRemainder."Invoice Discount Amount" +
                TempVATAmountLine."Invoice Discount Amount" * "Line Amount" /
                TempVATAmountLine."Inv. Disc. Base Amount";
              "Inv. Discount Amount" :=
                ROUND(
                  TempVATAmountLineRemainder."Invoice Discount Amount",Currency."Amount Rounding Precision");
              TempVATAmountLineRemainder."Invoice Discount Amount" :=
                TempVATAmountLineRemainder."Invoice Discount Amount" - "Inv. Discount Amount";
            END;

          IF PurchHeader."Prices Including VAT" THEN BEGIN
            IF NOT "Manually VAT Posting" THEN BEGIN //**4PS.n
              IF (TempVATAmountLine.CalcLineAmount = 0) OR ("Line Amount" = 0) THEN BEGIN
                TempVATAmountLineRemainder."VAT Amount" := 0;
                TempVATAmountLineRemainder."Amount Including VAT" := 0;
              END ELSE BEGIN
                TempVATAmountLineRemainder."VAT Amount" +=
                  TempVATAmountLine."VAT Amount" * CalcLineAmount / TempVATAmountLine.CalcLineAmount;
                TempVATAmountLineRemainder."Amount Including VAT" +=
                  TempVATAmountLine."Amount Including VAT" * CalcLineAmount / TempVATAmountLine.CalcLineAmount;
              END;
              IF "Line Discount %" <> 100 THEN
                "Amount Including VAT" :=
                  ROUND(TempVATAmountLineRemainder."Amount Including VAT",Currency."Amount Rounding Precision")
              ELSE
                "Amount Including VAT" := 0;
            END; //**4PS.n
            Amount :=
              ROUND("Amount Including VAT",Currency."Amount Rounding Precision") -
              ROUND(TempVATAmountLineRemainder."VAT Amount",Currency."Amount Rounding Precision");
            "VAT Base Amount" :=
              ROUND(
                Amount * (1 - PurchHeader."VAT Base Discount %" / 100),Currency."Amount Rounding Precision");
            TempVATAmountLineRemainder."Amount Including VAT" :=
              TempVATAmountLineRemainder."Amount Including VAT" - "Amount Including VAT";
            TempVATAmountLineRemainder."VAT Amount" :=
              TempVATAmountLineRemainder."VAT Amount" - "Amount Including VAT" + Amount;
          END ELSE
            IF "VAT Calculation Type" = "VAT Calculation Type"::"Full VAT" THEN BEGIN
              IF "Line Discount %" <> 100 THEN
                "Amount Including VAT" := CalcLineAmount
              ELSE
                "Amount Including VAT" := 0;
              Amount := 0;
              "VAT Base Amount" := 0;
            END ELSE BEGIN
              Amount := CalcLineAmount;
              "VAT Base Amount" :=
                ROUND(
                  Amount * (1 - PurchHeader."VAT Base Discount %" / 100),Currency."Amount Rounding Precision");
              IF NOT "Manually VAT Posting" THEN BEGIN //**4PS.n
                IF TempVATAmountLine."VAT Base" = 0 THEN
                  TempVATAmountLineRemainder."VAT Amount" := 0
                ELSE
                  TempVATAmountLineRemainder."VAT Amount" +=
                    TempVATAmountLine."VAT Amount" * CalcLineAmount / TempVATAmountLine.CalcLineAmount;
                IF "Line Discount %" <> 100 THEN
                  "Amount Including VAT" :=
                    Amount + ROUND(TempVATAmountLineRemainder."VAT Amount",Currency."Amount Rounding Precision")
                ELSE
                  "Amount Including VAT" := 0;
                TempVATAmountLineRemainder."VAT Amount" :=
                  TempVATAmountLineRemainder."VAT Amount" - "Amount Including VAT" + Amount;
              END; //**4PS.n
            END;

          TempVATAmountLineRemainder.MODIFY;
          IF "Deferral Code" <> '' THEN
            CalcDeferralAmounts(PurchHeader,PurchLine,OriginalDeferralAmount);
        END;

      END; //**4PS.n

      OnAfterDivideAmount(PurchHeader,PurchLine,QtyType,PurchLineQty,TempVATAmountLine,TempVATAmountLineRemainder);
    END;

    LOCAL PROCEDURE RoundAmount@9(PurchHeader@1003 : Record 38;VAR PurchLine@1004 : Record 39;PurchLineQty@1000 : Decimal);
    VAR
      CurrExchRate@1002 : Record 330;
      NoVAT@1001 : Boolean;
    BEGIN
      OnBeforeRoundAmount(PurchHeader,PurchLine,PurchLineQty);

      WITH PurchLine DO BEGIN
        IncrAmount(PurchHeader,PurchLine,TotalPurchLine);
        Increment(TotalPurchLine."Net Weight",ROUND(PurchLineQty * "Net Weight",UOMMgt.WeightRndPrecision));
        Increment(TotalPurchLine."Gross Weight",ROUND(PurchLineQty * "Gross Weight",UOMMgt.WeightRndPrecision));
        Increment(TotalPurchLine."Unit Volume",ROUND(PurchLineQty * "Unit Volume",UOMMgt.CubageRndPrecision));
        Increment(TotalPurchLine.Quantity,PurchLineQty);
        IF "Units per Parcel" > 0 THEN
          Increment(TotalPurchLine."Units per Parcel",ROUND(PurchLineQty / "Units per Parcel",1,'>'));

        xPurchLine := PurchLine;
        PurchLineACY := PurchLine;
        IF PurchHeader."Currency Code" <> '' THEN BEGIN
          IF PurchHeader."Posting Date" = 0D THEN
            Usedate := WORKDATE
          ELSE
            Usedate := PurchHeader."Posting Date";

          NoVAT := Amount = "Amount Including VAT";
          "Amount Including VAT" :=
            ROUND(
              CurrExchRate.ExchangeAmtFCYToLCY(
                1, PurchHeader."Job No.", //**4PS.n
                Usedate,PurchHeader."Currency Code",
      //        TotalPurchLine."Amount Including VAT",PurchHeader."Currency Factor") - //**4PS.o
                TotalPurchLine."Amount Including VAT",PurchHeader."Currency Factor",FALSE)) - //**4PS.n
            TotalPurchLineLCY."Amount Including VAT";
          IF NoVAT THEN
            Amount := "Amount Including VAT"
          ELSE
            Amount :=
              ROUND(
                CurrExchRate.ExchangeAmtFCYToLCY(
                  1, PurchHeader."Job No.", //**4PS.n
                  Usedate,PurchHeader."Currency Code",
      //          TotalPurchLine.Amount,PurchHeader."Currency Factor")) - //**4PS.o
                  TotalPurchLine.Amount,PurchHeader."Currency Factor",FALSE)) - //**4PS.n
              TotalPurchLineLCY.Amount;
          "Line Amount" :=
            ROUND(
              CurrExchRate.ExchangeAmtFCYToLCY(
                1, PurchHeader."Job No.", //**4PS.n
                Usedate,PurchHeader."Currency Code",
      //        TotalPurchLine."Line Amount",PurchHeader."Currency Factor")) - //**4PS.o
                TotalPurchLine."Line Amount",PurchHeader."Currency Factor",FALSE)) - //**4PS.n
            TotalPurchLineLCY."Line Amount";
          "Line Discount Amount" :=
            ROUND(
              CurrExchRate.ExchangeAmtFCYToLCY(
                1, PurchHeader."Job No.", //**4PS.n
                Usedate,PurchHeader."Currency Code",
       //       TotalPurchLine."Line Discount Amount",PurchHeader."Currency Factor")) - //**4PS.o
                TotalPurchLine."Line Discount Amount",PurchHeader."Currency Factor",FALSE)) - //**4PS.n
            TotalPurchLineLCY."Line Discount Amount";
          "Inv. Discount Amount" :=
            ROUND(
              CurrExchRate.ExchangeAmtFCYToLCY(
                1, PurchHeader."Job No.", //**4PS.n
                Usedate,PurchHeader."Currency Code",
      //        TotalPurchLine."Inv. Discount Amount",PurchHeader."Currency Factor")) - //**4PS.o
                TotalPurchLine."Inv. Discount Amount",PurchHeader."Currency Factor",FALSE)) - //**4PS.n
            TotalPurchLineLCY."Inv. Discount Amount";
          "VAT Difference" :=
            ROUND(
              CurrExchRate.ExchangeAmtFCYToLCY(
                1, PurchHeader."Job No.", //**4PS.n
                Usedate,PurchHeader."Currency Code",
      //        TotalPurchLine."VAT Difference",PurchHeader."Currency Factor")) - //**4PS.o
                TotalPurchLine."VAT Difference",PurchHeader."Currency Factor",FALSE)) - //**4PS.n
            TotalPurchLineLCY."VAT Difference";
          "VAT Base Amount" :=
            ROUND(
              CurrExchRate.ExchangeAmtFCYToLCY(
                1, PurchHeader."Job No.", //**4PS.n
                Usedate,PurchHeader."Currency Code",
      //        TotalPurchLine."VAT Base Amount",PurchHeader."Currency Factor")) - //**4PS.o
                TotalPurchLine."VAT Base Amount",PurchHeader."Currency Factor",FALSE)) - //**4PS.n
            TotalPurchLineLCY."VAT Base Amount";
        END;

        OnRoundAmountOnBeforeIncrAmount(PurchHeader,PurchLine,PurchLineQty,TotalPurchLine,TotalPurchLineLCY);

        IncrAmount(PurchHeader,PurchLine,TotalPurchLineLCY);
        Increment(TotalPurchLineLCY."Unit Cost (LCY)",ROUND(PurchLineQty * "Unit Cost (LCY)"));
      END;

      OnAfterRoundAmount(PurchHeader,PurchLine,PurchLineQty);
    END;

    [External]
    PROCEDURE ReverseAmount@10(VAR PurchLine@1000 : Record 39);
    BEGIN
      WITH PurchLine DO BEGIN
        //**4PS.sn
        "Amnt. to Invoice" := -"Amnt. to Invoice";
        "Amnt. to Receive" := -"Amnt. to Receive";
        //**4PS.en
        "Qty. to Receive" := -"Qty. to Receive";
        "Qty. to Receive (Base)" := -"Qty. to Receive (Base)";
        "Return Qty. to Ship" := -"Return Qty. to Ship";
        "Return Qty. to Ship (Base)" := -"Return Qty. to Ship (Base)";
        "Qty. to Invoice" := -"Qty. to Invoice";
        "Qty. to Invoice (Base)" := -"Qty. to Invoice (Base)";
        "Line Amount" := -"Line Amount";
        Amount := -Amount;
        "VAT Base Amount" := -"VAT Base Amount";
        "VAT Difference" := -"VAT Difference";
        "Amount Including VAT" := -"Amount Including VAT";
        "Line Discount Amount" := -"Line Discount Amount";
        "Inv. Discount Amount" := -"Inv. Discount Amount";
        "Salvage Value" := -"Salvage Value";
        OnAfterReverseAmount(PurchLine);
      END;
    END;

    LOCAL PROCEDURE InvoiceRounding@12(PurchHeader@1003 : Record 38;VAR PurchLine@1005 : Record 39;UseTempData@1000 : Boolean;BiggestLineNo@1004 : Integer) : Boolean;
    VAR
      VendPostingGr@1002 : Record 93;
      InvoiceRoundingAmount@1001 : Decimal;
      SavedStatusCheckSuspended@1100409000 : Boolean;
      lGLAcc@1100285500 : Record 15;
      HeadRoundingAmount@1101285000 : Decimal;
    BEGIN
      // ExFlow
      IF NOT ExFlowSetup.GET THEN
        CLEAR(ExFlowSetup);
      IF ExFlowSetup."Invoice Rounding" THEN BEGIN
        InvoiceRoundingAmount := ExFlowPurchPost.InvoiceRoundingAmount(TotalPurchLine."Amount Including VAT",
                                                                       PurchHeader."Gross Invoice Amount ExFlow",
                                                                       Currency,
                                                                       PurchHeader."Currency Factor");
      END
      ELSE BEGIN
      // ExFlow
        Currency.TESTFIELD("Invoice Rounding Precision");
        InvoiceRoundingAmount :=
          -ROUND(
            TotalPurchLine."Amount Including VAT" -
            ROUND(
              TotalPurchLine."Amount Including VAT",Currency."Invoice Rounding Precision",Currency.InvoiceRoundingDirection),
            Currency."Amount Rounding Precision");

        //>>190122, #22704
        HeadRoundingAmount :=
          ROUND(
            PurchHeader."Amount incl. VAT" -
            ROUND(
              PurchHeader."Amount incl. VAT",
              Currency."Invoice Rounding Precision",
              Currency.InvoiceRoundingDirection),
            Currency."Amount Rounding Precision");
        IF HeadRoundingAmount<>0 THEN InvoiceRoundingAmount += HeadRoundingAmount;
        //<<190122

      // ExFlow
      END;
      // ExFlow

      OnBeforeInvoiceRoundingAmount(
        PurchHeader,TotalPurchLine."Amount Including VAT",UseTempData,InvoiceRoundingAmount,SuppressCommit);
      IF InvoiceRoundingAmount <> 0 THEN BEGIN
        VendPostingGr.GET(PurchHeader."Vendor Posting Group");
        VendPostingGr.TESTFIELD("Invoice Rounding Account");
        WITH PurchLine DO BEGIN
          INIT;
          BiggestLineNo := BiggestLineNo + 10000;
          "System-Created Entry" := TRUE;
          //**4PS.sn
          SavedStatusCheckSuspended := GetStatusCheckSuspended; //C002812
          SuspendStatusCheck(TRUE); //C002812   must be True anycase
          SetSkipCheckSigns(TRUE); //C001910
          //**4PS.en
          IF UseTempData THEN BEGIN
            "Line No." := 0;
            Type := Type::"G/L Account";
          END ELSE BEGIN
            "Line No." := BiggestLineNo;
            VALIDATE(Type,Type::"G/L Account");
          END;
          VALIDATE("No.",VendPostingGr."Invoice Rounding Account");
          VALIDATE(Quantity,1);
          IF IsCreditDocType THEN
            VALIDATE("Return Qty. to Ship",Quantity)
          ELSE
            VALIDATE("Qty. to Receive",Quantity);
          IF PurchHeader."Prices Including VAT" THEN
            VALIDATE("Direct Unit Cost",InvoiceRoundingAmount)
          ELSE
            VALIDATE(
              "Direct Unit Cost",
              ROUND(
                InvoiceRoundingAmount /
                (1 + (1 - PurchHeader."VAT Base Discount %" / 100) * "VAT %" / 100),
                Currency."Amount Rounding Precision"));
          VALIDATE("Amount Including VAT",InvoiceRoundingAmount);
          "Line No." := BiggestLineNo;
          LastLineRetrieved := FALSE;
          RoundingLineInserted := TRUE;
          RoundingLineNo := "Line No.";
          // PEB0019
          "Charge Type" := "Charge Type"::Rounding;
          // 0019
          //**4PS.sn
          SetSkipCheckSigns(FALSE); //C001910
          SuspendStatusCheck(SavedStatusCheckSuspended); //C002812  reset to saved value
          //**4PS.en
        END;
      END;
      // ExFlow
      //>>4PSSE,131204, PrePostRoundingOff()
      IF InvoiceRoundingAmount = 0 THEN
        EXIT(FALSE);
      //4PSSE,131204
      EXIT(AddInvoiceRoundingLine(InvoiceRoundingAmount, UseTempData, BiggestLineNo,PurchHeader,PurchLine));
    END;

    PROCEDURE AddInvoiceRoundingLine@1100409003(InvoiceRoundingAmount@1100409001 : Decimal;UseTempData@1000 : Boolean;BiggestLineNo@1004 : Integer;PurchHeader@1101285000 : Record 38;VAR PurchLine@1101285001 : Record 39) : Boolean;
    VAR
      SavedStatusCheckSuspended@1100409000 : Boolean;
      lGLAcc@1002 : Record 15;
      VendPostingGr@1100285500 : Record 93;
    BEGIN
      //150713, split InvoiceRounding into  InvoiceRounding + AddInvoiceRoundingLine

      IF InvoiceRoundingAmount = 0 THEN
        EXIT(FALSE);
      //IF InvoiceRoundingAmount <> 0 THEN
      BEGIN
      //<<4PSSE,131204
        VendPostingGr.GET(PurchHeader."Vendor Posting Group");
        VendPostingGr.TESTFIELD("Invoice Rounding Account");
        WITH PurchLine DO BEGIN
          INIT;
          BiggestLineNo := BiggestLineNo + 10000;
          "System-Created Entry" := TRUE;
          SavedStatusCheckSuspended := GetStatusCheckSuspended;  //**4PS C002812
          SuspendStatusCheck(TRUE);                              //**4PS C002812   must be True anycase
          SetSkipCheckSigns(TRUE);  //*4PS.n C001910
          IF UseTempData THEN BEGIN
            "Line No." := 0;
            Type := Type::"G/L Account";
          END ELSE BEGIN
            "Line No." := BiggestLineNo;
            VALIDATE(Type,Type::"G/L Account");
          END;
          VALIDATE("No.",VendPostingGr."Invoice Rounding Account");

          //4PSSE 150116 ITERO.DL
          lGLAcc.GET(PurchLine."No.");
          Description := lGLAcc.Name;

          VALIDATE(Quantity,1);
          IF "Document Type" IN ["Document Type"::"Return Order","Document Type"::"Credit Memo"] THEN
            VALIDATE("Return Qty. to Ship",Quantity)
          ELSE
            VALIDATE("Qty. to Receive",Quantity);
          IF PurchHeader."Prices Including VAT" THEN
            VALIDATE("Direct Unit Cost",InvoiceRoundingAmount)
          ELSE
            VALIDATE(
              "Direct Unit Cost",
              ROUND(
                InvoiceRoundingAmount /
                (1 + (1 - PurchHeader."VAT Base Discount %" / 100) * "VAT %" / 100),
                Currency."Amount Rounding Precision"));
          VALIDATE("Amount Including VAT",InvoiceRoundingAmount);
          "Line No." := BiggestLineNo;
          LastLineRetrieved := FALSE;
          RoundingLineInserted := TRUE;
          RoundingLineNo := "Line No.";
          SetSkipCheckSigns(FALSE);  //*4PS.n C001910
          SuspendStatusCheck(SavedStatusCheckSuspended);                              //**4PS C002812  reset to saved value
         END;
      END;

      //4PSSE,131204
      OnAfterInvoiceRoundingAmount(
        PurchHeader,PurchLine,TotalPurchLine,UseTempData,InvoiceRoundingAmount,SuppressCommit);
      EXIT(TRUE);
    END;

    LOCAL PROCEDURE IncrAmount@13(PurchHeader@1001 : Record 38;PurchLine@1002 : Record 39;VAR TotalPurchLine@1000 : Record 39);
    BEGIN
      WITH PurchLine DO BEGIN
        IF PurchHeader."Prices Including VAT" OR
           ("VAT Calculation Type" <> "VAT Calculation Type"::"Full VAT")
        THEN
          Increment(TotalPurchLine."Line Amount","Line Amount");
        Increment(TotalPurchLine.Amount,Amount);
        Increment(TotalPurchLine."VAT Base Amount","VAT Base Amount");
        Increment(TotalPurchLine."VAT Difference","VAT Difference");
        Increment(TotalPurchLine."Amount Including VAT","Amount Including VAT");
        Increment(TotalPurchLine."Line Discount Amount","Line Discount Amount");
        Increment(TotalPurchLine."Inv. Discount Amount","Inv. Discount Amount");
        Increment(TotalPurchLine."Inv. Disc. Amount to Invoice","Inv. Disc. Amount to Invoice");
        Increment(TotalPurchLine."Prepmt. Line Amount","Prepmt. Line Amount");
        Increment(TotalPurchLine."Prepmt. Amt. Inv.","Prepmt. Amt. Inv.");
        Increment(TotalPurchLine."Prepmt Amt to Deduct","Prepmt Amt to Deduct");
        Increment(TotalPurchLine."Prepmt Amt Deducted","Prepmt Amt Deducted");
        Increment(TotalPurchLine."Prepayment VAT Difference","Prepayment VAT Difference");
        Increment(TotalPurchLine."Prepmt VAT Diff. to Deduct","Prepmt VAT Diff. to Deduct");
        Increment(TotalPurchLine."Prepmt VAT Diff. Deducted","Prepmt VAT Diff. Deducted");
        OnAfterIncrAmount(TotalPurchLine,PurchLine);
      END;
    END;

    LOCAL PROCEDURE Increment@14(VAR Number@1000 : Decimal;Number2@1001 : Decimal);
    BEGIN
      Number := Number + Number2;
    END;

    [External]
    PROCEDURE GetPurchLines@16(VAR PurchHeader@1000 : Record 38;VAR PurchLine@1001 : Record 39;QtyType@1002 : 'General,Invoicing,Shipping');
    BEGIN
      FillTempLines(PurchHeader,TempPurchLineGlobal);
      IF QtyType = QtyType::Invoicing THEN
        CreatePrepmtLines(PurchHeader,FALSE);
      SumPurchLines2(PurchHeader,PurchLine,TempPurchLineGlobal,QtyType,TRUE);
    END;

    [External]
    PROCEDURE SumPurchLines@15(VAR NewPurchHeader@1000 : Record 38;QtyType@1001 : 'General,Invoicing,Shipping';VAR NewTotalPurchLine@1002 : Record 39;VAR NewTotalPurchLineLCY@1003 : Record 39;VAR VATAmount@1004 : Decimal;VAR VATAmountText@1005 : Text[30]);
    VAR
      OldPurchLine@1006 : Record 39;
    BEGIN
      SumPurchLinesTemp(
        NewPurchHeader,OldPurchLine,QtyType,NewTotalPurchLine,NewTotalPurchLineLCY,
        VATAmount,VATAmountText);
    END;

    [External]
    PROCEDURE SumPurchLinesTemp@24(VAR PurchHeader@1000 : Record 38;VAR OldPurchLine@1001 : Record 39;QtyType@1002 : 'General,Invoicing,Shipping';VAR NewTotalPurchLine@1003 : Record 39;VAR NewTotalPurchLineLCY@1004 : Record 39;VAR VATAmount@1005 : Decimal;VAR VATAmountText@1006 : Text[30]);
    VAR
      PurchLine@1007 : Record 39;
    BEGIN
      WITH PurchHeader DO BEGIN
        SumPurchLines2(PurchHeader,PurchLine,OldPurchLine,QtyType,FALSE);
        VATAmount := TotalPurchLine."Amount Including VAT" - TotalPurchLine.Amount;
        IF TotalPurchLine."VAT %" = 0 THEN
          VATAmountText := VATAmountTxt
        ELSE
          VATAmountText := STRSUBSTNO(VATRateTxt,TotalPurchLine."VAT %");
        NewTotalPurchLine := TotalPurchLine;
        NewTotalPurchLineLCY := TotalPurchLineLCY;
      END;
    END;

    LOCAL PROCEDURE SumPurchLines2@11(PurchHeader@1008 : Record 38;VAR NewPurchLine@1000 : Record 39;VAR OldPurchLine@1001 : Record 39;QtyType@1002 : 'General,Invoicing,Shipping';InsertPurchLine@1003 : Boolean);
    VAR
      PurchLine@1009 : Record 39;
      TempVATAmountLine@1006 : TEMPORARY Record 290;
      TempVATAmountLineRemainder@1007 : TEMPORARY Record 290;
      PurchLineQty@1004 : Decimal;
      BiggestLineNo@1005 : Integer;
    BEGIN
      TempVATAmountLineRemainder.DELETEALL;
      OldPurchLine.CalcVATAmountLines(QtyType,PurchHeader,OldPurchLine,TempVATAmountLine);
      WITH PurchHeader DO BEGIN
        GetGLSetup;
        PurchSetup.GET;
        GetCurrency("Currency Code");
        OldPurchLine.SETRANGE("Document Type","Document Type");
        OldPurchLine.SETRANGE("Document No.","No.");
        RoundingLineInserted := FALSE;
        IF OldPurchLine.FINDSET THEN
          REPEAT
            IF NOT RoundingLineInserted THEN
              PurchLine := OldPurchLine;
            CASE QtyType OF
              QtyType::General:
                //**4PS.sn
                IF "Amounts only" THEN
                  PurchLineQty := 1
                ELSE
                //**4PS.en
                  PurchLineQty := PurchLine.Quantity;
              QtyType::Invoicing:
                //**4PS.sn
                IF "Amounts only" THEN
                  IF (PurchLine.Amount <> 0) AND (PurchLine."Amnt. to Invoice" <> 0) THEN
                    PurchLineQty := PurchLine."Amnt. to Invoice" / PurchLine.Amount
                  ELSE
                    PurchLineQty := 0
                ELSE
                //**4PS.en
                  PurchLineQty := PurchLine."Qty. to Invoice";
              QtyType::Shipping:
                BEGIN
                  //**4PS.sn
                  IF "Amounts only" THEN
                    IF (PurchLine.Amount <> 0) AND (PurchLine."Amnt. to Receive" <> 0) THEN
                      PurchLineQty := PurchLine."Amnt. to Receive" / PurchLine.Amount
                    ELSE
                      PurchLineQty := 0
                  ELSE
                  //**4PS.en
                    IF IsCreditDocType THEN
                      PurchLineQty := PurchLine."Return Qty. to Ship"
                    ELSE
                      PurchLineQty := PurchLine."Qty. to Receive"
                END;
            END;
            DivideAmount(PurchHeader,PurchLine,QtyType,PurchLineQty,TempVATAmountLine,TempVATAmountLineRemainder);
            PurchLine.Quantity := PurchLineQty;
            IF PurchLineQty <> 0 THEN BEGIN
              IF (PurchLine.Amount <> 0) AND NOT RoundingLineInserted THEN
                IF TotalPurchLine.Amount = 0 THEN
                  TotalPurchLine."VAT %" := PurchLine."VAT %"
                ELSE
                  IF TotalPurchLine."VAT %" <> PurchLine."VAT %" THEN
                    TotalPurchLine."VAT %" := 0;
              RoundAmount(PurchHeader,PurchLine,PurchLineQty);
              PurchLine := xPurchLine;
            END;
            IF InsertPurchLine THEN BEGIN
              NewPurchLine := PurchLine;
              NewPurchLine.INSERT;
            END;
            IF RoundingLineInserted THEN
              LastLineRetrieved := TRUE
            ELSE BEGIN
              BiggestLineNo := MAX(BiggestLineNo,OldPurchLine."Line No.");
              LastLineRetrieved := OldPurchLine.NEXT = 0;
              IF LastLineRetrieved AND PurchSetup."Invoice Rounding" THEN
                InvoiceRounding(PurchHeader,PurchLine,TRUE,BiggestLineNo);
            END;
          UNTIL LastLineRetrieved;
      END;
    END;

    [External]
    PROCEDURE UpdateBlanketOrderLine@21(PurchLine@1000 : Record 39;Receive@1001 : Boolean;Ship@1006 : Boolean;Invoice@1002 : Boolean);
    VAR
      BlanketOrderPurchLine@1003 : Record 39;
      ModifyLine@1004 : Boolean;
      Sign@1005 : Decimal;
      IsHandled@1007 : Boolean;
    BEGIN
      IsHandled := FALSE;
      OnBeforeUpdateBlanketOrderLine(PurchLine,Receive,Ship,Invoice,IsHandled);
      IF IsHandled THEN
        EXIT;

      IF (PurchLine."Blanket Order No." <> '') AND (PurchLine."Blanket Order Line No." <> 0) AND
         ((Receive AND (PurchLine."Qty. to Receive" <> 0)) OR
          (Ship AND (PurchLine."Return Qty. to Ship" <> 0)) OR
          (Invoice AND (PurchLine."Qty. to Invoice" <> 0)))
      THEN
        IF BlanketOrderPurchLine.GET(
             BlanketOrderPurchLine."Document Type"::"Blanket Order",PurchLine."Blanket Order No.",
             PurchLine."Blanket Order Line No.")
        THEN BEGIN
          //**4PS.sn
          IF PurchLine."Item No." <> '' THEN
            BlanketOrderPurchLine.TESTFIELD("Item No.",PurchLine."Item No.")
          ELSE BEGIN
          //**4PS.en
            //**4PS.so
            //BlanketOrderPurchLine.TESTFIELD(Type,PurchLine.Type);
            //BlanketOrderPurchLine.TESTFIELD("No.",PurchLine."No.");
            //**4PS.eo
          END; //**4PS.n
          BlanketOrderPurchLine.TESTFIELD("Buy-from Vendor No.",PurchLine."Buy-from Vendor No.");

          ModifyLine := FALSE;
          CASE PurchLine."Document Type" OF
            PurchLine."Document Type"::Order,
            PurchLine."Document Type"::Invoice:
              Sign := 1;
            PurchLine."Document Type"::"Return Order",
            PurchLine."Document Type"::"Credit Memo":
              Sign := -1;
          END;
          IF Receive AND (PurchLine."Receipt No." = '') THEN BEGIN
            IF BlanketOrderPurchLine."Qty. per Unit of Measure" =
               PurchLine."Qty. per Unit of Measure"
            THEN
              BlanketOrderPurchLine."Quantity Received" :=
                BlanketOrderPurchLine."Quantity Received" + Sign * PurchLine."Qty. to Receive"
            ELSE
              BlanketOrderPurchLine."Quantity Received" :=
                BlanketOrderPurchLine."Quantity Received" +
                Sign *
                ROUND(
                  (PurchLine."Qty. per Unit of Measure" /
                   BlanketOrderPurchLine."Qty. per Unit of Measure") * PurchLine."Qty. to Receive",
                  UOMMgt.QtyRndPrecision);
            BlanketOrderPurchLine."Qty. Received (Base)" :=
              BlanketOrderPurchLine."Qty. Received (Base)" + Sign * PurchLine."Qty. to Receive (Base)";
            ModifyLine := TRUE;
          END;
          IF Ship AND (PurchLine."Return Shipment No." = '') THEN BEGIN
            IF BlanketOrderPurchLine."Qty. per Unit of Measure" =
               PurchLine."Qty. per Unit of Measure"
            THEN
              BlanketOrderPurchLine."Quantity Received" :=
                BlanketOrderPurchLine."Quantity Received" + Sign * PurchLine."Return Qty. to Ship"
            ELSE
              BlanketOrderPurchLine."Quantity Received" :=
                BlanketOrderPurchLine."Quantity Received" +
                Sign *
                ROUND(
                  (PurchLine."Qty. per Unit of Measure" /
                   BlanketOrderPurchLine."Qty. per Unit of Measure") * PurchLine."Return Qty. to Ship",
                  UOMMgt.QtyRndPrecision);
            BlanketOrderPurchLine."Qty. Received (Base)" :=
              BlanketOrderPurchLine."Qty. Received (Base)" + Sign * PurchLine."Return Qty. to Ship (Base)";
            ModifyLine := TRUE;
          END;

          IF Invoice THEN BEGIN
            IF BlanketOrderPurchLine."Qty. per Unit of Measure" =
               PurchLine."Qty. per Unit of Measure"
            THEN
              BlanketOrderPurchLine."Quantity Invoiced" :=
                BlanketOrderPurchLine."Quantity Invoiced" + Sign * PurchLine."Qty. to Invoice"
            ELSE
              BlanketOrderPurchLine."Quantity Invoiced" :=
                BlanketOrderPurchLine."Quantity Invoiced" +
                Sign *
                ROUND(
                  (PurchLine."Qty. per Unit of Measure" /
                   BlanketOrderPurchLine."Qty. per Unit of Measure") * PurchLine."Qty. to Invoice",
                  UOMMgt.QtyRndPrecision);
            BlanketOrderPurchLine."Qty. Invoiced (Base)" :=
              BlanketOrderPurchLine."Qty. Invoiced (Base)" + Sign * PurchLine."Qty. to Invoice (Base)";
            ModifyLine := TRUE;
          END;

          IF ModifyLine THEN BEGIN
            OnUpdateBlanketOrderLineOnBeforeInitOutstanding(BlanketOrderPurchLine,PurchLine,Ship,Receive,Invoice);
            BlanketOrderPurchLine.InitOutstanding;

            IsHandled := FALSE;
            OnUpdateBlanketOrderLineOnBeforeCheck(BlanketOrderPurchLine,PurchLine,IsHandled);
            IF NOT IsHandled THEN BEGIN
              IF NOT PurchLine."Allow Exceeding Order Quantity" THEN BEGIN //**4PS.n

                IF (BlanketOrderPurchLine.Quantity * BlanketOrderPurchLine."Quantity Received" < 0) OR
                   (ABS(BlanketOrderPurchLine.Quantity) < ABS(BlanketOrderPurchLine."Quantity Received"))
                THEN
                  BlanketOrderPurchLine.FIELDERROR(
                    "Quantity Received",
                    STRSUBSTNO(BlanketOrderQuantityGreaterThanErr,BlanketOrderPurchLine.FIELDCAPTION(Quantity)));

                IF (BlanketOrderPurchLine."Quantity (Base)" * BlanketOrderPurchLine."Qty. Received (Base)" < 0) OR
                   (ABS(BlanketOrderPurchLine."Quantity (Base)") < ABS(BlanketOrderPurchLine."Qty. Received (Base)"))
                THEN
                  BlanketOrderPurchLine.FIELDERROR(
                    "Qty. Received (Base)",
                    STRSUBSTNO(BlanketOrderQuantityGreaterThanErr,BlanketOrderPurchLine.FIELDCAPTION("Quantity Received")));

              END; //**4PS.n

              BlanketOrderPurchLine.CALCFIELDS("Reserved Qty. (Base)");
              IF ABS(BlanketOrderPurchLine."Outstanding Qty. (Base)") < ABS(BlanketOrderPurchLine."Reserved Qty. (Base)") THEN
                BlanketOrderPurchLine.FIELDERROR(
                  "Reserved Qty. (Base)",BlanketOrderQuantityReducedErr);
            END;

            BlanketOrderPurchLine."Qty. to Invoice" :=
              BlanketOrderPurchLine.Quantity - BlanketOrderPurchLine."Quantity Invoiced";
            //**4PS.sn
            IF BlanketOrderPurchLine."Qty. to Receive" >
               (BlanketOrderPurchLine.Quantity - BlanketOrderPurchLine."Quantity Received")
            THEN
            //**4PS.en
              BlanketOrderPurchLine."Qty. to Receive" :=
                BlanketOrderPurchLine.Quantity - BlanketOrderPurchLine."Quantity Received";
            BlanketOrderPurchLine."Qty. to Invoice (Base)" :=
              BlanketOrderPurchLine."Quantity (Base)" - BlanketOrderPurchLine."Qty. Invoiced (Base)";
            //**4PS.sn
            IF BlanketOrderPurchLine."Qty. to Receive" >
               (BlanketOrderPurchLine.Quantity - BlanketOrderPurchLine."Quantity Received")
            THEN
            //**4PS.en
              BlanketOrderPurchLine."Qty. to Receive (Base)" :=
                BlanketOrderPurchLine."Quantity (Base)" - BlanketOrderPurchLine."Qty. Received (Base)";

            //**4PS.sn
            BlanketOrderPurchLine."Modified by" := USERID; //DP00469
            BlanketOrderPurchLine."Last Date Modified" := TODAY;//DP00469
            //**4PS.en

            OnBeforeBlanketOrderPurchLineModify(BlanketOrderPurchLine,PurchLine);
            BlanketOrderPurchLine.MODIFY;
            OnAfterBlanketOrderPurchLineModify(BlanketOrderPurchLine,PurchLine,Ship,Receive,Invoice);
          END;
        END;
    END;

    LOCAL PROCEDURE UpdatePurchaseHeader@163(VendorLedgerEntry@1000 : Record 25);
    VAR
      GenJnlLine@1001 : Record 81;
      IsHandled@1002 : Boolean;
    BEGIN
      IsHandled := FALSE;
      OnBeforeUpdatePurchaseHeader(VendorLedgerEntry,PurchInvHeader,PurchCrMemoHeader,GenJnlLineDocType,IsHandled);
      IF IsHandled THEN
        EXIT;

      CASE GenJnlLineDocType OF
        GenJnlLine."Document Type"::Invoice:
          BEGIN
            FindVendorLedgerEntry(GenJnlLineDocType,GenJnlLineDocNo,VendorLedgerEntry);
            PurchInvHeader."Vendor Ledger Entry No." := VendorLedgerEntry."Entry No.";
            PurchInvHeader.MODIFY;
          END;
        GenJnlLine."Document Type"::"Credit Memo":
          BEGIN
            FindVendorLedgerEntry(GenJnlLineDocType,GenJnlLineDocNo,VendorLedgerEntry);
            PurchCrMemoHeader."Vendor Ledger Entry No." := VendorLedgerEntry."Entry No.";
            PurchCrMemoHeader.MODIFY;
          END;
      END;

      OnAfterUpdatePurchaseHeader(VendorLedgerEntry,PurchInvHeader,PurchCrMemoHeader,GenJnlLineDocType);
    END;

    LOCAL PROCEDURE PostVendorEntry@68(VAR PurchHeader@1006 : Record 38;TotalPurchLine2@1005 : Record 39;TotalPurchLineLCY2@1004 : Record 39;DocType@1003 : Option;DocNo@1002 : Code[20];ExtDocNo@1001 : Code[35];SourceCode@1000 : Code[10]);
    VAR
      GenJnlLine@1007 : Record 81;
    BEGIN
      WITH GenJnlLine DO BEGIN
        InitNewLine(
          PurchHeader."Posting Date",PurchHeader."Document Date",PurchHeader."Posting Description",
          PurchHeader."Shortcut Dimension 1 Code",PurchHeader."Shortcut Dimension 2 Code",
          PurchHeader."Dimension Set ID",PurchHeader."Reason Code");

        CopyDocumentFields(DocType,DocNo,ExtDocNo,SourceCode,'');
        "Account Type" := "Account Type"::Vendor;
        "Account No." := PurchHeader."Pay-to Vendor No.";
        CopyFromPurchHeader(PurchHeader);
        SetCurrencyFactor(PurchHeader."Currency Code",PurchHeader."Currency Factor");
        "System-Created Entry" := TRUE;

        CopyFromPurchHeaderApplyTo(PurchHeader);
        CopyFromPurchHeaderPayment(PurchHeader);
        //**4PS.sn
        CASE PurchHeader."Document Type" OF
          PurchHeader."Document Type"::Order:
            Approved := TRUE;
          PurchHeader."Document Type"::Invoice:
            Approved := PurchInvHeader."Invoice Approved";
          PurchHeader."Document Type"::"Credit Memo":
            Approved := PurchCrMemoHeader."Credit Memo Approved";
        END;
        Memo := PurchaseHeaderExtension.Memo;
        "Pay VAT Amt. on B-Acc. Vendor" := PurchHeader."Pay VAT Amt. on B-Acc. Vendor";

        IF ("Document Type" = "Document Type"::Invoice) AND (PurchInvHeader."On Hold" <> '') THEN
          "On Hold" := PurchInvHeader."On Hold";
        IF ("Document Type" = "Document Type"::"Credit Memo") AND (PurchCrMemoHeader."On Hold" <> '') THEN
          "On Hold" := PurchCrMemoHeader."On Hold";
        //**4PS.en
        Amount := -TotalPurchLine2."Amount Including VAT";
        "Source Currency Amount" := -TotalPurchLine2."Amount Including VAT";
        "Amount (LCY)" := -TotalPurchLineLCY2."Amount Including VAT";
        "Sales/Purch. (LCY)" := -TotalPurchLineLCY2.Amount;
        "Inv. Discount (LCY)" := -TotalPurchLineLCY2."Inv. Discount Amount";
        // PEB0091
        PurchHeader.CALCFIELDS("OCR No.");
        "OCR No." := PurchHeader."OCR No.";
        "Recipient Bank Account" := PurchHeader."Recipient Bank Account";
        // 0091
        //>>RFC148
        "Payment Reference" := PurchHeader."Payment Reference";
        //<<RFC148
        OnBeforePostVendorEntry(GenJnlLine,PurchHeader,TotalPurchLine2,TotalPurchLineLCY2,PreviewMode,SuppressCommit);
        GenJnlPostLine.RunWithCheck(GenJnlLine);
        OnAfterPostVendorEntry(GenJnlLine,PurchHeader,TotalPurchLine2,TotalPurchLineLCY2,SuppressCommit,GenJnlPostLine);
      END;
    END;

    LOCAL PROCEDURE PostBalancingEntry@149(PurchHeader@1000 : Record 38;TotalPurchLine2@1006 : Record 39;TotalPurchLineLCY2@1005 : Record 39;DocType@1004 : Option;DocNo@1003 : Code[20];ExtDocNo@1002 : Code[35];SourceCode@1001 : Code[10]);
    VAR
      GenJnlLine@1007 : Record 81;
      VendLedgEntry@1008 : Record 25;
    BEGIN
      FindVendorLedgerEntry(DocType,DocNo,VendLedgEntry);

      //**4PS.sn
      IF NOT VendLedgEntry.Open THEN
        EXIT;
      //**4PS.en
      WITH GenJnlLine DO BEGIN
        InitNewLine(
          PurchHeader."Posting Date",PurchHeader."Document Date",PurchHeader."Posting Description",
          PurchHeader."Shortcut Dimension 1 Code",PurchHeader."Shortcut Dimension 2 Code",
          PurchHeader."Dimension Set ID",PurchHeader."Reason Code");

        CopyDocumentFields(0,DocNo,ExtDocNo,SourceCode,'');
        "Account Type" := "Account Type"::Vendor;
        "Account No." := PurchHeader."Pay-to Vendor No.";
        CopyFromPurchHeader(PurchHeader);
        SetCurrencyFactor(PurchHeader."Currency Code",PurchHeader."Currency Factor");

        IF PurchHeader.IsCreditDocType THEN
          "Document Type" := "Document Type"::Refund
        ELSE
          "Document Type" := "Document Type"::Payment;

        SetApplyToDocNo(PurchHeader,GenJnlLine,DocType,DocNo);

        Amount := TotalPurchLine2."Amount Including VAT" + VendLedgEntry."Remaining Pmt. Disc. Possible";
        "Source Currency Amount" := Amount;
        VendLedgEntry.CALCFIELDS(Amount);
        IF VendLedgEntry.Amount = 0 THEN
          "Amount (LCY)" := TotalPurchLineLCY2."Amount Including VAT"
        ELSE
          "Amount (LCY)" :=
            TotalPurchLineLCY2."Amount Including VAT" +
            ROUND(VendLedgEntry."Remaining Pmt. Disc. Possible" / VendLedgEntry."Adjusted Currency Factor");
        "Allow Zero-Amount Posting" := TRUE;

        OnBeforePostBalancingEntry(GenJnlLine,PurchHeader,TotalPurchLine2,TotalPurchLineLCY2,PreviewMode,SuppressCommit);
        GenJnlPostLine.RunWithCheck(GenJnlLine);
        OnAfterPostBalancingEntry(GenJnlLine,PurchHeader,TotalPurchLine2,TotalPurchLineLCY2,SuppressCommit,GenJnlPostLine);
      END;
    END;

    LOCAL PROCEDURE SetApplyToDocNo@25(PurchHeader@1000 : Record 38;VAR GenJnlLine@1001 : Record 81;DocType@1002 : Option;DocNo@1003 : Code[20]);
    BEGIN
      WITH GenJnlLine DO BEGIN
        IF PurchHeader."Bal. Account Type" = PurchHeader."Bal. Account Type"::"Bank Account" THEN
          "Bal. Account Type" := "Bal. Account Type"::"Bank Account";
        "Bal. Account No." := PurchHeader."Bal. Account No.";
        "Applies-to Doc. Type" := DocType;
        "Applies-to Doc. No." := DocNo;
      END;

      OnAfterSetApplyToDocNo(GenJnlLine,PurchHeader);
    END;

    LOCAL PROCEDURE FindVendorLedgerEntry@64(DocType@1000 : Option;DocNo@1001 : Code[20];VAR VendorLedgerEntry@1002 : Record 25);
    BEGIN
      VendorLedgerEntry.SETRANGE("Document Type",DocType);
      VendorLedgerEntry.SETRANGE("Document No.",DocNo);
      VendorLedgerEntry.FINDLAST;
    END;

    LOCAL PROCEDURE RunGenJnlPostLine@52(VAR GenJnlLine@1000 : Record 81) : Integer;
    BEGIN
      EXIT(GenJnlPostLine.RunWithCheck(GenJnlLine));
    END;

    LOCAL PROCEDURE CheckPostRestrictions@148(PurchaseHeader@1000 : Record 38);
    VAR
      Vendor@1002 : Record 23;
      Contact@1001 : Record 5050;
    BEGIN
      IF NOT PreviewMode THEN
        PurchaseHeader.OnCheckPurchasePostRestrictions;

      Vendor.GET(PurchaseHeader."Buy-from Vendor No.");
      Vendor.CheckBlockedVendOnDocs(Vendor,TRUE);
      PurchaseHeader.ValidatePurchaserOnPurchHeader(PurchaseHeader,TRUE,TRUE);

      IF PurchaseHeader."Pay-to Vendor No." <> PurchaseHeader."Buy-from Vendor No." THEN BEGIN
        Vendor.GET(PurchaseHeader."Pay-to Vendor No.");
        Vendor.CheckBlockedVendOnDocs(Vendor,TRUE);
      END;

      IF PurchaseHeader."Buy-from Contact No." <> '' THEN
        IF Contact.GET(PurchaseHeader."Buy-from Contact No.") THEN
          Contact.CheckIfPrivacyBlocked(TRUE);
      IF PurchaseHeader."Pay-to Contact No." <> '' THEN
        IF Contact.GET(PurchaseHeader."Pay-to Contact No.") THEN
          Contact.CheckIfPrivacyBlocked(TRUE);
    END;

    LOCAL PROCEDURE CheckFAPostingPossibility@372(PurchaseHeader@1000 : Record 38);
    VAR
      PurchaseLine@1001 : Record 39;
      PurchaseLineToFind@1002 : Record 39;
      FADepreciationBook@1003 : Record 5612;
      HasBookValue@1004 : Boolean;
    BEGIN
      PurchaseLine.SETRANGE("Document Type",PurchaseHeader."Document Type");
      PurchaseLine.SETRANGE("Document No.",PurchaseHeader."No.");
      PurchaseLine.SETRANGE(Type,PurchaseLine.Type::"Fixed Asset");
      PurchaseLine.SETFILTER("No.",'<>%1','');
      IF PurchaseLine.FINDSET THEN
        REPEAT
          PurchaseLineToFind.COPYFILTERS(PurchaseLine);
          PurchaseLineToFind.SETRANGE("No.",PurchaseLine."No.");
          PurchaseLineToFind.SETRANGE("Depr. until FA Posting Date",NOT PurchaseLine."Depr. until FA Posting Date");
          IF NOT PurchaseLineToFind.ISEMPTY THEN
            ERROR(MixedDerpFAUntilPostingDateErr,PurchaseLine."No.");

          IF PurchaseLine."Depr. until FA Posting Date" THEN BEGIN
            PurchaseLineToFind.SETRANGE("Depr. until FA Posting Date",TRUE);
            PurchaseLineToFind.SETFILTER("Line No.",'<>%1',PurchaseLine."Line No.");
            IF NOT PurchaseLineToFind.ISEMPTY THEN BEGIN
              HasBookValue := FALSE;
              FADepreciationBook.SETRANGE("FA No.",PurchaseLine."No.");
              FADepreciationBook.FINDSET;
              REPEAT
                FADepreciationBook.CALCFIELDS("Book Value");
                HasBookValue := HasBookValue OR (FADepreciationBook."Book Value" <> 0);
              UNTIL (FADepreciationBook.NEXT = 0) OR HasBookValue;
              IF NOT HasBookValue THEN
                ERROR(CannotPostSameMultipleFAWhenDeprBookValueZeroErr,PurchaseLine."No.");
            END;
          END;
        UNTIL PurchaseLine.NEXT = 0;
    END;

    LOCAL PROCEDURE DeleteItemChargeAssgnt@5803(PurchHeader@1001 : Record 38);
    VAR
      ItemChargeAssgntPurch@1000 : Record 5805;
    BEGIN
      ItemChargeAssgntPurch.SETRANGE("Document Type",PurchHeader."Document Type");
      ItemChargeAssgntPurch.SETRANGE("Document No.",PurchHeader."No.");
      IF NOT ItemChargeAssgntPurch.ISEMPTY THEN
        ItemChargeAssgntPurch.DELETEALL;
    END;

    LOCAL PROCEDURE UpdateItemChargeAssgnt@5808();
    VAR
      ItemChargeAssgntPurch@1000 : Record 5805;
    BEGIN
      WITH TempItemChargeAssgntPurch DO BEGIN
        ClearItemChargeAssgntFilter;
        MARKEDONLY(TRUE);
        IF FINDSET THEN
          REPEAT
            ItemChargeAssgntPurch.GET("Document Type","Document No.","Document Line No.","Line No.");
            ItemChargeAssgntPurch."Qty. Assigned" :=
              ItemChargeAssgntPurch."Qty. Assigned" + "Qty. to Assign";
            ItemChargeAssgntPurch."Qty. to Assign" := 0;
            ItemChargeAssgntPurch."Amount to Assign" := 0;
            ItemChargeAssgntPurch.MODIFY;
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE UpdatePurchOrderChargeAssgnt@5814(PurchOrderInvLine@1000 : Record 39;PurchOrderLine@1001 : Record 39);
    VAR
      PurchOrderLine2@1002 : Record 39;
      PurchOrderInvLine2@1003 : Record 39;
      PurchRcptLine@1004 : Record 121;
      ReturnShptLine@1005 : Record 6651;
      DocumentNo@1006 : Code[20];
    BEGIN
      WITH PurchOrderInvLine DO BEGIN
        ClearItemChargeAssgntFilter;
        TempItemChargeAssgntPurch.SETRANGE("Document Type","Document Type");
        TempItemChargeAssgntPurch.SETRANGE("Document No.","Document No.");
        TempItemChargeAssgntPurch.SETRANGE("Document Line No.","Line No.");
        TempItemChargeAssgntPurch.MARKEDONLY(TRUE);
        IF TempItemChargeAssgntPurch.FINDSET THEN
          REPEAT
            IF TempItemChargeAssgntPurch."Applies-to Doc. Type" = "Document Type" THEN BEGIN
              PurchOrderInvLine2.GET(
                TempItemChargeAssgntPurch."Applies-to Doc. Type",
                TempItemChargeAssgntPurch."Applies-to Doc. No.",
                TempItemChargeAssgntPurch."Applies-to Doc. Line No.");
              IF PurchOrderLine."Document Type" = PurchOrderLine."Document Type"::Order THEN BEGIN
                IF NOT
                   PurchRcptLine.GET(PurchOrderInvLine2."Receipt No.",PurchOrderInvLine2."Receipt Line No.")
                THEN
                  ERROR(ReceiptLinesDeletedErr);
                PurchOrderLine2.GET(
                  PurchOrderLine2."Document Type"::Order,
                  PurchRcptLine."Order No.",PurchRcptLine."Order Line No.");
                DocumentNo := PurchRcptLine."Order No.";
              END ELSE BEGIN
                IF NOT
                   ReturnShptLine.GET(PurchOrderInvLine2."Return Shipment No.",PurchOrderInvLine2."Return Shipment Line No.")
                THEN
                  ERROR(ReturnShipmentLinesDeletedErr);
                PurchOrderLine2.GET(
                  PurchOrderLine2."Document Type"::"Return Order",
                  ReturnShptLine."Return Order No.",ReturnShptLine."Return Order Line No.");
                DocumentNo := ReturnShptLine."Return Order No.";
              END;
              IF PurchOrderLine2."Document No." = DocumentNo THEN
                UpdatePurchChargeAssgntLines(
                  PurchOrderLine,
                  PurchOrderLine2."Document Type",
                  PurchOrderLine2."Document No.",
                  PurchOrderLine2."Line No.",
                  TempItemChargeAssgntPurch."Qty. to Assign");
            END ELSE
              UpdatePurchChargeAssgntLines(
                PurchOrderLine,
                TempItemChargeAssgntPurch."Applies-to Doc. Type",
                TempItemChargeAssgntPurch."Applies-to Doc. No.",
                TempItemChargeAssgntPurch."Applies-to Doc. Line No.",
                TempItemChargeAssgntPurch."Qty. to Assign");
          UNTIL TempItemChargeAssgntPurch.NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE UpdatePurchChargeAssgntLines@5813(PurchOrderLine@1000 : Record 39;ApplToDocType@1001 : Option;ApplToDocNo@1002 : Code[20];ApplToDocLineNo@1003 : Integer;QtytoAssign@1004 : Decimal);
    VAR
      ItemChargeAssgntPurch@1005 : Record 5805;
      TempItemChargeAssgntPurch2@1008 : Record 5805;
      LastLineNo@1006 : Integer;
      TotalToAssign@1007 : Decimal;
    BEGIN
      ItemChargeAssgntPurch.SETRANGE("Document Type",PurchOrderLine."Document Type");
      ItemChargeAssgntPurch.SETRANGE("Document No.",PurchOrderLine."Document No.");
      ItemChargeAssgntPurch.SETRANGE("Document Line No.",PurchOrderLine."Line No.");
      ItemChargeAssgntPurch.SETRANGE("Applies-to Doc. Type",ApplToDocType);
      ItemChargeAssgntPurch.SETRANGE("Applies-to Doc. No.",ApplToDocNo);
      ItemChargeAssgntPurch.SETRANGE("Applies-to Doc. Line No.",ApplToDocLineNo);
      IF ItemChargeAssgntPurch.FINDFIRST THEN BEGIN
        GetCurrency(PurchOrderLine."Currency Code");
        ItemChargeAssgntPurch."Qty. Assigned" += QtytoAssign;
        ItemChargeAssgntPurch."Qty. to Assign" -= QtytoAssign;
        IF ItemChargeAssgntPurch."Qty. to Assign" < 0 THEN
          ItemChargeAssgntPurch."Qty. to Assign" := 0;
        ItemChargeAssgntPurch."Amount to Assign" :=
          ROUND(ItemChargeAssgntPurch."Qty. to Assign" * ItemChargeAssgntPurch."Unit Cost",Currency."Amount Rounding Precision");
        ItemChargeAssgntPurch.MODIFY;
      END ELSE BEGIN
        ItemChargeAssgntPurch.SETRANGE("Applies-to Doc. Type");
        ItemChargeAssgntPurch.SETRANGE("Applies-to Doc. No.");
        ItemChargeAssgntPurch.SETRANGE("Applies-to Doc. Line No.");
        ItemChargeAssgntPurch.CALCSUMS("Qty. to Assign");

        TempItemChargeAssgntPurch2.SETRANGE("Document Type",TempItemChargeAssgntPurch."Document Type");
        TempItemChargeAssgntPurch2.SETRANGE("Document No.",TempItemChargeAssgntPurch."Document No.");
        TempItemChargeAssgntPurch2.SETRANGE("Document Line No.",TempItemChargeAssgntPurch."Document Line No.");
        TempItemChargeAssgntPurch2.CALCSUMS("Qty. to Assign");

        TotalToAssign := ItemChargeAssgntPurch."Qty. to Assign" +
          TempItemChargeAssgntPurch2."Qty. to Assign";

        IF ItemChargeAssgntPurch.FINDLAST THEN
          LastLineNo := ItemChargeAssgntPurch."Line No.";

        IF PurchOrderLine.Quantity < TotalToAssign THEN
          REPEAT
            TotalToAssign := TotalToAssign - ItemChargeAssgntPurch."Qty. to Assign";
            ItemChargeAssgntPurch."Qty. to Assign" := 0;
            ItemChargeAssgntPurch."Amount to Assign" := 0;
            ItemChargeAssgntPurch.MODIFY;
          UNTIL (ItemChargeAssgntPurch.NEXT(-1) = 0) OR
                (TotalToAssign = PurchOrderLine.Quantity);

        InsertAssocOrderCharge(
          PurchOrderLine,
          ApplToDocType,
          ApplToDocNo,
          ApplToDocLineNo,
          LastLineNo,
          TempItemChargeAssgntPurch."Applies-to Doc. Line Amount");
      END;
    END;

    LOCAL PROCEDURE InsertAssocOrderCharge@48(PurchOrderLine@1000 : Record 39;ApplToDocType@1002 : Option;ApplToDocNo@1003 : Code[20];ApplToDocLineNo@1004 : Integer;LastLineNo@1007 : Integer;ApplToDocLineAmt@1005 : Decimal);
    VAR
      NewItemChargeAssgntPurch@1001 : Record 5805;
    BEGIN
      WITH NewItemChargeAssgntPurch DO BEGIN
        INIT;
        "Document Type" := PurchOrderLine."Document Type";
        "Document No." := PurchOrderLine."Document No.";
        "Document Line No." := PurchOrderLine."Line No.";
        "Line No." := LastLineNo + 10000;
        "Item Charge No." := TempItemChargeAssgntPurch."Item Charge No.";
        "Item No." := TempItemChargeAssgntPurch."Item No.";
        "Qty. Assigned" := TempItemChargeAssgntPurch."Qty. to Assign";
        "Qty. to Assign" := 0;
        "Amount to Assign" := 0;
        Description := TempItemChargeAssgntPurch.Description;
        "Unit Cost" := TempItemChargeAssgntPurch."Unit Cost";
        "Applies-to Doc. Type" := ApplToDocType;
        "Applies-to Doc. No." := ApplToDocNo;
        "Applies-to Doc. Line No." := ApplToDocLineNo;
        "Applies-to Doc. Line Amount" := ApplToDocLineAmt;
        INSERT;
      END;
    END;

    LOCAL PROCEDURE CopyAndCheckItemCharge@5806(PurchHeader@1000 : Record 38);
    VAR
      TempPurchLine@1001 : TEMPORARY Record 39;
      PurchLine@1002 : Record 39;
      InvoiceEverything@1004 : Boolean;
      AssignError@1005 : Boolean;
      QtyNeeded@1102601000 : Decimal;
    BEGIN
      TempItemChargeAssgntPurch.RESET;
      TempItemChargeAssgntPurch.DELETEALL;

      // Check for max qty posting
      WITH TempPurchLine DO BEGIN
        ResetTempLines(TempPurchLine);
        SETRANGE(Type,Type::"Charge (Item)");
        //**4PS.sn
        PutPromisedReceiveDateFilter(TempPurchLine);
        PutReceiveMarkedOnlyFilter(TempPurchLine); //DP00556
        //**4PS.en
        IF ISEMPTY THEN
          EXIT;

        CopyItemChargeForPurchLine(TempItemChargeAssgntPurch,TempPurchLine);

        SETFILTER("Qty. to Invoice",'<>0');
        IF FINDSET THEN
          REPEAT
            OnCopyAndCheckItemChargeOnBeforeLoop(TempPurchLine,PurchHeader);
            TESTFIELD("Job No.",'');
            IF PurchHeader.Invoice AND
               ("Qty. to Receive" + "Return Qty. to Ship" <> 0) AND
               ((PurchHeader.Ship OR PurchHeader.Receive) OR
                (ABS("Qty. to Invoice") >
                 ABS("Qty. Rcd. Not Invoiced" + "Qty. to Receive") +
                 ABS("Ret. Qty. Shpd Not Invd.(Base)" + "Return Qty. to Ship")))
            THEN
              TESTFIELD("Line Amount");

            IF NOT PurchHeader.Receive THEN
              "Qty. to Receive" := 0;
            IF NOT PurchHeader.Ship THEN
              "Return Qty. to Ship" := 0;
            IF ABS("Qty. to Invoice") >
               ABS("Quantity Received" + "Qty. to Receive" +
                 "Return Qty. Shipped" + "Return Qty. to Ship" -
                 "Quantity Invoiced")
            THEN
              "Qty. to Invoice" :=
                "Quantity Received" + "Qty. to Receive" +
                "Return Qty. Shipped (Base)" + "Return Qty. to Ship (Base)" -
                "Quantity Invoiced";

            CALCFIELDS("Qty. to Assign","Qty. Assigned");
            IF ABS("Qty. to Assign" + "Qty. Assigned") >
               ABS("Qty. to Invoice" + "Quantity Invoiced")
            THEN BEGIN
              AdjustQtyToAssignForPurchLine(TempPurchLine);

              CALCFIELDS("Qty. to Assign","Qty. Assigned");
              IF ABS("Qty. to Assign" + "Qty. Assigned") >
                 ABS("Qty. to Invoice" + "Quantity Invoiced")
              THEN
                ERROR(CannotAssignMoreErr,
                  "Qty. to Invoice" + "Quantity Invoiced" - "Qty. Assigned",
                  FIELDCAPTION("Document Type"),"Document Type",
                  FIELDCAPTION("Document No."),"Document No.",
                  FIELDCAPTION("Line No."),"Line No.");

              CopyItemChargeForPurchLine(TempItemChargeAssgntPurch,TempPurchLine);
            END;
            IF Quantity = "Qty. to Invoice" + "Quantity Invoiced" THEN BEGIN
              IF "Qty. to Assign" <> 0 THEN
                IF Quantity = "Quantity Invoiced" THEN BEGIN
                  TempItemChargeAssgntPurch.SETRANGE("Document Line No.","Line No.");
                  TempItemChargeAssgntPurch.SETRANGE("Applies-to Doc. Type","Document Type");
                  IF TempItemChargeAssgntPurch.FINDSET THEN
                    REPEAT
                      PurchLine.GET(
                        TempItemChargeAssgntPurch."Applies-to Doc. Type",
                        TempItemChargeAssgntPurch."Applies-to Doc. No.",
                        TempItemChargeAssgntPurch."Applies-to Doc. Line No.");
                      IF PurchLine.Quantity = PurchLine."Quantity Invoiced" THEN
                        ERROR(CannotAssignInvoicedErr,PurchLine.TABLECAPTION,
                          PurchLine.FIELDCAPTION("Document Type"),PurchLine."Document Type",
                          PurchLine.FIELDCAPTION("Document No."),PurchLine."Document No.",
                          PurchLine.FIELDCAPTION("Line No."),PurchLine."Line No.");
                    UNTIL TempItemChargeAssgntPurch.NEXT = 0;
                END;
              IF Quantity <> "Qty. to Assign" + "Qty. Assigned" THEN
                AssignError := TRUE;
            END;

            IF ("Qty. to Assign" + "Qty. Assigned") < ("Qty. to Invoice" + "Quantity Invoiced") THEN
              ERROR(MustAssignItemChargeErr,"No.");

            // check if all ILEs exist
            QtyNeeded := "Qty. to Assign";
            TempItemChargeAssgntPurch.SETRANGE("Document Line No.","Line No.");
            IF TempItemChargeAssgntPurch.FINDSET THEN
              REPEAT
                IF (TempItemChargeAssgntPurch."Applies-to Doc. Type" <> "Document Type") OR
                   (TempItemChargeAssgntPurch."Applies-to Doc. No." <> "Document No.")
                THEN
                  QtyNeeded := QtyNeeded - TempItemChargeAssgntPurch."Qty. to Assign"
                ELSE BEGIN
                  PurchLine.GET(
                    TempItemChargeAssgntPurch."Applies-to Doc. Type",
                    TempItemChargeAssgntPurch."Applies-to Doc. No.",
                    TempItemChargeAssgntPurch."Applies-to Doc. Line No.");
                  IF ItemLedgerEntryExist(PurchLine,PurchHeader.Receive OR PurchHeader.Ship) THEN
                    QtyNeeded := QtyNeeded - TempItemChargeAssgntPurch."Qty. to Assign";
                END;
              UNTIL TempItemChargeAssgntPurch.NEXT = 0;

            IF QtyNeeded <> 0 THEN
              ERROR(CannotInvoiceItemChargeErr,"No.");
          UNTIL NEXT = 0;

        // Check purchlines
        IF AssignError THEN
          IF PurchHeader."Document Type" IN
             [PurchHeader."Document Type"::Invoice,PurchHeader."Document Type"::"Credit Memo"]
          THEN
            InvoiceEverything := TRUE
          ELSE BEGIN
            RESET;
            SETFILTER(Type,'%1|%2',Type::Item,Type::"Charge (Item)");
            //**4PS.sn
            PutPromisedReceiveDateFilter(TempPurchLine);
            PutReceiveMarkedOnlyFilter(TempPurchLine); //DP00556
            //**4PS.en
            IF FINDSET THEN
              REPEAT
                IF PurchHeader.Ship OR PurchHeader.Receive THEN
                  InvoiceEverything :=
                    Quantity = "Qty. to Invoice" + "Quantity Invoiced"
                ELSE
                  InvoiceEverything :=
                    (Quantity = "Qty. to Invoice" + "Quantity Invoiced") AND
                    ("Qty. to Invoice" =
                     "Qty. Rcd. Not Invoiced" + "Return Qty. Shipped Not Invd.");
              UNTIL (NEXT = 0) OR (NOT InvoiceEverything);
          END;

        IF InvoiceEverything AND AssignError THEN
          ERROR(MustAssignErr);
      END;
    END;

    LOCAL PROCEDURE CopyItemChargeForPurchLine@273(VAR TempItemChargeAssignmentPurch@1001 : TEMPORARY Record 5805;PurchaseLine@1002 : Record 39);
    VAR
      ItemChargeAssgntPurch@1000 : Record 5805;
    BEGIN
      TempItemChargeAssignmentPurch.RESET;
      TempItemChargeAssignmentPurch.SETRANGE("Document Type",PurchaseLine."Document Type");
      TempItemChargeAssignmentPurch.SETRANGE("Document No.",PurchaseLine."Document No.");
      IF NOT TempItemChargeAssignmentPurch.ISEMPTY THEN
        TempItemChargeAssignmentPurch.DELETEALL;

      ItemChargeAssgntPurch.RESET;
      ItemChargeAssgntPurch.SETRANGE("Document Type",PurchaseLine."Document Type");
      ItemChargeAssgntPurch.SETRANGE("Document No.",PurchaseLine."Document No.");
      ItemChargeAssgntPurch.SETFILTER("Qty. to Assign",'<>0');
      IF ItemChargeAssgntPurch.FINDSET THEN
        REPEAT
          TempItemChargeAssignmentPurch.INIT;
          TempItemChargeAssignmentPurch := ItemChargeAssgntPurch;
          TempItemChargeAssignmentPurch.INSERT;
        UNTIL ItemChargeAssgntPurch.NEXT = 0;
    END;

    LOCAL PROCEDURE AdjustQtyToAssignForPurchLine@274(VAR TempPurchaseLine@1000 : TEMPORARY Record 39);
    VAR
      ItemChargeAssgntPurch@1001 : Record 5805;
    BEGIN
      WITH TempPurchaseLine DO BEGIN
        CALCFIELDS("Qty. to Assign");

        ItemChargeAssgntPurch.RESET;
        ItemChargeAssgntPurch.SETRANGE("Document Type","Document Type");
        ItemChargeAssgntPurch.SETRANGE("Document No.","Document No.");
        ItemChargeAssgntPurch.SETRANGE("Document Line No.","Line No.");
        ItemChargeAssgntPurch.SETFILTER("Qty. to Assign",'<>0');
        IF ItemChargeAssgntPurch.FINDSET THEN
          REPEAT
            ItemChargeAssgntPurch.VALIDATE("Qty. to Assign",
              "Qty. to Invoice" * ROUND(ItemChargeAssgntPurch."Qty. to Assign" / "Qty. to Assign",
                UOMMgt.QtyRndPrecision));
            ItemChargeAssgntPurch.MODIFY;
          UNTIL ItemChargeAssgntPurch.NEXT = 0;

        CALCFIELDS("Qty. to Assign");
        IF "Qty. to Assign" < "Qty. to Invoice" THEN BEGIN
          ItemChargeAssgntPurch.VALIDATE("Qty. to Assign",
            ItemChargeAssgntPurch."Qty. to Assign" + ABS("Qty. to Invoice" - "Qty. to Assign"));
          ItemChargeAssgntPurch.MODIFY;
        END;

        IF "Qty. to Assign" > "Qty. to Invoice" THEN BEGIN
          ItemChargeAssgntPurch.VALIDATE("Qty. to Assign",
            ItemChargeAssgntPurch."Qty. to Assign" - ABS("Qty. to Invoice" - "Qty. to Assign"));
          ItemChargeAssgntPurch.MODIFY;
        END;
      END;
    END;

    LOCAL PROCEDURE ClearItemChargeAssgntFilter@27();
    BEGIN
      TempItemChargeAssgntPurch.SETRANGE("Document Line No.");
      TempItemChargeAssgntPurch.SETRANGE("Applies-to Doc. Type");
      TempItemChargeAssgntPurch.SETRANGE("Applies-to Doc. No.");
      TempItemChargeAssgntPurch.SETRANGE("Applies-to Doc. Line No.");
      TempItemChargeAssgntPurch.MARKEDONLY(FALSE);
    END;

    LOCAL PROCEDURE GetItemChargeLine@5809(PurchHeader@1001 : Record 38;VAR ItemChargePurchLine@1000 : Record 39);
    VAR
      QtyReceived@1003 : Decimal;
      QtyReturnShipped@1004 : Decimal;
    BEGIN
      WITH TempItemChargeAssgntPurch DO
        IF (ItemChargePurchLine."Document Type" <> "Document Type") OR
           (ItemChargePurchLine."Document No." <> "Document No.") OR
           (ItemChargePurchLine."Line No." <> "Document Line No.")
        THEN BEGIN
          ItemChargePurchLine.GET("Document Type","Document No.","Document Line No.");
          OnGetItemChargeLineOnAfterGet(ItemChargePurchLine,PurchHeader);
          IF NOT PurchHeader.Receive THEN
            ItemChargePurchLine."Qty. to Receive" := 0;
          IF NOT PurchHeader.Ship THEN
            ItemChargePurchLine."Return Qty. to Ship" := 0;

          IF ItemChargePurchLine."Receipt No." = '' THEN
            QtyReceived := ItemChargePurchLine."Quantity Received"
          ELSE
            QtyReceived := "Qty. to Assign";
          IF ItemChargePurchLine."Return Shipment No." = '' THEN
            QtyReturnShipped := ItemChargePurchLine."Return Qty. Shipped"
          ELSE
            QtyReturnShipped := "Qty. to Assign";

          IF ABS(ItemChargePurchLine."Qty. to Invoice") >
             ABS(QtyReceived + ItemChargePurchLine."Qty. to Receive" +
               QtyReturnShipped + ItemChargePurchLine."Return Qty. to Ship" -
               ItemChargePurchLine."Quantity Invoiced")
          THEN
            ItemChargePurchLine."Qty. to Invoice" :=
              QtyReceived + ItemChargePurchLine."Qty. to Receive" +
              QtyReturnShipped + ItemChargePurchLine."Return Qty. to Ship" -
              ItemChargePurchLine."Quantity Invoiced";
        END;
    END;

    LOCAL PROCEDURE CalcQtyToInvoice@5810(QtyToHandle@1000 : Decimal;QtyToInvoice@1001 : Decimal) : Decimal;
    BEGIN
      IF ABS(QtyToHandle) > ABS(QtyToInvoice) THEN
        EXIT(QtyToHandle);

      EXIT(QtyToInvoice);
    END;

    LOCAL PROCEDURE GetGLSetup@20();
    BEGIN
      IF NOT GLSetupRead THEN
        GLSetup.GET;
      GLSetupRead := TRUE;
    END;

    LOCAL PROCEDURE CheckWarehouse@7301(VAR TempItemPurchLine@1000 : TEMPORARY Record 39);
    VAR
      WhseValidateSourceLine@1003 : Codeunit 5777;
      ShowError@1002 : Boolean;
    BEGIN
      WITH TempItemPurchLine DO BEGIN
        IF "Prod. Order No." <> '' THEN
          EXIT;
        SETRANGE(Type,Type::Item);
        SETRANGE("Drop Shipment",FALSE);
        IF FINDSET THEN
          REPEAT
            GetLocation("Location Code");
            CASE "Document Type" OF
              "Document Type"::Order:
                IF ((Location."Require Receive" OR Location."Require Put-away") AND (Quantity >= 0)) OR
                   ((Location."Require Shipment" OR Location."Require Pick") AND (Quantity < 0))
                THEN BEGIN
                  IF Location."Directed Put-away and Pick" THEN
                    ShowError := TRUE
                  ELSE
                    IF WhseValidateSourceLine.WhseLinesExist(
                         DATABASE::"Purchase Line","Document Type","Document No.","Line No.",0,Quantity)
                    THEN
                      ShowError := TRUE;
                END;
              "Document Type"::"Return Order":
                IF ((Location."Require Receive" OR Location."Require Put-away") AND (Quantity < 0)) OR
                   ((Location."Require Shipment" OR Location."Require Pick") AND (Quantity >= 0))
                THEN BEGIN
                  IF Location."Directed Put-away and Pick" THEN
                    ShowError := TRUE
                  ELSE
                    IF WhseValidateSourceLine.WhseLinesExist(
                         DATABASE::"Purchase Line","Document Type","Document No.","Line No.",0,Quantity)
                    THEN
                      ShowError := TRUE;
                END;
              "Document Type"::Invoice,"Document Type"::"Credit Memo":
                IF Location."Directed Put-away and Pick" THEN
                  Location.TESTFIELD("Adjustment Bin Code");
            END;
            IF ShowError THEN
              ERROR(
                WarehouseRequiredErr,
                FIELDCAPTION("Document Type"),"Document Type",
                FIELDCAPTION("Document No."),"Document No.",
                FIELDCAPTION("Line No."),"Line No.");
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE CreateWhseJnlLine@7302(ItemJnlLine@1000 : Record 83;PurchLine@1002 : Record 39;VAR TempWhseJnlLine@1001 : TEMPORARY Record 7311);
    VAR
      WhseMgt@1003 : Codeunit 5775;
      WMSMgt@1004 : Codeunit 7302;
    BEGIN
      WITH PurchLine DO BEGIN
        WMSMgt.CheckAdjmtBin(Location,ItemJnlLine.Quantity,TRUE);
        WMSMgt.CreateWhseJnlLine(ItemJnlLine,0,TempWhseJnlLine,FALSE);
        TempWhseJnlLine."Source Type" := DATABASE::"Purchase Line";
        TempWhseJnlLine."Source Subtype" := "Document Type";
        TempWhseJnlLine."Source Document" := WhseMgt.GetSourceDocument(TempWhseJnlLine."Source Type",TempWhseJnlLine."Source Subtype");
        TempWhseJnlLine."Source No." := "Document No.";
        TempWhseJnlLine."Source Line No." := "Line No.";
        TempWhseJnlLine."Source Code" := SrcCode;
        CASE "Document Type" OF
          "Document Type"::Order:
            TempWhseJnlLine."Reference Document" :=
              TempWhseJnlLine."Reference Document"::"Posted Rcpt.";
          "Document Type"::Invoice:
            TempWhseJnlLine."Reference Document" :=
              TempWhseJnlLine."Reference Document"::"Posted P. Inv.";
          "Document Type"::"Credit Memo":
            TempWhseJnlLine."Reference Document" :=
              TempWhseJnlLine."Reference Document"::"Posted P. Cr. Memo";
          "Document Type"::"Return Order":
            TempWhseJnlLine."Reference Document" :=
              TempWhseJnlLine."Reference Document"::"Posted Rtrn. Rcpt.";
        END;
        TempWhseJnlLine."Reference No." := ItemJnlLine."Document No.";
      END;
    END;

    LOCAL PROCEDURE WhseHandlingRequired@7307(PurchLine@1001 : Record 39) : Boolean;
    VAR
      WhseSetup@1000 : Record 5769;
      IsHandled@1002 : Boolean;
      Required@1003 : Boolean;
    BEGIN
      IsHandled := FALSE;
      OnBeforeWhseHandlingRequired(PurchLine,Required,IsHandled);
      IF IsHandled THEN
        EXIT(Required);

      IF (PurchLine.Type = PurchLine.Type::Item) AND (NOT PurchLine."Drop Shipment") THEN BEGIN
        IF PurchLine."Location Code" = '' THEN BEGIN
          WhseSetup.GET;
          IF PurchLine."Document Type" = PurchLine."Document Type"::"Return Order" THEN
            EXIT(WhseSetup."Require Pick");

          EXIT(WhseSetup."Require Receive");
        END;

        GetLocation(PurchLine."Location Code");
        IF PurchLine."Document Type" = PurchLine."Document Type"::"Return Order" THEN
          EXIT(Location."Require Pick");

        EXIT(Location."Require Receive");
      END;
      EXIT(FALSE);
    END;

    LOCAL PROCEDURE GetLocation@7300(LocationCode@1000 : Code[10]);
    BEGIN
      IF LocationCode = '' THEN
        Location.GetLocationSetup(LocationCode,Location)
      ELSE
        IF Location.Code <> LocationCode THEN
          Location.GET(LocationCode);
    END;

    LOCAL PROCEDURE InsertRcptEntryRelation@38(VAR PurchRcptLine@1002 : Record 121) : Integer;
    VAR
      ItemEntryRelation@1001 : Record 6507;
    BEGIN
      TempHandlingSpecification.CopySpecification(TempTrackingSpecificationInv);
      TempHandlingSpecification.RESET;
      IF TempHandlingSpecification.FINDSET THEN BEGIN
        REPEAT
          ItemEntryRelation.InitFromTrackingSpec(TempHandlingSpecification);
          ItemEntryRelation.TransferFieldsPurchRcptLine(PurchRcptLine);
          ItemEntryRelation.INSERT;
        UNTIL TempHandlingSpecification.NEXT = 0;
        TempHandlingSpecification.DELETEALL;
        EXIT(0);
      END;
      EXIT(ItemLedgShptEntryNo);
    END;

    LOCAL PROCEDURE InsertReturnEntryRelation@39(VAR ReturnShptLine@1002 : Record 6651) : Integer;
    VAR
      ItemEntryRelation@1001 : Record 6507;
    BEGIN
      TempHandlingSpecification.CopySpecification(TempTrackingSpecificationInv);
      TempHandlingSpecification.RESET;
      IF TempHandlingSpecification.FINDSET THEN BEGIN
        REPEAT
          ItemEntryRelation.INIT;
          ItemEntryRelation.InitFromTrackingSpec(TempHandlingSpecification);
          ItemEntryRelation.TransferFieldsReturnShptLine(ReturnShptLine);
          ItemEntryRelation.INSERT;
        UNTIL TempHandlingSpecification.NEXT = 0;
        TempHandlingSpecification.DELETEALL;
        EXIT(0);
      END;
      EXIT(ItemLedgShptEntryNo);
    END;

    LOCAL PROCEDURE CheckTrackingSpecification@46(PurchHeader@1002 : Record 38;VAR TempItemPurchLine@1019 : TEMPORARY Record 39);
    VAR
      ReservationEntry@1001 : Record 337;
      Item@1016 : Record 27;
      ItemTrackingCode@1009 : Record 6502;
      ItemJnlLine@1006 : Record 83;
      CreateReservEntry@1004 : Codeunit 99000830;
      ItemTrackingManagement@1015 : Codeunit 6500;
      ErrorFieldCaption@1018 : Text[250];
      SignFactor@1005 : Integer;
      PurchLineQtyToHandle@1023 : Decimal;
      TrackingQtyToHandle@1003 : Decimal;
      Inbound@1010 : Boolean;
      SNRequired@1011 : Boolean;
      LotRequired@1012 : Boolean;
      SNInfoRequired@1013 : Boolean;
      LotInfoRequired@1014 : Boolean;
      CheckPurchLine@1008 : Boolean;
    BEGIN
      // if a PurchaseLine is posted with ItemTracking then tracked quantity must be equal to posted quantity
      IF NOT (PurchHeader."Document Type" IN
              [PurchHeader."Document Type"::Order,PurchHeader."Document Type"::"Return Order"])
      THEN
        EXIT;

      TrackingQtyToHandle := 0;

      WITH TempItemPurchLine DO BEGIN
        SETRANGE(Type,Type::Item);
        IF PurchHeader.Receive THEN BEGIN
          SETFILTER("Quantity Received",'<>%1',0);
          ErrorFieldCaption := FIELDCAPTION("Qty. to Receive");
        END ELSE BEGIN
          SETFILTER("Return Qty. Shipped",'<>%1',0);
          ErrorFieldCaption := FIELDCAPTION("Return Qty. to Ship");
        END;

        IF FINDSET THEN BEGIN
          ReservationEntry."Source Type" := DATABASE::"Purchase Line";
          ReservationEntry."Source Subtype" := PurchHeader."Document Type";
          SignFactor := CreateReservEntry.SignFactor(ReservationEntry);
          REPEAT
            // Only Item where no SerialNo or LotNo is required
            Item.GET("No.");
            IF Item."Item Tracking Code" <> '' THEN BEGIN
              Inbound := (Quantity * SignFactor) > 0;
              ItemTrackingCode.Code := Item."Item Tracking Code";
              ItemTrackingManagement.GetItemTrackingSettings(ItemTrackingCode,
                ItemJnlLine."Entry Type"::Purchase,Inbound,
                SNRequired,LotRequired,SNInfoRequired,LotInfoRequired);
              CheckPurchLine := NOT SNRequired AND NOT LotRequired;
              IF CheckPurchLine THEN
                CheckPurchLine := CheckTrackingExists(TempItemPurchLine);
            END ELSE
              CheckPurchLine := FALSE;

            TrackingQtyToHandle := 0;

            IF CheckPurchLine THEN BEGIN
              TrackingQtyToHandle := GetTrackingQuantities(TempItemPurchLine) * SignFactor;
              IF PurchHeader.Receive THEN
                PurchLineQtyToHandle := "Qty. to Receive (Base)"
              ELSE
                PurchLineQtyToHandle := "Return Qty. to Ship (Base)";
              IF TrackingQtyToHandle <> PurchLineQtyToHandle THEN
              //ERROR(ItemTrackQuantityMismatchErr,ErrorFieldCaption); //**4PS.o DP00121
                ERROR(ItemTrackQuantityMismatchErr,ErrorFieldCaption,"No."); //**4PS.n DP00121
            END;
          UNTIL NEXT = 0;
        END;
        IF PurchHeader.Receive THEN
          SETRANGE("Quantity Received")
        ELSE
          SETRANGE("Return Qty. Shipped");
      END;

      //**4PS.sn DP00121
      WITH TempItemPurchLine DO BEGIN
        SETRANGE("Quantity Received");
        SETRANGE("Return Qty. Shipped");
        SETRANGE(Type,Type::"G/L Account");
        SETFILTER("Item No.", '<>%1', '');
        IF PurchHeader.Receive THEN
          ErrorFieldCaption := FIELDCAPTION("Qty. to Receive")
        ELSE
          ErrorFieldCaption := FIELDCAPTION("Return Qty. to Ship");

        IF FINDSET THEN BEGIN
          ReservationEntry."Source Type" := DATABASE::"Purchase Line";
          ReservationEntry."Source Subtype" := PurchHeader."Document Type";
          SignFactor := CreateReservEntry.SignFactor(ReservationEntry);
          REPEAT
            // Only Item where no SerialNo or LotNo is required
            Item.GET("Item No.");
            IF Item."Item Tracking Code" <> '' THEN BEGIN
              Inbound := (Quantity * SignFactor) > 0;
              ItemTrackingCode.Code := Item."Item Tracking Code";
              ItemTrackingManagement.GetItemTrackingSettings(ItemTrackingCode,
                ItemJnlLine."Entry Type"::Purchase,Inbound,
                SNRequired,LotRequired,SNInfoRequired,LotInfoRequired);
              CheckPurchLine := NOT SNRequired AND NOT LotRequired;
              IF CheckPurchLine THEN
                CheckPurchLine := CheckTrackingExists(TempItemPurchLine);
            END ELSE
              CheckPurchLine := FALSE;

            TrackingQtyToHandle := 0;

            IF CheckPurchLine THEN BEGIN
              TrackingQtyToHandle := GetTrackingQuantities(TempItemPurchLine) * SignFactor;
              IF PurchHeader.Receive THEN
                PurchLineQtyToHandle := "Qty. to Receive (Base)"
              ELSE
                PurchLineQtyToHandle := "Return Qty. to Ship (Base)";
              IF TrackingQtyToHandle <> PurchLineQtyToHandle THEN
                ERROR(ItemTrackQuantityMismatchErr,ErrorFieldCaption,"Item No.");
            END;
          UNTIL NEXT = 0;
        END;
        SETRANGE(Type);
        SETRANGE("Item No.");
      END;
      //**4PS.en
    END;

    LOCAL PROCEDURE CheckTrackingExists@160(PurchLine@1000 : Record 39) : Boolean;
    BEGIN
      EXIT(
        ItemTrackingMgt.ItemTrackingExistsOnDocumentLine(
          DATABASE::"Purchase Line",PurchLine."Document Type",PurchLine."Document No.",PurchLine."Line No."));
    END;

    LOCAL PROCEDURE GetTrackingQuantities@47(PurchLine@1000 : Record 39) : Decimal;
    BEGIN
      EXIT(
        ItemTrackingMgt.CalcQtyToHandleForTrackedQtyOnDocumentLine(
          DATABASE::"Purchase Line",PurchLine."Document Type",PurchLine."Document No.",PurchLine."Line No."));
    END;

    LOCAL PROCEDURE SaveInvoiceSpecification@33(VAR TempInvoicingSpecification@1000 : TEMPORARY Record 336);
    BEGIN
      TempInvoicingSpecification.RESET;
      IF TempInvoicingSpecification.FINDSET THEN BEGIN
        REPEAT
          TempInvoicingSpecification."Quantity Invoiced (Base)" += TempInvoicingSpecification."Quantity actual Handled (Base)";
          TempInvoicingSpecification."Quantity actual Handled (Base)" := 0;
          TempTrackingSpecification := TempInvoicingSpecification;
          TempTrackingSpecification."Buffer Status" := TempTrackingSpecification."Buffer Status"::MODIFY;
          IF NOT TempTrackingSpecification.INSERT THEN BEGIN
            TempTrackingSpecification.GET(TempInvoicingSpecification."Entry No.");
            TempTrackingSpecification."Qty. to Invoice (Base)" += TempInvoicingSpecification."Qty. to Invoice (Base)";
            TempTrackingSpecification."Quantity Invoiced (Base)" += TempInvoicingSpecification."Qty. to Invoice (Base)";
            TempTrackingSpecification."Qty. to Invoice" += TempInvoicingSpecification."Qty. to Invoice";
            TempTrackingSpecification.MODIFY;
          END;
        UNTIL TempInvoicingSpecification.NEXT = 0;
        TempInvoicingSpecification.DELETEALL;
      END;
    END;

    LOCAL PROCEDURE InsertTrackingSpecification@35(PurchHeader@1001 : Record 38);
    BEGIN
      TempTrackingSpecification.RESET;
      IF NOT TempTrackingSpecification.ISEMPTY THEN BEGIN
        TempTrackingSpecification.InsertSpecification;
        ReservePurchLine.UpdateItemTrackingAfterPosting(PurchHeader);
      END;
    END;

    LOCAL PROCEDURE CalcBaseQty@29(ItemNo@1002 : Code[20];UOMCode@1004 : Code[10];Qty@1000 : Decimal) : Decimal;
    VAR
      Item@1003 : Record 27;
      UOMMgt@1001 : Codeunit 5402;
    BEGIN
      Item.GET(ItemNo);
      EXIT(ROUND(Qty * UOMMgt.GetQtyPerUnitOfMeasure(Item,UOMCode),UOMMgt.QtyRndPrecision));
    END;

    LOCAL PROCEDURE InsertValueEntryRelation@40();
    VAR
      ValueEntryRelation@1000 : Record 6508;
    BEGIN
      TempValueEntryRelation.RESET;
      IF TempValueEntryRelation.FINDSET THEN BEGIN
        REPEAT
          ValueEntryRelation := TempValueEntryRelation;
          ValueEntryRelation.INSERT;
        UNTIL TempValueEntryRelation.NEXT = 0;
        TempValueEntryRelation.DELETEALL;
      END;
    END;

    LOCAL PROCEDURE PostItemCharge@42(PurchHeader@1011 : Record 38;VAR PurchLine@1000 : Record 39;ItemEntryNo@1004 : Integer;QuantityBase@1005 : Decimal;AmountToAssign@1006 : Decimal;QtyToAssign@1007 : Decimal;IndirectCostPct@1008 : Decimal);
    VAR
      DummyTrackingSpecification@1001 : Record 336;
      PurchLineToPost@1009 : Record 39;
      CurrExchRate@1002 : Record 330;
    BEGIN
      WITH TempItemChargeAssgntPurch DO BEGIN
        PurchLineToPost := PurchLine;
        PurchLineToPost."No." := "Item No.";
        PurchLineToPost."Line No." := "Document Line No.";
        PurchLineToPost."Appl.-to Item Entry" := ItemEntryNo;
        PurchLineToPost."Indirect Cost %" := IndirectCostPct;

        PurchLineToPost.Amount := AmountToAssign;

        IF "Document Type" IN ["Document Type"::"Return Order","Document Type"::"Credit Memo"] THEN
          PurchLineToPost.Amount := -PurchLineToPost.Amount;

        IF PurchLineToPost."Currency Code" <> '' THEN
          PurchLineToPost."Unit Cost" := ROUND(
              PurchLineToPost.Amount / QuantityBase,Currency."Unit-Amount Rounding Precision")
        ELSE
          PurchLineToPost."Unit Cost" := ROUND(
              PurchLineToPost.Amount / QuantityBase,GLSetup."Unit-Amount Rounding Precision");

        TotalChargeAmt := TotalChargeAmt + PurchLineToPost.Amount;
        IF PurchHeader."Currency Code" <> '' THEN
          PurchLineToPost.Amount :=
            CurrExchRate.ExchangeAmtFCYToLCY(
        //    Usedate,PurchHeader."Currency Code",TotalChargeAmt,PurchHeader."Currency Factor"); //**4PS.o
              1, PurchHeader."Job No.", Usedate,PurchHeader."Currency Code",TotalChargeAmt,PurchHeader."Currency Factor",FALSE); //**4PS.n

        PurchLineToPost.Amount := ROUND(PurchLineToPost.Amount,GLSetup."Amount Rounding Precision") - TotalChargeAmtLCY;
        IF PurchHeader."Currency Code" <> '' THEN
          TotalChargeAmtLCY := TotalChargeAmtLCY + PurchLineToPost.Amount;
        PurchLineToPost."Unit Cost (LCY)" :=
          ROUND(
            PurchLineToPost.Amount / QuantityBase,GLSetup."Unit-Amount Rounding Precision");

        PurchLineToPost."Inv. Discount Amount" := ROUND(
            PurchLine."Inv. Discount Amount" / PurchLine.Quantity * QtyToAssign,
            GLSetup."Amount Rounding Precision");

        PurchLineToPost."Line Discount Amount" := ROUND(
            PurchLine."Line Discount Amount" / PurchLine.Quantity * QtyToAssign,
            GLSetup."Amount Rounding Precision");
        PurchLineToPost."Line Amount" := ROUND(
            PurchLine."Line Amount" / PurchLine.Quantity * QtyToAssign,
            GLSetup."Amount Rounding Precision");
        UpdatePurchLineDimSetIDFromAppliedEntry(PurchLineToPost,PurchLine);
        PurchLine."Inv. Discount Amount" := PurchLine."Inv. Discount Amount" - PurchLineToPost."Inv. Discount Amount";
        PurchLine."Line Discount Amount" := PurchLine."Line Discount Amount" - PurchLineToPost."Line Discount Amount";
        PurchLine."Line Amount" := PurchLine."Line Amount" - PurchLineToPost."Line Amount";
        PurchLine.Quantity := PurchLine.Quantity - QtyToAssign;

        OnPostItemChargeOnBeforePostItemJnlLine(PurchLineToPost,PurchLine,QtyToAssign);

        PostItemJnlLine(
          PurchHeader,PurchLineToPost,0,0,QuantityBase,QuantityBase,
          PurchLineToPost."Appl.-to Item Entry","Item Charge No.",DummyTrackingSpecification);
      END;
    END;

    LOCAL PROCEDURE SaveTempWhseSplitSpec@45(PurchLine3@1000 : Record 39);
    BEGIN
      TempWhseSplitSpecification.RESET;
      TempWhseSplitSpecification.DELETEALL;
      IF TempHandlingSpecification.FINDSET THEN
        REPEAT
          TempWhseSplitSpecification := TempHandlingSpecification;
          TempWhseSplitSpecification."Source Type" := DATABASE::"Purchase Line";
          TempWhseSplitSpecification."Source Subtype" := PurchLine3."Document Type";
          TempWhseSplitSpecification."Source ID" := PurchLine3."Document No.";
          TempWhseSplitSpecification."Source Ref. No." := PurchLine3."Line No.";
          TempWhseSplitSpecification.INSERT;
        UNTIL TempHandlingSpecification.NEXT = 0;

      OnAfterSaveTempWhseSplitSpec(PurchLine3,TempWhseSplitSpecification);
    END;

    LOCAL PROCEDURE TransferReservToItemJnlLine@32(VAR SalesOrderLine@1000 : Record 37;VAR ItemJnlLine@1001 : Record 83;PurchLine@1007 : Record 39;QtyToBeShippedBase@1002 : Decimal;ApplySpecificItemTracking@1003 : Boolean);
    VAR
      ReserveSalesLine@1006 : Codeunit 99000832;
      RemainingQuantity@1004 : Decimal;
      CheckApplFromItemEntry@1005 : Boolean;
    BEGIN
      // Handle Item Tracking and reservations, also on drop shipment
      IF QtyToBeShippedBase = 0 THEN
        EXIT;

      IF NOT ApplySpecificItemTracking THEN
        ReserveSalesLine.TransferSalesLineToItemJnlLine(
          SalesOrderLine,ItemJnlLine,QtyToBeShippedBase,CheckApplFromItemEntry,FALSE)
      ELSE BEGIN
        ReserveSalesLine.SetApplySpecificItemTracking(TRUE);
        TempTrackingSpecification.RESET;
        TempTrackingSpecification.SetSourceFilter(
          DATABASE::"Purchase Line",PurchLine."Document Type",PurchLine."Document No.",PurchLine."Line No.",FALSE);
        TempTrackingSpecification.SetSourceFilter2('',0);
        IF TempTrackingSpecification.ISEMPTY THEN
          ReserveSalesLine.TransferSalesLineToItemJnlLine(
            SalesOrderLine,ItemJnlLine,QtyToBeShippedBase,CheckApplFromItemEntry,FALSE)
        ELSE BEGIN
          ReserveSalesLine.SetOverruleItemTracking(TRUE);
          TempTrackingSpecification.FINDSET;
          IF TempTrackingSpecification."Quantity (Base)" / QtyToBeShippedBase < 0 THEN
            ERROR(ItemTrackingWrongSignErr);
          REPEAT
            ItemJnlLine.CopyTrackingFromSpec(TempTrackingSpecification);
            ItemJnlLine."Applies-to Entry" := TempTrackingSpecification."Item Ledger Entry No.";
            RemainingQuantity :=
              ReserveSalesLine.TransferSalesLineToItemJnlLine(
                SalesOrderLine,ItemJnlLine,TempTrackingSpecification."Quantity (Base)",CheckApplFromItemEntry,FALSE);
            IF RemainingQuantity <> 0 THEN
              ERROR(ItemTrackingMismatchErr);
          UNTIL TempTrackingSpecification.NEXT = 0;
          ItemJnlLine.ClearTracking;
          ItemJnlLine."Applies-to Entry" := 0;
        END;
      END;
    END;

    [External]
    PROCEDURE SetWhseRcptHeader@26(VAR WhseRcptHeader2@1000 : Record 7316);
    BEGIN
      WhseRcptHeader := WhseRcptHeader2;
      TempWhseRcptHeader := WhseRcptHeader;
      TempWhseRcptHeader.INSERT;
    END;

    [External]
    PROCEDURE SetWhseShptHeader@44(VAR WhseShptHeader2@1000 : Record 7320);
    BEGIN
      WhseShptHeader := WhseShptHeader2;
      TempWhseShptHeader := WhseShptHeader;
      TempWhseShptHeader.INSERT;
    END;

    LOCAL PROCEDURE CreatePrepmtLines@51(PurchHeader@1003 : Record 38;CompleteFunctionality@1009 : Boolean);
    VAR
      GLAcc@1002 : Record 15;
      TempPurchLine@1000 : TEMPORARY Record 39;
      TempExtTextLine@1011 : TEMPORARY Record 280;
      GenPostingSetup@1005 : Record 252;
      TempPrepmtPurchLine@1004 : TEMPORARY Record 39;
      TransferExtText@1012 : Codeunit 378;
      NextLineNo@1001 : Integer;
      Fraction@1008 : Decimal;
      VATDifference@1015 : Decimal;
      TempLineFound@1010 : Boolean;
      PrepmtAmtToDeduct@1016 : Decimal;
      IsHandled@1006 : Boolean;
    BEGIN
      IsHandled := FALSE;
      OnBeforeCreatePrepmtLines(PurchHeader,TempPrepmtPurchLine,CompleteFunctionality,IsHandled);
      IF IsHandled THEN
        EXIT;

      GetGLSetup;
      WITH TempPurchLine DO BEGIN
        FillTempLines(PurchHeader,TempPurchLineGlobal);
        ResetTempLines(TempPurchLine);
        IF NOT FINDLAST THEN
          EXIT;
        NextLineNo := "Line No." + 10000;
        //**4PS.sn
        PutPromisedReceiveDateFilter(TempPurchLine);
        PutReceiveMarkedOnlyFilter(TempPurchLine); //**4PS.n DP00556
        //**4PS.en
        SETFILTER(Quantity,'>0');
        SETFILTER("Qty. to Invoice",'>0');
        IF FINDSET THEN BEGIN
          IF CompleteFunctionality AND ("Document Type" = "Document Type"::Invoice) THEN
            TestGetRcptPPmtAmtToDeduct;
          REPEAT
            IF CompleteFunctionality THEN
              IF PurchHeader."Document Type" <> PurchHeader."Document Type"::Invoice THEN BEGIN
                IF NOT PurchHeader.Receive AND ("Qty. to Invoice" = Quantity - "Quantity Invoiced") THEN
                  IF "Qty. Rcd. Not Invoiced" >= 0 THEN //**4PS.n C008671
                    IF "Qty. Rcd. Not Invoiced" < "Qty. to Invoice" THEN
                      VALIDATE("Qty. to Invoice","Qty. Rcd. Not Invoiced");
                Fraction := ("Qty. to Invoice" + "Quantity Invoiced") / Quantity;

                IF "Prepayment %" <> 100 THEN
                  CASE TRUE OF
                    ("Prepmt Amt to Deduct" <> 0) AND
                    (ROUND(Fraction * "Line Amount",Currency."Amount Rounding Precision") < "Prepmt Amt to Deduct"):
                      FIELDERROR(
                        "Prepmt Amt to Deduct",
                        STRSUBSTNO(
                          CannotBeGreaterThanErr,
                          ROUND(Fraction * "Line Amount",Currency."Amount Rounding Precision")));
                    ("Prepmt. Amt. Inv." <> 0) AND
                    (ROUND((1 - Fraction) * "Line Amount",Currency."Amount Rounding Precision") <
                     ROUND(
                       ROUND(
                         ROUND("Direct Unit Cost" * (Quantity - "Quantity Invoiced" - "Qty. to Invoice"),
                           Currency."Amount Rounding Precision") *
                         (1 - "Line Discount %" / 100),Currency."Amount Rounding Precision") *
                       "Prepayment %" / 100,Currency."Amount Rounding Precision")):
                      FIELDERROR(
                        "Prepmt Amt to Deduct",
                        STRSUBSTNO(
                          CannotBeSmallerThanErr,
                          ROUND(
                            "Prepmt. Amt. Inv." - "Prepmt Amt Deducted" -
                            (1 - Fraction) * "Line Amount",Currency."Amount Rounding Precision")));
                  END;
              END;
            IF "Prepmt Amt to Deduct" <> 0 THEN BEGIN
              IF ("Gen. Bus. Posting Group" <> GenPostingSetup."Gen. Bus. Posting Group") OR
                 ("Gen. Prod. Posting Group" <> GenPostingSetup."Gen. Prod. Posting Group")
              THEN
                GenPostingSetup.GET("Gen. Bus. Posting Group","Gen. Prod. Posting Group");
              GLAcc.GET(GenPostingSetup.GetPurchPrepmtAccount);
              TempLineFound := FALSE;
              IF PurchHeader."Compress Prepayment" THEN BEGIN
                TempPrepmtPurchLine.SETRANGE("No.",GLAcc."No.");
                TempPrepmtPurchLine.SETRANGE("Job No.","Job No.");
                TempPrepmtPurchLine.SETRANGE("Dimension Set ID","Dimension Set ID");
                TempLineFound := TempPrepmtPurchLine.FINDFIRST;
              END;
              IF TempLineFound THEN BEGIN
                PrepmtAmtToDeduct :=
                  TempPrepmtPurchLine."Prepmt Amt to Deduct" +
                  InsertedPrepmtVATBaseToDeduct(
                    PurchHeader,TempPurchLine,TempPrepmtPurchLine."Line No.",TempPrepmtPurchLine."Direct Unit Cost");
                VATDifference := TempPrepmtPurchLine."VAT Difference";
                TempPrepmtPurchLine.VALIDATE(
                  "Direct Unit Cost",TempPrepmtPurchLine."Direct Unit Cost" + "Prepmt Amt to Deduct");
                TempPrepmtPurchLine.VALIDATE("VAT Difference",VATDifference - "Prepmt VAT Diff. to Deduct");
                TempPrepmtPurchLine."Prepmt Amt to Deduct" := PrepmtAmtToDeduct;
                IF "Prepayment %" < TempPrepmtPurchLine."Prepayment %" THEN
                  TempPrepmtPurchLine."Prepayment %" := "Prepayment %";

                //**4PS.sn
                TempPrepmtPurchLine."Modified by" := USERID; //DP00469
                TempPrepmtPurchLine."Last Date Modified" := TODAY;//DP00469
                //**4PS.en

                OnBeforeTempPrepmtPurchLineModify(TempPrepmtPurchLine,TempPurchLine,PurchHeader,CompleteFunctionality);
                TempPrepmtPurchLine.MODIFY;
              END ELSE BEGIN
                TempPrepmtPurchLine.INIT;
                TempPrepmtPurchLine."Document Type" := PurchHeader."Document Type";
                TempPrepmtPurchLine."Document No." := PurchHeader."No.";
                TempPrepmtPurchLine."Line No." := 0;
                TempPrepmtPurchLine."System-Created Entry" := TRUE;
                IF CompleteFunctionality THEN
                  TempPrepmtPurchLine.VALIDATE(Type,TempPrepmtPurchLine.Type::"G/L Account")
                ELSE
                  TempPrepmtPurchLine.Type := TempPrepmtPurchLine.Type::"G/L Account";
                TempPrepmtPurchLine.VALIDATE("No.",GenPostingSetup."Purch. Prepayments Account");
                TempPrepmtPurchLine.VALIDATE(Quantity,-1);
                TempPrepmtPurchLine."Qty. to Receive" := TempPrepmtPurchLine.Quantity;
                TempPrepmtPurchLine."Qty. to Invoice" := TempPrepmtPurchLine.Quantity;
                PrepmtAmtToDeduct := InsertedPrepmtVATBaseToDeduct(PurchHeader,TempPurchLine,NextLineNo,0);
                TempPrepmtPurchLine.VALIDATE("Direct Unit Cost","Prepmt Amt to Deduct");
                TempPrepmtPurchLine.VALIDATE("VAT Difference",-"Prepmt VAT Diff. to Deduct");
                TempPrepmtPurchLine."Prepmt Amt to Deduct" := PrepmtAmtToDeduct;
                TempPrepmtPurchLine."Prepayment %" := "Prepayment %";
                TempPrepmtPurchLine."Prepayment Line" := TRUE;
                TempPrepmtPurchLine."Shortcut Dimension 1 Code" := "Shortcut Dimension 1 Code";
                TempPrepmtPurchLine."Shortcut Dimension 2 Code" := "Shortcut Dimension 2 Code";
                TempPrepmtPurchLine."Dimension Set ID" := "Dimension Set ID";
                TempPrepmtPurchLine."Job No." := "Job No.";
                TempPrepmtPurchLine."Job Task No." := "Job Task No.";
                TempPrepmtPurchLine."Job Line Type" := "Job Line Type";
                TempPrepmtPurchLine."Line No." := NextLineNo;
                NextLineNo := NextLineNo + 10000;

                //**4PS.sn
                TempPrepmtPurchLine."Input by" := USERID; //DP00469
                TempPrepmtPurchLine."Input Date" := TODAY; //DP00469
                //**4PS.en

                OnBeforeTempPrepmtPurchLineInsert(TempPrepmtPurchLine,TempPurchLine,PurchHeader,CompleteFunctionality);
                TempPrepmtPurchLine.INSERT;

                TransferExtText.PrepmtGetAnyExtText(
                  TempPrepmtPurchLine."No.",DATABASE::"Purch. Inv. Line",
                  PurchHeader."Document Date",PurchHeader."Language Code",TempExtTextLine);
                IF TempExtTextLine.FIND('-') THEN
                  REPEAT
                    TempPrepmtPurchLine.INIT;
                    TempPrepmtPurchLine.Description := TempExtTextLine.Text;
                    TempPrepmtPurchLine."System-Created Entry" := TRUE;
                    TempPrepmtPurchLine."Prepayment Line" := TRUE;
                    TempPrepmtPurchLine."Line No." := NextLineNo;
                    NextLineNo := NextLineNo + 10000;
                    //**4PS.sn
                    TempPrepmtPurchLine."Input by" := USERID; //DP00469
                    TempPrepmtPurchLine."Input Date" := TODAY; //DP00469
                    //**4PS.en
                    TempPrepmtPurchLine.INSERT;
                  UNTIL TempExtTextLine.NEXT = 0;
              END;
            END;
          UNTIL NEXT = 0
        END;
      END;
      DividePrepmtAmountLCY(TempPrepmtPurchLine,PurchHeader);
      IF TempPrepmtPurchLine.FINDSET THEN
        REPEAT
          TempPurchLineGlobal := TempPrepmtPurchLine;
          TempPurchLineGlobal.INSERT;
        UNTIL TempPrepmtPurchLine.NEXT = 0;
    END;

    LOCAL PROCEDURE InsertedPrepmtVATBaseToDeduct@82(PurchHeader@1004 : Record 38;PurchLine@1000 : Record 39;PrepmtLineNo@1001 : Integer;TotalPrepmtAmtToDeduct@1002 : Decimal) : Decimal;
    VAR
      PrepmtVATBaseToDeduct@1003 : Decimal;
    BEGIN
      WITH PurchLine DO BEGIN
        IF PurchHeader."Prices Including VAT" THEN
          PrepmtVATBaseToDeduct :=
            ROUND(
              (TotalPrepmtAmtToDeduct + "Prepmt Amt to Deduct") / (1 + "Prepayment VAT %" / 100),
              Currency."Amount Rounding Precision") -
            ROUND(
              TotalPrepmtAmtToDeduct / (1 + "Prepayment VAT %" / 100),
              Currency."Amount Rounding Precision")
        ELSE
          PrepmtVATBaseToDeduct := "Prepmt Amt to Deduct";
      END;
      WITH TempPrepmtDeductLCYPurchLine DO BEGIN
        TempPrepmtDeductLCYPurchLine := PurchLine;
        IF "Document Type" = "Document Type"::Order THEN
          "Qty. to Invoice" := GetQtyToInvoice(PurchLine,PurchHeader.Receive)
        ELSE
          GetLineDataFromOrder(TempPrepmtDeductLCYPurchLine);
        IF ("Prepmt Amt to Deduct" = 0) OR ("Document Type" = "Document Type"::Invoice) THEN
          CalcPrepaymentToDeduct;
        "Line Amount" := GetLineAmountToHandleInclPrepmt("Qty. to Invoice");
        "Attached to Line No." := PrepmtLineNo;
        "VAT Base Amount" := PrepmtVATBaseToDeduct;
        INSERT;
      END;

      OnAfterInsertedPrepmtVATBaseToDeduct(
        PurchHeader,PurchLine,PrepmtLineNo,TotalPrepmtAmtToDeduct,TempPrepmtDeductLCYPurchLine,PrepmtVATBaseToDeduct);

      EXIT(PrepmtVATBaseToDeduct);
    END;

    LOCAL PROCEDURE DividePrepmtAmountLCY@83(VAR PrepmtPurchLine@1000 : Record 39;PurchHeader@1006 : Record 38);
    VAR
      CurrExchRate@1001 : Record 330;
      ActualCurrencyFactor@1002 : Decimal;
    BEGIN
      WITH PrepmtPurchLine DO BEGIN
        RESET;
        SETFILTER(Type,'<>%1',Type::" ");
        IF FINDSET THEN
          REPEAT
            IF PurchHeader."Currency Code" <> '' THEN
              ActualCurrencyFactor :=
                ROUND(
                  CurrExchRate.ExchangeAmtFCYToLCY(
                    1, PurchHeader."Job No.", //**4PS.n
                    PurchHeader."Posting Date",
                    PurchHeader."Currency Code",
                    "Prepmt Amt to Deduct",
                  //PurchHeader."Currency Factor")) / //**4PS.o
                    PurchHeader."Currency Factor",FALSE)) /  //**4PS.n
                "Prepmt Amt to Deduct"
            ELSE
              ActualCurrencyFactor := 1;

            UpdatePrepmtAmountInvBuf("Line No.",ActualCurrencyFactor);
          UNTIL NEXT = 0;
        RESET;
      END;
    END;

    LOCAL PROCEDURE UpdatePrepmtAmountInvBuf@78(PrepmtSalesLineNo@1000 : Integer;CurrencyFactor@1004 : Decimal);
    VAR
      PrepmtAmtRemainder@1002 : Decimal;
    BEGIN
      WITH TempPrepmtDeductLCYPurchLine DO BEGIN
        RESET;
        SETRANGE("Attached to Line No.",PrepmtSalesLineNo);
        IF FINDSET(TRUE) THEN
          REPEAT
            "Prepmt. Amount Inv. (LCY)" :=
              CalcRoundedAmount(CurrencyFactor * "VAT Base Amount",PrepmtAmtRemainder);
            //**4PS.sn
            "Modified by" := USERID; //DP00469
            "Last Date Modified" := TODAY;//DP00469
            //**4PS.en
            MODIFY;
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE AdjustPrepmtAmountLCY@84(PurchHeader@1008 : Record 38;VAR PrepmtPurchLine@1000 : Record 39);
    VAR
      PurchLine@1005 : Record 39;
      PurchInvoiceLine@1013 : Record 39;
      DeductionFactor@1001 : Decimal;
      PrepmtVATPart@1006 : Decimal;
      PrepmtVATAmtRemainder@1011 : Decimal;
      TotalRoundingAmount@1002 : ARRAY [2] OF Decimal;
      TotalPrepmtAmount@1003 : ARRAY [2] OF Decimal;
      FinalInvoice@1004 : Boolean;
      PricesInclVATRoundingAmount@1007 : ARRAY [2] OF Decimal;
    BEGIN
      IF PrepmtPurchLine."Prepayment Line" THEN BEGIN
        PrepmtVATPart :=
          (PrepmtPurchLine."Amount Including VAT" - PrepmtPurchLine.Amount) / PrepmtPurchLine."Direct Unit Cost";

        WITH TempPrepmtDeductLCYPurchLine DO BEGIN
          RESET;
          SETRANGE("Attached to Line No.",PrepmtPurchLine."Line No.");
          IF FINDSET(TRUE) THEN BEGIN
            FinalInvoice := IsFinalInvoice;
            REPEAT
              PurchLine := TempPrepmtDeductLCYPurchLine;
              PurchLine.FIND;
              IF "Document Type" = "Document Type"::Invoice THEN BEGIN
                PurchInvoiceLine := PurchLine;
                GetPurchOrderLine(PurchLine,PurchInvoiceLine);
                PurchLine."Qty. to Invoice" := PurchInvoiceLine."Qty. to Invoice";
              END;
              IF PurchLine."Qty. to Invoice" <> "Qty. to Invoice" THEN
                PurchLine."Prepmt Amt to Deduct" := CalcPrepmtAmtToDeduct(PurchLine,PurchHeader.Receive);
              DeductionFactor :=
                PurchLine."Prepmt Amt to Deduct" /
                (PurchLine."Prepmt. Amt. Inv." - PurchLine."Prepmt Amt Deducted");

              "Prepmt. VAT Amount Inv. (LCY)" :=
                -CalcRoundedAmount(PurchLine."Prepmt Amt to Deduct" * PrepmtVATPart,PrepmtVATAmtRemainder);
              IF ("Prepayment %" <> 100) OR IsFinalInvoice OR ("Currency Code" <> '') THEN
                CalcPrepmtRoundingAmounts(TempPrepmtDeductLCYPurchLine,PurchLine,DeductionFactor,TotalRoundingAmount);
              //**4PS.sn
              "Modified by" := USERID; //DP00469
              "Last Date Modified" := TODAY;//DP00469
              //**4PS.en
              MODIFY;

              IF PurchHeader."Prices Including VAT" THEN
                IF (("Prepayment %" <> 100) OR IsFinalInvoice) AND (DeductionFactor = 1) THEN BEGIN
                  PricesInclVATRoundingAmount[1] := TotalRoundingAmount[1];
                  PricesInclVATRoundingAmount[2] := TotalRoundingAmount[2];
                END;

              IF "VAT Calculation Type" <> "VAT Calculation Type"::"Full VAT" THEN
                TotalPrepmtAmount[1] += "Prepmt. Amount Inv. (LCY)";
              TotalPrepmtAmount[2] += "Prepmt. VAT Amount Inv. (LCY)";
              FinalInvoice := FinalInvoice AND IsFinalInvoice;
            UNTIL NEXT = 0;
          END;
        END;

        UpdatePrepmtPurchLineWithRounding(
          PrepmtPurchLine,TotalRoundingAmount,TotalPrepmtAmount,
          FinalInvoice,PricesInclVATRoundingAmount);
      END;
    END;

    LOCAL PROCEDURE CalcPrepmtAmtToDeduct@53(PurchLine@1000 : Record 39;Receive@1001 : Boolean) : Decimal;
    BEGIN
      WITH PurchLine DO BEGIN
        "Qty. to Invoice" := GetQtyToInvoice(PurchLine,Receive);
        CalcPrepaymentToDeduct;
        EXIT("Prepmt Amt to Deduct");
      END;
    END;

    LOCAL PROCEDURE GetQtyToInvoice@94(PurchLine@1000 : Record 39;Receive@1002 : Boolean) : Decimal;
    VAR
      AllowedQtyToInvoice@1001 : Decimal;
    BEGIN
      WITH PurchLine DO BEGIN
        AllowedQtyToInvoice := "Qty. Rcd. Not Invoiced";
        IF Receive THEN
          AllowedQtyToInvoice := AllowedQtyToInvoice + "Qty. to Receive";
        IF "Qty. to Invoice" > AllowedQtyToInvoice THEN
          EXIT(AllowedQtyToInvoice);
        EXIT("Qty. to Invoice");
      END;
    END;

    LOCAL PROCEDURE GetLineDataFromOrder@95(VAR PurchLine@1000 : Record 39);
    VAR
      PurchRcptLine@1001 : Record 121;
      PurchOrderLine@1002 : Record 39;
    BEGIN
      WITH PurchLine DO BEGIN
        PurchRcptLine.GET("Receipt No.","Receipt Line No.");
        PurchOrderLine.GET("Document Type"::Order,PurchRcptLine."Order No.",PurchRcptLine."Order Line No.");

        Quantity := PurchOrderLine.Quantity;
        "Qty. Rcd. Not Invoiced" := PurchOrderLine."Qty. Rcd. Not Invoiced";
        "Quantity Invoiced" := PurchOrderLine."Quantity Invoiced";
        "Prepmt Amt Deducted" := PurchOrderLine."Prepmt Amt Deducted";
        "Prepmt. Amt. Inv." := PurchOrderLine."Prepmt. Amt. Inv.";
        "Line Discount Amount" := PurchOrderLine."Line Discount Amount";
      END;
    END;

    LOCAL PROCEDURE CalcPrepmtRoundingAmounts@58(VAR PrepmtPurchLineBuf@1000 : Record 39;PurchLine@1003 : Record 39;DeductionFactor@1001 : Decimal;VAR TotalRoundingAmount@1002 : ARRAY [2] OF Decimal);
    VAR
      RoundingAmount@1004 : ARRAY [2] OF Decimal;
    BEGIN
      WITH PrepmtPurchLineBuf DO BEGIN
        IF "VAT Calculation Type" <> "VAT Calculation Type"::"Full VAT" THEN BEGIN
          RoundingAmount[1] :=
            "Prepmt. Amount Inv. (LCY)" - ROUND(DeductionFactor * PurchLine."Prepmt. Amount Inv. (LCY)");
          "Prepmt. Amount Inv. (LCY)" := "Prepmt. Amount Inv. (LCY)" - RoundingAmount[1];
          TotalRoundingAmount[1] += RoundingAmount[1];
        END;
        RoundingAmount[2] :=
          "Prepmt. VAT Amount Inv. (LCY)" - ROUND(DeductionFactor * PurchLine."Prepmt. VAT Amount Inv. (LCY)");
        "Prepmt. VAT Amount Inv. (LCY)" := "Prepmt. VAT Amount Inv. (LCY)" - RoundingAmount[2];
        TotalRoundingAmount[2] += RoundingAmount[2];
      END;
    END;

    LOCAL PROCEDURE UpdatePrepmtPurchLineWithRounding@89(VAR PrepmtPurchLine@1002 : Record 39;TotalRoundingAmount@1001 : ARRAY [2] OF Decimal;TotalPrepmtAmount@1000 : ARRAY [2] OF Decimal;FinalInvoice@1005 : Boolean;PricesInclVATRoundingAmount@1006 : ARRAY [2] OF Decimal);
    VAR
      NewAmountIncludingVAT@1003 : Decimal;
      Prepmt100PctVATRoundingAmt@1004 : Decimal;
      AmountRoundingPrecision@1007 : Decimal;
    BEGIN
      OnBeforeUpdatePrepmtPurchLineWithRounding(
        PrepmtPurchLine,TotalRoundingAmount,TotalPrepmtAmount,FinalInvoice,PricesInclVATRoundingAmount,
        TotalPurchLine,TotalPurchLineLCY);

      WITH PrepmtPurchLine DO BEGIN
        NewAmountIncludingVAT := TotalPrepmtAmount[1] + TotalPrepmtAmount[2] + TotalRoundingAmount[1] + TotalRoundingAmount[2];
        IF "Prepayment %" = 100 THEN
          TotalRoundingAmount[1] -= "Amount Including VAT" + NewAmountIncludingVAT;
        AmountRoundingPrecision :=
          GetAmountRoundingPrecisionInLCY("Document Type","Document No.","Currency Code");

        IF (ABS(TotalRoundingAmount[1]) <= AmountRoundingPrecision) AND
           (ABS(TotalRoundingAmount[2]) <= AmountRoundingPrecision)
        THEN BEGIN
          IF "Prepayment %" = 100 THEN
            Prepmt100PctVATRoundingAmt := TotalRoundingAmount[1];
          TotalRoundingAmount[1] := 0;
        END;
        "Prepmt. Amount Inv. (LCY)" := -TotalRoundingAmount[1];
        Amount := -(TotalPrepmtAmount[1] + TotalRoundingAmount[1]);

        IF (PricesInclVATRoundingAmount[1] <> 0) AND (TotalRoundingAmount[1] = 0) THEN BEGIN
          IF ("Prepayment %" = 100) AND FinalInvoice AND
             (Amount - TotalPrepmtAmount[2] = "Amount Including VAT")
          THEN
            Prepmt100PctVATRoundingAmt := 0;
          PricesInclVATRoundingAmount[1] := 0;
        END;

        IF ((TotalRoundingAmount[2] <> 0) OR FinalInvoice) AND (TotalRoundingAmount[1] = 0) THEN BEGIN
          IF ("Prepayment %" = 100) AND ("Prepmt. Amount Inv. (LCY)" = 0) THEN
            Prepmt100PctVATRoundingAmt += TotalRoundingAmount[2];
          IF ("Prepayment %" = 100) OR FinalInvoice THEN
            TotalRoundingAmount[2] := 0;
        END;

        IF (PricesInclVATRoundingAmount[2] <> 0) AND (TotalRoundingAmount[2] = 0) THEN BEGIN
          IF ABS(Prepmt100PctVATRoundingAmt) <= AmountRoundingPrecision THEN
            Prepmt100PctVATRoundingAmt := 0;
          PricesInclVATRoundingAmount[2] := 0;
        END;

        "Prepmt. VAT Amount Inv. (LCY)" := -(TotalRoundingAmount[2] + Prepmt100PctVATRoundingAmt);
        NewAmountIncludingVAT := Amount - (TotalPrepmtAmount[2] + TotalRoundingAmount[2]);
        IF (PricesInclVATRoundingAmount[1] = 0) AND (PricesInclVATRoundingAmount[2] = 0) OR
           ("Currency Code" <> '') AND FinalInvoice
        THEN
          Increment(
            TotalPurchLineLCY."Amount Including VAT",
            -("Amount Including VAT" - NewAmountIncludingVAT + Prepmt100PctVATRoundingAmt));
        IF "Currency Code" = '' THEN
          TotalPurchLine."Amount Including VAT" := TotalPurchLineLCY."Amount Including VAT";
        "Amount Including VAT" := NewAmountIncludingVAT;

        IF FinalInvoice AND (TotalPurchLine.Amount = 0) AND (TotalPurchLine."Amount Including VAT" <> 0) AND
           (ABS(TotalPurchLine."Amount Including VAT") <= Currency."Amount Rounding Precision")
        THEN BEGIN
          "Amount Including VAT" -= TotalPurchLineLCY."Amount Including VAT";
          TotalPurchLine."Amount Including VAT" := 0;
          TotalPurchLineLCY."Amount Including VAT" := 0;
        END;
      END;

      OnAfterUpdatePrepmtPurchLineWithRounding(
        PrepmtPurchLine,TotalRoundingAmount,TotalPrepmtAmount,FinalInvoice,PricesInclVATRoundingAmount,
        TotalPurchLine,TotalPurchLineLCY);
    END;

    LOCAL PROCEDURE CalcRoundedAmount@91(Amount@1000 : Decimal;VAR Remainder@1001 : Decimal) : Decimal;
    VAR
      AmountRnded@1002 : Decimal;
    BEGIN
      Amount := Amount + Remainder;
      AmountRnded := ROUND(Amount,GLSetup."Amount Rounding Precision");
      Remainder := Amount - AmountRnded;
      EXIT(AmountRnded);
    END;

    LOCAL PROCEDURE GetPurchOrderLine@85(VAR PurchOrderLine@1000 : Record 39;PurchLine@1001 : Record 39);
    VAR
      PurchRcptLine@1002 : Record 121;
    BEGIN
      PurchRcptLine.GET(PurchLine."Receipt No.",PurchLine."Receipt Line No.");
      PurchOrderLine.GET(
        PurchOrderLine."Document Type"::Order,
        PurchRcptLine."Order No.",PurchRcptLine."Order Line No.");
      PurchOrderLine."Prepmt Amt to Deduct" := PurchLine."Prepmt Amt to Deduct";
    END;

    LOCAL PROCEDURE DecrementPrepmtAmtInvLCY@86(PurchLine@1000 : Record 39;VAR PrepmtAmountInvLCY@1001 : Decimal;VAR PrepmtVATAmountInvLCY@1002 : Decimal);
    BEGIN
      TempPrepmtDeductLCYPurchLine.RESET;
      TempPrepmtDeductLCYPurchLine := PurchLine;
      IF TempPrepmtDeductLCYPurchLine.FIND THEN BEGIN
        PrepmtAmountInvLCY := PrepmtAmountInvLCY - TempPrepmtDeductLCYPurchLine."Prepmt. Amount Inv. (LCY)";
        PrepmtVATAmountInvLCY := PrepmtVATAmountInvLCY - TempPrepmtDeductLCYPurchLine."Prepmt. VAT Amount Inv. (LCY)";
      END;
    END;

    LOCAL PROCEDURE AdjustFinalInvWith100PctPrepmt@97(VAR CombinedPurchLine@1000 : Record 39);
    VAR
      DiffToLineDiscAmt@1001 : Decimal;
    BEGIN
      WITH TempPrepmtDeductLCYPurchLine DO BEGIN
        RESET;
        SETRANGE("Prepayment %",100);
        IF FINDSET(TRUE) THEN
          REPEAT
            IF IsFinalInvoice THEN BEGIN
              DiffToLineDiscAmt := "Prepmt Amt to Deduct" - "Line Amount";
              IF "Document Type" = "Document Type"::Order THEN
                DiffToLineDiscAmt := DiffToLineDiscAmt * Quantity / "Qty. to Invoice";
              IF DiffToLineDiscAmt <> 0 THEN BEGIN
                CombinedPurchLine.GET("Document Type","Document No.","Line No.");
                "Line Discount Amount" := CombinedPurchLine."Line Discount Amount" - DiffToLineDiscAmt;

                //**4PS.sn
                "Modified by" := USERID;
                "Last Date Modified" := TODAY;
                //**4PS.en

                MODIFY;
              END;
            END;
          UNTIL NEXT = 0;
        RESET;
      END;
    END;

    LOCAL PROCEDURE GetPrepmtDiffToLineAmount@98(PurchLine@1000 : Record 39) : Decimal;
    BEGIN
      WITH TempPrepmtDeductLCYPurchLine DO
        IF PurchLine."Prepayment %" = 100 THEN
          IF GET(PurchLine."Document Type",PurchLine."Document No.",PurchLine."Line No.") THEN
            EXIT("Prepmt Amt to Deduct" + "Inv. Discount Amount" - "Line Amount");
      EXIT(0);
    END;

    LOCAL PROCEDURE InsertICGenJnlLine@150(PurchHeader@1007 : Record 38;PurchLine@1000 : Record 39;VAR ICGenJnlLineNo@1006 : Integer);
    VAR
      ICGLAccount@1001 : Record 410;
      Cust@1002 : Record 18;
      Currency@1003 : Record 4;
      ICPartner@1004 : Record 413;
      CurrExchRate@1005 : Record 330;
      GenJnlLine@1008 : Record 81;
    BEGIN
      PurchHeader.TESTFIELD("Buy-from IC Partner Code",'');
      PurchHeader.TESTFIELD("Pay-to IC Partner Code",'');
      PurchLine.TESTFIELD("IC Partner Ref. Type",PurchLine."IC Partner Ref. Type"::"G/L Account");
      ICGLAccount.GET(PurchLine."IC Partner Reference");
      ICGenJnlLineNo := ICGenJnlLineNo + 1;

      WITH TempICGenJnlLine DO BEGIN
        InitNewLine(PurchHeader."Posting Date",PurchHeader."Document Date",PurchHeader."Posting Description",
          PurchLine."Shortcut Dimension 1 Code",PurchLine."Shortcut Dimension 2 Code",PurchLine."Dimension Set ID",
          PurchHeader."Reason Code");
        "Line No." := ICGenJnlLineNo;

        CopyDocumentFields(GenJnlLineDocType,GenJnlLineDocNo,GenJnlLineExtDocNo,SrcCode,PurchHeader."Posting No. Series");

        VALIDATE("Account Type","Account Type"::"IC Partner");
        VALIDATE("Account No.",PurchLine."IC Partner Code");
        "Source Currency Code" := PurchHeader."Currency Code";
        "Source Currency Amount" := Amount;
        Correction := PurchHeader.Correction;
        "Country/Region Code" := PurchHeader."VAT Country/Region Code";
        "Source Type" := GenJnlLine."Source Type"::Vendor;
        "Source No." := PurchHeader."Pay-to Vendor No.";
        "Source Line No." := PurchLine."Line No.";
        VALIDATE("Bal. Account Type","Bal. Account Type"::"G/L Account");
        VALIDATE("Bal. Account No.",PurchLine."No.");
        "Shortcut Dimension 1 Code" := PurchLine."Shortcut Dimension 1 Code";
        "Shortcut Dimension 2 Code" := PurchLine."Shortcut Dimension 2 Code";
        "Dimension Set ID" := PurchLine."Dimension Set ID";

        Cust.SETRANGE("IC Partner Code",PurchLine."IC Partner Code");
        IF Cust.FINDFIRST THEN BEGIN
          VALIDATE("Bal. Gen. Bus. Posting Group",Cust."Gen. Bus. Posting Group");
          VALIDATE("Bal. VAT Bus. Posting Group",Cust."VAT Bus. Posting Group");
        END;
        VALIDATE("Bal. VAT Prod. Posting Group",PurchLine."VAT Prod. Posting Group");
        "IC Partner Code" := PurchLine."IC Partner Code";
        "IC Partner G/L Acc. No." := PurchLine."IC Partner Reference";
        "IC Direction" := "IC Direction"::Outgoing;
        ICPartner.GET(PurchLine."IC Partner Code");
        IF ICPartner."Cost Distribution in LCY" AND (PurchLine."Currency Code" <> '') THEN BEGIN
          "Currency Code" := '';
          "Currency Factor" := 0;
          Currency.GET(PurchLine."Currency Code");
          IF PurchHeader.IsCreditDocType THEN
            Amount :=
              -ROUND(
                CurrExchRate.ExchangeAmtFCYToLCY(
                  1,PurchHeader."Job No.", //**4PS.n
                  PurchHeader."Posting Date",PurchLine."Currency Code",
      //          PurchLine.Amount,PurchHeader."Currency Factor")) //**4PS.o
                  PurchLine.Amount,PurchHeader."Currency Factor",FALSE)) //**4PS.n
          ELSE
            Amount :=
              ROUND(
                CurrExchRate.ExchangeAmtFCYToLCY(
                  1,PurchHeader."Job No.", //**4PS.n
                  PurchHeader."Posting Date",PurchLine."Currency Code",
      //          PurchLine.Amount,PurchHeader."Currency Factor")) //**4PS.o
                  PurchLine.Amount,PurchHeader."Currency Factor",FALSE)) //**4PS.n
        END ELSE BEGIN
          Currency.InitRoundingPrecision;
          "Currency Code" := PurchHeader."Currency Code";
          "Currency Factor" := PurchHeader."Currency Factor";
          IF PurchHeader.IsCreditDocType THEN
            Amount := -PurchLine.Amount
          ELSE
            Amount := PurchLine.Amount;
        END;
        IF "Bal. VAT %" <> 0 THEN
          Amount := ROUND(Amount * (1 + "Bal. VAT %" / 100),Currency."Amount Rounding Precision");
        VALIDATE(Amount);
        OnInsertICGenJnlLineOnBeforeICGenJnlLineInsert(TempICGenJnlLine,PurchHeader,PurchLine,SuppressCommit);
        INSERT;
      END;
    END;

    LOCAL PROCEDURE PostICGenJnl@151();
    VAR
      ICInboxOutboxMgt@1001 : Codeunit 427;
      ICOutboxExport@1002 : Codeunit 431;
      ICTransactionNo@1000 : Integer;
    BEGIN
      TempICGenJnlLine.RESET;
      IF TempICGenJnlLine.FIND('-') THEN
        REPEAT
          ICTransactionNo := ICInboxOutboxMgt.CreateOutboxJnlTransaction(TempICGenJnlLine,FALSE);
          ICInboxOutboxMgt.CreateOutboxJnlLine(ICTransactionNo,1,TempICGenJnlLine);
          ICOutboxExport.ProcessAutoSendOutboxTransactionNo(ICTransactionNo);
          IF TempICGenJnlLine.Amount <> 0 THEN
            GenJnlPostLine.RunWithCheck(TempICGenJnlLine);
        UNTIL TempICGenJnlLine.NEXT = 0;
    END;

    LOCAL PROCEDURE TestGetRcptPPmtAmtToDeduct@57();
    VAR
      TempPurchLine@1007 : TEMPORARY Record 39;
      TempRcvdPurchLine@1005 : TEMPORARY Record 39;
      TempTotalPurchLine@1004 : TEMPORARY Record 39;
      TempPurchRcptLine@1003 : TEMPORARY Record 121;
      PurchRcptLine@1000 : Record 121;
      PurchaseOrderLine@1001 : Record 39;
      MaxAmtToDeduct@1002 : Decimal;
    BEGIN
      WITH TempPurchLine DO BEGIN
        ResetTempLines(TempPurchLine);
        SETFILTER(Quantity,'>0');
        SETFILTER("Qty. to Invoice",'>0');
        SETFILTER("Receipt No.",'<>%1','');
        SETFILTER("Prepmt Amt to Deduct",'<>0');
        IF ISEMPTY THEN
          EXIT;

        SETRANGE("Prepmt Amt to Deduct");
        IF FINDSET THEN
          REPEAT
            IF PurchRcptLine.GET("Receipt No.","Receipt Line No.") THEN BEGIN
              TempRcvdPurchLine := TempPurchLine;
              TempRcvdPurchLine.INSERT;
              TempPurchRcptLine := PurchRcptLine;
              IF TempPurchRcptLine.INSERT THEN;

              IF NOT TempTotalPurchLine.GET("Document Type"::Order,PurchRcptLine."Order No.",PurchRcptLine."Order Line No.")
              THEN BEGIN
                TempTotalPurchLine.INIT;
                TempTotalPurchLine."Document Type" := "Document Type"::Order;
                TempTotalPurchLine."Document No." := PurchRcptLine."Order No.";
                TempTotalPurchLine."Line No." := PurchRcptLine."Order Line No.";
                //**4PS.sn
                TempTotalPurchLine."Input by" := USERID; //DP00469
                TempTotalPurchLine."Input Date" := TODAY; //DP00469
                //**4PS.en
                TempTotalPurchLine.INSERT;
              END;
              TempTotalPurchLine."Qty. to Invoice" := TempTotalPurchLine."Qty. to Invoice" + "Qty. to Invoice";
              TempTotalPurchLine."Prepmt Amt to Deduct" := TempTotalPurchLine."Prepmt Amt to Deduct" + "Prepmt Amt to Deduct";
              AdjustInvLineWith100PctPrepmt(TempPurchLine,TempTotalPurchLine);
              //**4PS.sn
              TempTotalPurchLine."Modified by" := USERID; //DP00469
              TempTotalPurchLine."Last Date Modified" := TODAY;//DP00469
              //**4PS.en
              TempTotalPurchLine.MODIFY;
            END;
          UNTIL NEXT = 0;

        IF TempRcvdPurchLine.FINDSET THEN
          REPEAT
            IF TempPurchRcptLine.GET(TempRcvdPurchLine."Receipt No.",TempRcvdPurchLine."Receipt Line No.") THEN
              IF PurchaseOrderLine.GET(
                   TempRcvdPurchLine."Document Type"::Order,TempPurchRcptLine."Order No.",TempPurchRcptLine."Order Line No.")
              THEN
                IF TempTotalPurchLine.GET(
                     TempRcvdPurchLine."Document Type"::Order,TempPurchRcptLine."Order No.",TempPurchRcptLine."Order Line No.")
                THEN BEGIN
                  MaxAmtToDeduct := PurchaseOrderLine."Prepmt. Amt. Inv." - PurchaseOrderLine."Prepmt Amt Deducted";

                  IF TempTotalPurchLine."Prepmt Amt to Deduct" > MaxAmtToDeduct THEN
                    ERROR(PrepAmountToDeductToBigErr,FIELDCAPTION("Prepmt Amt to Deduct"),MaxAmtToDeduct);

                  IF (TempTotalPurchLine."Qty. to Invoice" = PurchaseOrderLine.Quantity - PurchaseOrderLine."Quantity Invoiced") AND
                     (TempTotalPurchLine."Prepmt Amt to Deduct" <> MaxAmtToDeduct)
                  THEN
                    ERROR(PrepAmountToDeductToSmallErr,FIELDCAPTION("Prepmt Amt to Deduct"),MaxAmtToDeduct);
                END;
          UNTIL TempRcvdPurchLine.NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE AdjustInvLineWith100PctPrepmt@99(VAR PurchInvoiceLine@1000 : Record 39;VAR TempTotalPurchLine@1001 : TEMPORARY Record 39);
    VAR
      PurchOrderLine@1003 : Record 39;
      DiffAmtToDeduct@1002 : Decimal;
    BEGIN
      IF PurchInvoiceLine."Prepayment %" = 100 THEN BEGIN
        PurchOrderLine := TempTotalPurchLine;
        PurchOrderLine.FIND;
        IF TempTotalPurchLine."Qty. to Invoice" = PurchOrderLine.Quantity - PurchOrderLine."Quantity Invoiced" THEN BEGIN
          DiffAmtToDeduct :=
            PurchOrderLine."Prepmt. Amt. Inv." - PurchOrderLine."Prepmt Amt Deducted" - TempTotalPurchLine."Prepmt Amt to Deduct";
          IF DiffAmtToDeduct <> 0 THEN BEGIN
            PurchInvoiceLine."Prepmt Amt to Deduct" := PurchInvoiceLine."Prepmt Amt to Deduct" + DiffAmtToDeduct;
            PurchInvoiceLine."Line Amount" := PurchInvoiceLine."Prepmt Amt to Deduct";
            PurchInvoiceLine."Line Discount Amount" := PurchInvoiceLine."Line Discount Amount" - DiffAmtToDeduct;
            ModifyTempLine(PurchInvoiceLine);
            TempTotalPurchLine."Prepmt Amt to Deduct" := TempTotalPurchLine."Prepmt Amt to Deduct" + DiffAmtToDeduct;
          END;
        END;
      END;
    END;

    [External]
    PROCEDURE ArchiveUnpostedOrder@56(PurchHeader@1001 : Record 38);
    VAR
      PurchLine@1002 : Record 39;
      ArchiveManagement@1000 : Codeunit 5063;
      IsHandled@1003 : Boolean;
    BEGIN
      IsHandled := FALSE;
      OnBeforeArchiveUnpostedOrder(PurchHeader,IsHandled);
      IF IsHandled THEN
        EXIT;

      IF NOT (PurchHeader."Document Type" IN [PurchHeader."Document Type"::Order,PurchHeader."Document Type"::"Return Order"]) THEN
        EXIT;

      PurchSetup.GET;
      IF (PurchHeader."Document Type" = PurchHeader."Document Type"::Order) AND NOT PurchSetup."Archive Orders" THEN
        EXIT;
      IF (PurchHeader."Document Type" = PurchHeader."Document Type"::"Return Order") AND NOT PurchSetup."Archive Return Orders" THEN
        EXIT;

      PurchLine.RESET;
      PurchLine.SETRANGE("Document Type",PurchHeader."Document Type");
      PurchLine.SETRANGE("Document No.",PurchHeader."No.");
      PurchLine.SETFILTER(Quantity,'<>0');
      IF PurchHeader."Document Type" = PurchHeader."Document Type"::Order THEN
        PurchLine.SETFILTER("Qty. to Receive",'<>0')
      ELSE
        PurchLine.SETFILTER("Return Qty. to Ship",'<>0');
      IF NOT PurchLine.ISEMPTY AND NOT PreviewMode THEN BEGIN
        RoundDeferralsForArchive(PurchHeader,PurchLine);
        ArchiveManagement.ArchPurchDocumentNoConfirm(PurchHeader);
      END;
    END;

    LOCAL PROCEDURE PostItemJnlLineJobConsumption@59(PurchHeader@1007 : Record 38;VAR PurchLine@1000 : Record 39;ItemJournalLine@1008 : Record 83;VAR TempPurchReservEntry@1009 : TEMPORARY Record 337;QtyToBeInvoiced@1004 : Decimal;QtyToBeReceived@1002 : Decimal;VAR TempTrackingSpecification@1001 : TEMPORARY Record 336;PurchItemLedgEntryNo@1005 : Integer);
    VAR
      ItemLedgEntry@1102 : Record 32;
      TempReservationEntry@1003 : TEMPORARY Record 337;
      IsHandled@1006 : Boolean;
    BEGIN
      IsHandled := FALSE;
      OnPostItemJnlLineJobConsumption(
        PurchHeader,PurchLine,ItemJournalLine,TempPurchReservEntry,QtyToBeInvoiced,QtyToBeReceived,
        TempTrackingSpecification,PurchItemLedgEntryNo,IsHandled);
      IF IsHandled THEN
        EXIT;

      WITH PurchLine DO
        IF "Job No." <> '' THEN BEGIN
          ItemJournalLine."Entry Type" := ItemJournalLine."Entry Type"::"Negative Adjmt.";
          Job.GET("Job No.");
          ItemJournalLine."Source No." := Job."Bill-to Customer No.";
          IF PurchHeader.Invoice THEN BEGIN
            ItemLedgEntry.RESET;
            ItemLedgEntry.SETRANGE("Document Type",ItemLedgEntry."Document Type"::"Purchase Return Shipment");
            ItemLedgEntry.SETRANGE("Document No.",PurchHeader."Last Return Shipment No.");
            ItemLedgEntry.SETRANGE("Item No.","No.");
            ItemLedgEntry.SETRANGE("Entry Type",ItemLedgEntry."Entry Type"::"Negative Adjmt.");
            ItemLedgEntry.SETRANGE("Completely Invoiced",FALSE);
            IF ItemLedgEntry.FINDFIRST THEN
              ItemJournalLine."Item Shpt. Entry No." := ItemLedgEntry."Entry No.";
          END;
          ItemJournalLine."Source Type" := ItemJournalLine."Source Type"::Customer;
          ItemJournalLine."Discount Amount" := 0;

          GetAppliedItemLedgEntryNo(ItemJournalLine,"Quantity Received");

          IF QtyToBeReceived <> 0 THEN
            CopyJobConsumptionReservation(
              TempReservationEntry,TempPurchReservEntry,ItemJournalLine,TempTrackingSpecification,
              PurchItemLedgEntryNo,IsNonInventoriableItem);

          ItemJnlPostLine.RunPostWithReservation(ItemJournalLine,TempReservationEntry);

          IF QtyToBeInvoiced <> 0 THEN BEGIN
            "Qty. to Invoice" := QtyToBeInvoiced;
            JobPostLine.PostJobOnPurchaseLine(PurchHeader,PurchInvHeader,PurchCrMemoHeader,PurchLine,SrcCode);
          END;
        END;
    END;

    LOCAL PROCEDURE CopyJobConsumptionReservation@175(VAR TempReservEntryJobCons@1001 : TEMPORARY Record 337;VAR TempReservEntryPurchase@1002 : TEMPORARY Record 337;VAR ItemJournalLine@1003 : Record 83;VAR TempTrackingSpecification@1005 : TEMPORARY Record 336;PurchItemLedgEntryNo@1004 : Integer;IsNonInventoriableItem@1006 : Boolean);
    VAR
      NextReservationEntryNo@1000 : Integer;
    BEGIN
      // Item tracking for consumption
      NextReservationEntryNo := 1;
      IF TempReservEntryPurchase.FINDSET THEN
        REPEAT
          TempReservEntryJobCons := TempReservEntryPurchase;

          WITH TempReservEntryJobCons DO BEGIN
            "Entry No." := NextReservationEntryNo;
            Positive := NOT Positive;
            "Quantity (Base)" := -"Quantity (Base)";
            "Shipment Date" := "Expected Receipt Date";
            "Expected Receipt Date" := 0D;
            Quantity := -Quantity;
            "Qty. to Handle (Base)" := -"Qty. to Handle (Base)";
            "Qty. to Invoice (Base)" := -"Qty. to Invoice (Base)";
            "Source Subtype" := ItemJournalLine."Entry Type";
            "Source Ref. No." := ItemJournalLine."Line No.";

            IF NOT (ItemJournalLine.IsPurchaseReturn OR IsNonInventoriableItem) THEN BEGIN
              TempTrackingSpecification.SETRANGE("Serial No.","Serial No.");
              TempTrackingSpecification.SETRANGE("Lot No.","Lot No.");
              IF TempTrackingSpecification.FINDFIRST THEN
                "Appl.-to Item Entry" := TempTrackingSpecification."Item Ledger Entry No.";
            END;

            INSERT;
          END;

          NextReservationEntryNo := NextReservationEntryNo + 1;
        UNTIL TempReservEntryPurchase.NEXT = 0
      ELSE
        IF NOT (ItemJournalLine.IsPurchaseReturn OR IsNonInventoriableItem) THEN
          ItemJournalLine."Applies-to Entry" := PurchItemLedgEntryNo;
    END;

    LOCAL PROCEDURE GetAppliedItemLedgEntryNo@224(VAR ItemJournalLine@1000 : Record 83;QtyReceived@1003 : Decimal);
    VAR
      Item@1001 : Record 27;
      ItemLedgerEntry@1002 : Record 32;
    BEGIN
      Item.GET(ItemJournalLine."Item No.");
      IF Item.Type = Item.Type::Inventory THEN BEGIN
        IF QtyReceived > 0 THEN
          GetAppliedOutboundItemLedgEntryNo(ItemJournalLine)
        ELSE
          IF QtyReceived < 0 THEN
            GetAppliedInboundItemLedgEntryNo(ItemJournalLine);
      END ELSE
        IF ItemJournalLine."Item Shpt. Entry No." > 0 THEN BEGIN
          ItemLedgerEntry.GET(ItemJournalLine."Item Shpt. Entry No.");
          ItemLedgerEntry.SETRANGE("Document Type",ItemLedgerEntry."Document Type");
          ItemLedgerEntry.SETRANGE("Document No.",ItemLedgerEntry."Document No.");
          ItemLedgerEntry.SETRANGE("Document Line No.",ItemLedgerEntry."Document Line No.");
          ItemLedgerEntry.SETRANGE("Entry Type",ItemLedgerEntry."Entry Type"::"Negative Adjmt.");
          ItemLedgerEntry.SETRANGE("Item No.",ItemLedgerEntry."Item No.");
          ItemLedgerEntry.SETRANGE("Invoiced Quantity",0);
          IF ItemLedgerEntry.FINDFIRST THEN
            ItemJournalLine."Item Shpt. Entry No." := ItemLedgerEntry."Entry No."
        END;
    END;

    LOCAL PROCEDURE GetAppliedOutboundItemLedgEntryNo@80(VAR ItemJnlLine@1000 : Record 83);
    VAR
      ItemApplicationEntry@1001 : Record 339;
    BEGIN
      WITH ItemApplicationEntry DO BEGIN
        SETRANGE("Inbound Item Entry No.",ItemJnlLine."Item Shpt. Entry No.");
        IF FINDLAST THEN
          ItemJnlLine."Item Shpt. Entry No." := "Outbound Item Entry No.";
      END
    END;

    LOCAL PROCEDURE GetAppliedInboundItemLedgEntryNo@207(VAR ItemJnlLine@1000 : Record 83);
    VAR
      ItemApplicationEntry@1001 : Record 339;
    BEGIN
      WITH ItemApplicationEntry DO BEGIN
        SETRANGE("Outbound Item Entry No.",ItemJnlLine."Item Shpt. Entry No.");
        IF FINDLAST THEN
          ItemJnlLine."Item Shpt. Entry No." := "Inbound Item Entry No.";
      END
    END;

    LOCAL PROCEDURE ItemLedgerEntryExist@7(PurchLine2@1000 : Record 39;ReceiveOrShip@1002 : Boolean) : Boolean;
    VAR
      HasItemLedgerEntry@1001 : Boolean;
    BEGIN
      IF ReceiveOrShip THEN
        // item ledger entry will be created during posting in this transaction
        HasItemLedgerEntry :=
          ((PurchLine2."Qty. to Receive" + PurchLine2."Quantity Received") <> 0) OR
          ((PurchLine2."Qty. to Invoice" + PurchLine2."Quantity Invoiced") <> 0) OR
          ((PurchLine2."Return Qty. to Ship" + PurchLine2."Return Qty. Shipped") <> 0)
      ELSE
        // item ledger entry must already exist
        HasItemLedgerEntry :=
          (PurchLine2."Quantity Received" <> 0) OR
          (PurchLine2."Return Qty. Shipped" <> 0);

      EXIT(HasItemLedgerEntry);
    END;

    LOCAL PROCEDURE LockTables@60(VAR PurchHeader@1002 : Record 38);
    VAR
      PurchLine@1000 : Record 39;
      SalesLine@1001 : Record 37;
    BEGIN
      OnBeforeLockTables(PurchHeader,PreviewMode,SuppressCommit);

      PurchLine.LOCKTABLE;
      SalesLine.LOCKTABLE;
      GetGLSetup;
      IF NOT GLSetup.OptimGLEntLockForMultiuserEnv THEN BEGIN
        GLEntry.LOCKTABLE;
        IF GLEntry.FINDLAST THEN;
      END;
    END;

    LOCAL PROCEDURE MAX@31(number1@1000 : Integer;number2@1001 : Integer) : Integer;
    BEGIN
      IF number1 > number2 THEN
        EXIT(number1);
      EXIT(number2);
    END;

    [External]
    PROCEDURE CreateJobPurchLine@22(VAR JobPurchLine2@1000 : Record 39;PurchLine2@1001 : Record 39;PricesIncludingVAT@1002 : Boolean);
    BEGIN
      JobPurchLine2 := PurchLine2;
      IF PricesIncludingVAT THEN
        IF JobPurchLine2."VAT Calculation Type" = JobPurchLine2."VAT Calculation Type"::"Full VAT" THEN
          JobPurchLine2."Direct Unit Cost" := 0
        ELSE
          JobPurchLine2."Direct Unit Cost" := JobPurchLine2."Direct Unit Cost" / (1 + JobPurchLine2."VAT %" / 100);
    END;

    LOCAL PROCEDURE RevertWarehouseEntry@62(VAR TempWhseJnlLine@1000 : TEMPORARY Record 7311;JobNo@1001 : Code[20];PostJobConsumptionBeforePurch@1002 : Boolean) : Boolean;
    VAR
      IsHandled@1003 : Boolean;
      Result@1004 : Boolean;
    BEGIN
      IsHandled := FALSE;
      OnBeforeRevertWarehouseEntry(TempWhseJnlLine,JobNo,PostJobConsumptionBeforePurch,Result,IsHandled);
      IF IsHandled THEN
        EXIT(Result);

      IF PostJobConsumptionBeforePurch OR (JobNo = '') OR PositiveWhseEntrycreated THEN
        EXIT(FALSE);

      WITH TempWhseJnlLine DO BEGIN
        "Entry Type" := "Entry Type"::"Negative Adjmt.";
        Quantity := -Quantity;
        "Qty. (Base)" := -"Qty. (Base)";
        "From Bin Code" := "To Bin Code";
        "To Bin Code" := '';
      END;
      EXIT(TRUE);
    END;

    LOCAL PROCEDURE CreatePositiveEntry@93(WhseJnlLine@1000 : Record 7311;JobNo@1001 : Code[20];PostJobConsumptionBeforePurch@1002 : Boolean);
    BEGIN
      IF PostJobConsumptionBeforePurch OR (JobNo <> '') THEN BEGIN
        WITH WhseJnlLine DO BEGIN
          Quantity := -Quantity;
          "Qty. (Base)" := -"Qty. (Base)";
          "Qty. (Absolute)" := -"Qty. (Absolute)";
          "To Bin Code" := "From Bin Code";
          "From Bin Code" := '';
        END;
        WhseJnlPostLine.RUN(WhseJnlLine);
        PositiveWhseEntrycreated := TRUE;
      END;
    END;

    LOCAL PROCEDURE UpdateIncomingDocument@55(IncomingDocNo@1000 : Integer;PostingDate@1002 : Date;GenJnlLineDocNo@1003 : Code[20]);
    VAR
      IncomingDocument@1001 : Record 130;
    BEGIN
      IncomingDocument.UpdateIncomingDocumentFromPosting(IncomingDocNo,PostingDate,GenJnlLineDocNo);
    END;

    LOCAL PROCEDURE CheckItemCharge@61(ItemChargeAssignmentPurch@1000 : Record 5805);
    VAR
      PurchLineForCharge@1001 : Record 39;
    BEGIN
      WITH ItemChargeAssignmentPurch DO
        CASE "Applies-to Doc. Type" OF
          "Applies-to Doc. Type"::Order,
          "Applies-to Doc. Type"::Invoice:
            IF PurchLineForCharge.GET("Applies-to Doc. Type","Applies-to Doc. No.","Applies-to Doc. Line No.") THEN
              IF (PurchLineForCharge."Quantity (Base)" = PurchLineForCharge."Qty. Received (Base)") AND
                 (PurchLineForCharge."Qty. Rcd. Not Invoiced (Base)" = 0)
              THEN
                ERROR(ReassignItemChargeErr);
          "Applies-to Doc. Type"::"Return Order",
          "Applies-to Doc. Type"::"Credit Memo":
            IF PurchLineForCharge.GET("Applies-to Doc. Type","Applies-to Doc. No.","Applies-to Doc. Line No.") THEN
              IF (PurchLineForCharge."Quantity (Base)" = PurchLineForCharge."Return Qty. Shipped (Base)") AND
                 (PurchLineForCharge."Ret. Qty. Shpd Not Invd.(Base)" = 0)
              THEN
                ERROR(ReassignItemChargeErr);
        END;
    END;

    [External]
    PROCEDURE InitProgressWindow@105(PurchHeader@1000 : Record 38);
    BEGIN
      IF PurchHeader.Invoice THEN
        Window.OPEN(
          '#1#################################\\' +
          PostingLinesMsg +
          PostingPurchasesAndVATMsg +
          PostingVendorsMsg +
          PostingBalAccountMsg)
      ELSE
        Window.OPEN(
          '#1############################\\' +
          PostingLines2Msg);

      Window.UPDATE(1,STRSUBSTNO('%1 %2',PurchHeader."Document Type",PurchHeader."No."));
    END;

    [External]
    PROCEDURE SetPreviewMode@74(NewPreviewMode@1000 : Boolean);
    BEGIN
      PreviewMode := NewPreviewMode;
    END;

    LOCAL PROCEDURE UpdateInvoicedQtyOnPurchRcptLine@107(VAR PurchInvHeader@1003 : Record 122;VAR PurchRcptLine@1000 : Record 121;VAR PurchaseHeader@1004 : Record 38;VAR PurchaseLine@1005 : Record 39;QtyToBeInvoiced@1001 : Decimal;QtyToBeInvoicedBase@1002 : Decimal;TrackingSpecificationExists@1006 : Boolean);
    VAR
      CurrExchRate@1100525000 : Record 330;
      PurchReceiptHeader@1100525002 : Record 120;
    BEGIN
      OnBeforeUpdateInvoicedQtyOnPurchRcptLine(
        PurchRcptLine,QtyToBeInvoiced,QtyToBeInvoicedBase,SuppressCommit,PurchInvHeader,PurchaseHeader,PurchaseLine);

      WITH PurchRcptLine DO BEGIN
        "Quantity Invoiced" := "Quantity Invoiced" + QtyToBeInvoiced;
        "Qty. Invoiced (Base)" := "Qty. Invoiced (Base)" + QtyToBeInvoicedBase;
        "Qty. Rcd. Not Invoiced" := Quantity - "Quantity Invoiced";
        //**4PS.sn
        "Invoiced (line)" := "Invoiced (line)" +
          ROUND(QtyToBeInvoiced * GetPurchLineUnitCostInclDisc(PurchaseLine), Currency."Amount Rounding Precision");

        PurchReceiptHeader.GET(PurchRcptLine."Document No.");
        IF PurchReceiptHeader."Currency Code" = '' THEN
          PurchRcptLine."Invoiced (LCY) (line)" := PurchRcptLine."Invoiced (line)"
        ELSE
          PurchRcptLine."Invoiced (LCY) (line)" :=
            ROUND(
              CurrExchRate.ExchangeAmtFCYToLCY(
                1, PurchRcptHeader."Job No.", "Posting Date", PurchReceiptHeader."Currency Code",
                PurchRcptLine."Invoiced (line)", PurchReceiptHeader."Currency Factor",FALSE));

        IF PurchaseHeader."Amounts only" THEN
          PurchRcptLine."Amnt. Rcd. Not Invoiced (LCY)" :=
            PurchRcptLine."Amount (LCY)" - PurchRcptLine."Invoiced (LCY) (line)"
        ELSE BEGIN
          PurchRcptLine."Amnt. Rcd. Not Invoiced" :=
            PurchRcptLine."Received (line)" - PurchRcptLine."Invoiced (line)";
          PurchRcptLine."Amnt. Rcd. Not Invoiced (LCY)" :=
            PurchRcptLine."Amount (LCY)" - PurchRcptLine."Invoiced (LCY) (line)";
        END;
        //**4PS.en
        MODIFY;
      END;

      OnAfterUpdateInvoicedQtyOnPurchRcptLine(
        PurchInvHeader,PurchRcptLine,PurchaseLine,TempTrackingSpecification,TrackingSpecificationExists,
        QtyToBeInvoiced,QtyToBeInvoicedBase,PurchaseHeader,SuppressCommit);
    END;

    LOCAL PROCEDURE UpdateInvoicedQtyOnReturnShptLine@280(VAR ReturnShptLine@1000 : Record 6651;QtyToBeInvoiced@1002 : Decimal;QtyToBeInvoicedBase@1001 : Decimal);
    BEGIN
      WITH ReturnShptLine DO BEGIN
        "Quantity Invoiced" := "Quantity Invoiced" - QtyToBeInvoiced;
        "Qty. Invoiced (Base)" := "Qty. Invoiced (Base)" - QtyToBeInvoicedBase;
        "Return Qty. Shipped Not Invd." := Quantity - "Quantity Invoiced";
        MODIFY;
      END;
    END;

    LOCAL PROCEDURE UpdateQtyPerUnitOfMeasure@63(VAR PurchLine@1000 : Record 39);
    VAR
      ItemUnitOfMeasure@1001 : Record 5404;
    BEGIN
      IF PurchLine."Qty. per Unit of Measure" = 0 THEN
        IF (PurchLine.Type = PurchLine.Type::Item) AND
           (PurchLine."Unit of Measure Code" <> '') AND
           ItemUnitOfMeasure.GET(PurchLine."No.",PurchLine."Unit of Measure Code")
        THEN
          PurchLine."Qty. per Unit of Measure" := ItemUnitOfMeasure."Qty. per Unit of Measure"
        ELSE
          PurchLine."Qty. per Unit of Measure" := 1;
    END;

    LOCAL PROCEDURE UpdateQtyToBeInvoicedForReceipt@101(VAR QtyToBeInvoiced@1000 : Decimal;VAR QtyToBeInvoicedBase@1001 : Decimal;TrackingSpecificationExists@1002 : Boolean;PurchLine@1003 : Record 39;PurchRcptLine@1004 : Record 121;InvoicingTrackingSpecification@1006 : Record 336);
    BEGIN
      IF PurchLine."Document Type" = PurchLine."Document Type"::Invoice THEN //**4PS.n
        IF PurchLine."Qty. to Invoice" * PurchRcptLine.Quantity < 0 THEN
          PurchLine.FIELDERROR("Qty. to Invoice",ReceiptSameSignErr);
      IF TrackingSpecificationExists THEN BEGIN
        QtyToBeInvoiced := InvoicingTrackingSpecification."Qty. to Invoice";
        QtyToBeInvoicedBase := InvoicingTrackingSpecification."Qty. to Invoice (Base)";
      END ELSE BEGIN
        QtyToBeInvoiced := RemQtyToBeInvoiced - PurchLine."Qty. to Receive";
        QtyToBeInvoicedBase := RemQtyToBeInvoicedBase - PurchLine."Qty. to Receive (Base)";
      END;
      //**4PS.sn
      IF (PurchLine."Document Type" = PurchLine."Document Type"::"Credit Memo") AND (NOT NegativeOrderQuantity) THEN BEGIN
        IF ABS(QtyToBeInvoiced) > ABS(PurchRcptLine."Quantity Invoiced") THEN BEGIN
          QtyToBeInvoiced := -PurchRcptLine."Quantity Invoiced";
          QtyToBeInvoicedBase := -PurchRcptLine."Qty. Invoiced (Base)";
        END;
      END ELSE BEGIN
      //**4PS.en
        IF ABS(QtyToBeInvoiced) > ABS(PurchRcptLine.Quantity - PurchRcptLine."Quantity Invoiced") THEN BEGIN
          QtyToBeInvoiced := PurchRcptLine.Quantity - PurchRcptLine."Quantity Invoiced";
          QtyToBeInvoicedBase := PurchRcptLine."Quantity (Base)" - PurchRcptLine."Qty. Invoiced (Base)";
        END;
      END; //**4PS.n
    END;

    LOCAL PROCEDURE UpdateQtyToBeInvoicedForReturnShipment@198(VAR QtyToBeInvoiced@1004 : Decimal;VAR QtyToBeInvoicedBase@1003 : Decimal;TrackingSpecificationExists@1002 : Boolean;PurchLine@1001 : Record 39;ReturnShipmentLine@1000 : Record 6651;InvoicingTrackingSpecification@1005 : Record 336);
    BEGIN
      IF PurchLine."Qty. to Invoice" * ReturnShipmentLine.Quantity > 0 THEN
        PurchLine.FIELDERROR("Qty. to Invoice",ReturnShipmentSamesSignErr);
      IF TrackingSpecificationExists THEN BEGIN
        QtyToBeInvoiced := InvoicingTrackingSpecification."Qty. to Invoice";
        QtyToBeInvoicedBase := InvoicingTrackingSpecification."Qty. to Invoice (Base)";
      END ELSE BEGIN
        QtyToBeInvoiced := RemQtyToBeInvoiced - PurchLine."Return Qty. to Ship";
        QtyToBeInvoicedBase := RemQtyToBeInvoicedBase - PurchLine."Return Qty. to Ship (Base)";
      END;
      IF ABS(QtyToBeInvoiced) > ABS(ReturnShipmentLine.Quantity - ReturnShipmentLine."Quantity Invoiced") THEN BEGIN
        QtyToBeInvoiced := ReturnShipmentLine."Quantity Invoiced" - ReturnShipmentLine.Quantity;
        QtyToBeInvoicedBase := ReturnShipmentLine."Qty. Invoiced (Base)" - ReturnShipmentLine."Quantity (Base)";
      END;
    END;

    LOCAL PROCEDURE UpdateRemainingQtyToBeInvoiced@102(VAR RemQtyToInvoiceCurrLine@1000 : Decimal;VAR RemQtyToInvoiceCurrLineBase@1001 : Decimal;PurchRcptLine@1002 : Record 121);
    BEGIN
      RemQtyToInvoiceCurrLine := PurchRcptLine.Quantity - PurchRcptLine."Quantity Invoiced";
      RemQtyToInvoiceCurrLineBase := PurchRcptLine."Quantity (Base)" - PurchRcptLine."Qty. Invoiced (Base)";
      IF RemQtyToInvoiceCurrLine > RemQtyToBeInvoiced THEN BEGIN
        RemQtyToInvoiceCurrLine := RemQtyToBeInvoiced;
        RemQtyToInvoiceCurrLineBase := RemQtyToBeInvoicedBase;
      END;
    END;

    LOCAL PROCEDURE GetCountryCode@75(SalesLine@1000 : Record 37;SalesHeader@1001 : Record 36) : Code[10];
    VAR
      SalesShipmentHeader@1003 : Record 110;
      CountryRegionCode@1002 : Code[10];
      IsHandled@1004 : Boolean;
    BEGIN
      IsHandled := FALSE;
      OnBeforeGetCountryCode(SalesHeader,SalesLine,CountryRegionCode,IsHandled);
      IF IsHandled THEN
        EXIT(CountryRegionCode);

      IF SalesLine."Shipment No." <> '' THEN BEGIN
        SalesShipmentHeader.GET(SalesLine."Shipment No.");
        EXIT(
          GetCountryRegionCode(
            SalesLine."Sell-to Customer No.",
            SalesShipmentHeader."Ship-to Code",
            SalesShipmentHeader."Sell-to Country/Region Code"));
      END;
      EXIT(
        GetCountryRegionCode(
          SalesLine."Sell-to Customer No.",
          SalesHeader."Ship-to Code",
          SalesHeader."Sell-to Country/Region Code"));
    END;

    LOCAL PROCEDURE GetCountryRegionCode@103(CustNo@1001 : Code[20];ShipToCode@1002 : Code[10];SellToCountryRegionCode@1003 : Code[10]) : Code[10];
    VAR
      ShipToAddress@1000 : Record 222;
    BEGIN
      IF ShipToCode <> '' THEN BEGIN
        ShipToAddress.GET(CustNo,ShipToCode);
        EXIT(ShipToAddress."Country/Region Code");
      END;
      EXIT(SellToCountryRegionCode);
    END;

    LOCAL PROCEDURE CheckItemReservDisruption@104(PurchLine@1002 : Record 39);
    VAR
      Item@1000 : Record 27;
      ConfirmManagement@1003 : Codeunit 27;
      AvailableQty@1001 : Decimal;
    BEGIN
      WITH PurchLine DO BEGIN
        IF NOT IsCreditDocType OR (Type <> Type::Item) OR NOT ("Return Qty. to Ship (Base)" > 0) THEN
          EXIT;

        IF Nonstock OR "Special Order" OR "Drop Shipment" OR IsNonInventoriableItem OR
           TempSKU.GET("Location Code","No.","Variant Code") // Warn against item
        THEN
          EXIT;

        Item.GET("No.");
        Item.SETFILTER("Location Filter","Location Code");
        Item.SETFILTER("Variant Filter","Variant Code");
        Item.CALCFIELDS("Reserved Qty. on Inventory","Net Change");
        CALCFIELDS("Reserved Qty. (Base)");
        AvailableQty := Item."Net Change" - (Item."Reserved Qty. on Inventory" - ABS("Reserved Qty. (Base)"));

        IF (Item."Reserved Qty. on Inventory" > 0) AND
           (AvailableQty < "Return Qty. to Ship (Base)") AND
           (Item."Reserved Qty. on Inventory" > ABS("Reserved Qty. (Base)"))
        THEN BEGIN
          InsertTempSKU("Location Code","No.","Variant Code");
          IF NOT ConfirmManagement.ConfirmProcess(
               STRSUBSTNO(
                 ReservationDisruptedQst,FIELDCAPTION("No."),Item."No.",FIELDCAPTION("Location Code"),
                 "Location Code",FIELDCAPTION("Variant Code"),"Variant Code"),TRUE)
          THEN
            ERROR('');
        END;
      END;
    END;

    LOCAL PROCEDURE InsertTempSKU@106(LocationCode@1000 : Code[10];ItemNo@1001 : Code[20];VariantCode@1002 : Code[10]);
    BEGIN
      WITH TempSKU DO BEGIN
        INIT;
        "Location Code" := LocationCode;
        "Item No." := ItemNo;
        "Variant Code" := VariantCode;
        INSERT;
      END;
    END;

    LOCAL PROCEDURE UpdatePurchLineDimSetIDFromAppliedEntry@67(VAR PurchLineToPost@1000 : Record 39;PurchLine@1001 : Record 39);
    VAR
      ItemLedgEntry@1002 : Record 32;
      DimensionMgt@1003 : Codeunit 408;
      DimSetID@1004 : ARRAY [10] OF Integer;
    BEGIN
      DimSetID[1] := PurchLine."Dimension Set ID";
      WITH PurchLineToPost DO BEGIN
        IF "Appl.-to Item Entry" <> 0 THEN BEGIN
          ItemLedgEntry.GET("Appl.-to Item Entry");
          DimSetID[2] := ItemLedgEntry."Dimension Set ID";
        END;
        "Dimension Set ID" :=
          DimensionMgt.GetCombinedDimensionSetID(DimSetID,"Shortcut Dimension 1 Code","Shortcut Dimension 2 Code");
      END;
    END;

    LOCAL PROCEDURE CheckCertificateOfSupplyStatus@188(ReturnShptHeader@1000 : Record 6650;ReturnShptLine@1001 : Record 6651);
    VAR
      CertificateOfSupply@1002 : Record 780;
      VATPostingSetup@1003 : Record 325;
    BEGIN
      IF ReturnShptLine.Quantity <> 0 THEN
        IF VATPostingSetup.GET(ReturnShptHeader."VAT Bus. Posting Group",ReturnShptLine."VAT Prod. Posting Group") AND
           VATPostingSetup."Certificate of Supply Required"
        THEN BEGIN
          CertificateOfSupply.InitFromPurchase(ReturnShptHeader);
          CertificateOfSupply.SetRequired(ReturnShptHeader."No.")
        END;
    END;

    LOCAL PROCEDURE CheckSalesCertificateOfSupplyStatus@69(SalesShptHeader@1001 : Record 110;SalesShptLine@1000 : Record 111);
    VAR
      CertificateOfSupply@1002 : Record 780;
      VATPostingSetup@1003 : Record 325;
    BEGIN
      IF SalesShptLine.Quantity <> 0 THEN
        IF VATPostingSetup.GET(SalesShptHeader."VAT Bus. Posting Group",SalesShptLine."VAT Prod. Posting Group") AND
           VATPostingSetup."Certificate of Supply Required"
        THEN BEGIN
          CertificateOfSupply.InitFromSales(SalesShptHeader);
          CertificateOfSupply.SetRequired(SalesShptHeader."No.");
        END;
    END;

    LOCAL PROCEDURE InsertPostedHeaders@133(VAR PurchHeader@1000 : Record 38;VAR ModifyHeader@1100525003 : Boolean);
    VAR
      SalesShptLine@1002 : Record 111;
      PurchRcptLine@1001 : Record 121;
      GenJnlLine@1003 : Record 81;
      PostingPreviewEventHandler@1004 : Codeunit 20;
      ReceiptHeaderExists@1100525000 : Boolean;
      ApprovalManagement4PSConstr@1100525001 : Codeunit 11125349;
      PurchCommentLine@1100525002 : Record 43;
    BEGIN
      IF PreviewMode THEN
        PostingPreviewEventHandler.PreventCommit;
      WITH PurchHeader DO BEGIN
        // Insert receipt header
        //IF Receive THEN //**4PS.o
        //**4PS.sn
        IF "Receipts in Bundles" THEN
          ReceiptHeaderExists := PurchRcptHeader.GET("Receiving No.");
        IF Receive AND NOT ReceiptHeaderExists THEN
        //**4PS.en
          IF ("Document Type" = "Document Type"::Order) OR
             (("Document Type" = "Document Type"::Invoice) AND PurchSetup."Receipt on Invoice")
          THEN BEGIN
            IF DropShipOrder THEN BEGIN
              PurchRcptHeader.LOCKTABLE;
              PurchRcptLine.LOCKTABLE;
              SalesShptHeader.LOCKTABLE;
              SalesShptLine.LOCKTABLE;
            END;
            InsertReceiptHeader(PurchHeader,PurchRcptHeader);
            CopyDocuments(PurchHeader,PurchRcptHeader); //**4PS.n
            ServItemMgt.CopyReservation(PurchHeader);
          END;

        // Insert return shipment header
        IF Ship THEN
          IF ("Document Type" = "Document Type"::"Return Order") OR
             (("Document Type" = "Document Type"::"Credit Memo") AND PurchSetup."Return Shipment on Credit Memo")
          THEN
            InsertReturnShipmentHeader(PurchHeader,ReturnShptHeader);

        // Insert invoice header or credit memo header
        IF Invoice THEN
          IF "Document Type" IN ["Document Type"::Order,"Document Type"::Invoice] THEN BEGIN
        //NTR Start
            PurchSetup.GET;
            InwRegHeader.SETRANGE("Document Type",PurchHeader."Document Type");
            InwRegHeader.SETRANGE("Document No.",PurchHeader."No.");
            InwRegHeader.SETRANGE(Status, InwRegHeader.Status::Posted);
            IF InwRegHeader.FIND('-') THEN
              InwRegReverse.RUN(InwRegHeader);
        //NTR End
            InsertInvoiceHeader(PurchHeader,PurchInvHeader);
            GenJnlLineDocType := GenJnlLine."Document Type"::Invoice;
            GenJnlLineDocNo := PurchInvHeader."No.";
            GenJnlLineExtDocNo := "Vendor Invoice No.";
            GetGLSetup; //NAVFI
            IF GLSetup."Finnish localization active" THEN BEGIN
              CALCFIELDS("Message Type","Invoice Message");
              TESTFIELD("Invoice Message");  //NAVFI
            END;
            //**4PS.sn
            ReplaceDocLink := TRUE;
            IF NOT ApprovalManagement4PSConstr.OpenApprovalEntryPurchDoc(PurchInvHeader) THEN BEGIN
              IF ("On Hold" <> '') AND ("Invoice Lines Input") THEN BEGIN
                OnHoldRec.GET("On Hold");
                IF NOT OnHoldRec."Remain On Hold" THEN BEGIN
                  IF NOT ApprovalManagement4PSConstr.DCKeepOnHold THEN BEGIN
                    PurchInvHeader."On Hold" := '';
                    PurchInvHeader."Approvement Initials" := '';
                    PurchInvHeader.MODIFY;
                    "On Hold" := '';
                    "Approvement Initials" := '';
                    ModifyHeader := TRUE;
                  END;
                END;
              END;
            END;
            OnHoldCodeFromPurchLines(PurchHeader, PurchInvHeader."On Hold", PurchInvHeader."Approvement Initials");
            //**4PS.en
          END ELSE BEGIN // Credit Memo
            InsertCrMemoHeader(PurchHeader,PurchCrMemoHeader);
            GenJnlLineDocType := GenJnlLine."Document Type"::"Credit Memo";
            GenJnlLineDocNo := PurchCrMemoHeader."No.";
            GenJnlLineExtDocNo := "Vendor Cr. Memo No.";
            ReplaceDocLink := TRUE;
            IF NOT ApprovalManagement4PSConstr.OpenApprovalEntryPurchDoc(PurchCrMemoHeader) THEN BEGIN
              IF ("On Hold" <> '') AND ("Invoice Lines Input") THEN BEGIN
                OnHoldRec.GET("On Hold");
                IF NOT OnHoldRec."Remain On Hold" THEN BEGIN
                  IF NOT ApprovalManagement4PSConstr.DCKeepOnHold THEN BEGIN
                    PurchCrMemoHeader."On Hold" := '';
                    PurchCrMemoHeader."Approvement Initials" := '';
                    PurchCrMemoHeader.MODIFY;
                    "On Hold" := '';
                    "Approvement Initials" := '';
                    ModifyHeader := TRUE;
                  END;
                END;
              END;
            END;
            OnHoldCodeFromPurchLines(PurchHeader, PurchCrMemoHeader."On Hold", PurchCrMemoHeader."Approvement Initials");
            //**4PS.en
          END;
        //**4PS02.sn
        //Insert header for invoice to approve
        IF "Register Invoice" AND ("Document Type" = "Document Type"::Order) THEN BEGIN
          PurchHeaderInvToApprove.INIT;
          PurchHeaderInvToApprove.TRANSFERFIELDS(PurchHeader);
          PurchHeaderInvToApprove."Document Type" := PurchHeaderInvToApprove."Document Type"::Invoice;
          PurchHeaderInvToApprove."Receiving No." := '';
          PurchHeaderInvToApprove."Last Receiving No." := '';
          PurchHeaderInvToApprove."No." := "Posting No.";
          PurchHeaderInvToApprove."No. Series" := "No. Series";
          PurchHeaderInvToApprove."Related Purch. Order No." := "No.";
          PurchHeaderInvToApprove.Status := PurchHeaderInvToApprove.Status::Open;
          PurchHeaderInvToApprove."Invoice Lines Input" := TRUE;
          IF GUIALLOWED THEN
            Window.UPDATE(1,STRSUBSTNO(InvoiceNoMsg,"Document Type","No.",PurchHeaderInvToApprove."No."));
          PurchHeaderInvToApprove."No. Printed" := 0;

          PurchHeaderInvToApprove.INSERT;
          PurchaseHeaderExtension.CopyPurchHeadExtension("Document Type","No.",PurchHeaderInvToApprove."Document Type",PurchHeaderInvToApprove."No.");

          IF PurchSetup."Copy Comments Order to Invoice" THEN
            PurchCommentLine.CopyComments(
              "Document Type"::Order,PurchCommentLine."Document Type"::Invoice,"No.",PurchHeaderInvToApprove."No.");
        END;
        //**4PS02.en
        //4PSSE, DL, 131202, apply rounding-off '”resutj„mning'
        PrePostRoundingOff(PurchHeader);
      END;

      OnAfterInsertPostedHeaders(PurchHeader,PurchRcptHeader,PurchInvHeader,PurchCrMemoHeader,ReturnShptHeader);
    END;

    LOCAL PROCEDURE InsertReceiptHeader@71(VAR PurchHeader@1000 : Record 38;VAR PurchRcptHeader@1001 : Record 120);
    VAR
      PurchCommentLine@1002 : Record 43;
      RecordLinkManagement@1003 : Codeunit 447;
      IsHandled@1004 : Boolean;
    BEGIN
      IsHandled := FALSE;
      OnBeforeInsertReceiptHeader(PurchHeader,PurchRcptHeader,IsHandled,SuppressCommit);

      WITH PurchHeader DO BEGIN
        IF NOT IsHandled THEN BEGIN
          PurchRcptHeader.INIT;
          PurchRcptHeader.TRANSFERFIELDS(PurchHeader);
          PurchRcptHeader."No." := "Receiving No.";
          IF "Document Type" = "Document Type"::Order THEN BEGIN
            PurchRcptHeader."Order No. Series" := "No. Series";
            PurchRcptHeader."Order No." := "No.";
          END;
          PurchRcptHeader."No. Printed" := 0;
          PurchRcptHeader."Source Code" := SrcCode;
          PurchRcptHeader."User ID" := USERID;
          PurchRcptHeader."Created on" := TODAY; //**4PS.n
          OnBeforePurchRcptHeaderInsert(PurchRcptHeader,PurchHeader,SuppressCommit);
          PurchRcptHeader.INSERT(TRUE);
          OnAfterPurchRcptHeaderInsert(PurchRcptHeader,PurchHeader,SuppressCommit);

          ApprovalsMgmt.PostApprovalEntries(RECORDID,PurchRcptHeader.RECORDID,PurchRcptHeader."No.");
          //**4PS.sn C017601
          ApprovalsMgmt.PostApprovalCommentLines(RECORDID,PurchRcptHeader.RECORDID,PurchRcptHeader."No.");
          //**4PS.en
          IF PurchSetup."Copy Comments Order to Receipt" THEN BEGIN
            PurchCommentLine.CopyComments(
              "Document Type",PurchCommentLine."Document Type"::Receipt,"No.",PurchRcptHeader."No.");
            RecordLinkManagement.CopyLinks(PurchHeader,PurchRcptHeader);
          END;
        END;

        IF WhseReceive THEN BEGIN
          WhseRcptHeader.GET(TempWhseRcptHeader."No.");
          OnBeforeCreatePostedWhseRcptHeader(PostedWhseRcptHeader,WhseRcptHeader,PurchHeader);
          WhsePostRcpt.CreatePostedRcptHeader(PostedWhseRcptHeader,WhseRcptHeader,"Receiving No.","Posting Date");
        END;
        IF WhseShip THEN BEGIN
          WhseShptHeader.GET(TempWhseShptHeader."No.");
          OnBeforeCreatePostedWhseShptHeader(PostedWhseShptHeader,WhseShptHeader,PurchHeader);
          WhsePostShpt.CreatePostedShptHeader(PostedWhseShptHeader,WhseShptHeader,"Receiving No.","Posting Date");
        END;
      END;
    END;

    LOCAL PROCEDURE InsertReceiptLine@143(PurchRcptHeader@1000 : Record 120;PurchLine@1001 : Record 39;CostBaseAmount@1006 : Decimal;PurchHeader@1100525001 : Record 38;NextRcptLineNo@1100525005 : Integer;VAR NewPurchRcptLine@1100525000 : Record 121;VAR LastRefNo@1100525003 : Code[20]);
    VAR
      PurchRcptLine@1003 : Record 121;
      WhseRcptLine@1004 : Record 7317;
      WhseShptLine@1005 : Record 7321;
      PurchaseLineExtension@1100525002 : Record 11020644;
      PurchRouteRefMgt@1100525006 : Codeunit 11012045;
    BEGIN
      //PurchRcptLine.InitFromPurchLine(PurchRcptHeader,xPurchLine); //**4PS.o
      PurchRcptLine.InitFromPurchLine(PurchRcptHeader,PurchLine); //**4PS.n

      PurchRcptLine."Quantity Invoiced" := RemQtyToBeInvoiced;
      PurchRcptLine."Qty. Invoiced (Base)" := RemQtyToBeInvoicedBase;
      PurchRcptLine."Qty. Rcd. Not Invoiced" := PurchRcptLine.Quantity - PurchRcptLine."Quantity Invoiced";

      //**4PS.sn
      IF (PurchHeader."Document Type" = PurchHeader."Document Type"::Order) AND (PurchLine."Employee No." <> '') THEN
        //For (rental)orders use posting date of line instead of posting date in header
        PurchRcptLine."Posting Date" := PurchLine."Posting Date"
      ELSE
        PurchRcptLine."Posting Date" := PurchHeader."Posting Date";
      PurchRcptLine."Line No." := NextRcptLineNo;
      //**4PS.en
      IF (PurchLine.Type = PurchLine.Type::Item) AND (PurchLine."Qty. to Receive" <> 0) THEN BEGIN
        IF WhseReceive THEN
          IF WhseRcptLine.GetWhseRcptLine(
               WhseRcptHeader."No.",DATABASE::"Purchase Line",PurchLine."Document Type",PurchLine."Document No.",PurchLine."Line No.")
          THEN BEGIN
            WhseRcptLine.TESTFIELD("Qty. to Receive",PurchRcptLine.Quantity);
            SaveTempWhseSplitSpec(PurchLine);
            WhsePostRcpt.CreatePostedRcptLine(
              WhseRcptLine,PostedWhseRcptHeader,PostedWhseRcptLine,TempWhseSplitSpecification);
          END;

        IF WhseShip THEN
          IF WhseShptLine.GetWhseShptLine(
               WhseShptHeader."No.",DATABASE::"Purchase Line",PurchLine."Document Type",PurchLine."Document No.",PurchLine."Line No.")
          THEN BEGIN
            WhseShptLine.TESTFIELD("Qty. to Ship",-PurchRcptLine.Quantity);
            SaveTempWhseSplitSpec(PurchLine);
            WhsePostShpt.CreatePostedShptLine(
              WhseShptLine,PostedWhseShptHeader,PostedWhseShptLine,TempWhseSplitSpecification);
          END;
        PurchRcptLine."Item Rcpt. Entry No." := InsertRcptEntryRelation(PurchRcptLine);
        PurchRcptLine."Item Charge Base Amount" := ROUND(CostBaseAmount / PurchLine.Quantity * PurchRcptLine.Quantity);
      END;

      //**4PS.sn
      IF PurchHeader."Amounts only" THEN BEGIN
        PurchRcptLine."Received (line)" := xPurchLine."Amnt. to Receive";
        PurchRcptLine."Amnt. Rcd. Not Invoiced" := xPurchLine."Amnt. to Receive";
      END ELSE BEGIN
        PurchRcptLine."Received (line)" :=
          ROUND(PurchRcptLine.Quantity * GetPurchLineUnitCostInclDisc(PurchLine), Currency."Amount Rounding Precision");
      END;

      IF PurchRcptHeader."Currency Code" = '' THEN
        PurchRcptLine."Amount (LCY)" := ROUND(PurchRcptLine."Received (line)")
      ELSE
        PurchRcptLine."Amount (LCY)" :=
          ROUND(
            CurrExchRate.ExchangeAmtFCYToLCY(
              1, PurchRcptHeader."Job No.",
              PurchRcptLine."Posting Date", PurchRcptHeader."Currency Code",
              PurchRcptLine."Received (line)", PurchRcptHeader."Currency Factor",FALSE));

      IF NOT PurchHeader.Invoice THEN
        PurchRcptLine."Invoiced (line)" := 0
      ELSE BEGIN
        IF PurchHeader."Amounts only" THEN BEGIN
          IF ABS(xPurchLine."Amnt. to Invoice") > ABS(xPurchLine."Amnt. to Receive") THEN
            PurchRcptLine."Invoiced (line)" := xPurchLine."Amnt. to Receive"
          ELSE
            PurchRcptLine."Invoiced (line)" := xPurchLine."Amnt. to Invoice";
          PurchRcptLine."Amnt. Rcd. Not Invoiced" := PurchRcptLine."Received (line)" - PurchRcptLine."Invoiced (line)";
        END ELSE BEGIN
          PurchRcptLine."Invoiced (line)" :=
            ROUND(PurchRcptLine."Quantity Invoiced" * GetPurchLineUnitCostInclDisc(PurchLine),
              Currency."Amount Rounding Precision");
        END;
      END;
      PurchRcptLine."Close Pl.Ext.Rent Ord. on Rcpt" := GetCloseExtRentPlantOnReceipt(PurchHeader,xPurchLine);
      IF (PurchRcptLine."Requested Receipt Date" <> 0D) THEN
        PurchRcptLine."Requested Receipt Date differs" := PurchRcptLine."Posting Date" - PurchRcptLine."Requested Receipt Date";
      IF (PurchRcptLine."Promised Receipt Date" <> 0D) THEN
        PurchRcptLine."Promised Receipt Date differs" := PurchRcptLine."Posting Date" - PurchRcptLine."Promised Receipt Date";
      PurchaseLineExtension.GetPurchLineExtension(
        xPurchLine."Document Type",xPurchLine."Document No.",xPurchLine."Line No.");
      PurchRcptLine."Yard No." := PurchaseLineExtension."Yard No.";
      PurchRcptLine."System No." := PurchaseLineExtension."System No.";
      PurchRcptLine."Entity Type" := xPurchLine."Entity Type";
      PurchRcptLine."Entity No." := PurchaseLineExtension."Entity No.";
      PurchRcptLine."Cable Transit Pos." := PurchaseLineExtension."Cable Transit Pos.";
      IF PlotNoReceipts <> '' THEN
        PurchRcptLine."Plot No." := PlotNoReceipts;

      IF PurchRcptHeader."Currency Code" = '' THEN
        PurchRcptLine."Invoiced (LCY) (line)" := PurchRcptLine."Invoiced (line)"
      ELSE
        PurchRcptLine."Invoiced (LCY) (line)" :=
          ROUND(
            CurrExchRate.ExchangeAmtFCYToLCY(
              1, PurchRcptHeader."Job No.", PurchHeader."Posting Date", PurchRcptHeader."Currency Code",
              PurchRcptLine."Invoiced (line)", PurchRcptHeader."Currency Factor",FALSE));

      IF PurchHeader."Amounts only" THEN BEGIN
        PurchRcptLine."Amnt. Rcd. Not Invoiced (LCY)" :=
          PurchRcptLine."Amount (LCY)" - PurchRcptLine."Invoiced (LCY) (line)";
      END ELSE BEGIN
        PurchRcptLine."Amnt. Rcd. Not Invoiced" :=
          PurchRcptLine."Received (line)" - PurchRcptLine."Invoiced (line)";
        PurchRcptLine."Amnt. Rcd. Not Invoiced (LCY)" :=
          PurchRcptLine."Amount (LCY)" - PurchRcptLine."Invoiced (LCY) (line)";
      END;
      //**4PS.en

      OnBeforePurchRcptLineInsert(PurchRcptLine,PurchRcptHeader,PurchLine,SuppressCommit,PostedWhseRcptLine);
      PurchRcptLine.INSERT(TRUE);

      // ExFlow
      IF ExFlowSetupExists THEN
        ExFlowPurchPost.CreateNewDocLineForReceipt(PurchRcptLine);
      // ExFlow
      OnAfterPurchRcptLineInsert(
        PurchLine,PurchRcptLine,ItemLedgShptEntryNo,WhseShip,WhseReceive,SuppressCommit,PurchInvHeader,TempTrackingSpecification);

      //**4PS.sn
      xPurchLine.CopyPurLineDetailsToRcptLine(PurchRcptLine);
      CreatePurchaseOrderControl(PurchLine);

      IF (PurchLine."Purchase Route Reference" = '') THEN BEGIN
        IF (LastRefNo = '') THEN BEGIN
          LastRefNo := PurchRouteRefMgt.GetLastRefNo();
          LastRefNo := INCSTR(LastRefNo);
          PurchRouteRefMgt.WriteLastRefNo(LastRefNo);
        END;
        TempPurchLineGlobal.GET(PurchLine."Document Type", PurchLine."Document No.",PurchLine."Line No.");
        TempPurchLineGlobal."Purchase Route Reference" := LastRefNo;
        TempPurchLineGlobal.MODIFY;
        PurchRcptLine."Purchase Route Reference" := LastRefNo;
        PurchRcptLine.MODIFY;
      END;

      PostProjInventory(PurchHeader,PurchLine,PurchRcptLine);
      PostNSItemTracking(PurchHeader,PurchLine,PurchRcptLine);

      IF (PurchHeader."Document Type" = PurchHeader."Document Type"::Order) AND
          (PurchHeader.Receive) AND
          (PurchLine."Cost Type" = PurchLine."Cost Type"::Material) AND
          (PurchLine."Job No." <> '') AND
          (PurchLine."Inward Processing Relief") AND
          (PurchRcptLine.Quantity > 0) THEN
        InwardProcessing(PurchLine,PurchRcptLine);

      NewPurchRcptLine := PurchRcptLine;
      //**4PS.en
    END;

    LOCAL PROCEDURE InsertReturnShipmentHeader@73(VAR PurchHeader@1000 : Record 38;VAR ReturnShptHeader@1001 : Record 6650);
    VAR
      PurchCommentLine@1002 : Record 43;
      RecordLinkManagement@1003 : Codeunit 447;
    BEGIN
      WITH PurchHeader DO BEGIN
        ReturnShptHeader.INIT;
        ReturnShptHeader.TRANSFERFIELDS(PurchHeader);
        ReturnShptHeader."No." := "Return Shipment No.";
        IF "Document Type" = "Document Type"::"Return Order" THEN BEGIN
          ReturnShptHeader."Return Order No. Series" := "No. Series";
          ReturnShptHeader."Return Order No." := "No.";
        END;
        ReturnShptHeader."No. Series" := "Return Shipment No. Series";
        ReturnShptHeader."No. Printed" := 0;
        ReturnShptHeader."Source Code" := SrcCode;
        ReturnShptHeader."User ID" := USERID;
        OnBeforeReturnShptHeaderInsert(ReturnShptHeader,PurchHeader,SuppressCommit);
        ReturnShptHeader.INSERT(TRUE);
        OnAfterReturnShptHeaderInsert(ReturnShptHeader,PurchHeader,SuppressCommit);

        ApprovalsMgmt.PostApprovalEntries(RECORDID,ReturnShptHeader.RECORDID,ReturnShptHeader."No.");
        //**4PS.sn C017601
        ApprovalsMgmt.PostApprovalCommentLines(RECORDID,ReturnShptHeader.RECORDID,ReturnShptHeader."No.");
        //**4PS.en
        IF PurchSetup."Copy Cmts Ret.Ord. to Ret.Shpt" THEN BEGIN
          PurchCommentLine.CopyComments(
            "Document Type",PurchCommentLine."Document Type"::"Posted Return Shipment","No.",ReturnShptHeader."No.");
          RecordLinkManagement.CopyLinks(PurchHeader,ReturnShptHeader);
        END;
        IF WhseShip THEN BEGIN
          WhseShptHeader.GET(TempWhseShptHeader."No.");
          OnBeforeCreatePostedWhseShptHeader(PostedWhseShptHeader,WhseShptHeader,PurchHeader);
          WhsePostShpt.CreatePostedShptHeader(PostedWhseShptHeader,WhseShptHeader,"Return Shipment No.","Posting Date");
        END;
        IF WhseReceive THEN BEGIN
          WhseRcptHeader.GET(TempWhseRcptHeader."No.");
          OnBeforeCreatePostedWhseRcptHeader(PostedWhseRcptHeader,WhseRcptHeader,PurchHeader);
          WhsePostRcpt.CreatePostedRcptHeader(PostedWhseRcptHeader,WhseRcptHeader,"Return Shipment No.","Posting Date");
        END;
      END;
    END;

    LOCAL PROCEDURE InsertReturnShipmentLine@145(ReturnShptHeader@1000 : Record 6650;PurchLine@1001 : Record 39;CostBaseAmount@1006 : Decimal);
    VAR
      ReturnShptLine@1005 : Record 6651;
      WhseRcptLine@1004 : Record 7317;
      WhseShptLine@1003 : Record 7321;
    BEGIN
      ReturnShptLine.InitFromPurchLine(ReturnShptHeader,xPurchLine);
      ReturnShptLine."Quantity Invoiced" := -RemQtyToBeInvoiced;
      ReturnShptLine."Qty. Invoiced (Base)" := -RemQtyToBeInvoicedBase;
      ReturnShptLine."Return Qty. Shipped Not Invd." := ReturnShptLine.Quantity - ReturnShptLine."Quantity Invoiced";

      IF (PurchLine.Type = PurchLine.Type::Item) AND (PurchLine."Return Qty. to Ship" <> 0) THEN BEGIN
        IF WhseShip THEN
          IF WhseShptLine.GetWhseShptLine(
               WhseShptHeader."No.",DATABASE::"Purchase Line",PurchLine."Document Type",PurchLine."Document No.",PurchLine."Line No.")
          THEN BEGIN
            WhseShptLine.TESTFIELD("Qty. to Ship",ReturnShptLine.Quantity);
            SaveTempWhseSplitSpec(PurchLine);
            WhsePostShpt.CreatePostedShptLine(
              WhseShptLine,PostedWhseShptHeader,PostedWhseShptLine,TempWhseSplitSpecification);
          END;
        IF WhseReceive THEN
          IF WhseRcptLine.GetWhseRcptLine(
               WhseRcptHeader."No.",DATABASE::"Purchase Line",PurchLine."Document Type",PurchLine."Document No.",PurchLine."Line No.")
          THEN BEGIN
            WhseRcptLine.TESTFIELD("Qty. to Receive",-ReturnShptLine.Quantity);
            SaveTempWhseSplitSpec(PurchLine);
            WhsePostRcpt.CreatePostedRcptLine(
              WhseRcptLine,PostedWhseRcptHeader,PostedWhseRcptLine,TempWhseSplitSpecification);
          END;

        ReturnShptLine."Item Shpt. Entry No." := InsertReturnEntryRelation(ReturnShptLine);
        ReturnShptLine."Item Charge Base Amount" := ROUND(CostBaseAmount / PurchLine.Quantity * ReturnShptLine.Quantity);
      END;
      OnBeforeReturnShptLineInsert(ReturnShptLine,ReturnShptHeader,PurchLine,SuppressCommit);
      ReturnShptLine.INSERT(TRUE);
      OnAfterReturnShptLineInsert(
        ReturnShptLine,ReturnShptHeader,PurchLine,ItemLedgShptEntryNo,WhseShip,WhseReceive,SuppressCommit,
        TempWhseShptHeader,PurchCrMemoHeader);

      CheckCertificateOfSupplyStatus(ReturnShptHeader,ReturnShptLine);
    END;

    LOCAL PROCEDURE InsertInvoiceHeader@87(VAR PurchHeader@1000 : Record 38;VAR PurchInvHeader@1001 : Record 122);
    VAR
      PurchCommentLine@1002 : Record 43;
      RecordLinkManagement@1003 : Codeunit 447;
      PurchLine@1100525000 : Record 39;
    BEGIN
      WITH PurchHeader DO BEGIN
        //>>NAVSE
        InwRegHeader.SETRANGE("Document Type","Document Type");
        InwRegHeader.SETRANGE("Document No.","No.");
        InwRegHeader.SETRANGE(Status,InwRegHeader.Status::Posted);
        IF InwRegHeader.FINDFIRST THEN BEGIN
          InwRegReverse.SetPostingDate("Posting Date");
          InwRegReverse.RUN(InwRegHeader);
        END;
        //<<NAVSE
        PurchInvHeader.INIT;
        PurchInvHeader.TRANSFERFIELDS(PurchHeader);

        PurchInvHeader."No." := "Posting No.";
        //>>4PSSE, 170908
        PurchInvHeader."OCR No." := PurchHeader."OCR No.";
        //<<4PSSE

        IF "Document Type" = "Document Type"::Order THEN BEGIN
          PurchInvHeader."Pre-Assigned No. Series" := '';
          IF PreviewMode THEN
            PurchInvHeader."No." := '***'
          ELSE
            PurchInvHeader."Order No. Series" := "No. Series";
          PurchInvHeader."Order No." := "No.";
        END ELSE BEGIN
          IF "Posting No." = '' THEN
            PurchInvHeader."No." := "No.";
          PurchInvHeader."Pre-Assigned No. Series" := "No. Series";
          PurchInvHeader."Pre-Assigned No." := "No.";
        END;
        IF GUIALLOWED AND NOT HideProgressWindow THEN
          Window.UPDATE(1,STRSUBSTNO(InvoiceNoMsg,"Document Type","No.",PurchInvHeader."No."));

        PurchInvHeader."Creditor No." := "Creditor No.";
        PurchInvHeader."Payment Reference" := "Payment Reference";
        PurchInvHeader."Payment Method Code" := "Payment Method Code";
        PurchInvHeader."Source Code" := SrcCode;
        PurchInvHeader."User ID" := USERID;
        PurchInvHeader."No. Printed" := 0;
        // ExFlow
        IF "Document Type" = "Document Type"::Invoice THEN
          IF ExFlowSetupExists THEN
            ExFlowPurchPost.UpdateOrderNo(PurchInvHeader,PurchHeader);
        // ExFlow
        //**4PS.sn
        PurchInvHeader.Text := PurchaseHeaderExtension.Memo;
        PurchInvHeader."DMS Status" := PurchaseHeaderExtension."DMS Status"; // jhoek.060611
        PurchInvHeader."Invoice Approved" := TRUE; //call C-026335
        PurchInvHeader."Status (Approval)" := PurchInvHeader."Status (Approval)"::Released;
        IF (PurchHeader."Preregister WIP") AND (PurchSetup."Preregistration WIP Account" <> '') THEN BEGIN
          PurchLine.RESET;
          PurchLine.SETRANGE("Document Type","Document Type");
          PurchLine.SETRANGE("Document No.","No.");
          PurchLine.SETRANGE(Type, PurchLine.Type::"G/L Account");
          PurchLine.SETRANGE("No.", PurchSetup."Preregistration WIP Account");
          IF PurchLine.FINDFIRST THEN
            PurchInvHeader."Purchase Registration Account" := PurchSetup."Preregistration WIP Account"
          ELSE
            PurchInvHeader."Preregister WIP" := FALSE;
          PurchLine.RESET;
        END;
        IF "Document Type" = "Document Type"::Order THEN
          PurchInvHeader."Related Purch. Order No." := "No.";
        //**4PS.en
        CALCFIELDS("Message Type","Invoice Message");  //NAVFI
        PurchInvHeader."Message Type" := "Message Type";  //NAVFI
        PurchInvHeader."Invoice Message" := "Invoice Message";  //NAVFI
        OnBeforePurchInvHeaderInsert(PurchInvHeader,PurchHeader,SuppressCommit);
        PurchInvHeader.INSERT(TRUE);
        OnAfterPurchInvHeaderInsert(PurchInvHeader,PurchHeader);

        //**4PS.sn
        PurchaseHeaderExtension.CopyPurchExtensionToPostedExtension("Document Type","No.",PurchInvHeader."No.");

        IF ("Document Type" = "Document Type"::Invoice) THEN
          CopyAndDeleteSubcontractHours(0, 1, "No.", PurchInvHeader."No.");

        IF ("Vendor Invoice No." <> '') AND ("Document Type" = "Document Type"::Invoice) AND (PurchInvHeader."No." <> "No.") THEN
          CheckUpdateInvNoInInvoiceBBN("Vendor Invoice No.", "No.", PurchInvHeader."No.", FALSE);
        //**4PS.en

        ApprovalsMgmt.PostApprovalEntries(RECORDID,PurchInvHeader.RECORDID,PurchInvHeader."No.");
        //**4PS.sn
        ApprovalsMgmt.PostApprovalCommentLines(RECORDID,PurchInvHeader.RECORDID,PurchInvHeader."No.");
        //**4PS.en

        //IF PurchSetup."Copy Comments Order to Invoice" THEN BEGIN //**4PS.o
        //**4PS.sn
        IF PurchSetup."Copy Comments Order to Invoice" OR
          ("Document Type" = "Document Type"::Invoice) THEN BEGIN
        //**4PS.en
          PurchCommentLine.CopyComments(
            "Document Type",PurchCommentLine."Document Type"::"Posted Invoice","No.",PurchInvHeader."No.");
          RecordLinkManagement.CopyLinks(PurchHeader,PurchInvHeader);
        END;
      END;
    END;

    LOCAL PROCEDURE InsertCrMemoHeader@88(VAR PurchHeader@1000 : Record 38;VAR PurchCrMemoHdr@1001 : Record 124);
    VAR
      PurchCommentLine@1002 : Record 43;
      RecordLinkManagement@1003 : Codeunit 447;
    BEGIN
      WITH PurchHeader DO BEGIN
        PurchCrMemoHdr.INIT;
        PurchCrMemoHdr.TRANSFERFIELDS(PurchHeader);

        //>>4PSSE, 170908
        PurchCrMemoHdr."Payment Reference" := PurchHeader."Payment Reference";
        PurchCrMemoHdr.KID := PurchHeader.KID;
        PurchCrMemoHdr."OCR No." := PurchHeader."OCR No.";
        //<<4PSSE

        IF "Document Type" = "Document Type"::"Return Order" THEN BEGIN
          PurchCrMemoHdr."No." := "Posting No.";
          PurchCrMemoHdr."Pre-Assigned No. Series" := '';
          PurchCrMemoHdr."Return Order No. Series" := "No. Series";
          PurchCrMemoHdr."Return Order No." := "No.";
          IF GUIALLOWED AND NOT HideProgressWindow THEN
            Window.UPDATE(1,STRSUBSTNO(CreditMemoNoMsg,"Document Type","No.",PurchCrMemoHdr."No."));
        END ELSE BEGIN
          PurchCrMemoHdr."Pre-Assigned No. Series" := "No. Series";
          PurchCrMemoHdr."Pre-Assigned No." := "No.";
          IF "Posting No." <> '' THEN BEGIN
            PurchCrMemoHdr."No." := "Posting No.";
            IF GUIALLOWED AND NOT HideProgressWindow THEN
              Window.UPDATE(1,STRSUBSTNO(CreditMemoNoMsg,"Document Type","No.",PurchCrMemoHdr."No."));
          END;
        END;
        PurchCrMemoHdr."Source Code" := SrcCode;
        PurchCrMemoHdr."User ID" := USERID;
        PurchCrMemoHdr."No. Printed" := 0;

        //**4PS.sn
        PurchCrMemoHdr.Text := PurchaseHeaderExtension.Memo;
        PurchCrMemoHdr."DMS Status" := PurchaseHeaderExtension."DMS Status";
        PurchCrMemoHdr."Status (Approval)" := PurchCrMemoHdr."Status (Approval)"::Released;
        //**4PS.en

        OnBeforePurchCrMemoHeaderInsert(PurchCrMemoHdr,PurchHeader,SuppressCommit);
        PurchCrMemoHdr.INSERT(TRUE);
        OnAfterPurchCrMemoHeaderInsert(PurchCrMemoHdr,PurchHeader,SuppressCommit);

        //**4PS.sn
        IF ("Vendor Cr. Memo No." <> '') AND ("Document Type" = "Document Type"::Invoice) AND (PurchCrMemoHdr."No."<>"No.") THEN
          CheckUpdateInvNoInInvoiceBBN("Vendor Cr. Memo No.", "No.", PurchCrMemoHdr."No.", TRUE);
        //**4PS.en

        ApprovalsMgmt.PostApprovalEntries(RECORDID,PurchCrMemoHdr.RECORDID,PurchCrMemoHdr."No.");

        //**4PS.sn
        ApprovalsMgmt.PostApprovalCommentLines(RECORDID,PurchCrMemoHdr.RECORDID,PurchCrMemoHdr."No.");
        //**4PS.en

        //IF PurchSetup."Copy Cmts Ret.Ord. to Cr. Memo" THEN BEGIN //**4PS.o
        //**4PS.sn
        IF PurchSetup."Copy Cmts Ret.Ord. to Cr. Memo" OR
          ("Document Type" = "Document Type"::"Credit Memo") THEN BEGIN
        //**4PS.en
          PurchCommentLine.CopyComments(
            "Document Type",PurchCommentLine."Document Type"::"Posted Credit Memo","No.",PurchCrMemoHdr."No.");
          RecordLinkManagement.CopyLinks(PurchHeader,PurchCrMemoHdr);
        END;
      END;
    END;

    LOCAL PROCEDURE InsertSalesShptHeader@267(VAR SalesOrderHeader@1000 : Record 36;VAR PurchHeader@1001 : Record 38;VAR SalesShptHeader@1002 : Record 110);
    BEGIN
      WITH SalesShptHeader DO BEGIN
        INIT;
        TRANSFERFIELDS(SalesOrderHeader);
        "No." := SalesOrderHeader."Shipping No.";
        "Order No." := SalesOrderHeader."No.";
        "Posting Date" := PurchHeader."Posting Date";
        "Document Date" := PurchHeader."Document Date";
        "No. Printed" := 0;
        OnBeforeSalesShptHeaderInsert(SalesShptHeader,SalesOrderHeader,SuppressCommit);
        INSERT(TRUE);
        OnAfterSalesShptHeaderInsert(SalesShptHeader,SalesOrderHeader,SuppressCommit,PurchHeader);
      END;
    END;

    LOCAL PROCEDURE InsertSalesShptLine@261(SalesShptHeader@1000 : Record 110;SalesOrderLine@1001 : Record 37;DropShptPostBuffer@1002 : Record 223;VAR SalesShptLine@1003 : Record 111);
    BEGIN
      WITH SalesShptLine DO BEGIN
        INIT;
        TRANSFERFIELDS(SalesOrderLine);
        "Posting Date" := SalesShptHeader."Posting Date";
        "Document No." := SalesShptHeader."No.";
        Quantity := DropShptPostBuffer.Quantity;
        "Quantity (Base)" := DropShptPostBuffer."Quantity (Base)";
        "Quantity Invoiced" := 0;
        "Qty. Invoiced (Base)" := 0;
        "Order No." := SalesOrderLine."Document No.";
        "Order Line No." := SalesOrderLine."Line No.";
        "Qty. Shipped Not Invoiced" :=
          Quantity - "Quantity Invoiced";
        IF Quantity <> 0 THEN BEGIN
          "Item Shpt. Entry No." := DropShptPostBuffer."Item Shpt. Entry No.";
          "Item Charge Base Amount" := SalesOrderLine."Line Amount";
        END;
        OnBeforeSalesShptLineInsert(SalesShptLine,SalesShptHeader,SalesOrderLine,SuppressCommit,DropShptPostBuffer);
        INSERT;
        OnAfterSalesShptLineInsert(SalesShptLine,SalesShptHeader,SalesOrderLine,SuppressCommit,DropShptPostBuffer);
      END;
    END;

    LOCAL PROCEDURE GetSign@90(Value@1000 : Decimal) : Integer;
    BEGIN
      IF Value > 0 THEN
        EXIT(1);

      EXIT(-1);
    END;

    LOCAL PROCEDURE CheckICDocumentDuplicatePosting@65(PurchHeader@1000 : Record 38);
    VAR
      PurchHeader2@1001 : Record 38;
      ICInboxPurchHeader@1002 : Record 436;
      PurchInvHeader@1003 : Record 122;
      ConfirmManagement@1004 : Codeunit 27;
      IsHandled@1005 : Boolean;
    BEGIN
      IsHandled := FALSE;
      OnBeforeCheckICDocumentDuplicatePosting(PurchHeader,IsHandled);
      IF IsHandled THEN
        EXIT;

      WITH PurchHeader DO BEGIN
        IF NOT Invoice THEN
          EXIT;
        IF "IC Direction" = "IC Direction"::Outgoing THEN BEGIN
          PurchInvHeader.SETRANGE("Your Reference","No.");
          PurchInvHeader.SETRANGE("Buy-from Vendor No.","Buy-from Vendor No.");
          PurchInvHeader.SETRANGE("Pay-to Vendor No.","Pay-to Vendor No.");
          IF PurchInvHeader.FINDFIRST THEN
            IF NOT ConfirmManagement.ConfirmProcess(
                 STRSUBSTNO(PostedInvoiceDuplicateQst,PurchInvHeader."No.","No."),TRUE)
            THEN
              ERROR('');
        END;
        IF "IC Direction" = "IC Direction"::Incoming THEN BEGIN
          IF "Document Type" = "Document Type"::Order THEN BEGIN
            PurchHeader2.SETRANGE("Document Type","Document Type"::Invoice);
            PurchHeader2.SETRANGE("Vendor Order No.","Vendor Order No.");
            IF PurchHeader2.FINDFIRST THEN
              IF NOT ConfirmManagement.ConfirmProcess(
                   STRSUBSTNO(UnpostedInvoiceDuplicateQst,"No.",PurchHeader2."No."),TRUE)
              THEN
                ERROR('');
            ICInboxPurchHeader.SETRANGE("Document Type","Document Type"::Invoice);
            ICInboxPurchHeader.SETRANGE("Vendor Order No.","Vendor Order No.");
            IF ICInboxPurchHeader.FINDFIRST THEN
              IF NOT ConfirmManagement.ConfirmProcess(
                   STRSUBSTNO(InvoiceDuplicateInboxQst,"No.",ICInboxPurchHeader."No."),TRUE)
              THEN
                ERROR('');
            PurchInvHeader.SETRANGE("Vendor Order No.","Vendor Order No.");
            IF PurchInvHeader.FINDFIRST THEN
              IF NOT ConfirmManagement.ConfirmProcess(
                   STRSUBSTNO(PostedInvoiceDuplicateQst,PurchInvHeader."No.","No."),TRUE)
              THEN
                ERROR('');
          END;
          IF ("Document Type" = "Document Type"::Invoice) AND ("Vendor Order No." <> '') THEN BEGIN
            PurchHeader2.SETRANGE("Document Type","Document Type"::Order);
            PurchHeader2.SETRANGE("Vendor Order No.","Vendor Order No.");
            IF PurchHeader2.FINDFIRST THEN
              IF NOT ConfirmManagement.ConfirmProcess(
                   STRSUBSTNO(OrderFromSameTransactionQst,PurchHeader2."No.","No."),TRUE)
              THEN
                ERROR('');
            ICInboxPurchHeader.SETRANGE("Document Type","Document Type"::Order);
            ICInboxPurchHeader.SETRANGE("Vendor Order No.","Vendor Order No.");
            IF ICInboxPurchHeader.FINDFIRST THEN
              IF NOT ConfirmManagement.ConfirmProcess(
                   STRSUBSTNO(DocumentFromSameTransactionQst,"No.",ICInboxPurchHeader."No."),TRUE)
              THEN
                ERROR('');
            PurchInvHeader.SETRANGE("Vendor Order No.","Vendor Order No.");
            IF PurchInvHeader.FINDFIRST THEN
              IF NOT ConfirmManagement.ConfirmProcess(
                   STRSUBSTNO(PostedInvoiceFromSameTransactionQst,PurchInvHeader."No.","No."),TRUE)
              THEN
                ERROR('');
            IF "Your Reference" <> '' THEN BEGIN
              PurchInvHeader.RESET;
              PurchInvHeader.SETRANGE("Order No.","Your Reference");
              PurchInvHeader.SETRANGE("Buy-from Vendor No.","Buy-from Vendor No.");
              PurchInvHeader.SETRANGE("Pay-to Vendor No.","Pay-to Vendor No.");
              IF PurchInvHeader.FINDFIRST THEN
                IF NOT ConfirmManagement.ConfirmProcess(
                     STRSUBSTNO(PostedInvoiceFromSameTransactionQst,PurchInvHeader."No.","No."),TRUE)
                THEN
                  ERROR('');
            END;
          END;
        END;
      END;
    END;

    LOCAL PROCEDURE CheckICPartnerBlocked@70(PurchHeader@1000 : Record 38);
    VAR
      ICPartner@1001 : Record 413;
    BEGIN
      WITH PurchHeader DO BEGIN
        IF "Buy-from IC Partner Code" <> '' THEN
          IF ICPartner.GET("Buy-from IC Partner Code") THEN
            ICPartner.TESTFIELD(Blocked,FALSE);
        IF "Pay-to IC Partner Code" <> '' THEN
          IF ICPartner.GET("Pay-to IC Partner Code") THEN
            ICPartner.TESTFIELD(Blocked,FALSE);
      END;
    END;

    LOCAL PROCEDURE SendICDocument@77(VAR PurchHeader@1000 : Record 38;VAR ModifyHeader@1002 : Boolean);
    VAR
      ICInboxOutboxMgt@1001 : Codeunit 427;
      IsHandled@1003 : Boolean;
    BEGIN
      OnBeforeSendICDocument(PurchHeader,ModifyHeader,IsHandled);
      IF IsHandled THEN
        EXIT;

      WITH PurchHeader DO
        IF "Send IC Document" AND ("IC Status" = "IC Status"::New) AND ("IC Direction" = "IC Direction"::Outgoing) AND
           ("Document Type" IN ["Document Type"::Order,"Document Type"::"Return Order"])
        THEN BEGIN
          ICInboxOutboxMgt.SendPurchDoc(PurchHeader,TRUE);
          "IC Status" := "IC Status"::Pending;
          ModifyHeader := TRUE;
        END;
    END;

    LOCAL PROCEDURE UpdateHandledICInboxTransaction@100(PurchHeader@1000 : Record 38);
    VAR
      HandledICInboxTrans@1001 : Record 420;
      Vendor@1002 : Record 23;
      IsHandled@1003 : Boolean;
    BEGIN
      OnBeforeUpdateHandledICInboxTransaction(PurchHeader,IsHandled);
      IF IsHandled THEN
        EXIT;

      WITH PurchHeader DO
        IF "IC Direction" = "IC Direction"::Incoming THEN BEGIN
          CASE "Document Type" OF
            "Document Type"::Invoice:
              HandledICInboxTrans.SETRANGE("Document No.","Vendor Invoice No.");
            "Document Type"::Order:
              HandledICInboxTrans.SETRANGE("Document No.","Vendor Order No.");
            "Document Type"::"Credit Memo":
              HandledICInboxTrans.SETRANGE("Document No.","Vendor Cr. Memo No.");
            "Document Type"::"Return Order":
              HandledICInboxTrans.SETRANGE("Document No.","Vendor Order No.");
          END;
          Vendor.GET("Buy-from Vendor No.");
          HandledICInboxTrans.SETRANGE("IC Partner Code",Vendor."IC Partner Code");
          HandledICInboxTrans.LOCKTABLE;
          IF HandledICInboxTrans.FINDFIRST THEN BEGIN
            HandledICInboxTrans.Status := HandledICInboxTrans.Status::Posted;
            HandledICInboxTrans.MODIFY;
          END;
        END;
    END;

    LOCAL PROCEDURE MakeInventoryAdjustment@72();
    VAR
      InvtSetup@1001 : Record 313;
      InvtAdjmt@1002 : Codeunit 5895;
    BEGIN
      InvtSetup.GET;
      IF InvtSetup."Automatic Cost Adjustment" <>
         InvtSetup."Automatic Cost Adjustment"::Never
      THEN BEGIN
        InvtAdjmt.SetProperties(TRUE,InvtSetup."Automatic Cost Posting");
        InvtAdjmt.SetJobUpdateProperties(FALSE);
        InvtAdjmt.MakeMultiLevelAdjmt;
      END;
    END;

    LOCAL PROCEDURE CheckTrackingAndWarehouseForReceive@19(PurchHeader@1000 : Record 38) Receive : Boolean;
    VAR
      TempPurchLine@1002 : TEMPORARY Record 39;
    BEGIN
      WITH TempPurchLine DO BEGIN
        ResetTempLines(TempPurchLine);
        //**4PS.sn
        PutPromisedReceiveDateFilter(TempPurchLine);
        PutReceiveMarkedOnlyFilter(TempPurchLine); //**4PS.n DP00556
        IF PurchHeader."Agreed Amount" <> 0 THEN BEGIN
          "Document Type" := PurchHeader."Document Type";
          "Document No." := PurchHeader."No.";
          CALCFIELDS("Balance Excl. VAT");
          IF PurchHeader."Agreed Amount" <> "Balance Excl. VAT" THEN
            PurchHeader.FIELDERROR("Agreed Amount",STRSUBSTNO(Text11012004,PurchHeader."Agreed Amount","Balance Excl. VAT"));
        END;
        IF PurchHeader."Amounts only" THEN
          SETFILTER("Line Amount",'<>0')
        ELSE
        //**4PS.en
          SETFILTER(Quantity,'<>0');
        IF PurchHeader."Document Type" = PurchHeader."Document Type"::Order THEN
          //**4PS.sn
          IF PurchHeader."Amounts only" THEN
            SETFILTER("Amnt. to Receive",'<>0')
          ELSE
          //**4PS.en
            SETFILTER("Qty. to Receive",'<>0');
        SETRANGE("Receipt No.",'');
        Receive := FINDFIRST;
        WhseReceive := TempWhseRcptHeader.FINDFIRST;
        WhseShip := TempWhseShptHeader.FINDFIRST;
        IF Receive THEN BEGIN
          CheckTrackingSpecification(PurchHeader,TempPurchLine);
          //**4PS.sn
          CheckReasonCodeFGases(TempPurchLine);
          CheckPostingReceiptAllowed(TempPurchLine); //DP00904
          //**4PS.en
          IF NOT (WhseReceive OR WhseShip OR InvtPickPutaway) THEN
            CheckWarehouse(TempPurchLine);
        END;
        OnAfterCheckTrackingAndWarehouseForReceive(
          PurchHeader,Receive,SuppressCommit,TempWhseShptHeader,TempWhseRcptHeader,TempPurchLine);
        EXIT(Receive);
      END;
    END;

    LOCAL PROCEDURE CheckTrackingAndWarehouseForShip@132(PurchHeader@1000 : Record 38) Ship : Boolean;
    VAR
      TempPurchLine@1002 : TEMPORARY Record 39;
    BEGIN
      WITH TempPurchLine DO BEGIN
        ResetTempLines(TempPurchLine);
        //**4PS.sn
        PutPromisedReceiveDateFilter(TempPurchLine);
        PutReceiveMarkedOnlyFilter(TempPurchLine); //DP00556
        //**4PS.en
        SETFILTER(Quantity,'<>0');
        SETFILTER("Return Qty. to Ship",'<>0');
        SETRANGE("Return Shipment No.",'');
        Ship := FINDFIRST;
        WhseReceive := TempWhseRcptHeader.FINDFIRST;
        WhseShip := TempWhseShptHeader.FINDFIRST;
        IF Ship THEN BEGIN
          CheckTrackingSpecification(PurchHeader,TempPurchLine);
          CheckReasonCodeFGases(TempPurchLine); //**4PS.n
          IF NOT (WhseShip OR WhseReceive OR InvtPickPutaway) THEN
            CheckWarehouse(TempPurchLine);
        END;
        OnAfterCheckTrackingAndWarehouseForShip(PurchHeader,Ship,SuppressCommit);
        EXIT(Ship);
      END;
    END;

    LOCAL PROCEDURE CheckIfInvPutawayExists@237(PurchaseHeader@1002 : Record 38) : Boolean;
    VAR
      TempPurchLine@1000 : TEMPORARY Record 39;
      WarehouseActivityLine@1001 : Record 5767;
    BEGIN
      WITH TempPurchLine DO BEGIN
        ResetTempLines(TempPurchLine);
        SETFILTER(Quantity,'<>0');
        IF PurchaseHeader."Document Type" = PurchaseHeader."Document Type"::Order THEN
          SETFILTER("Qty. to Receive",'<>0');
        SETRANGE("Receipt No.",'');
        IF ISEMPTY THEN
          EXIT(FALSE);
        FINDSET;
        REPEAT
          IF WarehouseActivityLine.ActivityExists(
               DATABASE::"Purchase Line","Document Type","Document No.","Line No.",0,
               WarehouseActivityLine."Activity Type"::"Invt. Put-away")
          THEN
            EXIT(TRUE);
        UNTIL NEXT = 0;
        EXIT(FALSE);
      END;
    END;

    LOCAL PROCEDURE CheckIfInvPickExists@236() : Boolean;
    VAR
      TempPurchLine@1000 : TEMPORARY Record 39;
      WarehouseActivityLine@1001 : Record 5767;
    BEGIN
      WITH TempPurchLine DO BEGIN
        ResetTempLines(TempPurchLine);
        SETFILTER(Quantity,'<>0');
        SETFILTER("Return Qty. to Ship",'<>0');
        SETRANGE("Return Shipment No.",'');
        IF ISEMPTY THEN
          EXIT(FALSE);
        FINDSET;
        REPEAT
          IF WarehouseActivityLine.ActivityExists(
               DATABASE::"Purchase Line","Document Type","Document No.","Line No.",0,
               WarehouseActivityLine."Activity Type"::"Invt. Pick")
          THEN
            EXIT(TRUE);
        UNTIL NEXT = 0;
        EXIT(FALSE);
      END;
    END;

    LOCAL PROCEDURE CheckAssociatedOrderLines@120(PurchHeader@1000 : Record 38);
    VAR
      PurchLine@1001 : Record 39;
      SalesHeader@1004 : Record 36;
      SalesOrderLine@1002 : Record 37;
      TempSalesHeader@1006 : TEMPORARY Record 36;
      TempSalesLine@1003 : TEMPORARY Record 37;
      CheckDimensions@1005 : Codeunit 481;
      IsHandled@1007 : Boolean;
    BEGIN
      WITH PurchHeader DO BEGIN
        PurchLine.RESET;
        PurchLine.SETRANGE("Document Type","Document Type");
        PurchLine.SETRANGE("Document No.","No.");
        //**4PS.sn
        PutPromisedReceiveDateFilter(PurchLine);
        PutReceiveMarkedOnlyFilter(PurchLine); //DP00556
        //**4PS.en
        PurchLine.SETFILTER("Sales Order Line No.",'<>0');
        IF PurchLine.FINDSET THEN
          REPEAT
            SalesOrderLine.GET(
              SalesOrderLine."Document Type"::Order,PurchLine."Sales Order No.",PurchLine."Sales Order Line No.");
            TempSalesLine := SalesOrderLine;
            TempSalesLine.INSERT;
            IF Invoice THEN BEGIN
              IF Receive AND (PurchLine."Qty. to Invoice" <> 0) AND (PurchLine."Qty. to Receive" <> 0) THEN
                ERROR(DropShipmentErr);
              IF ABS(PurchLine."Quantity Received" - PurchLine."Quantity Invoiced") < ABS(PurchLine."Qty. to Invoice")
              THEN BEGIN
                PurchLine."Qty. to Invoice" := PurchLine."Quantity Received" - PurchLine."Quantity Invoiced";
                PurchLine."Qty. to Invoice (Base)" := PurchLine."Qty. Received (Base)" - PurchLine."Qty. Invoiced (Base)";
              END;
              IsHandled := FALSE;
              OnCheckAssocOrderLinesOnBeforeCheckOrderLine(PurchHeader,PurchLine,IsHandled);
              IF NOT IsHandled THEN
                IF ABS(PurchLine.Quantity - (PurchLine."Qty. to Invoice" + PurchLine."Quantity Invoiced")) <
                   ABS(SalesOrderLine.Quantity - SalesOrderLine."Quantity Invoiced")
                THEN
                  ERROR(CannotInvoiceBeforeAssocSalesOrderErr,PurchLine."Sales Order No.");
            END;

            TempSalesHeader."Document Type" := TempSalesHeader."Document Type"::Order;
            TempSalesHeader."No." := PurchLine."Sales Order No.";
            IF TempSalesHeader.INSERT THEN;
          UNTIL PurchLine.NEXT = 0;
      END;

      IF TempSalesHeader.FINDSET THEN
        REPEAT
          SalesHeader.GET(TempSalesHeader."Document Type"::Order,TempSalesHeader."No.");
          TempSalesLine.SETRANGE("Document No.",SalesHeader."No.");
          CheckDimensions.CheckSalesDim(SalesHeader,TempSalesLine);
        UNTIL TempSalesHeader.NEXT = 0;
    END;

    LOCAL PROCEDURE PostCombineSalesOrderShipment@76(VAR PurchHeader@1001 : Record 38;VAR TempDropShptPostBuffer@1004 : TEMPORARY Record 223);
    VAR
      SalesSetup@1000 : Record 311;
      SalesCommentLine@1002 : Record 44;
      SalesOrderHeader@1006 : Record 36;
      SalesOrderLine@1005 : Record 37;
      SalesShptLine@1007 : Record 111;
      RecordLinkManagement@1003 : Codeunit 447;
    BEGIN
      OnBeforePostCombineSalesOrderShipment(PurchHeader,TempDropShptPostBuffer);

      ArchiveSalesOrders(TempDropShptPostBuffer);
      WITH PurchHeader DO
        IF TempDropShptPostBuffer.FINDSET THEN BEGIN
          SalesSetup.GET;
          REPEAT
            SalesOrderHeader.GET(SalesOrderHeader."Document Type"::Order,TempDropShptPostBuffer."Order No.");
            InsertSalesShptHeader(SalesOrderHeader,PurchHeader,SalesShptHeader);
            ApprovalsMgmt.PostApprovalEntries(RECORDID,SalesShptHeader.RECORDID,SalesShptHeader."No.");

            //**4PS.sn
            ApprovalsMgmt.PostApprovalCommentLines(RECORDID,SalesShptHeader.RECORDID,SalesShptHeader."No.");
            //**4PS.en
            IF SalesSetup."Copy Comments Order to Shpt." THEN BEGIN
              SalesCommentLine.CopyComments(
                SalesOrderHeader."Document Type",SalesCommentLine."Document Type"::Shipment,
                SalesOrderHeader."No.",SalesShptHeader."No.");
              RecordLinkManagement.CopyLinks(SalesOrderHeader,SalesShptHeader);
            END;
            TempDropShptPostBuffer.SETRANGE("Order No.",TempDropShptPostBuffer."Order No.");
            REPEAT
              SalesOrderLine.GET(
                SalesOrderLine."Document Type"::Order,
                TempDropShptPostBuffer."Order No.",TempDropShptPostBuffer."Order Line No.");
              InsertSalesShptLine(SalesShptHeader,SalesOrderLine,TempDropShptPostBuffer,SalesShptLine);
              CheckSalesCertificateOfSupplyStatus(SalesShptHeader,SalesShptLine);

              SalesOrderLine."Qty. to Ship" := SalesShptLine.Quantity;
              SalesOrderLine."Qty. to Ship (Base)" := SalesShptLine."Quantity (Base)";
              ServItemMgt.CreateServItemOnSalesLineShpt(SalesOrderHeader,SalesOrderLine,SalesShptLine);
              SalesPost.UpdateBlanketOrderLine(SalesOrderLine,TRUE,FALSE,FALSE);

              SalesOrderLine.SETRANGE("Document Type",SalesOrderLine."Document Type"::Order);
              SalesOrderLine.SETRANGE("Document No.",TempDropShptPostBuffer."Order No.");
              SalesOrderLine.SETRANGE("Attached to Line No.",TempDropShptPostBuffer."Order Line No.");
              SalesOrderLine.SETRANGE(Type,SalesOrderLine.Type::" ");
              IF SalesOrderLine.FINDSET THEN
                REPEAT
                  SalesShptLine.INIT;
                  SalesShptLine.TRANSFERFIELDS(SalesOrderLine);
                  SalesShptLine."Document No." := SalesShptHeader."No.";
                  SalesShptLine."Order No." := SalesOrderLine."Document No.";
                  SalesShptLine."Order Line No." := SalesOrderLine."Line No.";
                  OnBeforeSalesShptLineInsert(SalesShptLine,SalesShptHeader,SalesOrderLine,SuppressCommit,TempDropShptPostBuffer);
                  SalesShptLine.INSERT;
                  OnAfterSalesShptLineInsert(SalesShptLine,SalesShptHeader,SalesOrderLine,SuppressCommit,TempDropShptPostBuffer);
                UNTIL SalesOrderLine.NEXT = 0;
            UNTIL TempDropShptPostBuffer.NEXT = 0;
            TempDropShptPostBuffer.SETRANGE("Order No.");
            OnAfterInsertCombinedSalesShipment(SalesShptHeader);
          UNTIL TempDropShptPostBuffer.NEXT = 0;
        END;
    END;

    LOCAL PROCEDURE PostInvoicePostBufferLine@92(VAR PurchHeader@1000 : Record 38;InvoicePostBuffer@1001 : Record 49) GLEntryNo : Integer;
    VAR
      GenJnlLine@1002 : Record 81;
    BEGIN
      WITH GenJnlLine DO BEGIN
        InitNewLine(
          PurchHeader."Posting Date",PurchHeader."Document Date",PurchHeader."Posting Description",
          InvoicePostBuffer."Global Dimension 1 Code",InvoicePostBuffer."Global Dimension 2 Code",
          InvoicePostBuffer."Dimension Set ID",PurchHeader."Reason Code");

        CopyDocumentFields(GenJnlLineDocType,GenJnlLineDocNo,GenJnlLineExtDocNo,SrcCode,'');
        CopyFromPurchHeader(PurchHeader);
        CopyFromInvoicePostBuffer(InvoicePostBuffer);


        //**4PS.sn DP01406
        IF PurchHeader."Document Type" IN [PurchHeader."Document Type"::Invoice,PurchHeader."Document Type"::"Credit Memo"] THEN BEGIN
          IF (InvoicePostBuffer."Generated Retention Line") OR
             (InvoicePostBuffer."Applies-to Retention ID" <> 0) THEN
          BEGIN
            "Sell-to/Buy-from No." := PurchHeader."Buy-from Vendor No.";
            "Retention Entry Type" := "Retention Entry Type"::Purchase;
            "Source No." := PurchHeader."Buy-from Vendor No.";
            IF InvoicePostBuffer."Generated Retention Line" THEN BEGIN
              IF PurchHeader."Document Type" = PurchHeader."Document Type"::Invoice THEN
                "Retention Entry Document Type" := "Retention Entry Document Type"::Invoice
              ELSE
                "Retention Entry Document Type" := "Retention Entry Document Type"::"Credit Memo";
            END ELSE BEGIN
              "Retention Entry Document Type" := "Retention Entry Document Type"::Closure;
              "Applies-to Retention ID" := InvoicePostBuffer."Applies-to Retention ID";
              "Skip WIP Check" := TRUE;
            END;
            "Subcontract No." := PurchHeader."Subcontract No.";
            "Closed Project No." := PurchHeader."Job No.";
          END;
        END;
        //**4PS.en

        IF InvoicePostBuffer.Type <> InvoicePostBuffer.Type::"Prepmt. Exch. Rate Difference" THEN
          "Gen. Posting Type" := "Gen. Posting Type"::Purchase;
        IF InvoicePostBuffer.Type = InvoicePostBuffer.Type::"Fixed Asset" THEN BEGIN
          CASE InvoicePostBuffer."FA Posting Type" OF
            InvoicePostBuffer."FA Posting Type"::"Acquisition Cost":
              "FA Posting Type" := "FA Posting Type"::"Acquisition Cost";
            InvoicePostBuffer."FA Posting Type"::Maintenance:
              "FA Posting Type" := "FA Posting Type"::Maintenance;
            InvoicePostBuffer."FA Posting Type"::Appreciation:
              "FA Posting Type" := "FA Posting Type"::Appreciation;
          END;
          CopyFromInvoicePostBufferFA(InvoicePostBuffer);
        END;

        OnBeforePostInvPostBuffer(GenJnlLine,InvoicePostBuffer,PurchHeader,GenJnlPostLine,PreviewMode,SuppressCommit);
        GLEntryNo := RunGenJnlPostLine(GenJnlLine);
        OnAfterPostInvPostBuffer(GenJnlLine,InvoicePostBuffer,PurchHeader,GLEntryNo,SuppressCommit,GenJnlPostLine);
      END;
    END;

    LOCAL PROCEDURE FindTempItemChargeAssgntPurch@96(PurchLineNo@1000 : Integer) : Boolean;
    BEGIN
      ClearItemChargeAssgntFilter;
      TempItemChargeAssgntPurch.SETCURRENTKEY("Applies-to Doc. Type");
      TempItemChargeAssgntPurch.SETRANGE("Document Line No.",PurchLineNo);
      EXIT(TempItemChargeAssgntPurch.FINDSET);
    END;

    LOCAL PROCEDURE FillDeferralPostingBuffer@123(PurchHeader@1008 : Record 38;PurchLine@1000 : Record 39;InvoicePostBuffer@1009 : Record 49;RemainAmtToDefer@1001 : Decimal;RemainAmtToDeferACY@1002 : Decimal;DeferralAccount@1003 : Code[20];PurchAccount@1004 : Code[20]);
    VAR
      DeferralTemplate@1007 : Record 1700;
    BEGIN
      IF PurchLine."Deferral Code" <> '' THEN BEGIN
        DeferralTemplate.GET(PurchLine."Deferral Code");

        IF TempDeferralHeader.GET(DeferralUtilities.GetPurchDeferralDocType,'','',
             PurchLine."Document Type",PurchLine."Document No.",PurchLine."Line No.")
        THEN BEGIN
          IF TempDeferralHeader."Amount to Defer" <> 0 THEN BEGIN
            DeferralUtilities.FilterDeferralLines(
              TempDeferralLine,DeferralUtilities.GetPurchDeferralDocType,'','',
              PurchLine."Document Type",PurchLine."Document No.",PurchLine."Line No.");
            // Remainder\Initial deferral pair
            DeferralPostBuffer.PreparePurch(PurchLine,GenJnlLineDocNo);
            DeferralPostBuffer."Posting Date" := PurchHeader."Posting Date";
            DeferralPostBuffer.Description := PurchHeader."Posting Description";
            DeferralPostBuffer."Period Description" := DeferralTemplate."Period Description";
            DeferralPostBuffer."Deferral Line No." := InvDefLineNo;
            DeferralPostBuffer.PrepareInitialPair(
              InvoicePostBuffer,RemainAmtToDefer,RemainAmtToDeferACY,PurchAccount,DeferralAccount);
            DeferralPostBuffer.Update(DeferralPostBuffer,InvoicePostBuffer);
            IF (RemainAmtToDefer <> 0) OR (RemainAmtToDeferACY <> 0) THEN BEGIN
              DeferralPostBuffer.PrepareRemainderPurchase(
                PurchLine,RemainAmtToDefer,RemainAmtToDeferACY,PurchAccount,DeferralAccount,InvDefLineNo);
              DeferralPostBuffer.Update(DeferralPostBuffer,InvoicePostBuffer);
            END;

            // Add the deferral lines for each period to the deferral posting buffer merging when they are the same
            IF TempDeferralLine.FINDSET THEN
              REPEAT
                IF (TempDeferralLine."Amount (LCY)" <> 0) OR (TempDeferralLine.Amount <> 0) THEN BEGIN
                  DeferralPostBuffer.PreparePurch(PurchLine,GenJnlLineDocNo);
                  DeferralPostBuffer.InitFromDeferralLine(TempDeferralLine);
                  IF PurchLine.IsCreditDocType THEN
                    DeferralPostBuffer.ReverseAmounts;
                  DeferralPostBuffer."G/L Account" := PurchAccount;
                  DeferralPostBuffer."Deferral Account" := DeferralAccount;
                  DeferralPostBuffer."Period Description" := DeferralTemplate."Period Description";
                  DeferralPostBuffer."Deferral Line No." := InvDefLineNo;
                  DeferralPostBuffer.Update(DeferralPostBuffer,InvoicePostBuffer);
                END ELSE
                  ERROR(ZeroDeferralAmtErr,PurchLine."No.",PurchLine."Deferral Code");

              UNTIL TempDeferralLine.NEXT = 0

            ELSE
              ERROR(NoDeferralScheduleErr,PurchLine."No.",PurchLine."Deferral Code");
          END ELSE
            ERROR(NoDeferralScheduleErr,PurchLine."No.",PurchLine."Deferral Code")
        END ELSE
          ERROR(NoDeferralScheduleErr,PurchLine."No.",PurchLine."Deferral Code")
      END;
    END;

    LOCAL PROCEDURE RoundDeferralsForArchive@126(PurchHeader@1000 : Record 38;VAR PurchLine@1001 : Record 39);
    VAR
      ArchiveManagement@1005 : Codeunit 5063;
    BEGIN
      ArchiveManagement.RoundPurchaseDeferralsForArchive(PurchHeader,PurchLine);
    END;

    LOCAL PROCEDURE GetAmountsForDeferral@127(PurchLine@1001 : Record 39;VAR AmtToDefer@1002 : Decimal;VAR AmtToDeferACY@1003 : Decimal;VAR DeferralAccount@1004 : Code[20]);
    VAR
      DeferralTemplate@1005 : Record 1700;
    BEGIN
      IF PurchLine."Deferral Code" <> '' THEN BEGIN
        DeferralTemplate.GET(PurchLine."Deferral Code");
        DeferralTemplate.TESTFIELD("Deferral Account");
        DeferralAccount := DeferralTemplate."Deferral Account";

        IF TempDeferralHeader.GET(DeferralUtilities.GetPurchDeferralDocType,'','',
             PurchLine."Document Type",PurchLine."Document No.",PurchLine."Line No.")
        THEN BEGIN
          AmtToDeferACY := TempDeferralHeader."Amount to Defer";
          AmtToDefer := TempDeferralHeader."Amount to Defer (LCY)";
        END;

        IF PurchLine.IsCreditDocType THEN BEGIN
          AmtToDefer := -AmtToDefer;
          AmtToDeferACY := -AmtToDeferACY;
        END
      END ELSE BEGIN
        AmtToDefer := 0;
        AmtToDeferACY := 0;
        DeferralAccount := '';
      END;
    END;

    LOCAL PROCEDURE CheckMandatoryHeaderFields@128(VAR PurchHeader@1000 : Record 38);
    BEGIN
      PurchHeader.TESTFIELD("Document Type");
      PurchHeader.TESTFIELD("Buy-from Vendor No.");
      PurchHeader.TESTFIELD("Pay-to Vendor No.");
      PurchHeader.TESTFIELD("Posting Date");
      PurchHeader.TESTFIELD("Document Date");

      OnAfterCheckMandatoryFields(PurchHeader,SuppressCommit);
    END;

    LOCAL PROCEDURE InitVATAmounts@111(PurchLine@1002 : Record 39;VAR TotalVAT@1000 : Decimal;VAR TotalVATACY@1001 : Decimal;VAR TotalAmount@1003 : Decimal;VAR TotalAmountACY@1004 : Decimal);
    BEGIN
      TotalVAT := PurchLine."Amount Including VAT" - PurchLine.Amount;
      TotalVATACY := PurchLineACY."Amount Including VAT" - PurchLineACY.Amount;
      TotalAmount := PurchLine.Amount;
      TotalAmountACY := PurchLineACY.Amount;
    END;

    LOCAL PROCEDURE InitVATBase@212(PurchLine@1002 : Record 39;VAR TotalVATBase@1005 : Decimal;VAR TotalVATBaseACY@1006 : Decimal);
    BEGIN
      TotalVATBase := PurchLine."VAT Base Amount";
      TotalVATBaseACY := PurchLineACY."VAT Base Amount";
    END;

    LOCAL PROCEDURE InitAmounts@109(PurchLine@1005 : Record 39;VAR TotalVAT@1004 : Decimal;VAR TotalVATACY@1003 : Decimal;VAR TotalAmount@1002 : Decimal;VAR TotalAmountACY@1001 : Decimal;VAR AmtToDefer@1006 : Decimal;VAR AmtToDeferACY@1007 : Decimal;VAR DeferralAccount@1008 : Code[20]);
    BEGIN
      InitVATAmounts(PurchLine,TotalVAT,TotalVATACY,TotalAmount,TotalAmountACY);
      GetAmountsForDeferral(PurchLine,AmtToDefer,AmtToDeferACY,DeferralAccount);
    END;

    LOCAL PROCEDURE CalcInvoiceDiscountPosting@112(PurchHeader@1002 : Record 38;PurchLine@1001 : Record 39;PurchLineACY@1000 : Record 39;VAR InvoicePostBuffer@1003 : Record 49);
    BEGIN
      CASE PurchLine."VAT Calculation Type" OF
        PurchLine."VAT Calculation Type"::"Normal VAT",PurchLine."VAT Calculation Type"::"Full VAT":
          InvoicePostBuffer.CalcDiscount(
            PurchHeader."Prices Including VAT",-PurchLine."Inv. Discount Amount",-PurchLineACY."Inv. Discount Amount");
        PurchLine."VAT Calculation Type"::"Reverse Charge VAT":
          InvoicePostBuffer.CalcDiscountNoVAT(-PurchLine."Inv. Discount Amount",-PurchLineACY."Inv. Discount Amount");
        PurchLine."VAT Calculation Type"::"Sales Tax":
          IF NOT PurchLine."Use Tax" THEN // Use Tax is calculated later, based on totals
            InvoicePostBuffer.CalcDiscount(
              PurchHeader."Prices Including VAT",-PurchLine."Inv. Discount Amount",-PurchLineACY."Inv. Discount Amount")
          ELSE
            InvoicePostBuffer.CalcDiscountNoVAT(-PurchLine."Inv. Discount Amount",-PurchLineACY."Inv. Discount Amount");
      END;
    END;

    LOCAL PROCEDURE CalcLineDiscountPosting@110(PurchHeader@1002 : Record 38;PurchLine@1001 : Record 39;PurchLineACY@1000 : Record 39;VAR InvoicePostBuffer@1003 : Record 49);
    BEGIN
      CASE PurchLine."VAT Calculation Type" OF
        PurchLine."VAT Calculation Type"::"Normal VAT",PurchLine."VAT Calculation Type"::"Full VAT":
          InvoicePostBuffer.CalcDiscount(
            PurchHeader."Prices Including VAT",-PurchLine."Line Discount Amount",-PurchLineACY."Line Discount Amount");
        PurchLine."VAT Calculation Type"::"Reverse Charge VAT":
          InvoicePostBuffer.CalcDiscountNoVAT(-PurchLine."Line Discount Amount",-PurchLineACY."Line Discount Amount");
        PurchLine."VAT Calculation Type"::"Sales Tax":
          IF NOT PurchLine."Use Tax" THEN // Use Tax is calculated later, based on totals
            InvoicePostBuffer.CalcDiscount(
              PurchHeader."Prices Including VAT",-PurchLine."Line Discount Amount",-PurchLineACY."Line Discount Amount")
          ELSE
            InvoicePostBuffer.CalcDiscountNoVAT(-PurchLine."Line Discount Amount",-PurchLineACY."Line Discount Amount");
      END;
    END;

    LOCAL PROCEDURE ClearPostBuffers@113();
    BEGIN
      //**4PS.sn
      CLEAR(PostPlantEntry);
      CLEAR(LoanJnlPostLine);
      //**4PS.en
      CLEAR(WhsePostRcpt);
      CLEAR(WhsePostShpt);
      CLEAR(GenJnlPostLine);
      CLEAR(JobPostLine);
      CLEAR(ItemJnlPostLine);
      CLEAR(WhseJnlPostLine);
    END;

    LOCAL PROCEDURE ValidatePostingAndDocumentDate@119(VAR PurchaseHeader@1000 : Record 38);
    VAR
      BatchProcessingMgt@1002 : Codeunit 1380;
      BatchPostParameterTypes@1003 : Codeunit 1370;
      PostingDate@1007 : Date;
      ModifyHeader@1001 : Boolean;
      PostingDateExists@1006 : Boolean;
      ReplacePostingDate@1005 : Boolean;
      ReplaceDocumentDate@1004 : Boolean;
    BEGIN
      OnBeforeValidatePostingAndDocumentDate(PurchaseHeader,SuppressCommit);

      //**4PS.sn
      BatchProcessingMgt.GetParameterBoolean(
        PurchaseHeader.RECORDID,BatchPostParameterTypes.NoErrorNothingToPost,NoErrorNothingToPost);
      BatchProcessingMgt.GetParameterDate(
        PurchaseHeader.RECORDID,BatchPostParameterTypes.UpToPromisedReceiptDate,UptoPromisedReceiveDate);
      IF NoErrorNothingToPost THEN
        SetNoErrorNothingToPost(TRUE);
      //**4PS.en

      PostingDateExists :=
        BatchProcessingMgt.GetParameterBoolean(
          PurchaseHeader.RECORDID,BatchPostParameterTypes.ReplacePostingDate,ReplacePostingDate) AND
        BatchProcessingMgt.GetParameterBoolean(
          PurchaseHeader.RECORDID,BatchPostParameterTypes.ReplaceDocumentDate,ReplaceDocumentDate) AND
        BatchProcessingMgt.GetParameterDate(
          PurchaseHeader.RECORDID,BatchPostParameterTypes.PostingDate,PostingDate);

      IF PostingDateExists AND (ReplacePostingDate OR (PurchaseHeader."Posting Date" = 0D)) THEN BEGIN
        PurchaseHeader."Posting Date" := PostingDate;
        PurchaseHeader.VALIDATE("Currency Code");
        ModifyHeader := TRUE;
      END;

      IF PostingDateExists AND (ReplaceDocumentDate OR (PurchaseHeader."Document Date" = 0D)) THEN BEGIN
        PurchaseHeader.VALIDATE("Document Date",PostingDate);
        ModifyHeader := TRUE;
      END;

      IF ModifyHeader THEN
        PurchaseHeader.MODIFY;

      OnAfterValidatePostingAndDocumentDate(PurchaseHeader,SuppressCommit,PreviewMode);
    END;

    LOCAL PROCEDURE CheckExternalDocumentNumber@117(VAR VendLedgEntry@1001 : Record 25;VAR PurchaseHeader@1000 : Record 38);
    VAR
      VendorMgt@1003 : Codeunit 1312;
      Handled@1002 : Boolean;
      Vendor@1100583000 : Record 23;
    BEGIN
      OnBeforeCheckExternalDocumentNumber(VendLedgEntry,PurchaseHeader,Handled,GenJnlLineDocType,GenJnlLineExtDocNo);
      IF Handled THEN
        EXIT;
      // ExFlow
      Vendor.GET(PurchaseHeader."Pay-to Vendor No.");
      IF Vendor."Do not check Duplicate Invoice" THEN
        EXIT;
      // ExFlow

      VendLedgEntry.RESET;
      VendLedgEntry.SETCURRENTKEY("External Document No.");
      VendorMgt.SetFilterForExternalDocNo(
        VendLedgEntry,GenJnlLineDocType,GenJnlLineExtDocNo,PurchaseHeader."Pay-to Vendor No.",PurchaseHeader."Document Date");

      //**4PS.sn
      VendLedgEntry.SETRANGE("Document Date" ,CALCDATE('<-CY>',PurchaseHeader."Document Date"),CALCDATE('<CY>',PurchaseHeader."Document Date"));
      //**4PS.en

      IF VendLedgEntry.FINDFIRST THEN
        ERROR(
          PurchaseAlreadyExistsErr,VendLedgEntry."Document Type",GenJnlLineExtDocNo);
    END;

    LOCAL PROCEDURE PostInvoicePostingBuffer@141(PurchHeader@1002 : Record 38;VAR TempInvoicePostBuffer@1005 : TEMPORARY Record 49);
    VAR
      VATPostingSetup@1001 : Record 325;
      CurrExchRate@1003 : Record 330;
      LineCount@1000 : Integer;
      GLEntryNo@1004 : Integer;
      ExpenseAllowanceSchemeEntry@1100525000 : Record 11020683;
      Job@1100527300 : Record 11072003;
      VATIndicator@1100527301 : 'VAT,No VAT';
    BEGIN
      OnBeforePostInvoicePostBuffer(PurchHeader,TempInvoicePostBuffer,TotalPurchLine,TotalPurchLineLCY);

      LineCount := 0;
      IF TempInvoicePostBuffer.FIND('+') THEN
        REPEAT
          LineCount := LineCount + 1;
          IF GUIALLOWED AND NOT HideProgressWindow THEN
            Window.UPDATE(3,LineCount);
          //**4PS.sn
          IF (TempInvoicePostBuffer."Job No." <> '') AND Job.GET(TempInvoicePostBuffer."Job No.") THEN
            VATIndicator := Job."VAT Indicator (Purchase)"
          ELSE
            VATIndicator := PurchSetup."VAT Indicator (Purchase)";

          IF VATIndicator = VATIndicator::VAT THEN
          //**4PS.en
            CASE TempInvoicePostBuffer."VAT Calculation Type" OF
              TempInvoicePostBuffer."VAT Calculation Type"::"Reverse Charge VAT":
                BEGIN
                  VATPostingSetup.GET(
                    TempInvoicePostBuffer."VAT Bus. Posting Group",TempInvoicePostBuffer."VAT Prod. Posting Group");
                  OnPostInvoicePostingBufferOnAfterVATPostingSetupGet(VATPostingSetup);
                  TempInvoicePostBuffer."VAT Amount" :=
                    ROUND(
                      TempInvoicePostBuffer."VAT Base Amount" *
                      (1 - PurchHeader."VAT Base Discount %" / 100) * VATPostingSetup."VAT %" / 100);
                  TempInvoicePostBuffer."VAT Amount (ACY)" :=
                    ROUND(
                      TempInvoicePostBuffer."VAT Base Amount (ACY)" * (1 - PurchHeader."VAT Base Discount %" / 100) *
                      VATPostingSetup."VAT %" / 100,Currency."Amount Rounding Precision");
                END;
              TempInvoicePostBuffer."VAT Calculation Type"::"Sales Tax":
                IF TempInvoicePostBuffer."Use Tax" THEN BEGIN
                  TempInvoicePostBuffer."VAT Amount" :=
                    ROUND(
                      SalesTaxCalculate.CalculateTax(
                        TempInvoicePostBuffer."Tax Area Code",TempInvoicePostBuffer."Tax Group Code",
                        TempInvoicePostBuffer."Tax Liable",PurchHeader."Posting Date",
                        TempInvoicePostBuffer.Amount,TempInvoicePostBuffer.Quantity,0));
                  IF GLSetup."Additional Reporting Currency" <> '' THEN
                    TempInvoicePostBuffer."VAT Amount (ACY)" :=
                      CurrExchRate.ExchangeAmtLCYToFCY(
                        0, '', //**4PS.n
                        PurchHeader."Posting Date",GLSetup."Additional Reporting Currency",
                      //TempInvoicePostBuffer."VAT Amount",0); //**4PS.o
                        TempInvoicePostBuffer."VAT Amount",0,FALSE); //**4PS.n
                END;
            END;

          GLEntryNo := PostInvoicePostBufferLine(PurchHeader,TempInvoicePostBuffer);

          IF (TempInvoicePostBuffer."Job No." <> '') AND
             (TempInvoicePostBuffer.Type = TempInvoicePostBuffer.Type::"G/L Account")
          THEN
            JobPostLine.PostPurchaseGLAccounts(TempInvoicePostBuffer,GLEntryNo);

          //**4PS.sn
          IF TempInvoicePostBuffer."Expense Allowance Scheme" THEN BEGIN
            ExpenseAllowanceSchemeEntry."G/L Entry No." := GLEntryNo;
            IF ExpenseAllowanceSchemeEntry.INSERT THEN ;
          END;
          //**4PS.en

        UNTIL TempInvoicePostBuffer.NEXT(-1) = 0;

      TempInvoicePostBuffer.DELETEALL;
    END;

    LOCAL PROCEDURE PostItemTracking@144(PurchHeader@1000 : Record 38;PurchLine@1005 : Record 39;VAR TempTrackingSpecification@1004 : TEMPORARY Record 336;TrackingSpecificationExists@1002 : Boolean);
    VAR
      QtyToInvoiceBaseInTrackingSpec@1011 : Decimal;
    BEGIN
      WITH PurchHeader DO BEGIN
        IF TrackingSpecificationExists THEN BEGIN
          TempTrackingSpecification.CALCSUMS("Qty. to Invoice (Base)");
          QtyToInvoiceBaseInTrackingSpec := TempTrackingSpecification."Qty. to Invoice (Base)";
          IF NOT TempTrackingSpecification.FINDFIRST THEN
            TempTrackingSpecification.INIT;
        END;

      //IF IsCreditDocType THEN BEGIN //**4PS.o
        IF "Document Type" IN ["Document Type"::"Return Order"] THEN BEGIN  //**4PS.n
          IF (ABS(RemQtyToBeInvoiced) > ABS(PurchLine."Return Qty. to Ship")) OR
             (ABS(RemQtyToBeInvoiced) >= ABS(QtyToInvoiceBaseInTrackingSpec)) AND (QtyToInvoiceBaseInTrackingSpec <> 0)
          THEN
            PostItemTrackingForShipment(PurchHeader,PurchLine,TrackingSpecificationExists,TempTrackingSpecification);

          IF ABS(RemQtyToBeInvoiced) > ABS(PurchLine."Return Qty. to Ship") THEN BEGIN
            IF "Document Type" = "Document Type"::"Credit Memo" THEN
              ERROR(InvoiceGreaterThanReturnShipmentErr,ReturnShptHeader."No.");
            ERROR(ReturnShipmentLinesDeletedErr);
          END;
        END ELSE BEGIN
          //**4PS.so
          //IF (ABS(RemQtyToBeInvoiced) > ABS(PurchLine."Qty. to Receive")) OR
          //   (ABS(RemQtyToBeInvoiced) >= ABS(QtyToInvoiceBaseInTrackingSpec)) AND (QtyToInvoiceBaseInTrackingSpec <> 0)
          //**4PS.eo
          //**4PS.sn
          IF ("Amounts only" AND (ABS(RemAmntToBeInvoiced) > ABS(PurchLine."Amnt. to Receive"))) OR
             (NOT "Amounts only" AND ((ABS(RemQtyToBeInvoiced) > ABS(PurchLine."Qty. to Receive")) OR
             (ABS(RemQtyToBeInvoiced) >= ABS(QtyToInvoiceBaseInTrackingSpec)) AND (QtyToInvoiceBaseInTrackingSpec <> 0)))
          THEN
            PostItemTrackingForReceipt(PurchHeader,PurchLine,TrackingSpecificationExists,TempTrackingSpecification);


          //**4PS.so  Call: 5858  Quantity should be modifiable, independent of receive.
          //IF ABS(RemQtyToBeInvoiced) > ABS(PurchLine."Qty. to Receive") THEN BEGIN
          //  IF "Document Type" = "Document Type"::Invoice THEN
          //    ERROR(QuantityToInvoiceGreaterErr,PurchRcptHeader."No.");
          //  ERROR(ReceiptLinesDeletedErr);
          //END;
          //**4PS.eo
        END;
      END;
    END;

    LOCAL PROCEDURE PostItemTrackingForReceipt@281(PurchHeader@1003 : Record 38;PurchLine@1002 : Record 39;TrackingSpecificationExists@1001 : Boolean;VAR TempTrackingSpecification@1000 : TEMPORARY Record 336);
    VAR
      PurchRcptLine@1012 : Record 121;
      ItemEntryRelation@1010 : Record 6507;
      EndLoop@1009 : Boolean;
      RemQtyToInvoiceCurrLine@1008 : Decimal;
      RemQtyToInvoiceCurrLineBase@1007 : Decimal;
      QtyToBeInvoiced@1006 : Decimal;
      QtyToBeInvoicedBase@1005 : Decimal;
      PurchOrder@1100525002 : Record 38;
      PurchRcptHeader@1100525001 : Record 120;
      AmntToBeInvoiced@1100525000 : Decimal;
    BEGIN
      WITH PurchHeader DO BEGIN
        EndLoop := FALSE;
        PurchRcptLine.RESET;
        CASE "Document Type" OF
          "Document Type"::Order:
            BEGIN
              PurchRcptLine.SETCURRENTKEY("Order No.","Order Line No.");
              PurchRcptLine.SETRANGE("Order No.",PurchLine."Document No.");
              PurchRcptLine.SETRANGE("Order Line No.",PurchLine."Line No.");
            END;
          "Document Type"::"Credit Memo", //**4PS.n
          "Document Type"::Invoice:
            BEGIN
              PurchRcptLine.SETRANGE("Document No.",PurchLine."Receipt No.");
              PurchRcptLine.SETRANGE("Line No.",PurchLine."Receipt Line No.");
            END;
        END;

        //**4PS.sn
        IF ("Document Type" IN ["Document Type"::"Credit Memo"]) AND (NOT NegativeOrderQuantity) THEN BEGIN
          IF "Amounts only" THEN
            PurchRcptLine.SETFILTER(PurchRcptLine."Invoiced (line)",'<>0')
          ELSE
            PurchRcptLine.SETFILTER("Quantity Invoiced",'<>0');
        END ELSE
          IF "Amounts only" THEN
            PurchRcptLine.SETFILTER("Amnt. Rcd. Not Invoiced",'<>0')
          ELSE
        //**4PS.en
            PurchRcptLine.SETFILTER("Qty. Rcd. Not Invoiced",'<>0');

        //**4PS.sn
        PurchOrder.INIT;
        IF PurchLine."Receipt No." <> '' THEN
          IF PurchRcptHeader.GET(PurchLine."Receipt No.") THEN
            IF PurchRcptHeader."Order No." <> '' THEN
              IF PurchOrder.GET(PurchOrder."Document Type"::Order,PurchRcptHeader."Order No.") THEN;

        IF PurchOrder."Tolerate Exceeding Invoice Qu." THEN
          PurchRcptLine.SETRANGE("Qty. Rcd. Not Invoiced");
        //**4PS.en

        IF PurchRcptLine.FINDSET(TRUE,FALSE) THEN BEGIN
          ItemJnlRollRndg := TRUE;
          REPEAT
            IF TrackingSpecificationExists THEN BEGIN
              ItemEntryRelation.GET(TempTrackingSpecification."Item Ledger Entry No.");
              PurchRcptLine.GET(ItemEntryRelation."Source ID",ItemEntryRelation."Source Ref. No.");
            END ELSE
              ItemEntryRelation."Item Entry No." := PurchRcptLine."Item Rcpt. Entry No.";
            UpdateRemainingQtyToBeInvoiced(RemQtyToInvoiceCurrLine,RemQtyToInvoiceCurrLineBase,PurchRcptLine);
            PurchRcptLine.TESTFIELD("Buy-from Vendor No.",PurchLine."Buy-from Vendor No.");
            PurchRcptLine.TESTFIELD(Type,PurchLine.Type);
            //**4PS.so
            //PurchRcptLine.TESTFIELD("No.",PurchLine."No.");
            //PurchRcptLine.TESTFIELD("Gen. Bus. Posting Group",PurchLine."Gen. Bus. Posting Group");
            //PurchRcptLine.TESTFIELD("Gen. Prod. Posting Group",PurchLine."Gen. Prod. Posting Group");
            //**4PS.eo
            PurchRcptLine.TESTFIELD("Job No.",PurchLine."Job No.");
            PurchRcptLine.TESTFIELD("Unit of Measure Code",PurchLine."Unit of Measure Code");
            PurchRcptLine.TESTFIELD("Variant Code",PurchLine."Variant Code");
            PurchRcptLine.TESTFIELD("Prod. Order No.",PurchLine."Prod. Order No.");

            //**4PS.sn
            IF (PurchLine."Job No." <> '') AND
               (PurchLine."Shortcut Dimension 2 Code" <> '') AND
               (Project."Project Status" > Project."Project Status"::"Administrative Finished") AND
               (PurchRcptLine."No." <> PurchLine."No.") THEN
            BEGIN
              CASE PurchLine."Cost Type" OF
                PurchLine."Cost Type"::Labor:
                  PurchLine.TESTFIELD("No.",ProjectType."Provision Account Labor");
                PurchLine."Cost Type"::Material:
                  PurchLine.TESTFIELD("No.",ProjectType."Provision Account Material");
                PurchLine."Cost Type"::Subcontracting:
                  PurchLine.TESTFIELD("No.",ProjectType."Provision Account Subcontr.");
                PurchLine."Cost Type"::Plant:
                  PurchLine.TESTFIELD("No.",ProjectType."Provision Account Plant");
                PurchLine."Cost Type"::Sundry:
                  PurchLine.TESTFIELD("No.",ProjectType."Provision Account Sundry");
              ELSE
                PurchRcptLine.TESTFIELD("No.",PurchLine."No.");
              END;
            END ELSE
              PurchRcptLine.TESTFIELD("No.",PurchLine."No.");

            IF "Amounts only" THEN BEGIN
              IF "Document Type" = "Document Type"::Invoice THEN
                IF PurchLine."Amnt. to Invoice" * PurchRcptLine."Received (line)" < 0 THEN
                  PurchLine.FIELDERROR("Amnt. to Invoice",ReceiptSameSignErr);
              AmntToBeInvoiced := RemAmntToBeInvoiced - PurchLine."Amnt. to Receive";
              IF "Document Type" = "Document Type"::"Credit Memo" THEN BEGIN
                IF PurchRcptLine."Received (line)" < 0 THEN BEGIN
                  IF ABS(AmntToBeInvoiced) > ABS(PurchRcptLine."Received (line)" - PurchRcptLine."Invoiced (line)") THEN
                    AmntToBeInvoiced := -(PurchRcptLine."Received (line)" - PurchRcptLine."Invoiced (line)");
                END ELSE
                  IF ABS(AmntToBeInvoiced) > ABS(PurchRcptLine."Invoiced (line)") THEN
                    AmntToBeInvoiced := -PurchRcptLine."Invoiced (line)";
              END;
              RemAmntToBeInvoiced := RemAmntToBeInvoiced - AmntToBeInvoiced;
              PurchRcptLine."Invoiced (line)" := PurchRcptLine."Invoiced (line)" + AmntToBeInvoiced;
              PurchRcptLine."Amnt. Rcd. Not Invoiced" :=
                PurchRcptLine."Received (line)" - PurchRcptLine."Invoiced (line)";
            END ELSE BEGIN
            //**4PS.en

              UpdateQtyToBeInvoicedForReceipt(
                QtyToBeInvoiced,QtyToBeInvoicedBase,
                TrackingSpecificationExists,PurchLine,PurchRcptLine,TempTrackingSpecification);

              IF TrackingSpecificationExists THEN BEGIN
                TempTrackingSpecification."Quantity actual Handled (Base)" := QtyToBeInvoicedBase;
                TempTrackingSpecification.MODIFY;
              END;

              IF TrackingSpecificationExists THEN
                ItemTrackingMgt.AdjustQuantityRounding(
                  RemQtyToInvoiceCurrLine,QtyToBeInvoiced,RemQtyToInvoiceCurrLineBase,QtyToBeInvoicedBase);

              RemQtyToBeInvoiced := RemQtyToBeInvoiced - QtyToBeInvoiced;
              RemQtyToBeInvoicedBase := RemQtyToBeInvoicedBase - QtyToBeInvoicedBase;
            END; //**4PS.n

            //UpdateInvoicedQtyOnPurchRcptLine(PurchRcptLine,QtyToBeInvoiced,QtyToBeInvoicedBase); //**4PS.o
      //      UpdateInvoicedQtyOnPurchRcptLine(PurchRcptLine,QtyToBeInvoiced,QtyToBeInvoicedBase,PurchLine,PurchHeader); //**4PS.n

            UpdateInvoicedQtyOnPurchRcptLine(
              PurchInvHeader,PurchRcptLine,PurchHeader,PurchLine,QtyToBeInvoiced,QtyToBeInvoicedBase,TrackingSpecificationExists);

            IF PostItemTrackingForReceiptCondition(PurchLine,PurchRcptLine) THEN
              PostItemJnlLine(
                PurchHeader,PurchLine,0,0,QtyToBeInvoiced,QtyToBeInvoicedBase,
                ItemEntryRelation."Item Entry No.",'',TempTrackingSpecification);

            IF TrackingSpecificationExists THEN
              EndLoop := (TempTrackingSpecification.NEXT = 0) OR (RemQtyToBeInvoiced = 0)
            ELSE
              EndLoop :=
              //(PurchRcptLine.NEXT = 0) OR (ABS(RemQtyToBeInvoiced) <= ABS(PurchLine."Qty. to Receive")); //**4PS.o
                //**4PS.sn
                (PurchRcptLine.NEXT = 0) OR
                ("Amounts only" AND (ABS(RemAmntToBeInvoiced) <= ABS(PurchLine."Amnt. to Receive"))) OR
                (NOT "Amounts only" AND (ABS(RemQtyToBeInvoiced) <= ABS(PurchLine."Qty. to Receive")));
                //**4PS.en
          UNTIL EndLoop;
        END ELSE
          IF "Document Type" <> "Document Type"::"Credit Memo" THEN //**4PS.n
            ERROR(ReceiptInvoicedErr,PurchLine."Receipt Line No.",PurchLine."Receipt No.");
      END;
    END;

    LOCAL PROCEDURE PostItemTrackingForReceiptCondition@288(PurchLine@1001 : Record 39;PurchRcptLine@1002 : Record 121) : Boolean;
    VAR
      Condition@1000 : Boolean;
    BEGIN
      Condition := PurchLine.Type = PurchLine.Type::Item;
      OnBeforePostItemTrackingForReceiptCondition(PurchLine,PurchRcptLine,Condition);
      EXIT(Condition);
    END;

    LOCAL PROCEDURE PostItemTrackingForShipment@374(PurchHeader@1000 : Record 38;PurchLine@1001 : Record 39;TrackingSpecificationExists@1003 : Boolean;VAR TempTrackingSpecification@1012 : TEMPORARY Record 336);
    VAR
      ReturnShptLine@1010 : Record 6651;
      ItemEntryRelation@1009 : Record 6507;
      EndLoop@1008 : Boolean;
      QtyToBeInvoiced@1005 : Decimal;
      QtyToBeInvoicedBase@1004 : Decimal;
    BEGIN
      WITH PurchHeader DO BEGIN
        EndLoop := FALSE;
        ReturnShptLine.RESET;
        CASE "Document Type" OF
          "Document Type"::"Return Order":
            BEGIN
              ReturnShptLine.SETCURRENTKEY("Return Order No.","Return Order Line No.");
              ReturnShptLine.SETRANGE("Return Order No.",PurchLine."Document No.");
              ReturnShptLine.SETRANGE("Return Order Line No.",PurchLine."Line No.");
            END;
          "Document Type"::"Credit Memo":
            BEGIN
              ReturnShptLine.SETRANGE("Document No.",PurchLine."Return Shipment No.");
              ReturnShptLine.SETRANGE("Line No.",PurchLine."Return Shipment Line No.");
            END;
        END;
        ReturnShptLine.SETFILTER("Return Qty. Shipped Not Invd.",'<>0');
        IF ReturnShptLine.FINDSET(TRUE,FALSE) THEN BEGIN
          ItemJnlRollRndg := TRUE;
          REPEAT
            IF TrackingSpecificationExists THEN BEGIN  // Item Tracking
              ItemEntryRelation.GET(TempTrackingSpecification."Item Ledger Entry No.");
              ReturnShptLine.GET(ItemEntryRelation."Source ID",ItemEntryRelation."Source Ref. No.");
            END ELSE
              ItemEntryRelation."Item Entry No." := ReturnShptLine."Item Shpt. Entry No.";
            ReturnShptLine.TESTFIELD("Buy-from Vendor No.",PurchLine."Buy-from Vendor No.");
            ReturnShptLine.TESTFIELD(Type,PurchLine.Type);
            ReturnShptLine.TESTFIELD("No.",PurchLine."No.");
            ReturnShptLine.TESTFIELD("Gen. Bus. Posting Group",PurchLine."Gen. Bus. Posting Group");
            ReturnShptLine.TESTFIELD("Gen. Prod. Posting Group",PurchLine."Gen. Prod. Posting Group");
            ReturnShptLine.TESTFIELD("Job No.",PurchLine."Job No.");
            ReturnShptLine.TESTFIELD("Unit of Measure Code",PurchLine."Unit of Measure Code");
            ReturnShptLine.TESTFIELD("Variant Code",PurchLine."Variant Code");
            ReturnShptLine.TESTFIELD("Prod. Order No.",PurchLine."Prod. Order No.");
            UpdateQtyToBeInvoicedForReturnShipment(
              QtyToBeInvoiced,QtyToBeInvoicedBase,
              TrackingSpecificationExists,PurchLine,ReturnShptLine,TempTrackingSpecification);

            IF TrackingSpecificationExists THEN BEGIN
              TempTrackingSpecification."Quantity actual Handled (Base)" := QtyToBeInvoicedBase;
              TempTrackingSpecification.MODIFY;
            END;

            IF TrackingSpecificationExists THEN
              ItemTrackingMgt.AdjustQuantityRounding(
                RemQtyToBeInvoiced,QtyToBeInvoiced,RemQtyToBeInvoicedBase,QtyToBeInvoicedBase);

            RemQtyToBeInvoiced := RemQtyToBeInvoiced - QtyToBeInvoiced;
            RemQtyToBeInvoicedBase := RemQtyToBeInvoicedBase - QtyToBeInvoicedBase;
            UpdateInvoicedQtyOnReturnShptLine(ReturnShptLine,QtyToBeInvoiced,QtyToBeInvoicedBase);

            OnAfterUpdateInvoicedQtyOnReturnShptLine(
              PurchCrMemoHeader,ReturnShptLine,PurchLine,TempTrackingSpecification,TrackingSpecificationExists,
              QtyToBeInvoiced,QtyToBeInvoicedBase);
            IF PostItemTrackingForShipmentCondition(PurchLine,ReturnShptLine) THEN
              PostItemJnlLine(
                PurchHeader,PurchLine,0,0,QtyToBeInvoiced,QtyToBeInvoicedBase,
                ItemEntryRelation."Item Entry No.",'',TempTrackingSpecification);

            IF TrackingSpecificationExists THEN
              EndLoop := (TempTrackingSpecification.NEXT = 0) OR (RemQtyToBeInvoiced = 0)
            ELSE
              EndLoop :=
                (ReturnShptLine.NEXT = 0) OR (ABS(RemQtyToBeInvoiced) <= ABS(PurchLine."Return Qty. to Ship"));
          UNTIL EndLoop;
        END ELSE
          ERROR(
            ReturnShipmentInvoicedErr,
            PurchLine."Return Shipment Line No.",PurchLine."Return Shipment No.");
      END;
    END;

    LOCAL PROCEDURE PostItemTrackingForShipmentCondition@293(PurchLine@1001 : Record 39;ReturnShipmentLine@1002 : Record 6651) : Boolean;
    VAR
      Condition@1000 : Boolean;
    BEGIN
      Condition := PurchLine.Type = PurchLine.Type::Item;
      OnBeforePostItemTrackingForShipmentCondition(PurchLine,ReturnShipmentLine,Condition);
      EXIT(Condition);
    END;

    LOCAL PROCEDURE PostUpdateOrderLine@142(PurchHeader@1001 : Record 38);
    VAR
      TempPurchLine@1000 : TEMPORARY Record 39;
    BEGIN
      OnBeforePostUpdateOrderLine(PurchHeader,TempPurchLineGlobal);

      ResetTempLines(TempPurchLine);
      WITH TempPurchLine DO BEGIN
        SETRANGE("Prepayment Line",FALSE);
      //SETFILTER(Quantity,'<>0'); //**4PS.o

        //**4PS.sn
        PutPromisedReceiveDateFilter(TempPurchLine);
        PutReceiveMarkedOnlyFilter(TempPurchLine);
        //**4PS.en

        IF FINDSET THEN
          REPEAT
           //**4PS.sn
           IF Quantity = 0 THEN BEGIN
             IF PurchHeader."Amounts only" THEN BEGIN
               IF PurchHeader.Receive THEN
                 "Amnt. Received" += "Amnt. to Receive";
               IF PurchHeader.Invoice THEN BEGIN
                 IF "Document Type" = "Document Type"::Order THEN
                   IF ABS("Amnt. Invoiced" + "Amnt. to Invoice") >
                      ABS("Amnt. Received")
                   THEN
                     VALIDATE("Amnt. to Invoice","Amnt. Received"-"Amnt. Invoiced");
                 "Amnt. Invoiced" += "Amnt. to Invoice";
               END;
               UpdateVATAmounts;
               InitOutstandingAmount;
               InitAmntToReceive;
               ModifyTempLine(TempPurchLine);
             END;
           END ELSE BEGIN
           //**4PS.en
            IF PurchHeader.Receive THEN BEGIN
              "Quantity Received" += "Qty. to Receive";
              "Qty. Received (Base)" += "Qty. to Receive (Base)";
              //**4PS.sn
              "Amnt. Received" :=
                ROUND("Quantity Received" * GetPurchLineUnitCostInclDisc(TempPurchLine),
                Currency."Amount Rounding Precision");
              //**4PS.en
            END;
            IF PurchHeader.Ship THEN BEGIN
              "Return Qty. Shipped" += "Return Qty. to Ship";
              "Return Qty. Shipped (Base)" += "Return Qty. to Ship (Base)";
            END;
            IF PurchHeader.Invoice THEN BEGIN
              IF "Document Type" = "Document Type"::Order THEN BEGIN
                IF ABS("Quantity Invoiced" + "Qty. to Invoice") > ABS("Quantity Received") THEN BEGIN
                  VALIDATE("Qty. to Invoice","Quantity Received" - "Quantity Invoiced");
                  "Qty. to Invoice (Base)" := "Qty. Received (Base)" - "Qty. Invoiced (Base)";
                END
              END ELSE
                IF ABS("Quantity Invoiced" + "Qty. to Invoice") > ABS("Return Qty. Shipped") THEN BEGIN
                  VALIDATE("Qty. to Invoice","Return Qty. Shipped" - "Quantity Invoiced");
                  "Qty. to Invoice (Base)" := "Return Qty. Shipped (Base)" - "Qty. Invoiced (Base)";
                END;

              "Quantity Invoiced" := "Quantity Invoiced" + "Qty. to Invoice";
              "Qty. Invoiced (Base)" := "Qty. Invoiced (Base)" + "Qty. to Invoice (Base)";
              IF "Qty. to Invoice" <> 0 THEN BEGIN
                "Prepmt Amt Deducted" += "Prepmt Amt to Deduct";
                "Prepmt VAT Diff. Deducted" += "Prepmt VAT Diff. to Deduct";
                DecrementPrepmtAmtInvLCY(
                  TempPurchLine,"Prepmt. Amount Inv. (LCY)","Prepmt. VAT Amount Inv. (LCY)");
                "Prepmt Amt to Deduct" := "Prepmt. Amt. Inv." - "Prepmt Amt Deducted";
                "Prepmt VAT Diff. to Deduct" := 0;
                //**4PS.sn
                "Amnt. Invoiced" :=
                  ROUND("Quantity Invoiced" * GetPurchLineUnitCostInclDisc(TempPurchLine),
                  Currency."Amount Rounding Precision")
                //**4PS.en
              END;
            END;

            UpdateBlanketOrderLine(TempPurchLine,PurchHeader.Receive,PurchHeader.Ship,PurchHeader.Invoice);
            //**4PS.sn
            "Amnt. to Receive" := 0;
            "Amnt. to Invoice" := 0;
            IF "Document Type" = "Document Type"::Order THEN BEGIN
              "Approve Receipt" := "Approve Receipt"::" ";
              "Comment Receipt" := '';
            END;
            //**4PS.en
            OnPostUpdateOrderLineOnBeforeInitOutstanding(PurchHeader,TempPurchLine);
            InitOutstanding;

            //**4PS.so
            //IF WhseHandlingRequired(TempPurchLine) OR
            //   (PurchSetup."Default Qty. to Receive" = PurchSetup."Default Qty. to Receive"::Blank)
            //**4PS.eo
            IF WhseHandlingRequired(TempPurchLine) //**4PS.n
            THEN BEGIN
              IF "Document Type" = "Document Type"::"Return Order" THEN BEGIN
                "Return Qty. to Ship" := 0;
                "Return Qty. to Ship (Base)" := 0;
              END ELSE BEGIN
                "Qty. to Receive" := 0;
                "Qty. to Receive (Base)" := 0;
              END;
              InitQtyToInvoice;
            END ELSE BEGIN
              IF "Document Type" = "Document Type"::"Return Order" THEN
                InitQtyToShip
              ELSE
                InitQtyToReceive2;
            END;
            SetDefaultQuantity;
            OnBeforePostUpdateOrderLineModifyTempLine(TempPurchLine,WhseShip,WhseReceive,SuppressCommit,PurchHeader);
            ModifyTempLine(TempPurchLine);
            OnAfterPostUpdateOrderLine(TempPurchLine,WhseShip,WhseReceive,SuppressCommit);
           END; //**4PS.n
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE PostUpdateInvoiceLine@140(PurchHeader@1100525000 : Record 38);
    VAR
      PurchOrderLine@1001 : Record 39;
      PurchRcptLine@1002 : Record 121;
      SalesOrderLine@1003 : Record 37;
      TempPurchLine@1000 : TEMPORARY Record 39;
    BEGIN
      //**4PS
      ResetTempLines(TempPurchLine);
      WITH TempPurchLine DO BEGIN
        SETFILTER("Receipt No.",'<>%1','');
        SETFILTER(Type,'<>%1',Type::" ");
        IF FINDSET THEN
          REPEAT
            PurchRcptLine.GET("Receipt No.","Receipt Line No.");
            PurchOrderLine.GET(
              PurchOrderLine."Document Type"::Order,
              PurchRcptLine."Order No.",PurchRcptLine."Order Line No.");
            IF Type = Type::"Charge (Item)" THEN
              UpdatePurchOrderChargeAssgnt(TempPurchLine,PurchOrderLine);
            //**4PS.sn
            IF "Document Type" = "Document Type"::"Credit Memo" THEN BEGIN
              PurchOrderLine."Quantity Invoiced" -= "Qty. to Invoice";
              PurchOrderLine."Qty. Invoiced (Base)" -= "Qty. to Invoice (Base)";
            END ELSE BEGIN
              PurchOrderLine."Quantity Invoiced" += "Qty. to Invoice";
              PurchOrderLine."Qty. Invoiced (Base)" += "Qty. to Invoice (Base)";
            END; //**4PS.n
          //IF ABS(PurchOrderLine."Quantity Invoiced") > ABS(PurchOrderLine."Quantity Received") THEN //**4PS.o
            IF PurchRcptLine.Quantity * PurchRcptLine."Qty. Rcd. Not Invoiced" < 0 THEN //**4PS.n
              ERROR(InvoiceMoreThanReceivedErr,PurchOrderLine."Document No.");
            IF PurchOrderLine."Sales Order Line No." <> 0 THEN BEGIN // Drop Shipment
              SalesOrderLine.GET(
                SalesOrderLine."Document Type"::Order,
                PurchOrderLine."Sales Order No.",PurchOrderLine."Sales Order Line No.");
              IF ABS(PurchOrderLine.Quantity - PurchOrderLine."Quantity Invoiced") <
                 ABS(SalesOrderLine.Quantity - SalesOrderLine."Quantity Invoiced")
              THEN
                ERROR(CannotPostBeforeAssosSalesOrderErr,PurchOrderLine."Sales Order No.");
            END;
            //**4PS.sn
            IF "Document Type" = "Document Type"::"Credit Memo" THEN
              PurchOrderLine."Amnt. Invoiced" -= TempPurchLine.Amount
            ELSE
              PurchOrderLine."Amnt. Invoiced" += TempPurchLine.Amount;
            PurchOrderLine.UpdateVATAmounts;
            IF PurchHeader."Amounts only" THEN BEGIN
              PurchOrderLine.InitOutstandingAmount;
              PurchOrderLine.InitAmntToReceive;
              PurchOrderLine.InitAmntToInvoice;
            END ELSE BEGIN
            //**4PS.en
              PurchOrderLine.InitQtyToInvoice;
              IF PurchOrderLine."Prepayment %" <> 0 THEN BEGIN
                PurchOrderLine."Prepmt Amt Deducted" += "Prepmt Amt to Deduct";
                PurchOrderLine."Prepmt VAT Diff. Deducted" += "Prepmt VAT Diff. to Deduct";
                DecrementPrepmtAmtInvLCY(
                  TempPurchLine,PurchOrderLine."Prepmt. Amount Inv. (LCY)",PurchOrderLine."Prepmt. VAT Amount Inv. (LCY)");
                PurchOrderLine."Prepmt Amt to Deduct" :=
                  PurchOrderLine."Prepmt. Amt. Inv." - PurchOrderLine."Prepmt Amt Deducted";
                PurchOrderLine."Prepmt VAT Diff. to Deduct" := 0;
              END;
              PurchOrderLine.InitOutstanding;
            //**4PS.sn
            END;
            PurchOrderLine."Modified by" := USERID; //DP00469
            PurchOrderLine."Last Date Modified" := TODAY;//DP00469
            //**4PS.en
            PurchOrderLine.MODIFY;

            //**4PS.sn
            CheckCloseHeader(PurchOrderLine);
            CreatePurchaseOrderControl(PurchOrderLine);
            UpdateReceiptBalance(TempPurchLine);
            //**4PS.en

            OnPostUpdateInvoiceLineOnAfterPurchOrderLineModify(PurchOrderLine,TempPurchLine);
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE PostUpdateCreditMemoLine@108();
    VAR
      PurchOrderLine@1002 : Record 39;
      ReturnShptLine@1001 : Record 6651;
      TempPurchLine@1000 : TEMPORARY Record 39;
    BEGIN
      //NOT Used by 4PS
      ResetTempLines(TempPurchLine);
      WITH TempPurchLine DO BEGIN
        SETFILTER("Return Shipment No.",'<>%1','');
        SETFILTER(Type,'<>%1',Type::" ");
        IF FINDSET THEN
          REPEAT
            ReturnShptLine.GET("Return Shipment No.","Return Shipment Line No.");
            PurchOrderLine.GET(
              PurchOrderLine."Document Type"::"Return Order",
              ReturnShptLine."Return Order No.",ReturnShptLine."Return Order Line No.");
            IF Type = Type::"Charge (Item)" THEN
              UpdatePurchOrderChargeAssgnt(TempPurchLine,PurchOrderLine);
            PurchOrderLine."Quantity Invoiced" :=
              PurchOrderLine."Quantity Invoiced" + "Qty. to Invoice";
            PurchOrderLine."Qty. Invoiced (Base)" :=
              PurchOrderLine."Qty. Invoiced (Base)" + "Qty. to Invoice (Base)";
            IF ABS(PurchOrderLine."Quantity Invoiced") > ABS(PurchOrderLine."Return Qty. Shipped") THEN
              ERROR(InvoiceMoreThanShippedErr,PurchOrderLine."Document No.");
            PurchOrderLine.InitQtyToInvoice;
            PurchOrderLine.InitOutstanding;
            PurchOrderLine.MODIFY;
          UNTIL NEXT = 0;
      END;
    END;

    [External]
    PROCEDURE SetPostingFlags@18(VAR PurchHeader@1000 : Record 38);
    BEGIN
      WITH PurchHeader DO BEGIN
        CASE "Document Type" OF
          "Document Type"::Order:
            Ship := FALSE;
          "Document Type"::Invoice:
            BEGIN
              Receive := TRUE;
              Invoice := TRUE;
              Ship := FALSE;
            END;
          "Document Type"::"Return Order":
            Receive := FALSE;
          "Document Type"::"Credit Memo":
            BEGIN
              Receive := FALSE;
              Invoice := TRUE;
              Ship := TRUE;
            END;
        END;
        IF NOT NoErrorNothingToPost THEN //**4PS.n
          IF NOT (Receive OR Invoice OR Ship) THEN
            ERROR(ReceiveInvoiceShipErr);
      END;
    END;

    LOCAL PROCEDURE SetCheckApplToItemEntry@164(PurchLine@1000 : Record 39) : Boolean;
    BEGIN
      WITH PurchLine DO
        EXIT(
          PurchSetup."Exact Cost Reversing Mandatory" AND (Type = Type::Item) AND
          (((Quantity < 0) AND ("Document Type" IN ["Document Type"::Order,"Document Type"::Invoice])) OR
           ((Quantity > 0) AND IsCreditDocType)) AND
          ("Job No." = ''));
    END;

    [Integration]
    PROCEDURE OnAfterPostBeforeCommitPurchaseDoc@1100528200(VAR PurchaseHeader@1000 : Record 38;VAR GenJnlPostLine@1001 : Codeunit 12;PurchRcpHdrNo@1002 : Code[20];RetShptHdrNo@1003 : Code[20];PurchInvHdrNo@1004 : Code[20];PurchCrMemoHdrNo@1005 : Code[20]);
    BEGIN
    END;

    LOCAL PROCEDURE CreatePostedDeferralScheduleFromPurchDoc@169(PurchLine@1008 : Record 39;NewDocumentType@1007 : Integer;NewDocumentNo@1003 : Code[20];NewLineNo@1002 : Integer;PostingDate@1000 : Date);
    VAR
      PostedDeferralHeader@1006 : Record 1704;
      PostedDeferralLine@1005 : Record 1705;
      DeferralTemplate@1004 : Record 1700;
      DeferralAccount@1001 : Code[20];
    BEGIN
      IF PurchLine."Deferral Code" = '' THEN
        EXIT;

      IF DeferralTemplate.GET(PurchLine."Deferral Code") THEN
        DeferralAccount := DeferralTemplate."Deferral Account";

      IF TempDeferralHeader.GET(
           DeferralUtilities.GetPurchDeferralDocType,'','',PurchLine."Document Type",PurchLine."Document No.",PurchLine."Line No.")
      THEN BEGIN
        PostedDeferralHeader.InitFromDeferralHeader(TempDeferralHeader,'','',NewDocumentType,
          NewDocumentNo,NewLineNo,DeferralAccount,PurchLine."Buy-from Vendor No.",PostingDate);
        DeferralUtilities.FilterDeferralLines(
          TempDeferralLine,DeferralUtilities.GetPurchDeferralDocType,'','',
          PurchLine."Document Type",PurchLine."Document No.",PurchLine."Line No.");
        IF TempDeferralLine.FINDSET THEN
          REPEAT
            PostedDeferralLine.InitFromDeferralLine(
              TempDeferralLine,'','',NewDocumentType,NewDocumentNo,NewLineNo,DeferralAccount);
          UNTIL TempDeferralLine.NEXT = 0;
      END;

      OnAfterCreatePostedDeferralScheduleFromPurchDoc(PurchLine,PostedDeferralHeader);
    END;

    LOCAL PROCEDURE CalcDeferralAmounts@173(PurchHeader@1000 : Record 38;PurchLine@1003 : Record 39;OriginalDeferralAmount@1002 : Decimal);
    VAR
      DeferralHeader@1004 : Record 1701;
      DeferralLine@1005 : Record 1702;
      CurrExchRate@1006 : Record 330;
      TotalAmountLCY@1009 : Decimal;
      TotalAmount@1010 : Decimal;
      TotalDeferralCount@1007 : Integer;
      DeferralCount@1008 : Integer;
      UseDate@1001 : Date;
    BEGIN
      // Populate temp and calculate the LCY amounts for posting
      IF PurchHeader."Posting Date" = 0D THEN
        UseDate := WORKDATE
      ELSE
        UseDate := PurchHeader."Posting Date";

      IF DeferralHeader.GET(
           DeferralUtilities.GetPurchDeferralDocType,'','',PurchLine."Document Type",PurchLine."Document No.",PurchLine."Line No.")
      THEN BEGIN
        TempDeferralHeader := DeferralHeader;
        IF PurchLine.Quantity <> PurchLine."Qty. to Invoice" THEN
          TempDeferralHeader."Amount to Defer" :=
            ROUND(TempDeferralHeader."Amount to Defer" *
              PurchLine.GetDeferralAmount / OriginalDeferralAmount,Currency."Amount Rounding Precision");
        TempDeferralHeader."Amount to Defer (LCY)" :=
          ROUND(
            CurrExchRate.ExchangeAmtFCYToLCY(
              1, PurchHeader."Job No.", //**4PS.n
              UseDate,PurchHeader."Currency Code",
      //      TempDeferralHeader."Amount to Defer",PurchHeader."Currency Factor")); //**4PS.o
              TempDeferralHeader."Amount to Defer",PurchHeader."Currency Factor",FALSE)); //**4PS.n
        TempDeferralHeader.INSERT;

        WITH DeferralLine DO BEGIN
          DeferralUtilities.FilterDeferralLines(
            DeferralLine,DeferralHeader."Deferral Doc. Type",
            DeferralHeader."Gen. Jnl. Template Name",DeferralHeader."Gen. Jnl. Batch Name",
            PurchLine."Document Type",PurchLine."Document No.",PurchLine."Line No.");
          IF FINDSET THEN BEGIN
            TotalDeferralCount := COUNT;
            REPEAT
              TempDeferralLine.INIT;
              TempDeferralLine := DeferralLine;
              DeferralCount := DeferralCount + 1;

              IF DeferralCount = TotalDeferralCount THEN BEGIN
                TempDeferralLine.Amount := TempDeferralHeader."Amount to Defer" - TotalAmount;
                TempDeferralLine."Amount (LCY)" := TempDeferralHeader."Amount to Defer (LCY)" - TotalAmountLCY;
              END ELSE BEGIN
                IF PurchLine.Quantity <> PurchLine."Qty. to Invoice" THEN
                  TempDeferralLine.Amount :=
                    ROUND(TempDeferralLine.Amount *
                      PurchLine.GetDeferralAmount / OriginalDeferralAmount,Currency."Amount Rounding Precision");

                TempDeferralLine."Amount (LCY)" :=
                  ROUND(
                    CurrExchRate.ExchangeAmtFCYToLCY(
                      1, PurchHeader."Job No.", //**4PS.n
                      UseDate,PurchHeader."Currency Code",
      //              TempDeferralLine.Amount,PurchHeader."Currency Factor")); //**4PS.o
                      TempDeferralLine.Amount,PurchHeader."Currency Factor",FALSE)); //**4PS.n
                TotalAmount := TotalAmount + TempDeferralLine.Amount;
                TotalAmountLCY := TotalAmountLCY + TempDeferralLine."Amount (LCY)";
              END;
              OnBeforeTempDeferralLineInsert(TempDeferralLine,DeferralLine,PurchLine,DeferralCount,TotalDeferralCount);
              TempDeferralLine.INSERT;
            UNTIL NEXT = 0;
          END;
        END;
      END;
    END;

    LOCAL PROCEDURE GetAmountRoundingPrecisionInLCY@122(DocType@1001 : Option;DocNo@1002 : Code[20];CurrencyCode@1000 : Code[10]) AmountRoundingPrecision : Decimal;
    VAR
      PurchHeader@1003 : Record 38;
    BEGIN
      IF CurrencyCode = '' THEN
        EXIT(GLSetup."Amount Rounding Precision");
      PurchHeader.GET(DocType,DocNo);
      AmountRoundingPrecision := Currency."Amount Rounding Precision" / PurchHeader."Currency Factor";
      IF AmountRoundingPrecision < GLSetup."Amount Rounding Precision" THEN
        EXIT(GLSetup."Amount Rounding Precision");
      EXIT(AmountRoundingPrecision);
    END;

    LOCAL PROCEDURE CollectPurchaseLineReservEntries@185(VAR JobReservEntry@1003 : Record 337;ItemJournalLine@1001 : Record 83);
    VAR
      ReservationEntry@1004 : Record 337;
      ItemJnlLineReserve@1000 : Codeunit 99000835;
    BEGIN
      IF ItemJournalLine."Job No." <> '' THEN BEGIN
        JobReservEntry.DELETEALL;
        ItemJnlLineReserve.FindReservEntry(ItemJournalLine,ReservationEntry);
        ReservationEntry.ClearTrackingFilter;
        IF ReservationEntry.FINDSET THEN
          REPEAT
            JobReservEntry := ReservationEntry;
            JobReservEntry.INSERT;
          UNTIL ReservationEntry.NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE ArchiveSalesOrders@180(VAR TempDropShptPostBuffer@1000 : TEMPORARY Record 223);
    VAR
      SalesOrderHeader@1002 : Record 36;
      SalesOrderLine@1001 : Record 37;
    BEGIN
      IF TempDropShptPostBuffer.FINDSET THEN BEGIN
        REPEAT
          SalesOrderHeader.GET(
            SalesOrderHeader."Document Type"::Order,
            TempDropShptPostBuffer."Order No.");
          TempDropShptPostBuffer.SETRANGE("Order No.",TempDropShptPostBuffer."Order No.");
          REPEAT
            SalesOrderLine.GET(
              SalesOrderLine."Document Type"::Order,
              TempDropShptPostBuffer."Order No.",TempDropShptPostBuffer."Order Line No.");
            SalesOrderLine."Qty. to Ship" := TempDropShptPostBuffer.Quantity;
            SalesOrderLine."Qty. to Ship (Base)" := TempDropShptPostBuffer."Quantity (Base)";
            SalesOrderLine.MODIFY;
          UNTIL TempDropShptPostBuffer.NEXT = 0;
          SalesPost.ArchiveUnpostedOrder(SalesOrderHeader);
          TempDropShptPostBuffer.SETRANGE("Order No.");
        UNTIL TempDropShptPostBuffer.NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE ClearAllVariables@270();
    BEGIN
      IF NOT SkipClearAll THEN  //**4PS.n DP00416
        CLEARALL;
      TempPurchLineGlobal.DELETEALL;
      TempItemChargeAssgntPurch.DELETEALL;
      TempHandlingSpecification.DELETEALL;
      TempTrackingSpecification.DELETEALL;
      TempTrackingSpecificationInv.DELETEALL;
      TempWhseSplitSpecification.DELETEALL;
      TempValueEntryRelation.DELETEALL;
      TempICGenJnlLine.DELETEALL;
      TempPrepmtDeductLCYPurchLine.DELETEALL;
      TempSKU.DELETEALL;
      TempDeferralHeader.DELETEALL;
      TempDeferralLine.DELETEALL;
    END;

    [External]
    PROCEDURE SetSuppressCommit@239(NewSuppressCommit@1000 : Boolean);
    BEGIN
      SuppressCommit := NewSuppressCommit;
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterBlanketOrderPurchLineModify@287(VAR BlanketOrderPurchLine@1000 : Record 39;PurchaseLine@1001 : Record 39;Ship@1002 : Boolean;Receive@1003 : Boolean;Invoice@1004 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterCheckPurchDoc@1(VAR PurchHeader@1000 : Record 38;CommitIsSupressed@1001 : Boolean;WhseShip@1002 : Boolean;WhseReceive@1003 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterCheckAndUpdate@130(VAR PurchaseHeader@1000 : Record 38;CommitIsSuppressed@1001 : Boolean;PreviewMode@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterCheckTrackingAndWarehouseForReceive@217(VAR PurchaseHeader@1000 : Record 38;VAR Receive@1001 : Boolean;CommitIsSupressed@1002 : Boolean;VAR TempWarehouseShipmentHeader@1003 : TEMPORARY Record 7320;VAR TempWarehouseReceiptHeader@1004 : TEMPORARY Record 7316;VAR TempPurchaseLine@1005 : TEMPORARY Record 39);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterCheckTrackingAndWarehouseForShip@218(VAR PurchaseHeader@1000 : Record 38;VAR Ship@1001 : Boolean;CommitIsSupressed@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterCreatePostedDeferralScheduleFromPurchDoc@334(VAR PurchaseLine@1000 : Record 39;VAR PostedDeferralHeader@1001 : Record 1704);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterDeleteAfterPosting@129(PurchHeader@1000 : Record 38;PurchInvHeader@1001 : Record 122;PurchCrMemoHdr@1002 : Record 124;CommitIsSupressed@1003 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterDivideAmount@250(PurchHeader@1005 : Record 38;VAR PurchLine@1004 : Record 39;QtyType@1003 : 'General,Invoicing,Shipping';PurchLineQty@1002 : Decimal;VAR TempVATAmountLine@1001 : TEMPORARY Record 290;VAR TempVATAmountLineRemainder@1000 : TEMPORARY Record 290);
    BEGIN
    END;

    [Integration]
    PROCEDURE OnAfterPostPurchaseDoc@116(VAR PurchaseHeader@1000 : Record 38;VAR GenJnlPostLine@1001 : Codeunit 12;PurchRcpHdrNo@1002 : Code[20];RetShptHdrNo@1003 : Code[20];PurchInvHdrNo@1004 : Code[20];PurchCrMemoHdrNo@1005 : Code[20];CommitIsSupressed@1006 : Boolean);
    BEGIN
    END;

    [Integration(DEFAULT,TRUE)]
    LOCAL PROCEDURE OnAfterPostPurchaseDocDropShipment@235(SalesShptNo@1000 : Code[20];CommitIsSupressed@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterUpdatePostingNos@178(VAR PurchaseHeader@1000 : Record 38;VAR NoSeriesMgt@1001 : Codeunit 396;CommitIsSupressed@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterCheckMandatoryFields@195(VAR PurchaseHeader@1000 : Record 38;CommitIsSupressed@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterFillInvoicePostBuffer@213(VAR InvoicePostBuffer@1000 : Record 49;PurchLine@1001 : Record 39;VAR TempInvoicePostBuffer@1002 : TEMPORARY Record 49;CommitIsSupressed@1003 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterFinalizePosting@196(VAR PurchHeader@1000 : Record 38;VAR PurchRcptHeader@1001 : Record 120;VAR PurchInvHeader@1002 : Record 122;VAR PurchCrMemoHdr@1003 : Record 124;VAR ReturnShptHeader@1004 : Record 6650;VAR GenJnlPostLine@1005 : Codeunit 12;PreviewMode@1006 : Boolean;CommitIsSupressed@1007 : Boolean);
    BEGIN
    END;

    [Integration(DEFAULT,TRUE)]
    LOCAL PROCEDURE OnAfterFinalizePostingOnBeforeCommit@242(VAR PurchHeader@1007 : Record 38;VAR PurchRcptHeader@1006 : Record 120;VAR PurchInvHeader@1005 : Record 122;VAR PurchCrMemoHdr@1004 : Record 124;VAR ReturnShptHeader@1003 : Record 6650;VAR GenJnlPostLine@1002 : Codeunit 12;PreviewMode@1001 : Boolean;CommitIsSupressed@1000 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterIncrAmount@230(VAR TotalPurchLine@1000 : Record 39;PurchLine@1001 : Record 39);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterInitAssocItemJnlLine@285(VAR ItemJournalLine@1000 : Record 83;SalesHeader@1001 : Record 36;SalesLine@1002 : Record 37;PurchaseHeader@1003 : Record 38);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterInsertCombinedSalesShipment@30(VAR SalesShipmentHeader@1000 : Record 110);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterInsertPostedHeaders@214(VAR PurchaseHeader@1000 : Record 38;VAR PurchRcptHeader@1001 : Record 120;VAR PurchInvHeader@1002 : Record 122;VAR PurchCrMemoHdr@1003 : Record 124;VAR ReturnShptHeader@1004 : Record 6650);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterInvoiceRoundingAmount@245(PurchaseHeader@1000 : Record 38;VAR PurchaseLine@1001 : Record 39;VAR TotalPurchaseLine@1002 : Record 39;UseTempData@1003 : Boolean;InvoiceRoundingAmount@1004 : Decimal;CommitIsSuppressed@1005 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterInsertedPrepmtVATBaseToDeduct@256(PurchHeader@1003 : Record 38;PurchLine@1002 : Record 39;PrepmtLineNo@1001 : Integer;TotalPrepmtAmtToDeduct@1000 : Decimal;VAR TempPrepmtDeductLCYPurchLine@1004 : TEMPORARY Record 39;VAR PrepmtVATBaseToDeduct@1005 : Decimal);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterPostItemJnlLineCopyProdOrder@197(VAR ItemJnlLine@1000 : Record 83;PurchLine@1001 : Record 39;PurchRcptHeader@1002 : Record 120;QtyToBeReceived@1003 : Decimal;CommitIsSupressed@1004 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterPostItemTrackingLine@284(VAR PurchaseHeader@1000 : Record 38;VAR PurchaseLine@1001 : Record 39;WhseReceive@1002 : Boolean;WhseShip@1003 : Boolean;InvtPickPutaway@1004 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterPurchRcptHeaderInsert@200(VAR PurchRcptHeader@1001 : Record 120;VAR PurchaseHeader@1000 : Record 38;CommitIsSupressed@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterPurchRcptLineInsert@211(PurchaseLine@1000 : Record 39;VAR PurchRcptLine@1001 : Record 121;ItemLedgShptEntryNo@1002 : Integer;WhseShip@1003 : Boolean;WhseReceive@1004 : Boolean;CommitIsSupressed@1005 : Boolean;PurchInvHeader@1006 : Record 122;VAR TempTrackingSpecification@1007 : TEMPORARY Record 336);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterPurchInvHeaderInsert@203(VAR PurchInvHeader@1001 : Record 122;VAR PurchHeader@1000 : Record 38);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterPurchInvLineInsert@177(VAR PurchInvLine@1000 : Record 123;PurchInvHeader@1002 : Record 122;PurchLine@1001 : Record 39;ItemLedgShptEntryNo@1003 : Integer;WhseShip@1004 : Boolean;WhseReceive@1005 : Boolean;CommitIsSupressed@1006 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterPurchCrMemoHeaderInsert@204(VAR PurchCrMemoHdr@1001 : Record 124;VAR PurchHeader@1000 : Record 38;CommitIsSupressed@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterPurchCrMemoLineInsert@182(VAR PurchCrMemoLine@1000 : Record 125;VAR PurchCrMemoHdr@1002 : Record 124;VAR PurchLine@1001 : Record 39;CommitIsSupressed@1003 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterReturnShptHeaderInsert@201(VAR ReturnShptHeader@1001 : Record 6650;VAR PurchHeader@1000 : Record 38;CommitIsSupressed@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterReturnShptLineInsert@202(VAR ReturnShptLine@1001 : Record 6651;ReturnShptHeader@1002 : Record 6650;PurchLine@1000 : Record 39;ItemLedgShptEntryNo@1003 : Integer;WhseShip@1004 : Boolean;WhseReceive@1005 : Boolean;CommitIsSupressed@1006 : Boolean;VAR TempWhseShptHeader@1007 : TEMPORARY Record 7320;PurchCrMemoHdr@1008 : Record 124);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterSalesShptHeaderInsert@263(VAR SalesShipmentHeader@1000 : Record 110;SalesOrderHeader@1001 : Record 36;CommitIsSuppressed@1002 : Boolean;PurchHeader@1003 : Record 38);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterSalesShptLineInsert@265(VAR SalesShptLine@1000 : Record 111;SalesShptHeader@1001 : Record 110;SalesOrderLine@1002 : Record 37;CommitIsSuppressed@1003 : Boolean;DropShptPostBuffer@1004 : Record 223);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterPostAccICLine@209(PurchaseLine@1000 : Record 39;CommitIsSupressed@1001 : Boolean);
    BEGIN
    END;

    [Integration(TRUE)]
    LOCAL PROCEDURE OnAfterPostItemLine@210(PurchaseLine@1000 : Record 39;CommitIsSupressed@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterPostVendorEntry@181(VAR GenJnlLine@1003 : Record 81;VAR PurchHeader@1000 : Record 38;VAR TotalPurchLine@1001 : Record 39;VAR TotalPurchLineLCY@1002 : Record 39;CommitIsSupressed@1004 : Boolean;VAR GenJnlPostLine@1005 : Codeunit 12);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterPostBalancingEntry@184(VAR GenJnlLine@1000 : Record 81;VAR PurchHeader@1003 : Record 38;VAR TotalPurchLine@1002 : Record 39;VAR TotalPurchLineLCY@1001 : Record 39;CommitIsSupressed@1004 : Boolean;VAR GenJnlPostLine@1005 : Codeunit 12);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterPostInvPostBuffer@206(VAR GenJnlLine@1002 : Record 81;VAR InvoicePostBuffer@1001 : Record 49;PurchHeader@1000 : Record 38;GLEntryNo@1003 : Integer;CommitIsSupressed@1004 : Boolean;VAR GenJnlPostLine@1005 : Codeunit 12);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterPostItemJnlLine@298(VAR ItemJournalLine@1000 : Record 83;VAR PurchaseLine@1001 : Record 39;VAR PurchaseHeader@1002 : Record 38;VAR ItemJnlPostLine@1003 : Codeunit 22);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterPostWhseJnlLine@1012(VAR PurchaseLine@1000 : Record 39;ItemLedgEntryNo@1003 : Integer;WhseShip@1001 : Boolean;WhseReceive@1002 : Boolean;CommitIsSupressed@1004 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterPostUpdateOrderLine@1015(VAR PurchaseLine@1000 : Record 39;WhseShip@1001 : Boolean;WhseReceive@1002 : Boolean;CommitIsSupressed@1003 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterPostGLAndVendor@225(VAR PurchHeader@1000 : Record 38;VAR GenJnlPostLine@1001 : Codeunit 12;TotalPurchLine@1003 : Record 39;TotalPurchLineLCY@1004 : Record 39;CommitIsSupressed@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterPostPurchLine@226(VAR PurchaseHeader@1000 : Record 38;VAR PurchaseLine@1001 : Record 39;CommitIsSupressed@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterPostPurchLines@241(VAR PurchHeader@1000 : Record 38;VAR PurchRcptHeader@1001 : Record 120;VAR PurchInvHeader@1002 : Record 122;VAR PurchCrMemoHdr@1003 : Record 124;VAR ReturnShipmentHeader@1004 : Record 6650;WhseShip@1005 : Boolean;WhseReceive@1006 : Boolean;VAR PurchLinesProcessed@1007 : Boolean;CommitIsSuppressed@1008 : Boolean;EverythingInvoiced@1009 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterResetTempLines@255(VAR TempPurchLineGlobal@1000 : TEMPORARY Record 39);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterRestorePurchaseHeader@395(VAR PurchaseHeader@1000 : Record 38;PurchaseHeaderCopy@1001 : Record 38);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterReverseAmount@240(VAR PurchLine@1000 : Record 39);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterRoundAmount@247(PurchaseHeader@1000 : Record 38;VAR PurchaseLine@1001 : Record 39;PurchLineQty@1002 : Decimal);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterSaveTempWhseSplitSpec@278(PurchaseLine@1000 : Record 39;VAR TempTrackingSpecification@1001 : TEMPORARY Record 336);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterSetApplyToDocNo@124(VAR GenJournalLine@1000 : Record 81;PurchaseHeader@1001 : Record 38);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterTestPurchLine@223(PurchHeader@1000 : Record 38;PurchLine@1001 : Record 39;WhseReceive@1002 : Boolean;WhseShip@1003 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterUpdateInvoicedQtyOnPurchRcptLine@275(VAR PurchInvHeader@1000 : Record 122;VAR PurchRcptLine@1001 : Record 121;VAR PurchaseLine@1002 : Record 39;VAR TempTrackingSpecification@1003 : TEMPORARY Record 336;TrackingSpecificationExists@1004 : Boolean;VAR QtyToBeInvoiced@1005 : Decimal;VAR QtyToBeInvoicedBase@1006 : Decimal;VAR PurchaseHeader@1007 : Record 38;CommitIsSuppressed@1008 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterUpdateInvoicedQtyOnReturnShptLine@277(PurchCrMemoHdr@1000 : Record 124;ReturnShipmentLine@1001 : Record 6651;PurchaseLine@1002 : Record 39;TempTrackingSpecification@1003 : TEMPORARY Record 336;TrackingSpecificationExists@1004 : Boolean;QtyToBeInvoiced@1005 : Decimal;QtyToBeInvoicedBase@1006 : Decimal);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterUpdatePurchLineBeforePost@1014(VAR PurchaseLine@1000 : Record 39;WhseShip@1001 : Boolean;WhseReceive@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterUpdatePrepmtPurchLineWithRounding@253(VAR PrepmtPurchLine@1004 : Record 39;TotalRoundingAmount@1003 : ARRAY [2] OF Decimal;TotalPrepmtAmount@1002 : ARRAY [2] OF Decimal;FinalInvoice@1001 : Boolean;PricesInclVATRoundingAmount@1000 : ARRAY [2] OF Decimal;VAR TotalPurchLine@1005 : Record 39;VAR TotalPurchLineLCY@1006 : Record 39);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterUpdatePurchaseHeader@272(VAR VendorLedgerEntry@1000 : Record 25;VAR PurchInvHeader@1001 : Record 122;VAR PurchCrMemoHdr@1002 : Record 124;GenJnlLineDocType@1003 : Integer);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterValidatePostingAndDocumentDate@283(VAR PurchaseHeader@1000 : Record 38;CommitIsSuppressed@1001 : Boolean;PreviewMode@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeArchiveUnpostedOrder@297(VAR PurchaseHeader@1000 : Record 38;VAR IsHandled@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeBlanketOrderPurchLineModify@254(VAR BlanketOrderPurchLine@1000 : Record 39;PurchLine@1001 : Record 39);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeCheckExternalDocumentNumber@215(VendorLedgerEntry@1000 : Record 25;PurchaseHeader@1001 : Record 38;VAR Handled@1002 : Boolean;DocType@1003 : Option;ExtDocNo@1004 : Text[35]);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeCheckICDocumentDuplicatePosting@282(VAR PurchaseHeader@1000 : Record 38;VAR IsHandled@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeCreatePostedWhseRcptHeader@294(VAR PostedWhseReceiptHeader@1000 : Record 7318;WarehouseReceiptHeader@1001 : Record 7316;PurchaseHeader@1002 : Record 38);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeCreatePostedWhseShptHeader@291(VAR PostedWhseShipmentHeader@1000 : Record 7322;WarehouseShipmentHeader@1001 : Record 7320;PurchaseHeader@1002 : Record 38);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeCreatePrepmtLines@313(PurchaseHeader@1000 : Record 38;VAR TempPrepmtPurchaseLine@1001 : TEMPORARY Record 39;CompleteFunctionality@1002 : Boolean;VAR IsHandled@1003 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeDeleteAfterPosting@664(VAR PurchaseHeader@1000 : Record 38;VAR PurchInvHeader@1001 : Record 122;VAR PurchCrMemoHdr@1002 : Record 124;VAR SkipDelete@1003 : Boolean;CommitIsSupressed@1004 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeDivideAmount@249(PurchHeader@1005 : Record 38;VAR PurchLine@1004 : Record 39;QtyType@1003 : 'General,Invoicing,Shipping';PurchLineQty@1002 : Decimal;VAR TempVATAmountLine@1001 : TEMPORARY Record 290;VAR TempVATAmountLineRemainder@1000 : TEMPORARY Record 290);
    BEGIN
    END;

    [Integration(DEFAULT,TRUE)]
    LOCAL PROCEDURE OnBeforeFinalizePosting@228(VAR PurchaseHeader@1000 : Record 38;VAR TempPurchLineGlobal@1001 : TEMPORARY Record 39;VAR EverythingInvoiced@1002 : Boolean;CommitIsSupressed@1003 : Boolean;VAR GenJnlPostLine@1004 : Codeunit 12);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeInitAssocItemJnlLine@383(VAR ItemJournalLine@1000 : Record 83;SalesHeader@1001 : Record 36;SalesLine@1002 : Record 37;PurchaseHeader@1003 : Record 38);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeInvoiceRoundingAmount@208(PurchHeader@1000 : Record 38;TotalAmountIncludingVAT@1001 : Decimal;UseTempData@1002 : Boolean;VAR InvoiceRoundingAmount@1003 : Decimal;CommitIsSupressed@1004 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeInsertPostedHeaders@49(VAR PurchaseHeader@1000 : Record 38;VAR WarehouseReceiptHeader@1001 : Record 7316;VAR WarehouseShipmentHeader@1002 : Record 7320);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeInsertReceiptHeader@243(VAR PurchHeader@1000 : Record 38;VAR PurchRcptHeader@1001 : Record 120;VAR IsHandled@1002 : Boolean;CommitIsSuppressed@1003 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeInvoicePostingBufferSetAmounts@317(PurchaseLine@1000 : Record 39;VAR TempInvoicePostBuffer@1001 : TEMPORARY Record 49;VAR InvoicePostBuffer@1002 : Record 49;VAR TotalVAT@1010 : Decimal;VAR TotalVATACY@1009 : Decimal;VAR TotalAmount@1008 : Decimal;VAR TotalAmountACY@1007 : Decimal;VAR TotalVATBase@1004 : Decimal;VAR TotalVATBaseACY@1003 : Decimal);
    BEGIN
    END;

    [Integration(TRUE,TRUE)]
    LOCAL PROCEDURE OnBeforeItemJnlPostLine@227(VAR ItemJournalLine@1000 : Record 83;PurchaseLine@1001 : Record 39;PurchaseHeader@1002 : Record 38;CommitIsSupressed@1003 : Boolean;VAR IsHandled@1004 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeLockTables@168(VAR PurchHeader@1000 : Record 38;PreviewMode@1001 : Boolean;CommitIsSuppressed@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePostLines@222(VAR PurchLine@1000 : Record 39;PurchHeader@1001 : Record 38;PreviewMode@1002 : Boolean;CommitIsSupressed@1003 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePostGLAndVendor@205(VAR PurchHeader@1000 : Record 38;VAR TempInvoicePostBuffer@1001 : TEMPORARY Record 49;PreviewMode@1002 : Boolean;CommitIsSupressed@1003 : Boolean;VAR GenJnlPostLine@1004 : Codeunit 12);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePostGLAccICLine@257(VAR PurchHeader@1002 : Record 38;VAR PurchLine@1001 : Record 39;VAR ICGenJnlLineNo@1000 : Integer;VAR IsHandled@1003 : Boolean);
    BEGIN
    END;

    [Integration(TRUE)]
    LOCAL PROCEDURE OnBeforePostPurchaseDoc@114(VAR PurchaseHeader@1000 : Record 38;PreviewMode@1001 : Boolean;CommitIsSupressed@1002 : Boolean;VAR HideProgressWindow@1003 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePostCommitPurchaseDoc@115(VAR PurchaseHeader@1000 : Record 38;VAR GenJnlPostLine@1001 : Codeunit 12;PreviewMode@1002 : Boolean;ModifyHeader@1003 : Boolean;CommitIsSupressed@1004 : Boolean;VAR TempPurchLineGlobal@1005 : TEMPORARY Record 39);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePurchLineDeleteAll@219(VAR PurchaseLine@1000 : Record 39;CommitIsSupressed@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePurchRcptHeaderInsert@183(VAR PurchRcptHeader@1001 : Record 120;VAR PurchaseHeader@1000 : Record 38;CommitIsSupressed@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePurchRcptLineInsert@192(VAR PurchRcptLine@1001 : Record 121;VAR PurchRcptHeader@1002 : Record 120;VAR PurchLine@1000 : Record 39;CommitIsSupressed@1003 : Boolean;PostedWhseRcptLine@1004 : Record 7319);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePurchInvHeaderInsert@176(VAR PurchInvHeader@1001 : Record 122;VAR PurchHeader@1000 : Record 38;CommitIsSupressed@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePurchInvLineInsert@189(VAR PurchInvLine@1001 : Record 123;VAR PurchInvHeader@1000 : Record 122;VAR PurchaseLine@1002 : Record 39;CommitIsSupressed@1003 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePurchCrMemoHeaderInsert@187(VAR PurchCrMemoHdr@1001 : Record 124;VAR PurchHeader@1000 : Record 38;CommitIsSupressed@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePurchCrMemoLineInsert@190(VAR PurchCrMemoLine@1001 : Record 125;VAR PurchCrMemoHdr@1000 : Record 124;VAR PurchLine@1002 : Record 39;CommitIsSupressed@1003 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeReturnShptHeaderInsert@186(VAR ReturnShptHeader@1001 : Record 6650;VAR PurchHeader@1000 : Record 38;CommitIsSupressed@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeReturnShptLineInsert@191(VAR ReturnShptLine@1001 : Record 6651;VAR ReturnShptHeader@1002 : Record 6650;VAR PurchLine@1000 : Record 39;CommitIsSupressed@1003 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeRoundAmount@244(VAR PurchaseHeader@1000 : Record 38;VAR PurchaseLine@1001 : Record 39;PurchLineQty@1002 : Decimal);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeSalesShptHeaderInsert@221(VAR SalesShptHeader@1000 : Record 110;SalesOrderHeader@1001 : Record 36;CommitIsSupressed@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeSalesShptLineInsert@216(VAR SalesShptLine@1000 : Record 111;SalesShptHeader@1001 : Record 110;SalesLine@1002 : Record 37;CommitIsSupressed@1003 : Boolean;DropShptPostBuffer@1004 : Record 223);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePostVendorEntry@193(VAR GenJnlLine@1003 : Record 81;VAR PurchHeader@1000 : Record 38;VAR TotalPurchLine@1001 : Record 39;VAR TotalPurchLineLCY@1002 : Record 39;PreviewMode@1004 : Boolean;CommitIsSupressed@1005 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePostBalancingEntry@194(VAR GenJnlLine@1000 : Record 81;VAR PurchHeader@1003 : Record 38;VAR TotalPurchLine@1002 : Record 39;VAR TotalPurchLineLCY@1001 : Record 39;PreviewMode@1004 : Boolean;CommitIsSupressed@1005 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePostCombineSalesOrderShipment@413(VAR PurchaseHeader@1000 : Record 38;VAR TempDropShptPostBuffer@1001 : TEMPORARY Record 223);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePostInvPostBuffer@6(VAR GenJnlLine@1000 : Record 81;VAR InvoicePostBuffer@1001 : Record 49;VAR PurchHeader@1003 : Record 38;VAR GenJnlPostLine@1002 : Codeunit 12;PreviewMode@1004 : Boolean;CommitIsSupressed@1005 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePostInvoicePostBuffer@299(PurchaseHeader@1000 : Record 38;VAR TempInvoicePostBuffer@1001 : TEMPORARY Record 49;VAR TotalPurchLine@1002 : Record 39;VAR TotalPurchLineLCY@1003 : Record 39);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePostItemJnlLine@234(PurchHeader@1008 : Record 38;VAR PurchLine@1007 : Record 39;VAR QtyToBeReceived@1006 : Decimal;VAR QtyToBeReceivedBase@1005 : Decimal;VAR QtyToBeInvoiced@1004 : Decimal;VAR QtyToBeInvoicedBase@1003 : Decimal;VAR ItemLedgShptEntryNo@1002 : Integer;VAR ItemChargeNo@1001 : Code[20];VAR TrackingSpecification@1000 : Record 336;CommitIsSupressed@1009 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePostAssocItemJnlLine@233(VAR ItemJournalLine@1000 : Record 83;VAR SalesLine@1001 : Record 37;CommitIsSupressed@1002 : Boolean;VAR PurchaseLine@1003 : Record 39);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePostItemChargePerOrder@238(VAR PurchHeader@1004 : Record 38;VAR PurchLine@1003 : Record 39;VAR ItemJnlLine2@1002 : Record 83;VAR ItemChargePurchLine@1001 : Record 39;VAR TempTrackingSpecificationChargeAssmt@1000 : TEMPORARY Record 336;CommitIsSupressed@1005 : Boolean;VAR TempItemChargeAssgntPurch@1006 : TEMPORARY Record 5805);
    BEGIN
    END;

    [Integration(TRUE)]
    LOCAL PROCEDURE OnBeforePostItemJnlLineJobConsumption@251(VAR ItemJournalLine@1000 : Record 83;PurchaseLine@1001 : Record 39;PurchInvHeader@1002 : Record 122;PurchCrMemoHdr@1003 : Record 124;QtyToBeInvoiced@1004 : Decimal;QtyToBeInvoicedBase@1005 : Decimal;SourceCode@1006 : Code[10]);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePostItemTrackingForReceiptCondition@289(PurchaseLine@1000 : Record 39;PurchRcptLine@1001 : Record 121;VAR Condition@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePostItemTrackingForShipmentCondition@292(PurchaseLine@1002 : Record 39;ReturnShipmentLine@1001 : Record 6651;VAR Condition@1000 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePostResourceLine@331(PurchaseHeader@1000 : Record 38;VAR PurchaseLine@1001 : Record 39;VAR IsHandled@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePostUpdateOrderLine@262(PurchHeader@1000 : Record 38;VAR TempPurchLineGlobal@1001 : TEMPORARY Record 39);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePostUpdateOrderLineModifyTempLine@28(VAR TempPurchaseLine@1000 : TEMPORARY Record 39;WhseShip@1001 : Boolean;WhseReceive@1002 : Boolean;CommitIsSuppressed@1003 : Boolean;PurchHeader@1004 : Record 38);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeRevertWarehouseEntry@305(VAR WarehouseJournalLine@1000 : Record 7311;JobNo@1001 : Code[20];PostJobConsumption@1002 : Boolean;VAR Result@1004 : Boolean;VAR IsHandled@1003 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeSendICDocument@319(VAR PurchHeader@1000 : Record 38;VAR ModifyHeader@1001 : Boolean;VAR IsHandled@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeTempDeferralLineInsert@306(VAR TempDeferralLine@1000 : TEMPORARY Record 1702;DeferralLine@1001 : Record 1702;PurchaseLine@1002 : Record 39;VAR DeferralCount@1003 : Integer;VAR TotalDeferralCount@1004 : Integer);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeTempDropShptPostBufferInsert@325(VAR TempDropShptPostBuffer@1000 : TEMPORARY Record 223;PurchaseLine@1001 : Record 39);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeTempPrepmtPurchLineInsert@248(VAR TempPrepmtPurchLine@1000 : TEMPORARY Record 39;VAR TempPurchLine@1001 : TEMPORARY Record 39;PurchaseHeader@1002 : Record 38;CompleteFunctionality@1003 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeTempPrepmtPurchLineModify@246(VAR TempPrepmtPurchLine@1000 : TEMPORARY Record 39;VAR TempPurchLine@1001 : TEMPORARY Record 39;PurchaseHeader@1002 : Record 38;CompleteFunctionality@1003 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeUpdateBlanketOrderLine@318(PurchLine@1003 : Record 39;Receive@1002 : Boolean;Ship@1001 : Boolean;Invoice@1000 : Boolean;VAR IsHandled@1004 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeUpdatePurchaseHeader@324(VAR VendorLedgerEntry@1000 : Record 25;VAR PurchInvHeader@1001 : Record 122;VAR PurchCrMemoHdr@1002 : Record 124;GenJnlLineDocType@1003 : Option;VAR IsHandled@1004 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeUpdatePurchLineBeforePost@199(VAR PurchaseLine@1000 : Record 39;VAR PurchaseHeader@1001 : Record 38;WhseShip@1002 : Boolean;WhseReceive@1003 : Boolean;RoundingLineInserted@1004 : Boolean;CommitIsSupressed@1005 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeUpdateInvoicedQtyOnPurchRcptLine@231(VAR PurchRcptLine@1000 : Record 121;VAR QtyToBeInvoiced@1001 : Decimal;VAR QtyToBeInvoicedBase@1002 : Decimal;CommitIsSupressed@1003 : Boolean;VAR PurchInvHeader@1004 : Record 122;VAR PurchaseHeader@1005 : Record 38;VAR PurchaseLine@1006 : Record 39);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeUpdatePrepmtPurchLineWithRounding@252(VAR PrepmtPurchLine@1004 : Record 39;TotalRoundingAmount@1003 : ARRAY [2] OF Decimal;TotalPrepmtAmount@1002 : ARRAY [2] OF Decimal;FinalInvoice@1001 : Boolean;PricesInclVATRoundingAmount@1000 : ARRAY [2] OF Decimal;VAR TotalPurchLine@1005 : Record 39;VAR TotalPurchLineLCY@1006 : Record 39);
    BEGIN
    END;

    [Integration(DEFAULT,TRUE)]
    LOCAL PROCEDURE OnBeforeTestPurchLine@1006(VAR PurchaseLine@1000 : Record 39;VAR PurchaseHeader@1001 : Record 38;CommitIsSupressed@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeTestPurchLineFixedAsset@311(PurchaseLine@1000 : Record 39;VAR IsHandled@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeTestPurchLineItemCharge@309(PurchaseLine@1000 : Record 39;VAR IsHandled@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeTestPurchLineJob@310(PurchaseLine@1000 : Record 39;VAR IsHandled@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeTestPurchLineOthers@312(PurchaseLine@1000 : Record 39;VAR IsHandled@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeUpdateHandledICInboxTransaction@321(VAR PurchaseHeader@1000 : Record 38;VAR IsHandled@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeValidatePostingAndDocumentDate@220(VAR PurchaseHeader@1000 : Record 38;CommitIsSupressed@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeWhseHandlingRequired@316(PurchaseLine@1000 : Record 39;VAR Required@1001 : Boolean;VAR IsHandled@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeFillDeferralPostingBuffer@229(VAR PurchLine@1002 : Record 39;VAR TempInvoicePostBuffer@1001 : TEMPORARY Record 49;VAR InvoicePostBuffer@1000 : Record 49;UseDate@1003 : Date;InvDefLineNo@1004 : Integer;DeferralLineNo@1005 : Integer;CommitIsSupressed@1006 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeGetCountryCode@264(SalesHeader@1000 : Record 36;SalesLine@1001 : Record 37;VAR CountryRegionCode@1003 : Code[10];VAR IsHandled@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnCheckAndUpdateOnBeforeCalcInvDiscount@170(VAR PurchaseHeader@1000 : Record 38;WarehouseReceiptHeader@1001 : Record 7316;WarehouseShipmentHeader@1002 : Record 7320;WhseReceive@1003 : Boolean;WhseShip@1004 : Boolean;VAR RefreshNeeded@1005 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnCheckAssocOrderLinesOnBeforeCheckOrderLine@323(PurchaseHeader@1000 : Record 38;PurchaseLine@1001 : Record 39;VAR IsHandled@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnCopyAndCheckItemChargeOnBeforeLoop@266(VAR TempPurchLine@1000 : TEMPORARY Record 39;PurchHeader@1001 : Record 38);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnCopyToTempLinesOnAfterSetFilters@279(VAR PurchaseLine@1000 : Record 39;PurchaseHeader@1001 : Record 38);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnFillInvoicePostBufferOnAfterInitAmounts@269(PurchHeader@1004 : Record 38;VAR PurchLine@1003 : Record 39;VAR PurchLineACY@1002 : Record 39;VAR TempInvoicePostBuffer@1001 : TEMPORARY Record 49;VAR InvoicePostBuffer@1000 : Record 49;VAR TotalAmount@1005 : Decimal;VAR TotalAmountACY@1006 : Decimal);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnFillInvoicePostingBufferOnAfterUpdateInvoicePostBuffer@300(PurchaseHeader@1000 : Record 38;PurchaseLine@1001 : Record 39;VAR InvoicePostBuffer@1002 : Record 49;VAR TempInvoicePostBuffer@1003 : TEMPORARY Record 49);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnGetItemChargeLineOnAfterGet@268(VAR ItemChargePurchLine@1000 : Record 39;PurchHeader@1001 : Record 38);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnInsertICGenJnlLineOnBeforeICGenJnlLineInsert@320(VAR TempICGenJournalLine@1000 : TEMPORARY Record 81;PurchaseHeader@1001 : Record 38;PurchaseLine@1002 : Record 39;CommitIsSuppressed@1003 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnPostInvoicePostingBufferOnAfterVATPostingSetupGet@322(VAR VATPostingSetup@1000 : Record 325);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnPostItemChargeOnBeforePostItemJnlLine@496(VAR PurchaseLineToPost@1000 : Record 39;VAR PurchaseLine@1001 : Record 39;QtyToAssign@1002 : Decimal);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnPostItemChargePerOrderOnAfterCopyToItemJnlLine@259(VAR ItemJournalLine@1000 : Record 83;VAR PurchaseLine@1001 : Record 39;GeneralLedgerSetup@1002 : Record 98;QtyToInvoice@1003 : Decimal;VAR TempItemChargeAssignmentPurch@1004 : TEMPORARY Record 5805);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnPostItemChargePerSalesRetRcptOnBeforeTestJobNo@314(ReturnReceiptLine@1000 : Record 6661;VAR IsHandled@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnPostItemChargePerSalesShptOnBeforeTestJobNo@315(SalesShipmentLine@1000 : Record 111;VAR IsHandled@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnPostItemChargePerRetShptOnBeforeTestJobNo@307(ReturnShipmentLine@1000 : Record 6651;VAR IsHandled@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnPostItemJnlLineOnAfterCopyDocumentFields@34(VAR ItemJournalLine@1000 : Record 83;PurchaseLine@1001 : Record 39;WarehouseReceiptHeader@1002 : Record 7316;WarehouseShipmentHeader@1003 : Record 7320);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnPostItemJnlLineOnBeforeCopyDocumentFields@286(VAR ItemJournalLine@1000 : Record 83;PurchaseHeader@1001 : Record 38;PurchaseLine@1002 : Record 39;WhseReceive@1003 : Boolean;WhseShip@1004 : Boolean;InvtPickPutaway@1005 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnPostItemJnlLineJobConsumption@50(PurchHeader@1007 : Record 38;VAR PurchLine@1006 : Record 39;ItemJournalLine@1005 : Record 83;VAR TempPurchReservEntry@1004 : TEMPORARY Record 337;QtyToBeInvoiced@1003 : Decimal;QtyToBeReceived@1002 : Decimal;VAR TempTrackingSpecification@1001 : TEMPORARY Record 336;PurchItemLedgEntryNo@1000 : Integer;VAR IsHandled@1008 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnPostItemJnlLineOnAfterSetFactor@54(VAR PurchaseLine@1000 : Record 39;VAR Factor@1001 : Decimal);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnPostItemJnlLineOnAfterPrepareItemJnlLine@326(VAR ItemJournalLine@1000 : Record 83;PurchaseLine@1001 : Record 39;PurchaseHeader@1002 : Record 38);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnPostPurchLineOnAfterSetEverythingInvoiced@290(PurchaseLine@1000 : Record 39;VAR EverythingInvoiced@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnPostUpdateInvoiceLineOnAfterPurchOrderLineModify@260(VAR PurchaseLine@1000 : Record 39;VAR TempPurchaseLine@1001 : TEMPORARY Record 39);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnPostUpdateOrderLineOnBeforeInitOutstanding@327(VAR PurchaseHeader@1000 : Record 38;VAR TempPurchaseLine@1001 : TEMPORARY Record 39);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnReleasePurchDocumentOnBeforeSetStatus@295(VAR PurchaseHeader@1000 : Record 38;VAR IsHandled@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnRoundAmountOnBeforeIncrAmount@258(PurchaseHeader@1000 : Record 38;VAR PurchaseLine@1001 : Record 39;PurchLineQty@1002 : Decimal;VAR TotalPurchLine@1003 : Record 39;VAR TotalPurchLineLCY@1004 : Record 39);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnRunOnBeforeFinalizePosting@371(VAR PurchaseHeader@1000 : Record 38;VAR PurchRcptHeader@1001 : Record 120;VAR PurchInvHeader@1002 : Record 122;VAR PurchCrMemoHdr@1003 : Record 124;VAR ReturnShipmentHeader@1004 : Record 6650;VAR GenJnlPostLine@1005 : Codeunit 12;CommitIsSuppressed@1006 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnUpdateAssocOrderOnAfterSalesOrderLineModify@349(VAR SalesOrderLine@1000 : Record 37;VAR TempDropShptPostBuffer@1001 : TEMPORARY Record 223);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnUpdateBlanketOrderLineOnBeforeCheck@296(VAR BlanketOrderPurchLine@1000 : Record 39;PurchaseLine@1001 : Record 39;VAR IsHandled@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnUpdateBlanketOrderLineOnBeforeInitOutstanding@276(VAR BlanketOrderPurchaseLine@1000 : Record 39;PurchaseLine@1001 : Record 39;Ship@1002 : Boolean;Receive@1003 : Boolean;Invoice@1004 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnUpdateWhseDocumentsOnAfterUpdateWhseRcpt@328(VAR WarehouseReceiptHeader@1000 : Record 7316);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnUpdateWhseDocumentsOnAfterUpdateWhseShpt@330(VAR WarehouseShipmentHeader@1000 : Record 7320);
    BEGIN
    END;

    PROCEDURE SetReceiptsInBundles@1100525033();
    BEGIN
      //**4PS
      ReceiptsInBundles := TRUE;
    END;

    LOCAL PROCEDURE PostJobServicePlant@1100525001(PurchHeader@1100525006 : Record 38;PurchLine@1100525005 : Record 39;InvoicePostBuffer@1100525012 : Record 49);
    VAR
      PurchRcptLine@1100525007 : Record 121;
      lvWageCompRec@1100525004 : Record 11012014;
      lvPostJobJnl@1100525000 : Boolean;
      lvWIPAccNo@1100525002 : Code[20];
      lvCompName@1100525001 : Text[50];
      DimMgt@1100525003 : Codeunit 408;
      DimVal@1100525008 : Record 349;
      ICJobSetup@1100525009 : Record 315;
      JobJnlLine@1100525010 : Record 11072008;
      ServJnlLine@1100525011 : Record 11012820;
      DummyJobJnlLine@1100525014 : Record 11072008;
      DummyServJnlLine@1100525013 : Record 11012820;
      PurchaseLineExtension@1100525015 : Record 11020644;
    BEGIN
      //**4PS
      JobLedgEntryNo := 0;
      ServLedgEntryNo := 0;
      WITH PurchHeader DO BEGIN
        IF (PurchSetup."Preregister WIP Purch. Inv.") AND
           (PurchSetup."Preregistration WIP Account" = PurchLine."No.") AND
           (PurchLine.Type = PurchLine.Type::"G/L Account") THEN
          lvPostJobJnl := FALSE
        ELSE
          lvPostJobJnl := TRUE;

        IF (lvPostJobJnl) AND
           (PurchLine."Receiving Company" = '') AND
           (PurchLine."Job No." <> '') AND
           (("Amounts only" AND (PurchLine."Amnt. to Invoice" <> 0)) OR
            ((NOT "Amounts only") AND (PurchLine."Qty. to Invoice" <> 0)))
        THEN BEGIN
          PurchLine.TESTFIELD("Shortcut Dimension 2 Code");
          DimMgt.GetDimValueRec(2,PurchLine."Shortcut Dimension 2 Code",DimVal,TRUE,PurchLine."Job No.");

          IF PurchLine."Receiving Company" <> '' THEN
            lvCompName := PurchLine."Receiving Company"
          ELSE
            lvCompName := COMPANYNAME;

          ICJobSetup.CHANGECOMPANY(lvCompName);
          ICJobSetup.GET;
          lvWIPAccNo := ProjectType.GetCostAccountRentalUnit(
            Project."Project Type",
            DimVal."Cost Type",
            Project."Project Status",
            ICJobSetup."Provisions at Closure",
            lvCompName,
            DimVal."Cost Type",
            PurchHeader."Buy-from Vendor No.",
            PurchLine."Rental Unit");
          IF PurchLine."No." <> lvWIPAccNo THEN
            PurchLine.FIELDERROR("No.", STRSUBSTNO(Text11012000, lvWIPAccNo));

          // Post job entries
          JobJnlLine.INIT;
          JobJnlLine."Posting Date" := "Posting Date";
          JobJnlLine."Document Date" := "Document Date";
          JobJnlLine."Country/Region Code" := "VAT Country/Region Code";
          JobJnlLine."Reason Code" := "Reason Code";
          JobJnlLine."Job No." := PurchLine."Job No.";
          JobJnlLine.Element := PurchLine.Element;
          JobJnlLine."Extension Contract" := PurchLine."Extension Contract";
          JobJnlLine."Item No." := PurchLine."Item No.";
          JobJnlLine."Basic Item" := PurchLine."Basic Item";
          JobJnlLine."Trade Item" := PurchLine."Trade Item";
          JobJnlLine."Vendor (Trade Item)" := PurchLine."Vendor (Trade Item)";
          JobJnlLine.Manufacturer := PurchLine.Manufacturer;
          JobJnlLine."Service Order No." := PurchLine."Service Order No.";
          JobJnlLine."Service Contract No." := PurchLine."Service Contract No.";
          JobJnlLine."Service Location No." := PurchLine."Service Location No.";
          JobJnlLine."Purchase Action" := PurchLine."Purchase Action";
          JobJnlLine."Employee No." := PurchLine."Employee No.";
          JobJnlLine."Wage Component" := PurchLine."Wage Component";
          JobJnlLine.Vendor := PurchLine."Buy-from Vendor No.";
          JobJnlLine."Document Line No." := PurchLine."Line No."; //db, 24-08-04
          JobJnlLine."Rental Unit" := PurchLine."Rental Unit";
          JobJnlLine."Cost Component" := PurchLine."Cost Component";
          JobJnlLine."Removal Contribution" := PurchLine."Removal Contribution";
          JobJnlLine."Plot No." := PurchLine."Plot No.";
          JobJnlLine."Country/Region of Origin/Dest." := PurchHeader."Country of Destination";
          JobJnlLine."Tariff No." := PurchLine."Tariff No.";
          JobJnlLine."Net Weight" := PurchLine."Net Weight";
          IF (PurchLine."Receipt No." <> '') THEN
            JobJnlLine."Execution Date" := PurchRcptLine."Posting Date";
          IF JobJnlLine."Execution Date" = 0D THEN
            JobJnlLine."Execution Date" := JobJnlLine."Posting Date";
          JobJnlLine."No." := lvWIPAccNo;
          JobJnlLine."Variant Code" := PurchLine."Variant Code";
          JobJnlLine.Description := PurchLine.Description;
          JobJnlLine."Description 2" := PurchLine."Description 2";
          JobJnlLine."Unit of Measure Code" := PurchLine."Unit of Measure Code";
          JobJnlLine."Location Code" := PurchLine."Location Code";
          JobJnlLine."Posting Group" := PurchLine."Posting Group";
          JobJnlLine."Shortcut Dimension 1 Code" := PurchLine."Shortcut Dimension 1 Code";
          JobJnlLine."Shortcut Dimension 2 Code" := PurchLine."Shortcut Dimension 2 Code";
          JobJnlLine."Dimension Set ID" := PurchLine."Dimension Set ID";
          JobJnlLine."Gen. Bus. Posting Group" := PurchLine."Gen. Bus. Posting Group";
          JobJnlLine."Gen. Prod. Posting Group" := PurchLine."Gen. Prod. Posting Group";
          JobJnlLine."Transaction Type" := PurchLine."Transaction Type";
          JobJnlLine."Transport Method" := PurchLine."Transport Method";
          JobJnlLine."Entry/Exit Point" := PurchLine."Entry Point";
          JobJnlLine.Area := PurchLine.Area;
          JobJnlLine."Transaction Specification" := PurchLine."Transaction Specification";
          JobJnlLine."Entry Type" := JobJnlLine."Entry Type"::Usage;
          JobJnlLine."Document No." := GenJnlLineDocNo;
          JobJnlLine."External Document No." := GenJnlLineExtDocNo;
          JobJnlLine.Type := 3 - PurchLine.Type;
          JobJnlLine.Quantity := PurchLine."Qty. to Invoice";
          JobJnlLine."Quantity (Base)" := PurchLine."Qty. to Invoice (Base)";
          JobJnlLine."Source Code" := SrcCode;
          JobJnlLine."Posting No. Series" := "Posting No. Series";
          JobJnlLine."Source Currency Code" := "Currency Code";
          JobJnlLine."Cost Plus Entry Created" := PurchLine."Cost Plus Entry Created";
          PurchaseLineExtension.GetPurchLineExtension(
            PurchLine."Document Type", PurchLine."Document No.", PurchLine."Line No.");
          JobJnlLine."Yard No." := PurchaseLineExtension."Yard No.";
          JobJnlLine."System No." := PurchaseLineExtension."System No.";
          JobJnlLine."Entity Type" := PurchLine."Entity Type";
          JobJnlLine."Entity No." := PurchaseLineExtension."Entity No.";
          JobJnlLine."Cable Transit Pos." := PurchaseLineExtension."Cable Transit Pos.";

          JobJnlLine."Total Cost (LCY)" := InvoicePostBuffer.Amount + InvoicePostBuffer."Retention Amount";
          JobJnlLine."Total Cost" := InvoicePostBuffer."Amount (ACY)" + InvoicePostBuffer."Retention Amount (ACY)";
          IF NOT "Amounts only" THEN
            JobJnlLine."Direct Unit Cost (LCY)" := ROUND(JobJnlLine."Total Cost (LCY)" / JobJnlLine.Quantity)
          ELSE
            JobJnlLine."Direct Unit Cost (LCY)" := JobJnlLine."Total Cost (LCY)";
          JobJnlLine."Source Currency Total Cost" :=
            InvoicePostBuffer."Amount (ACY)" + InvoicePostBuffer."Retention Amount (ACY)";
          IF (JobJnlLine."Source Currency Code" <> '') THEN
            JobJnlLine."Total Cost" := JobJnlLine."Source Currency Total Cost";
          JobJnlLine."Sales Price Purch. Order" := PurchLine."Sales Price";

          IF (PurchLine."Cost Type" = PurchLine."Cost Type"::Labor) AND
             (PurchLine."Wage Component" <> '') THEN
            IF lvWageCompRec.GET(PurchLine."Wage Component") THEN
              IF lvWageCompRec."Component Type" = lvWageCompRec."Component Type"::Expenses THEN BEGIN
                JobJnlLine.Quantity := 0;
                JobJnlLine."Quantity (Base)" := 0;
                JobJnlLine."Unit Cost (LCY)" := JobJnlLine."Direct Unit Cost (LCY)";
              END;
          JobJnlLine."Qty. per Unit of Measure" := PurchLine."Qty. per Unit of Measure";
          JobJnlLine."FSC Type Code" := PurchLine."FSC Type Code";
          JobJnlLine.Comment := GetCommentForProjEntry(PurchLine, MAXSTRLEN(JobJnlLine.Comment));
          JobJnlLine.Text := PurchLine.Text;
          JobJnlLine."Purchase Route Reference" := PurchLine."Purchase Route Reference";  //DP01727
          //**4PS.en

          JobJnlPostLine.RunWithCheck(JobJnlLine);
          JobLedgEntryNo := JobJnlPostLine.GetJobLedgEntryNo;
          JobJnlLine."Sales Price Purch. Order" := 0;
          JobJnlLine.Comment := ''; //Not in surcharges

          PostComplementaryWIPCostProj(PurchHeader,PurchLine,JobJnlLine);
          PostSurcharge(PurchHeader,PurchLine,JobJnlLine,DummyServJnlLine,0);
        END ELSE BEGIN
          IF (PurchLine."Job No." <> '') AND ((PurchLine."Qty. to Receive" <> 0) OR (PurchLine."Return Qty. to Ship" <> 0)) THEN
            JobJnlPostLine.TestJob(PurchLine."Job No.", PurchLine."Receiving Company",
              (PurchLine."Employee No." <> '') AND (PurchLine."Wage Component" <> ''));
        END;

        IF (PurchLine."Receiving Company" = '') AND
           (PurchLine."Service Order No." <> '') AND
           (("Amounts only" AND (PurchLine."Amnt. to Invoice" <> 0)) OR
            ((NOT "Amounts only") AND (PurchLine."Qty. to Invoice" <> 0)))
        THEN BEGIN
          PostService(PurchHeader,PurchLine,PurchRcptLine,InvoicePostBuffer,ServJnlLine);
          PostComplementaryWIPCostServ(PurchHeader,PurchLine,ServJnlLine);
          PostSurcharge(PurchHeader,PurchLine,DummyJobJnlLine,ServJnlLine,1);
        END;

        IF (PurchLine."Plant Type" <> '') AND
           (("Document Type" IN ["Document Type"::Invoice, "Document Type"::"Credit Memo"]) OR
            (("Document Type" = "Document Type"::Order) AND Receive AND Invoice)) AND
           (PurchLine.Type IN [PurchLine.Type::"G/L Account", PurchLine.Type::"Fixed Asset"])
        THEN
          PostPlant(PurchHeader,PurchLine);

        IF ("Document Type" = "Document Type"::Invoice) OR
           (("Document Type" = "Document Type"::Order) AND Receive AND Invoice)
        THEN BEGIN
          IF (PurchLine.Type = PurchLine.Type::"Fixed Asset") THEN
            FA_PlantIntegration(PurchLine);
          IF (PurchLine."Plant No." <> '') THEN
            UpdatePlantNoPurchPrice(PurchLine);
        END;

        IF ("Document Type" IN ["Document Type"::Invoice, "Document Type"::"Credit Memo"]) AND
           (PurchLine."Ext. Rented Plant Invoiced to" <> 0D)
        THEN
          UpdatePlantNoExtRentDate(PurchLine);
      END;
    END;

    LOCAL PROCEDURE CreateICEntry@5818(PurchHeader@1100525003 : Record 38;PurchLine@1100525001 : Record 39;IntercompanyRelation@1100525002 : Record 11012057);
    VAR
      NewLineNo@11012000 : Integer;
      IntercompanyEntry@1100525000 : Record 11012058;
    BEGIN
      //**4PS
      WITH IntercompanyEntry DO BEGIN
        LOCKTABLE;
        IF FINDLAST THEN
          NewLineNo := "Line No." + 1
        ELSE
          NewLineNo := 1;

        INIT;
        "Line No." := NewLineNo;
        "Post in Company" := PurchLine."Receiving Company";
        "Supplying Company" := COMPANYNAME;
        "Receiving Company" := PurchLine."Receiving Company";
        "Account No." := IntercompanyRelation."Receiving Company IC Account";
        "Account Type" := "Account Type"::"G/L Account";
        "Bal. Account No." := PurchLine."No.";
        Description := PurchLine.Description;
        "Description 2" := PurchLine."Description 2";
        "Project No." := PurchLine."Job No.";
        Element := PurchLine.Element;
        "Extension Contract" := PurchLine."Extension Contract";
        "Service Order No." := PurchLine."Service Order No.";
        "Service Contract No." := PurchLine."Service Contract No.";
        "Service Location No." := PurchLine."Service Location No.";
        "Additional Cost (Service)" := PurchLine."Additional Cost (Service)";
        "Item No." := PurchLine."Item No.";
        "Basic Item" := PurchLine."Basic Item";
        "Trade Item" := PurchLine."Trade Item";
        Manufacturer := PurchLine.Manufacturer;
        "Vendor (Trade Item)" := PurchLine."Vendor (Trade Item)";
        "Cost Object" := PurchLine."Shortcut Dimension 2 Code";
        "Global Dimension 1 Code" := PurchLine."Shortcut Dimension 1 Code";
        "Dimension Set ID" := PurchLine."Dimension Set ID";
        Quantity := PurchLine.Quantity;
        "Unit of Measure Code" := PurchLine."Unit of Measure Code";
        //Amount := PurchLine.Amount;  //db, 03-01-19: original amount (in FCY) converted to LCY by function RoundAmount
        Amount := PurchLine."VAT Base Amount";  //excl.VAT
        IF Quantity = 0 THEN
          Price := Amount
        ELSE
          Price := Amount / Quantity;
        "Document No." := PurchLine."Document No.";
        "Vendor No." := PurchLine."Buy-from Vendor No.";
        "Posting Date" := PurchLine."Posting Date";
        "Interest Date" := PurchHeader."Interest Date";
        IF PurchLine."Plant Type" <> '' THEN
          PurchLine.TESTFIELD("Cost Component Plant");
        "Plant Type" := PurchLine."Plant Type";
        "Plant No." := PurchLine."Plant No.";
        "Cost Component Plant" := PurchLine."Cost Component Plant";
        "Cost Component" := PurchLine."Cost Component";
        "Posting Group" := PurchLine."Posting Group";
        "Employee No." := PurchLine."Employee No.";

        CheckProjStatusReceivingComp;
        CheckProjElemBlockedRecComp;

        AddICRelationDims(IntercompanyRelation);
        IF "Global Dimension 1 Code" <> '' THEN
          CheckGlobalDimAllowed(1, "Global Dimension 1 Code");
        IF "Cost Object" <> '' THEN
          CheckGlobalDimAllowed(2, "Cost Object");

        INSERT(TRUE);
        "Currency Code" := GLSetup.GetCurrencyCode(PurchLine."Currency Code");  //DP02206
        MODIFY;
      END;
    END;

    LOCAL PROCEDURE UpdateReceiptBalance@5817(PurchLine@11012000 : Record 39);
    BEGIN
      //**4PS
      IF PurchLine."Receipt No." = '' THEN
        EXIT;

      PurchRcptHeader.GET(PurchLine."Receipt No.");
      PurchRcptHeader.CALCFIELDS(Received, Invoiced);
      PurchRcptHeader."Received Not Invoiced" := PurchRcptHeader.Received - PurchRcptHeader.Invoiced;
      PurchRcptHeader.MODIFY;
    END;

    LOCAL PROCEDURE PostSurchargeForExternalIndirectHours@1100528400(PurchHeader@1100525002 : Record 38;PurchLine@1100525000 : Record 39);
    VAR
      HumanResourcesSetup@1100528401 : Record 5218;
      Employee@1100528402 : Record 5200;
      DummyJobJnlLine@1100525006 : Record 11072008;
      DummyServJnlLine@1100525005 : Record 11012820;
      Origin@1100528400 : 'Project,Service,Indirect';
    BEGIN
      //**4PS
      IF PurchLine."Employee No." = '' THEN
        EXIT;
      IF PurchLine."Document Type" <> PurchLine."Document Type"::Invoice THEN
        EXIT;
      IF PurchLine."Receiving Company" <> '' THEN
        EXIT;
      IF PurchLine."Job No." <> '' THEN
        EXIT;
      IF PurchLine."Service Order No." <> '' THEN
        EXIT;
      IF PurchLine."Wage Component" = '' THEN
        EXIT;
      IF NOT HumanResourcesSetup.GET THEN
        EXIT;
      IF HumanResourcesSetup."Charge Costs Extern. Employees" <> HumanResourcesSetup."Charge Costs Extern. Employees"::"Posting Invoices" THEN
        EXIT;
      IF NOT Employee.GET(PurchLine."Employee No.") THEN
        EXIT;
      IF NOT Employee.External THEN
        EXIT;

      PostSurcharge(PurchHeader,PurchLine,DummyJobJnlLine,DummyServJnlLine,Origin::Indirect);
    END;

    LOCAL PROCEDURE FillGenJnlLineForExternalIndirectHours@1100528401(PurchHeader@1100525002 : Record 38;PurchLine@1100525001 : Record 39;VAR GenJnlLine@1100525000 : Record 81);
    VAR
      PurchRcptLine@1100528400 : Record 121;
      PurchOrderLine@1100528401 : Record 39;
    BEGIN
      //**4PS
      GenJnlLine."Employee No." := PurchLine."Employee No.";
      GenJnlLine."Document No." := PurchLine."Document No.";
      GenJnlLine."Source Code" := SrcCode;
      GenJnlLine."Reason Code" := PurchLine."Reason Code";
      GenJnlLine."Shortcut Dimension 1 Code" := PurchLine."Shortcut Dimension 1 Code";
      GenJnlLine."Shortcut Dimension 2 Code" := PurchLine."Shortcut Dimension 2 Code";
      GenJnlLine."Dimension Set ID" := PurchLine."Dimension Set ID";
      GenJnlLine."Wage Component" := PurchLine."Wage Component";
      GenJnlLine."Cost Component" := PurchLine."Cost Component";
      GenJnlLine."System-Created Entry" := TRUE;
      GenJnlLine."Account Type" := GenJnlLine."Account Type"::"G/L Account";
      GenJnlLine."Posting Date" := PurchHeader."Posting Date";
      GenJnlLine."Account No." := PurchLine."No.";
      GenJnlLine.Description := PurchLine.Description;
      GenJnlLine."Interest Date" := GenJnlLine."Posting Date";
      GenJnlLine.Amount := PurchLine.Amount;
      GenJnlLine.VALIDATE(Amount);
      GenJnlLine.Quantity := PurchLine.Quantity;
      IF PurchRcptLine.GET(PurchLine."Receipt No.", PurchLine."Receipt Line No.") THEN
        IF PurchOrderLine.GET(
          PurchOrderLine."Document Type"::Order, PurchRcptLine."Order No.", PurchRcptLine."Order Line No.")
        THEN BEGIN
          GenJnlLine."Purchase Order" := PurchOrderLine."Document No.";
          GenJnlLine."Purchase Order Line No." := PurchOrderLine."Line No.";
        END;
    END;

    LOCAL PROCEDURE PostSurcharge@1210190008(PurchHeader@1100525003 : Record 38;PurchLine@1100525002 : Record 39;JobJnlLine@1100525005 : Record 11072008;ServJnlLine@1100525006 : Record 11012820;Origin@1210190002 : 'Project,Service,Indirect');
    VAR
      GenJnlLine@1100525001 : Record 81;
      PostingMgt@1100525000 : Codeunit 11012360;
    BEGIN
      //**4PS
      IF Origin = Origin::Indirect THEN
        FillGenJnlLineForExternalIndirectHours(PurchHeader,PurchLine,GenJnlLine);
      PostingMgt.SetPostingFromPurchLine(PurchLine,PurchHeader,GenJnlLine);
      PostingMgt.BufferSurcharges(
        Origin,GenJnlLine,JobJnlLine,ServJnlLine,JobJnlPostLine,ServJnlPostLine,TempSurchargePostingBuffer,TempComplWIPPostingBuffer);
    END;

    LOCAL PROCEDURE PostService@1210190000(PurchHeader@1100525003 : Record 38;PurchLine@1100525002 : Record 39;PurchRcptLine@1100525000 : Record 121;InvoicePostBuffer@1100525004 : Record 49;VAR ServJnlLine@1100525001 : Record 11012820);
    VAR
      lvWageCompRec@1100528600 : Record 11012014;
    BEGIN
      //**4PS
      ServJnlLine.INIT;
      ServJnlLine."Service Contract No." := PurchLine."Service Contract No.";
      ServJnlLine.VALIDATE("Service Order No.", PurchLine."Service Order No.");
      ServJnlLine."Service Location No." := PurchLine."Service Location No.";
      IF PurchLine."Document Type" = PurchLine."Document Type"::"Credit Memo" THEN
        ServJnlLine."Document Type" := ServJnlLine."Document Type"::"Purchase Credit Memo"
      ELSE
        ServJnlLine."Document Type" := ServJnlLine."Document Type"::"Purchase Invoice";
      ServJnlLine."Document No." := GenJnlLineDocNo;
      ServJnlLine."Document Line No." := PurchLine."Line No.";
      ServJnlLine."G/L Account" := PurchLine."No.";
      ServJnlLine."Posting Date" := PurchHeader."Posting Date";
      ServJnlLine."Shortcut Dimension 1 Code" := PurchLine."Shortcut Dimension 1 Code";
      ServJnlLine."Shortcut Dimension 2 Code" := PurchLine."Shortcut Dimension 2 Code";
      ServJnlLine."Dimension Set ID" := PurchLine."Dimension Set ID";
      ServJnlLine.Description := PurchLine.Description;
      ServJnlLine."Description 2" := PurchLine."Description 2";
      ServJnlLine.Quantity := PurchLine."Qty. to Invoice";
      ServJnlLine."Unit of Measure Code" := PurchLine."Unit of Measure Code";
      ServJnlLine."Currency Code" := PurchLine."Currency Code";
      ServJnlLine."Total Cost (LCY)" := InvoicePostBuffer.Amount;
      ServJnlLine."Total Cost" := InvoicePostBuffer."Amount (ACY)";
      ServJnlLine."Entry Type" := ServJnlLine."Entry Type"::Usage;
      IF NOT PurchHeader."Amounts only" THEN BEGIN
        ServJnlLine."Unit Cost (LCY)" := ServJnlLine."Total Cost (LCY)" / ServJnlLine.Quantity;
        ServJnlLine."Unit Cost" := ServJnlLine."Total Cost" / ServJnlLine.Quantity;
      END ELSE BEGIN
        ServJnlLine."Unit Cost (LCY)" := ServJnlLine."Total Cost (LCY)";
        ServJnlLine."Unit Cost" := ServJnlLine."Total Cost";
      END;
      ServJnlLine."Reason Code" := PurchHeader."Reason Code";
      ServJnlLine."Source Code" := SrcCode;
      ServJnlLine."Item No." := PurchLine."Item No.";
      ServJnlLine."Basic Item" := PurchLine."Basic Item";
      ServJnlLine."Trade Item" := PurchLine."Trade Item";
      ServJnlLine."Vendor (Trade Item)" := PurchLine."Vendor (Trade Item)";
      ServJnlLine.Manufacturer := PurchLine.Manufacturer;
      ServJnlLine."Project No." := PurchLine."Job No.";
      ServJnlLine."Vendor No." := PurchLine."Buy-from Vendor No.";
      ServJnlLine."Additional Cost" := PurchLine."Additional Cost (Service)";
      ServJnlLine."Employee No." := PurchLine."Employee No.";
      ServJnlLine."Wage Component" := PurchLine."Wage Component";
      ServJnlLine."Cost Component" := PurchLine."Cost Component";
      ServJnlLine."Removal Contribution" := PurchLine."Removal Contribution";
      ServJnlLine."Sales Price Purch. Order" := PurchLine."Sales Price";
      IF (PurchLine."Receipt No." <> '') THEN
        ServJnlLine."Execution Date" := PurchRcptLine."Posting Date";
      IF ServJnlLine."Execution Date" = 0D THEN
        ServJnlLine."Execution Date" := ServJnlLine."Posting Date";
      ServJnlLine."Country/Region of Origin/Dest." := PurchHeader."Country of Destination";
      ServJnlLine."Tariff No." := PurchLine."Tariff No.";
      ServJnlLine."Net Weight" := PurchLine."Net Weight";
      ServJnlLine."Country/Region Code" := PurchHeader."VAT Country/Region Code";
      ServJnlLine."Transaction Type" := PurchLine."Transaction Type";
      ServJnlLine."Transport Method" := PurchLine."Transport Method";
      ServJnlLine."Entry/Exit Point" := PurchLine."Entry Point";
      ServJnlLine.Area := PurchLine.Area;
      ServJnlLine."Cost Plus Entry Created" := PurchLine."Cost Plus Entry Created";
      ServJnlLine.Text := PurchLine.Text;
      ServJnlLine."Qty. per Unit of Measure" := PurchLine."Qty. per Unit of Measure";

      IF (PurchLine."Cost Type" = PurchLine."Cost Type"::Labor) AND
         (PurchLine."Wage Component" <> '') THEN
        IF lvWageCompRec.GET(PurchLine."Wage Component") THEN
          IF lvWageCompRec."Component Type" = lvWageCompRec."Component Type"::Expenses THEN
            ServJnlLine.Quantity := 0;

      ServJnlPostLine.RunWithCheck(ServJnlLine);
      ServLedgEntryNo := ServJnlPostLine.GetServLedgEntryNo;
      ServJnlLine."Sales Price Purch. Order" := 0;
    END;

    LOCAL PROCEDURE CheckGeneratePlantNoOnReceipt@1100485006(PurchHeader@1100525000 : Record 38;PurchLine@1100485000 : Record 39;VAR OExplodeCounter@1100485001 : Integer) : Boolean;
    VAR
      lvPlantSetupRec@1100485004 : Record 11012550;
      lvPlantTypeRec@1100485002 : Record 11012551;
      lvTypeNo@1100485003 : Integer;
    BEGIN
      //**4PS
      OExplodeCounter := 1;
      WITH PurchLine DO BEGIN
        IF PurchHeader."Hours Hire Order Type" = PurchHeader."Hours Hire Order Type"::Plant THEN
          EXIT(FALSE);
        IF NOT (("Plant Type" <> '') AND ("Plant No." = '') AND ("Cost Component Plant" <> '')) THEN
          EXIT(FALSE);

        lvTypeNo := CheckPlantAcquisitionOrRent(PurchLine);
        IF (lvTypeNo = 0) THEN
          EXIT(FALSE);

        TESTFIELD("Receiving Company",''); //* Test needed otherwise error in functions for posting plant no./FA
        lvPlantTypeRec.GET("Plant Type"); //* Change company not needed because "Receiving Company" is empty (see test above).
        IF (lvPlantTypeRec.Bulk) THEN BEGIN
          lvPlantSetupRec.GET;
          IF NOT ((lvTypeNo = 2) AND (NOT lvPlantTypeRec.External) AND lvPlantSetupRec."Ext Bulk Plant with No. in Inv") THEN
            lvPlantTypeRec.TESTFIELD(External, (lvTypeNo=2))
        END ELSE BEGIN
          IF ("Qty. to Receive (Base)" > 0) THEN BEGIN
            TESTFIELD("Qty. to Receive (Base)", ROUND("Qty. to Receive (Base)", 1));
            OExplodeCounter := ROUND("Qty. to Receive (Base)", 1);
          END;
        END;
      END;

      EXIT(TRUE);
    END;

    LOCAL PROCEDURE GeneratePlantNoOnReceipt@1100485000(PurchHeader@1100525000 : Record 38;VAR PurchLine@1100485002 : Record 39;IRcptDocNo@1100485004 : Code[20];IRcptLineNo@1100485005 : Integer) : Code[20];
    VAR
      lvPlantSetupRec@1100485007 : Record 11012550;
      lvPlantTypeRec@1100485006 : Record 11012551;
      lvPlantNoRec@1100485000 : Record 11012552;
      lvPurchOrderRentalRateRec@1100485011 : Record 11020513;
      lvPlantPurchPriceRec@1100485013 : Record 11012597;
      lvPlantPurchDiscRec@1100485014 : Record 11012598;
    BEGIN
      //**4PS
      WITH PurchLine DO BEGIN
        lvPlantSetupRec.GET;
        lvPlantTypeRec.GET("Plant Type");

        lvPlantNoRec.INIT;
        lvPlantNoRec."Plant Type" := "Plant Type";
        lvPlantNoRec."No." := '';
        lvPlantNoRec.INSERT(TRUE);

        lvPlantNoRec.Description := COPYSTR(Description, 1, MAXSTRLEN(lvPlantNoRec.Description));
        lvPlantNoRec.VALIDATE(Description);
        IF NOT lvPlantTypeRec.Bulk THEN
          lvPlantNoRec.Quantity := 1
        ELSE
          lvPlantNoRec.Quantity := "Qty. to Receive (Base)";
        IF ("Shortcut Dimension 1 Code" <> '') THEN
          lvPlantNoRec.VALIDATE("Department Code", "Shortcut Dimension 1 Code")
        ELSE
          lvPlantNoRec.VALIDATE("Department Code", lvPlantTypeRec."Department Code");
        lvPlantNoRec."Exploded on No." := '';
        lvPlantNoRec.VALIDATE(External, CheckPlantAcquisitionOrRent(PurchLine) = 2);
        lvPlantNoRec."Fixed Asset" := '';
        lvPlantNoRec."Purchase Order No." := "Document No.";
        FillPlantNoFieldsCommon(PurchHeader,PurchLine,lvPlantNoRec,lvPlantSetupRec);
        lvPlantNoRec.MODIFY(TRUE);

        IF lvPlantNoRec.External AND lvPlantSetupRec."Save Rent Price on Receipt" THEN BEGIN
          lvPlantPurchPriceRec.INIT;
          lvPlantPurchPriceRec."Price Type" := lvPlantPurchPriceRec."Price Type"::Rent;
          lvPlantPurchPriceRec."Plant Type" := lvPlantNoRec."Plant Type";
          lvPlantPurchPriceRec."Plant No." := lvPlantNoRec."No.";
          lvPlantPurchPriceRec."Vendor No." := lvPlantNoRec.Vendor;
          lvPlantPurchPriceRec."Starting Date" := lvPlantNoRec."Receipt Date";
          lvPlantPurchPriceRec."Currency Code" := '';
          lvPlantPurchPriceRec."Unit of Measure Code" := "Unit of Measure Code";
          lvPlantPurchPriceRec."Minimum Quantity" := 0;
          lvPlantPurchPriceRec."Ending Date" := 0D;
          lvPlantPurchPriceRec."Direct Unit Cost" := "Direct Unit Cost";
          lvPlantPurchPriceRec.INSERT;

          IF "Line Discount %" <> 0 THEN BEGIN
            lvPlantPurchDiscRec.INIT;
            lvPlantPurchDiscRec."Price Type" := lvPlantPurchDiscRec."Price Type"::Rent;
            lvPlantPurchDiscRec."Plant Type" := lvPlantNoRec."Plant Type";
            lvPlantPurchDiscRec."Plant No." := lvPlantNoRec."No.";
            lvPlantPurchDiscRec."Vendor No." := lvPlantNoRec.Vendor;
            lvPlantPurchDiscRec."Starting Date" := lvPlantNoRec."Receipt Date";
            lvPlantPurchDiscRec."Currency Code" := '';
            lvPlantPurchDiscRec."Unit of Measure Code" := "Unit of Measure Code";
            lvPlantPurchDiscRec."Minimum Quantity" := 0;
            lvPlantPurchDiscRec."Ending Date" := 0D;
            lvPlantPurchDiscRec."Line Discount %" := PurchLine."Line Discount %";
            lvPlantPurchDiscRec.INSERT;
          END;
        END;

        IF CheckPlantNoRentalRatesAllowed(PurchLine) THEN BEGIN
          IF lvPurchOrderRentalRateRec.GET("Document No.","Line No.") THEN
            lvPurchOrderRentalRateRec.InsertPlantNumberRentalRates(lvPurchOrderRentalRateRec, lvPlantNoRec."Plant Type", lvPlantNoRec."No.");
        END;

        PostPlantNoOnReceipt(PurchLine, lvPlantNoRec, lvPlantSetupRec, lvPlantTypeRec, IRcptDocNo, IRcptLineNo, FALSE);

      END;

      EXIT(lvPlantNoRec."No.");
    END;

    LOCAL PROCEDURE CheckPostPlantNoOnReceipt@1100525009(PurchHeader@1100525000 : Record 38;VAR PurchLine@1100485000 : Record 39;IRcptDocNo@1100525004 : Code[20];IRcptLineNo@1100525003 : Integer);
    VAR
      lvPlantSetupRec@1100485004 : Record 11012550;
      lvPlantTypeRec@1100485002 : Record 11012551;
      lvPlantNoRec@1100485003 : Record 11012552;
      AcquisitionOrRent@1100525001 : Integer;
    BEGIN
      //**4PS
      //** For unique plant numbers that are create on the Purchase Order with the function 'Create Unique Plant Numbers',
      //** via codeunit 11012243.
      WITH PurchLine DO BEGIN
        IF PurchHeader."Hours Hire Order Type" = PurchHeader."Hours Hire Order Type"::Plant THEN
          EXIT;
        IF ("Plant Type" = '') OR ("Plant No." = '') OR ("Cost Component Plant" = '') OR ("Receiving Company" <> '') THEN
          EXIT;
        IF NOT lvPlantTypeRec.GET("Plant Type") THEN
          EXIT;
        IF lvPlantTypeRec.Bulk THEN
          EXIT;
        IF NOT lvPlantNoRec.GET("Plant Type", "Plant No.") THEN
          EXIT;
        IF lvPlantNoRec.Posted OR (lvPlantNoRec."Purchase Order No." <> "Document No.") THEN
          EXIT;
        AcquisitionOrRent := CheckPlantAcquisitionOrRent(PurchLine);
        IF (AcquisitionOrRent <> 1) AND (AcquisitionOrRent <> 2) THEN
          EXIT;
        IF ((AcquisitionOrRent = 1) AND (lvPlantNoRec.External)) OR ((AcquisitionOrRent = 2) AND (NOT lvPlantNoRec.External)) THEN
          EXIT;

        lvPlantSetupRec.GET;
        lvPlantNoRec.Quantity := 1;
        FillPlantNoFieldsCommon(PurchHeader,PurchLine,lvPlantNoRec,lvPlantSetupRec);
        lvPlantNoRec.MODIFY(TRUE);

        PostPlantNoOnReceipt(PurchLine, lvPlantNoRec, lvPlantSetupRec, lvPlantTypeRec, IRcptDocNo, IRcptLineNo, TRUE);
      END;
    END;

    LOCAL PROCEDURE GetCloseExtRentPlantOnReceipt@1210190003(PurchHeader@1100525000 : Record 38;VAR PurchLine@1210190000 : Record 39) : Boolean;
    BEGIN
      //**4PS
      WITH PurchLine DO BEGIN
        IF NOT PurchSetup."Close Pl.Ext.Rent Ord. on Rcpt" THEN
          EXIT(FALSE);
        IF PurchHeader."Hours Hire Order Type" = PurchHeader."Hours Hire Order Type"::Plant THEN
          EXIT(FALSE);
        IF ("Plant Type" = '') OR ("Plant No." = '') OR ("Cost Component Plant" = '') THEN
          EXIT(FALSE);

        IF CheckPlantAcquisitionOrRent(PurchLine) = 2 THEN
          EXIT(TRUE)
      END;
      EXIT(FALSE);
    END;

    LOCAL PROCEDURE FillPlantNoFieldsCommon@1100525010(PurchHeader@1100525005 : Record 38;VAR PurchLine@1100525000 : Record 39;VAR PlantNoRec@1100525001 : Record 11012552;PlantSetupRec@1100525002 : Record 11012550);
    VAR
      PlantLocRec@1100525003 : Record 11012554;
      PlantOrderRec@1100525004 : Record 11012556;
    BEGIN
      //**4PS
      WITH PurchLine DO BEGIN
        PlantNoRec.Vendor := "Buy-from Vendor No.";
        IF ("Posting Date" <> 0D) THEN
          PlantNoRec."Receipt Date" := "Posting Date"
        ELSE BEGIN
          IF (PurchHeader."Posting Date" <> 0D) THEN
            PlantNoRec."Receipt Date" := PurchHeader."Posting Date"
          ELSE
            PlantNoRec."Receipt Date" := WORKDATE;
        END;
        IF PlantNoRec."Ship To Location" = '' THEN
          PlantNoRec."Ship To Location" := PlantSetupRec.GetShipToLocation;
        IF (PurchHeader.Deliver = PurchHeader.Deliver::"Plant Location") AND (PurchHeader."Ship-to Location" <> '') THEN BEGIN
          IF PlantLocRec.GET(PurchHeader."Ship-to Location") THEN BEGIN
            PlantNoRec."Ship To Location" := PurchHeader."Ship-to Location";
          END;
        END;
        IF PlantSetupRec."Extended Picking Procedure" AND ("Plant Order No." <> '') AND
           ("Direct Delivery Plant" OR PlantNoRec.External)
        THEN BEGIN
          IF PlantOrderRec.GET("Plant Order No.") THEN BEGIN
            IF (PlantOrderRec."From Location" <> '') THEN
              PlantNoRec."Ship To Location" := PlantOrderRec."From Location";
          END;
        END;
      END;
    END;

    LOCAL PROCEDURE PostPlantNoOnReceipt@1100525011(VAR PurchLineRec@1100525002 : Record 39;VAR PlantNoRec@1100525001 : Record 11012552;PlantSetupRec@1100525000 : Record 11012550;PlantTypeRec@1100525008 : Record 11012551;RcptDocNo@1100525004 : Code[20];RcptLineNo@1100525003 : Integer;FillFAOnPurchLine@1100525009 : Boolean);
    VAR
      lvPurchLineRec2@1100525010 : Record 39;
      PostPlantNoCU@1100525006 : Codeunit 11012550;
      ExtendedPlantOrderFuncCU@1100525005 : Codeunit 11020503;
      lvText000@1100525007 : TextConst 'ENU=Plant Receipt of Purchase Order Line %1-%2 can (or may) not be updated automatically in Plant Order %3, Plant No. %4-%5.';
    BEGIN
      //**4PS
      WITH PurchLineRec DO BEGIN
        PostPlantNoCU.SetReceiptMode(RcptDocNo, RcptLineNo, "Expected Enddate Rent");
        PostPlantNoCU.RUN(PlantNoRec);
        IF (Type = Type::"Fixed Asset") AND (PlantNoRec."Fixed Asset" = '') AND
           (NOT PlantNoRec.External) AND (PlantTypeRec."Rental Type" = PlantTypeRec."Rental Type"::Rental) AND
           PlantTypeRec."Integration Fixed Assets"
        THEN BEGIN
          PlantNoRec.CreateFA(TRUE, "Shortcut Dimension 1 Code");
          PlantNoRec.FIND;
          PurchLineRec."No." := PlantNoRec."Fixed Asset";
          IF FillFAOnPurchLine THEN BEGIN
            lvPurchLineRec2 := PurchLineRec;
            lvPurchLineRec2.FIND;
            lvPurchLineRec2."No." := PlantNoRec."Fixed Asset";
            lvPurchLineRec2.MODIFY;
          END
        END;

        IF PlantSetupRec."Extended Picking Procedure" AND ("Plant Order No." <> '') THEN BEGIN
          IF ReceiptForPlantOrders = '' THEN
            ReceiptForPlantOrders := "Plant Order No."
          ELSE BEGIN
            IF (STRPOS(ReceiptForPlantOrders, "Plant Order No.") = 0) AND
               ((STRLEN(ReceiptForPlantOrders) + STRLEN("Plant Order No.") + 2) <=  MAXSTRLEN(ReceiptForPlantOrders))
            THEN
              ReceiptForPlantOrders := ReceiptForPlantOrders + ', ' + "Plant Order No.";
          END;
          IF NOT ExtendedPlantOrderFuncCU.RunUpdateQtyOnReceipt(
             "Document No.", "Line No.", "Plant Order No.", "Plant Order Line No.", "Plant Type", PlantNoRec."No.")
          THEN
            MESSAGE(lvText000, "Document No.", "Line No.", "Plant Order No.", "Plant Type", PlantNoRec."No.");
        END;
      END;
    END;

    LOCAL PROCEDURE ItemReceiptOnPlantOrder@1100485005(PurchLine@1100485001 : Record 39);
    VAR
      lvText000@1100485000 : TextConst 'ENU=Item Receipt of Purchase Order Line %1-%2 can (or may) not be updated automatically in Plant Order %3, Item No. %4.;NOR=Artikkelkvittering av Innkj›psordrerad %1-%2 kan (eller f†r) ikke oppdateres automatisk i maskinordre %3, artikkelnr %4.;SVE=Artikelinleverans av ink”psorderrad %1-%2 kan (eller f†r) inte uppdateras automatiskt i Maskinsorder %3, artikelnr %4.';
      lvPlantSetupRec@1100485003 : Record 11012550;
      lvExtendedPlantOrderFuncCU@1100485002 : Codeunit 11020503;
    BEGIN
      //**4PS
      //* Update quantity on plant order-item line.
      WITH PurchLine DO BEGIN
        IF ("Item No." = '') OR ("Plant Type" <> '') OR ("Plant Order No." = '') OR ("Plant Order Line No." = 0) THEN
          EXIT;

        lvPlantSetupRec.GET;
        IF NOT lvPlantSetupRec."Extended Picking Procedure" THEN
          EXIT;

        IF ReceiptForPlantOrders = '' THEN
          ReceiptForPlantOrders := "Plant Order No."
        ELSE BEGIN
          IF (STRPOS(ReceiptForPlantOrders, "Plant Order No.") = 0) AND
             ((STRLEN(ReceiptForPlantOrders) + STRLEN("Plant Order No.") + 2) <=  MAXSTRLEN(ReceiptForPlantOrders))
          THEN
            ReceiptForPlantOrders := ReceiptForPlantOrders + ', ' + "Plant Order No.";
        END;
        IF NOT lvExtendedPlantOrderFuncCU.RunUpdateItemQtyOnReceipt(
           "Document No.", "Line No.", "Plant Order No.", "Plant Order Line No.",
           "Item No.", "Qty. to Receive (Base)")
        THEN
          MESSAGE(lvText000, "Document No.", "Line No.", "Plant Order No.", "Item No.");
      END;
    END;

    LOCAL PROCEDURE PostPlant@1210190002(PurchHeader@1100525003 : Record 38;PurchLine@1100525001 : Record 39);
    VAR
      PlantSetup@1210190001 : Record 11012550;
      lvPlantTypeRec@1100525000 : Record 11012551;
      PlantCostComp@1100409002 : Record 11012575;
      PlantLedgerEntry@1100525002 : Record 11012572;
      InsertPlantOrderMgt@1100409000 : Codeunit 11012552;
      Immediately@1100409003 : Integer;
      PlantOrderNo@1100409001 : Code[20];
    BEGIN
      //**4PS
      IF (PurchLine."Plant Type" = '') OR (PurchLine."Receiving Company" <> '') THEN
        EXIT;

      PurchLine.TESTFIELD("Cost Component Plant");

      PlantSetup.GET;
      IF PlantSetup."Integration Fixed Assets" THEN BEGIN
        lvPlantTypeRec.GET(PurchLine."Plant Type");
        IF lvPlantTypeRec."Integration Fixed Assets" THEN BEGIN
          IF (PurchLine.CheckPlantAcquisitionOrRent(PurchLine) = 1) THEN
            EXIT;
        END;
      END;

      WITH PlantLedgerEntry DO BEGIN
        INIT;
        "Document No." := GenJnlLineDocNo;
        "Posting Date" := PurchLine."Posting Date";
        "Document Date" := PurchHeader."Document Date";
        "Account No." := PurchLine."No.";
        Description := PurchLine.Description;
        "Description 2" := PurchLine."Description 2"; //**4PS01.n
        Quantity := PurchLine."Qty. to Invoice";
        "Direct Unit Cost" := PurchLine."Direct Unit Cost";
        "Unit Cost" := PurchLine."Unit Cost (LCY)";
        "Total Cost" := PurchLine."Amount (LCY)";
        IF PurchLine."Document Type" = PurchLine."Document Type"::"Credit Memo" THEN
          "Total Cost" := -"Total Cost";
        "Unit of Measure Code" := PurchLine."Unit of Measure Code";
        "Department Code" := PurchLine."Shortcut Dimension 1 Code";
        "Cost Object" := PurchLine."Shortcut Dimension 2 Code";
        "Dimension Set ID" := PurchLine."Dimension Set ID";
        "Source Code" := SrcCode;
        "Reason Code" := PurchHeader."Reason Code";
        "No. Series" := PurchHeader."No. Series";
        "Plant Type" := PurchLine."Plant Type";
        "Plant No." := PurchLine."Plant No.";
        "Cost Component" := PurchLine."Cost Component Plant";
        "Vendor No." := PurchLine."Buy-from Vendor No.";
        "Country/Region Code" := PurchHeader."VAT Country/Region Code";
        IF "Plant Type" <> '' THEN BEGIN
          IF lvPlantTypeRec.GET("Plant Type") THEN
            "Plant Posting Group" := lvPlantTypeRec.PlantPostingGrp("Plant No.", '', '');
        END;

        PostPlantEntry.RUN(PlantLedgerEntry);
      END;

      IF (PurchLine."Cost Component Plant" <> '') THEN BEGIN
        PlantCostComp.GET(PurchLine."Cost Component Plant");
        IF PlantCostComp."Charge Purchase" THEN BEGIN
          PurchLine.TESTFIELD("Plant Location");
          PlantOrderNo := '';
          IF PlantCostComp."Immediately Post Charge Purch." THEN
            Immediately := 1;
          IF TempPlantLocChargePO.GET(PurchLine."Plant Location", Immediately) THEN
            PlantOrderNo := TempPlantLocChargePO."Document No.";
          InsertPlantOrderMgt.InsertPlantOrderOnChargePurch(PlantOrderNo,PurchLine."Plant Location",PlantLedgerEntry,PlantCostComp);
          IF NOT TempPlantLocChargePO.GET(PurchLine."Plant Location", Immediately) THEN BEGIN
            TempPlantLocChargePO.INIT;
            TempPlantLocChargePO.Location := PurchLine."Plant Location";
            TempPlantLocChargePO."Line No." := Immediately;
              // Field used for 'Immediately Posting' of the created Plant Order(s)
            TempPlantLocChargePO."Delete Remainder" := PlantSetup."Extended Picking Procedure";
              //Field used for 'Release Plant Order' needed
            TempPlantLocChargePO."Document No." := PlantOrderNo; // Doc.No is used for Plant Order No.
            TempPlantLocChargePO.INSERT;
          END;
        END;
      END;
    END;

    LOCAL PROCEDURE PostPlantOrderChargePurch@1100409001();
    VAR
      PlantOrder@1100409001 : Record 11012556;
      ExtentedPlantOrdeFunc@1100409000 : Codeunit 11020503;
      PostPlantOrder@1100409002 : Codeunit 11012553;
    BEGIN
      //**4PS (C001519)
      TempPlantLocChargePO.RESET;
      TempPlantLocChargePO.SETRANGE("Line No.", 1);
      IF TempPlantLocChargePO.FINDSET THEN BEGIN
        REPEAT
          PlantOrder.GET(TempPlantLocChargePO."Document No.");
          IF TempPlantLocChargePO."Delete Remainder" THEN BEGIN
            ExtentedPlantOrdeFunc.SetChargePurchRun();
            ExtentedPlantOrdeFunc.RunReleasePlantOrder(PlantOrder);
          END;
          PostPlantOrder.SetChargePurchRun();
          PostPlantOrder.RUN(PlantOrder);
        UNTIL TempPlantLocChargePO.NEXT = 0;
      END;
      TempPlantLocChargePO.RESET;
      TempPlantLocChargePO.DELETEALL;
    END;

    LOCAL PROCEDURE FA_PlantIntegration@1210190001(PurchLine@1100525000 : Record 39);
    VAR
      lRecPlantNumber@1210190001 : Record 11012552;
      lRecPlantSetup@1210190000 : Record 11012550;
      lCduPostPlantNumber@1210190003 : Codeunit 11012550;
    BEGIN
      //**4PS
      // - Post (unposted) plant no. in case parameter set
      // - Update plant no. (linked by fixed asset) with purchase price

      WITH PurchLine DO BEGIN
        IF (NOT FPSLicenseManagement.LicenseAndReadPermissionForTable(lRecPlantSetup)) THEN
          EXIT;
        IF (NOT(lRecPlantSetup.GET AND lRecPlantSetup."Integration Fixed Assets")) THEN
          EXIT;
        lRecPlantNumber.SETCURRENTKEY("Fixed Asset");
        lRecPlantNumber.SETRANGE("Fixed Asset", "No.");
        IF (NOT lRecPlantNumber.FIND('-')) THEN
          EXIT;
        lRecPlantNumber.SETCURRENTKEY("Plant Type", "No.");

        // Post plant
        IF (lRecPlantSetup."Post On FA Acquisition" AND NOT lRecPlantNumber.Posted) THEN
          lCduPostPlantNumber.RUN(lRecPlantNumber)
        ELSE
          lRecPlantNumber.TESTFIELD(Posted, TRUE);
      END;
    END;

    LOCAL PROCEDURE UpdatePlantNoPurchPrice@1100485001(PurchLine@1100525000 : Record 39);
    VAR
      lvPlantNoRec@1100485000 : Record 11012552;
    BEGIN
      //**4PS
      IF (PurchLine."Plant Type" = '') OR (PurchLine."Plant No." = '') OR (PurchLine."Cost Component Plant" = '') THEN
        EXIT;
      IF (PurchLine.CheckPlantAcquisitionOrRent(PurchLine) <> 1) THEN
        EXIT;
      IF NOT lvPlantNoRec.GET(PurchLine."Plant Type", PurchLine."Plant No.") THEN
        EXIT;

      IF (lvPlantNoRec."Purchase Price" = 0) THEN BEGIN
        lvPlantNoRec."Purchase Price" := PurchLine."Unit Cost (LCY)";
        lvPlantNoRec.MODIFY;
      END;
    END;

    PROCEDURE CheckCloseHeader@1210190004(iPurchLine@1210190000 : Record 39);
    VAR
      lPurchHeader@1210190001 : Record 38;
      lCloseOrder@1210190002 : Boolean;
      ReleasePurchDoc@1210190003 : Codeunit 415;
    BEGIN
      //**4PS01.n
      lPurchHeader.GET(iPurchLine."Document Type",iPurchLine."Document No.");
      IF lPurchHeader.Status = lPurchHeader.Status::Closed THEN
        EXIT;
      IF lPurchHeader."Document Type" <> lPurchHeader."Document Type"::Order THEN
        EXIT;

      IF (NOT lPurchHeader."Amounts only") THEN BEGIN
        IF (iPurchLine.Quantity <> iPurchLine."Quantity Invoiced") THEN BEGIN
          IF NOT CheckPlantExtRentOrdLineClosed(lPurchHeader,iPurchLine) THEN
            EXIT;
        END;
      END ELSE BEGIN
        IF (iPurchLine.Amount <> iPurchLine."Amnt. Invoiced") THEN
          EXIT;
      END;

      IF lPurchHeader."Tolerate Exceeding Invoice Qu." THEN
        EXIT;

      iPurchLine.RESET;
      iPurchLine.SETRANGE("Document Type", lPurchHeader."Document Type");
      iPurchLine.SETRANGE("Document No.", lPurchHeader."No.");
      lCloseOrder := TRUE;
      IF iPurchLine.FINDSET THEN
        REPEAT
          IF (NOT lPurchHeader."Amounts only") THEN BEGIN
            IF (iPurchLine."Quantity Received" <> iPurchLine."Quantity Invoiced") OR
               (iPurchLine.Quantity <> iPurchLine."Quantity Invoiced")
            THEN BEGIN
              IF NOT CheckPlantExtRentOrdLineClosed(lPurchHeader,iPurchLine) THEN BEGIN
                lCloseOrder := FALSE;
                EXIT;
              END;
            END;
          END ELSE BEGIN
            IF iPurchLine.Amount <> iPurchLine."Amnt. Invoiced" THEN BEGIN
              lCloseOrder := FALSE;
              EXIT;
            END;
          END;
        UNTIL iPurchLine.NEXT = 0;

      IF lCloseOrder THEN
        ReleasePurchDoc.Close(lPurchHeader);
    END;

    LOCAL PROCEDURE CheckPlantExtRentOrdLineClosed@1100525007(PurchHeader@1210190000 : Record 38;PurchLine@1100525000 : Record 39) : Boolean;
    BEGIN
      //**4PS
      IF PurchHeader."Hours Hire Order Type" = PurchHeader."Hours Hire Order Type"::Plant THEN
        EXIT(FALSE);

      IF NOT PurchSetup."Close Pl.Ext.Rent Ord. on Rcpt" THEN
        EXIT(FALSE);

      IF (PurchLine."Quantity Received" = PurchLine.Quantity) AND
         (PurchLine."Plant Type" <> '') AND (PurchLine."Cost Component Plant" <>'')
      THEN BEGIN
        IF (PurchLine.CheckPlantAcquisitionOrRent(PurchLine) = 2) THEN  //* 2 = External Rent (plant)
          EXIT(TRUE);
      END;
      EXIT(FALSE);
    END;

    PROCEDURE UndoProjectInventory@1100525003(PurchRcptLine@1100525000 : Record 121);
    VAR
      PurchHeader@1100525001 : Record 38;
      PurchLine@1100525002 : Record 39;
    BEGIN
      //**4PS
      //* Post project inventory on undo posted receipt (called from CU5813).

      //* Read/fill all globals needed for the function 'PostProjInventory'.
      PurchRcptHeader.GET(PurchRcptLine."Document No.");
      PurchRcptHeader."Document Date" := TODAY;
      IF NOT PurchHeader.GET(PurchHeader."Document Type"::Order, PurchRcptLine."Order No.") THEN
        PurchHeader.INIT;
      IF NOT PurchLine.GET(PurchLine."Document Type"::Order, PurchRcptLine."Order No.", PurchRcptLine."Order Line No.") THEN
        PurchLine.INIT;

      PostProjInventory(PurchHeader,PurchLine,PurchRcptLine);
    END;

    LOCAL PROCEDURE PostProjInventory@1210190006(PurchHeader@1100525003 : Record 38;PurchLine@1100525002 : Record 39;PurchRcptLine@1100525000 : Record 121);
    VAR
      lvProjInventEntry@1210190000 : Record 11012670;
      lvItemRec@1210190001 : Record 27;
      lvBasicItemRec@1210190003 : Record 11012316;
      lvTradeItemRec@1210190004 : Record 11012317;
      PurchaseLineDetail@1100529000 : Record 11020660;
      InventorySetup@1100525001 : Record 313;
    BEGIN
      //**4PS
      IF PurchHeader.Deliver IN
        [PurchHeader.Deliver::"Project Location",PurchHeader.Deliver::"Service Location"] THEN
        EXIT;
      IF PurchLine."No Project Stock" THEN
        EXIT;

      WITH PurchRcptLine DO BEGIN
        IF ("Job No." = '') OR ("Location Code" = '') OR (Quantity = 0) OR ("Cost Type" <> "Cost Type"::Material) OR
           (("Item No." = '') AND ("Basic Item" = '') AND ("Trade Item" = '') AND (Description = ''))
        THEN
          EXIT;
        InventorySetup.GET;  //C035848 (db, 10-02-17)
        IF NOT InventorySetup.JobInventoryByLocationShelf("Job No.") THEN
          EXIT;
      END;

      WITH lvProjInventEntry DO BEGIN
        INIT;
        "Document Date" := PurchRcptHeader."Document Date";
        "Document No." := PurchRcptLine."Document No.";
        "Receipt No." := PurchRcptLine."Document No."; //**4PS.n BI006 KD 27-10-16
        "Posting Date" := PurchRcptHeader."Posting Date";
        "Project No." := PurchRcptLine."Job No.";
        "Item No." := PurchRcptLine."Item No.";
        Manufacturer := PurchRcptLine.Manufacturer;
        "Basic Item" := PurchRcptLine."Basic Item";
        "Vendor (Trade Item)" := PurchRcptLine."Vendor (Trade Item)";
        "Trade Item" := PurchRcptLine."Trade Item";
        IF ("Item No." <> '') THEN BEGIN
          lvItemRec.GET("Item No.");
          lvItemRec.TESTFIELD("Base Unit of Measure");
          "Unit of Measure Code" := lvItemRec."Base Unit of Measure";
        END ELSE BEGIN
          "Unit of Measure Code" := PurchRcptLine."Unit of Measure Code";
          IF "Trade Item" <> '' THEN BEGIN
            IF lvTradeItemRec.GET("Vendor (Trade Item)", "Trade Item") THEN
              "Unit of Measure Code" := lvTradeItemRec."Application Unit";
            lvTradeItemRec.TESTFIELD("Application Unit");
          END ELSE BEGIN
            IF "Basic Item" <> '' THEN BEGIN
              IF lvBasicItemRec.GET(Manufacturer, "Basic Item") THEN
                "Unit of Measure Code" := lvBasicItemRec."Application Unit";
              lvBasicItemRec.TESTFIELD("Application Unit");
            END ELSE BEGIN
              PurchRcptLine.TESTFIELD("Unit of Measure Code");
              "Unit of Measure Code" := PurchRcptLine."Unit of Measure Code";
            END;
          END;
        END;
        Description := PurchRcptLine.Description;
        "Description 2" := PurchRcptLine."Description 2";
        "Location Code" := PurchRcptLine."Location Code";
        "Bin Code" := PurchRcptLine."Bin Code"; //db, 02-11-10
        "Shelf No." := PurchRcptLine."Shelf No."; //db, 29-08-05
        Quantity := PurchRcptLine."Quantity (Base)";
        "Receipt Line No." := PurchRcptLine."Line No.";
        "Entry Type" := "Entry Type"::Receipt;
        "Yard No." := PurchRcptLine."Yard No.";
        "System No." := PurchRcptLine."System No.";
        "Entity Type" := PurchRcptLine."Entity Type";
        "Entity No." := PurchRcptLine."Entity No.";
        "Gland Position" := PurchRcptLine."Cable Transit Pos.";
        Element := PurchRcptLine.Element; //hbk, 06-05-10
        "Variant Code" := PurchRcptLine."Variant Code"; // Variant, X0.71
        "Purch. Detail No." := PurchaseLineDetail.GetDetailNoPurchOrderLine(PurchRcptLine."Order No.",PurchRcptLine."Order Line No."); //DP00749
        "Cost Object" := PurchRcptLine."Shortcut Dimension 2 Code"; //kzwerver, 110616, n, #RfC Electr. purchaseorder
        "Purchase Route Reference" := PurchRcptLine."Purchase Route Reference";
        "Purchase Requisition No." := PurchRcptHeader."Purchase Requisition No.";
        "Plant Type" := PurchRcptLine."Plant Type";
        "Plant No." := PurchRcptLine."Plant No.";
        "Comments for Logistics" := PurchRcptLine."Comments for Logistics"; //**4PS.n BI003a KD 08-02-17
        "Extension Contract" := PurchRcptLine."Extension Contract";
        "Plot No." := PurchRcptLine."Plot No.";

        ProjectInventoryPostLine.RunWithCheck(lvProjInventEntry);
      END;
    END;

    LOCAL PROCEDURE InvoiceMarginCheck@1210190007(VAR PurchHeader@1100525000 : Record 38;VAR AmountHeader@1100529400 : Decimal;VAR AmountLines@1100529401 : Decimal) : Boolean;
    VAR
      lvGenPostSetupRec@1210190012 : Record 252;
      lvVendRec@1210190000 : Record 23;
      lvPurchLineRec@1210190004 : Record 39;
      lvProjRelated@1210190008 : Boolean;
      lvMarginAmount@1210190001 : Decimal;
      lvMarginPerc@1210190002 : Decimal;
      lvDiffAmount@1210190003 : Decimal;
      lvReceivingComp@1210190015 : Code[30];
      lvShortcutDim1@1210190016 : Code[20];
      lvBusGroup@1210190013 : Code[10];
      lvProdGroup@1210190007 : Code[10];
      lvVatBusGroup@1210190010 : Code[10];
      lvVatProdGroup@1210190011 : Code[10];
      lvVatCalcType@1210190014 : Option;
      lvText11012000@1210190009 : TextConst 'ENU=Correction purchace variance;NOR=Rettelse av innkj›psavvik;SVE=R„ttning av ink”psavvikelse';
    BEGIN
      //**4PS.n
      WITH PurchHeader DO BEGIN
        CALCFIELDS("Amount Including VAT");

        AmountHeader := "Amount incl. VAT";
      //>>4PSSE, 190427
        //  AmountLines := ROUND(
        //    "Amount Including VAT",
        //    Currency."Invoice Rounding Precision",
        //    Currency.InvoiceRoundingDirection);
        AmountLines := "Amount Including VAT";
      //4PSSE.sn #24659
        IF AmountLines = AmountHeader THEN
          EXIT(TRUE);
      //4PSSE.en #24659
        IF PurchSetup."Invoice Rounding" THEN
          AmountLines := ROUND(
            "Amount Including VAT",
            Currency."Invoice Rounding Precision",
            Currency.InvoiceRoundingDirection);
      //<<4PSSE, 190427

        IF AmountLines = AmountHeader THEN
          EXIT(TRUE);

        lvVendRec.GET("Buy-from Vendor No.");
        lvMarginAmount := lvVendRec."Invoice/Receipt Margin Amount";
        lvMarginPerc := lvVendRec."Invoice/Receipt Margin Perc.";
        IF (lvMarginAmount = 0) AND (lvMarginPerc = 0) THEN BEGIN
          PurchSetup.GET;
          lvMarginAmount := PurchSetup."Margin Amount (Header)";
          lvMarginPerc := PurchSetup."Margin % (Header)";
        END;
        IF (lvMarginAmount = 0) AND (lvMarginPerc = 0) THEN
          EXIT(FALSE);

        AmountLines := "Amount Including VAT";
        lvDiffAmount := AmountHeader - AmountLines;
        IF (lvMarginAmount <> 0) AND (ABS(lvDiffAmount) > lvMarginAmount) THEN
          EXIT(FALSE);
        IF (lvMarginPerc <> 0) THEN BEGIN
          IF (AmountLines = 0) THEN
            EXIT(FALSE)
          ELSE BEGIN
            IF (ABS(lvDiffAmount / AmountLines * 100)  > lvMarginPerc) THEN
              EXIT(FALSE);
          END;
        END;

        lvPurchLineRec.RESET;
        lvPurchLineRec.SETRANGE("Document Type", "Document Type");
        lvPurchLineRec.SETRANGE("Document No.", "No.");
        lvPurchLineRec.SETFILTER(Type, '<>%1', lvPurchLineRec.Type::" ");
        IF NOT lvPurchLineRec.FINDSET THEN
          EXIT(FALSE);
        lvReceivingComp := lvPurchLineRec."Receiving Company";
        lvShortcutDim1 := lvPurchLineRec."Shortcut Dimension 1 Code";
        lvBusGroup := lvPurchLineRec."Gen. Bus. Posting Group";
        lvProdGroup := lvPurchLineRec."Gen. Prod. Posting Group";
        lvVatBusGroup := lvPurchLineRec."VAT Bus. Posting Group";
        lvVatProdGroup := lvPurchLineRec."VAT Prod. Posting Group";
        lvVatCalcType := lvPurchLineRec."VAT Calculation Type";
        lvProjRelated := (lvPurchLineRec."Job No." <> '');
        REPEAT
          IF (PurchHeader."Order Type (SiB)" = PurchHeader."Order Type (SiB)"::" ") AND ((lvPurchLineRec."Receipt No." = '') OR (lvPurchLineRec."Receipt Line No." = 0)) THEN
            EXIT(FALSE);
          IF (lvPurchLineRec."Receiving Company" <> lvReceivingComp) OR
             (lvPurchLineRec."Gen. Bus. Posting Group" <> lvBusGroup) OR
             (lvPurchLineRec."Gen. Prod. Posting Group" <> lvProdGroup) OR
             (lvPurchLineRec."VAT Bus. Posting Group" <> lvVatBusGroup) OR
             (lvPurchLineRec."VAT Prod. Posting Group" <> lvVatProdGroup) OR
             (lvPurchLineRec."VAT Calculation Type" <> lvVatCalcType)
          THEN
            EXIT(FALSE);
          IF (lvProjRelated <> (lvPurchLineRec."Job No." <> '')) THEN
            EXIT(FALSE);
          IF (lvShortcutDim1 <> '') AND (lvPurchLineRec."Shortcut Dimension 1 Code" <> lvShortcutDim1) THEN
            lvShortcutDim1 := '';
        UNTIL (lvPurchLineRec.NEXT = 0);

        IF NOT lvGenPostSetupRec.GET(lvBusGroup, lvProdGroup) THEN
          EXIT(FALSE);

        IF lvProjRelated  THEN
          lvGenPostSetupRec.TESTFIELD("Purch. Variance Acc.(Projects)")
        ELSE
          lvGenPostSetupRec.TESTFIELD("Purchase Variance Account");

        lvPurchLineRec.RESET;
        lvPurchLineRec.SETRANGE("Document Type", "Document Type");
        lvPurchLineRec.SETRANGE("Document No.", "No.");
        lvPurchLineRec.FINDLAST; //Read last 'Line No.'
        //
        lvPurchLineRec.INIT;
        lvPurchLineRec."Document Type" := "Document Type";
        lvPurchLineRec."Document No." := "No.";
        lvPurchLineRec."Line No." := lvPurchLineRec."Line No." + 10000;
        lvPurchLineRec.VALIDATE(Type, lvPurchLineRec.Type::"G/L Account");
        lvPurchLineRec."System-Created Entry" := TRUE;
        lvPurchLineRec."Receiving Company" := lvReceivingComp;
        IF lvProjRelated THEN
          lvPurchLineRec.VALIDATE("No.", lvGenPostSetupRec."Purch. Variance Acc.(Projects)")
        ELSE
          lvPurchLineRec.VALIDATE("No.", lvGenPostSetupRec."Purchase Variance Account");
        IF (lvShortcutDim1 <> '') THEN
          lvPurchLineRec.VALIDATE("Shortcut Dimension 1 Code", lvShortcutDim1);
        lvPurchLineRec."Gen. Bus. Posting Group" := lvBusGroup;
        lvPurchLineRec."Gen. Prod. Posting Group" := lvProdGroup;
        lvPurchLineRec."VAT Bus. Posting Group" := lvVatBusGroup;
        lvPurchLineRec.VALIDATE("VAT Prod. Posting Group", lvVatProdGroup);
        lvPurchLineRec."VAT Calculation Type" := lvVatCalcType;
        lvPurchLineRec.Description := lvText11012000;
        lvPurchLineRec.VALIDATE(Quantity, 1);
        lvPurchLineRec.VALIDATE("Amount Including VAT", lvDiffAmount);
        lvPurchLineRec.VALIDATE("Line Amount", lvPurchLineRec.Amount);
        lvPurchLineRec.INSERT(TRUE);

        PurchHeader.Receive := TRUE;
        EXIT(TRUE);
      END;
    END;

    LOCAL PROCEDURE CheckUpdateItemPrice@1210190012(PurchaseLine@1210190001 : Record 39);
    VAR
      Item@1210190000 : Record 27;
      Amnt@1100485000 : Decimal;
    BEGIN
      //**4PS
      WITH PurchaseLine DO BEGIN
        GLSetup.GET;
        PurchSetup.GET;

        IF ("Item No." <> '') AND ("Trade Item" + "Basic Item" = '') THEN BEGIN
          Item.GET("Item No.");
          IF Item."Costing Method" <> Item."Costing Method"::Standard THEN BEGIN
            IF Quantity * "Qty. per Unit of Measure" <> 0 THEN BEGIN
              IF "Document Type" <> "Document Type"::Invoice THEN
                Amnt := "Unit Cost (LCY)" / "Qty. per Unit of Measure"
              ELSE
                Amnt := (Amount + "Line Discount Amount") / (Quantity * "Qty. per Unit of Measure");
              Amnt := ROUND(ABS(Amnt), GLSetup."Unit-Amount Rounding Precision");
              Item.VALIDATE("Last Direct Cost", Amnt);
              Item.MODIFY(TRUE);
            END;
          END;
        END;
      END;
    END;

    LOCAL PROCEDURE CreatePurchaseOrderControl@1210190005(PurchLine@1210190000 : Record 39);
    BEGIN
      //**4PS
      IF RoundingLineInserted THEN
        EXIT;

      PurchLine.CreatePurchOrderControl(FALSE);
    END;

    LOCAL PROCEDURE CheckStatusProjectAndService@1100485003(PurchHeader@1100525001 : Record 38;PurchLine@1100525000 : Record 39) : Boolean;
    BEGIN
      //**4PS
      IF PurchHeader."Document Type" = PurchHeader."Document Type"::Order THEN BEGIN
        IF PurchHeader."Amounts only" THEN BEGIN
          IF PurchLine. "Amnt. to Receive" = 0 THEN
            EXIT(FALSE);
        END ELSE BEGIN
          IF PurchLine."Qty. to Receive" = 0 THEN
            EXIT(FALSE);
        END;
      END;
      EXIT(TRUE);
    END;

    LOCAL PROCEDURE UpdatePlantNoExtRentDate@1100485021(PurchLine@1100525005 : Record 39);
    VAR
      PlantSetup@1100525004 : Record 11012550;
      lvPlantNoRec@1100485000 : Record 11012552;
      lvRentEntryRec@1100525000 : Record 11012535;
      lvSaveDate@1100525001 : Date;
      lvStartDate@1100525002 : Date;
      lvEndDate@1100525003 : Date;
    BEGIN
      //**4PS.n
      IF (PurchLine."Receiving Company" = '') AND (PurchLine."Ext. Rented Plant Invoiced to" <> 0D) AND
         (PurchLine."Plant Type" <> '') AND (PurchLine."Plant No." <> '') AND (PurchLine."Cost Component Plant" <> '')
      THEN BEGIN
        PlantSetup.GET;
        IF PurchLine."Cost Component Plant" <> PlantSetup."Cost Component Rent" THEN
          EXIT;
        IF lvPlantNoRec.GET(PurchLine."Plant Type", PurchLine."Plant No.") THEN BEGIN
          IF lvPlantNoRec.External THEN BEGIN
            lvSaveDate := lvPlantNoRec."Ext. Rented Invoiced to";
            lvRentEntryRec.GetExtRentPeriod(lvPlantNoRec.Vendor,lvPlantNoRec."Plant Type",lvPlantNoRec."No.",lvStartDate,lvEndDate);
            //* Enddate (removal date) is only filled if the plant is completely removed (bulk can be removed in parts)
            IF PurchLine."Ext. Rented Plant Invoiced to" >= lvPlantNoRec."Ext. Rented Invoiced to" THEN BEGIN
              lvPlantNoRec."Ext. Rented Invoiced to" := PurchLine."Ext. Rented Plant Invoiced to";
              IF (lvEndDate <> 0D) AND (lvPlantNoRec."Ext. Rented Invoiced to" > lvEndDate) THEN
                lvPlantNoRec."Ext. Rented Invoiced to" := lvEndDate;
            END ELSE BEGIN
              IF (lvEndDate <> 0D) AND (lvPlantNoRec."Ext. Rented Invoiced to" > lvEndDate) THEN
                lvPlantNoRec."Ext. Rented Invoiced to" := lvEndDate;
            END;
            IF lvPlantNoRec."Ext. Rented Invoiced to" <> lvSaveDate THEN
              lvPlantNoRec.MODIFY;
          END;
        END;
      END;
    END;

    LOCAL PROCEDURE PostComplementaryWIPCostProj@1100485002(PurchHeader@1100525002 : Record 38;PurchLine@1100525001 : Record 39;JobJnlLine@1100525000 : Record 11072008);
    VAR
      Vendor@1100528500 : Record 23;
      ProjectType@1100485003 : Record 11012009;
    BEGIN
      //**4PS
      IF JobJnlLine."Total Cost (LCY)" = 0 THEN
        EXIT;

      IF PurchLine."Pay-to Vendor No." = '' THEN
        EXIT;

      Project.CHANGECOMPANY(PurchLine."Receiving Company");
      ProjectType.CHANGECOMPANY(PurchLine."Receiving Company");
      Project.GET(PurchLine."Job No.");

      Project.TESTFIELD("Project Type");
      ProjectType.GET(Project."Project Type");
      IF NOT ProjectType."Post Complementary Costs" THEN
        EXIT;

      Vendor.GET(PurchLine."Pay-to Vendor No.");

      //Post Debit Line
      TempComplWIPPostingBuffer[1]."G/L Account" := ProjectType.GetComplWIPCoverAcc(PurchLine."Cost Type"-1,Vendor."Vendor Posting Group",'');
      TempComplWIPPostingBuffer[1].Amount := -JobJnlLine."Total Cost (LCY)";
      TempComplWIPPostingBuffer[1].Description := PurchHeader."Posting Description";
      TempComplWIPPostingBuffer[1]."Job No." := Project."No.";
      TempComplWIPPostingBuffer[1]."Global Dimension 1 Code" := JobJnlLine."Shortcut Dimension 1 Code";
      TempComplWIPPostingBuffer[1]."Global Dimension 2 Code" := JobJnlLine."Shortcut Dimension 2 Code";
      TempComplWIPPostingBuffer[1]."Dimension Set ID" := JobJnlLine."Dimension Set ID";
      TempComplWIPPostingBuffer[1]."Cost Component" := PurchLine."Cost Component"; //M22560
      UpdateComplementaryWIPBuffer;

      //Post Credit Line
      TempComplWIPPostingBuffer[1]."G/L Account" := ProjectType.GetComplWipAcc(PurchLine."Cost Type"-1,Vendor."Vendor Posting Group",'');
      TempComplWIPPostingBuffer[1].Amount := JobJnlLine."Total Cost (LCY)";
      TempComplWIPPostingBuffer[1]."Job No." := Project."No.";
      UpdateComplementaryWIPBuffer;
    END;

    LOCAL PROCEDURE PostComplementaryWIPCostServ@1100485007(PurchHeader@1100525002 : Record 38;PurchLine@1100525001 : Record 39;ServJnlLine@1100525000 : Record 11012820);
    VAR
      Vendor@1100485002 : Record 23;
      ServiceType@1100485003 : Record 11012814;
      ServiceOrder@1100525003 : Record 11012823;
    BEGIN
      //**4PS
      IF ServJnlLine."Total Cost (LCY)" = 0 THEN
        EXIT;

      IF PurchLine."Pay-to Vendor No." = '' THEN
        EXIT;

      ServiceOrder.GET(PurchLine."Service Order No.");

      ServiceOrder.TESTFIELD("Service Type");
      ServiceType.GET(ServiceOrder."Service Type");
      IF NOT ServiceType."Post Complementary Costs" THEN
        EXIT;

      Vendor.GET(PurchLine."Pay-to Vendor No.");

      //Post Debit Line
      CLEAR(TempComplWIPPostingBuffer[1]);
      TempComplWIPPostingBuffer[1]."G/L Account" := ServiceType.GetComplWIPCoverAcc(PurchLine."Cost Type"-1,Vendor."Vendor Posting Group",'',ServiceOrder);
      TempComplWIPPostingBuffer[1].Amount := -ServJnlLine."Total Cost (LCY)";
      TempComplWIPPostingBuffer[1].Description := PurchHeader."Posting Description";
      TempComplWIPPostingBuffer[1]."Service Order No." := ServiceOrder."No.";
      TempComplWIPPostingBuffer[1]."Service Contract No." := ServiceOrder."Service Contract No.";
      TempComplWIPPostingBuffer[1]."Global Dimension 1 Code" := ServJnlLine."Shortcut Dimension 1 Code";
      TempComplWIPPostingBuffer[1]."Global Dimension 2 Code" := ServJnlLine."Shortcut Dimension 2 Code";
      TempComplWIPPostingBuffer[1]."Dimension Set ID" := ServJnlLine."Dimension Set ID";
      TempComplWIPPostingBuffer[1]."Cost Component" := PurchLine."Cost Component"; //M22560
      UpdateComplementaryWIPBuffer;

      //Post Credit Line
      TempComplWIPPostingBuffer[1]."G/L Account" := ServiceType.GetComplWipAcc(PurchLine."Cost Type"-1,Vendor."Vendor Posting Group",'');
      TempComplWIPPostingBuffer[1].Amount := ServJnlLine."Total Cost (LCY)";
      TempComplWIPPostingBuffer[1]."Service Order No." := ServiceOrder."No.";
      TempComplWIPPostingBuffer[1]."Service Contract No." := ServiceOrder."Service Contract No.";
      UpdateComplementaryWIPBuffer;
    END;

    LOCAL PROCEDURE UpdateComplementaryWIPBuffer@1100485004();
    BEGIN
      //**4PS
      TempComplWIPPostingBuffer[2] := TempComplWIPPostingBuffer[1];
      IF TempComplWIPPostingBuffer[2].FIND THEN BEGIN
        TempComplWIPPostingBuffer[2].Amount :=
          TempComplWIPPostingBuffer[2].Amount + TempComplWIPPostingBuffer[1].Amount;
        TempComplWIPPostingBuffer[2].MODIFY;
      END ELSE
        TempComplWIPPostingBuffer[1].INSERT;
    END;

    LOCAL PROCEDURE InwardProcessing@1100485011(PurchLine@1100525001 : Record 39;PurchRcptLine@1100525000 : Record 121);
    VAR
      InwardRec@1100485000 : Record 11020350;
      InwardRec2@1100485001 : Record 11020350;
    BEGIN
      //**4PS
      InwardRec2.INIT;
      InwardRec2.RESET;
      InwardRec2.SETCURRENTKEY("Purchase Order No.");
      InwardRec2.SETRANGE("Purchase Order No.", PurchLine."Document No.");
      InwardRec2.SETRANGE("Order Line No.", PurchLine."Line No.");
      IF InwardRec2.FINDFIRST THEN;

      InwardRec.INIT;
      InwardRec.RESET;
      InwardRec."Job No." := PurchLine."Job No.";
      InwardRec.Element := PurchLine.Element;
      InwardRec."Receipt No." := PurchRcptLine."Document No.";
      InwardRec."Receipt Line" := PurchRcptLine."Line No.";
      InwardRec."Receipt Date" := PurchRcptHeader."Document Date";
      InwardRec."Purchase Order No." := PurchLine."Document No.";
      InwardRec."Order Line No." := PurchLine."Line No.";
      IF InwardRec.INSERT THEN BEGIN
        InwardRec.Quantity := PurchRcptLine.Quantity;
        InwardRec."Unit of Measure" := PurchRcptLine."Unit of Measure";
        InwardRec."Tariff Code" := InwardRec2."Tariff Code";
        InwardRec.MODIFY;
      END;
    END;

    LOCAL PROCEDURE CheckUpdateInvNoInInvoiceBBN@1100525000(iInvoiceNoBBN@1100525000 : Code[35];iPurchInvNoOld@1100525001 : Code[20];iPurchInvNoNew@1100525002 : Code[20];iCreditMemo@1100525004 : Boolean);
    VAR
      lvInvoiceBBNRec@1100525003 : Record 11072653;
    BEGIN
      //**4PS
      IF (iInvoiceNoBBN = '') OR (iPurchInvNoNew = iPurchInvNoOld) THEN
        EXIT;

      lvInvoiceBBNRec.SETRANGE("No.", COPYSTR(iInvoiceNoBBN, 1, MAXSTRLEN(lvInvoiceBBNRec."No.")));
      IF NOT iCreditMemo THEN
        lvInvoiceBBNRec.SETRANGE("Purch. Invoice Type", lvInvoiceBBNRec."Purch. Invoice Type"::Invoice)
      ELSE
        lvInvoiceBBNRec.SETRANGE("Purch. Invoice Type", lvInvoiceBBNRec."Purch. Invoice Type"::CreditMemo);
      lvInvoiceBBNRec.SETRANGE("Purchase Invoice No.", iPurchInvNoOld);
      IF lvInvoiceBBNRec.FINDFIRST THEN BEGIN  //* Don't use GET for permission reasons
        lvInvoiceBBNRec."Purchase Invoice No." := iPurchInvNoNew;
        lvInvoiceBBNRec.MODIFY;
      END;
    END;

    PROCEDURE SetNoErrorNothingToPost@1100525002(iNoErrorNothingToPost@1100525000 : Boolean);
    BEGIN
      //**4PS
      SkipClearAll := TRUE; //DP00416.n
      NoErrorNothingToPost := iNoErrorNothingToPost;
      NothingToPostFlag := FALSE;
    END;

    PROCEDURE SetUptoPromisedReceiveDate@1100525004(NewUptoPromisedReceiveDate@1100525000 : Date);
    BEGIN
      //**4PS
      UptoPromisedReceiveDate := NewUptoPromisedReceiveDate;
    END;

    LOCAL PROCEDURE PutPromisedReceiveDateFilter@1100525005(VAR PurchLine@1100525000 : Record 39);
    BEGIN
      //**4PS
      IF UptoPromisedReceiveDate <> 0D THEN
        PurchLine.SETRANGE("Promised Receipt Date", 0D, UptoPromisedReceiveDate);
    END;

    LOCAL PROCEDURE CheckApprovalTemplate@1100525006(PurchHeader@1100525000 : Record 38);
    BEGIN
      //**4PS
      IF (PurchSetup."Determine Approval Template" = PurchSetup."Determine Approval Template"::GlobalDim1) THEN
        PurchHeader.TESTFIELD("Shortcut Dimension 1 Code");
      PurchHeader.TESTFIELD("Inv.Appr.Journal Template");
    END;

    LOCAL PROCEDURE FillRetentionPostingBufferWar@1210190009(PurchHeader@1210190000 : Record 38);
    VAR
      WarrantyDataPurchOrder@1210190001 : Record 11020665;
      CurrExchRate@1100525000 : Record 330;
    BEGIN
      //**4PS, RFC 337
      WITH PurchHeader DO BEGIN
        CLEAR(TempRetentionPostingBuffer[1]);

        WarrantyDataPurchOrder.SETRANGE("Document Type",WarrantyDataPurchOrder."Document Type"::Order);
        WarrantyDataPurchOrder.SETRANGE("Document No.", "Related Purch. Order No.");
        WarrantyDataPurchOrder.SETRANGE("Warranty Obligation satisfied",FALSE);
        IF WarrantyDataPurchOrder.FINDSET THEN BEGIN
          DocumentRetentionAmount := 0; //call 27569
          RetentionType := RetentionType::Warranty;
          REPEAT
            TempRetentionPostingBuffer[1].Type := 0;
            TempRetentionPostingBuffer[1]."Global Dimension 1 Code" := "Shortcut Dimension 1 Code";
            TempRetentionPostingBuffer[1]."Global Dimension 2 Code" := "Shortcut Dimension 2 Code";
            TempRetentionPostingBuffer[1]."Dimension Set ID" := "Dimension Set ID";
            TempRetentionPostingBuffer[1]."Purchase Order" := WarrantyDataPurchOrder."Document No.";
            TempRetentionPostingBuffer[1]."Warranty Object" := WarrantyDataPurchOrder."Warranty Code";
            CALCFIELDS(Amount);
            IF WarrantyDataPurchOrder."Retention Percentage" <> 0 THEN
              TempRetentionPostingBuffer[1]."Retention Amount" := ROUND(-Amount *
                WarrantyDataPurchOrder."Retention Percentage"/100)  // Call 29199 (round)
            ELSE
              TempRetentionPostingBuffer[1]."Retention Amount" := -WarrantyDataPurchOrder."Retention Amount";
            IF "Currency Code" = '' THEN
              TempRetentionPostingBuffer[1]."Retention Amount (ACY)" := TempRetentionPostingBuffer[1]."Retention Amount"
            ELSE BEGIN
              TempRetentionPostingBuffer[1]."Retention Amount (ACY)" :=
                ROUND(
                  CurrExchRate.ExchangeAmtFCYToLCY(
                    1, PurchHeader."Job No.", PurchHeader."Posting Date",PurchHeader."Currency Code",
                    TempRetentionPostingBuffer[1]."Retention Amount" ,PurchHeader."Currency Factor",FALSE));
            END;

            UpdRetentionPostingBuffer;
            DocumentRetentionAmount := DocumentRetentionAmount + TempRetentionPostingBuffer[1]."Retention Amount"; //call 27569
          UNTIL WarrantyDataPurchOrder.NEXT = 0;
        END;
      END;
    END;

    LOCAL PROCEDURE UpdRetentionPostingBuffer@1100525020();
    BEGIN
      //**4PS
      TempRetentionPostingBuffer[2] := TempRetentionPostingBuffer[1];
      IF TempRetentionPostingBuffer[2].FIND THEN BEGIN
        TempRetentionPostingBuffer[2]."Retention Amount" :=
          TempRetentionPostingBuffer[2]."Retention Amount" + TempRetentionPostingBuffer[1]."Retention Amount";
        TempRetentionPostingBuffer[2]."Retention Amount (ACY)" :=
          TempRetentionPostingBuffer[2]."Retention Amount (ACY)" + TempRetentionPostingBuffer[1]."Retention Amount (ACY)";
        TempRetentionPostingBuffer[2].MODIFY;
      END ELSE
        TempRetentionPostingBuffer[1].INSERT;
    END;

    LOCAL PROCEDURE PostRetentionPostingBuffer@11132551(PurchHeader@1100525002 : Record 38);
    VAR
      SubcontracterContract@1210190000 : Record 11020635;
      PaymentTerms@1210190001 : Record 3;
      Vendor@1100525000 : Record 23;
      VendPostingGr@1100525001 : Record 93;
      GenJnlLine@1100525003 : Record 81;
      CurrencyExchangeRate@1100529500 : Record 330;
    BEGIN
      //**4PS
      //DP01406 now only used for retentions on base of warranty
      IF TempRetentionPostingBuffer[1].FINDSET THEN
        REPEAT
          Vendor.GET(PurchHeader."Buy-from Vendor No.");
          Vendor.TESTFIELD("Vendor Posting Group");
          VendPostingGr.GET(Vendor."Vendor Posting Group");
          VendPostingGr.TESTFIELD("Retention Suspense Acc.");

          GenJnlLine.INIT;
          GenJnlLine."Account Type" := GenJnlLine."Account Type"::"G/L Account";
          GenJnlLine."Account No." := VendPostingGr."Retention Suspense Acc.";

          IF PurchHeader."Applies-to Doc. Type" IN
            [PurchHeader."Applies-to Doc. Type"::Invoice,PurchHeader."Applies-to Doc. Type"::"Credit Memo"]
          THEN BEGIN
            GenJnlLine."Applies-to Doc. Type" := PurchHeader."Applies-to Doc. Type";
            GenJnlLine."Applies-to Doc. No." := PurchHeader."Applies-to Doc. No.";
          END;

          GenJnlLine."Gen. Posting Type" := 0; // None
          GenJnlLine."Gen. Bus. Posting Group" := '';
          GenJnlLine."Gen. Prod. Posting Group" := '';
          GenJnlLine."VAT Bus. Posting Group" := '';
          GenJnlLine."VAT Prod. Posting Group" := '';
          GenJnlLine."VAT Calculation Type" := GenJnlLine."VAT Calculation Type"::"Normal VAT";
          GenJnlLine."VAT Amount" := 0;
          GenJnlLine."Currency Code" := PurchHeader."Currency Code";
          GenJnlLine."Source Currency Code" := PurchHeader."Currency Code";
          GenJnlLine."Source Currency Amount" := TempRetentionPostingBuffer[1]."Retention Amount";
          GenJnlLine.Amount := TempRetentionPostingBuffer[1]."Retention Amount";
          GenJnlLine."Amount (LCY)" := TempRetentionPostingBuffer[1]."Retention Amount (ACY)";
          GenJnlLine."Skip WIP Check" := TRUE;

          IF PurchHeader."Currency Code" = '' THEN
            GenJnlLine."Currency Factor" := 1
          ELSE BEGIN
            GenJnlLine."Currency Factor" := PurchHeader."Currency Factor";
            IF GenJnlLine."Currency Factor" = CurrencyExchangeRate.ExchangeRate(1, PurchHeader."Job No.", PurchHeader."Posting Date", PurchHeader."Currency Code", FALSE) THEN
              IF CurrencyExchangeRate.HasFoundJobCurrExchRate THEN
                GenJnlLine."Exchange Rate From" := GenJnlLine."Exchange Rate From"::"Project Exchange Rate";
          END;

          IF ((GenJnlLine.Amount > 0) AND (NOT PurchHeader.Correction)) OR
             ((GenJnlLine.Amount < 0) AND PurchHeader.Correction)
          THEN BEGIN
            GenJnlLine."Debit Amount" := GenJnlLine.Amount;
            GenJnlLine."Credit Amount" := 0
          END ELSE BEGIN
            GenJnlLine."Debit Amount" := 0;
            GenJnlLine."Credit Amount" := -GenJnlLine.Amount;
          END;

          GenJnlLine."Posting Date" := PurchHeader."Posting Date";
          GenJnlLine."Document Date" := PurchHeader."Document Date";
          GenJnlLine."Due Date" := PurchHeader."Document Date";
          IF PurchHeader."Document Type" = PurchHeader."Document Type"::Invoice THEN BEGIN
            IF (TempRetentionPostingBuffer[1].Type <> 0) AND (PurchHeader."Subcontract No." <> '') AND
               (PurchHeader."Document Date" <> 0D) THEN
            BEGIN
              SubcontracterContract.GET(PurchHeader."Buy-from Vendor No.", PurchHeader."Subcontract No.");
              IF (TempRetentionPostingBuffer[1].Type = 1) AND (SubcontracterContract."Retention Payment Terms Code" <> '') THEN
              BEGIN
                PaymentTerms.GET(SubcontracterContract."Retention Payment Terms Code");
                GenJnlLine."Due Date" := CALCDATE(PaymentTerms."Due Date Calculation",PurchHeader."Document Date");
              END;
              IF (TempRetentionPostingBuffer[1].Type = 2) AND (SubcontracterContract."Retention Payment Terms Code 2" <> '') THEN
              BEGIN
                PaymentTerms.GET(SubcontracterContract."Retention Payment Terms Code 2");
                GenJnlLine."Due Date" := CALCDATE(PaymentTerms."Due Date Calculation",PurchHeader."Document Date");
              END;
            END;
          END;
          //

          GenJnlLine."Purchase Order" := TempRetentionPostingBuffer[1]."Purchase Order";
          GenJnlLine."Warranty Object" := TempRetentionPostingBuffer[1]."Warranty Object";
          GenJnlLine.Description := PurchHeader."Posting Description";
          GenJnlLine."Reason Code" := PurchHeader."Reason Code";
          GenJnlLine."Document Type" := GenJnlLineDocType;
          GenJnlLine."Document No." := GenJnlLineDocNo;
          GenJnlLine."External Document No." := GenJnlLineExtDocNo;
          GenJnlLine."System-Created Entry" := TRUE;
          GenJnlLine.Correction := PurchHeader.Correction;
          GenJnlLine.Quantity := 1;
          GenJnlLine."Source Code" := SrcCode;
          GenJnlLine."Sell-to/Buy-from No." := PurchHeader."Buy-from Vendor No.";
          GenJnlLine."Source Type" := GenJnlLine."Source Type"::Vendor;
          GenJnlLine."Source No." := PurchHeader."Buy-from Vendor No.";
          GenJnlLine."Posting No. Series" := PurchHeader."Posting No. Series";

          IF TempRetentionPostingBuffer[1].Type <> 0 THEN BEGIN
            GenJnlLine."Job No." := PurchHeader."Job No.";
            GenJnlLine."Subcontract No." := PurchHeader."Subcontract No.";
          END ELSE
            GenJnlLine."Closed Project No." := PurchHeader."Job No.";

          GenJnlLine."Shortcut Dimension 1 Code" := TempRetentionPostingBuffer[1]."Global Dimension 1 Code";
          GenJnlLine."Shortcut Dimension 2 Code" := TempRetentionPostingBuffer[1]."Global Dimension 2 Code";
          GenJnlLine."Dimension Set ID" := TempRetentionPostingBuffer[1]."Dimension Set ID";
          GenJnlLine."Cost Component" := TempRetentionPostingBuffer[1]."Cost Component";

          GenJnlLine."Retention Entry Type" := GenJnlLine."Retention Entry Type"::Purchase;

          IF PurchHeader."Document Type" IN [PurchHeader."Document Type"::Order,PurchHeader."Document Type"::Invoice] THEN
            GenJnlLine."Retention Entry Document Type" := GenJnlLine."Retention Entry Document Type"::Invoice
          ELSE
            GenJnlLine."Retention Entry Document Type" := GenJnlLine."Retention Entry Document Type"::"Credit Memo";

          GenJnlPostLine.RunWithCheck(GenJnlLine);

        UNTIL TempRetentionPostingBuffer[1].NEXT = 0;
    END;

    LOCAL PROCEDURE PlantReceivedAndCreatedOnOrder@1100525024(PurchLine2@1210190000 : Record 39) : Boolean;
    VAR
      PlantNoRec@1100525000 : Record 11012552;
    BEGIN
      //**4PS  26690
      WITH PurchLine2 DO BEGIN
        IF ("Document Type" = "Document Type"::Order) AND ("Receiving Company" = '') AND
           (Type = Type::"Fixed Asset") AND ("No." <> '') AND
           ("Plant Type" <> '') AND ("Plant Type" <> '') AND ("Cost Component Plant" <> '') AND
           (Quantity = 1) AND ("Qty. to Receive" = 0) AND ("Quantity Received" = 1)
        THEN BEGIN
          IF (CheckPlantAcquisitionOrRent(PurchLine2) = 1) THEN BEGIN
            IF PlantNoRec.GET("Plant Type", "Plant No.") THEN BEGIN
              PlantNoRec.CALCFIELDS(Bulk);
              IF (NOT PlantNoRec.Bulk) AND PlantNoRec.Posted AND (NOT PlantNoRec.External) AND
                 (PlantNoRec."Fixed Asset" = "No.") AND (PlantNoRec."Purchase Order No." = "Document No.")
              THEN
                EXIT(TRUE);
            END;
          END;
        END;
      END;
      EXIT(FALSE);
    END;

    LOCAL PROCEDURE GetPurchLineUnitCostInclDisc@1210190010(PurchLine1@1210190001 : Record 39) : Decimal;
    VAR
      PurchLine2@1210190000 : Record 39;
    BEGIN
      //**4PS
      //* Purchase line must be read a again because sometimes fields arre zero here (fi Line Amount)
      IF PurchLine2.GET(PurchLine1."Document Type", PurchLine1."Document No.", PurchLine1."Line No.") THEN
        IF (PurchLine2."Line Discount Amount" = 0) AND (PurchLine2."Inv. Discount Amount" = 0) THEN
          EXIT(PurchLine2."Direct Unit Cost")
        ELSE
          IF PurchLine2.Quantity <> 0 THEN
            EXIT(PurchLine2.Amount / PurchLine2.Quantity);

      EXIT(0);
    END;

    LOCAL PROCEDURE CopyAndDeleteSubcontractHours@1100409000(FromType@1100409005 : Option;ToType@1100409004 : Option;FromDocNo@1100409000 : Code[20];ToDocNo@1100409001 : Code[20]);
    VAR
      SubcontractingHoursInvoice@1100409002 : Record 11020694;
      SubcontractingHoursInvoice2@1100409003 : Record 11020694;
    BEGIN
      //**4PS
      SubcontractingHoursInvoice.SETRANGE(Type, FromType);
      SubcontractingHoursInvoice.SETRANGE("Document No.", FromDocNo);
      IF (NOT SubcontractingHoursInvoice.FINDSET(TRUE, TRUE)) THEN
        EXIT;

      REPEAT
        SubcontractingHoursInvoice2 := SubcontractingHoursInvoice;
        SubcontractingHoursInvoice2.Type := ToType;
        SubcontractingHoursInvoice2."Document No." := ToDocNo;
        IF FromType = 2 THEN
          SubcontractingHoursInvoice2."Purchase Order No." := FromDocNo;
        SubcontractingHoursInvoice2.INSERT(TRUE);

        SubcontractingHoursInvoice.DELETE(TRUE);
      UNTIL (SubcontractingHoursInvoice.NEXT = 0);
    END;

    LOCAL PROCEDURE PostNSItemTracking@1100528601(PurchHeader@1100525003 : Record 38;PurchLine@1100525002 : Record 39;PurchRcptLine@1100525000 : Record 121);
    VAR
      NSReservationEntry@1100528604 : Record 11071900;
      Item@1100525001 : Record 27;
      NSItemTrackingCheck@1100528600 : Codeunit 11012353;
      QuantityProcessed@1100528602 : Decimal;
      IsFirstReservLine@1100528500 : Boolean;
      ErrorFieldCaption@1100528501 : Text[250];
    BEGIN
      //**4PS
      IF (PurchRcptLine."Item No." = '') OR (PurchRcptLine.Type <> PurchRcptLine.Type::"G/L Account") THEN
        EXIT;

      IF NOT Item.GET(PurchRcptLine."Item No.") THEN
        EXIT;

      IF Item."Item Tracking Code" = '' THEN
        EXIT;

      IF PurchHeader.Receive THEN
        ErrorFieldCaption := PurchLine.FIELDCAPTION("Qty. to Receive")
      ELSE
        ErrorFieldCaption := PurchLine.FIELDCAPTION("Return Qty. to Ship");

      NSReservationEntry.SETCURRENTKEY(
        "Source ID","Source Ref. No.","Source Type","Source Subtype");
      IF PurchRcptLine."Order No." <> '' THEN BEGIN
        NSReservationEntry.SETRANGE("Source ID", PurchRcptLine."Order No.");
        NSReservationEntry.SETRANGE("Source Ref. No.", PurchRcptLine."Order Line No.");
      END ELSE BEGIN
        NSReservationEntry.SETRANGE("Source ID", PurchHeader."No.");
        NSReservationEntry.SETRANGE("Source Ref. No.", PurchLine."Line No.");
      END;
      NSReservationEntry.SETRANGE("Source Type", DATABASE::"Purchase Line");
      NSReservationEntry.SETRANGE("Source Subtype", PurchHeader."Document Type");
      IF NSReservationEntry.FINDSET(TRUE) THEN BEGIN
        IsFirstReservLine := TRUE;
        REPEAT
          IF (NSReservationEntry."Qty. to Handle (Base)" <> 0) AND
             ((NSReservationEntry."Serial No." <> '') OR (NSReservationEntry."Lot No." <> '')) THEN
          BEGIN
            NSItemTrackingCheck.CheckLine(
              NSReservationEntry, 0, PurchRcptHeader."Document Date",
              PurchRcptLine."Quantity (Base)", IsFirstReservLine, ErrorFieldCaption);
            PostNSItemTrackingEntry(PurchHeader.Receive,NSReservationEntry,PurchRcptLine,Item,PurchRcptHeader."Posting Date",PurchHeader.Invoice); //C016406.c

            QuantityProcessed += NSReservationEntry."Qty. to Handle (Base)";
            IsFirstReservLine := FALSE;
            IF PurchHeader.Invoice THEN
              NSReservationEntry.MODIFY
            ELSE
              NSReservationEntry.DELETE;
          END;
        UNTIL NSReservationEntry.NEXT = 0;
      END;

      IF ABS(QuantityProcessed) <> ABS(PurchRcptLine."Quantity (Base)") THEN
        ERROR(STRSUBSTNO(ItemTrackQuantityMismatchErr,ErrorFieldCaption,PurchRcptLine."Item No."));
    END;

    PROCEDURE PostNSItemTrackingEntry@1100528603(DoReceive@1100525004 : Boolean;VAR NSReservationEntry@1100528600 : Record 11071900;PurchRcptLine@1100525000 : Record 121;Item@1100525003 : Record 27;PostingDate@1100525001 : Date;PostingInvoice@1100525002 : Boolean);
    VAR
      NSTrackingSpecification@1100528601 : Record 11071901;
      NSItemTrackingEntry@1100528604 : Record 11071902;
      NSItemTrackingEntryRelation@1100528603 : Record 11071903;
      NSItemApplnEntry@1100528606 : Record 11071904;
      EntryNo@1100528602 : Integer;
    BEGIN
      //**4PS DP00121 function also used from codeunit 11012027
      WITH NSItemTrackingEntry DO BEGIN
        LOCKTABLE;
        IF FINDLAST THEN
          EntryNo := "Entry No." + 1
        ELSE
          EntryNo := 1;

        INIT;
        "Entry No." := EntryNo;
        "Item No." := PurchRcptLine."Item No.";
        "Posting Date" := PostingDate; //C016406.c
        "Entry Type" := "Entry Type"::Purchase;
        "Location Code" := PurchRcptLine."Location Code";
        "Document Type" := "Document Type"::"Purchase Receipt";
        "Document No." := PurchRcptLine."Document No.";
        "Document Line No." := PurchRcptLine."Line No.";
        "Variant Code" := PurchRcptLine."Variant Code";
        Open := TRUE;
        "Serial No." := NSReservationEntry."Serial No.";
        "Lot No." := NSReservationEntry."Lot No.";
        "Warranty Date Vendor" := NSReservationEntry."Warranty Date Vendor";
        "Warranty Code Vendor" := NSReservationEntry."Warranty Code Vendor";
        "Warranty Start Date Vendor" := NSReservationEntry."Warranty Start Date Vendor";
        "Warranty Period Vendor" := NSReservationEntry."Warranty Period Vendor";
        "Warranty Code Customer" := NSReservationEntry."Warranty Code Customer";
        "Warranty Start Date Customer" := NSReservationEntry."Warranty Start Date Customer";
        "Warranty Period Customer" := NSReservationEntry."Warranty Period Customer";
        "Warranty Date Customer" := NSReservationEntry."Warranty Date Customer";
        "Good Customs":= NSReservationEntry."Good Customs";
        "Shipment with T1" := NSReservationEntry."Shipment with T1";
        "Customs Destination Code" := NSReservationEntry."Customs Destination Code";
        "Expiration Date" := NSReservationEntry."Expiration Date";
        Quantity := NSReservationEntry."Qty. to Handle (Base)";
        "Remaining Quantity" := Quantity;
        Positive := ("Remaining Quantity" > 0);
        "Item Tracking":= ItemTrackingMgt.ItemTrackingOption(
          NSReservationEntry."Lot No.", NSReservationEntry."Serial No.");
        "Source Type":= "Source Type"::Vendor;
        "Source No.":= PurchRcptLine."Buy-from Vendor No.";
        "Project No." := PurchRcptLine."Job No.";
        "Service Order No." := PurchRcptLine."Service Order No.";
        //apply before insert cause applying data is added to NSItemTrackingEntry
        NSItemTrackingEntriesApply.ApplyNSItemTrackingEntry(NSItemTrackingEntry, Item."Item Tracking Code");
        INSERT;
      END;

      IF PostingInvoice AND (NSReservationEntry."Item Ledger Entry No." = 0) THEN
        NSReservationEntry."Item Ledger Entry No." := EntryNo;

      WITH NSTrackingSpecification DO BEGIN
        INIT;
        TRANSFERFIELDS(NSReservationEntry);
        "Entry No." := EntryNo;
        "Quantity Handled (Base)" := NSReservationEntry."Qty. to Handle (Base)";
        "Qty. to Handle (Base)" := 0;
        INSERT;
      END;

      WITH NSItemTrackingEntryRelation DO BEGIN
        INIT;
        "Item Tracking Entry No." := EntryNo;
        "Serial No." := NSReservationEntry."Serial No.";
        "Lot No." := NSReservationEntry."Lot No.";
        TransferFieldsPurchRcptLine(PurchRcptLine);
        INSERT;
      END;

      //Application
      IF NOT NSItemTrackingEntry.Positive THEN
        EXIT;

      IF NOT DoReceive THEN
        EXIT;

      WITH NSItemApplnEntry DO BEGIN
        LOCKTABLE;
        IF FINDLAST THEN
          EntryNo := "Entry No." + 1
        ELSE
          EntryNo := 1;

        INIT;
        "Entry No." := EntryNo;
        "NS Item Tracking Entry No." := NSItemTrackingEntry."Entry No.";
        "Inbound Item Entry No." := NSItemTrackingEntry."Entry No.";
        "Outbound Item Entry No." := 0;
        Quantity := NSItemTrackingEntry.Quantity;
        "Posting Date" := NSItemTrackingEntry."Posting Date";
        "Creation Date" := CURRENTDATETIME;
        "Created By" := USERID;
        INSERT;
      END;
    END;

    LOCAL PROCEDURE InsertNSItemTrackingRelation@1100528500(PurchHeader@1100525003 : Record 38;PurchLine@1100528501 : Record 39;PurchRcptLine@1100525001 : Record 121;RowID@1100528503 : Text[100]);
    VAR
      NSReservationEntry@1100528502 : Record 11071900;
      NSItemTrackingRelation@1100528504 : Record 11071905;
      NSItemTrackingEntry@1100525000 : Record 11071902;
      Item@1100525002 : Record 27;
    BEGIN
      //**4PS DP00121
      NSReservationEntry.SETCURRENTKEY(
        "Source ID","Source Ref. No.","Source Type","Source Subtype");
      NSReservationEntry.SETRANGE("Source ID", PurchLine."Document No.");
      NSReservationEntry.SETRANGE("Source Ref. No.", PurchLine."Line No.");
      NSReservationEntry.SETRANGE("Source Type", DATABASE::"Purchase Line");
      NSReservationEntry.SETRANGE("Source Subtype", PurchLine."Document Type");
      IF NSReservationEntry.FINDSET(TRUE) THEN
        REPEAT
          IF NSReservationEntry."Item Ledger Entry No." <> 0 THEN BEGIN
            IF NSItemTrackingRelation.GET(NSReservationEntry."Item Ledger Entry No.") THEN BEGIN
              //Must be second invoice. Adjust the first and create new
              NSItemTrackingEntry.GET(NSReservationEntry."Item Ledger Entry No.");
              NSItemTrackingEntry.Quantity -= NSReservationEntry."Qty. to Handle (Base)";
              NSItemTrackingEntry."Remaining Quantity" -= NSReservationEntry."Qty. to Handle (Base)";
              NSItemTrackingEntry.MODIFY;

              Item.GET(PurchLine."Item No.");
              NSReservationEntry."Item Ledger Entry No." := 0;
              PurchRcptHeader.GET(PurchRcptLine."Document No.");
              PostNSItemTrackingEntry(PurchHeader.Receive,NSReservationEntry,PurchRcptLine,Item,PurchRcptHeader."Posting Date",PurchHeader.Invoice);
            END;
            NSItemTrackingRelation."Item Tracking Entry No." := NSReservationEntry."Item Ledger Entry No.";
            NSItemTrackingRelation."Source RowId" := RowID;
            NSItemTrackingRelation."Project Ledger Entry No." := JobLedgEntryNo;
            NSItemTrackingRelation."Service Ledger Entry No." := ServLedgEntryNo;
            NSItemTrackingRelation.INSERT;
            NSReservationEntry.DELETE;
          END;
        UNTIL NSReservationEntry.NEXT = 0;
    END;

    LOCAL PROCEDURE GetCommentForProjEntry@1100409002(PurchLine@1100409000 : Record 39;MaxLen@1100409001 : Integer) : Text[100];
    VAR
      PurchCommentLine@1100409002 : Record 43;
    BEGIN
      //**4PS
      CASE PurchLine."Document Type" OF
        PurchLine."Document Type"::Order:
          PurchCommentLine.SETRANGE("Document Type", PurchCommentLine."Document Type"::Order);
        PurchLine."Document Type"::Invoice:
          PurchCommentLine.SETRANGE("Document Type", PurchCommentLine."Document Type"::Invoice);
        PurchLine."Document Type"::"Credit Memo":
          PurchCommentLine.SETRANGE("Document Type", PurchCommentLine."Document Type"::"Credit Memo");
        ELSE
          EXIT('')
      END;
      PurchCommentLine.SETRANGE("No.", PurchLine."Document No.");
      PurchCommentLine.SETRANGE("Document Line No.", PurchLine."Line No.");
      PurchCommentLine.SETFILTER(Comment, '<>%1', '');
      IF PurchCommentLine.FINDFIRST THEN
        EXIT(COPYSTR(PurchCommentLine.Comment, 1, MaxLen));
      EXIT('');
    END;

    PROCEDURE SetPlotNoReceipts@1100525013(PlotNo@1100525000 : Code[10]);
    BEGIN
      //**4PS
      SkipClearAll := TRUE;
      PlotNoReceipts := PlotNo;
    END;

    LOCAL PROCEDURE CheckReasonCodeFGases@1100528300(VAR PurchaseLine@1100528300 : Record 39);
    VAR
      PurchaseLineToCheck@1100528301 : Record 39;
      Item@1100525000 : Record 27;
    BEGIN
      //**4PS
      PurchaseLineToCheck.COPY(PurchaseLine);

      PurchaseLineToCheck.SETRANGE("Document Type", PurchaseLine."Document Type");
      PurchaseLineToCheck.SETRANGE("Document No.", PurchaseLine."Document No.");
      PurchaseLineToCheck.SETRANGE(Type, PurchaseLine.Type::Item);
      IF PurchaseLineToCheck.FINDSET THEN BEGIN
        REPEAT
          IF (NOT Item.GET(PurchaseLineToCheck."Item No.")) THEN
            Item.INIT;
          IF (Item."Reason Code F-Gases Mandatory") THEN
            PurchaseLineToCheck.TESTFIELD("Reason Code");
        UNTIL (PurchaseLineToCheck.NEXT = 0);
      END;
    END;

    LOCAL PROCEDURE CheckPostingReceiptAllowed@1100528800(PurchaseLine@1100528800 : Record 39);
    VAR
      PurchaseHeader@1100528801 : Record 38;
    BEGIN
      //**4PS
      IF NOT PurchSetup."Block Posting Receipts" THEN
        EXIT;

      PurchaseHeader.GET(PurchaseLine."Document Type", PurchaseLine."Document No.");

      IF (PurchaseHeader."Contract Applicable") AND (PurchaseHeader."Return Date Signed Contract" = 0D) THEN
        ERROR(Text11012020, PurchaseHeader.FIELDCAPTION("Return Date Signed Contract"), PurchaseLine."Document Type", PurchaseLine."Document No.");

      IF (PurchaseHeader.LetterOfCreditIsApplicable) AND (PurchaseHeader."Return Date Letter of Credit" = 0D) THEN
        ERROR(Text11012020, PurchaseHeader.FIELDCAPTION("Return Date Letter of Credit"), PurchaseLine."Document Type", PurchaseLine."Document No.");
    END;

    LOCAL PROCEDURE SetReceiveMarkedOnly@1100525014(VAR PurchaseHeader@1100409000 : Record 38);
    BEGIN
      //**4PS
      ReceiveMarkedOnly := PurchaseHeader."Markedonly Receipt Run";
      PurchaseHeader."Markedonly Receipt Run" := FALSE;
    END;

    LOCAL PROCEDURE PutReceiveMarkedOnlyFilter@1100525015(VAR PurchLine@1100525000 : Record 39);
    BEGIN
      //**4PS
      IF ReceiveMarkedOnly THEN
        PurchLine.SETRANGE("Marked for Receipt Run", TRUE);
    END;

    LOCAL PROCEDURE UpdateHeadersForApproval@1100525008(VAR PurchHeader@1100525001 : Record 38;VAR PurchLine@1100525000 : Record 39);
    BEGIN
      //**4PS NAV2017
      WITH PurchHeader DO BEGIN
        IF NOT ("Document Type" IN ["Document Type"::Invoice,"Document Type"::"Credit Memo"]) THEN
          EXIT;

        IF (PurchLine.Type <> PurchLine.Type::"G/L Account") OR (PurchLine."No." = '') THEN
          EXIT;

        IF NOT (PurchLine."No." IN [PurchSetup."Purchase Registration Account", PurchSetup."Preregistration WIP Account"]) THEN
          EXIT;

        IF ("Amount excl. VAT" <> 0) OR ("Amount incl. VAT" <> 0) THEN BEGIN
          IF ("Document Type" = "Document Type"::Invoice) AND PurchInvHeader."Invoice Approved" THEN BEGIN
            CheckApprovalTemplate(PurchHeader);

            PurchInvHeader."Invoice Approved" := FALSE;
            PurchInvHeader."Status (Approval)" := PurchInvHeader."Status (Approval)"::Open;
            IF PurchInvHeader."On Hold" <> '' THEN BEGIN
              OnHoldRec.GET(PurchInvHeader."On Hold");
              PurchInvHeader."Remain On Hold" := OnHoldRec."Remain On Hold";
            END;
            PurchInvHeader.MODIFY;
          END;
          IF ("Document Type" = "Document Type"::"Credit Memo") AND PurchCrMemoHeader."Credit Memo Approved" THEN BEGIN
            CheckApprovalTemplate(PurchHeader);

            PurchCrMemoHeader."Credit Memo Approved" := FALSE;
            PurchCrMemoHeader."Status (Approval)" := PurchCrMemoHeader."Status (Approval)"::Open;
            IF PurchCrMemoHeader."On Hold" <> '' THEN BEGIN
              OnHoldRec.GET(PurchCrMemoHeader."On Hold");
              PurchCrMemoHeader."Remain On Hold" := OnHoldRec."Remain On Hold";
            END;
            PurchCrMemoHeader.MODIFY;
          END;
        END;

        IF ("Amount excl. VAT" = 0) AND ("Amount incl. VAT" = 0) THEN
          CASE "Document Type" OF
            "Document Type"::Invoice:
              BEGIN
                PurchInvHeader."Invoice Approved" := FALSE;
                PurchInvHeader."Status (Approval)" := PurchInvHeader."Status (Approval)"::Open;
                PurchInvHeader.MODIFY;
              END;
            "Document Type"::"Credit Memo":
              BEGIN
                PurchCrMemoHeader."Credit Memo Approved" := FALSE;
                PurchCrMemoHeader."Status (Approval)" := PurchCrMemoHeader."Status (Approval)"::Open;
                PurchCrMemoHeader.MODIFY;
              END;
          END;
      END;
    END;

    LOCAL PROCEDURE PostSurchargePostingBuffer@1100525026(PurchHeader@1100525001 : Record 38);
    VAR
      GenJnlLine@1100525000 : Record 81;
    BEGIN
      //**4PS
      TempSurchargePostingBuffer[1].RESET;
      IF TempSurchargePostingBuffer[1].FIND('-') THEN
        REPEAT
          GenJnlLine.INIT;
          GenJnlLine."Source Code" := SrcCode;
          GenJnlLine."Reason Code":= PurchHeader."Reason Code";
          GenJnlLine."Account Type" := GenJnlLine."Account Type"::"G/L Account";
          GenJnlLine."Account No." := TempSurchargePostingBuffer[1]."G/L Account";
          GenJnlLine."Posting Date" := PurchHeader."Posting Date";
          GenJnlLine."Document Type" := GenJnlLineDocType;
          GenJnlLine."Document No." := GenJnlLineDocNo;
          GenJnlLine."System-Created Entry" := TRUE;
          GenJnlLine."Document Date" := PurchHeader."Document Date";
          GenJnlLine.Description := TempSurchargePostingBuffer[1].Description;
          GenJnlLine."Description 2" := TempSurchargePostingBuffer[1]."Description 2";
          GenJnlLine.Amount := TempSurchargePostingBuffer[1].Amount;
          GenJnlLine.VALIDATE(Amount);
          GenJnlLine."Shortcut Dimension 1 Code" := TempSurchargePostingBuffer[1]."Global Dimension 1 Code";
          GenJnlLine."Shortcut Dimension 2 Code" := TempSurchargePostingBuffer[1]."Global Dimension 2 Code";
          GenJnlLine."Dimension Set ID" := TempSurchargePostingBuffer[1]."Dimension Set ID";
          GenJnlLine."Cost Component" := TempSurchargePostingBuffer[1]."Cost Component";
          GenJnlLine."Job No." := TempSurchargePostingBuffer[1]."Job No.";
          GenJnlLine.Element := TempSurchargePostingBuffer[1].Element;
          GenJnlLine."Extension Contract" := TempSurchargePostingBuffer[1]."Extension Contract";
          GenJnlLine."Service Order No." := TempSurchargePostingBuffer[1]."Service Order No.";
          GenJnlLine.GetServiceCategory;
          GenJnlLine."Service Contract No." := TempSurchargePostingBuffer[1]."Service Contract No.";
          GenJnlLine."Service Location No." := TempSurchargePostingBuffer[1]."Service Location No.";
          GenJnlLine."Origin Type" := TempSurchargePostingBuffer[1]."Origin Type";
          GenJnlLine."Interest Date" := PurchHeader."Interest Date";
          GenJnlLine."Employee No." := TempSurchargePostingBuffer[1]."Employee No.";

          //Call C006064 n  FIELD "Buy-Back Item (Plant Order)" USED FOR OTHER PURPOSE
          GenJnlLine."Skip WIP Check" := TempSurchargePostingBuffer[1]."Buy-Back Item (Plant Order)";

          RunGenJnlPostLine(GenJnlLine);
        UNTIL TempSurchargePostingBuffer[1].NEXT = 0;
      TempSurchargePostingBuffer[1].DELETEALL;
    END;

    LOCAL PROCEDURE PostRequisitionPostingBuffer@1100525025(PurchHeader@1100525001 : Record 38);
    VAR
      GenJnlLine@1100525000 : Record 81;
    BEGIN
      //**4PS
      TempRequisitionPostingBuffer[1].RESET;
      IF TempRequisitionPostingBuffer[1].FIND('-') THEN
        REPEAT
          GenJnlLine.INIT;
          GenJnlLine."Source Code" := SrcCode;
          GenJnlLine."Reason Code":= PurchHeader."Reason Code";
          GenJnlLine."Account Type" := GenJnlLine."Account Type"::"G/L Account";
          GenJnlLine."Account No." := TempRequisitionPostingBuffer[1]."G/L Account";
          GenJnlLine."Posting Date" := PurchHeader."Posting Date";
          GenJnlLine."Document Type" := GenJnlLineDocType;
          GenJnlLine."Document No." := GenJnlLineDocNo;
          GenJnlLine."System-Created Entry" := TRUE;
          GenJnlLine."Document Date" := PurchHeader."Document Date";
          GenJnlLine.Description := TempRequisitionPostingBuffer[1].Description;
          GenJnlLine."Description 2" := TempRequisitionPostingBuffer[1]."Description 2";
          GenJnlLine."Bal. Account No." := TempRequisitionPostingBuffer[1]."Bal. Account No.";
          GenJnlLine.Amount := TempRequisitionPostingBuffer[1].Amount;
          GenJnlLine.VALIDATE(Amount);
          GenJnlLine."Shortcut Dimension 1 Code" := TempRequisitionPostingBuffer[1]."Global Dimension 1 Code";
          GenJnlLine."Shortcut Dimension 2 Code" := TempRequisitionPostingBuffer[1]."Global Dimension 2 Code";
          GenJnlLine."Dimension Set ID" := TempRequisitionPostingBuffer[1]."Dimension Set ID";
          GenJnlLine."Job No." := TempRequisitionPostingBuffer[1]."Job No.";
          GenJnlLine."Origin Type" := TempRequisitionPostingBuffer[1]."Origin Type";
          RunGenJnlPostLine(GenJnlLine);
        UNTIL TempRequisitionPostingBuffer[1].NEXT = 0;
      TempRequisitionPostingBuffer[1].DELETEALL;
    END;

    LOCAL PROCEDURE PostComplWIPPostingBuffer@1100525023(PurchHeader@1100525000 : Record 38);
    VAR
      GenJnlLine@1100525001 : Record 81;
    BEGIN
      //**4PS
      TempComplWIPPostingBuffer[1].RESET;
      IF TempComplWIPPostingBuffer[1].FIND('-') THEN
        REPEAT
          GenJnlLine.INIT;
          GenJnlLine."Source Code" := SrcCode;
          GenJnlLine."Reason Code":= PurchHeader."Reason Code";
          GenJnlLine."Cost Component":= TempComplWIPPostingBuffer[1]."Cost Component";
          GenJnlLine."Account Type" := GenJnlLine."Account Type"::"G/L Account";
          GenJnlLine."Account No." := TempComplWIPPostingBuffer[1]."G/L Account";
          GenJnlLine."Posting Date" := PurchHeader."Posting Date";
          GenJnlLine."Document Type" := GenJnlLineDocType;
          GenJnlLine."Document No." := GenJnlLineDocNo;
          GenJnlLine."System-Created Entry" := TRUE;
          GenJnlLine."Document Date" := PurchHeader."Document Date";
          GenJnlLine.Description := TempComplWIPPostingBuffer[1].Description;
          GenJnlLine."Description 2" := TempComplWIPPostingBuffer[1]."Description 2";
          GenJnlLine.Amount := TempComplWIPPostingBuffer[1].Amount;
          GenJnlLine.VALIDATE(Amount);
          GenJnlLine."Shortcut Dimension 1 Code" := TempComplWIPPostingBuffer[1]."Global Dimension 1 Code";
          GenJnlLine."Shortcut Dimension 2 Code" := TempComplWIPPostingBuffer[1]."Global Dimension 2 Code";
          GenJnlLine."Dimension Set ID" := TempComplWIPPostingBuffer[1]."Dimension Set ID";
          GenJnlLine."Closed Project No." := TempComplWIPPostingBuffer[1]."Job No.";
          GenJnlLine."Closed Service Order No." := TempComplWIPPostingBuffer[1]."Service Order No.";
          GenJnlLine."Closed Service Contract No." := TempComplWIPPostingBuffer[1]."Service Contract No.";
          GenJnlLine."Origin Type" := TempComplWIPPostingBuffer[1]."Origin Type";
          RunGenJnlPostLine(GenJnlLine);
        UNTIL TempComplWIPPostingBuffer[1].NEXT = 0;
      TempComplWIPPostingBuffer[1].DELETEALL;
    END;

    LOCAL PROCEDURE CheckAndUpdateOnHoldCode@1100525044(VAR PurchHeader@1100525000 : Record 38;Vendor@1100525003 : Record 23;VAR ModifyHeader@1100525002 : Boolean);
    VAR
      OnHoldCode@1100525001 : Code[3];
    BEGIN
      //**4PS
      WITH PurchHeader DO BEGIN
        OnHoldCode := DetermineOnHoldCode;
        IF OnHoldCode <> "On Hold" THEN BEGIN
          VALIDATE("On Hold", OnHoldCode);
          ModifyHeader := TRUE;
        END;

        IF PurchSetup."Block Invoices Mandatory" AND (NOT Vendor."Ignore Block Inv. Mandatory") THEN BEGIN
          TESTFIELD("On Hold");
          TESTFIELD("Approvement Initials");
        END;
      END;
    END;

    LOCAL PROCEDURE OnHoldCodeFromPurchLines@1100528201(VAR PurchHeader@1100528201 : Record 38;VAR OnHold@1100528202 : Code[3];VAR Initials@1100528203 : Code[10]);
    VAR
      PurchaseLine@1100528200 : Record 39;
      OnHoldCode@1100528204 : Record 11012031;
    BEGIN
      //**4Ps
      PurchaseLine.SETRANGE("Document Type",PurchHeader."Document Type");
      PurchaseLine.SETRANGE("Document No.",PurchHeader."No.");
      PurchaseLine.SETFILTER(PurchaseLine."On Hold", '<>%1', '');
      IF PurchaseLine.FINDFIRST THEN BEGIN
        OnHold := PurchaseLine."On Hold";
        IF OnHoldCode.GET(PurchaseLine."On Hold") THEN
          Initials := OnHoldCode."Default Approvement Initials";
      END;
    END;

    LOCAL PROCEDURE CheckWKAAmount@1100525045(PurchHeader@1100525000 : Record 38;Vendor@1100525001 : Record 23;WKA@1100525002 : Boolean);
    BEGIN
      //**4PS
      WITH PurchHeader DO BEGIN
        IF WKA THEN BEGIN
          CALCFIELDS(Amount);
          IF "Labor Amount" > Amount THEN
            ERROR(Text11012002,FIELDCAPTION("Labor Amount"),FIELDCAPTION(Amount), "Document Type", "No.");

        END;
      END;
    END;

    LOCAL PROCEDURE CheckIntrastat@1210190020(PurchHeader@1100525000 : Record 38);
    VAR
      CountryRegion@1210190000 : Record 9;
      PurchLine@1100525001 : Record 39;
      TradeItem@1100525004 : Record 11012317;
      Item@1100525003 : Record 27;
      IntraStatCodeOrig@1210190001 : Code[10];
      IntraStatCodeDest@1210190002 : Code[10];
      TariffNo@1100525002 : Code[20];
    BEGIN
      //**4PS
      WITH PurchHeader DO BEGIN
        IF NOT ("Document Type" IN ["Document Type"::Invoice,"Document Type"::"Credit Memo"]) THEN
          EXIT;
        IF NOT "Invoice Lines Input" THEN
          EXIT;
        IF ("Country of Origin" = '') OR ("Country of Destination" = '') THEN
          EXIT;
        IF "Country of Origin" = "Country of Destination" THEN
          EXIT;

        IntraStatCodeOrig := '';
        IntraStatCodeDest := '';
        IF CountryRegion.GET("Country of Origin") THEN
          IntraStatCodeOrig := CountryRegion."Intrastat Code";
        IF CountryRegion.GET("Country of Destination") THEN
          IntraStatCodeDest := CountryRegion."Intrastat Code";
        IF (IntraStatCodeOrig = '') OR (IntraStatCodeDest = '') THEN
          EXIT;
        IF (IntraStatCodeOrig = IntraStatCodeDest) THEN
          EXIT;

        PurchLine.RESET;
        PurchLine.SETRANGE("Document Type","Document Type");
        PurchLine.SETRANGE("Document No.","No.");
        PurchLine.SETRANGE("Cost Type", PurchLine."Cost Type"::Material);
        PurchLine.SETFILTER(Type, '<>%1', PurchLine.Type::" ");
        PurchLine.SETFILTER("Tariff No.", '=%1', '');
        IF PurchLine.FIND('-') THEN
          REPEAT
            TariffNo := '';
            IF PurchLine."Trade Item" <> '' THEN BEGIN
              IF NOT TradeItem.GET(PurchLine."Vendor (Trade Item)", PurchLine."Trade Item") THEN
                TradeItem.INIT;
              TariffNo := TradeItem."CBS Code";
            END;

            IF (TariffNo = '') AND (PurchLine."Item No." <> '') THEN BEGIN
              IF NOT Item.GET(PurchLine."Item No.") THEN
                Item.INIT;
              TariffNo := Item."Tariff No.";
            END;

            IF TariffNo = '' THEN
              PurchLine.TESTFIELD("Tariff No.");
          UNTIL PurchLine.NEXT = 0;

      END;
    END;

    LOCAL PROCEDURE RestorePurchLineFixedAssetNo@1100525016(PurchaseLine@1100525000 : Record 39;VAR PurchaseLine2@1100525001 : Record 39);
    BEGIN
      //**4PS
      IF (PurchaseLine.Type = PurchaseLine.Type::"Fixed Asset") AND (PurchaseLine."No." <> '') AND (PurchaseLine2."No." = '') THEN
        PurchaseLine2."No." := PurchaseLine."No.";
    END;

    PROCEDURE WasNothingToPost@1100529600() : Boolean;
    BEGIN
      //**4PS
      EXIT(NothingToPostFlag);
    END;

    PROCEDURE PrePostRoundingOff@1100288000(pPurchHeader@1100288000 : Record 38);
    VAR
      lPurchaseLine@1100288001 : Record 39;
      BiggestLineNo@1100288002 : Integer;
      AmountIncludingVAT@1100409000 : Decimal;
      GLAcc@1101285000 : Record 15;
      PurchLine@1101285001 : Record 39;
    BEGIN
      //4PSSE, DL, 131202, apply rounding BEFORE margin-check

      //>>131210
      IF NOT pPurchHeader.Invoice THEN
        EXIT;
      //<<131210

      PurchSetup.GET;
      GetGLSetup;
      IF (NOT PurchSetup."Invoice Rounding") AND (NOT GLSetup."Norwegian Localization Active") THEN
        EXIT;

      IF (NOT PurchSetup."Invoice Rounding") AND (GLSetup."Norwegian Localization Active") THEN BEGIN
        lPurchaseLine.SETRANGE("Document Type",pPurchHeader."Document Type");
        lPurchaseLine.SETRANGE("Document No.",pPurchHeader."No.");
        IF lPurchaseLine.FINDLAST THEN
          BiggestLineNo := lPurchaseLine."Line No.";
        lPurchaseLine.SETFILTER("Qty. to Invoice",'<>0');
          AmountIncludingVAT := 0;
        IF lPurchaseLine.FINDSET(FALSE) THEN
        REPEAT
          AmountIncludingVAT += lPurchaseLine."Amount Including VAT";
        UNTIL lPurchaseLine.NEXT = 0;
        BiggestLineNo := MAX(BiggestLineNo,lPurchaseLine."Line No.");
        lPurchaseLine."Line No." := BiggestLineNo;

        IF AddInvoiceRoundingLine(AmountIncludingVAT - pPurchHeader."Amount incl. VAT",FALSE,BiggestLineNo,pPurchHeader,lPurchaseLine) THEN BEGIN
          GLAcc.GET(lPurchaseLine."No.");
          lPurchaseLine.Description := GLAcc.Name;
          lPurchaseLine.INSERT;
        END;
        EXIT;
      END;

      WITH pPurchHeader DO
        IF "Currency Code" = '' THEN
          Currency.InitRoundingPrecision
        ELSE BEGIN
          Currency.GET("Currency Code");
          Currency.TESTFIELD("Amount Rounding Precision");
        END;

      RoundingLineInserted := FALSE;
      LastLineRetrieved := FALSE;
      PurchaseLinesProcessed := FALSE; //180104
      CLEAR(TotalPurchLine);

      lPurchaseLine.SETRANGE("Document Type",pPurchHeader."Document Type");
      lPurchaseLine.SETRANGE("Document No.",pPurchHeader."No.");
      IF lPurchaseLine.FINDLAST THEN
        BiggestLineNo := lPurchaseLine."Line No.";
      lPurchaseLine.SETFILTER("Qty. to Invoice",'<>0');
      IF lPurchaseLine.FIND('-') THEN
      REPEAT
        IF RoundingLineInserted THEN
          LastLineRetrieved := TRUE
        ELSE BEGIN
          TotalPurchLine."Amount Including VAT" += lPurchaseLine."Amount Including VAT";
          PurchLine.GET(lPurchaseLine."Document Type",lPurchaseLine."Document No.",lPurchaseLine."Line No.");
          LastLineRetrieved := TempPurchLineGlobal.NEXT = 0;
          IF LastLineRetrieved THEN BEGIN
            BiggestLineNo := MAX(BiggestLineNo,PurchLine."Line No.");
            PurchLine."Line No." := BiggestLineNo;
            IF InvoiceRounding(pPurchHeader,PurchLine,FALSE,BiggestLineNo) THEN BEGIN
              GLAcc.GET(PurchLine."No.");
              PurchLine.Description := GLAcc.Name;
              PurchLine.INSERT;
            END;
          END;
        END;
      UNTIL LastLineRetrieved;
      CLEAR(TotalPurchLine);
    END;

    LOCAL PROCEDURE PostLoan@1100528501(PurchHeader@1100528501 : Record 38;PurchLine@1100528500 : Record 39;InvoicePostBuffer@1100528504 : Record 49);
    VAR
      LoanLedgerEntry@1100528503 : Record 11229444;
    BEGIN
      //**4PS
      IF (PurchLine."Loan Code" = '') THEN
        EXIT;

      WITH LoanLedgerEntry DO BEGIN
        INIT;
        "Document No." := GenJnlLineDocNo;
        Type := Type::Purchase;
        "Posting Date" := PurchHeader."Posting Date";
        "Document Date" := PurchHeader."Document Date";
        "Account No." := PurchLine."No.";
        "Loan Code" := PurchLine."Loan Code";
        "Loan Type" := PurchLine."Loan Type";
        Description := PurchLine.Description;
        Quantity := PurchLine."Qty. to Invoice";
        "Amount (LCY)" := InvoicePostBuffer.Amount;
        Amount := InvoicePostBuffer."Amount (ACY)";
        "Currency Code" := PurchLine."Currency Code";
        "Global Dimension 1 Code" := PurchLine."Shortcut Dimension 1 Code";
        "Global Dimension 2 Code" := PurchLine."Shortcut Dimension 2 Code";
        "Dimension Set ID" := PurchLine."Dimension Set ID";

        LoanJnlPostLine.RUN(LoanLedgerEntry);
      END;
    END;

    LOCAL PROCEDURE CopyDocuments@1100525017(PurchHeader@1100525000 : Record 38;PurchRcptHeader@1100525001 : Record 120);
    VAR
      SourceRecRef@1100525002 : RecordRef;
      TargetRecReef@1100525003 : RecordRef;
      DocumentLinkManagement@1100525004 : Codeunit 11012401;
    BEGIN
      //**4PS
      SourceRecRef.GETTABLE(PurchHeader);
      TargetRecReef.GETTABLE(PurchRcptHeader);
      DocumentLinkManagement.CopyDocLinks(SourceRecRef, TargetRecReef);
    END;

    LOCAL PROCEDURE CheckFinalInstallmentAllowed@1100528202(PurchHeader@1000 : Record 38);
    VAR
      UserSetup@1100528200 : Record 91;
      PurchLine@1001 : Record 39;
    BEGIN
      //**4PS
      IF UserSetup.GET(USERID) THEN BEGIN
        IF UserSetup."Post Final Inst Purch Order" THEN
          EXIT;
        WITH PurchHeader DO BEGIN
          PurchLine.RESET;
          PurchLine.SETRANGE("Document Type","Document Type");
          PurchLine.SETRANGE("Document No.","No.");
          PutPromisedReceiveDateFilter(PurchLine);
          PutReceiveMarkedOnlyFilter(PurchLine);
          PurchLine.SETRANGE("Final Installment",TRUE);
          IF NOT PurchLine.ISEMPTY THEN
            PurchLine.FIELDERROR("Final Installment");
        END;
      END;
    END;

    BEGIN
    {
      4PS07 HBK 03-08-2009, Transfer Objectfields to Project Inventory Entry
      4PS08 HBK 06-05-2010, Transfer Element to Project Inventory Entry
      4PS09 MMA 19-02-2010 Changes RFC Vendor rating
      4PS10 KK 22-11-2010, On hold when no contract returned or when no letter of credit returned.
      4PS11 JD 25-01-2010 Documentmanagement changes
      4PS, C024747, 22-12-2015, Read permissions added for table 17
      4PS 21-06-16 UKR-C21173 KD: New project inventory screen (BI006) - Trigger PostProjInventory changed
      4PS 08-02-17 UKR-C32789 KD: Comments for logistics (BI003a) - Trigger PostProjInventory changed
      4PSSE DL 131202 apply rounding BEFORE margin-check


      --- ExFlow --->
      Code        : OnRun
      Globals
      161207 ITERO.WG Merge Exflow 4.11
      190401 SICH Upgraded to 513
      <-- ExFlow ---

      141117 ITERO.DL handle if Exflow is not in license
      150116 ITERO.DL apply GLAcc.Name in InvoiceRounding()
      150713 ITERO.DL split InvoiceRounding into  InvoiceRounding + AddInvoiceRoundingLine
      160929 ITERO.DL RFC148 handle Payment Reference for more countries and added OCR
      170111 ITERO.WG Moved CALCFIELDS NAVFI fields before create invoice
      170822 ITERO.DL made AddInvoiceRoundingLine non-local
      170908 ITERO.DL pure276534 KID missing on creditmemo
      180104 ITERO.DL many roundinglines where created
      190122 ORANGO.DL Feature #22704 Rounding purchase invoice regardless if invoice amount (head) is rounded or not
      190427 ORANGO.DL #23967 invoicemargincheck don't follow nav-setup
      190509 ORANGO.SB Batch-posting fix (CU87101)
      190614 ORANGO.WG #24659 invoicemargincheck
    }
    END.
  }
}

