OBJECT Codeunit 11128586 OIOUBL Export Service Invoice
{
  OBJECT-PROPERTIES
  {
    Date=;
    Time=;
    Version List=NAVDK10.00 (13616);
  }
  PROPERTIES
  {
    TableNo=5992;
    OnRun=VAR
            ServInvHeader2@1101100007 : Record 5992;
            ServInvLine@1101100000 : Record 5993;
            ServInvLine2@1101100008 : Record 5993;
            SalespersonPurchaser@1060013 : Record 13;
            OIOUBLProfile@1060015 : Record 11128570;
            RBMgt@1060006 : Codeunit 419;
            XMLDOMManagement@1060019 : Codeunit 6224;
            XMLCurrNode@1060012 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlNode";
            XMLNewChild@1060005 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlNode";
            XMLdocOut@1060004 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlDocument";
            CurrencyCode@1060007 : Code[10];
            Prefix@1101100004 : Text[30];
            DocNameSpace@1101100005 : Text[100];
            FromFile@1060008 : Text[1024];
            ToFile@1060009 : Text[1024];
            DocNameSpace2@1060011 : Text[250];
            Prefix2@1060010 : Text[30];
            VATPercentage@1060002 : Decimal;
            TaxableAmount@1060014 : Decimal;
            TaxAmount@1060003 : Decimal;
            TotalAmount@1060001 : Decimal;
            TotalInvDiscountAmount@1060000 : Decimal;
            TotalTaxAmount@1060016 : Decimal;
            DocumentType@1060018 : 'Quote,Order,Invoice,Credit Memo';
            FileName@1060017 : Text;
          BEGIN
            CODEUNIT.RUN(CODEUNIT::"OIOUBL Check Service Invoice",Rec);
            ReadGLSetup;
            ReadCompanyInfo;

            IF "Currency Code" = '' THEN
              CurrencyCode := GLSetup."LCY Code"
            ELSE
              CurrencyCode := "Currency Code";

            ServInvLine.SETRANGE("Document No.","No.");
            ServInvLine.SETFILTER(Type,'>%1',0);
            ServInvLine.SETFILTER("No.",'<>%1',' ');
            IF NOT ServInvLine.FINDSET THEN
              EXIT;

            FromFile := RBMgt.ServerTempFileName('');

            // Invoice
            Header := '<?xml version="1.0" encoding="UTF-8" ?> ' +
              '<Invoice xsi:schemaLocation="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2 UBL-Invoice-2.0.xsd" ' +
              'xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2" ' +
              'xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2" ' +
              'xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2" ' +
              'xmlns:ccts="urn:oasis:names:specification:ubl:schema:xsd:CoreComponentParameters-2" ' +
              'xmlns:sdt="urn:oasis:names:specification:ubl:schema:xsd:SpecializedDatatypes-2" ' +
              'xmlns:udt="urn:un:unece:uncefact:data:specification:UnqualifiedDataTypesSchemaModule:2"/> ';

            XMLDOMManagement.LoadXMLDocumentFromText(Header,XMLdocOut);
            XMLCurrNode := XMLdocOut.DocumentElement;

            WITH OIOUBLDOMManagement DO BEGIN
              DocNameSpace := 'urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2';
              DocNameSpace2 := 'urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2';

              Prefix := 'cbc';
              Prefix2 := 'cac';

              AddElement(XMLCurrNode,'UBLVersionID','2.0',DocNameSpace,XMLNewChild,Prefix);
              AddElement(XMLCurrNode,'CustomizationID','OIOUBL-2.02',DocNameSpace,XMLNewChild,Prefix);

              AddElement(
                XMLCurrNode,'ProfileID',
                OIOUBLProfile.GetOIOUBLProfileID(Rec."OIOUBL Profile Code",Rec."Customer No."),
                DocNameSpace,XMLNewChild,Prefix);
              XMLCurrNode := XMLNewChild;
              AddAttribute(XMLCurrNode,'schemeID','urn:oioubl:id:profileid-1.2');
              AddAttribute(XMLCurrNode,'schemeAgencyID','320');
              XMLCurrNode := XMLCurrNode.ParentNode;

              AddElement(XMLCurrNode,'ID',"No.",DocNameSpace,XMLNewChild,Prefix);
              AddElement(XMLCurrNode,'CopyIndicator',OIOUBLDocumentEncode.BooleanToText("Electronic Invoice Created"),
                DocNameSpace,XMLNewChild,Prefix);
              AddElement(XMLCurrNode,'IssueDate',OIOUBLDocumentEncode.DateToText("Posting Date"),DocNameSpace,XMLNewChild,Prefix);

              AddElement(XMLCurrNode,'InvoiceTypeCode','380',DocNameSpace,XMLNewChild,Prefix);
              XMLCurrNode := XMLNewChild;
              AddAttribute(XMLCurrNode,'listID','urn:oioubl:codelist:invoicetypecode-1.1');
              AddAttribute(XMLCurrNode,'listAgencyID','320');
              XMLCurrNode := XMLCurrNode.ParentNode;

              AddElement(XMLCurrNode,'DocumentCurrencyCode',CurrencyCode,DocNameSpace,XMLNewChild,Prefix);
              AddElement(XMLCurrNode,'AccountingCostCode',"Account Code DK",DocNameSpace,XMLNewChild,Prefix);

              // Invoice->OrderReference
              AddElement(XMLCurrNode,'OrderReference','',DocNameSpace2,XMLNewChild,Prefix2);
              XMLCurrNode := XMLNewChild;

              AddElement(XMLCurrNode,'ID',"Your Reference",DocNameSpace,XMLNewChild,Prefix);
              IF "Order No." <> '' THEN
                AddElement(XMLCurrNode,'CustomerReference',"Order No.",DocNameSpace,XMLNewChild,Prefix)
              ELSE
                AddElement(XMLCurrNode,'CustomerReference',"Pre-Assigned No.",DocNameSpace,XMLNewChild,Prefix);

              // Invoice->AccountingSupplierParty
              XMLCurrNode := XMLCurrNode.ParentNode;
              AddElement(XMLCurrNode,'AccountingSupplierParty','',DocNameSpace2,XMLNewChild,Prefix2);
              XMLCurrNode := XMLNewChild;

              AddElement(XMLCurrNode,'Party','',DocNameSpace2,XMLNewChild,Prefix2);

              XMLCurrNode := XMLNewChild;
              AddElement(XMLCurrNode,'WebsiteURI',CompanyInfo."Home Page",DocNameSpace,XMLNewChild,Prefix);
              AddElement(XMLCurrNode,'EndpointID',OIOUBLDocumentEncode.GetCompanyVATRegNo(CompanyInfo."VAT Registration No."),
                DocNameSpace,XMLNewChild,Prefix);
              XMLCurrNode := XMLNewChild;
              AddAttribute(XMLCurrNode,'schemeID','DK:CVR');
              XMLCurrNode := XMLCurrNode.ParentNode;

              // Invoice->AccountingSupplierParty->PartyIdentification
              AddElement(XMLCurrNode,'PartyIdentification','',DocNameSpace2,XMLNewChild,Prefix2);

              XMLCurrNode := XMLNewChild;
              AddElement(XMLCurrNode,'ID',OIOUBLDocumentEncode.GetCompanyVATRegNo(CompanyInfo."VAT Registration No."),
                DocNameSpace,XMLNewChild,Prefix);
              XMLCurrNode := XMLNewChild;
              AddAttribute(XMLCurrNode,'schemeID','DK:CVR');
              XMLCurrNode := XMLCurrNode.ParentNode;

              // Invoice->AccountingSupplierParty->PartyName
              XMLCurrNode := XMLCurrNode.ParentNode;
              AddElement(XMLCurrNode,'PartyName','',DocNameSpace2,XMLNewChild,Prefix2);

              XMLCurrNode := XMLNewChild;
              AddElement(XMLCurrNode,'Name',CompanyInfo.Name,DocNameSpace,XMLNewChild,Prefix);

              // Invoice->AccountingSupplierParty->PostalAddress
              XMLCurrNode := XMLCurrNode.ParentNode;
              AddElement(XMLCurrNode,'PostalAddress','',DocNameSpace2,XMLNewChild,Prefix2);

              XMLCurrNode := XMLNewChild;
              AddElement(XMLCurrNode,'AddressFormatCode','StructuredLax',DocNameSpace,XMLNewChild,Prefix);
              XMLCurrNode := XMLNewChild;
              AddAttribute(XMLCurrNode,'listID','urn:oioubl:codelist:addressformatcode-1.1');
              AddAttribute(XMLCurrNode,'listAgencyID','320');
              XMLCurrNode := XMLCurrNode.ParentNode;

              AddElement(XMLCurrNode,'StreetName',CompanyInfo.Address,DocNameSpace,XMLNewChild,Prefix);
              AddElement(XMLCurrNode,'AdditionalStreetName',CompanyInfo."Address 2",DocNameSpace,XMLNewChild,Prefix);
              AddElement(XMLCurrNode,'InhouseMail',CompanyInfo."E-Mail",DocNameSpace,XMLNewChild,Prefix);
              AddElement(XMLCurrNode,'CityName',CompanyInfo.City,DocNameSpace,XMLNewChild,Prefix);
              AddElement(XMLCurrNode,'PostalZone',CompanyInfo."Post Code",DocNameSpace,XMLNewChild,Prefix);

              // Invoice->AccountingSupplierParty->Address->Country
              AddElement(XMLCurrNode,'Country','',DocNameSpace2,XMLNewChild,Prefix2);

              XMLCurrNode := XMLNewChild;
              AddElement(XMLCurrNode,'IdentificationCode',CompanyInfo."Country/Region Code",DocNameSpace,XMLNewChild,Prefix);

              // Invoice->AccountingSupplierParty->PartyTextScheme
              XMLCurrNode := XMLCurrNode.ParentNode;
              XMLCurrNode := XMLCurrNode.ParentNode;
              AddElement(XMLCurrNode,'PartyTaxScheme','',DocNameSpace2,XMLNewChild,Prefix2);

              XMLCurrNode := XMLNewChild;
              AddElement(XMLCurrNode,'CompanyID',OIOUBLDocumentEncode.GetCompanyVATRegNo(CompanyInfo."VAT Registration No."),
                DocNameSpace,XMLNewChild,Prefix);
              XMLCurrNode := XMLNewChild;
              AddAttribute(XMLCurrNode,'schemeID','DK:SE');
              XMLCurrNode := XMLCurrNode.ParentNode;

              AddElement(XMLCurrNode,'TaxScheme','',DocNameSpace2,XMLNewChild,Prefix2);

              XMLCurrNode := XMLNewChild;
              AddElement(XMLCurrNode,'ID','63',DocNameSpace,XMLNewChild,Prefix);
              XMLCurrNode := XMLNewChild;
              AddAttribute(XMLCurrNode,'schemeAgencyID','320');
              AddAttribute(XMLCurrNode,'schemeID','urn:oioubl:id:taxschemeid-1.1');
              XMLCurrNode := XMLCurrNode.ParentNode;
              AddElement(XMLCurrNode,'Name','Moms',DocNameSpace,XMLNewChild,Prefix);

              // Invoice->AccountingSupplierParty->PartyLegalEntity
              XMLCurrNode := XMLCurrNode.ParentNode;
              XMLCurrNode := XMLCurrNode.ParentNode;
              AddElement(XMLCurrNode,'PartyLegalEntity','',DocNameSpace2,XMLNewChild,Prefix2);

              XMLCurrNode := XMLNewChild;
              AddElement(XMLCurrNode,'RegistrationName',CompanyInfo.Name,DocNameSpace,XMLNewChild,Prefix);
              AddElement(XMLCurrNode,'CompanyID',OIOUBLDocumentEncode.GetCompanyVATRegNo(CompanyInfo."VAT Registration No."),
                DocNameSpace,XMLNewChild,Prefix);
              XMLCurrNode := XMLNewChild;
              AddAttribute(XMLCurrNode,'schemeID','DK:CVR');
              XMLCurrNode := XMLCurrNode.ParentNode;

              // Invoice->AccountingSupplierParty->Contact
              XMLCurrNode := XMLCurrNode.ParentNode;
              IF SalespersonPurchaser.GET("Salesperson Code") THEN BEGIN
                AddElement(XMLCurrNode,'Contact','',DocNameSpace2,XMLNewChild,Prefix2);
                XMLCurrNode := XMLNewChild;
                AddElement(XMLCurrNode,'ID',"Salesperson Code",DocNameSpace,XMLNewChild,Prefix);
                AddElement(XMLCurrNode,'Name',SalespersonPurchaser.Name,DocNameSpace,XMLNewChild,Prefix);
                AddElement(XMLCurrNode,'Telephone',SalespersonPurchaser."Phone No.",DocNameSpace,XMLNewChild,Prefix);
                AddElement(XMLCurrNode,'ElectronicMail',SalespersonPurchaser."E-Mail",DocNameSpace,XMLNewChild,Prefix);
                XMLCurrNode := XMLCurrNode.ParentNode;
              END;

              XMLCurrNode := XMLCurrNode.ParentNode;
              XMLCurrNode := XMLCurrNode.ParentNode;

              // Invoice->AccountingCustomerParty
              AddElement(XMLCurrNode,'AccountingCustomerParty','',DocNameSpace2,XMLNewChild,Prefix2);
              XMLCurrNode := XMLNewChild;

              AddElement(XMLCurrNode,'Party','',DocNameSpace2,XMLNewChild,Prefix2);

              XMLCurrNode := XMLNewChild;
              AddElement(XMLCurrNode,'EndpointID',"EAN No.",DocNameSpace,XMLNewChild,Prefix);
              XMLCurrNode := XMLNewChild;
              AddAttribute(XMLCurrNode,'schemeAgencyID','9');
              AddAttribute(XMLCurrNode,'schemeID','GLN');
              XMLCurrNode := XMLCurrNode.ParentNode;

              // Invoice->AccountingCustomerParty->PartyIdentification
              AddElement(XMLCurrNode,'PartyIdentification','',DocNameSpace2,XMLNewChild,Prefix2);

              XMLCurrNode := XMLNewChild;
              AddElement(XMLCurrNode,'ID',OIOUBLDocumentEncode.GetCustomerVATRegNo("VAT Registration No."),
                DocNameSpace,XMLNewChild,Prefix);
              XMLCurrNode := XMLNewChild;
              AddAttribute(XMLCurrNode,'schemeID','DK:CVR');
              XMLCurrNode := XMLCurrNode.ParentNode;

              // Invoice->AccountingCustomerParty->PartyName
              XMLCurrNode := XMLCurrNode.ParentNode;
              AddElement(XMLCurrNode,'PartyName','',DocNameSpace2,XMLNewChild,Prefix2);

              XMLCurrNode := XMLNewChild;
              AddElement(XMLCurrNode,'Name',"Bill-to Name",DocNameSpace,XMLNewChild,Prefix);

              // Invoice->AccountingCustomerParty->PostalAddress
              XMLCurrNode := XMLCurrNode.ParentNode;
              AddElement(XMLCurrNode,'PostalAddress','',DocNameSpace2,XMLNewChild,Prefix2);

              XMLCurrNode := XMLNewChild;
              AddElement(XMLCurrNode,'AddressFormatCode','StructuredLax',DocNameSpace,XMLNewChild,Prefix);
              XMLCurrNode := XMLNewChild;
              AddAttribute(XMLCurrNode,'listID','urn:oioubl:codelist:addressformatcode-1.1');
              AddAttribute(XMLCurrNode,'listAgencyID','320');
              XMLCurrNode := XMLCurrNode.ParentNode;

              AddElement(XMLCurrNode,'StreetName',"Bill-to Address",DocNameSpace,XMLNewChild,Prefix);
              AddElement(XMLCurrNode,'AdditionalStreetName',"Bill-to Address 2",DocNameSpace,XMLNewChild,Prefix);
              AddElement(XMLCurrNode,'CityName',"Bill-to City",DocNameSpace,XMLNewChild,Prefix);
              AddElement(XMLCurrNode,'PostalZone',"Bill-to Post Code",DocNameSpace,XMLNewChild,Prefix);

              // Invoice->AccountingCustomerParty->Address->Country
              AddElement(XMLCurrNode,'Country','',DocNameSpace2,XMLNewChild,Prefix2);

              XMLCurrNode := XMLNewChild;
              AddElement(XMLCurrNode,'IdentificationCode',OIOUBLDocumentEncode.GetOIOUBLCountryRegionCode("Bill-to Country/Region Code"),
                DocNameSpace,XMLNewChild,Prefix);

              // Invoice->AccountingCustomerParty->Contact
              XMLCurrNode := XMLCurrNode.ParentNode;
              XMLCurrNode := XMLCurrNode.ParentNode;
              AddElement(XMLCurrNode,'Contact','',DocNameSpace2,XMLNewChild,Prefix2);
              XMLCurrNode := XMLNewChild;
              AddElement(XMLCurrNode,'ID',"Contact Name",DocNameSpace,XMLNewChild,Prefix);

              AddElement(XMLCurrNode,'Name',"Contact Name",DocNameSpace,XMLNewChild,Prefix);
              AddElement(XMLCurrNode,'Telephone',"Phone No.",DocNameSpace,XMLNewChild,Prefix);
              AddElement(XMLCurrNode,'Telefax',"Fax No.",DocNameSpace,XMLNewChild,Prefix);
              AddElement(XMLCurrNode,'ElectronicMail',"E-Mail",DocNameSpace,XMLNewChild,Prefix);

              XMLCurrNode := XMLCurrNode.ParentNode;
              XMLCurrNode := XMLCurrNode.ParentNode;
              XMLCurrNode := XMLCurrNode.ParentNode;

              // Invoice->Delivery
              AddElement(XMLCurrNode,'Delivery','',DocNameSpace2,XMLNewChild,Prefix2);
              XMLCurrNode := XMLNewChild;

              AddElement(XMLCurrNode,'DeliveryLocation','',DocNameSpace2,XMLNewChild,Prefix2);
              XMLCurrNode := XMLNewChild;

              // Invoice->Delivery->Address
              AddElement(XMLCurrNode,'Address','',DocNameSpace2,XMLNewChild,Prefix2);
              XMLCurrNode := XMLNewChild;

              AddElement(XMLCurrNode,'AddressFormatCode','StructuredLax',DocNameSpace,XMLNewChild,Prefix);
              XMLCurrNode := XMLNewChild;
              AddAttribute(XMLCurrNode,'listID','urn:oioubl:codelist:addressformatcode-1.1');
              AddAttribute(XMLCurrNode,'listAgencyID','320');
              XMLCurrNode := XMLCurrNode.ParentNode;

              AddElement(XMLCurrNode,'StreetName',"Ship-to Address",DocNameSpace,XMLNewChild,Prefix);
              AddElement(XMLCurrNode,'AdditionalStreetName',"Ship-to Address 2",DocNameSpace,XMLNewChild,Prefix);
              AddElement(XMLCurrNode,'CityName',"Ship-to City",DocNameSpace,XMLNewChild,Prefix);
              AddElement(XMLCurrNode,'PostalZone',"Ship-to Post Code",DocNameSpace,XMLNewChild,Prefix);

              // Invoice->Delivery->Address->Country
              AddElement(XMLCurrNode,'Country','',DocNameSpace2,XMLNewChild,Prefix2);

              XMLCurrNode := XMLNewChild;
              AddElement(XMLCurrNode,'IdentificationCode',"Ship-to Country/Region Code",DocNameSpace,XMLNewChild,Prefix);

              XMLCurrNode := XMLCurrNode.ParentNode;
              XMLCurrNode := XMLCurrNode.ParentNode;
              XMLCurrNode := XMLCurrNode.ParentNode;
              XMLCurrNode := XMLCurrNode.ParentNode;

              // Invoice->PaymentMeans
              AddElement(XMLCurrNode,'PaymentMeans','',DocNameSpace2,XMLNewChild,Prefix2);
              XMLCurrNode := XMLNewChild;

              AddElement(XMLCurrNode,'ID','1',DocNameSpace,XMLNewChild,Prefix);
              AddElement(XMLCurrNode,'PaymentMeansCode','42',DocNameSpace,XMLNewChild,Prefix);
              AddElement(XMLCurrNode,'PaymentDueDate',OIOUBLDocumentEncode.DateToText("Due Date"),DocNameSpace,XMLNewChild,Prefix);
              AddElement(XMLCurrNode,'PaymentChannelCode',GetPaymentChannelCode,DocNameSpace,XMLNewChild,Prefix);
              XMLCurrNode := XMLNewChild;
              AddAttribute(XMLCurrNode,'listAgencyID','320');
              AddAttribute(XMLCurrNode,'listID','urn:oioubl:codelist:paymentchannelcode-1.1');
              XMLCurrNode := XMLCurrNode.ParentNode;

              // Invoice->PaymentMeans->PayeeFinancialAccount
              AddElement(XMLCurrNode,'PayeeFinancialAccount','',DocNameSpace2,XMLNewChild,Prefix2);
              XMLCurrNode := XMLNewChild;

              AddElement(XMLCurrNode,'ID',CompanyInfo."Bank Account No.",DocNameSpace,XMLNewChild,Prefix);

              // Invoice->PaymentMeans->PayeeFinancialAccount->FinancialInstitutionBranch
              AddElement(XMLCurrNode,'FinancialInstitutionBranch','',DocNameSpace2,XMLNewChild,Prefix2);
              XMLCurrNode := XMLNewChild;

              AddElement(XMLCurrNode,'ID',CompanyInfo."Bank Branch No.",DocNameSpace,XMLNewChild,Prefix);

              // Invoice->PaymentMeans->PayeeFinancialAccount->FinancialInstitutionBranch->FinancialInstitution
              AddElement(XMLCurrNode,'FinancialInstitution','',DocNameSpace2,XMLNewChild,Prefix2);
              XMLCurrNode := XMLNewChild;

              IF CompanyInfo."SWIFT Code" <> '' THEN
                AddElement(XMLCurrNode,'ID',CompanyInfo."SWIFT Code",DocNameSpace,XMLNewChild,Prefix)
              ELSE
                AddElement(XMLCurrNode,'ID','null',DocNameSpace,XMLNewChild,Prefix);
              AddElement(XMLCurrNode,'Name',CompanyInfo."Bank Name",DocNameSpace,XMLNewChild,Prefix);

              XMLCurrNode := XMLCurrNode.ParentNode;
              XMLCurrNode := XMLCurrNode.ParentNode;
              XMLCurrNode := XMLCurrNode.ParentNode;
              XMLCurrNode := XMLCurrNode.ParentNode;

              // Invoice->PaymentTerms
              ServInvLine2.RESET;
              ServInvLine2.COPY(ServInvLine);
              ServInvLine2.SETRANGE(Type);
              ServInvLine2.SETRANGE("No.");
              ServInvLine2.CALCSUMS(Amount,"Amount Including VAT","Inv. Discount Amount");

              AddElement(XMLCurrNode,'PaymentTerms','',DocNameSpace2,XMLNewChild,Prefix2);
              XMLCurrNode := XMLNewChild;

              AddElement(XMLCurrNode,'ID','1',DocNameSpace,XMLNewChild,Prefix);
              AddElement(XMLCurrNode,'PaymentMeansID','1',DocNameSpace,XMLNewChild,Prefix);
              PaymentTerms.GET("Payment Terms Code");
              AddElement(XMLCurrNode,'Note',PaymentTerms.Description,DocNameSpace,XMLNewChild,Prefix);
              AddElement(XMLCurrNode,'SettlementDiscountPercent',OIOUBLDocumentEncode.DecimalToText("Payment Discount %"),
                DocNameSpace,XMLNewChild,Prefix);
              AddElement(XMLCurrNode,'Amount',OIOUBLDocumentEncode.DecimalToText(ServInvLine2."Amount Including VAT"),
                DocNameSpace,XMLNewChild,Prefix);
              XMLCurrNode := XMLNewChild;
              AddAttribute(XMLCurrNode,'currencyID',"Currency Code");
              XMLCurrNode := XMLCurrNode.ParentNode;

              // Invoice->PaymentTerms->SettlementPeriod
              AddElement(XMLCurrNode,'SettlementPeriod','',DocNameSpace2,XMLNewChild,Prefix2);
              XMLCurrNode := XMLNewChild;

              AddElement(XMLCurrNode,'EndDate',OIOUBLDocumentEncode.DateToText("Pmt. Discount Date"),DocNameSpace,XMLNewChild,Prefix);
              XMLCurrNode := XMLCurrNode.ParentNode;

              // Invoice->PaymentTerms->PenaltyPeriod
              AddElement(XMLCurrNode,'PenaltyPeriod','',DocNameSpace2,XMLNewChild,Prefix2);
              XMLCurrNode := XMLNewChild;

              AddElement(XMLCurrNode,'StartDate',OIOUBLDocumentEncode.DateToText("Due Date"),DocNameSpace,XMLNewChild,Prefix);

              XMLCurrNode := XMLCurrNode.ParentNode;
              XMLCurrNode := XMLCurrNode.ParentNode;

              TotalInvDiscountAmount := 0;
              IF ServInvLine2.FINDSET THEN
                REPEAT
                  TotalInvDiscountAmount := TotalInvDiscountAmount + ServInvLine2."Inv. Discount Amount" +
                    ServInvLine2."Line Discount Amount";
                UNTIL ServInvLine2.NEXT = 0;

              IF TotalInvDiscountAmount > 0 THEN BEGIN
                AddElement(XMLCurrNode,'AllowanceCharge','',DocNameSpace2,XMLNewChild,Prefix2);
                XMLCurrNode := XMLNewChild;

                AddElement(XMLCurrNode,'ID','1',DocNameSpace,XMLNewChild,Prefix);
                AddElement(XMLCurrNode,'ChargeIndicator','false',
                  DocNameSpace,XMLNewChild,Prefix);
                AddElement(XMLCurrNode,'AllowanceChargeReason','Rabat',DocNameSpace,XMLNewChild,Prefix);
                AddElement(XMLCurrNode,'MultiplierFactorNumeric','1.000',DocNameSpace,XMLNewChild,Prefix);
                AddElement(XMLCurrNode,'SequenceNumeric','1',DocNameSpace,XMLNewChild,Prefix);

                AddElement(XMLCurrNode,'Amount',OIOUBLDocumentEncode.DecimalToText(TotalInvDiscountAmount),
                  DocNameSpace,XMLNewChild,Prefix);
                XMLCurrNode := XMLNewChild;
                AddAttribute(XMLCurrNode,'currencyID',CurrencyCode);
                XMLCurrNode := XMLCurrNode.ParentNode;

                AddElement(XMLCurrNode,'BaseAmount',OIOUBLDocumentEncode.DecimalToText(TotalInvDiscountAmount),
                  DocNameSpace,XMLNewChild,Prefix);
                XMLCurrNode := XMLNewChild;
                AddAttribute(XMLCurrNode,'currencyID',CurrencyCode);
                XMLCurrNode := XMLCurrNode.ParentNode;
                // Invoice->AllowanceCharge->TaxCategory
                AddElement(XMLCurrNode,'TaxCategory','',DocNameSpace2,XMLNewChild,Prefix2);
                XMLCurrNode := XMLNewChild;

                AddElement(XMLCurrNode,'ID',GetTaxCategoryID(ServInvLine2."VAT Calculation Type",ServInvLine2."VAT %"),
                  DocNameSpace,XMLNewChild,Prefix);
                XMLCurrNode := XMLNewChild;
                AddAttribute(XMLCurrNode,'schemeID','urn:oioubl:id:taxcategoryid-1.1');
                AddAttribute(XMLCurrNode,'schemeAgencyID','320');
                XMLCurrNode := XMLCurrNode.ParentNode;

                AddElement(XMLCurrNode,'Percent',OIOUBLDocumentEncode.DecimalToText(ServInvLine2."VAT %"),
                  DocNameSpace,XMLNewChild,Prefix);

                // Invoice->AllowanceCharge->TaxCategory->TaxScheme
                AddElement(XMLCurrNode,'TaxScheme','',DocNameSpace2,XMLNewChild,Prefix2);
                XMLCurrNode := XMLNewChild;

                AddElement(XMLCurrNode,'ID','63',DocNameSpace,XMLNewChild,Prefix);
                XMLCurrNode := XMLNewChild;
                AddAttribute(XMLCurrNode,'schemeID','urn:oioubl:id:taxschemeid-1.1');
                XMLCurrNode := XMLCurrNode.ParentNode;
                AddElement(XMLCurrNode,'Name','Moms',DocNameSpace,XMLNewChild,Prefix);

                XMLCurrNode := XMLCurrNode.ParentNode;
                XMLCurrNode := XMLCurrNode.ParentNode;
                XMLCurrNode := XMLCurrNode.ParentNode;
              END;

              ServInvLine2.RESET;
              ServInvLine2.COPY(ServInvLine);
              ServInvLine2.SETFILTER(
                "VAT Calculation Type",'%1|%2|%3',
                ServInvLine2."VAT Calculation Type"::"Normal VAT",
                ServInvLine2."VAT Calculation Type"::"Full VAT",
                ServInvLine2."VAT Calculation Type"::"Reverse Charge VAT");
              IF ServInvLine2.FINDFIRST THEN BEGIN
                TotalTaxAmount := 0;
                ServInvLine2.CALCSUMS(Amount,"Amount Including VAT");
                TotalTaxAmount := ServInvLine2."Amount Including VAT" - ServInvLine2.Amount;

                AddElement(XMLCurrNode,'TaxTotal','',DocNameSpace2,XMLNewChild,Prefix2);
                XMLCurrNode := XMLNewChild;
                AddElement(
                  XMLCurrNode,'TaxAmount',
                  OIOUBLDocumentEncode.DecimalToText(TotalTaxAmount),DocNameSpace,XMLNewChild,Prefix);
                XMLCurrNode := XMLNewChild;
                AddAttribute(XMLCurrNode,'currencyID',"Currency Code");
                XMLCurrNode := XMLCurrNode.ParentNode;

                // Invoice->TaxTotal (for ("Normal VAT" AND "VAT %" <> 0) OR "Full VAT")
                ServInvLine2.SETFILTER(
                  "VAT Calculation Type",'%1|%2',
                  ServInvLine2."VAT Calculation Type"::"Normal VAT",
                  ServInvLine2."VAT Calculation Type"::"Full VAT");
                IF ServInvLine2.FINDFIRST THEN BEGIN
                  TaxableAmount := 0;
                  TaxAmount := 0;
                  ServInvLine2.SETFILTER("VAT %",'<>0');
                  IF ServInvLine2.FINDSET THEN BEGIN
                    VATPercentage := ServInvLine2."VAT %";
                    REPEAT
                      UpdateTaxAmtAndTaxableAmt(ServInvLine2.Amount,ServInvLine2."Amount Including VAT",TaxableAmount,TaxAmount);
                    UNTIL ServInvLine2.NEXT = 0;
                    // Invoice->TaxTotal->TaxSubtotal
                    AddElement(XMLCurrNode,'TaxSubtotal','',DocNameSpace2,XMLNewChild,Prefix2);
                    XMLCurrNode := XMLNewChild;
                    AddElement(XMLCurrNode,'TaxableAmount',
                      OIOUBLDocumentEncode.DecimalToText(TaxableAmount),DocNameSpace,XMLNewChild,Prefix);
                    XMLCurrNode := XMLNewChild;
                    AddAttribute(XMLCurrNode,'currencyID',"Currency Code");
                    XMLCurrNode := XMLCurrNode.ParentNode;

                    AddElement(XMLCurrNode,'TaxAmount',
                      OIOUBLDocumentEncode.DecimalToText(TaxAmount),DocNameSpace,XMLNewChild,Prefix);
                    XMLCurrNode := XMLNewChild;
                    AddAttribute(XMLCurrNode,'currencyID',"Currency Code");
                    XMLCurrNode := XMLCurrNode.ParentNode;

                    // Invoice->TaxTotal->TaxSubtotal->TaxCategory
                    AddElement(XMLCurrNode,'TaxCategory','',DocNameSpace2,XMLNewChild,Prefix2);
                    XMLCurrNode := XMLNewChild;

                    AddElement(XMLCurrNode,'ID',GetTaxCategoryID(ServInvLine2."VAT Calculation Type",VATPercentage),
                      DocNameSpace,XMLNewChild,Prefix);
                    XMLCurrNode := XMLNewChild;
                    AddAttribute(XMLCurrNode,'schemeID','urn:oioubl:id:taxcategoryid-1.1');
                    AddAttribute(XMLCurrNode,'schemeAgencyID','320');
                    XMLCurrNode := XMLCurrNode.ParentNode;

                    AddElement(XMLCurrNode,'Percent',OIOUBLDocumentEncode.DecimalToText(VATPercentage),
                      DocNameSpace,XMLNewChild,Prefix);

                    // Invoice->TaxTotal->TaxSubtotal->TaxCategory->TaxScheme
                    AddElement(XMLCurrNode,'TaxScheme','',DocNameSpace2,XMLNewChild,Prefix2);
                    XMLCurrNode := XMLNewChild;

                    AddElement(XMLCurrNode,'ID','63',DocNameSpace,XMLNewChild,Prefix);
                    XMLCurrNode := XMLNewChild;
                    AddAttribute(XMLCurrNode,'schemeID','urn:oioubl:id:taxschemeid-1.1');
                    XMLCurrNode := XMLCurrNode.ParentNode;
                    AddElement(XMLCurrNode,'Name','Moms',DocNameSpace,XMLNewChild,Prefix);

                    XMLCurrNode := XMLCurrNode.ParentNode;
                    XMLCurrNode := XMLCurrNode.ParentNode;
                    XMLCurrNode := XMLCurrNode.ParentNode;
                  END;

                  TaxableAmount := 0;
                  TaxAmount := 0;
                  ServInvLine2.SETRANGE("VAT %",0);
                  IF ServInvLine2.FINDSET THEN BEGIN
                    VATPercentage := ServInvLine2."VAT %";
                    REPEAT
                      UpdateTaxAmtAndTaxableAmt(ServInvLine2.Amount,ServInvLine2."Amount Including VAT",TaxableAmount,TaxAmount);
                    UNTIL ServInvLine2.NEXT = 0;
                    // Invoice->TaxTotal->TaxSubtotal
                    AddElement(XMLCurrNode,'TaxSubtotal','',DocNameSpace2,XMLNewChild,Prefix2);
                    XMLCurrNode := XMLNewChild;
                    AddElement(XMLCurrNode,'TaxableAmount',
                      OIOUBLDocumentEncode.DecimalToText(TaxableAmount),DocNameSpace,XMLNewChild,Prefix);
                    XMLCurrNode := XMLNewChild;
                    AddAttribute(XMLCurrNode,'currencyID',"Currency Code");
                    XMLCurrNode := XMLCurrNode.ParentNode;

                    AddElement(XMLCurrNode,'TaxAmount',
                      OIOUBLDocumentEncode.DecimalToText(TaxAmount),DocNameSpace,XMLNewChild,Prefix);
                    XMLCurrNode := XMLNewChild;
                    AddAttribute(XMLCurrNode,'currencyID',"Currency Code");
                    XMLCurrNode := XMLCurrNode.ParentNode;

                    // Invoice->TaxTotal->TaxSubtotal->TaxCategory
                    AddElement(XMLCurrNode,'TaxCategory','',DocNameSpace2,XMLNewChild,Prefix2);
                    XMLCurrNode := XMLNewChild;

                    AddElement(XMLCurrNode,'ID',GetTaxCategoryID(ServInvLine2."VAT Calculation Type",VATPercentage),
                      DocNameSpace,XMLNewChild,Prefix);
                    XMLCurrNode := XMLNewChild;
                    AddAttribute(XMLCurrNode,'schemeID','urn:oioubl:id:taxcategoryid-1.1');
                    AddAttribute(XMLCurrNode,'schemeAgencyID','320');
                    XMLCurrNode := XMLCurrNode.ParentNode;

                    AddElement(XMLCurrNode,'Percent',OIOUBLDocumentEncode.DecimalToText(VATPercentage),
                      DocNameSpace,XMLNewChild,Prefix);

                    // Invoice->TaxTotal->TaxSubtotal->TaxCategory->TaxScheme
                    AddElement(XMLCurrNode,'TaxScheme','',DocNameSpace2,XMLNewChild,Prefix2);
                    XMLCurrNode := XMLNewChild;

                    AddElement(XMLCurrNode,'ID','63',DocNameSpace,XMLNewChild,Prefix);
                    XMLCurrNode := XMLNewChild;
                    AddAttribute(XMLCurrNode,'schemeID','urn:oioubl:id:taxschemeid-1.1');
                    XMLCurrNode := XMLCurrNode.ParentNode;
                    AddElement(XMLCurrNode,'Name','Moms',DocNameSpace,XMLNewChild,Prefix);

                    XMLCurrNode := XMLCurrNode.ParentNode;
                    XMLCurrNode := XMLCurrNode.ParentNode;
                    XMLCurrNode := XMLCurrNode.ParentNode;
                  END;
                END;

                // Invoice->TaxTotal (for "Reverse Charge VAT")
                ServInvLine2.SETRANGE("VAT %");
                ServInvLine2.SETRANGE("VAT Calculation Type",ServInvLine2."VAT Calculation Type"::"Reverse Charge VAT");
                IF ServInvLine2.FINDSET THEN BEGIN
                  TaxableAmount := 0;
                  TaxAmount := 0;
                  VATPercentage := ServInvLine2."VAT %";
                  REPEAT
                    UpdateTaxAmtAndTaxableAmt(ServInvLine2.Amount,ServInvLine2."Amount Including VAT",TaxableAmount,TaxAmount);
                  UNTIL ServInvLine2.NEXT = 0;
                  // Invoice->TaxTotal->TaxSubtotal
                  AddElement(XMLCurrNode,'TaxSubtotal','',DocNameSpace2,XMLNewChild,Prefix2);
                  XMLCurrNode := XMLNewChild;
                  AddElement(XMLCurrNode,'TaxableAmount',
                    OIOUBLDocumentEncode.DecimalToText(TaxableAmount),DocNameSpace,XMLNewChild,Prefix);
                  XMLCurrNode := XMLNewChild;
                  AddAttribute(XMLCurrNode,'currencyID',"Currency Code");
                  XMLCurrNode := XMLCurrNode.ParentNode;

                  AddElement(XMLCurrNode,'TaxAmount',
                    OIOUBLDocumentEncode.DecimalToText(TaxAmount),DocNameSpace,XMLNewChild,Prefix);
                  XMLCurrNode := XMLNewChild;
                  AddAttribute(XMLCurrNode,'currencyID',"Currency Code");
                  XMLCurrNode := XMLCurrNode.ParentNode;

                  // Invoice->TaxTotal->TaxSubtotal->TaxCategory
                  AddElement(XMLCurrNode,'TaxCategory','',DocNameSpace2,XMLNewChild,Prefix2);
                  XMLCurrNode := XMLNewChild;

                  AddElement(XMLCurrNode,'ID',GetTaxCategoryID(ServInvLine2."VAT Calculation Type",VATPercentage),
                    DocNameSpace,XMLNewChild,Prefix);
                  XMLCurrNode := XMLNewChild;
                  AddAttribute(XMLCurrNode,'schemeID','urn:oioubl:id:taxcategoryid-1.1');
                  AddAttribute(XMLCurrNode,'schemeAgencyID','320');
                  XMLCurrNode := XMLCurrNode.ParentNode;

                  AddElement(XMLCurrNode,'Percent',OIOUBLDocumentEncode.DecimalToText(VATPercentage),
                    DocNameSpace,XMLNewChild,Prefix);

                  // Invoice->TaxTotal->TaxSubtotal->TaxCategory->TaxScheme
                  AddElement(XMLCurrNode,'TaxScheme','',DocNameSpace2,XMLNewChild,Prefix2);
                  XMLCurrNode := XMLNewChild;

                  AddElement(XMLCurrNode,'ID','63',DocNameSpace,XMLNewChild,Prefix);
                  XMLCurrNode := XMLNewChild;
                  AddAttribute(XMLCurrNode,'schemeID','urn:oioubl:id:taxschemeid-1.1');
                  XMLCurrNode := XMLCurrNode.ParentNode;
                  AddElement(XMLCurrNode,'Name','Moms',DocNameSpace,XMLNewChild,Prefix);

                  XMLCurrNode := XMLCurrNode.ParentNode;
                  XMLCurrNode := XMLCurrNode.ParentNode;
                  XMLCurrNode := XMLCurrNode.ParentNode;
                END;
                XMLCurrNode := XMLCurrNode.ParentNode;
              END;

              // Invoice->LegalMonetaryTotal
              TaxableAmount := 0;
              TaxAmount := 0;

              ServInvLine2.RESET;
              ServInvLine2.COPY(ServInvLine);
              IF ServInvLine2.FINDSET THEN
                REPEAT
                  TaxableAmount := TaxableAmount + ServInvLine2.Amount + ServInvLine2."Inv. Discount Amount" +
                    ServInvLine2."Line Discount Amount";
                  TotalAmount := TotalAmount + ServInvLine2."Amount Including VAT";
                  TaxAmount := TaxAmount + ServInvLine2."Amount Including VAT" - ServInvLine2.Amount;
                UNTIL ServInvLine2.NEXT = 0;

              AddElement(XMLCurrNode,'LegalMonetaryTotal','',
                DocNameSpace2,XMLNewChild,Prefix2);
              XMLCurrNode := XMLNewChild;

              AddElement(XMLCurrNode,'LineExtensionAmount',OIOUBLDocumentEncode.DecimalToText(TaxableAmount),
                DocNameSpace,XMLNewChild,Prefix);
              XMLCurrNode := XMLNewChild;
              AddAttribute(XMLCurrNode,'currencyID',CurrencyCode);
              XMLCurrNode := XMLCurrNode.ParentNode;

              AddElement(XMLCurrNode,'TaxExclusiveAmount',OIOUBLDocumentEncode.DecimalToText(TaxAmount),
                DocNameSpace,XMLNewChild,Prefix);
              XMLCurrNode := XMLNewChild;
              AddAttribute(XMLCurrNode,'currencyID',"Currency Code");
              XMLCurrNode := XMLCurrNode.ParentNode;

              AddElement(XMLCurrNode,'TaxInclusiveAmount',OIOUBLDocumentEncode.DecimalToText(TotalAmount),
                DocNameSpace,XMLNewChild,Prefix);
              XMLCurrNode := XMLNewChild;
              AddAttribute(XMLCurrNode,'currencyID',"Currency Code");
              XMLCurrNode := XMLCurrNode.ParentNode;

              IF TotalInvDiscountAmount > 0 THEN BEGIN
                AddElement(XMLCurrNode,'AllowanceTotalAmount',OIOUBLDocumentEncode.DecimalToText(TotalInvDiscountAmount),
                  DocNameSpace,XMLNewChild,Prefix);
                XMLCurrNode := XMLNewChild;
                AddAttribute(XMLCurrNode,'currencyID',"Currency Code");
                XMLCurrNode := XMLCurrNode.ParentNode;
              END;
              AddElement(XMLCurrNode,'PayableAmount',OIOUBLDocumentEncode.DecimalToText(TotalAmount),
                DocNameSpace,XMLNewChild,Prefix);
              XMLCurrNode := XMLNewChild;
              AddAttribute(XMLCurrNode,'currencyID',"Currency Code");
              XMLCurrNode := XMLCurrNode.ParentNode;

              XMLCurrNode := XMLCurrNode.ParentNode;

              // Invoice->InvoiceLine
              REPEAT
                ServInvLine.TESTFIELD(Description);

                AddElement(XMLCurrNode,'InvoiceLine','',DocNameSpace2,XMLNewChild,Prefix2);
                XMLCurrNode := XMLNewChild;

                AddElement(XMLCurrNode,'ID',FORMAT(ServInvLine."Line No."),DocNameSpace,XMLNewChild,Prefix);
                AddElement(XMLCurrNode,'InvoicedQuantity',OIOUBLDocumentEncode.DecimalToText(ServInvLine.Quantity),
                  DocNameSpace,XMLNewChild,Prefix);
                XMLCurrNode := XMLNewChild;
                AddAttribute(XMLCurrNode,'unitCode',OIOUBLDocumentEncode.GetUoMCode(ServInvLine."Unit of Measure Code"));
                XMLCurrNode := XMLCurrNode.ParentNode;

                AddElement(XMLCurrNode,'LineExtensionAmount',
                  OIOUBLDocumentEncode.DecimalToText(ServInvLine.Amount + ServInvLine."Inv. Discount Amount" +
                    ServInvLine."Line Discount Amount"),DocNameSpace,XMLNewChild,Prefix);
                XMLCurrNode := XMLNewChild;
                AddAttribute(XMLNewChild,'currencyID',"Currency Code");
                XMLCurrNode := XMLCurrNode.ParentNode;

                AddElement(XMLCurrNode,'AccountingCost',ServInvLine."Account Code DK",DocNameSpace,XMLNewChild,Prefix);

                // Invoice->InvoiceLine->OrderLineReference
                AddElement(XMLCurrNode,'OrderLineReference','',DocNameSpace2,XMLNewChild,Prefix2);
                XMLCurrNode := XMLNewChild;

                AddElement(XMLCurrNode,'LineID',FORMAT(ServInvLine."Line No."),DocNameSpace,XMLNewChild,Prefix);

                // Invoice->InvoiceLine->OrderLineReference->OrderReference
                AddElement(XMLCurrNode,'OrderReference','',DocNameSpace2,XMLNewChild,Prefix2);
                XMLCurrNode := XMLNewChild;

                AddElement(XMLCurrNode,'ID',"Your Reference",DocNameSpace,XMLNewChild,Prefix);

                XMLCurrNode := XMLCurrNode.ParentNode;
                XMLCurrNode := XMLCurrNode.ParentNode;

                // Invoice->InvoiceLine->TaxTotal
                AddElement(XMLCurrNode,'TaxTotal','',DocNameSpace2,XMLNewChild,Prefix2);
                XMLCurrNode := XMLNewChild;

                AddElement(XMLCurrNode,'TaxAmount',
                  OIOUBLDocumentEncode.DecimalToText(ServInvLine."Amount Including VAT" - ServInvLine.Amount),
                  DocNameSpace,XMLNewChild,Prefix);
                XMLCurrNode := XMLNewChild;
                AddAttribute(XMLCurrNode,'currencyID',CurrencyCode);
                XMLCurrNode := XMLCurrNode.ParentNode;

                // Invoice->InvoiceLine->TaxTotal->TaxSubtotal
                AddElement(XMLCurrNode,'TaxSubtotal','',DocNameSpace2,XMLNewChild,Prefix2);
                XMLCurrNode := XMLNewChild;
                AddElement(XMLCurrNode,'TaxableAmount',
                  OIOUBLDocumentEncode.DecimalToText(ServInvLine.Amount),DocNameSpace,XMLNewChild,Prefix);
                XMLCurrNode := XMLNewChild;
                AddAttribute(XMLCurrNode,'currencyID',CurrencyCode);
                XMLCurrNode := XMLCurrNode.ParentNode;

                AddElement(XMLCurrNode,'TaxAmount',
                  OIOUBLDocumentEncode.DecimalToText(ServInvLine."Amount Including VAT" - ServInvLine.Amount),
                  DocNameSpace,XMLNewChild,Prefix);
                XMLCurrNode := XMLNewChild;
                AddAttribute(XMLCurrNode,'currencyID',CurrencyCode);
                XMLCurrNode := XMLCurrNode.ParentNode;

                // Invoice->InvoiceLine->TaxTotal->TaxSubtotal->TaxCategory
                AddElement(XMLCurrNode,'TaxCategory','',DocNameSpace2,XMLNewChild,Prefix2);
                XMLCurrNode := XMLNewChild;

                AddElement(XMLCurrNode,'ID',GetTaxCategoryID(ServInvLine."VAT Calculation Type",ServInvLine."VAT %"),
                  DocNameSpace,XMLNewChild,Prefix);
                XMLCurrNode := XMLNewChild;
                AddAttribute(XMLCurrNode,'schemeID','urn:oioubl:id:taxcategoryid-1.1');
                AddAttribute(XMLCurrNode,'schemeAgencyID','320');
                XMLCurrNode := XMLCurrNode.ParentNode;

                AddElement(XMLCurrNode,'Percent',OIOUBLDocumentEncode.DecimalToText(ServInvLine."VAT %"),
                  DocNameSpace,XMLNewChild,Prefix);

                // Invoice->InvoiceLine->TaxTotal->TaxSubtotal->TaxCategory->TaxScheme
                AddElement(XMLCurrNode,'TaxScheme','',DocNameSpace2,XMLNewChild,Prefix2);
                XMLCurrNode := XMLNewChild;

                AddElement(XMLCurrNode,'ID','63',DocNameSpace,XMLNewChild,Prefix);
                XMLCurrNode := XMLNewChild;
                AddAttribute(XMLCurrNode,'schemeID','urn:oioubl:id:taxschemeid-1.1');
                XMLCurrNode := XMLCurrNode.ParentNode;
                AddElement(XMLCurrNode,'Name','Moms',DocNameSpace,XMLNewChild,Prefix);

                XMLCurrNode := XMLCurrNode.ParentNode;
                XMLCurrNode := XMLCurrNode.ParentNode;
                XMLCurrNode := XMLCurrNode.ParentNode;
                XMLCurrNode := XMLCurrNode.ParentNode;

                // Invoice->InvoiceLine->Item
                AddElement(XMLCurrNode,'Item','',DocNameSpace2,XMLNewChild,Prefix2);
                XMLCurrNode := XMLNewChild;

                AddElement(XMLCurrNode,'Description',ServInvLine.Description,DocNameSpace,XMLNewChild,Prefix);
                AddElement(XMLCurrNode,'Name',COPYSTR(ServInvLine.Description,1,40),DocNameSpace,XMLNewChild,Prefix);

                // Invoice->InvoiceLine->Item->SellersItemIdentification
                AddElement(XMLCurrNode,'SellersItemIdentification','',DocNameSpace2,XMLNewChild,Prefix2);
                XMLCurrNode := XMLNewChild;

                AddElement(XMLCurrNode,'ID',ServInvLine."No.",DocNameSpace,XMLNewChild,Prefix);
                XMLCurrNode := XMLNewChild;
                AddAttribute(XMLCurrNode,'schemeID','n/a');
                XMLCurrNode := XMLCurrNode.ParentNode;

                XMLCurrNode := XMLCurrNode.ParentNode;
                XMLCurrNode := XMLCurrNode.ParentNode;

                // Invoice->InvoiceLine->Price
                AddElement(XMLCurrNode,'Price','',DocNameSpace2,XMLNewChild,Prefix2);
                XMLCurrNode := XMLNewChild;

                AddElement(XMLCurrNode,'PriceAmount',FORMAT(ServInvLine."Unit Price",0,9),
                  DocNameSpace,XMLNewChild,Prefix);
                XMLCurrNode := XMLNewChild;
                AddAttribute(XMLCurrNode,'currencyID',CurrencyCode);
                XMLCurrNode := XMLCurrNode.ParentNode;

                AddElement(XMLCurrNode,'BaseQuantity',OIOUBLDocumentEncode.DecimalToText(ABS(ServInvLine.Quantity)),
                  DocNameSpace,XMLNewChild,Prefix);
                XMLCurrNode := XMLNewChild;
                AddAttribute(XMLNewChild,'unitCode',OIOUBLDocumentEncode.GetUoMCode(ServInvLine."Unit of Measure Code"));
                XMLCurrNode := XMLCurrNode.ParentNode;

                XMLCurrNode := XMLCurrNode.ParentNode;
                XMLCurrNode := XMLCurrNode.ParentNode;
              UNTIL ServInvLine.NEXT = 0;
            END;

            ServiceMgtSetup.GET;
            ServiceMgtSetup."OIOUBL Service Invoice Path" := DELCHR(ServiceMgtSetup."OIOUBL Service Invoice Path",'>','\');
            XMLdocOut.Save(FromFile);
            IF RBMgt.CanRunDotNetOnClient THEN BEGIN
              ServiceMgtSetup.VerifyAndSetOIOUBLPath(DocumentType::Invoice);

              ToFile := RBMgt.DownloadTempFile(FromFile);
              RBMgt.CopyClientFile(ToFile,STRSUBSTNO('%1\%2.xml',ServiceMgtSetup."OIOUBL Service Invoice Path","No."),TRUE);
            END ELSE BEGIN
              IF ServiceMgtSetup."OIOUBL Service Invoice Path" <> '' THEN
                MESSAGE(STRSUBSTNO(PleaseUsetheStdInvoicePath,ServiceMgtSetup."OIOUBL Service Invoice Path"))
              ELSE
                MESSAGE(UsetheIOULBClientPath);
              FileName := STRSUBSTNO('%1.xml',"No.");
              DOWNLOAD(FromFile,'',ServiceMgtSetup."OIOUBL Service Invoice Path",'',FileName);
            END;

            ServInvHeader2.GET("No.");
            ServInvHeader2."Electronic Invoice Created" := TRUE;
            ServInvHeader2.MODIFY;
          END;

  }
  CODE
  {
    VAR
      GLSetup@1101100001 : Record 98;
      CompanyInfo@1101100003 : Record 79;
      ServiceMgtSetup@1101100007 : Record 5911;
      PaymentTerms@1101100008 : Record 3;
      OIOUBLDocumentEncode@1101100006 : Codeunit 11128570;
      OIOUBLDOMManagement@1060002 : Codeunit 11128571;
      Header@1060004 : Text[1000];
      GLSetupRead@1101100000 : Boolean;
      CompanyInfoRead@1101100002 : Boolean;
      PleaseUsetheStdInvoicePath@1060005 : TextConst 'ENU=Please save the file under %1.';
      UsetheIOULBClientPath@1060001 : TextConst 'ENU=Please save the file to a location from which it can be retrieved by the OIOUBL function.';

    LOCAL PROCEDURE ReadGLSetup@1101100000();
    BEGIN
      IF NOT GLSetupRead THEN BEGIN
        GLSetup.GET;
        GLSetupRead := TRUE;
      END;
    END;

    LOCAL PROCEDURE ReadCompanyInfo@1101100002();
    BEGIN
      IF NOT CompanyInfoRead THEN BEGIN
        CompanyInfo.GET;
        CompanyInfoRead := TRUE;
      END;
    END;

    PROCEDURE GetPaymentChannelCode@1060014() : Text[7];
    BEGIN
      EXIT(CompanyInfo.GetPaymentChannelCode);
    END;

    PROCEDURE GetTaxCategoryID@1060038(Type@1060000 : 'Normal VAT,Reverse Charge VAT,Full VAT,Sales Tax';VATPercent@1060001 : Decimal) : Text[15];
    BEGIN
      CASE Type OF
        Type::"Normal VAT":
          BEGIN
            IF VATPercent <> 0 THEN
              EXIT('StandardRated');
            EXIT('ZeroRated');
          END;
        Type::"Full VAT":
          EXIT('StandardRated');
        Type::"Reverse Charge VAT":
          EXIT('ReverseCharge');
        ELSE
          EXIT('ZeroRated');
      END;
    END;

    PROCEDURE UpdateTaxAmtAndTaxableAmt@1060001(Amount@1060000 : Decimal;AmountIncludingVAT@1060001 : Decimal;VAR TaxableAmountParam@1060002 : Decimal;VAR TaxAmountParam@1060003 : Decimal);
    BEGIN
      TaxableAmountParam := TaxableAmountParam + Amount;
      TaxAmountParam := TaxAmountParam + AmountIncludingVAT - Amount;
    END;

    BEGIN
    END.
  }
}

