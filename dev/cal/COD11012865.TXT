OBJECT Codeunit 11012865 Appointment Management
{
  OBJECT-PROPERTIES
  {
    Date=;
    Time=;
    Version List=4PS14.00;
  }
  PROPERTIES
  {
    OnRun=BEGIN
          END;

  }
  CODE
  {
    VAR
      TmpOccupiedTimeBuffer@1100528600 : TEMPORARY Record 11071809;
      LastEntryNo@1100528602 : Integer;
      OccupiedType@1100528601 : ' ,Base Calendar,Employee Time Table,Pause,Service Time Table,Employee Absence,Planned Service Order,Maintenance Proposal,Reserved for Calls,Outside Maintenance Window';
      Text000@1100528603 : TextConst 'DEU=Zu planende Serviceauftr„ge haben unterschiedliche %1, %2 oder %3;ENU=Service Orders to plan have different %1, %2 or %3;NLD=Te plannen serviceorders hebben verschillen in %1, %2 of %3';

    PROCEDURE RebuildSOAvailAppointmBlocks@1100528600(IServiceOrderNo@1100528603 : Code[20]);
    VAR
      ServiceOrder@1100528604 : Record 11012823;
      PlanningAgreement@1100528602 : Record 11071729;
      ServiceAppointmentBlock@1100528600 : Record 11071965;
      ServiceClusterSeq@1100528605 : Record 11071966;
      SeekDate@1100528601 : Date;
      StartingDatePeriod@1100528606 : Date;
      EndingDatePeriod@1100528607 : Date;
    BEGIN
      ServiceOrder.GET(IServiceOrderNo);
      IF ServiceOrder."Starting Date" <> ServiceOrder."Ending Date" THEN
        EXIT;
      IF NOT GetClusterSeqFromServiceOrder(ServiceOrder, ServiceClusterSeq) THEN
        EXIT;
      ServiceAppointmentBlock.SETRANGE(Type, ServiceAppointmentBlock.Type::"Service Order");
      ServiceAppointmentBlock.SETRANGE(Code, IServiceOrderNo);
      ServiceAppointmentBlock.DELETEALL(TRUE);

      IF (ServiceOrder."Starting Date" <> 0D) AND (FORMAT(ServiceClusterSeq."Last Possible Change Bandwidth") <> '') THEN BEGIN
        IF TODAY > CALCDATE(ServiceClusterSeq."Last Possible Change Bandwidth", ServiceOrder."Starting Date") THEN
          EXIT;
      END ELSE
        IF ServiceClusterSeq."Last Possible Change Date" <> 0D THEN
          IF TODAY > ServiceClusterSeq."Last Possible Change Date" THEN
            EXIT;

      RebuildClusterSeqn(ServiceOrder."No.", ServiceClusterSeq);

      DetermineStartEndPeriod(ServiceOrder, StartingDatePeriod, EndingDatePeriod);
      IF StartingDatePeriod < TODAY THEN
        StartingDatePeriod := TODAY;
      IF StartingDatePeriod > EndingDatePeriod THEN
        EXIT;
      FOR SeekDate := StartingDatePeriod TO EndingDatePeriod DO BEGIN
        PlanningAgreement.SETFILTER(Type, '%1|%2', PlanningAgreement.Type::"Appointment Letter", PlanningAgreement.Type::Both);
        IF PlanningAgreement.FINDSET THEN
          REPEAT
            ServiceAppointmentBlock.INIT;
            ServiceAppointmentBlock.Type := ServiceAppointmentBlock.Type::"Service Order";
            ServiceAppointmentBlock.Code := IServiceOrderNo;
            ServiceAppointmentBlock."Appointment Date" := SeekDate;
            ServiceAppointmentBlock.VALIDATE("Planning Agreement Code", PlanningAgreement.Code);
            ServiceAppointmentBlock.Available :=
              IsAppointBlockAvailable(IServiceOrderNo, SeekDate, PlanningAgreement."Starting Time", PlanningAgreement."Ending Time");
            ServiceAppointmentBlock.INSERT(TRUE);

            ServiceAppointmentBlock.VALIDATE("Planning Agreement Code", '');
            IF NOT ServiceAppointmentBlock.INSERT(TRUE) THEN
              IF ServiceAppointmentBlock.Available THEN
                ServiceAppointmentBlock.MODIFY(TRUE);
          UNTIL PlanningAgreement.NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE RebuildClusterSeqn@1100528601(IServiceOrderNo@1100528600 : Code[20];IServiceClusterSeq@1100528602 : Record 11071966);
    VAR
      ServiceOrder@1100528601 : Record 11012823;
      SeekDate@1100528605 : Date;
      StartingDatePeriod@1100528603 : Date;
      EndingDatePeriod@1100528606 : Date;
    BEGIN
      IF NOT ServiceOrder.GET(IServiceOrderNo) THEN
        EXIT;
      // Refresh after 1 minute
      IF FORMAT(IServiceClusterSeq."Last Rebuild") <> '' THEN
        IF (CURRENTDATETIME - IServiceClusterSeq."Last Rebuild") / 1000 / 60 < 1 THEN
          EXIT;
      DetermineStartEndPeriod(ServiceOrder, StartingDatePeriod, EndingDatePeriod);
      IF StartingDatePeriod < TODAY THEN
        StartingDatePeriod := TODAY;
      IF StartingDatePeriod > EndingDatePeriod THEN
        EXIT;
      FOR SeekDate := StartingDatePeriod TO EndingDatePeriod DO
        RebuildClusterSeqnByDate(IServiceOrderNo, SeekDate);
      IServiceClusterSeq."Last Rebuild" := CURRENTDATETIME;
      IServiceClusterSeq.MODIFY(TRUE);
    END;

    LOCAL PROCEDURE RebuildClusterSeqnByDate@1100528622(IServiceOrderNo@1100528605 : Code[20];ISeekDate@1100528600 : Date);
    VAR
      ServiceOrder@1100528603 : Record 11012823;
      ServiceClusterSeq@1100528601 : Record 11071966;
      SCClusterEmployee@1100528602 : Record 11071967;
    BEGIN
      IF NOT ServiceOrder.GET(IServiceOrderNo) THEN
        EXIT;
      GetClusterSeqFromServiceOrder(ServiceOrder, ServiceClusterSeq);
      IF ServiceClusterSeq.Subcontractor = '' THEN BEGIN
        SCClusterEmployee.SETRANGE(Type, ServiceClusterSeq.Type);
        SCClusterEmployee.SETRANGE("Type Code", ServiceClusterSeq."Type Code");
        SCClusterEmployee.SETRANGE("Source Type", ServiceClusterSeq."Source Type");
        SCClusterEmployee.SETRANGE("Cluster Code", ServiceClusterSeq."Cluster Code");
        SCClusterEmployee.SETRANGE("Seq. No.", ServiceClusterSeq."Seq. No.");
        IF SCClusterEmployee.FINDSET THEN
          REPEAT
            RebuildClusterSeqnByEmplDate(ServiceOrder."No.", ServiceClusterSeq, SCClusterEmployee, ISeekDate);
          UNTIL SCClusterEmployee.NEXT = 0;
      END ELSE BEGIN
        CLEAR(SCClusterEmployee);
        RebuildClusterSeqnByEmplDate(ServiceOrder."No.", ServiceClusterSeq, SCClusterEmployee, ISeekDate);
      END;
    END;

    LOCAL PROCEDURE RebuildClusterSeqnByEmplDate@1100528605(IServiceOrderNo@1100528600 : Code[20];IServiceClusterSeq@1100528602 : Record 11071966;IServiceClusterEmployee@1100528609 : Record 11071967;ISeekDate@1100528607 : Date);
    VAR
      ServiceOrder@1100528601 : Record 11012823;
      ServiceAvailableTimeBlock@1100528604 : Record 11071968;
      ObjectModificationMgt@1100525000 : Codeunit 11012835;
      DatetimeMgt@1100528603 : Codeunit 11020218;
      ResourceNo@1100528605 : Code[20];
    BEGIN
      IF IServiceClusterSeq.Subcontractor = '' THEN
        ResourceNo := IServiceClusterEmployee."Resource No."
      ELSE
        ResourceNo := IServiceClusterSeq.Subcontractor;
      FillOccupiedTimeBuffer(ISeekDate, ResourceNo);

      IF NOT ServiceOrder.GET(IServiceOrderNo) THEN
        ServiceOrder.INIT;

      CASE ServiceOrder."Source Type" OF
        ServiceOrder."Source Type"::Contract:
          BEGIN
            ServiceAvailableTimeBlock.SETRANGE(Type, ServiceAvailableTimeBlock.Type::"Service Contract");
            ServiceAvailableTimeBlock.SETRANGE(Code, IServiceClusterEmployee."Type Code");
            ServiceAvailableTimeBlock.SETRANGE("Source Type", IServiceClusterEmployee."Source Type"::" ");
          END;
        ServiceOrder."Source Type"::Modification:
          BEGIN
            ServiceAvailableTimeBlock.SETRANGE(Type, ServiceAvailableTimeBlock.Type::Modification);
            ServiceAvailableTimeBlock.SETRANGE(Code, ObjectModificationMgt.GetModificationNoByServiceOrderNo(IServiceOrderNo));
            ServiceAvailableTimeBlock.SETRANGE("Source Type", IServiceClusterEmployee."Source Type"::" ");
          END;
        ServiceOrder."Source Type"::Call,
        ServiceOrder."Source Type"::Direct:
          BEGIN
            ServiceAvailableTimeBlock.SETRANGE(Type, ServiceAvailableTimeBlock.Type::"Service Location");
            ServiceAvailableTimeBlock.SETRANGE(Code, ServiceOrder."Service Location No.");
            ServiceAvailableTimeBlock.SETRANGE("Source Type", ServiceOrder."Source Type");
          END;
      END;
      ServiceAvailableTimeBlock.SETRANGE("Cluster Code", IServiceClusterSeq."Cluster Code");
      ServiceAvailableTimeBlock.SETRANGE("Cluster Seq. No.", IServiceClusterSeq."Seq. No.");
      ServiceAvailableTimeBlock.SETRANGE("Resource No.", ResourceNo);
      ServiceAvailableTimeBlock.SETRANGE("Available Date", ISeekDate);
      ServiceAvailableTimeBlock.DELETEALL(TRUE);

      TmpOccupiedTimeBuffer.SETFILTER("Unoccupied Hours", '>%1', 0);
      IF TmpOccupiedTimeBuffer.FINDSET THEN
        REPEAT
          ServiceAvailableTimeBlock.INIT;
          CASE ServiceOrder."Source Type" OF
            ServiceOrder."Source Type"::Contract:
              BEGIN
                ServiceAvailableTimeBlock.Type := ServiceAvailableTimeBlock.Type::"Service Contract";
                ServiceAvailableTimeBlock.Code := GetClusterContractNo(ServiceOrder."Service Contract No.");
                ServiceAvailableTimeBlock."Source Type" := IServiceClusterSeq."Source Type"::" ";
              END;
            ServiceOrder."Source Type"::Modification:
              BEGIN
                ServiceAvailableTimeBlock.Type := ServiceAvailableTimeBlock.Type::Modification;
                ServiceAvailableTimeBlock.Code := ObjectModificationMgt.GetModificationNoByServiceOrderNo(IServiceOrderNo);
                ServiceAvailableTimeBlock."Source Type" := IServiceClusterSeq."Source Type"::" ";
              END;
            ServiceOrder."Source Type"::Call,
            ServiceOrder."Source Type"::Direct:
              BEGIN
                ServiceAvailableTimeBlock.Type := ServiceAvailableTimeBlock.Type::"Service Location";
                ServiceAvailableTimeBlock.Code := ServiceOrder."Service Location No.";
                ServiceAvailableTimeBlock."Source Type" := IServiceClusterSeq."Source Type";
              END;
          END;
          ServiceAvailableTimeBlock."Cluster Code" := IServiceClusterSeq."Cluster Code";
          ServiceAvailableTimeBlock."Cluster Seq. No." := IServiceClusterSeq."Seq. No.";
          ServiceAvailableTimeBlock."Seq. No." := 0;
          ServiceAvailableTimeBlock."Resource No." := ResourceNo;
          ServiceAvailableTimeBlock."Available Date" := ISeekDate;
          ServiceAvailableTimeBlock."Available Block Start" := TmpOccupiedTimeBuffer."Ending Time";
          ServiceAvailableTimeBlock."Available Block End" :=
            TmpOccupiedTimeBuffer."Ending Time" + DatetimeMgt.HoursToDuration(TmpOccupiedTimeBuffer."Unoccupied Hours");
          ServiceAvailableTimeBlock."Available Hours" := TmpOccupiedTimeBuffer."Unoccupied Hours";
          ServiceAvailableTimeBlock.INSERT(TRUE);
        UNTIL TmpOccupiedTimeBuffer.NEXT = 0;
    END;

    PROCEDURE IsAppointBlockAvailable@1100528607(IServiceOrderNo@1100528602 : Code[20];ISeekDate@1100528605 : Date;IStartingTime@1100528600 : Time;IEndingTime@1100528601 : Time) : Boolean;
    VAR
      ServiceOrder@1100528603 : Record 11012823;
      ServiceClusterSeq@1100528607 : Record 11071966;
      AvailableClusterSeqnBlock@1100528608 : Record 11071968;
      ObjectModificationMgt@1100528610 : Codeunit 11012835;
      DatetimeMgt@1100528609 : Codeunit 11020218;
      BudgetHours@1100528604 : Decimal;
      AvailableHours@1100528606 : Decimal;
    BEGIN
      BudgetHours := GetServiceOrderBudgetHours(IServiceOrderNo);
      IF BudgetHours = -1 THEN
        EXIT(FALSE);
      IF NOT ServiceOrder.GET(IServiceOrderNo) THEN
        EXIT(FALSE);
      IF NOT GetClusterSeqFromServiceOrder(ServiceOrder, ServiceClusterSeq) THEN
        EXIT(FALSE);
      CASE ServiceOrder."Source Type" OF
        ServiceOrder."Source Type"::Contract:
          BEGIN
            AvailableClusterSeqnBlock.SETRANGE(Type, AvailableClusterSeqnBlock.Type::"Service Contract");
            AvailableClusterSeqnBlock.SETRANGE(Code, GetClusterContractNo(ServiceOrder."Service Contract No."));
            AvailableClusterSeqnBlock.SETRANGE("Source Type", AvailableClusterSeqnBlock."Source Type"::" ");
          END;
        ServiceOrder."Source Type"::Modification:
          BEGIN
            AvailableClusterSeqnBlock.SETRANGE(Type, AvailableClusterSeqnBlock.Type::Modification);
            AvailableClusterSeqnBlock.SETRANGE(Code, ObjectModificationMgt.GetModificationNoByServiceOrderNo(ServiceOrder."No."));
            AvailableClusterSeqnBlock.SETRANGE("Source Type", AvailableClusterSeqnBlock."Source Type"::" ");
          END;
        ServiceOrder."Source Type"::Call,
        ServiceOrder."Source Type"::Direct:
          BEGIN
            AvailableClusterSeqnBlock.SETRANGE(Type, AvailableClusterSeqnBlock.Type::"Service Location");
            AvailableClusterSeqnBlock.SETRANGE(Code, ServiceOrder."Service Location No.");
            AvailableClusterSeqnBlock.SETRANGE("Source Type", ServiceOrder."Source Type");
          END;
      END;
      AvailableClusterSeqnBlock.SETRANGE("Cluster Code", ServiceOrder."Service Cluster");
      AvailableClusterSeqnBlock.SETRANGE("Cluster Seq. No.", ServiceOrder."Service Cluster Seqn.");
      AvailableClusterSeqnBlock.SETRANGE("Available Date", ISeekDate);
      AvailableClusterSeqnBlock.SETFILTER("Available Block Start", '<=%1', IEndingTime);
      AvailableClusterSeqnBlock.SETFILTER("Available Block End", '>=%1', IStartingTime);
      AvailableClusterSeqnBlock.SETFILTER("Available Hours", '>=%1', BudgetHours);
      IF AvailableClusterSeqnBlock.FINDSET THEN
        REPEAT
          AvailableHours := AvailableClusterSeqnBlock."Available Hours";
          IF IStartingTime > AvailableClusterSeqnBlock."Available Block Start" THEN
            AvailableHours -= DatetimeMgt.DurationToHours(IStartingTime - AvailableClusterSeqnBlock."Available Block Start");
          IF IEndingTime < AvailableClusterSeqnBlock."Available Block End" THEN
            AvailableHours -= DatetimeMgt.DurationToHours(AvailableClusterSeqnBlock."Available Block End" - IEndingTime);
          IF BudgetHours <= AvailableHours THEN
            EXIT(TRUE);
        UNTIL AvailableClusterSeqnBlock.NEXT = 0;
    END;

    LOCAL PROCEDURE GetServiceOrderBudgetHours@1100528613(IServiceOrderNo@1100528601 : Code[20]) BudgetHours : Decimal;
    VAR
      ServiceOrder@1100528600 : Record 11012823;
      DatetimeMgt@1100528602 : Codeunit 11020218;
    BEGIN
      IF ServiceOrder.GET(IServiceOrderNo) THEN BEGIN
        ServiceOrder.CALCFIELDS("Budget Hours");
        IF ServiceOrder."Budget Hours" <> 0 THEN
          BudgetHours := ServiceOrder."Budget Hours"
        ELSE IF ServiceOrder."Expected Hours" <> 0 THEN
          BudgetHours := ServiceOrder."Expected Hours"
        ELSE IF ServiceOrder."Starting Date" <> ServiceOrder."Ending Date" THEN
          BudgetHours := -1
        ELSE IF (ServiceOrder."Starting Time" <> 0T) AND (ServiceOrder."Ending Time" <> 0T) THEN
          BudgetHours := DatetimeMgt.DurationToHours(ServiceOrder."Ending Time" - ServiceOrder."Starting Time");
        BudgetHours := DatetimeMgt.RoundHoursByMinutes(BudgetHours, 1);
      END;
    END;

    PROCEDURE ReplanServiceOrder@1100528604(IServiceOrderNo@1100528600 : Code[20];INewAppointmentDate@1100528602 : Date;INewAppointementCode@1100528601 : Code[10]) : Boolean;
    VAR
      ServiceOrder@1100528603 : Record 11012823;
      WorkOrder@1100528613 : Record 11229279;
      AvailableClusterSeqnBlock@1100528604 : Record 11071968;
      PlanningAgreement@1100528607 : Record 11071729;
      ResourceWOP@1100528612 : Record 11229278;
      ObjectModificationMgt@1100528614 : Codeunit 11012835;
      DatetimeMgt@1100528615 : Codeunit 11020218;
      BudgetHours@1100528605 : Decimal;
      PreviousStartingDate@1100528606 : Date;
      StartingTime@1100528611 : Time;
      NewStartingTime@1100528610 : Time;
      EndingTime@1100528609 : Time;
      NewResourceNo@1100528608 : Code[20];
    BEGIN
      IF NOT ServiceOrder.GET(IServiceOrderNo) THEN
        EXIT(FALSE);
      BudgetHours := GetServiceOrderBudgetHours(IServiceOrderNo);
      IF BudgetHours = -1 THEN
        EXIT(FALSE);
      IF NOT CanReplanServiceOrder(IServiceOrderNo) THEN
        EXIT(FALSE);
      IF (INewAppointmentDate = ServiceOrder."Starting Date") AND
         (INewAppointementCode = GetPlanningAgreementCode(IServiceOrderNo))
      THEN
        EXIT(FALSE);

      RebuildClusterSeqnByDate(ServiceOrder."No.", INewAppointmentDate);
      PlanningAgreement.GET(INewAppointementCode);
      CASE ServiceOrder."Source Type" OF
        ServiceOrder."Source Type"::Contract:
          BEGIN
            AvailableClusterSeqnBlock.SETRANGE(Type, AvailableClusterSeqnBlock.Type::"Service Contract");
            AvailableClusterSeqnBlock.SETRANGE(Code, GetClusterContractNo(ServiceOrder."Service Contract No."));
            AvailableClusterSeqnBlock.SETRANGE("Source Type", AvailableClusterSeqnBlock."Source Type"::" ");
          END;
        ServiceOrder."Source Type"::Modification:
          BEGIN
            AvailableClusterSeqnBlock.SETRANGE(Type, AvailableClusterSeqnBlock.Type::Modification);
            AvailableClusterSeqnBlock.SETRANGE(Code, ObjectModificationMgt.GetModificationNoByServiceOrderNo(ServiceOrder."No."));
            AvailableClusterSeqnBlock.SETRANGE("Source Type", AvailableClusterSeqnBlock."Source Type"::" ");
          END;
        ServiceOrder."Source Type"::Call,
        ServiceOrder."Source Type"::Direct:
          BEGIN
            AvailableClusterSeqnBlock.SETRANGE(Type, AvailableClusterSeqnBlock.Type::"Service Location");
            AvailableClusterSeqnBlock.SETRANGE(Code, ServiceOrder."Service Location No.");
            AvailableClusterSeqnBlock.SETRANGE("Source Type", ServiceOrder."Source Type");
          END;
      END;
      AvailableClusterSeqnBlock.SETRANGE("Cluster Code", ServiceOrder."Service Cluster");
      AvailableClusterSeqnBlock.SETRANGE("Cluster Seq. No.", ServiceOrder."Service Cluster Seqn.");
      AvailableClusterSeqnBlock.SETRANGE("Available Date", INewAppointmentDate);
      AvailableClusterSeqnBlock.SETFILTER("Available Hours", '>=%1', BudgetHours);
      AvailableClusterSeqnBlock.SETFILTER("Available Block Start", '<%1', PlanningAgreement."Ending Time");
      AvailableClusterSeqnBlock.SETFILTER("Available Block End", '>%1', PlanningAgreement."Starting Time");
      IF AvailableClusterSeqnBlock.FINDSET THEN
        REPEAT
          StartingTime := PlanningAgreement."Starting Time";
          EndingTime := PlanningAgreement."Ending Time";
          CASE TRUE OF
            PlanningAgreement."Starting Time" < AvailableClusterSeqnBlock."Available Block Start":
              StartingTime := AvailableClusterSeqnBlock."Available Block Start";
            PlanningAgreement."Ending Time" > AvailableClusterSeqnBlock."Available Block End":
              EndingTime := AvailableClusterSeqnBlock."Available Block End";
          END;
          IF EndingTime - StartingTime >= DatetimeMgt.HoursToDuration(BudgetHours) THEN BEGIN
            NewStartingTime := StartingTime;
            NewResourceNo := AvailableClusterSeqnBlock."Resource No.";
          END;
        UNTIL (AvailableClusterSeqnBlock.NEXT = 0) OR (NewStartingTime <> 0T);
      IF NewStartingTime = 0T THEN
        EXIT(FALSE);

      PreviousStartingDate := ServiceOrder."Starting Date";

      WorkOrder.SETCURRENTKEY("Source Company", "Source Type", "Source No.");
      WorkOrder.SETRANGE("Source Company", COMPANYNAME);
      WorkOrder.SETRANGE("Source Type", WorkOrder."Source Type"::ServiceOrder);
      WorkOrder.SETRANGE("Source No.", ServiceOrder."No.");
      WorkOrder.DELETEALL(TRUE);

      ServiceOrder.FIND('=');
      IF INewAppointmentDate <> ServiceOrder."Starting Date" THEN BEGIN
        ServiceOrder.VALIDATE("First Possible Starting Date", 0D);
        ServiceOrder.VALIDATE("First Possible Starting Time", 0T);
        ServiceOrder.VALIDATE("Last Possible Ending Time", 0T);
        ServiceOrder.VALIDATE("Ending Date", 0D);
        ServiceOrder."Firm Planned" := FALSE;
        ServiceOrder.VALIDATE("Starting Date", INewAppointmentDate);
        ServiceOrder.VALIDATE("Ending Date", INewAppointmentDate);
        ServiceOrder.VALIDATE("Firm Planned", TRUE);
      END;
      ServiceOrder.VALIDATE("Ending Time", 0T);
      ServiceOrder.VALIDATE("Starting Time", NewStartingTime);
      ServiceOrder.VALIDATE("Ending Time", ServiceOrder."Starting Time" + DatetimeMgt.HoursToDuration(BudgetHours));

      IF NOT ResourceWOP.GET(NewResourceNo) THEN
        ResourceWOP.INIT;
      CASE ResourceWOP.Type OF
        ResourceWOP.Type::Employee:
          ServiceOrder.VALIDATE("Employee No.", NewResourceNo);
        ResourceWOP.Type::Subcontractor:
          ServiceOrder.VALIDATE(Subcontractor, NewResourceNo);
      END;
      ServiceOrder.MODIFY(TRUE);
      ServiceOrder.UpdateWorkOrder(TRUE);

      IF PreviousStartingDate <> ServiceOrder."Starting Date" THEN
        RebuildClusterSeqnByDate(ServiceOrder."No.", PreviousStartingDate);
      RebuildClusterSeqnByDate(ServiceOrder."No.", INewAppointmentDate);

      EXIT(TRUE);
    END;

    PROCEDURE CanReplanServiceOrder@1100528606(IServiceOrderNo@1100528600 : Code[20]) : Boolean;
    VAR
      ServiceClusterSeq@1100528603 : Record 11071966;
      ServiceOrder@1100528601 : Record 11012823;
      LastPossibleChangeDate@1100528607 : Date;
    BEGIN
      IF NOT ServiceOrder.GET(IServiceOrderNo) THEN
        EXIT(FALSE);
      IF NOT GetClusterSeqFromServiceOrder(ServiceOrder, ServiceClusterSeq) THEN
        EXIT(FALSE);
      IF (ServiceOrder."Starting Date" <> 0D) AND (FORMAT(ServiceClusterSeq."Last Possible Change Bandwidth") <> '') THEN
        LastPossibleChangeDate := CALCDATE(ServiceClusterSeq."Last Possible Change Bandwidth", ServiceOrder."Starting Date")
      ELSE
        LastPossibleChangeDate := ServiceClusterSeq."Last Possible Change Date";
      EXIT((LastPossibleChangeDate >= TODAY) OR (LastPossibleChangeDate = 0D));
    END;

    PROCEDURE GetPlanningAgreementCode@1100528624(IServiceOrderNo@1100528601 : Code[20]) : Code[10];
    VAR
      ServiceOrder@1100528602 : Record 11012823;
    BEGIN
      IF NOT ServiceOrder.GET(IServiceOrderNo) THEN
        EXIT;
      EXIT(GetPlanningAgreementCodeByTime(ServiceOrder."Starting Time"));
    END;

    PROCEDURE GetPlanningAgreementCodeByTime@1100528603(IStartingTime@1100528601 : Time) : Code[10];
    VAR
      PlanningAgreement@1100528600 : Record 11071729;
    BEGIN
      PlanningAgreement.SETFILTER(Type, '%1|%2', PlanningAgreement.Type::"Appointment Letter", PlanningAgreement.Type::Both);
      PlanningAgreement.SETFILTER("Starting Time", '<=%1', IStartingTime);
      PlanningAgreement.SETFILTER("Ending Time", '>%1', IStartingTime);
      IF PlanningAgreement.FINDLAST THEN
        EXIT(PlanningAgreement.Code);
    END;

    PROCEDURE GetMaintAppointLink@1100528612(IServiceOrderNo@1100528601 : Code[20];IType@1100528600 : 'Confirmation,Change') : Text[250];
    VAR
      ServPortSetup@1100528602 : Record 11126065;
      AppointmentMgtSPTWS@1100528604 : Codeunit 11012864;
      ActionText@1100528603 : Text[30];
    BEGIN
      IF NOT ServPortSetup.FINDFIRST THEN
        EXIT;

      CASE IType OF
        IType::Confirmation:
          ActionText := 'confirmation';
        IType::Change:
          ActionText := 'change';
      END;

      EXIT(STRSUBSTNO('%1/CallAppointment.aspx?action=%2&SO=%3&hash=%4',
        ServPortSetup."URL Site Root", ActionText, IServiceOrderNo, AppointmentMgtSPTWS.GetMaintAppointmentHash(IServiceOrderNo)));
    END;

    PROCEDURE GetFullHTMLMaintAppointLink@1100528611(IServiceOrderNo@1100528601 : Code[20];IType@1100528600 : 'Confirmation,Change';ILinkText@1100528602 : Text[50]) : Text[250];
    VAR
      ServPortSetup@1100528603 : Record 11126065;
    BEGIN
      IF NOT ServPortSetup.FINDFIRST THEN
        EXIT;
      EXIT(STRSUBSTNO('<a href="%1">%2</a>', GetMaintAppointLink(IServiceOrderNo, IType), ILinkText));
    END;

    PROCEDURE "----"@1100528602();
    BEGIN
    END;

    LOCAL PROCEDURE FillOccupiedTimeBuffer@1100528610(IDate@1100528601 : Date;IResourceNo@1100528606 : Code[20]);
    VAR
      CompanyInformation@1100528602 : Record 79;
      EmployeeTimeTable@1100528600 : Record 11012923;
      BaseCalendar@1100528607 : Record 11072014;
      EmployeeAbsence@1100528609 : Record 5207;
      ServiceOrder@1100528611 : Record 11012823;
      Resource@1100529001 : Record 11229278;
      WorkOrder@1100528612 : Record 11229279;
      CompanyPlanGroup@1100528616 : Record 11229300;
      CalendarManagement@1100528604 : Codeunit 7600;
      NonWorking@1100528603 : Boolean;
      Description@1100528605 : Text[30];
      DOW@1100528610 : Integer;
      StartingTime@1100528614 : Time;
      EndingTime@1100528615 : Time;
      EmployeeNo@1100529000 : Code[20];
      SetupCompanyName@1100528613 : Text[30];
    BEGIN
      IF IResourceNo <> '' THEN BEGIN
        IF Resource.GET(IResourceNo) THEN
          IF Resource.Type = Resource.Type::Employee THEN
            EmployeeNo := Resource."Source No.";
      END;
      IF (EmployeeNo <> '') AND (COMPANYNAME <> Resource.Company) THEN BEGIN
        EmployeeTimeTable.CHANGECOMPANY(Resource.Company);
        EmployeeAbsence.CHANGECOMPANY(Resource.Company);
      END;
      SetupCompanyName := CompanyPlanGroup.GetSetupCompanyOfCurrentCompanyPlanGroup();
      IF SetupCompanyName <> COMPANYNAME THEN BEGIN
        CompanyInformation.CHANGECOMPANY(SetupCompanyName);
        BaseCalendar.CHANGECOMPANY(SetupCompanyName);
      END;

      TmpOccupiedTimeBuffer.RESET;
      TmpOccupiedTimeBuffer.DELETEALL(TRUE);
      ResetOccupiedTimeBufferFilter(TmpOccupiedTimeBuffer);
      TmpOccupiedTimeBuffer.SETRANGE("Starting Date", IDate);
      IF NOT TmpOccupiedTimeBuffer.ISEMPTY THEN
        EXIT;

      CompanyInformation.GET;
      NonWorking := CalendarManagement.CheckDateStatus(CompanyInformation."Base Calendar Code", IDate, Description);
      IF NonWorking THEN BEGIN
        InsertOccupiedTimeEntry(IDate, 0T, 235959T, OccupiedType::"Base Calendar");
        EXIT;
      END;

      IF IDate = TODAY THEN
        InsertOccupiedTimeEntry(IDate, 0T, TIME, OccupiedType::"Outside Maintenance Window");

      DOW := DATE2DWY(IDate, 1);
      EmployeeTimeTable.SETRANGE("Employee No.", EmployeeNo);
      EmployeeTimeTable.SETFILTER("Effective Date", '..%1', IDate);
      IF (EmployeeNo <> '') AND EmployeeTimeTable.FINDLAST THEN BEGIN
        CASE DOW OF
          1:
            BEGIN
              IF EmployeeTimeTable."Monday Work From" <> 0T THEN BEGIN
                InsertOccupiedTimeEntry(IDate, 0T, EmployeeTimeTable."Monday Work From", OccupiedType::"Employee Time Table");
                InsertOccupiedTimeEntry(IDate, EmployeeTimeTable."Monday Work Until", 235959T, OccupiedType::"Employee Time Table");
              END ELSE
                InsertOccupiedTimeEntry(IDate, 0T, 235959T, OccupiedType::"Employee Time Table");
              IF (EmployeeTimeTable."Monday Pause From" <> 0T) AND (EmployeeTimeTable."Monday Pause Until" <> 0T) THEN
                InsertOccupiedTimeEntry(
                  IDate, EmployeeTimeTable."Monday Pause From", EmployeeTimeTable."Monday Pause Until", OccupiedType::Pause);
            END;
          2:
            BEGIN
              IF EmployeeTimeTable."Tuesday Work From" <> 0T THEN BEGIN
                InsertOccupiedTimeEntry(IDate, 0T, EmployeeTimeTable."Tuesday Work From", OccupiedType::"Employee Time Table");
                InsertOccupiedTimeEntry(IDate, EmployeeTimeTable."Tuesday Work Until", 235959T, OccupiedType::"Employee Time Table");
              END ELSE
                InsertOccupiedTimeEntry(IDate, 0T, 235959T, OccupiedType::"Employee Time Table");
              IF (EmployeeTimeTable."Tuesday Pause From" <> 0T) AND (EmployeeTimeTable."Tuesday Pause Until" <> 0T) THEN
                InsertOccupiedTimeEntry(
                  IDate, EmployeeTimeTable."Tuesday Pause From", EmployeeTimeTable."Tuesday Pause Until", OccupiedType::Pause);
            END;
          3:
            BEGIN
              IF EmployeeTimeTable."Wednesday Work From" <> 0T THEN BEGIN
                InsertOccupiedTimeEntry(IDate, 0T, EmployeeTimeTable."Wednesday Work From", OccupiedType::"Employee Time Table");
                InsertOccupiedTimeEntry(IDate, EmployeeTimeTable."Wednesday Work Until", 235959T, OccupiedType::"Employee Time Table");
              END ELSE
                InsertOccupiedTimeEntry(IDate, 0T, 235959T, OccupiedType::"Employee Time Table");
              IF (EmployeeTimeTable."Wednesday Pause From" <> 0T) AND (EmployeeTimeTable."Wednesday Pause Until" <> 0T) THEN
                InsertOccupiedTimeEntry(
                  IDate, EmployeeTimeTable."Wednesday Pause From", EmployeeTimeTable."Wednesday Pause Until", OccupiedType::Pause);
            END;
          4:
            BEGIN
              IF EmployeeTimeTable."Thursday Work From" <> 0T THEN BEGIN
                InsertOccupiedTimeEntry(IDate, 0T, EmployeeTimeTable."Thursday Work From", OccupiedType::"Employee Time Table");
                InsertOccupiedTimeEntry(IDate, EmployeeTimeTable."Thursday Work Until", 235959T, OccupiedType::"Employee Time Table");
              END ELSE
                InsertOccupiedTimeEntry(IDate, 0T, 235959T, OccupiedType::"Employee Time Table");
              IF (EmployeeTimeTable."Thursday Pause From" <> 0T) AND (EmployeeTimeTable."Thursday Pause Until" <> 0T) THEN
                InsertOccupiedTimeEntry(
                  IDate, EmployeeTimeTable."Thursday Pause From", EmployeeTimeTable."Thursday Pause Until", OccupiedType::Pause);
            END;
          5:
            BEGIN
              IF EmployeeTimeTable."Friday Work From" <> 0T THEN BEGIN
                InsertOccupiedTimeEntry(IDate, 0T, EmployeeTimeTable."Friday Work From", OccupiedType::"Employee Time Table");
                InsertOccupiedTimeEntry(IDate, EmployeeTimeTable."Friday Work Until", 235959T, OccupiedType::"Employee Time Table");
              END ELSE
                InsertOccupiedTimeEntry(IDate, 0T, 235959T, OccupiedType::"Employee Time Table");
              IF (EmployeeTimeTable."Friday Pause From" <> 0T) AND (EmployeeTimeTable."Friday Pause Until" <> 0T) THEN
                InsertOccupiedTimeEntry(
                  IDate, EmployeeTimeTable."Friday Pause From", EmployeeTimeTable."Friday Pause Until", OccupiedType::Pause);
            END;
          6:
            BEGIN
              IF EmployeeTimeTable."Saturday Work From" <> 0T THEN BEGIN
                InsertOccupiedTimeEntry(IDate, 0T, EmployeeTimeTable."Saturday Work From", OccupiedType::"Employee Time Table");
                InsertOccupiedTimeEntry(IDate, EmployeeTimeTable."Saturday Work Until", 235959T, OccupiedType::"Employee Time Table");
              END ELSE
                InsertOccupiedTimeEntry(IDate, 0T, 235959T, OccupiedType::"Employee Time Table");
              IF (EmployeeTimeTable."Saturday Pause From" <> 0T) AND (EmployeeTimeTable."Saturday Pause Until" <> 0T) THEN
                InsertOccupiedTimeEntry(
                  IDate, EmployeeTimeTable."Saturday Pause From", EmployeeTimeTable."Saturday Pause Until", OccupiedType::Pause);
            END;
          7:
            BEGIN
              IF EmployeeTimeTable."Sunday Work From" <> 0T THEN BEGIN
                InsertOccupiedTimeEntry(IDate, 0T, EmployeeTimeTable."Sunday Work From", OccupiedType::"Employee Time Table");
                InsertOccupiedTimeEntry(IDate, EmployeeTimeTable."Sunday Work Until", 235959T, OccupiedType::"Employee Time Table");
              END ELSE
                InsertOccupiedTimeEntry(IDate, 0T, 235959T, OccupiedType::"Employee Time Table");
              IF (EmployeeTimeTable."Sunday Pause From" <> 0T) AND (EmployeeTimeTable."Sunday Pause Until" <> 0T) THEN
                InsertOccupiedTimeEntry(
                  IDate, EmployeeTimeTable."Sunday Pause From", EmployeeTimeTable."Sunday Pause Until", OccupiedType::Pause);
            END;
        END;
      END ELSE BEGIN
        CompanyInformation.GET;
        IF BaseCalendar.GET(CompanyInformation."Base Calendar Code") THEN BEGIN
          CASE DOW OF
            1:
              BEGIN
                IF BaseCalendar."Monday Work From" <> 0T THEN BEGIN
                  InsertOccupiedTimeEntry(IDate, 0T, BaseCalendar."Monday Work From", OccupiedType::"Employee Time Table");
                  InsertOccupiedTimeEntry(IDate, BaseCalendar."Monday Work Until", 235959T, OccupiedType::"Employee Time Table");
                END ELSE
                  InsertOccupiedTimeEntry(IDate, 0T, 235959T, OccupiedType::"Employee Time Table");
                IF (BaseCalendar."Monday Pause From" <> 0T) AND (BaseCalendar."Monday Pause Until" <> 0T) THEN
                  InsertOccupiedTimeEntry(
                    IDate, BaseCalendar."Monday Pause From", BaseCalendar."Monday Pause Until", OccupiedType::Pause);
              END;
            2:
              BEGIN
                IF BaseCalendar."Tuesday Work From" <> 0T THEN BEGIN
                  InsertOccupiedTimeEntry(IDate, 0T, BaseCalendar."Tuesday Work From", OccupiedType::"Employee Time Table");
                  InsertOccupiedTimeEntry(IDate, BaseCalendar."Tuesday Work Until", 235959T, OccupiedType::"Employee Time Table");
                END ELSE
                  InsertOccupiedTimeEntry(IDate, 0T, 235959T, OccupiedType::"Employee Time Table");
                IF (BaseCalendar."Tuesday Pause From" <> 0T) AND (BaseCalendar."Tuesday Pause Until" <> 0T) THEN
                  InsertOccupiedTimeEntry(
                    IDate, BaseCalendar."Tuesday Pause From", BaseCalendar."Tuesday Pause Until", OccupiedType::Pause);
              END;
            3:
              BEGIN
                IF BaseCalendar."Wednesday Work From" <> 0T THEN BEGIN
                  InsertOccupiedTimeEntry(IDate, 0T, BaseCalendar."Wednesday Work From", OccupiedType::"Employee Time Table");
                  InsertOccupiedTimeEntry(
                   IDate, BaseCalendar."Wednesday Work Until", 235959T, OccupiedType::"Employee Time Table");
                END ELSE
                  InsertOccupiedTimeEntry(IDate, 0T, 235959T, OccupiedType::"Employee Time Table");
                IF (BaseCalendar."Wednesday Pause From" <> 0T) AND (BaseCalendar."Wednesday Pause Until" <> 0T) THEN
                  InsertOccupiedTimeEntry(
                    IDate, BaseCalendar."Wednesday Pause From", BaseCalendar."Wednesday Pause Until", OccupiedType::Pause);
              END;
            4:
              BEGIN
                IF BaseCalendar."Thursday Work From" <> 0T THEN BEGIN
                  InsertOccupiedTimeEntry(IDate, 0T, BaseCalendar."Thursday Work From", OccupiedType::"Employee Time Table");
                  InsertOccupiedTimeEntry(
                    IDate, BaseCalendar."Thursday Work Until", 235959T, OccupiedType::"Employee Time Table");
                END ELSE
                  InsertOccupiedTimeEntry(IDate, 0T, 235959T, OccupiedType::"Employee Time Table");
                IF (BaseCalendar."Thursday Pause From" <> 0T) AND (BaseCalendar."Thursday Pause Until" <> 0T) THEN
                  InsertOccupiedTimeEntry(
                    IDate, BaseCalendar."Thursday Pause From", BaseCalendar."Thursday Pause Until", OccupiedType::Pause);
              END;
            5:
              BEGIN
                IF BaseCalendar."Friday Work From" <> 0T THEN BEGIN
                  InsertOccupiedTimeEntry(IDate, 0T, BaseCalendar."Friday Work From", OccupiedType::"Employee Time Table");
                  InsertOccupiedTimeEntry(IDate, BaseCalendar."Friday Work Until", 235959T, OccupiedType::"Employee Time Table");
                END ELSE
                  InsertOccupiedTimeEntry(IDate, 0T, 235959T, OccupiedType::"Employee Time Table");
                IF (BaseCalendar."Friday Pause From" <> 0T) AND (BaseCalendar."Friday Pause Until" <> 0T) THEN
                  InsertOccupiedTimeEntry(
                    IDate, BaseCalendar."Friday Pause From", BaseCalendar."Friday Pause Until", OccupiedType::Pause);
              END;
            6:
              BEGIN
                IF BaseCalendar."Saturday Work From" <> 0T THEN BEGIN
                  InsertOccupiedTimeEntry(IDate, 0T, BaseCalendar."Saturday Work From", OccupiedType::"Employee Time Table");
                  InsertOccupiedTimeEntry(
                    IDate, BaseCalendar."Saturday Work Until", 235959T, OccupiedType::"Employee Time Table");
                END ELSE
                  InsertOccupiedTimeEntry(IDate, 0T, 235959T, OccupiedType::"Employee Time Table");
                IF (BaseCalendar."Saturday Pause From" <> 0T) AND (BaseCalendar."Saturday Pause Until" <> 0T) THEN
                  InsertOccupiedTimeEntry(
                    IDate, BaseCalendar."Saturday Pause From", BaseCalendar."Saturday Pause Until", OccupiedType::Pause);
              END;
            7:
              BEGIN
                IF BaseCalendar."Sunday Work From" <> 0T THEN BEGIN
                  InsertOccupiedTimeEntry(IDate, 0T, BaseCalendar."Sunday Work From", OccupiedType::"Employee Time Table");
                  InsertOccupiedTimeEntry(IDate, BaseCalendar."Sunday Work Until", 235959T, OccupiedType::"Employee Time Table");
                END ELSE
                  InsertOccupiedTimeEntry(IDate, 0T, 235959T, OccupiedType::"Employee Time Table");
                IF (BaseCalendar."Sunday Pause From" <> 0T) AND (BaseCalendar."Sunday Pause Until" <> 0T) THEN
                  InsertOccupiedTimeEntry(
                    IDate, BaseCalendar."Sunday Pause From", BaseCalendar."Sunday Pause Until", OccupiedType::Pause);
              END;
          END;
        END;
      END;

      IF EmployeeNo <> '' THEN BEGIN
        EmployeeAbsence.SETCURRENTKEY("Employee No.", "From Date");
        EmployeeAbsence.SETRANGE("Employee No.", EmployeeNo);
        EmployeeAbsence.SETFILTER("From Date", '<=%1', IDate);
        EmployeeAbsence.SETFILTER("To Date", '>=%1', IDate);
        IF EmployeeAbsence.FINDSET THEN
          REPEAT
            IF EmployeeAbsence."From Date" < IDate THEN
              StartingTime := 0T
            ELSE
              StartingTime := EmployeeAbsence."From Time";
            IF EmployeeAbsence."To Date" > IDate THEN
              EndingTime := 0T
            ELSE
              EndingTime := EmployeeAbsence."Until Time";
            EmployeeAbsence.CALCFIELDS(Plannable);
            IF NOT EmployeeAbsence.Plannable THEN
              InsertOccupiedTimeEntry(IDate, StartingTime, EndingTime, OccupiedType::"Employee Absence");
          UNTIL EmployeeAbsence.NEXT = 0;
      END;

      RemoveDoubleOccTimeEntries(IDate);
      UpdateUnoccupiedTimeEntries(IDate);

      WorkOrder.SETCURRENTKEY("Resource No.", "Starting Date/Time", "Ending Date/Time");
      WorkOrder.SETRANGE("Resource No.", IResourceNo);
      WorkOrder.SETFILTER("Starting Date/Time", '<=%1', DATI2VARIANT(IDate, 235959.999T));
      WorkOrder.SETFILTER("Ending Date/Time", '>=%1', DATI2VARIANT(IDate, 0T));
      IF WorkOrder.FINDSET THEN
        REPEAT
          IF DT2DATE(WorkOrder."Starting Date/Time") < IDate THEN
            StartingTime := 0T
          ELSE
            StartingTime := DT2TIME(WorkOrder."Starting Date/Time");
          IF DT2DATE(WorkOrder."Ending Date/Time") > IDate THEN
            EndingTime := 0T
          ELSE
            EndingTime := DT2TIME(WorkOrder."Ending Date/Time");
          IF WorkOrder."Source Type" = WorkOrder."Source Type"::ServiceOrder THEN BEGIN
            IF WorkOrder."Source Company" <> ServiceOrder.CURRENTCOMPANY THEN
              ServiceOrder.CHANGECOMPANY(WorkOrder."Source Company");
            ServiceOrder.GET(WorkOrder."Source No.");
          END ELSE
            CLEAR(ServiceOrder);
          IF (ServiceOrder."No." = '') OR (ServiceOrder.Status < ServiceOrder.Status::Cancelled) THEN
            InsertOccupiedTimeEntry(IDate, StartingTime, EndingTime, OccupiedType::"Planned Service Order");
        UNTIL WorkOrder.NEXT = 0;

      RemoveDoubleOccTimeEntries(IDate);
      UpdateUnoccupiedTimeEntries(IDate);
    END;

    LOCAL PROCEDURE InsertOccupiedTimeEntry@1100528608(IStartingDate@1100528600 : Date;IStartTime@1100528601 : Time;IEndTime@1100528603 : Time;IOccupiedType@1100528605 : Option);
    BEGIN
      TmpOccupiedTimeBuffer.INIT;
      LastEntryNo += 1;
      TmpOccupiedTimeBuffer."Entry No." := LastEntryNo;
      TmpOccupiedTimeBuffer."Starting Date" := IStartingDate;
      TmpOccupiedTimeBuffer."Starting Time" := IStartTime;
      IF ((IStartTime = IEndTime) AND (IStartTime = 0T)) OR (IEndTime = 0T) THEN //T007409
        TmpOccupiedTimeBuffer."Ending Time" := 235959T
      ELSE
        TmpOccupiedTimeBuffer."Ending Time" := IEndTime;
      TmpOccupiedTimeBuffer."Occupied Type" := IOccupiedType;
      TmpOccupiedTimeBuffer.INSERT(TRUE);
    END;

    PROCEDURE RemoveDoubleOccTimeEntries@1100528609(IStartingDate@1100528602 : Date);
    VAR
      TmpOccupiedTimeBuffer2@1100528603 : TEMPORARY Record 11071809;
      StartingTime@1100528600 : Time;
      EndingTime@1100528601 : Time;
    BEGIN
      TmpOccupiedTimeBuffer2.COPY(TmpOccupiedTimeBuffer, TRUE);
      ResetOccupiedTimeBufferFilter(TmpOccupiedTimeBuffer2);
      TmpOccupiedTimeBuffer2.SETRANGE("Starting Date", IStartingDate);
      IF TmpOccupiedTimeBuffer2.FINDFIRST THEN
        REPEAT
          IF TmpOccupiedTimeBuffer2."Ending Time" > EndingTime THEN BEGIN
            IF TmpOccupiedTimeBuffer2."Starting Time" > EndingTime THEN
              StartingTime := TmpOccupiedTimeBuffer2."Starting Time";
            EndingTime := TmpOccupiedTimeBuffer2."Ending Time";
          END
          ELSE
          IF TmpOccupiedTimeBuffer2."Ending Time" <= EndingTime THEN BEGIN
            TmpOccupiedTimeBuffer2.Deleted := TRUE;
            TmpOccupiedTimeBuffer2.MODIFY;
          END;
        UNTIL TmpOccupiedTimeBuffer2.NEXT = 0;
    END;

    PROCEDURE UpdateUnoccupiedTimeEntries@1100528615(IStartingDate@1100528602 : Date);
    VAR
      TmpOccupiedTimeBuffer2@1100528605 : TEMPORARY Record 11071809;
      LastOccupiedTimeBuffer@1100528601 : TEMPORARY Record 11071809;
      DatetimeMgt@1100528604 : Codeunit 11020218;
      EndingTime@1100528600 : Time;
      TimeDuration@1100528603 : Integer;
    BEGIN
      EndingTime := 0T;
      LastOccupiedTimeBuffer.COPY(TmpOccupiedTimeBuffer, TRUE);
      TmpOccupiedTimeBuffer2.COPY(TmpOccupiedTimeBuffer, TRUE);
      ResetOccupiedTimeBufferFilter(TmpOccupiedTimeBuffer2);
      TmpOccupiedTimeBuffer2.SETRANGE("Starting Date", IStartingDate);
      IF TmpOccupiedTimeBuffer2.FINDSET THEN BEGIN
        REPEAT
          IF EndingTime > 0T THEN BEGIN
            IF TmpOccupiedTimeBuffer2."Starting Time" >= EndingTime THEN
              TimeDuration := TmpOccupiedTimeBuffer2."Starting Time" - EndingTime
            ELSE
              TimeDuration := 0;
            LastOccupiedTimeBuffer."Unoccupied Hours" := DatetimeMgt.DurationToHours(TimeDuration);
            LastOccupiedTimeBuffer.MODIFY;
          END;
          EndingTime := TmpOccupiedTimeBuffer2."Ending Time";
          LastOccupiedTimeBuffer := TmpOccupiedTimeBuffer2;
        UNTIL TmpOccupiedTimeBuffer2.NEXT = 0;
        TimeDuration := 235959T - EndingTime;
        LastOccupiedTimeBuffer."Unoccupied Hours" := DatetimeMgt.DurationToHours(TimeDuration);
        LastOccupiedTimeBuffer.MODIFY;
      END;
    END;

    PROCEDURE ResetOccupiedTimeBufferFilter@1100528614(VAR OBuffer@1100528600 : TEMPORARY Record 11071809);
    BEGIN
      OBuffer.RESET;
      OBuffer.SETCURRENTKEY("Starting Date", "Starting Time");
      OBuffer.SETRANGE(Deleted, FALSE);
    END;

    PROCEDURE GetClusterContractNo@1100528617(IServiceContractNo@1100528600 : Code[20]) : Code[20];
    VAR
      ServiceContract@1100528601 : Record 11012812;
    BEGIN
      ServiceContract.GET(IServiceContractNo);
      IF ServiceContract."Use Contract Clusters" THEN
        EXIT(IServiceContractNo)
      ELSE
        EXIT;
    END;

    PROCEDURE GetClusterSeqFromServiceOrder@1100528620(IServiceOrder@1100528600 : Record 11012823;VAR OServiceClusterSeq@1100528601 : Record 11071966) : Boolean;
    VAR
      ServiceContract@1100528603 : Record 11012812;
      ObjectModification@1100528604 : Record 11071700;
      ObjectModificationMgt@1100528605 : Codeunit 11012835;
      ObjectModificationNo@1100528606 : Code[20];
    BEGIN
      OServiceClusterSeq.RESET;
      CASE IServiceOrder."Source Type" OF
        IServiceOrder."Source Type"::Contract:
          BEGIN
            ServiceContract.GET(IServiceOrder."Service Contract No.");
            IF ServiceContract."Use Contract Clusters" THEN BEGIN
              IF NOT OServiceClusterSeq.GET(OServiceClusterSeq.Type::Contract, IServiceOrder."Service Contract No.", OServiceClusterSeq."Source Type"::" ",
                IServiceOrder."Service Cluster", IServiceOrder."Service Cluster Seqn.")
              THEN
                EXIT(FALSE);
            END ELSE BEGIN
              IF NOT OServiceClusterSeq.GET(OServiceClusterSeq.Type::" ", '', OServiceClusterSeq."Source Type"::" ", IServiceOrder."Service Cluster",
                IServiceOrder."Service Cluster Seqn.")
              THEN
                EXIT(FALSE);
            END;
          END;
        IServiceOrder."Source Type"::Modification:
          BEGIN
            ObjectModificationNo := ObjectModificationMgt.GetModificationNoByServiceOrderNo(IServiceOrder."No.");
            ObjectModification.GET(ObjectModificationNo);
            IF ObjectModification."Use Modification Clusters" THEN BEGIN
              IF NOT OServiceClusterSeq.GET(OServiceClusterSeq.Type::Modification, ObjectModificationNo, OServiceClusterSeq."Source Type"::" ", IServiceOrder."Service Cluster", IServiceOrder."Service Cluster Seqn.") THEN
                EXIT(FALSE);
            END ELSE BEGIN
              IF NOT OServiceClusterSeq.GET(OServiceClusterSeq.Type::" ", '', OServiceClusterSeq."Source Type"::" ", IServiceOrder."Service Cluster", IServiceOrder."Service Cluster Seqn.") THEN
                EXIT(FALSE);
            END;
          END;
        IServiceOrder."Source Type"::Call,
        IServiceOrder."Source Type"::Direct:
          IF NOT OServiceClusterSeq.GET(OServiceClusterSeq.Type::"Source Type", '', IServiceOrder."Source Type", IServiceOrder."Service Cluster",
            IServiceOrder."Service Cluster Seqn.")
          THEN
            EXIT(FALSE);
      END;
      EXIT(TRUE);
    END;

    PROCEDURE DetermineResourceFilterByCluster@1100528618(VAR IServiceOrder@1100528600 : Record 11012823) OResourceFilter : Text;
    VAR
      ServiceOrder@1100528601 : Record 11012823;
      ServiceClusterSeq@1100528602 : Record 11071966;
      ServiceContract@1100528603 : Record 11012812;
      ObjectModification@1100528605 : Record 11071700;
      ServiceClusterEmployee@1100528607 : Record 11071967;
      ObjectModificationMgt@1100528606 : Codeunit 11012835;
      NoOfServiceOrders@1100528608 : Integer;
      ObjectModificationNo@1100528604 : Code[20];
    BEGIN
      ServiceOrder.COPY(IServiceOrder);
      NoOfServiceOrders := ServiceOrder.COUNT;
      IF ServiceOrder.FINDFIRST AND (NoOfServiceOrders > 1) THEN BEGIN
        ServiceOrder.SETRANGE("Service Contract No.", ServiceOrder."Service Contract No.");
        ServiceOrder.SETRANGE("Service Cluster", ServiceOrder."Service Cluster");
        ServiceOrder.SETRANGE("Service Cluster Seqn.", ServiceOrder."Service Cluster Seqn.");
        IF ServiceOrder.COUNT <> NoOfServiceOrders THEN
          ERROR(Text000, ServiceOrder.FIELDCAPTION("Service Contract No."), ServiceOrder.FIELDCAPTION("Service Cluster"), ServiceOrder.FIELDCAPTION("Service Cluster Seqn."));
      END;
      IF (ServiceOrder."Service Cluster" <> '') AND (ServiceOrder."Service Cluster Seqn." <> 0) THEN BEGIN
        CASE ServiceOrder."Source Type" OF
          ServiceOrder."Source Type"::Contract:
            BEGIN
              ServiceContract.GET(ServiceOrder."Service Contract No.");
              IF ServiceContract."Use Contract Clusters" THEN
                ServiceClusterSeq.GET(ServiceClusterSeq.Type::Contract, ServiceOrder."Service Contract No.", ServiceClusterSeq."Source Type"::" ", ServiceOrder."Service Cluster", ServiceOrder."Service Cluster Seqn.")
              ELSE
                ServiceClusterSeq.GET(ServiceClusterSeq.Type::" ", '', ServiceClusterSeq."Source Type"::" ", ServiceOrder."Service Cluster", ServiceOrder."Service Cluster Seqn.");
            END;
          ServiceOrder."Source Type"::Modification:
            BEGIN
              ObjectModificationNo := ObjectModificationMgt.GetModificationNoByServiceOrderNo(ServiceOrder."No.");
              ObjectModification.GET(ObjectModificationNo);
              IF ObjectModification."Use Modification Clusters" THEN
                ServiceClusterSeq.GET(ServiceClusterSeq.Type::Modification, ObjectModificationNo, ServiceClusterSeq."Source Type"::" ", ServiceOrder."Service Cluster", ServiceOrder."Service Cluster Seqn.")
              ELSE
                ServiceClusterSeq.GET(ServiceClusterSeq.Type::" ", '', ServiceClusterSeq."Source Type"::" ", ServiceOrder."Service Cluster", ServiceOrder."Service Cluster Seqn.")
            END;
          ServiceOrder."Source Type"::Call,
          ServiceOrder."Source Type"::Direct:
            ServiceClusterSeq.GET(ServiceClusterSeq.Type::"Source Type", '', ServiceOrder."Source Type", ServiceOrder."Service Cluster", ServiceOrder."Service Cluster Seqn.");
        END;
        ServiceClusterEmployee.SETRANGE(Type, ServiceClusterSeq.Type);
        ServiceClusterEmployee.SETRANGE("Type Code", ServiceClusterSeq."Type Code");
        ServiceClusterEmployee.SETRANGE("Source Type", ServiceClusterSeq."Source Type");
        ServiceClusterEmployee.SETRANGE("Cluster Code", ServiceClusterSeq."Cluster Code");
        ServiceClusterEmployee.SETRANGE("Seq. No.", ServiceClusterSeq."Seq. No.");
        IF ServiceClusterEmployee.FINDSET THEN
          REPEAT
            IF OResourceFilter <> '' THEN
              OResourceFilter += '|';
            OResourceFilter += ServiceClusterEmployee."Resource No.";
          UNTIL ServiceClusterEmployee.NEXT = 0;
      END;
    END;

    PROCEDURE DetermineStartEndPeriod@1100528616(IServiceOrder@1100528602 : Record 11012823;VAR OStartingDatePeriod@1100528600 : Date;VAR OEndingDatePeriod@1100528601 : Date);
    VAR
      ServiceClusterSeq@1100528603 : Record 11071966;
    BEGIN
      GetClusterSeqFromServiceOrder(IServiceOrder, ServiceClusterSeq);
      IF FORMAT(ServiceClusterSeq."Plan Bandwidth") <> '' THEN BEGIN
        OStartingDatePeriod := TODAY;
        OEndingDatePeriod := CALCDATE(ServiceClusterSeq."Plan Bandwidth", OStartingDatePeriod);
        IF ServiceClusterSeq."Execution Period Ending Date" <> 0D THEN BEGIN
          IF OEndingDatePeriod > ServiceClusterSeq."Execution Period Ending Date" THEN
            OEndingDatePeriod := ServiceClusterSeq."Execution Period Ending Date";
          IF OStartingDatePeriod > OEndingDatePeriod THEN
            OStartingDatePeriod := OEndingDatePeriod;
        END;
      END ELSE BEGIN
        ServiceClusterSeq.TESTFIELD("Execution Period Start Date");
        ServiceClusterSeq.TESTFIELD("Execution Period Ending Date");
        OStartingDatePeriod := ServiceClusterSeq."Execution Period Start Date";
        OEndingDatePeriod := ServiceClusterSeq."Execution Period Ending Date";
      END;
    END;

    BEGIN
    END.
  }
}

