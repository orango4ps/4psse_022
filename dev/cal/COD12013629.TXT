OBJECT Codeunit 12013629 ExFlow Web Service Request Mgt
{
  OBJECT-PROPERTIES
  {
    Date=;
    Time=;
    Version List=EXF513000,4PS;
  }
  PROPERTIES
  {
    OnRun=BEGIN
            IF GUIALLOWED THEN
              TEST;
          END;

  }
  CODE
  {
    VAR
      WebCompID@1100285000 : Record 12013630;
      DecFormat@1100285004 : TextConst 'ENU=<Sign><Integer><Decimals><Comma,.>';
      EXF002@1100285002 : TextConst 'ENU=Web service must connect using the company from the record!;SVE=Web tj„nsten m†ste ansluta med samma f”retag som posten tillh”r!';
      EXF003@1000 : TextConst 'ENU=Error downloading attchment;SVE=Fel vid nedladdning av billaga';
      ExFlowWebServMgt@1100285001 : Codeunit 12013636;

    LOCAL PROCEDURE TEST@1100285001();
    BEGIN
    END;

    PROCEDURE GetUsers@1100285010(VAR UserData@1100285003 : BigText);
    VAR
      ExUserComp@1100285000 : Record 12013641;
      ExUser@1100285020 : Record 12013640;
      ExUserGroup@1100285021 : Record 12013606;
      ExUserGroupLine@1100285022 : Record 12013607;
      TempExUserGroupLine@1100285002 : TEMPORARY Record 12013607;
      EXUserLevelPermission@1100285027 : Record 12013644;
      xmlDoc@1100285001 : DotNet "'System.Xml, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlDocument";
      Writer@1100285029 : DotNet "'System.Xml, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlTextWriter";
      StrWriter@1100285030 : DotNet "'mscorlib, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.IO.StringWriter";
    BEGIN
      StrWriter := StrWriter.StringWriter;
      Writer := Writer.XmlTextWriter(StrWriter);
      Writer.WriteStartElement('User');
      Writer.WriteAttributeString('xmlns','http://tempuri.org/User.xsd');

      WebCompID.RESET;
      WebCompID.SETRANGE("Web enabled", TRUE);
      IF WebCompID.FINDSET THEN BEGIN
        EXUserLevelPermission.RESET;
        IF EXUserLevelPermission.FINDSET THEN
          REPEAT
            Writer.WriteStartElement('UserLevelPermission');
            Writer.WriteElementString('UserLevel', FORMAT(EXUserLevelPermission."User Level",0,2));
            Writer.WriteElementString('Permission', FORMAT(EXUserLevelPermission.Permission));
            Writer.WriteEndElement;
          UNTIL EXUserLevelPermission.NEXT = 0;

        ExUser.RESET;
        IF ExUser.FINDSET THEN
          REPEAT
            Writer.WriteStartElement('User');
            Writer.WriteElementString('UserID', FORMAT(ExUser."User ID"));
            IF ExUser."User Name" = '' THEN
              Writer.WriteElementString('Name', ExUser."User ID")
            ELSE
              Writer.WriteElementString('Name', ExUser."User Name");
            Writer.WriteEndElement;
          UNTIL ExUser.NEXT = 0;

        REPEAT
          ExUserComp.RESET;
          ExUserComp.CHANGECOMPANY(WebCompID."Company Name");
          IF ExUserComp.FINDSET THEN
            REPEAT
              Writer.WriteStartElement('UserDetails');
              Writer.WriteElementString('UserID', FORMAT(ExUserComp."User ID"));
              Writer.WriteElementString('UserLevel', FORMAT(ExUserComp."User Level",0,'<Number>'));
              Writer.WriteElementString('CodingRuleID', FORMAT(ExUserComp."Coding Rule ID"+WebCompID."Web Company ID"));
              IF ExUserComp.Blocked THEN
                Writer.WriteElementString('Name', ExUserComp."User Name" + '(BLOCKED)')
              ELSE
                Writer.WriteElementString('Name', ExUserComp."User Name");
              Writer.WriteElementString('Email', ExUserComp."E-mail ExFlow");
              Writer.WriteElementString('Company', WebCompID."Company Name");
              Writer.WriteElementString('Dimension1', ReplaceDim1Filter(ExUserComp,WebCompID));
              Writer.WriteEndElement;
            UNTIL ExUserComp.NEXT = 0;

          TempExUserGroupLine.RESET;
          TempExUserGroupLine.DELETEALL;

          ExUserGroup.RESET;
          ExUserGroup.CHANGECOMPANY(WebCompID."Company Name");
          IF ExUserGroup.FINDSET THEN BEGIN
            REPEAT
              Writer.WriteStartElement('ApprovalStructure');
              Writer.WriteElementString('CompName', WebCompID."Company Name");
              Writer.WriteElementString('Code', FORMAT(ExUserGroup.Code));
              Writer.WriteElementString('Name', ExUserGroup.Name);
              IF ExUserGroup."Exclude from web list" THEN
                Writer.WriteElementString('Exclude', FORMAT('1'))
              ELSE
                Writer.WriteElementString('Exclude', FORMAT('0'));
              Writer.WriteElementString('ID', WebCompID."Company Name" + ';' + ExUserGroup.Code + ';');
              Writer.WriteEndElement;

              ExUserGroupLine.RESET;
              ExUserGroupLine.CHANGECOMPANY(WebCompID."Company Name");
              ExUserGroupLine.SETRANGE(Code, ExUserGroup.Code);
              IF ExUserGroupLine.FINDSET THEN
                REPEAT
                  TempExUserGroupLine.INIT;
                  TempExUserGroupLine.TRANSFERFIELDS(ExUserGroupLine);
                  TempExUserGroupLine.INSERT;
                UNTIL ExUserGroupLine.NEXT = 0;
            UNTIL ExUserGroup.NEXT = 0;

            TempExUserGroupLine.RESET;
            IF TempExUserGroupLine.FINDSET THEN
              REPEAT
                Writer.WriteStartElement('ApprovalStructureLine');
                Writer.WriteElementString('CompName', WebCompID."Company Name");
                Writer.WriteElementString('Code', FORMAT(TempExUserGroupLine.Code));
                Writer.WriteElementString('LineNo_', FORMAT(TempExUserGroupLine."Line No."));
                Writer.WriteElementString('UserID', FORMAT(TempExUserGroupLine."User ID"));
                IF TempExUserGroupLine."Starting Date" <> 0D THEN
                  Writer.WriteElementString('StartDate', FORMAT(TempExUserGroupLine."Starting Date",0,9));
                IF TempExUserGroupLine."Ending Date" <> 0D THEN
                  Writer.WriteElementString('EndDate', FORMAT(TempExUserGroupLine."Ending Date",0,9));
                Writer.WriteElementString('AppStructureID', WebCompID."Company Name" + ';' + FORMAT(TempExUserGroupLine.Code) + ';');
                Writer.WriteElementString('ID',
                       WebCompID."Company Name" + ';' + FORMAT(TempExUserGroupLine.Code) + ';' + FORMAT(TempExUserGroupLine."Line No.") + ';');
                Writer.WriteEndElement;
              UNTIL TempExUserGroupLine.NEXT = 0;
          END;
        UNTIL WebCompID.NEXT = 0;
      END;

      Writer.WriteEndElement; //EXF_Message

      IF TestMode(WebCompID) THEN BEGIN
        xmlDoc := xmlDoc.XmlDocument();
        xmlDoc.LoadXml(StrWriter.ToString);
        xmlDoc.Save('c:\temp\getusers.xml');
      END;

      UserData.ADDTEXT(StrWriter.ToString);
      ExFlowWebServMgt.CleanUpXmlBigText(UserData);
    END;

    PROCEDURE GetLineTypes@1100285009(VAR LineTypeData@1100285019 : BigText);
    VAR
      ExLineType@1100285018 : Record 12013642;
      RecordRef@1100285016 : RecordRef;
      xmlDoc@1100285014 : DotNet "'System.Xml, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlDocument";
      Writer@1100285025 : DotNet "'System.Xml, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlTextWriter";
      StrWriter@1100285024 : DotNet "'mscorlib, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.IO.StringWriter";
    BEGIN
      StrWriter := StrWriter.StringWriter;
      Writer := Writer.XmlTextWriter(StrWriter);
      Writer.WriteStartElement('_LineType');
      Writer.WriteAttributeString('xmlns','http://tempuri.org/LineType.xsd');

      ExLineType.RESET;
      IF ExLineType.FINDSET THEN
        REPEAT
          Writer.WriteStartElement('LineType');
          RecordRef.GETTABLE(ExLineType);
          Writer.WriteElementString('ID', FORMAT(ExLineType.Code));
          Writer.WriteElementString('LineType', FORMAT(ExLineType."Line Type"));
          Writer.WriteElementString('Value', FORMAT(ExLineType.Value));
          Writer.WriteElementString('DocumentDisplayExpr', FORMAT(ExLineType."Document Display Expr"));
          Writer.WriteElementString('LineDisplayExpr', FORMAT(ExLineType."Line Display Expr"));
          Writer.WriteElementString('UserDisplayExpr', FORMAT(ExLineType."User Display Expr"));
          Writer.WriteEndElement;
        UNTIL ExLineType.NEXT = 0;

      Writer.WriteEndElement; //EXF_Message

      IF TestMode(WebCompID) THEN BEGIN
        xmlDoc := xmlDoc.XmlDocument();
        xmlDoc.LoadXml(StrWriter.ToString);
        xmlDoc.Save('c:\temp\linetype.xml');
      END;

      LineTypeData.ADDTEXT(StrWriter.ToString);
      ExFlowWebServMgt.CleanUpXmlBigText(LineTypeData);
    END;

    PROCEDURE GetColumns@1100285011(VAR ColumnsData@1100285000 : BigText);
    VAR
      ExColumn@1100285019 : Record 12013661;
      ExCodingRule@1100285026 : Record 12013660;
      ExCodingRuleLine@1100285001 : Record 12013663;
      xmlDoc@1100285015 : DotNet "'System.Xml, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlDocument";
      Writer@1100285025 : DotNet "'System.Xml, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlTextWriter";
      StrWriter@1100285024 : DotNet "'mscorlib, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.IO.StringWriter";
      ExCodingRuleExpLine@1100285002 : Record 12057162;
    BEGIN
      StrWriter := StrWriter.StringWriter;
      Writer := Writer.XmlTextWriter(StrWriter);
      Writer.WriteStartElement('LineColumn');
      Writer.WriteAttributeString('xmlns','http://tempuri.org/LineColumn.xsd');

      WebCompID.RESET;
      WebCompID.SETRANGE("Web enabled", TRUE);
      IF WebCompID.FINDSET THEN
        REPEAT
          ExColumn.RESET;
          ExColumn.CHANGECOMPANY(WebCompID."Company Name");
          IF ExColumn.FINDSET THEN
            REPEAT
              Writer.WriteStartElement('Column');
              Writer.WriteElementString('ID', FORMAT(ExColumn.ID+WebCompID."Web Company ID"));
              Writer.WriteElementString('Company', WebCompID."Company Name");
              Writer.WriteElementString('Code', FORMAT(ExColumn.Code));
              Writer.WriteElementString('Source', FORMAT(ExColumn.Source));
              Writer.WriteElementString('Format', FORMAT(ExColumn.Format));
              Writer.WriteElementString('UseAutoCompletion', FORMAT(ExColumn."Use Auto Completion",0,'<Number>'));
              Writer.WriteElementString('IsFreeText', FORMAT(ExColumn."Is Free Text",0,'<Number>'));
              Writer.WriteElementString('SortOrder', FORMAT(ExColumn."Sort Order"));
              Writer.WriteElementString('DocumentDisplayExpr', FORMAT(ExColumn."Document Display Expr"));
              Writer.WriteElementString('LineDisplayExpr', FORMAT(ExColumn."Line Display Expr"));
              Writer.WriteElementString('DataType', FORMAT(ExColumn."Data Type"));
              IF ExColumn."Is Autofill Trigger" > 0 THEN
                Writer.WriteElementString('IsAutofillTrigger','1');
              IF ExColumn."Copy Dimenson On Split" THEN
                Writer.WriteElementString('CopyDimTestExpression','TRUE')
              ELSE
                Writer.WriteElementString('CopyDimTestExpression','FALSE');
              Writer.WriteElementString('PartialFetchCount', FORMAT(ExColumn."No of Values to Send"));
              Writer.WriteEndElement;
            UNTIL ExColumn.NEXT = 0;

          ExCodingRule.RESET;
          ExCodingRule.CHANGECOMPANY(WebCompID."Company Name");
          ExCodingRule.SETRANGE(IsAutofill, FALSE);
          ExCodingRule.SETRANGE(Active, TRUE);
          IF ExCodingRule.FINDSET THEN
            REPEAT
              Writer.WriteStartElement('CodingRule');
              Writer.WriteElementString('ID', FORMAT(ExCodingRule.ID+WebCompID."Web Company ID"));
              Writer.WriteElementString('CompName', WebCompID."Company Name");
              Writer.WriteElementString('Name', FORMAT(ExCodingRule.Name));
              Writer.WriteElementString('ValidationMessage', FORMAT(ExCodingRule."Validation Message"));
              Writer.WriteElementString('MemoryNote', FORMAT(ExCodingRule."Memory Note"));
              Writer.WriteElementString('Active', FORMAT(ExCodingRule.Active,0,'<Number>'));
              Writer.WriteElementString('IsValidation', FORMAT(ExCodingRule."Is Validation",0,'<Number>'));
              Writer.WriteElementString('IsFilter', FORMAT(ExCodingRule."Is Filter",0,'<Number>'));
              Writer.WriteElementString('IsSubset', FORMAT(ExCodingRule."Is Subset",0,'<Number>'));
              Writer.WriteElementString('IsDeny', FORMAT(ExCodingRule.IsDeny,0,'<Number>'));

              ExCodingRuleLine.CHANGECOMPANY(WebCompID."Company Name");
              ExCodingRuleLine.SETRANGE(ID, ExCodingRule.ID);
              IF ExCodingRuleLine.FINDFIRST THEN BEGIN
                //4PS20200221
                IF ExCodingRuleExpLine.HasLines(ExCodingRule.ID) THEN
                  Writer.WriteElementString('Expression', FORMAT(ExCodingRuleExpLine.GetExpression(ExCodingRule.ID,WebCompID."Web Company ID",WebCompID."Company Name")))
                ELSE BEGIN
                //4PS20200221
                  ExCodingRuleLine.CalculateExpression(WebCompID."Web Company ID",ExCodingRule,WebCompID."Company Name");
                  Writer.WriteElementString('Expression', FORMAT(ExCodingRule.Expression+ExCodingRule.Expression2+
                                                                      ExCodingRule.Expression3+ExCodingRule.Expression4));
                //4PS20200221
                END;
                //4PS20200221
              END
              ELSE
                Writer.WriteElementString('Expression','');

              Writer.WriteElementString('TestExpression1', FORMAT(ExCodingRule.TestExpression1));
              Writer.WriteElementString('TestExpression2', FORMAT(ExCodingRule.TestExpression2));
              Writer.WriteElementString('TestExpression3', FORMAT(ExCodingRule.TestExpression3));
              Writer.WriteElementString('TestExpression4', FORMAT(ExCodingRule.TestExpression4));
              Writer.WriteElementString('TestExpression5', FORMAT(ExCodingRule.TestExpression5));
              Writer.WriteEndElement;
            UNTIL ExCodingRule.NEXT = 0;
        UNTIL WebCompID.NEXT = 0;

      Writer.WriteEndElement; //EXF_Message

      IF TestMode(WebCompID) THEN BEGIN
        xmlDoc := xmlDoc.XmlDocument();
        xmlDoc.LoadXml(StrWriter.ToString);
        xmlDoc.Save('c:\temp\linecolumn.xml');
      END;

      ColumnsData.ADDTEXT(StrWriter.ToString);
      ExFlowWebServMgt.CleanUpXmlBigText(ColumnsData);
    END;

    PROCEDURE GetDocument@1100285013(VAR DocumentData@1100285000 : BigText;ID@1100285023 : BigInteger;CompName@1100285021 : Text[30]);
    VAR
      ExDocument@1100285019 : Record 12013608;
      ExDocumentLine@1100285018 : Record 12013609;
      ExDocumentLineApprover@1100285017 : Record 12013610;
      ExDocumentLineDimension@1100285032 : Record 12013611;
      PostedExDocument@1100285005 : Record 12013626;
      PostedExDocumentLine@1100285004 : Record 12013627;
      PostedExDocumentLineApprover@1100285003 : Record 12013628;
      PostedExDocumentLineDimension@1100285002 : Record 12013629;
      ExFlowSetup@1100285016 : Record 12013601;
      VendLedgEntry@1100285006 : Record 25;
      VendLedgEntry2@1100285007 : Record 25;
      ExColumn@1100285008 : Record 12013661;
      xmlDoc@1100285015 : DotNet "'System.Xml, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlDocument";
      TempID@1100285011 : BigInteger;
      Writer@1100285020 : DotNet "'System.Xml, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlTextWriter";
      StrWriter@1100285014 : DotNet "'mscorlib, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.IO.StringWriter";
      ApproverComment@1100285030 : BigText;
      IStream@1100285031 : InStream;
      TempDesc@1100285022 : Text[1024];
      TempChangeDate@1100285001 : DateTime;
    BEGIN
      StrWriter := StrWriter.StringWriter;
      Writer := Writer.XmlTextWriter(StrWriter);
      Writer.WriteStartElement('Document');
      Writer.WriteAttributeString('xmlns','http://tempuri.org/Document.xsd');

      IF CompName <> COMPANYNAME THEN
        ERROR(EXF002);

      // EX Document
      ExDocument.RESET;
      ExDocument.SETCURRENTKEY("Web ID");
      ExDocument.SETRANGE("Web ID", ID);

      GetWebComp(CompName);

      IF ExDocument.FINDFIRST THEN BEGIN
        ExFlowSetup.GET;

        WITH ExDocument DO BEGIN
          CLEAR(ApproverComment);
          CALCFIELDS("Approver Comments");
          "Approver Comments".CREATEINSTREAM(IStream);
          ApproverComment.READ(IStream);

          Writer.WriteStartElement('Document');
          Writer.WriteElementString('CompName', FORMAT(CompName));
          Writer.WriteElementString('DocType',FORMAT("Document Type",0,'<Number>'));
          Writer.WriteElementString('DocNo', FORMAT("Document No."));
          Writer.WriteElementString('Initiator', FORMAT(Initiator));
          Writer.WriteElementString('VendorNo', FORMAT("Vendor No."));
      // Temp. Solution ->
      //uncomment    Writer.WriteElementString('AdminComment',"Admin Comment");
      //delete ->
          IF "Admin Comment" <> '' THEN
            Writer.WriteElementString('AdminComment',STRSUBSTNO('%1 \ %2',"Admin Comment",ApproverComment))
          ELSE
            Writer.WriteElementString('AdminComment',STRSUBSTNO('%1',ApproverComment));
      //delete <-
      //Temp. Solution <-
          IF "Create Date" <> 0D THEN
            Writer.WriteElementString('CreateDate',FORMAT("Create Date",0,9));
          IF "Due Date" <> 0D THEN
            Writer.WriteElementString('DueDate',FORMAT("Due Date",0,9));
          IF "Posting Date" <> 0D THEN
            Writer.WriteElementString('PostingDate',FORMAT("Posting Date",0,9));
          IF "Expected Receipt Date" <> 0D THEN
            Writer.WriteElementString('ExpectedReceiptDate',FORMAT("Expected Receipt Date",0,9));
          IF "Document Date" <> 0D THEN
            Writer.WriteElementString('DocDate',FORMAT("Document Date",0,9));
          Writer.WriteElementString('Status',FORMAT(Status,0,'<Number>'));
          Writer.WriteElementString('ImageName',ExFlowSetup."Path to Used Invoices" + "Image Name");
          Writer.WriteElementString('PostingNo',FORMAT("Predefind Posting No."));
          Writer.WriteElementString('VendorDocNo',FORMAT("Vendor Document No."));
          Writer.WriteElementString('CurrencyCode',FORMAT("Currency Code"));
          Writer.WriteElementString('ID',FORMAT("Web ID"));
          Writer.WriteElementString('VendorName',"Vendor Name");
          Writer.WriteElementString('Amount',FORMAT("Gross Amount",0,DecFormat));
          Writer.WriteElementString('NetAmount',FORMAT("Net Amount",0,DecFormat));
          Writer.WriteElementString('VATAmount',FORMAT("VAT Amount",0,DecFormat));
          Writer.WriteElementString('TextField1',"Text Field 1");
          Writer.WriteElementString('TextField2',"Text Field 2");
          Writer.WriteElementString('TextField3',"Text Field 3");
          Writer.WriteElementString('TextField4',"Text Field 4");
          Writer.WriteElementString('TextField5',"Text Field 5");
          Writer.WriteElementString('TextField6',"Text Field 6");
          Writer.WriteElementString('TextField7',"Text Field 7");
          Writer.WriteElementString('TextField8',"Text Field 8");
          Writer.WriteElementString('TextField9',"Text Field 9");
          Writer.WriteElementString('TextField10',"Text Field 10");
          IF "Date Field 1" <> 0D THEN
            Writer.WriteElementString('DateField1',FORMAT("Date Field 1",0,9));
          IF "Date Field 2" <> 0D THEN
            Writer.WriteElementString('DateField2',FORMAT("Date Field 2",0,9));
          IF "Date Field 3" <> 0DT THEN
            Writer.WriteElementString('DateField3',FORMAT("Date Field 3",0,9));
          IF "Date Field 4" <> 0DT THEN
            Writer.WriteElementString('DateField4',FORMAT("Date Field 4",0,9));
          Writer.WriteElementString('DecimalField1',FORMAT("Decimal Field 1",0,DecFormat));
          Writer.WriteElementString('DecimalField2',FORMAT("Decimal Field 2",0,DecFormat));
          Writer.WriteElementString('DecimalField3',FORMAT("Decimal Field 3",0,DecFormat));
          Writer.WriteElementString('DecimalField4',FORMAT("Decimal Field 4",0,DecFormat));
          Writer.WriteElementString('AssignedReceiptGroup',FORMAT("Assigned Receipt Group"));
          Writer.WriteElementString('RequisitionStatus',FORMAT("Requisition Status",0,'<Number>'));
          Writer.WriteElementString('DocSubType',FORMAT("Requisition Subtype"));

          Writer.WriteElementString('ChangedBy',FORMAT("Changed By"));

          IF "Change Date" <> 0DT THEN
            Writer.WriteElementString('ChangeDate',FORMAT("Change Date",0,9));
      // Temp. Solution ->
      //uncomment    Writer.WriteElementString('ApproverComments',ApproverComment);
          Writer.WriteElementString('ApproverComments',''); //delete
      // Temp. Solution ->
          Writer.WriteElementString('Attachments',GetAttchmentStr(ID));
          Writer.WriteEndElement;
        END;

        // EX Document Line
        WITH ExDocumentLine DO BEGIN
          RESET;
          SETCURRENTKEY("Document ID");
          SETRANGE("Document ID", ExDocument.ID);
          IF FINDSET THEN
            REPEAT
              Writer.WriteStartElement('DocumentLines');
              Writer.WriteElementString('CompName',CompName);
              Writer.WriteElementString('DocType',FORMAT("Document Type",0,'<Number>'));
              Writer.WriteElementString('DocNo',FORMAT("Document No."));
              Writer.WriteElementString('LineNo_',FORMAT("Line No."));
              Writer.WriteElementString('Flowstatus',FORMAT(Flowstatus,0,'<Number>'));
              Writer.WriteElementString('LineType',FORMAT("Line Type",0,'<Number>'));
              Writer.WriteElementString('No_',FORMAT("No."));
              Writer.WriteElementString('Description',Description);
              Writer.WriteElementString('Quantity',FORMAT(ROUND(Quantity,0.00001),0,DecFormat));
              Writer.WriteElementString('UnitCost',FORMAT(ROUND("Direct Unit Cost",0.00001),0,DecFormat));
              Writer.WriteElementString('LineDiscount',FORMAT(ROUND("Line Discount %",0.00001),0,DecFormat));
              Writer.WriteElementString('LineDifference',FORMAT("Line Difference",0,'<Number>'));
              Writer.WriteElementString('Amount',FORMAT(ROUND(Amount,0.00001),0,DecFormat));
              Writer.WriteElementString('DocumentID',FORMAT(ExDocument."Web ID"));
              IF "Connected Line ID" > 0 THEN
                Writer.WriteElementString('ConnectedLineID',FORMAT("Connected Line ID"+ExDocument."Web Company ID"));
              Writer.WriteElementString('ID',FORMAT(ID+ExDocument."Web Company ID"));
              Writer.WriteElementString('OrderNo',FORMAT("Order No."));
              Writer.WriteElementString('OrderUnitCost',FORMAT(ROUND("Order Unit Cost",0.00001),0,DecFormat));
              Writer.WriteElementString('ChangedBy',FORMAT("Changed By"));

              CALCFIELDS("Last Change Date Dimension");
              TempChangeDate := "Change Date";

              IF "Last Change Date Dimension" > TempChangeDate THEN
                TempChangeDate := "Last Change Date Dimension";
              IF TempChangeDate <> 0DT THEN
                Writer.WriteElementString('ChangeDate',FORMAT(TempChangeDate,0,9))
              ELSE
                Writer.WriteElementString('ChangeDate','');

              Writer.WriteEndElement;
            UNTIL NEXT = 0;
        END;

        // EX Document Line Approver
        WITH ExDocumentLineApprover DO BEGIN
          RESET;
          SETCURRENTKEY("Document ID");
          SETRANGE("Document ID", ExDocument.ID);
          IF FINDSET THEN
            REPEAT
              Writer.WriteStartElement('DocumentLineApprovers');
              Writer.WriteElementString('CompName',FORMAT(CompName));
              Writer.WriteElementString('DocType',FORMAT("Document Type",0,'<Number>'));
              Writer.WriteElementString('DocNo',FORMAT("Document No."));
              Writer.WriteElementString('LineNo_',FORMAT("Line No."));
              Writer.WriteElementString('Approver',FORMAT(Approver));
              IF "Approval Date" <> 0DT THEN
                Writer.WriteElementString('ApprovalDate',FORMAT("Approval Date",0,9));
              Writer.WriteElementString('ApprovedBy',FORMAT("Approved By"));
              Writer.WriteElementString('Comment',Comment);
              Writer.WriteElementString('AppOrder',FORMAT("Approver Order"));
              Writer.WriteElementString('Flowstatus',FORMAT(Flowstatus,0,'<Number>'));
              Writer.WriteElementString('DocumentLineID',FORMAT("Document Line ID"+ExDocument."Web Company ID"));
              Writer.WriteElementString('DocumentID',FORMAT(ExDocument."Web ID"));
              Writer.WriteElementString('ChangedBy',FORMAT("Changed By"));
              Writer.WriteElementString('DelegateTo',FORMAT("Delegated to"));
              IF "Change Date" <> 0DT THEN
                Writer.WriteElementString('ChangeDate',FORMAT("Change Date",0,9));
              Writer.WriteElementString('ID',FORMAT(ID+ExDocument."Web Company ID"));
              Writer.WriteEndElement;
            UNTIL NEXT = 0;
        END;

        // EX Document Line Dimension
        WITH ExDocumentLineDimension DO BEGIN
          TempID := 0;
          RESET;
          SETCURRENTKEY("Document ID");
          SETRANGE("Document ID", ExDocument.ID);
          IF FINDSET THEN
            REPEAT
              Writer.WriteStartElement('DocumentLineDimensions');
              Writer.WriteElementString('CompName',FORMAT(CompName));
              Writer.WriteElementString('DocType',FORMAT("Document Type",0,'<Number>'));
              Writer.WriteElementString('DocNo',FORMAT("Document No."));
              Writer.WriteElementString('LineNo_',FORMAT("Line No."));
              Writer.WriteElementString('DimensionCode',FORMAT("Dimension Code"));
              Writer.WriteElementString('DimensionValue',FORMAT("Dimension Value"));

              TempDesc := GetDimValDesc(CompName,"Column ID","Dimension Value","Document Line ID");
              IF (TempDesc = '') AND ("Dimension Value" = '') THEN BEGIN
                Writer.WriteElementString('DimensionValue',"Dimension Desc.");
                Writer.WriteElementString('_Description','');
              END ELSE BEGIN
                Writer.WriteElementString('DimensionValue',FORMAT("Dimension Value"));
                Writer.WriteElementString('_Description',TempDesc);
              END;

              Writer.WriteElementString('DocumentLineID',FORMAT("Document Line ID"+ExDocument."Web Company ID"));
              Writer.WriteElementString('DocumentID',FORMAT(ExDocument."Web ID"));
              Writer.WriteElementString('ColumnID',FORMAT("Column ID"+WebCompID."Web Company ID"));
              Writer.WriteElementString('ChangedBy',FORMAT("Changed By"));
              IF "Change Date" <> 0DT THEN
                Writer.WriteElementString('ChangeDate',FORMAT("Change Date",0,9));
              Writer.WriteElementString('ID',FORMAT(ID+ExDocument."Web Company ID"));
              Writer.WriteEndElement;
              IF ID > TempID THEN
                TempID := ID;
            UNTIL NEXT = 0;

          ExColumn.SETRANGE(Code, 'DESCRIPTION'); // special handling of description
          IF ExColumn.FINDFIRST THEN BEGIN
            ExDocumentLine.RESET;
            ExDocumentLine.SETCURRENTKEY("Document ID");
            ExDocumentLine.SETRANGE("Document ID", ExDocument.ID);
            ExDocumentLine.SETFILTER(Description, '<>%1', '');

            IF ExDocumentLine.FINDSET THEN
              REPEAT
                TempID := TempID + 1;
                Writer.WriteStartElement('DocumentLineDimensions');
                Writer.WriteElementString('CompName',FORMAT(CompName));
                Writer.WriteElementString('DocType',FORMAT(ExDocumentLine."Document Type",0,'<Number>'));
                Writer.WriteElementString('DocNo',FORMAT(ExDocumentLine."Document No."));
                Writer.WriteElementString('LineNo_',FORMAT(ExDocumentLine."Line No."));
                Writer.WriteElementString('DimensionCode','DESCRIPTION');
                Writer.WriteElementString('DimensionValue',FORMAT(ExDocumentLine.Description));
                Writer.WriteElementString('_Description','');
                Writer.WriteElementString('DocumentLineID',FORMAT(ExDocumentLine.ID+ExDocument."Web Company ID"));
                Writer.WriteElementString('DocumentID',FORMAT(ExDocument."Web ID"));
                Writer.WriteElementString('ColumnID',FORMAT(ExColumn.ID+WebCompID."Web Company ID"));
                Writer.WriteElementString('ChangedBy',FORMAT("Changed By"));
                IF "Change Date" <> 0DT THEN
                  Writer.WriteElementString('ChangeDate',FORMAT("Change Date",0,9));
                Writer.WriteElementString('ID',FORMAT(TempID+ExDocument."Web Company ID"));
                Writer.WriteEndElement;
              UNTIL ExDocumentLine.NEXT = 0;
          END;
        END;
      END ELSE BEGIN
        // Posted docs
        PostedExDocument.RESET;
        PostedExDocument.SETCURRENTKEY("Web ID");
        PostedExDocument.SETRANGE("Web ID", ID);
        IF PostedExDocument.FINDFIRST THEN BEGIN
          ExFlowSetup.GET;

          WITH PostedExDocument DO BEGIN
            CLEAR(ApproverComment);
            CALCFIELDS("Approver Comments");
            "Approver Comments".CREATEINSTREAM(IStream);
            ApproverComment.READ(IStream);

            Writer.WriteStartElement('Document');
            Writer.WriteElementString('CompName', FORMAT(CompName));
            Writer.WriteElementString('DocType',FORMAT("Document Type",0,'<Number>'));
            Writer.WriteElementString('DocNo', FORMAT("Document No."));
            Writer.WriteElementString('Initiator', FORMAT(Initiator));
            Writer.WriteElementString('VendorNo', FORMAT("Vendor No."));

      //Temp. Solution ->
      //uncomment      Writer.WriteElementString('AdminComment',"Admin Comment");
      //delete ->
            IF "Admin Comment" <> '' THEN
              Writer.WriteElementString('AdminComment',STRSUBSTNO('%1\%2',"Admin Comment",ApproverComment))
            ELSE
              Writer.WriteElementString('AdminComment',STRSUBSTNO('%1',ApproverComment));
      //delete <-
      //Temp. Solution <-

            IF "Create Date" <> 0D THEN
              Writer.WriteElementString('CreateDate',FORMAT("Create Date",0,9));
            IF "Due Date" <> 0D THEN
              Writer.WriteElementString('DueDate',FORMAT("Due Date",0,9));
            IF "Posting Date" <> 0D THEN
              Writer.WriteElementString('PostingDate',FORMAT("Posting Date",0,9));
            IF "Expected Receipt Date" <> 0D THEN
              Writer.WriteElementString('ExpectedReceiptDate',FORMAT("Expected Receipt Date",0,9));
            IF "Document Date" <> 0D THEN
              Writer.WriteElementString('DocDate',FORMAT("Document Date",0,9));
            Writer.WriteElementString('Status',FORMAT(Status,0,'<Number>'));
            Writer.WriteElementString('ImageName',ExFlowSetup."Path to Used Invoices" + "Image Name");
            Writer.WriteElementString('PostingNo',FORMAT("Predefind Posting No."));
            Writer.WriteElementString('VendorDocNo',FORMAT("Vendor Document No."));
            Writer.WriteElementString('CurrencyCode',FORMAT("Currency Code"));
            Writer.WriteElementString('ID',FORMAT("Web ID"));
            Writer.WriteElementString('VendorName',"Vendor Name");
            Writer.WriteElementString('Amount',FORMAT(ROUND("Gross Amount",0.00001),0,DecFormat));
            Writer.WriteElementString('NetAmount',FORMAT(ROUND("Net Amount",0.00001),0,DecFormat));
            Writer.WriteElementString('VATAmount',FORMAT(ROUND("VAT Amount",0.00001),0,DecFormat));
            Writer.WriteElementString('TextField1',"Text Field 1");
            Writer.WriteElementString('TextField2',"Text Field 2");
            Writer.WriteElementString('TextField3',"Text Field 3");

            CASE PostedExDocument."Document Type" OF
              PostedExDocument."Document Type"::"Posted Invoice": VendLedgEntry.SETRANGE("Document Type", VendLedgEntry."Document Type"::Invoice);
              PostedExDocument."Document Type"::"Posted Credit Memo": VendLedgEntry.SETRANGE("Document Type", VendLedgEntry."Document Type"::"Credit Memo");
            END;
            VendLedgEntry.SETRANGE("Document No.", "Document No.");
            IF VendLedgEntry.FINDFIRST THEN BEGIN
              VendLedgEntry.CALCFIELDS("Remaining Amount","Original Amount");
              Writer.WriteElementString('DecimalField4',FORMAT(ABS(VendLedgEntry."Original Amount"-VendLedgEntry."Remaining Amount"),0,DecFormat));

              IF VendLedgEntry."Closed by Entry No." <> 0 THEN BEGIN
                VendLedgEntry2.GET(VendLedgEntry."Closed by Entry No.");
                Writer.WriteElementString('DateField4',FORMAT(VendLedgEntry2."Posting Date",0,9));
              END ELSE BEGIN
                VendLedgEntry2.SETCURRENTKEY("Closed by Entry No.");
                VendLedgEntry2.SETRANGE("Closed by Entry No.",VendLedgEntry."Entry No.");
                IF VendLedgEntry2.FINDLAST THEN
                  Writer.WriteElementString('DateField4',FORMAT(VendLedgEntry2."Posting Date",0,9));
              END;
            END ELSE BEGIN
              IF "Date Field 4" <> 0DT THEN
                Writer.WriteElementString('DateField4',FORMAT("Date Field 4",0,9));

              Writer.WriteElementString('DecimalField4',FORMAT("Decimal Field 4",0,DecFormat));
            END;

            Writer.WriteElementString('TextField5',"Text Field 5");
            Writer.WriteElementString('TextField6',"Text Field 6");
            Writer.WriteElementString('TextField7',"Text Field 7");
            Writer.WriteElementString('TextField8',"Text Field 8");
            Writer.WriteElementString('TextField9',"Text Field 9");
            Writer.WriteElementString('TextField10',"Text Field 10");
            IF "Date Field 1" <> 0D THEN
              Writer.WriteElementString('DateField1',FORMAT("Date Field 1",0,9));
            IF "Date Field 2" <> 0D THEN
              Writer.WriteElementString('DateField2',FORMAT("Date Field 2",0,9));
            IF "Date Field 3" <> 0DT THEN
              Writer.WriteElementString('DateField3',FORMAT("Date Field 3",0,9));
            IF "Date Field 4" <> 0DT THEN
              Writer.WriteElementString('DateField4',FORMAT("Date Field 4",0,9));
            Writer.WriteElementString('DecimalField1',FORMAT(ROUND("Decimal Field 1",0.00001),0,DecFormat));
            Writer.WriteElementString('DecimalField2',FORMAT(ROUND("Decimal Field 2",0.00001),0,DecFormat));
            Writer.WriteElementString('DecimalField3',FORMAT(ROUND("Decimal Field 3",0.00001),0,DecFormat));
            Writer.WriteElementString('DecimalField4',FORMAT(ROUND("Decimal Field 4",0.00001),0,DecFormat));
            Writer.WriteElementString('AssignedReceiptGroup',FORMAT("Assigned Receipt Group"));
            Writer.WriteElementString('RequisitionStatus',FORMAT("Requisition Status",0,'<Number>'));

      // Temp. Solution ->
      //uncomment    Writer.WriteElementString('ApproverComments',ApproverComment);
          Writer.WriteElementString('ApproverComments',''); //delete
      // Temp. Solution ->
            Writer.WriteElementString('Attachments',GetAttchmentStr(ID));
            Writer.WriteEndElement;
          END;

          // Posted EX Document Line
          WITH PostedExDocumentLine DO BEGIN
            RESET;
            SETCURRENTKEY("Document ID");
            SETRANGE("Document ID", PostedExDocument.ID);
            IF FINDSET THEN
              REPEAT
                Writer.WriteStartElement('DocumentLines');
                Writer.WriteElementString('CompName',CompName);
                Writer.WriteElementString('DocType',FORMAT("Document Type",0,'<Number>'));
                Writer.WriteElementString('DocNo',FORMAT("Document No."));
                Writer.WriteElementString('LineNo_',FORMAT("Line No."));
                Writer.WriteElementString('Flowstatus',FORMAT(Flowstatus,0,'<Number>'));
                Writer.WriteElementString('LineType',FORMAT("Line Type",0,'<Number>'));
                Writer.WriteElementString('No_',FORMAT("No."));
                Writer.WriteElementString('Description',Description);
                Writer.WriteElementString('Quantity',FORMAT(Quantity,0,DecFormat));
                Writer.WriteElementString('UnitCost',FORMAT(ROUND("Direct Unit Cost"),0,DecFormat));
                Writer.WriteElementString('LineDiscount',FORMAT("Line Discount %",0,DecFormat));
                Writer.WriteElementString('LineDifference',FORMAT("Line Difference",0,'<Number>'));
                Writer.WriteElementString('Amount',FORMAT(ROUND(Amount),0,DecFormat));
                Writer.WriteElementString('DocumentID',FORMAT(PostedExDocument."Web ID"));
                IF "Connected Line ID" > 0 THEN
                  Writer.WriteElementString('ConnectedLineID',FORMAT("Connected Line ID"+PostedExDocument."Web Company ID"));
                Writer.WriteElementString('ID',FORMAT(ID+PostedExDocument."Web Company ID"));
                Writer.WriteElementString('OrderNo',FORMAT("Order No."));
                Writer.WriteElementString('OrderUnitCost',FORMAT("Order Unit Cost",0,DecFormat));
                Writer.WriteElementString('ChangedBy',FORMAT("Changed By"));

                CALCFIELDS("Last Change Date Approval","Last Change Date Dimension");
                TempChangeDate := "Change Date";
                IF "Last Change Date Approval" > TempChangeDate THEN
                  TempChangeDate := "Last Change Date Approval";
                IF "Last Change Date Dimension" > TempChangeDate THEN
                  TempChangeDate := "Last Change Date Dimension";
                IF TempChangeDate <> 0DT THEN
                  Writer.WriteElementString('ChangeDate',FORMAT(TempChangeDate,0,9))
                ELSE
                  Writer.WriteElementString('ChangeDate','');

                Writer.WriteEndElement;
              UNTIL NEXT = 0;
          END;

          // EX Document Line Approver
          WITH PostedExDocumentLineApprover DO BEGIN
            RESET;
            SETCURRENTKEY("Document ID");
            SETRANGE("Document ID", PostedExDocument.ID);
            IF FINDSET THEN
              REPEAT
                Writer.WriteStartElement('DocumentLineApprovers');
                Writer.WriteElementString('CompName',FORMAT(CompName));
                Writer.WriteElementString('DocType',FORMAT("Document Type",0,'<Number>'));
                Writer.WriteElementString('DocNo',FORMAT("Document No."));
                Writer.WriteElementString('LineNo_',FORMAT("Line No."));
                Writer.WriteElementString('Approver',FORMAT(Approver));
                IF "Approval Date" <> 0DT THEN
                  Writer.WriteElementString('ApprovalDate',FORMAT("Approval Date",0,9));
                Writer.WriteElementString('ApprovedBy',FORMAT("Approved By"));
                Writer.WriteElementString('Comment',Comment);
                Writer.WriteElementString('AppOrder',FORMAT("Approver Order"));
                Writer.WriteElementString('Flowstatus',FORMAT(Flowstatus,0,'<Number>'));
                Writer.WriteElementString('DocumentLineID',FORMAT("Document Line ID"+PostedExDocument."Web Company ID"));
                Writer.WriteElementString('DocumentID',FORMAT(PostedExDocument."Web ID"));
                Writer.WriteElementString('ChangedBy',FORMAT("Changed By"));
                IF "Change Date" <> 0DT THEN
                  Writer.WriteElementString('ChangeDate',FORMAT("Change Date",0,9));
                Writer.WriteElementString('ID',FORMAT(ID+PostedExDocument."Web Company ID"));
                Writer.WriteEndElement;
              UNTIL NEXT = 0;
          END;

          // EX Document Line Dimension
          WITH PostedExDocumentLineDimension DO BEGIN
            RESET;
            SETCURRENTKEY("Document ID");
            SETRANGE("Document ID", PostedExDocument.ID);
            IF FINDSET THEN
              REPEAT
                Writer.WriteStartElement('DocumentLineDimensions');
                Writer.WriteElementString('CompName',FORMAT(CompName));
                Writer.WriteElementString('DocType',FORMAT("Document Type",0,'<Number>'));
                Writer.WriteElementString('DocNo',FORMAT("Document No."));
                Writer.WriteElementString('LineNo_',FORMAT("Line No."));
                Writer.WriteElementString('DimensionCode',FORMAT("Dimension Code"));
                Writer.WriteElementString('DimensionValue',FORMAT("Dimension Value"));
                Writer.WriteElementString('_Description',GetDimValDesc(CompName,"Column ID","Dimension Value","Document Line ID"));
                Writer.WriteElementString('DocumentLineID',FORMAT("Document Line ID"+PostedExDocument."Web Company ID"));
                Writer.WriteElementString('DocumentID',FORMAT(PostedExDocument."Web ID"));
                Writer.WriteElementString('ColumnID',FORMAT("Column ID"+WebCompID."Web Company ID"));
                Writer.WriteElementString('ChangedBy',FORMAT("Changed By"));
                IF "Change Date" <> 0DT THEN
                  Writer.WriteElementString('ChangeDate',FORMAT("Change Date",0,9));
                Writer.WriteElementString('ID',FORMAT(ID+PostedExDocument."Web Company ID"));
                Writer.WriteEndElement;
            UNTIL NEXT = 0;
          END;
        END;
      END;

      Writer.WriteEndElement; //EXF_Message

      IF TestMode(WebCompID) THEN BEGIN
        xmlDoc := xmlDoc.XmlDocument();
        xmlDoc.LoadXml(StrWriter.ToString);
        xmlDoc.Save(STRSUBSTNO('c:\temp\Document_%1.xml',ID));
      END;

      DocumentData.ADDTEXT(StrWriter.ToString);
      ExFlowWebServMgt.CleanUpXmlBigText(DocumentData);
    END;

    PROCEDURE SearchDocument@1100285007(VAR res@1100285000 : BigText;bigTxt@1100285002 : BigText);
    VAR
      SearchDocs@1100285001 : Codeunit 12013635;
      xmlDoc@1100285003 : DotNet "'System.Xml, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlDocument";
    BEGIN
      IF TestMode(WebCompID) THEN BEGIN
        xmlDoc := xmlDoc.XmlDocument();
        xmlDoc.LoadXml(bigTxt);
        xmlDoc.Save(STRSUBSTNO('c:\temp\LatestSearchIn.xml'));
      END;

      SearchDocs.SearchUserDocuments(res,bigTxt);
      ExFlowWebServMgt.CleanUpXmlBigText(res);
      IF TestMode(WebCompID) THEN BEGIN
        xmlDoc := xmlDoc.XmlDocument();
        xmlDoc.LoadXml(res);
        xmlDoc.Save(STRSUBSTNO('c:\temp\LatestSearchOut.xml'));
      END;
    END;

    PROCEDURE GetColumnValues@1100285014(VAR res@1100285001 : BigText;bigTxt@1100285000 : BigText);
    VAR
      SearchDocs@1100285002 : Codeunit 12013635;
      xmlDoc@1100285003 : DotNet "'System.Xml, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlDocument";
    BEGIN
      IF TestMode(WebCompID) THEN BEGIN
        xmlDoc := xmlDoc.XmlDocument();
        xmlDoc.LoadXml(bigTxt);
        xmlDoc.Save(STRSUBSTNO('c:\temp\GetColumnValuesIn.xml'));
      END;

      SearchDocs.GetColumnValues(bigTxt,res);
      ExFlowWebServMgt.CleanUpXmlBigText(res);

      IF TestMode(WebCompID) THEN BEGIN
        xmlDoc := xmlDoc.XmlDocument();
        xmlDoc.LoadXml(res);
        xmlDoc.Save(STRSUBSTNO('c:\temp\GetColumnValuesOut.xml'));
      END;
    END;

    PROCEDURE GetPurchaseHeader@1100285021(VAR BigTxt@1100285002 : BigText;OrderNo@1100285000 : Code[20];CompName@1100285001 : Text[30]);
    VAR
      PurchHeader@1100285003 : Record 38;
      Writer@1100285006 : DotNet "'System.Xml, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlTextWriter";
      StrWriter@1100285005 : DotNet "'mscorlib, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.IO.StringWriter";
    BEGIN
      IF CompName = '' THEN
        CompName := COMPANYNAME;

      StrWriter := StrWriter.StringWriter;
      Writer := Writer.XmlTextWriter(StrWriter);
      Writer.WriteStartElement('HelperSP');
      Writer.WriteAttributeString('xmlns','http://tempuri.org/HelperSP.xsd');

      WITH PurchHeader DO BEGIN
        RESET;
        CHANGECOMPANY(CompName);
        SETRANGE("Document Type","Document Type"::Order);
        SETRANGE("No.",OrderNo);
        IF FINDFIRST THEN BEGIN
          Writer.WriteStartElement('PurchaseHeader');
          Writer.WriteElementString('OrderNo', "No.");
          Writer.WriteElementString('VendorNo', "Buy-from Vendor No.");
          Writer.WriteElementString('VendorName', "Buy-from Vendor Name");
          Writer.WriteElementString('VendOrderNo',"Vendor Order No.");
          IF "Order Date" <> 0D THEN
            Writer.WriteElementString('OrderDate',FORMAT("Order Date",0,9));
          IF "Posting Date" <> 0D THEN
            Writer.WriteElementString('PostingDate',FORMAT("Posting Date",0,9));
          IF "Expected Receipt Date" <> 0D THEN
            Writer.WriteElementString('ExpectedReceiptDate',FORMAT("Expected Receipt Date",0,9));
          IF "Due Date" <> 0D THEN
            Writer.WriteElementString('DueDate',FORMAT("Due Date",0,9));
          Writer.WriteElementString('PurchaserCode',"Purchaser Code");
          Writer.WriteEndElement;
        END;
      END;

      Writer.WriteEndElement;
      BigTxt.ADDTEXT(StrWriter.ToString);
      ExFlowWebServMgt.CleanUpXmlBigText(BigTxt);
    END;

    PROCEDURE GetPurchaseLines@1100285022(VAR BigTxt@1100285000 : BigText;OrderNo@1100285002 : Code[20];CompName@1100285001 : Text[30]);
    VAR
      PurchLine@1100285003 : Record 39;
      Writer@1100285005 : DotNet "'System.Xml, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlTextWriter";
      StrWriter@1100285004 : DotNet "'mscorlib, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.IO.StringWriter";
    BEGIN
      IF CompName = '' THEN
        CompName := COMPANYNAME;

      StrWriter := StrWriter.StringWriter;
      Writer := Writer.XmlTextWriter(StrWriter);
      Writer.WriteStartElement('HelperSP');
      Writer.WriteAttributeString('xmlns','http://tempuri.org/HelperSP.xsd');

      WITH PurchLine DO BEGIN
        RESET;
        CHANGECOMPANY(CompName);
        SETRANGE("Document Type","Document Type"::Order);
        SETRANGE("Document No.",OrderNo);
        IF FINDSET THEN
          REPEAT
            Writer.WriteStartElement('PurchaseLines');
            Writer.WriteElementString('LineNo_',FORMAT("Line No.",0,9));
            Writer.WriteElementString('LineType',FORMAT(Type,0,9));
            Writer.WriteElementString('LineTypeNo',"No.");
            Writer.WriteElementString('Description',Description);
            Writer.WriteElementString('LocationCode',"Location Code");
            Writer.WriteElementString('QuantityPerUnit',FORMAT("Qty. per Unit of Measure",0,9));
            Writer.WriteElementString('UOM',"Unit of Measure");
            Writer.WriteElementString('UnitCost',FORMAT("Direct Unit Cost",0,9));
            Writer.WriteElementString('Quantity',FORMAT(Quantity,0,9));
            Writer.WriteElementString('Discount',FORMAT("Line Discount %",0,9));
            Writer.WriteElementString('Amount',FORMAT(Amount,0,9));
            Writer.WriteElementString('QtyToReceive',FORMAT("Qty. to Receive",0,9));
            Writer.WriteElementString('QtyReceived',FORMAT("Quantity Received",0,9));
            Writer.WriteElementString('VendItemNo',"Vendor Item No.");
            Writer.WriteEndElement;
          UNTIL NEXT = 0;
      END;

      Writer.WriteEndElement;
      BigTxt.ADDTEXT(StrWriter.ToString);
      ExFlowWebServMgt.CleanUpXmlBigText(BigTxt);
    END;

    PROCEDURE GetLocation@1100285030(VAR BigTxt@1100285000 : BigText;InName@1100285002 : Text[30];CompName@1100285001 : Text[30];InUserId@1100285003 : Text[50]);
    VAR
      ExLocation@1100285006 : Record 12013613;
      Writer@1100285005 : DotNet "'System.Xml, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlTextWriter";
      StrWriter@1100285004 : DotNet "'mscorlib, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.IO.StringWriter";
    BEGIN
      IF CompName = '' THEN
        CompName := COMPANYNAME;

      StrWriter := StrWriter.StringWriter;
      Writer := Writer.XmlTextWriter(StrWriter);
      Writer.WriteStartElement('HelperSP');
      Writer.WriteAttributeString('xmlns','http://tempuri.org/HelperSP.xsd');

      GetWebComp(CompName);

      WITH ExLocation DO BEGIN
        RESET;
        CHANGECOMPANY(CompName);
        SETRANGE(Name,InName);
        SETFILTER("Created By", '%1|%2',InUserId,'');
        IF FINDSET THEN REPEAT
          Writer.WriteStartElement('Location');
          Writer.WriteElementString('CompName',CompName);
          Writer.WriteElementString('Name',Name);
          Writer.WriteElementString('Address',Address);
          Writer.WriteElementString('Address2',"Address 2");
          Writer.WriteElementString('City',City);
          Writer.WriteElementString('PostCode',"Post Code");
          Writer.WriteElementString('CountryCode',"Country/Region Code");
          Writer.WriteElementString('ID',FORMAT(ID+WebCompID."Web Company ID"));
          Writer.WriteEndElement;
        UNTIL NEXT = 0;
      END;

      Writer.WriteEndElement;
      BigTxt.ADDTEXT(StrWriter.ToString);
      ExFlowWebServMgt.CleanUpXmlBigText(BigTxt);
    END;

    PROCEDURE GetCount@1100285016(VAR strCount@1100285003 : Text;inboxName@1100285002 : Text[50];compName@1100285001 : Text[50];InUserID@1100285000 : Code[50]);
    VAR
      SearchDocs@1100285005 : Codeunit 12013635;
      TempCount@1100285004 : Integer;
    BEGIN
      TempCount := SearchDocs.GetCount(inboxName,compName,InUserID);
      strCount := FORMAT(TempCount);
    END;

    PROCEDURE HasSettingsTableChanged@1100285017(VAR latestDate@1100285000 : Text);
    VAR
      SettingsChanged@1100285001 : Record 12057071;
    BEGIN
      SettingsChanged.RESET;
      SettingsChanged.SETCURRENTKEY("Change Date");
      IF SettingsChanged.FINDLAST THEN
        latestDate := FORMAT(SettingsChanged."Change Date",0,9)
      ELSE
        latestDate := FORMAT(CURRENTDATETIME,0,9);
    END;

    PROCEDURE SetNewAttachments@1100285019(VAR bigTxt@1100285000 : BigText);
    VAR
      xf_WebService@1100285001 : Codeunit 12013636;
    BEGIN
      xf_WebService.SetDocNewAttachments(bigTxt);
    END;

    PROCEDURE GetLinesChangeDate@1100285031(VAR Params@1100285000 : BigText);
    VAR
      xf_WebService@1100285001 : Codeunit 12013636;
    BEGIN
      xf_WebService.GetLinesChangeDate(Params);
      ExFlowWebServMgt.CleanUpXmlBigText(Params);
    END;

    PROCEDURE SetDocument@1100285020(VAR Params@1100285001 : BigText;DocID@1100285000 : BigInteger;InUserID@1100285002 : Code[50]);
    VAR
      xf_WebService@1100285003 : Codeunit 12013636;
      custom_WebService@1100285004 : Codeunit 12013638;
    BEGIN
      xf_WebService.SetDocument(Params,DocID,InUserID);
      custom_WebService.SetDocument(Params,DocID,InUserID);
    END;

    PROCEDURE ValidateDocument@1100285018(VAR Params@1100285002 : BigText;DocID@1100285001 : BigInteger;InUserID@1100285000 : Code[50]);
    VAR
      custom_WebService@1100285004 : Codeunit 12013638;
    BEGIN
      custom_WebService.ValidateDocument(Params,DocID,InUserID);
    END;

    PROCEDURE ValidateDocumentLine@1100285012(VAR Params@1100285002 : BigText;DocID@1100285001 : BigInteger;InUserID@1100285000 : Code[50]);
    BEGIN
    END;

    PROCEDURE ReplacerUpdate@1100285023(VAR TxtOut@1100285001 : Text;bigTxtIn@1100285000 : BigText);
    VAR
      reader@1100285009 : DotNet "'System.Xml, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlTextReader";
      strReader@1100285008 : DotNet "'mscorlib, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.IO.StringReader";
      ExQuoteToReq@1100285007 : Codeunit 12013614;
      _exApprGrpLine@1100285006 : Record 12013607;
      _exApprGrpLine2@1100285005 : Record 12013607;
      WebSetting@1100285010 : Record 12057071;
      RecRef@1100285002 : RecordRef;
      _action@1100285004 : Text[50];
      TempCompName@1100285003 : Text[30];
    BEGIN
      strReader := strReader.StringReader(bigTxtIn);
      reader := reader.XmlTextReader(strReader);

      WHILE reader.Read() DO BEGIN
        IF reader.IsStartElement() THEN
          CASE LOWERCASE(reader.Name) OF
            'company': TempCompName := COPYSTR(reader.ReadString,1,MAXSTRLEN(TempCompName));
            'code': _exApprGrpLine.Code := COPYSTR(reader.ReadString,1,MAXSTRLEN(_exApprGrpLine.Code));
            'lineno': EVALUATE(_exApprGrpLine."Line No.",reader.ReadString);
            'action': _action := reader.ReadString;
            'approver': _exApprGrpLine."User ID" := COPYSTR(reader.ReadString,1,MAXSTRLEN(_exApprGrpLine."User ID"));
            'startingdate': _exApprGrpLine."Starting Date" := ExQuoteToReq.DateField(reader.ReadString);
            'endingdatedate': _exApprGrpLine."Ending Date" := ExQuoteToReq.DateField(reader.ReadString);
          END;
      END;

      IF LOWERCASE(_action) = 'delete' THEN BEGIN
        _exApprGrpLine2.CHANGECOMPANY(TempCompName);

        IF _exApprGrpLine2.GET(_exApprGrpLine.Code,_exApprGrpLine."Line No.") THEN
          IF _exApprGrpLine2."User ID" = _exApprGrpLine."User ID" THEN
            _exApprGrpLine2.DELETE(FALSE);
      END ELSE IF LOWERCASE(_action) = 'insert' THEN BEGIN
        _exApprGrpLine2.CHANGECOMPANY(TempCompName);
        _exApprGrpLine2.SETRANGE(Code, _exApprGrpLine.Code);
        IF NOT _exApprGrpLine2.FINDLAST THEN
          _exApprGrpLine2."Line No." := 0;
        _exApprGrpLine."Line No." := _exApprGrpLine2."Line No." +10000;
        _exApprGrpLine.INSERT(FALSE);
      END;

      RecRef.GETTABLE(_exApprGrpLine);
      WebSetting.TableChange(RecRef);

      TxtOut:='';
    END;

    PROCEDURE GetVendor@1100285025(VAR _bigText@1100285000 : BigText;_name@1100285002 : Text[50];_compName@1100285001 : Text[30]);
    VAR
      xf_WebService@1100285003 : Codeunit 12013636;
    BEGIN
      xf_WebService.GetVendor(_name,_compName,_bigText);
      ExFlowWebServMgt.CleanUpXmlBigText(_bigText);
    END;

    PROCEDURE GetCurrencyCodes@1100285027(VAR BigTxt@1100285000 : BigText;CompName@1100285001 : Text[30]);
    VAR
      Currency@1100285004 : Record 4;
      Writer@1100285003 : DotNet "'System.Xml, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlTextWriter";
      StrWriter@1100285002 : DotNet "'mscorlib, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.IO.StringWriter";
      xmlDoc@1100285005 : DotNet "'System.Xml, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlDocument";
    BEGIN
      IF CompName = '' THEN
        CompName := COMPANYNAME;

      StrWriter := StrWriter.StringWriter;
      Writer := Writer.XmlTextWriter(StrWriter);
      Writer.WriteStartElement('CurrencyCode');

      WITH Currency DO BEGIN
        RESET;

        CHANGECOMPANY(CompName);

        IF FINDSET THEN
          REPEAT
            Writer.WriteStartElement('CurrencyCode');
            Writer.WriteElementString('Code',Code);
            Writer.WriteElementString('CompName',CompName);
            Writer.WriteEndElement;
          UNTIL NEXT = 0;
      END;

      Writer.WriteEndElement;

      IF TestMode(WebCompID) THEN BEGIN
        xmlDoc := xmlDoc.XmlDocument();
        xmlDoc.LoadXml(StrWriter.ToString);
        xmlDoc.Save('c:\temp\currency.xml');
      END;

      BigTxt.ADDTEXT(StrWriter.ToString);
      ExFlowWebServMgt.CleanUpXmlBigText(BigTxt);
    END;

    PROCEDURE GetVendorsForAutoComplete@1100285004(VAR BigTxt@1100285000 : BigText;CompName@1100285002 : Text[30];Prefix@1100285001 : Text[100]);
    VAR
      WebUsedVendor@1100285003 : Query 12013631;
      Writer@1100285005 : DotNet "'System.Xml, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlTextWriter";
      StrWriter@1100285004 : DotNet "'mscorlib, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.IO.StringWriter";
      xmlDoc@1100285006 : DotNet "'System.Xml, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlDocument";
      tmpWebVend@1100285007 : TEMPORARY Record 12013631;
    BEGIN
      StrWriter := StrWriter.StringWriter;
      Writer := Writer.XmlTextWriter(StrWriter);
      Writer.WriteStartElement('Vendor');

      IF Prefix <> '' THEN
        WebUsedVendor.SETFILTER(Vendor_Name, STRSUBSTNO('%1*', Prefix));

      IF CompName <> '' THEN
        WebUsedVendor.SETFILTER(Company_Name,'%1',CompName);
      tmpWebVend.DELETEALL;

      WebUsedVendor.OPEN;
      WHILE WebUsedVendor.READ DO BEGIN
        tmpWebVend.RESET;
        tmpWebVend.SETRANGE("Vendor Name",WebUsedVendor.Vendor_Name);
        IF NOT tmpWebVend.FINDFIRST THEN
          tmpWebVend.INIT;

        Writer.WriteStartElement('Vendor');
        Writer.WriteElementString('Description',WebUsedVendor.Vendor_Name);
        Writer.WriteElementString('Value',WebUsedVendor.Vendor_Name);
        Writer.WriteEndElement;
      END;

      Writer.WriteEndElement;
      BigTxt.ADDTEXT(StrWriter.ToString);
      ExFlowWebServMgt.CleanUpXmlBigText(BigTxt);

      IF TestMode(WebCompID) THEN BEGIN
        xmlDoc := xmlDoc.XmlDocument();
        xmlDoc.LoadXml(StrWriter.ToString);
        xmlDoc.Save('c:\temp\getvendorsforautocomplete.xml');
      END;
    END;

    PROCEDURE GetAllVendorsBySearchText@1100285026(VAR _bigText@1100285000 : BigText;_approver@1100285003 : Text[100];_compName@1100285002 : Text[30];_searchText@1100285001 : Text[1024]);
    VAR
      xf_WebService@1100285004 : Codeunit 12013636;
    BEGIN
      xf_WebService.GetAllVendorsBySearchText(_approver,_compName,_searchText,_bigText);
      ExFlowWebServMgt.CleanUpXmlBigText(_bigText);
    END;

    PROCEDURE GetLocationForAutoComplete@1100285028(VAR BigTxt@1100285000 : BigText;CompName@1100285002 : Text[30];Prefix@1100285001 : Text[100];InUserId@1100285003 : Text[50]);
    VAR
      ExLocation@1100285006 : Record 12013613;
      Writer@1100285005 : DotNet "'System.Xml, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlTextWriter";
      StrWriter@1100285004 : DotNet "'mscorlib, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.IO.StringWriter";
    BEGIN
      IF CompName = '' THEN
        CompName := COMPANYNAME;

      StrWriter := StrWriter.StringWriter;
      Writer := Writer.XmlTextWriter(StrWriter);
      Writer.WriteStartElement('Location');

      WITH ExLocation DO BEGIN
        RESET;
        CHANGECOMPANY(CompName);

        SETFILTER(ExLocation."Created By", '%1|%2',InUserId,'');
        IF FINDSET THEN
          REPEAT
            Writer.WriteStartElement('Location');
            Writer.WriteElementString('Description',Name);
            Writer.WriteElementString('Value',Name);
            Writer.WriteEndElement;
          UNTIL NEXT = 0;
      END;

      Writer.WriteEndElement;
      BigTxt.ADDTEXT(StrWriter.ToString);
      ExFlowWebServMgt.CleanUpXmlBigText(BigTxt);
    END;

    PROCEDURE GetRegionForAutoComplete@1100285035(VAR BigTxt@1100285002 : BigText;CompName@1100285001 : Text[30];Prefix@1100285000 : Text[100]);
    VAR
      ExCountry@1100285003 : Record 12013616;
      Writer@1100285005 : DotNet "'System.Xml, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlTextWriter";
      StrWriter@1100285004 : DotNet "'mscorlib, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.IO.StringWriter";
    BEGIN
      IF CompName = '' THEN
        CompName := COMPANYNAME;

      StrWriter := StrWriter.StringWriter;
      Writer := Writer.XmlTextWriter(StrWriter);
      Writer.WriteStartElement('Region');

      WITH ExCountry DO BEGIN
        RESET;
        CHANGECOMPANY(CompName);

        IF FINDSET THEN
          REPEAT
            Writer.WriteStartElement('Region');
            Writer.WriteElementString('Description',"Country Name");
            Writer.WriteElementString('Value',"Country Code");
            Writer.WriteEndElement;
          UNTIL NEXT() = 0;
      END;

      Writer.WriteEndElement;
      BigTxt.ADDTEXT(StrWriter.ToString);
      ExFlowWebServMgt.CleanUpXmlBigText(BigTxt);
    END;

    PROCEDURE GetPurchaseTables@1100285032(VAR BigTxt@1100285002 : BigText;OrderNo@1100285001 : Code[20];CompName@1100285000 : Text[30]);
    VAR
      PurchHeader@1100285003 : Record 38;
      PurchLine@1100285004 : Record 39;
      Writer@1100285006 : DotNet "'System.Xml, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlTextWriter";
      StrWriter@1100285005 : DotNet "'mscorlib, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.IO.StringWriter";
    BEGIN
      IF CompName = '' THEN
        CompName := COMPANYNAME;

      StrWriter := StrWriter.StringWriter;
      Writer := Writer.XmlTextWriter(StrWriter);
      Writer.WriteStartElement('HelperSP');
      Writer.WriteAttributeString('xmlns','http://tempuri.org/HelperSP.xsd');

      WITH PurchHeader DO BEGIN
        RESET;
        CHANGECOMPANY(CompName);

        SETRANGE("Document Type","Document Type"::Order);
        SETRANGE("No.",OrderNo);
        IF FINDFIRST THEN
          REPEAT
            Writer.WriteStartElement('PurchaseHeader');
            Writer.WriteElementString('OrderNo',"No.");
            Writer.WriteElementString('VendorNo',"Buy-from Vendor No.");
            Writer.WriteElementString('VendorName',"Pay-to Name");
            Writer.WriteElementString('VendOrderNo',"Vendor Order No.");
            IF "Order Date" <> 0D THEN
              Writer.WriteElementString('OrderDate',FORMAT("Order Date",0,9));
            IF "Posting Date" <> 0D THEN
              Writer.WriteElementString('PostingDate',FORMAT("Posting Date",0,9));
            IF "Expected Receipt Date" <> 0D THEN
              Writer.WriteElementString('ExpectedReceiptDate',FORMAT("Expected Receipt Date",0,9));
            IF "Due Date" <> 0D THEN
              Writer.WriteElementString('DueDate',FORMAT("Due Date",0,9));
            Writer.WriteElementString('PurchaserCode',"Purchaser Code");
            Writer.WriteEndElement;
          UNTIL NEXT = 0;
      END;

      WITH PurchLine DO BEGIN
        RESET;
        CHANGECOMPANY(CompName);
        SETRANGE("Document Type","Document Type"::Order);
        SETRANGE("Document No.",OrderNo);
        IF FINDSET THEN
          REPEAT
            Writer.WriteStartElement('PurchaseLines');
            Writer.WriteElementString('LineNo_',FORMAT("Line No.",0,9));
            Writer.WriteElementString('LineType',FORMAT(Type,0,9));
            Writer.WriteElementString('LineTypeNo',"No.");
            Writer.WriteElementString('Description',Description);
            Writer.WriteElementString('LocationCode',"Location Code");
            Writer.WriteElementString('QuantityPerUnit',FORMAT("Qty. per Unit of Measure",0,9));
            Writer.WriteElementString('UOM',"Unit of Measure");
            Writer.WriteElementString('UnitCost',FORMAT("Direct Unit Cost",0,9));
            Writer.WriteElementString('Quantity',FORMAT(Quantity,0,9));
            Writer.WriteElementString('Discount',FORMAT("Line Discount %",0,9));
            Writer.WriteElementString('Amount',FORMAT(Amount,0,9));
            Writer.WriteElementString('QtyToReceive',FORMAT("Qty. to Receive",0,9));
            Writer.WriteElementString('QtyReceived',FORMAT("Quantity Received",0,9));
            Writer.WriteElementString('VendItemNo',"Vendor Item No.");
            Writer.WriteEndElement;
          UNTIL NEXT = 0;
      END;

      Writer.WriteEndElement;
      BigTxt.ADDTEXT(StrWriter.ToString);
      ExFlowWebServMgt.CleanUpXmlBigText(BigTxt);
    END;

    PROCEDURE UpdateReqStatus@1100285033(InUserID@1100285002 : Text[100];Status@1100285001 : Integer;ID@1100285000 : BigInteger;CompName@1100285009 : Text[30]);
    VAR
      ExDoc@1100285010 : Record 12013608;
      cmt@1100285003 : BigText;
      cr@1100285004 : Char;
      lf@1100285005 : Char;
      oStream@1100285006 : OutStream;
      iStream@1100285007 : InStream;
      cmt2@1100285008 : Text[250];
    BEGIN
      IF CompName <> COMPANYNAME THEN
        ERROR(EXF002);

      ExDoc.SETCURRENTKEY("Web ID");
      ExDoc.SETRANGE("Web ID", ID);
      ExDoc.FINDFIRST;

      ExDoc.CALCFIELDS("Approver Comments");
      ExDoc."Approver Comments".CREATEINSTREAM(iStream);
      cmt.READ(iStream);
      cr:=13;
      lf:=10;

      IF Status = 1 THEN BEGIN
        ExDoc.VALIDATE("Requisition Status",Status);
        ExDoc."Changed By" := USERID;
        ExDoc."Change Date" := CREATEDATETIME(TODAY,TIME);
        ExDoc.MODIFY;
      END ELSE BEGIN
        cmt2 := FORMAT(cr) + FORMAT(lf) + 'PO CLOSED BY '+ InUserID + ' at ' + FORMAT(TODAY,0,9);
        cmt.ADDTEXT(cmt2);
        ExDoc."Approver Comments".CREATEOUTSTREAM(oStream);
        cmt.WRITE(oStream);
        ExDoc.VALIDATE(Status,Status);
        ExDoc."Changed By" := USERID;
        ExDoc."Change Date" := CREATEDATETIME(TODAY,TIME);
        ExDoc.MODIFY;
      END;
    END;

    PROCEDURE GetWebCodesForAutoComplete@1100285034(VAR BigTxt@1100285002 : BigText;CompName@1100285001 : Text[30];Prefix@1100285000 : Text[100];FieldNo@1100285003 : Text[30]);
    VAR
      ExWebCode@1100285007 : Record 12013600;
      int@1100285004 : Integer;
      Writer@1100285006 : DotNet "'System.Xml, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlTextWriter";
      StrWriter@1100285005 : DotNet "'mscorlib, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.IO.StringWriter";
    BEGIN
      IF CompName = '' THEN
        CompName := COMPANYNAME;

      StrWriter := StrWriter.StringWriter;
      Writer := Writer.XmlTextWriter(StrWriter);
      Writer.WriteStartElement('WebCode');

      int:=TextToInteger(FieldNo);
      WITH ExWebCode DO BEGIN
        RESET;
        CHANGECOMPANY(CompName);

        SETRANGE("Field No",int);

        IF FINDSET THEN
          REPEAT
            Writer.WriteStartElement('WebCode');
            Writer.WriteElementString('Description',Description);
            Writer.WriteElementString('Value',Code);
            Writer.WriteEndElement;
          UNTIL NEXT = 0;
      END;

      Writer.WriteEndElement;
      BigTxt.ADDTEXT(StrWriter.ToString);
      ExFlowWebServMgt.CleanUpXmlBigText(BigTxt);
    END;

    PROCEDURE CreateLocation@1100285036(VAR nameReturn@1100285000 : Text[30];compName@1100285007 : Text[30];name@1100285006 : Text[30];address@1100285005 : Text[50];address2@1100285004 : Text[50];city@1100285003 : Text[30];postCode@1100285002 : Code[20];countryCode@1100285001 : Code[10];InUserID@1100285008 : Text[50]);
    VAR
      xf_WebService@1100285009 : Codeunit 12013636;
    BEGIN
      xf_WebService.InsertLocation(compName,name,address,address2,city,postCode,countryCode,nameReturn,InUserID);
    END;

    PROCEDURE SendSSOMail@1100285003(SendTo@1100285000 : Text;SSOCode@1100285001 : Text);
    VAR
      ExFlowEmailMgt@1100285002 : Codeunit 12013627;
    BEGIN
      ExFlowEmailMgt.SendSSOMail(SendTo,SSOCode);
    END;

    LOCAL PROCEDURE GetWebComp@1100285037(CompName@1100285000 : Text[30]);
    VAR
      WebSearchMgt@1100285001 : Codeunit 12013635;
    BEGIN
      WebSearchMgt.GetWebComp(WebCompID,CompName);
    END;

    LOCAL PROCEDURE GetDimValDesc@1100285024(CompName@1100285004 : Text[30];ColID@1100285001 : Integer;ColValue@1100285000 : Code[20];ExDocLineID@1100285002 : Integer) Desc : Text[100];
    VAR
      ExDocLineDim@1100285005 : Record 12013611;
      ExColumn@1100285006 : Record 12013661;
      GLAcc@1100285007 : Record 15;
      FA@1100285008 : Record 5600;
      Item@1100285009 : Record 27;
      ItemCharge@1100285010 : Record 5800;
      Job@1100285011 : Record 11072003;
      JobTask@1100285012 : Record 11072600;
      UOM@1100285013 : Record 204;
      Cust@1100285014 : Record 18;
      ExInvCode@1100285015 : Record 12013597;
      DimVal@1100285016 : Record 349;
      ExPeriodicMgt@1100285003 : Codeunit 12013599;
      ServiceHeader@1101285000 : Record 11012823;
    BEGIN
      IF CompName <> COMPANYNAME THEN
        ERROR(EXF002);

      ExColumn.RESET;
      IF ExColumn.GET(ColID) THEN
        CASE UPPERCASE(ExColumn.Source) OF
          'G_LACCOUNT','GLB_G_LACCOUNT':
            WITH GLAcc DO BEGIN
              IF GET(ColValue) THEN
                EXIT(Name)
              ELSE
                EXIT('');
            END;
          'FIXEDASSET','GLB_FIXEDASSET':
            WITH FA DO BEGIN
              IF GET(ColValue) THEN
                EXIT(Description)
              ELSE
                EXIT('');
            END;
          'ITEM','GLB_ITEM':
            WITH Item DO BEGIN
              IF GET(ColValue) THEN
                EXIT(Description)
              ELSE
                EXIT('');
            END;
          'CHARGE','GLB_CHARGE':
            WITH ItemCharge DO BEGIN
              IF GET(ColValue) THEN
                EXIT(Description)
              ELSE
                EXIT('');
            END;
          'JOB','GLB_JOB':
            WITH Job DO BEGIN
              IF GET(ColValue) THEN
                EXIT(Description)
              ELSE
                EXIT('');
            END;
          'JOBTASK','GLB_JOBTASK':
            WITH JobTask DO BEGIN
              ExDocLineDim.SETCURRENTKEY("Document Line ID");
              ExDocLineDim.SETRANGE("Document Line ID",ExDocLineID);
              ExDocLineDim.SETFILTER("Dimension Code", '%1|%2', 'JOB', 'GLB_JOB');
              IF ExDocLineDim.FINDFIRST THEN
                IF GET(ExDocLineDim."Dimension Value",ColValue) THEN
                  EXIT(Description);
              EXIT('');
            END;
          'PERCODE','GLB_PERCODE':
            EXIT(ExPeriodicMgt.GetPerCodeDesc(ExColumn,ColValue,CompName));
          'SERVICEORDERNO':
            WITH ServiceHeader DO BEGIN
              IF GET(ColValue) THEN
                EXIT(Description)
              ELSE
                EXIT('');

            END;

          '1014_RCPT':;
          '1128_SUB-ITEM':;
          '1128_PROJECT':;
          'UOM':
            WITH UOM DO BEGIN
              IF GET(ColValue) THEN
                EXIT(Description)
              ELSE
                EXIT('');
            END;
          'CUSTOMER','GLB_CUSTOMER':
            WITH Cust DO BEGIN
              IF GET(ColValue) THEN
                EXIT(Name)
              ELSE
                EXIT('');
            END;
          'INV_CODE':
            WITH ExInvCode DO BEGIN
              RESET;
              SETRANGE("Invoicing Code",ColValue);
              IF FINDFIRST THEN
                EXIT(Description)
              ELSE
                EXIT('');
            END;
          '1128_ITEM','1128_GLB_ITEM':
            WITH Item DO BEGIN
              IF GET(ColValue) THEN BEGIN
                IF "Description 2" = '' THEN
                  EXIT(Description)
                ELSE
                  EXIT(COPYSTR(Description +' - ' +"Description 2",1,50));
              END ELSE
                EXIT('');
            END;
          'DESCRIPTION':
            EXIT('')
          ELSE IF COPYSTR(ExColumn.Source,1,3) = 'DIM' THEN BEGIN
            WITH DimVal DO BEGIN
              IF GET(ExColumn.Code,ColValue) THEN
                EXIT(Name)
              ELSE
                EXIT('');
            END;
          END;
        END;
    END;

    LOCAL PROCEDURE TransformString@1100285008(InStr@1100285000 : Text[1024]) : Text[1024];
    BEGIN
      InStr := DELCHR(InStr);
      InStr := CONVERTSTR(InStr,'():-%','_____');
      EXIT(InStr);
    END;

    LOCAL PROCEDURE ConvertToString@1100285005(Field@1100285000 : Record 2000000041;VAR FieldRef@1100285001 : FieldRef) : Text[1024];
    VAR
      TempBoolean@1100285002 : Boolean;
      TempDate@1100285003 : Date;
      TempDec@1100285008 : Decimal;
      TempTime@1100285009 : Time;
      TempOpt@1100285004 : Option;
      TempDateTime@1100285005 : DateTime;
    BEGIN
      CASE Field.Type OF
        Field.Type::Boolean:
          BEGIN
            IF EVALUATE(TempBoolean,FORMAT(FieldRef.VALUE)) THEN BEGIN
              EXIT(FORMAT(TempBoolean,0,2));
            END;
          END;
        Field.Type::Date:
          BEGIN
            IF EVALUATE(TempDate,FORMAT(FieldRef.VALUE)) THEN BEGIN
              EXIT(FORMAT(TempDate,0,9));
            END;
          END;
        Field.Type::DateTime:
          BEGIN
            IF EVALUATE(TempDateTime,FORMAT(FieldRef.VALUE)) THEN BEGIN
              EXIT(FORMAT(TempDateTime,0,9));
            END;
          END;
        Field.Type::Decimal:
          BEGIN
            IF EVALUATE(TempDec,FORMAT(FieldRef.VALUE)) THEN BEGIN
              EXIT(FORMAT(TempDec,0,9)); //XML Format
            END;
          END;
        Field.Type::Time:
          BEGIN
            IF EVALUATE(TempTime,FORMAT(FieldRef.VALUE)) THEN BEGIN
              EXIT(FORMAT(TempTime,0,9)); //XML Format
            END;
          END;
        Field.Type::Option:
          BEGIN
            IF EVALUATE(TempOpt,FORMAT(FieldRef.VALUE)) THEN BEGIN
              EXIT(FORMAT(TempOpt,0,9));
            END;
          END;
        ELSE
          EXIT(FORMAT(FieldRef.VALUE));
      END;

      EXIT('');
    END;

    LOCAL PROCEDURE TransformTxt2Date@1100285000(InStr@1100285005 : Text[30]) : Text[30];
    VAR
      newStr@1100285001 : Text[30];
      YYYY@1100285002 : Text[30];
      DD@1100285003 : Text[30];
      MM@1100285004 : Text[30];
    BEGIN
      YYYY:= COPYSTR(InStr,1,4);
      MM := COPYSTR(InStr,5,2);
      DD :=  COPYSTR(InStr,7,2);
      newStr:= YYYY + '-' + MM + '-' + DD + ' 00:00:00';

      EXIT(newStr);
    END;

    LOCAL PROCEDURE TransformDate2Txt@1100285006(InDate@1100285000 : Date) NewStr : Text[30];
    VAR
      YYYY@1100285003 : Text[30];
      DD@1100285002 : Text[30];
      MM@1100285001 : Text[30];
    BEGIN
      YYYY := FORMAT(DATE2DMY(InDate,3));
      MM := FORMAT(DATE2DMY(InDate,2));
      DD := FORMAT(DATE2DMY(InDate,1));

      NewStr:= YYYY + '-' + MM + '-' + DD + ' 00:00:00';

      EXIT(NewStr);
    END;

    LOCAL PROCEDURE Ansi2Ascii@9(_Text@1000000000 : Text[250]) : Text[250];
    VAR
      AsciiStr@1100285001 : Text[250];
      AnsiStr@1100285000 : Text[250];
    BEGIN
      MakeVars(AsciiStr,AnsiStr);
      EXIT(CONVERTSTR(_Text,AnsiStr,AsciiStr));
    END;

    LOCAL PROCEDURE Ascii2Ansi@10(_Text@1000000000 : Text[250]) : Text[250];
    VAR
      encoding@1100285003 : DotNet "'mscorlib, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Text.Encoding";
      _ascii@1100285002 : DotNet "'mscorlib, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Text.ASCIIEncoding";
      txt@1100285001 : Text[30];
      _byte@1100285000 : DotNet "'mscorlib, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Array";
    BEGIN
      _ascii := _ascii.ASCIIEncoding();
      _byte := _ascii.GetBytes(_Text);
      txt := encoding.ASCII.GetString(_byte,0,_byte.Length);
      EXIT(txt);
    END;

    LOCAL PROCEDURE MakeVars@1(VAR AsciiStr@1100285001 : Text[250];VAR AnsiStr@1100285000 : Text[250]);
    VAR
      CharVar@1100285002 : ARRAY [32] OF Char;
    BEGIN
      AsciiStr := '€‚ƒ„…†‡ˆ‰Š‹ŒŽ‘’“”•–—˜™š›œžŸ ¡¢£¤¥¦§¨©ª«¬­®¯ÝÝÝÝÝµ¶·¸ÝÝ++½¾++--+-+ÆÇ++--Ý-+';
      AsciiStr := AsciiStr +'ÏÐÑÒÓÔiÖ×Ø++Ý_ÝÞîàáâãäåæçèéêëìíîïðñ=óôõö÷øùúûüýÝÿ';
      CharVar[1] := 196;
      CharVar[2] := 197;
      CharVar[3] := 201;
      CharVar[4] := 242;
      CharVar[5] := 220;
      CharVar[6] := 186;
      CharVar[7] := 191;
      CharVar[8] := 188;
      CharVar[9] := 187;
      CharVar[10] := 193;
      CharVar[11] := 194;
      CharVar[12] := 192;
      CharVar[13] := 195;
      CharVar[14] := 202;
      CharVar[15] := 203;
      CharVar[16] := 200;
      CharVar[17] := 205;
      CharVar[18] := 206;
      CharVar[19] := 204;
      CharVar[20] := 175;
      CharVar[21] := 223;
      CharVar[22] := 213;
      CharVar[23] := 254;
      CharVar[24] := 218;
      CharVar[25] := 219;
      CharVar[26] := 217;
      CharVar[27] := 180;
      CharVar[28] := 177;
      CharVar[29] := 176;
      CharVar[30] := 185;
      CharVar[31] := 179;
      CharVar[32] := 178;
      AnsiStr  := 'Çüéâäàåçêëèïîì'+FORMAT(CharVar[1])+FORMAT(CharVar[2])+FORMAT(CharVar[3])+ 'æÆôö'+FORMAT(CharVar[4]);
      AnsiStr := AnsiStr + 'ûùÿÖ'+FORMAT(CharVar[5])+'ø£Ø×ƒáíóúñÑª'+FORMAT(CharVar[6])+FORMAT(CharVar[7]);
      AnsiStr := AnsiStr + '®¬½'+FORMAT(CharVar[8])+'¡«'+FORMAT(CharVar[9])+'___¦¦' + FORMAT(CharVar[10])+FORMAT(CharVar[11]);
      AnsiStr := AnsiStr + FORMAT(CharVar[12]) + '©¦¦++¢¥++--+-+ã' + FORMAT(CharVar[13]) + '++--¦-+¤ðÐ';
      AnsiStr  :=  AnsiStr + FORMAT(CharVar[14])+FORMAT(CharVar[15])+FORMAT(CharVar[16])+'i'+FORMAT(CharVar[17])+FORMAT(CharVar[18]);
      AnsiStr  :=  AnsiStr + 'Ï++__¦' + FORMAT(CharVar[19])+FORMAT(CharVar[20])+'Ó'+FORMAT(CharVar[21])+'ÔÒõ';
      AnsiStr  :=  AnsiStr + FORMAT(CharVar[22]) + 'µ' + FORMAT(CharVar[23]) + 'Þ' + FORMAT(CharVar[24])+ FORMAT(CharVar[25]);
      AnsiStr  :=  AnsiStr + FORMAT(CharVar[26]) + 'ýÝ¯' + FORMAT(CharVar[27]) + '­' + FORMAT(CharVar[28]) +'=¾¶§÷¸'+ FORMAT(CharVar[29]
      );
      AnsiStr  :=  AnsiStr + '¨·' + FORMAT(CharVar[30]) +FORMAT(CharVar[31]) +FORMAT(CharVar[32]) +'_ ';
    END;

    LOCAL PROCEDURE ReplaceString@1100285002(String@1100285000 : Text[250];FindWhat@1100285001 : Text[250];ReplaceWith@1100285002 : Text[250]) NewString : Text[250];
    BEGIN
      WHILE STRPOS(String,FindWhat) > 0 DO
        String := DELSTR(String,STRPOS(String,FindWhat)) + ReplaceWith + COPYSTR(String,STRPOS(String,FindWhat) + STRLEN(FindWhat));
      NewString := String;
    END;

    LOCAL PROCEDURE TextToInteger@1100285015(VarText@1100285000 : Text[250]) : Integer;
    VAR
      VarInteger@1100285001 : Integer;
    BEGIN
      EVALUATE(VarInteger,VarText);
      EXIT(VarInteger);
    END;

    PROCEDURE TestMode@1100285038(_WebCompID@1100285000 : Record 12013630) : Boolean;
    BEGIN
      IF _WebCompID."Company Name" = '' THEN
        IF _WebCompID.FINDFIRST THEN;

      EXIT(_WebCompID."Test Mode (web)");
    END;

    LOCAL PROCEDURE ReplaceDim1Filter@1100285029(ExUserComp@1100285000 : Record 12013641;WebCompID@1100285001 : Record 12013630) OutString : Text[1024];
    VAR
      ExColumn@1100285002 : Record 12013661;
      ReplaceWith@1100285003 : Text[100];
      FindWhat@1100285004 : Text[100];
    BEGIN
      OutString := ExUserComp."Dimension 1";
      ExColumn.RESET;
      ExColumn.CHANGECOMPANY(WebCompID."Company Name");
      ExColumn.SETFILTER("Dimension Code",'<>%1','');
      IF ExColumn.FINDSET THEN
        REPEAT
          ReplaceWith := FORMAT(WebCompID."Web Company ID" + ExColumn.ID);
          FindWhat := ExColumn.Code;
          WHILE STRPOS(OutString,FindWhat) > 0 DO
            OutString := DELSTR(OutString,STRPOS(OutString,FindWhat)) + ReplaceWith + COPYSTR(OutString,STRPOS(OutString,FindWhat) + STRLEN(FindWhat));
        UNTIL ExColumn.NEXT = 0;

      EXIT(OutString);
    END;

    PROCEDURE GetDocumentImage@1100285039(VAR PDF64@1002 : BigText;Id@1100285000 : BigInteger);
    VAR
      TempBlob@1100285001 : Record 99008535;
      ExDoc2@1100285002 : Record 12013612;
      ExAppSetup@1100285003 : Record 12013601;
      FileMgt@1100285004 : Codeunit 419;
      FullFilePath@1100285005 : Text;
      ExTempBlobMgt@1100285006 : Codeunit 12057145;
    BEGIN
      ExDoc2.RESET;
      ExDoc2.SETRANGE("Web ID", Id);
      IF ExDoc2.FINDFIRST THEN
        IF ExDoc2."Image Blob".HASVALUE THEN BEGIN
          ExDoc2.CALCFIELDS("Image Blob");
          TempBlob.Blob := ExDoc2."Image Blob";
          PDF64.ADDTEXT(ExTempBlobMgt.ToBase64String(TempBlob));
        END ELSE BEGIN
          ExAppSetup.GET;
          IF ExAppSetup."Path to Used Invoices" <> '' THEN BEGIN
            FullFilePath := ExAppSetup."Path to Used Invoices" + ExDoc2."Image Name";
            IF FileMgt.ServerFileExists(FullFilePath) THEN BEGIN
              FileMgt.BLOBImportFromServerFile(TempBlob,FullFilePath);
              PDF64.ADDTEXT(ExTempBlobMgt.ToBase64String(TempBlob));
            END;
          END;
        END;
    END;

    PROCEDURE GetDocumentAttachment@1100285042(VAR PDF64@1002 : BigText;Id@1100285000 : BigInteger;fileName@1100285004 : Text);
    VAR
      TempBlob@1100285001 : Record 99008535;
      ExAttachedFile@1100285005 : Record 12013643;
      ExTempBlobMgt@1100285006 : Codeunit 12057145;
    BEGIN
      ExAttachedFile.RESET;
      ExAttachedFile.SETCURRENTKEY("Web ID");
      ExAttachedFile.SETRANGE("Web ID",Id);
      ExAttachedFile.SETRANGE("Attached File",fileName);
      IF ExAttachedFile.FINDFIRST THEN
        IF ExAttachedFile."Attachment Blob".HASVALUE THEN BEGIN
          ExAttachedFile.CALCFIELDS("Attachment Blob");
          TempBlob.Blob := ExAttachedFile."Attachment Blob";
          PDF64.ADDTEXT(ExTempBlobMgt.ToBase64String(TempBlob))
        END;
    END;

    PROCEDURE AddDocumentAttachment@1100285040(PDF64@1100285005 : Text;Id@1100285002 : BigInteger;fileName@1100285001 : Text[250];InUserID@1100285000 : Text[100]);
    VAR
      ExDoc@1100285003 : Record 12013608;
      ExAttachment@1100285004 : Record 12013643;
      TempBlob@1100285006 : Record 99008535;
      ExTempBlobMgt@1100285009 : Codeunit 12057145;
    BEGIN
      IF fileName = '' THEN
        ERROR(EXF003);

      ExDoc.SETRANGE("Web ID", Id);
      ExDoc.FINDFIRST;

      ExTempBlobMgt.FromBase64String(TempBlob,PDF64);

      ExAttachment.INIT;
      ExAttachment."Entry No." := 0;
      ExAttachment."Attached File" := fileName;
      ExAttachment."Attachment Blob" := TempBlob.Blob;
      ExAttachment."Document Type" := ExDoc."Document Type";
      ExAttachment."Document No." := ExDoc."Document No.";
      ExAttachment.Attached := TRUE;
      ExAttachment."Document ID" := ExDoc.ID;
      ExAttachment."Web ID" := Id;
      ExAttachment."Created By" := InUserID;
      ExAttachment."Created Date" := CREATEDATETIME(TODAY,TIME);
      ExAttachment.Source := ExAttachment.Source::Web;
      ExAttachment.INSERT;
    END;

    LOCAL PROCEDURE GetAttchmentStr@1100285043(DocID@1100285000 : BigInteger) AttStr : Text;
    VAR
      ExAttachment@1100285001 : Record 12013643;
      Separate@1100285002 : Boolean;
    BEGIN
      ExAttachment.RESET;
      ExAttachment.SETCURRENTKEY("Document ID");
      ExAttachment.SETRANGE("Document ID",DocID);
      IF ExAttachment.FINDSET THEN
        REPEAT
          IF NOT Separate THEN BEGIN
            AttStr := ExAttachment."Attached File";
            Separate := TRUE;
          END ELSE
            AttStr := AttStr + ',' + ExAttachment."Attached File";
        UNTIL ExAttachment.NEXT = 0;
    END;

    PROCEDURE GetItemDetails@1100285041(VAR bigtxt@1100285000 : BigText;CompName@1100285001 : Text[30];ItemNo@1100285002 : Text[50]);
    BEGIN
      // Placeholder
    END;

    BEGIN
    {
      This codeunit handles all the requests made by the web site
      The requests are then routed to codeunits specifically created for these purposes

      This codeunit needs to be published as a web service with the name EXFWEB. No other name allowed!

      4PS20200221 SICH Code in GetColumns
    }
    END.
  }
}

