OBJECT Codeunit 11012033 Validate Items
{
  OBJECT-PROPERTIES
  {
    Date=;
    Time=;
    Version List=4PS14.00,4PSSE;
  }
  PROPERTIES
  {
    OnRun=BEGIN
          END;

  }
  CODE
  {
    VAR
      ItemSetup@1100485000 : Record 11012300;
      InventSetup@1100485001 : Record 313;
      GLSetup@1100485005 : Record 98;
      Customer@1210190004 : Record 18;
      DimensionValue@1210190007 : Record 349;
      LanguageCode@1100525000 : Code[10];
      QuanDec@1100525001 : Decimal;
      GetBasicItemOnly@1210190000 : Boolean;
      ItemRelationsRead@1210190002 : Boolean;
      ItemRelationsPresent@1210190001 : Boolean;
      CustPresent@1210190003 : Boolean;
      GLSetupRead@1210190006 : Boolean;
      InventSetupRead@1210190005 : Boolean;
      SkipError@1100525002 : Boolean;
      VendorTradeItem@1100525003 : Code[20];
      ShowSalesDiscount@1100525005 : Boolean;
      gvSalesPrice@1100525004 : Decimal;
      CalledFromSalesPrice@1100525006 : Boolean;
      VendorNavItem@1100525007 : Code[20];
      "-EVRY-"@1100285003 : Integer;
      PriceListCode@1100285002 : Code[10];
      PriceHistFound@1100285001 : Boolean;
      PriceListVendorNo@1100285000 : Code[20];
      LatestCustGrossPrice@1100409000 : Decimal;
      "-ITERO-"@1100285005 : Integer;
      DontUseSingleGTIN@1100285004 : Boolean;
      gvFoundSalesDiscRef@1100285006 : Code[20];

    PROCEDURE ValidateItem@1(ItemOption@11012000 : 'Item,Basic Item,Trade Item,Trade Vendor';VAR TradeCde@11012001 : Code[20];VAR ItemCde@11012002 : Code[20];VAR ManufCde@11012003 : Code[20];VAR VendorCde@11012004 : Code[20];VAR BasicCde@11012005 : Code[20];VAR CostObject@11012006 : Code[20];VAR DescTxt@11012007 : Text[100];VAR UnitCde@11012008 : Code[10];VAR NetPrice@11012009 : Decimal;VAR DiscPerc@11012010 : Decimal;VAR ItemRefDate@11012011 : Date;VAR GrossPrice@11012012 : Decimal;VAR DescTxt2@1210190000 : Text[50];VAR CostComp@1100485000 : Code[10];DiscRef1@1100485003 : Code[20];DiscRef2@1100485002 : Code[20];PriceRefDate@1100485001 : Date;DiscPrio@1100525000 : Code[10]);
    BEGIN
      CASE ItemOption OF
        ItemOption::Item:
          BEGIN
            BasicCde := '';
            ManufCde := '';
            TradeCde := '';
            VendorCde := '';
            ValidateInventoryItem(TradeCde,ItemCde,ManufCde,VendorCde,BasicCde,CostObject,DescTxt,UnitCde,
                                  NetPrice,DiscPerc,ItemRefDate,GrossPrice,DescTxt2,CostComp,
                                  DiscRef1,DiscRef2,PriceRefDate,DiscPrio);
          END;
        ItemOption::"Basic Item":
          BEGIN
            ItemCde := '';
            //ManufCde := '';
            TradeCde := '';
            VendorCde := '';
            ValidateBasicItem(TradeCde,ItemCde,ManufCde,VendorCde,BasicCde,CostObject,DescTxt,UnitCde,
                              NetPrice,DiscPerc,ItemRefDate,GrossPrice,DescTxt2,CostComp,
                              DiscRef1,DiscRef2,PriceRefDate,DiscPrio);
          END;
        ItemOption::"Trade Item":
          BEGIN
            ItemCde := '';
            ValidateTradeItem(TradeCde,ItemCde,ManufCde,VendorCde,BasicCde,CostObject,DescTxt,UnitCde,
                              NetPrice,DiscPerc,ItemRefDate,GrossPrice,DescTxt2,CostComp,
                              DiscRef1,DiscRef2,PriceRefDate,DiscPrio);
          END;
        ItemOption::"Trade Vendor":
          BEGIN
            ValidateTradeVendor(TradeCde,ItemCde,ManufCde,VendorCde,BasicCde,CostObject,DescTxt,UnitCde,
                                NetPrice,DiscPerc,ItemRefDate,GrossPrice,DescTxt2,CostComp,
                                DiscRef1,DiscRef2,PriceRefDate,DiscPrio);
          END;
      END;
    END;

    PROCEDURE ValidateInventoryItem@2(VAR TradeCde@11012000 : Code[20];ItemCde@11012001 : Code[20];VAR ManufCde@11012002 : Code[20];VAR VendorCde@11012003 : Code[20];VAR BasicCde@11012004 : Code[20];VAR CostObject@11012005 : Code[20];VAR DescTxt@11012006 : Text[100];VAR UnitCde@11012007 : Code[10];VAR NetPrice@11012008 : Decimal;VAR DiscPerc@11012009 : Decimal;VAR ItemRefDate@11012010 : Date;VAR GrossPrice@11012011 : Decimal;VAR DescTxt2@1210190000 : Text[50];VAR CostComp@1100485000 : Code[10];DiscRef1@1100485009 : Code[20];DiscRef2@1100485008 : Code[20];PriceRefDate@1100485001 : Date;DiscPrio@1100525000 : Code[10]);
    VAR
      lvItemRec@1100485006 : Record 27;
      ItemRelation@1100485007 : Record 11012319;
      lvTradeItemRec@1100525001 : Record 11012317;
      lvTradeItem@1100485005 : Code[20];
      lvVendor@1100485004 : Code[20];
      lvManufacturer@1100485003 : Code[20];
      lvBasicItem@1100485002 : Code[20];
      RelationLevel@1100525002 : Integer;
    BEGIN
      IF lvItemRec.GET(ItemCde) THEN BEGIN
        // Search through relation table if standard item exist as base-/trade item
        IF GetItemRelationsPresent THEN BEGIN
          ItemRelation.RESET;
          ItemRelation.SETCURRENTKEY("Navision Item");
          ItemRelation.SETRANGE("Navision Item", ItemCde);
          ItemRelation.SETRANGE("Expired (Trade Item)", FALSE);  //C002132
          IF ItemRelation.FINDFIRST THEN BEGIN
            lvVendor := ItemRelation.Vendor;
            lvTradeItem := ItemRelation."Trade Item";
            lvManufacturer := ItemRelation.Manufacturer ;
            lvBasicItem := ItemRelation."Basic Item" ;
            IF (VendorTradeItem <> lvVendor) AND (VendorTradeItem <> '') THEN BEGIN
              IF ItemRelation."GTIN Code" = '' THEN
                RelationLevel := 1;
              IF RelationLevel = 0 THEN BEGIN  //GTIN-code
                lvTradeItemRec.RESET;
                lvTradeItemRec.SETCURRENTKEY("GTIN Code (Item)");
                lvTradeItemRec.SETRANGE("GTIN Code (Item)", ItemRelation."GTIN Code");
                lvTradeItemRec.SETRANGE(Vendor, VendorTradeItem);
                IF lvTradeItemRec.FINDFIRST THEN BEGIN
                  lvVendor := lvTradeItemRec.Vendor;
                  lvTradeItem := lvTradeItemRec."Item Code";
                  lvManufacturer := lvTradeItemRec.Manufacturer ;
                  lvBasicItem := lvTradeItemRec."Product Code" ;
                END ELSE BEGIN
                  RelationLevel := RelationLevel + 1;
                END;
              END;
              IF RelationLevel = 1 THEN
                IF (ItemRelation.Manufacturer = '') OR (ItemRelation."Basic Item" = '') THEN
                  RelationLevel := 2;
              IF RelationLevel = 1 THEN BEGIN  //Basic Item
                lvTradeItemRec.RESET;
                lvTradeItemRec.SETCURRENTKEY("Product Code", Manufacturer);
                lvTradeItemRec.SETRANGE("Product Code", ItemRelation."Basic Item");
                lvTradeItemRec.SETRANGE(Manufacturer, ItemRelation.Manufacturer);
                lvTradeItemRec.SETRANGE(Vendor, VendorTradeItem);
                IF lvTradeItemRec.FINDFIRST THEN BEGIN
                  lvVendor := lvTradeItemRec.Vendor;
                  lvTradeItem := lvTradeItemRec."Item Code";
                  lvManufacturer := lvTradeItemRec.Manufacturer ;
                  lvBasicItem := lvTradeItemRec."Product Code" ;
                END;
              END;
              ItemRelation.Manufacturer := lvManufacturer;
              ItemRelation."Basic Item" := lvBasicItem;
              ItemRelation.Vendor := lvVendor;
              ItemRelation."Trade Item" := lvTradeItem;
            END;
            IF CheckPreferredVendor(lvTradeItem,ItemCde,lvManufacturer,lvVendor,lvBasicItem) THEN BEGIN
              ItemRelation."Source Type" := ItemRelation."Source Type"::"Trade Item";
              ItemRelation.Manufacturer := lvManufacturer;
              ItemRelation."Basic Item" := lvBasicItem;
              ItemRelation.Vendor := lvVendor;
              ItemRelation."Trade Item" := lvTradeItem;
            END;

            CASE ItemRelation."Source Type" OF
              ItemRelation."Source Type"::"Basic Item":
                BEGIN
                  IF BasicCde = '' THEN BEGIN
                    BasicCde := ItemRelation."Basic Item";
                    ManufCde := ItemRelation.Manufacturer;
                    ValidateBasicItem(TradeCde,ItemCde,ManufCde,VendorCde,BasicCde,CostObject,DescTxt,UnitCde,
                                      NetPrice,DiscPerc,ItemRefDate,GrossPrice,DescTxt2,CostComp,
                                      DiscRef1,DiscRef2,PriceRefDate,DiscPrio);
                  END;
                END;
              ItemRelation."Source Type"::"Trade Item":
                BEGIN
                  IF TradeCde = '' THEN BEGIN
                    BasicCde := ItemRelation."Basic Item";
                    ManufCde := ItemRelation.Manufacturer;
                    TradeCde := ItemRelation."Trade Item";
                    VendorCde := ItemRelation.Vendor;
                    ValidateTradeItem(TradeCde,ItemCde,ManufCde,VendorCde,BasicCde,CostObject,DescTxt,UnitCde,
                                      NetPrice,DiscPerc,ItemRefDate,GrossPrice,DescTxt2,CostComp,
                                      DiscRef1,DiscRef2,PriceRefDate,DiscPrio);
                  END;
                END;
            END;
          END;
        END;

        ItemCde := lvItemRec."No.";
        GetInventSetup;
        IF (NOT InventSetup."Item Info Trade Item Leading") OR (TradeCde = '') THEN
          GetNavisionItemInfo(ItemCde, DescTxt, DescTxt2, CostObject, CostComp, FALSE);
        IF (NOT InventSetup."Price Info Trade Item Leading") OR (TradeCde = '') THEN
          GetNavisionItemPrices(ItemCde, UnitCde, NetPrice, DiscPerc, GrossPrice, PriceRefDate, FALSE); //C045045
      END;
    END;

    PROCEDURE ValidateBasicItem@3(VAR TradeCde@11012000 : Code[20];VAR ItemCde@11012001 : Code[20];VAR ManufCde@11012002 : Code[20];VAR VendorCde@11012003 : Code[20];BasicCde@11012004 : Code[20];VAR CostObject@11012005 : Code[20];VAR DescTxt@11012006 : Text[100];VAR UnitCde@11012007 : Code[10];VAR NetPrice@11012008 : Decimal;VAR DiscPerc@11012009 : Decimal;VAR ItemRefDate@11012010 : Date;VAR GrossPrice@11012011 : Decimal;VAR DescTxt2@1210190000 : Text[50];VAR CostComp@1100485000 : Code[10];DiscRef1@1100485005 : Code[20];DiscRef2@1100485004 : Code[20];PriceRefDate@1100485003 : Date;DiscPrio@1100525000 : Code[10]);
    VAR
      ItemRelation@1100485001 : Record 11012319;
      lvBasicItemRec@1100485002 : Record 11012316;
      PreferredVendor@1210190001 : Record 11012318;
    BEGIN
      lvBasicItemRec.RESET;
      lvBasicItemRec.SETCURRENTKEY("Product Code", Manufacturer);
      lvBasicItemRec.SETRANGE("Product Code", BasicCde);
      IF ManufCde <> '' THEN BEGIN
        lvBasicItemRec.SETRANGE(Manufacturer, ManufCde);
        IF NOT lvBasicItemRec.FINDFIRST THEN BEGIN
          lvBasicItemRec.SETRANGE(Manufacturer);
        END;
      END;
      IF lvBasicItemRec.FINDFIRST THEN BEGIN
        ManufCde := lvBasicItemRec.Manufacturer;
        IF GetItemRelationsPresent THEN BEGIN
          IF (VendorCde = '') AND (TradeCde = '') THEN BEGIN
            PreferredVendor.RESET;
            PreferredVendor.SETCURRENTKEY(Manufacturer, "Basic Item");
            PreferredVendor.SETRANGE(Manufacturer, ManufCde);
            PreferredVendor.SETRANGE("Basic Item", BasicCde);
            PreferredVendor.SETFILTER(Vendor, '<>%1', '');
            PreferredVendor.SETFILTER("Trade Item", '<>%1', '');
            IF PreferredVendor.FINDFIRST THEN BEGIN
              VendorCde := PreferredVendor.Vendor;
              TradeCde := PreferredVendor."Trade Item";
            END;
          END;
          ItemRelation.RESET;
          ItemRelation.SETCURRENTKEY(Manufacturer, "Basic Item");
          ItemRelation.SETRANGE(Manufacturer, lvBasicItemRec.Manufacturer);
          ItemRelation.SETRANGE("Basic Item", lvBasicItemRec."Product Code");
          ItemRelation.SETRANGE("Source Type", ItemRelation."Source Type"::"Basic Item");
          ItemRelation.SETRANGE("GTIN Code", lvBasicItemRec."GTIN Code");
          IF ItemRelation.FINDFIRST THEN
            ItemCde := ItemRelation."Navision Item";
        END;

        IF GetBasicItemOnly THEN EXIT;

        CostObject := lvBasicItemRec."Cost Object";
        GetCostComponent(CostObject, CostComp);
        DescTxt := lvBasicItemRec."Product Description";
        DescTxt2 := lvBasicItemRec."Product Description 2";
        GetNavisionItemInfo(ItemCde, DescTxt, DescTxt2, CostObject, CostComp, TRUE);

        GetPriceBasicItem(lvBasicItemRec, PriceRefDate, DiscRef1, DiscRef2, DiscPrio, FALSE);
        UnitCde := lvBasicItemRec."Application Unit";
        ItemRefDate := lvBasicItemRec."Price Reference Date";
        DiscPerc := lvBasicItemRec."Discount Percentage";
        IF lvBasicItemRec."Qty. per Unit of Measure" <> 0 THEN BEGIN
          NetPrice := lvBasicItemRec."Net Price" / lvBasicItemRec."Qty. per Unit of Measure";
          GrossPrice := lvBasicItemRec."Gross Price" / lvBasicItemRec."Qty. per Unit of Measure";
        END ELSE BEGIN
          NetPrice := lvBasicItemRec."Net Price";
          GrossPrice := lvBasicItemRec."Gross Price";
        END;
      END;
    END;

    PROCEDURE ValidateTradeItem@4(VAR TradeCde@11012000 : Code[20];VAR ItemCde@11012001 : Code[20];VAR ManufCde@11012002 : Code[20];VAR VendorCde@11012003 : Code[20];VAR BasicCde@11012004 : Code[20];VAR CostObject@11012005 : Code[20];VAR DescTxt@11012006 : Text[100];VAR UnitCde@11012007 : Code[10];VAR NetPrice@11012008 : Decimal;VAR Discperc@11012009 : Decimal;VAR ItemRefDate@11012010 : Date;VAR GrossPrice@11012011 : Decimal;VAR DescTxt2@1210190000 : Text[50];VAR CostComp@1100485000 : Code[10];DiscRef1@1100485007 : Code[20];DiscRef2@1100485006 : Code[20];PriceRefDate@1100485005 : Date;DiscPrio@1100525000 : Code[10]);
    VAR
      PreferredVendor@1100485001 : Record 11012318;
      ItemRelation@1100485002 : Record 11012319;
      lvBasicItemRec@1100485003 : Record 11012316;
      lvTradeItemRec@1100485004 : Record 11012317;
      ItemVendor@1100525001 : Record 99;
      ItemRelationFound@1100409000 : Boolean;
    BEGIN
      // - VAR-parameter switched on for vendor-item in this function
      // - searchfunction changed: existing option (manual input vendor-item) extended with
      //   possibility to return vendor-item after changing vendor.

      lvTradeItemRec.RESET;
      IF TradeCde <> '' THEN BEGIN
        BasicCde := '';
        ManufCde := '';
        lvTradeItemRec.SETCURRENTKEY("Item Code");
        lvTradeItemRec.SETRANGE("Item Code", TradeCde);
        lvTradeItemRec.SETRANGE(Vendor, VendorCde);
        //this occurs when user selects vendor-item by zoom or manual input.
        //program is searching for vendor related vendor-item, based on (abusive) condition of no duplicate value for vendor-item.
      END ELSE BEGIN
        //db, 18-04-07: this variant not used anymore since 22-11-06; replaced by ValidateTradeVendor
        lvTradeItemRec.SETCURRENTKEY("Product Code");
        lvTradeItemRec.SETRANGE("Product Code", BasicCde);
        lvTradeItemRec.SETRANGE(Manufacturer, ManufCde);
        lvTradeItemRec.SETRANGE(Vendor, VendorCde);
        //this occurs when user selects another vendor for existing item.
        //clear vendor-item when function called  (for example adviced purchase-orders).
      END;
      IF lvTradeItemRec.FINDFIRST THEN BEGIN
        IF VendorCde = '' THEN
          VendorCde := lvTradeItemRec.Vendor;
        IF TradeCde = '' THEN
          TradeCde := lvTradeItemRec."Item Code";
        //db, 31-05-05: first check Item Relation based on Trade Item, second on Basic Item and EAN-code
        IF lvBasicItemRec.GET(lvTradeItemRec.Manufacturer, lvTradeItemRec."Product Code") THEN BEGIN
          ManufCde := lvTradeItemRec.Manufacturer;
          BasicCde := lvTradeItemRec."Product Code";
          GetBasicItemOnly := TRUE;
          ValidateBasicItem(TradeCde,ItemCde,ManufCde,VendorCde,BasicCde,CostObject,DescTxt,UnitCde,
                            NetPrice,Discperc,ItemRefDate,GrossPrice,DescTxt2,CostComp,
                            DiscRef1,DiscRef2,PriceRefDate,DiscPrio);
          GetBasicItemOnly := FALSE;
        END;

        PreferredVendor.RESET;
        PreferredVendor.SETCURRENTKEY(Vendor, "Trade Item");
        PreferredVendor.SETRANGE(Vendor, VendorCde);
        PreferredVendor.SETRANGE("Trade Item", TradeCde);
        PreferredVendor.SETFILTER("Navision Item", '<>%1', '');
        IF PreferredVendor.FINDFIRST THEN BEGIN
          ItemCde := PreferredVendor."Navision Item";
        END ELSE BEGIN
          IF GetItemRelationsPresent THEN BEGIN
            ItemRelation.RESET;
            ItemRelation.SETCURRENTKEY(Vendor, "Trade Item");
            ItemRelation.SETRANGE(Vendor, VendorCde);
            ItemRelation.SETRANGE("Trade Item", TradeCde);
            IF ItemRelation.FINDFIRST THEN BEGIN
              ItemCde := ItemRelation."Navision Item";
              ItemRelationFound := TRUE;
            END;
            IF NOT ItemRelationFound THEN BEGIN
              IF lvTradeItemRec."GTIN Code (Item)" <> '' THEN BEGIN
                ItemRelation.RESET;
                ItemRelation.SETCURRENTKEY("GTIN Code");
                ItemRelation.SETRANGE("GTIN Code", lvTradeItemRec."GTIN Code (Item)");
      //>>150608, SYM086
                IF DontUseSingleGTIN THEN
                  ItemRelation.SETRANGE(Vendor, VendorCde);
      //<<150608
                IF ItemRelation.FINDFIRST THEN BEGIN
                  ItemCde := ItemRelation."Navision Item";
                  ItemRelationFound := TRUE;
                END;
              END;
            END;
            IF NOT ItemRelationFound THEN BEGIN
              IF (lvTradeItemRec."Product Code" <> '') AND (lvTradeItemRec.Manufacturer <> '') THEN BEGIN
                ItemRelation.RESET;
                ItemRelation.SETCURRENTKEY(Manufacturer, "Basic Item");
                ItemRelation.SETRANGE("Basic Item", lvTradeItemRec."Product Code");
                ItemRelation.SETRANGE(Manufacturer, lvTradeItemRec.Manufacturer);
                IF ItemRelation.FINDFIRST THEN BEGIN
                  ItemCde := ItemRelation."Navision Item";
                  ItemRelationFound := TRUE;
                END;
              END;
            END;
          END;
        END;
        IF ItemCde = '' THEN BEGIN
          ItemVendor.SETRANGE("Vendor Item No.",TradeCde);
          ItemVendor.SETRANGE("Vendor (Trade Item)",VendorCde);  //C033393
          ItemVendor.SETRANGE("Source Type", ItemVendor."Source Type"::"Trade Item");  //C033393
          IF ItemVendor.FINDFIRST THEN
            ItemCde := ItemVendor."Item No.";
        END;

        CostObject := lvTradeItemRec."Cost Object";
        GetCostComponent(CostObject, CostComp);
        DescTxt := lvTradeItemRec."Item Description";
        DescTxt2 := lvTradeItemRec."Item Description 2";
        GetNavisionItemInfo(ItemCde, DescTxt, DescTxt2, CostObject, CostComp, TRUE);

        GetPriceTradeItem(lvTradeItemRec, PriceRefDate, DiscRef1, DiscRef2, DiscPrio);
        UnitCde := lvTradeItemRec."Application Unit";
        ItemRefDate := lvTradeItemRec."Price Reference Date";
        Discperc := lvTradeItemRec."Discount Percentage";
        IF lvTradeItemRec."Qty. per Unit of Measure" <> 0 THEN BEGIN
          NetPrice := lvTradeItemRec."Net Price" / lvTradeItemRec."Qty. per Unit of Measure";
          GrossPrice := lvTradeItemRec."Gross Price" / lvTradeItemRec."Qty. per Unit of Measure";
        END ELSE BEGIN
          NetPrice := lvTradeItemRec."Net Price";
          GrossPrice := lvTradeItemRec."Gross Price";
        END;
        GetNavisionItemPrices(ItemCde, UnitCde, NetPrice, Discperc, GrossPrice, PriceRefDate, TRUE); //C045045
      END;
    END;

    [External]
    PROCEDURE ValidateTradeVendor@1210190003(VAR TradeCde@11012000 : Code[20];VAR ItemCde@11012001 : Code[20];VAR ManufCde@11012002 : Code[20];VAR VendorCde@11012003 : Code[20];VAR BasicCde@11012004 : Code[20];VAR CostObject@11012005 : Code[20];VAR DescTxt@11012006 : Text[100];VAR UnitCde@11012007 : Code[10];VAR NetPrice@11012008 : Decimal;VAR DiscPerc@11012009 : Decimal;VAR ItemRefDate@11012010 : Date;VAR GrossPrice@11012011 : Decimal;VAR DescTxt2@1210190000 : Text[50];VAR CostComp@1100485000 : Code[10];DiscRef1@1100485007 : Code[20];DiscRef2@1100485006 : Code[20];PriceRefDate@1100485005 : Date;DiscPrio@1100525000 : Code[10]);
    VAR
      PreferredVendor@1100485001 : Record 11012318;
      ItemRelation@1100485002 : Record 11012319;
      lvBasicItemRec@1100485003 : Record 11012316;
      lvTradeItemRec@1100485004 : Record 11012317;
    BEGIN
      //this occurs when user selects another vendor for existing item.
      lvTradeItemRec.RESET;
      lvTradeItemRec.SETCURRENTKEY("Product Code");
      lvTradeItemRec.SETRANGE("Product Code", BasicCde);
      lvTradeItemRec.SETRANGE(Manufacturer, ManufCde);
      lvTradeItemRec.SETRANGE(Vendor, VendorCde);
      lvTradeItemRec.SETRANGE(Expired, FALSE);
      IF lvTradeItemRec.FINDFIRST THEN BEGIN
        TradeCde := lvTradeItemRec."Item Code";
        IF lvBasicItemRec.GET(lvTradeItemRec.Manufacturer, lvTradeItemRec."Product Code") THEN BEGIN
          PreferredVendor.RESET;
          PreferredVendor.SETCURRENTKEY(Vendor, "Trade Item");
          PreferredVendor.SETRANGE(Vendor, VendorCde);
          PreferredVendor.SETRANGE("Trade Item", TradeCde);
          PreferredVendor.SETFILTER("Navision Item", '<>%1', '');
          IF PreferredVendor.FINDFIRST THEN BEGIN
            ItemCde := PreferredVendor."Navision Item";
          END ELSE BEGIN
            IF GetItemRelationsPresent THEN BEGIN
              ItemRelation.RESET;
              ItemRelation.SETCURRENTKEY(Manufacturer, "Basic Item");
              ItemRelation.SETRANGE(Manufacturer, lvBasicItemRec.Manufacturer);
              ItemRelation.SETRANGE("Basic Item", lvBasicItemRec."Product Code");
              ItemRelation.SETRANGE(Vendor, VendorCde);
              ItemRelation.SETRANGE("Trade Item", TradeCde);
              IF ItemRelation.FINDFIRST THEN BEGIN
                ItemCde := ItemRelation."Navision Item";
              END ELSE BEGIN
                ItemRelation.SETRANGE(Vendor);
                ItemRelation.SETRANGE("Trade Item");
                IF ItemRelation.FINDSET THEN BEGIN
                  REPEAT
                    IF (ItemRelation."GTIN Code" <> '') AND
                     //(ItemRelation."Item Vendor" = '') AND
                       (ItemRelation."Source Type" = ItemRelation."Source Type"::"Basic Item") AND
                       (ItemRelation."Navision Item" = ItemCde) THEN
                    BEGIN
                      lvTradeItemRec.RESET;
                      lvTradeItemRec.SETCURRENTKEY("GTIN Code (Item)");
                      lvTradeItemRec.SETRANGE("GTIN Code (Item)",ItemRelation."GTIN Code");
                      lvTradeItemRec.SETRANGE(Vendor,VendorCde);
                      IF lvTradeItemRec.FINDFIRST THEN
                        TradeCde := lvTradeItemRec."Item Code";
                    END;
                  UNTIL ItemRelation.NEXT = 0;
                END;
              END;
            END;
          END;
        END;

        CostObject := lvTradeItemRec."Cost Object";
        GetCostComponent(CostObject, CostComp);
        DescTxt := lvTradeItemRec."Item Description";
        DescTxt2 := lvTradeItemRec."Item Description 2";
        GetNavisionItemInfo(ItemCde, DescTxt, DescTxt2, CostObject, CostComp, TRUE);

        GetPriceTradeItem(lvTradeItemRec, PriceRefDate, DiscRef1, DiscRef2, DiscPrio);
        UnitCde := lvTradeItemRec."Application Unit";
        ItemRefDate := lvTradeItemRec."Price Reference Date";
        DiscPerc := lvTradeItemRec."Discount Percentage";
        IF lvTradeItemRec."Qty. per Unit of Measure" <> 0 THEN BEGIN
          NetPrice := lvTradeItemRec."Net Price" / lvTradeItemRec."Qty. per Unit of Measure";
          GrossPrice := lvTradeItemRec."Gross Price" / lvTradeItemRec."Qty. per Unit of Measure";
        END ELSE BEGIN
          NetPrice := lvTradeItemRec."Net Price";
          GrossPrice := lvTradeItemRec."Gross Price";
        END;
        GetNavisionItemPrices(ItemCde, UnitCde, NetPrice, DiscPerc, GrossPrice, PriceRefDate, TRUE); //C045045
      END ELSE BEGIN
        DescTxt := PADSTR('', MAXSTRLEN(DescTxt), '*');
        DescTxt2 := PADSTR('', MAXSTRLEN(DescTxt2), '*');
      END;
    END;

    [External]
    PROCEDURE CheckPreferredVendor@1100485001(VAR TradeItemNo@11012000 : Code[20];VAR ItemNo@11012001 : Code[20];VAR Manufacturer@11012002 : Code[20];VAR VendorNo@11012003 : Code[20];VAR BasicItemNo@11012004 : Code[20]) : Boolean;
    VAR
      TradeItem@1100485001 : Record 11012317;
      PreferredVendor@1100485000 : Record 11012318;
    BEGIN
      PreferredVendor.RESET;
      PreferredVendor.SETCURRENTKEY(Type, "Navision Item", Manufacturer, "Basic Item");
      IF ItemNo <> '' THEN BEGIN
        PreferredVendor.SETRANGE(Type, PreferredVendor.Type::"Navision Item");
        PreferredVendor.SETRANGE("Navision Item", ItemNo);
      END ELSE BEGIN
        IF (Manufacturer = '') AND (BasicItemNo = '') THEN
          EXIT(FALSE);
        PreferredVendor.SETRANGE(Type, PreferredVendor.Type::"Basic Item");
        PreferredVendor.SETRANGE("Navision Item");
        PreferredVendor.SETRANGE(Manufacturer, Manufacturer);
        PreferredVendor.SETRANGE("Basic Item", BasicItemNo);
      END;
      PreferredVendor.SETFILTER("Trade Item", '<>%1', '');
      PreferredVendor.SETFILTER(Vendor, '<>%1', '');
      IF PreferredVendor.FINDFIRST THEN BEGIN
        IF TradeItem.GET(PreferredVendor.Vendor, PreferredVendor."Trade Item") THEN BEGIN
          Manufacturer := TradeItem.Manufacturer;
          BasicItemNo := TradeItem."Product Code";
          VendorNo := TradeItem.Vendor;
          TradeItemNo := TradeItem."Item Code";
          EXIT(TRUE);
        END;
      END;
      EXIT(FALSE);
    END;

    [External]
    PROCEDURE GetSalesPrice@1100525015(CustNo@1100525013 : Code[20];ItemNo@1100525012 : Code[20];BasicItemNo@1100525011 : Code[20];TradeItemNo@1100525010 : Code[20];Manufacturer@1100525009 : Code[20];VendorNo@1100525008 : Code[20];VAR NetPrice@1100525007 : Decimal;VAR DiscPerc@1100525006 : Decimal;VAR GrossPrice@1100525005 : Decimal;RefDate@1100525004 : Date;CustDiscGrp@1100525003 : Code[20];DiscRef1@1100525002 : Code[20];DiscRef2@1100525001 : Code[20];DiscPrio@1100525000 : Code[10]) SalesConditionPresent : Boolean;
    BEGIN
      //db, 13-02-18 (GrossPrice=VAR)
      CalledFromSalesPrice := TRUE;
      SalesConditionPresent := GetSalesDiscount(
        CustNo, ItemNo, BasicItemNo, TradeItemNo, Manufacturer, VendorNo,
        NetPrice, DiscPerc, GrossPrice,
        RefDate, CustDiscGrp, DiscRef1, DiscRef2, DiscPrio);
      CalledFromSalesPrice := FALSE;
      GrossPrice := gvSalesPrice;
      EXIT(SalesConditionPresent);
    END;

    [External]
    PROCEDURE GetSalesDiscount@1210190000(CustNo@1210190002 : Code[20];ItemNo@1210190011 : Code[20];BasicItemNo@1210190008 : Code[20];TradeItemNo@1210190012 : Code[20];Manufacturer@1210190006 : Code[20];VendorNo@1210190005 : Code[20];VAR NetPrice@1210190004 : Decimal;VAR DiscPerc@1210190003 : Decimal;GrossPrice@1210190001 : Decimal;RefDate@1100485000 : Date;iCustDiscGrp@1100485002 : Code[20];DiscRef1@1100525003 : Code[20];DiscRef2@1100525002 : Code[20];DiscPrio@1100525000 : Code[10]) : Boolean;
    VAR
      EtimVendor@1100485004 : Record 11012304;
      Item@1100485009 : Record 27;
      TradeItem@1100485007 : Record 11012317;
      BasicItem@1100485008 : Record 11012316;
      ItemRelation@1100409000 : Record 11012319;
      CustLevl@1210190010 : Integer;
      ItemLevl@1100485001 : Integer;
      CustPriceGrp@1100530000 : Code[20];
      CustDiscGrp@1210190009 : Code[20];
      ItemDiscGrp@1210190014 : Code[20];
      DefCust@1100485003 : Code[20];
      DiscPrice@1100525008 : Decimal;
      SalesPrice@1100525001 : Decimal;
      MaxCustLevl@1100525005 : Integer;
      MaxItemLevl@1100525006 : Integer;
      DiscFound@1100525007 : Boolean;
      PriceFound@1210190000 : Boolean;
      lvPriceHistRec@1100409001 : Record 11012315;
    BEGIN
      IF ItemNo + BasicItemNo + TradeItemNo = '' THEN EXIT;  //for cost object no discountgroup defined.

      GetGLSetup;
      GetInventSetup;
      DefCust := InventSetup."Default Customer";

      CustLevl := 0;
      ItemLevl := 0;
      DiscPerc := 0;
      MaxCustLevl := 1;
      MaxItemLevl := 2;
      NetPrice := GrossPrice;
      gvFoundSalesDiscRef := '';
      IF InventSetup."Use UnitPrice at ItemRelation" THEN BEGIN  //C010501
        IF (ItemNo <> '') AND (TradeItemNo <> '') THEN
          IF ItemRelation.GET(ItemNo) THEN
            ItemLevl := 2;  //ignore discount TradeItem and only check NavItem (price+discount)
        IF ItemLevl = 2 THEN BEGIN
          Item.GET(ItemNo);
          NetPrice := Item."Unit Price";
        END;
      END;

      //>> ANCA 150527 IME-355
      IF (PriceListCode <> '' ) THEN BEGIN
        lvPriceHistRec.SETCURRENTKEY("Item Code", "Starting Date", "Price List Code");
        lvPriceHistRec.SETRANGE("Item Code", TradeItemNo);
        lvPriceHistRec.SETRANGE("Starting Date", 0D, RefDate);
        lvPriceHistRec.SETRANGE("Price List Code",PriceListCode);

        IF lvPriceHistRec.FINDLAST THEN BEGIN
          VendorNo := lvPriceHistRec.Vendor;
          LatestCustGrossPrice := lvPriceHistRec."Gross Price";
          PriceHistFound := TRUE;
          PriceListVendorNo := lvPriceHistRec.Vendor;
        END ELSE BEGIN
          LatestCustGrossPrice := GrossPrice;
        END;
      END ELSE BEGIN
        LatestCustGrossPrice := GrossPrice;  //150912 ITERO.AC IME413
      END;
      //<< IME-355

      REPEAT  //check both discount levels on sequence Trade-Basic-Navision Item
        REPEAT
          IF CustLevl = 0 THEN
            IF NOT GetCust(CustNo) THEN
              CustLevl := 1;  //for dummy contract without customer
          IF CustLevl = 1 THEN
            IF NOT GetCust(DefCust) THEN;
          IF (iCustDiscGrp <> '') THEN
            CustDiscGrp := iCustDiscGrp  //preselected CustGrp (estimate)
          ELSE
            CustDiscGrp := Customer."Customer Disc. Group";
          CustPriceGrp := Customer."Customer Price Group";

          IF (TradeItemNo <> '') AND (VendorNo <> '') AND (ItemLevl = 0) THEN BEGIN
            IF TradeItem.GET(VendorNo, TradeItemNo) THEN BEGIN
              IF EvaluateSalesDiscount(TradeItem, DiscPrice, DiscPerc, GrossPrice, CustNo, CustDiscGrp,
                RefDate, DiscRef1, DiscRef2, DiscPrio) THEN
                  gvFoundSalesDiscRef := DiscRef1;  // 150914 ITERO.AC RFC001-2
                DiscFound := TRUE;
            END;
          END;

          IF (BasicItemNo <> '') AND (Manufacturer <> '') AND (ItemLevl = 1) AND
             (TradeItemNo = '') AND (VendorNo = '') THEN BEGIN
            IF TradeItem.GET(Manufacturer, BasicItemNo) THEN BEGIN
              IF EvaluateSalesDiscount(TradeItem, DiscPrice, DiscPerc, GrossPrice, CustNo, CustDiscGrp,
                RefDate, DiscRef1, DiscRef2, DiscPrio) THEN
                DiscFound := TRUE;
            END;
            IF NOT EtimVendor.GET(Manufacturer) THEN
              EtimVendor.INIT
            ELSE
              EtimVendor.CALCFIELDS("Vendor (Price/Discount)");
            IF EtimVendor."Vendor (Price/Discount)" <> '' THEN BEGIN
              TradeItem.RESET;
              TradeItem.SETCURRENTKEY("Product Code");
              TradeItem.SETRANGE("Product Code", BasicItemNo);
              TradeItem.SETRANGE(Manufacturer, Manufacturer);
              TradeItem.SETRANGE(Vendor, EtimVendor."Vendor (Price/Discount)");
              IF TradeItem.FINDFIRST THEN BEGIN
                IF EvaluateSalesDiscount(TradeItem, DiscPrice, DiscPerc, GrossPrice, CustNo, CustDiscGrp,
                  RefDate, DiscRef1, DiscRef2, DiscPrio) THEN
                  DiscFound := TRUE;
              END;
            END;
            IF BasicItem.GET(Manufacturer, BasicItemNo) THEN BEGIN
              TradeItem.RESET;
              TradeItem.SETCURRENTKEY("Product Code");
              TradeItem.SETRANGE("Product Code", BasicItemNo);
              TradeItem.SETRANGE(Manufacturer, Manufacturer);
              TradeItem.SETRANGE("GTIN Code (Item)", BasicItem."GTIN Code");
              IF TradeItem.FINDFIRST THEN BEGIN
                IF EvaluateSalesDiscount(TradeItem, DiscPrice, DiscPerc, GrossPrice, CustNo, CustDiscGrp,
                  RefDate, DiscRef1, DiscRef2, DiscPrio) THEN
                  DiscFound := TRUE;
              END;
            END;
          END;

          IF (ItemNo <> '') AND (ItemLevl = 2) THEN BEGIN
            IF GetSalesPriceItem(CustNo, CustPriceGrp, ItemNo, RefDate, SalesPrice) THEN BEGIN
              IF NOT PriceFound THEN BEGIN
                NetPrice := SalesPrice;
              END ELSE BEGIN
                IF SalesPrice < NetPrice THEN
                  NetPrice := SalesPrice;
              END;
              PriceFound := TRUE;
            END;
            IF DiscountPercItemPresent(CustNo, CustDiscGrp, ItemNo, RefDate, DiscPerc) THEN BEGIN
              //DiscPrice := ((100 - DiscPerc)/100 ) * GrossPrice;
              DiscFound := TRUE;
            END ELSE BEGIN
              IF Item.GET(ItemNo) THEN BEGIN
                ItemDiscGrp := Item."Item Disc. Group";
                IF DiscountPercItemGroupPresent(CustNo, CustDiscGrp, ItemDiscGrp, RefDate, DiscPerc) THEN BEGIN
                  //DiscPrice := ((100 - DiscPerc)/100 ) * GrossPrice;
                  DiscFound := TRUE;
                END;
              END;
            END;
          END;
          CustLevl := CustLevl + 1;
        UNTIL (CustLevl > MaxCustLevl) OR DiscFound;
        CustLevl := 0;
        ItemLevl := ItemLevl + 1;
      UNTIL (ItemLevl > MaxItemLevl) OR DiscFound;

      IF CalledFromSalesPrice THEN BEGIN  //db, 13-02-18
        gvSalesPrice := NetPrice;
        NetPrice := ((100 - DiscPerc)/100 ) * gvSalesPrice;
      END ELSE BEGIN
        DiscPrice := ((100 - DiscPerc)/100 ) * NetPrice;
        IF GrossPrice <> 0 THEN BEGIN
          DiscPerc := ((GrossPrice - DiscPrice) / GrossPrice) * 100;
          NetPrice := ((100 - DiscPerc)/100 ) * GrossPrice;
        END ELSE BEGIN
          NetPrice := DiscPrice;
        END;
      END;

      EXIT(DiscFound OR PriceFound);  //C015604
    END;

    [External]
    PROCEDURE DiscountPercItemGroupPresent@1210190004(CustNo@1100525001 : Code[20];CustGrp@1210190001 : Code[20];ItemGrp@1210190000 : Code[20];RefDate@1100525000 : Date;VAR DiscPerc@1210190003 : Decimal) : Boolean;
    VAR
      SalesLineDiscount@1210190002 : Record 7004;
    BEGIN
      WITH SalesLineDiscount DO BEGIN
        SETRANGE(Type, Type::"Item Disc. Group");
        SETRANGE(Code, ItemGrp);
        SETRANGE("Sales Type", "Sales Type"::Customer);
        SETRANGE("Sales Code", CustNo);
        SETRANGE("Starting Date", 0D, RefDate);
        SETFILTER("Ending Date", '%1|>=%2', 0D, RefDate);
        SETFILTER("Minimum Quantity", '..%1', ABS(QuanDec));
        IF FINDLAST THEN BEGIN
          DiscPerc := "Line Discount %";
          IF ShowSalesDiscount THEN
            PAGE.RUNMODAL(0, SalesLineDiscount);
          EXIT(TRUE);
        END ELSE BEGIN
          SETRANGE("Sales Type", "Sales Type"::"Customer Disc. Group");
          SETRANGE("Sales Code", CustGrp);
          IF FINDLAST THEN BEGIN
            DiscPerc := "Line Discount %";
            IF ShowSalesDiscount THEN
              PAGE.RUNMODAL(0, SalesLineDiscount);
            EXIT(TRUE);
          END ELSE BEGIN
            SETRANGE("Sales Type", "Sales Type"::"All Customers");
            SETFILTER("Sales Code", '%1', '');
            IF FINDLAST THEN BEGIN
              DiscPerc := "Line Discount %";
              IF ShowSalesDiscount THEN
                PAGE.RUNMODAL(0, SalesLineDiscount);
              EXIT(TRUE);
            END;
          END;
        END;
      END;

      DiscPerc := 0;
      EXIT(FALSE);
    END;

    [External]
    PROCEDURE DiscountPercItemPresent@1100485000(CustNo@1100485003 : Code[20];CustGrp@1100525000 : Code[20];ItemNo@1100485002 : Code[20];RefDate@1100485001 : Date;VAR DiscPerc@1100485000 : Decimal) : Boolean;
    VAR
      SalesLineDiscount@1210190002 : Record 7004;
    BEGIN
      WITH SalesLineDiscount DO BEGIN
        SETRANGE(Type, Type::Item);
        SETRANGE(Code, ItemNo);
        SETRANGE("Sales Type", "Sales Type"::Customer);
        SETRANGE("Sales Code", CustNo);
        SETRANGE("Starting Date", 0D, RefDate);
        SETFILTER("Ending Date", '%1|>=%2', 0D, RefDate);
        SETFILTER("Minimum Quantity", '..%1', ABS(QuanDec));
        IF FINDLAST THEN BEGIN
          DiscPerc := "Line Discount %";
          IF ShowSalesDiscount THEN
            PAGE.RUNMODAL(0, SalesLineDiscount);
          EXIT(TRUE);
        END ELSE BEGIN
          SETRANGE("Sales Type", "Sales Type"::"Customer Disc. Group");
          SETRANGE("Sales Code", CustGrp);
          IF FINDLAST THEN BEGIN
            DiscPerc := "Line Discount %";
            IF ShowSalesDiscount THEN
              PAGE.RUNMODAL(0, SalesLineDiscount);
            EXIT(TRUE);
          END ELSE BEGIN
            SETRANGE("Sales Type", "Sales Type"::"All Customers");
            SETFILTER("Sales Code", '%1', '');
            IF FINDLAST THEN BEGIN
              DiscPerc := "Line Discount %";
              IF ShowSalesDiscount THEN
                PAGE.RUNMODAL(0, SalesLineDiscount);
              EXIT(TRUE);
            END;
          END;
        END;
      END;

      DiscPerc := 0;
      EXIT(FALSE);
    END;

    [External]
    PROCEDURE GetSalesDiscountSurcharge@110128000(CustNo@1210190002 : Code[20];ItemNo@1210190011 : Code[20];BasicItemNo@1210190008 : Code[20];TradeItemNo@1210190012 : Code[20];Manufacturer@1210190006 : Code[20];VendorNo@1210190005 : Code[20];VAR NetPrice@1210190004 : Decimal;VAR DiscPerc@1210190003 : Decimal;GrossPrice@1210190001 : Decimal;RefDate@1100485000 : Date;iCustDiscGrp@1100485002 : Code[20];DiscRef1@1100525003 : Code[20];DiscRef2@1100525002 : Code[20];DiscPrio@1100525000 : Code[10];JobNo@110128003 : Code[20]) : Boolean;
    VAR
      EtimVendor@1100485004 : Record 11012304;
      Item@1100485009 : Record 27;
      TradeItem@1100485007 : Record 11012317;
      BasicItem@1100485008 : Record 11012316;
      ItemRelation@1100409000 : Record 11012319;
      CustLevl@1210190010 : Integer;
      ItemLevl@1100485001 : Integer;
      CustPriceGrp@1100530000 : Code[20];
      CustDiscGrp@1210190009 : Code[20];
      ItemDiscGrp@1210190014 : Code[20];
      DefCust@1100485003 : Code[20];
      DiscPrice@1100525008 : Decimal;
      SalesPrice@1100525001 : Decimal;
      MaxCustLevl@1100525005 : Integer;
      MaxItemLevl@1100525006 : Integer;
      DiscFound@1100525007 : Boolean;
      PriceFound@1210190000 : Boolean;
      lvPriceHistRec@1100409001 : Record 11012315;
      CustDiscRec@110128000 : Record 340;
      SurchargePerc@110128001 : Decimal;
      SurchargeFound@110128002 : Boolean;
      Cust@1000000000 : Record 18;
      Job@1000000001 : Record 11072003;
    BEGIN
      IF ItemNo + BasicItemNo + TradeItemNo = '' THEN EXIT;  //for cost object no discountgroup defined.

      GetGLSetup;
      GetInventSetup;
      DefCust := InventSetup."Default Customer";

      CustLevl := 0;
      ItemLevl := 0;
      DiscPerc := 0;
      SurchargePerc := 0;
      MaxCustLevl := 1;
      MaxItemLevl := 2;
      NetPrice := GrossPrice;
      gvFoundSalesDiscRef := '';
      IF InventSetup."Use UnitPrice at ItemRelation" THEN BEGIN  //C010501
        IF (ItemNo <> '') AND (TradeItemNo <> '') THEN
          IF ItemRelation.GET(ItemNo) THEN
            ItemLevl := 2;  //ignore discount TradeItem and only check NavItem (price+discount)
        IF ItemLevl = 2 THEN BEGIN
          Item.GET(ItemNo);
          NetPrice := Item."Unit Price";
        END;
      END;

      //>> ANCA 150527 IME-355
      IF (PriceListCode <> '' ) THEN BEGIN
        lvPriceHistRec.SETCURRENTKEY("Item Code", "Starting Date", "Price List Code");
        lvPriceHistRec.SETRANGE("Item Code", TradeItemNo);
        lvPriceHistRec.SETRANGE("Starting Date", 0D, RefDate);
        lvPriceHistRec.SETRANGE("Price List Code",PriceListCode);

        IF lvPriceHistRec.FINDLAST THEN BEGIN
          VendorNo := lvPriceHistRec.Vendor;
          LatestCustGrossPrice := lvPriceHistRec."Gross Price";
          PriceHistFound := TRUE;
          PriceListVendorNo := lvPriceHistRec.Vendor;
        END ELSE BEGIN
          LatestCustGrossPrice := GrossPrice;
        END;
      END ELSE BEGIN
        LatestCustGrossPrice := GrossPrice;  //150912 ITERO.AC IME413
      END;
      //<< IME-355

      REPEAT  //check both discount levels on sequence Trade-Basic-Navision Item
        REPEAT
          IF CustLevl = 0 THEN
            IF NOT GetCust(CustNo) THEN
              CustLevl := 1;  //for dummy contract without customer
          IF CustLevl = 1 THEN
            IF NOT GetCust(DefCust) THEN;
          IF (iCustDiscGrp <> '') THEN
            CustDiscGrp := iCustDiscGrp  //preselected CustGrp (estimate)
          ELSE
            CustDiscGrp := Customer."Customer Disc. Group";
          CustPriceGrp := Customer."Customer Price Group";

          IF (TradeItemNo <> '') AND (VendorNo <> '') AND (ItemLevl = 0) THEN BEGIN
            IF TradeItem.GET(VendorNo, TradeItemNo) THEN BEGIN
              IF EvaluateSalesDiscount(TradeItem, DiscPrice, DiscPerc, GrossPrice, CustNo, CustDiscGrp,
                RefDate, DiscRef1, DiscRef2, DiscPrio) THEN
                  gvFoundSalesDiscRef := DiscRef1;  // 150914 ITERO.AC RFC001-2
                DiscFound := TRUE;
            END;
          END;

          IF (BasicItemNo <> '') AND (Manufacturer <> '') AND (ItemLevl = 1) AND
             (TradeItemNo = '') AND (VendorNo = '') THEN BEGIN
            IF TradeItem.GET(Manufacturer, BasicItemNo) THEN BEGIN
              IF EvaluateSalesDiscount(TradeItem, DiscPrice, DiscPerc, GrossPrice, CustNo, CustDiscGrp,
                RefDate, DiscRef1, DiscRef2, DiscPrio) THEN
                DiscFound := TRUE;
            END;
            IF NOT EtimVendor.GET(Manufacturer) THEN
              EtimVendor.INIT
            ELSE
              EtimVendor.CALCFIELDS("Vendor (Price/Discount)");
            IF EtimVendor."Vendor (Price/Discount)" <> '' THEN BEGIN
              TradeItem.RESET;
              TradeItem.SETCURRENTKEY("Product Code");
              TradeItem.SETRANGE("Product Code", BasicItemNo);
              TradeItem.SETRANGE(Manufacturer, Manufacturer);
              TradeItem.SETRANGE(Vendor, EtimVendor."Vendor (Price/Discount)");
              IF TradeItem.FINDFIRST THEN BEGIN
                IF EvaluateSalesDiscount(TradeItem, DiscPrice, DiscPerc, GrossPrice, CustNo, CustDiscGrp,
                  RefDate, DiscRef1, DiscRef2, DiscPrio) THEN
                  DiscFound := TRUE;
              END;
            END;
            IF BasicItem.GET(Manufacturer, BasicItemNo) THEN BEGIN
              TradeItem.RESET;
              TradeItem.SETCURRENTKEY("Product Code");
              TradeItem.SETRANGE("Product Code", BasicItemNo);
              TradeItem.SETRANGE(Manufacturer, Manufacturer);
              TradeItem.SETRANGE("GTIN Code (Item)", BasicItem."GTIN Code");
              IF TradeItem.FINDFIRST THEN BEGIN
                IF EvaluateSalesDiscount(TradeItem, DiscPrice, DiscPerc, GrossPrice, CustNo, CustDiscGrp,
                  RefDate, DiscRef1, DiscRef2, DiscPrio) THEN
                  DiscFound := TRUE;
              END;
            END;
          END;

          IF (ItemNo <> '') AND (ItemLevl = 2) THEN BEGIN
            IF GetSalesPriceItem(CustNo, CustPriceGrp, ItemNo, RefDate, SalesPrice) THEN BEGIN
              IF NOT PriceFound THEN BEGIN
                NetPrice := SalesPrice;
              END ELSE BEGIN
                IF SalesPrice < NetPrice THEN
                  NetPrice := SalesPrice;
              END;
              PriceFound := TRUE;
            END;
            IF CustDiscRec.GET(CustDiscGrp) THEN BEGIN
              IF CustDiscRec."Surcharge Purchase Price" THEN BEGIN
                IF SurchargePercItemPresent(CustNo, CustDiscGrp, ItemNo, RefDate, SurchargePerc,JobNo) THEN BEGIN
                  SurchargeFound := TRUE;
                END ELSE BEGIN
                  IF Item.GET(ItemNo) THEN BEGIN
                    ItemDiscGrp := Item."Item Disc. Group";
                    IF SurchargePercItemGroupPresent(CustNo, CustDiscGrp, ItemDiscGrp, RefDate, SurchargePerc,JobNo) THEN BEGIN
                      SurchargeFound := TRUE;
                    END;
                  END;
                END;
              END ELSE BEGIN
                IF DiscountPercItemPresent(CustNo, CustDiscGrp, ItemNo, RefDate, DiscPerc) THEN BEGIN
                  DiscFound := TRUE;
                END ELSE BEGIN
                  IF Item.GET(ItemNo) THEN BEGIN
                    ItemDiscGrp := Item."Item Disc. Group";
                    IF DiscountPercItemGroupPresent(CustNo, CustDiscGrp, ItemDiscGrp, RefDate, DiscPerc) THEN BEGIN
                      DiscFound := TRUE;
                    END;
                  END;
                END;
              END;
            END ELSE BEGIN
              IF DiscountPercItemPresent(CustNo, CustDiscGrp, ItemNo, RefDate, DiscPerc) THEN BEGIN
                DiscFound := TRUE;
              END ELSE BEGIN
                IF Item.GET(ItemNo) THEN BEGIN
                  ItemDiscGrp := Item."Item Disc. Group";
                  IF DiscountPercItemGroupPresent(CustNo, CustDiscGrp, ItemDiscGrp, RefDate, DiscPerc) THEN BEGIN
                    //DiscPrice := ((100 - DiscPerc)/100 ) * GrossPrice;
                    DiscFound := TRUE;
                  END;
                END;
              END;
            END;
          END;
          CustLevl := CustLevl + 1;
        UNTIL (CustLevl > MaxCustLevl) OR DiscFound;
        CustLevl := 0;
        ItemLevl := ItemLevl + 1;
      UNTIL (ItemLevl > MaxItemLevl) OR DiscFound;
      IF CalledFromSalesPrice THEN BEGIN  //db, 13-02-18
        gvSalesPrice := NetPrice;
        NetPrice := ((100 - DiscPerc)/100 ) * gvSalesPrice;
      END ELSE BEGIN
        IF SurchargeFound THEN BEGIN
            NetPrice := GrossPrice;
            DiscPerc := SurchargePerc;
        END ELSE BEGIN
          IF Job.GET(JobNo) THEN BEGIN
            SurchargePerc := Job."Surcharge % Purchase Price";
            NetPrice := GrossPrice;
            DiscPerc := SurchargePerc;
            SurchargeFound := TRUE;
          END;
          IF SurchargePerc = 0 THEN BEGIN
            IF Cust.GET(CustNo) THEN BEGIN
              SurchargePerc := Cust."Surcharge % Purchase Price";
              NetPrice := GrossPrice;
              DiscPerc := SurchargePerc;
              SurchargeFound := TRUE;
            END;
          END;
          IF NOT SurchargeFound THEN BEGIN
            DiscPrice := ((100 - DiscPerc)/100 ) * NetPrice;
            IF GrossPrice <> 0 THEN BEGIN
              DiscPerc := ((GrossPrice - DiscPrice) / GrossPrice) * 100;
              NetPrice := ((100 - DiscPerc)/100 ) * GrossPrice;
            END ELSE BEGIN
              NetPrice := DiscPrice;
            END;
          END;
        END;
      END;

      EXIT(DiscFound OR PriceFound OR SurchargeFound);
    END;

    [External]
    PROCEDURE SurchargePercItemGroupPresent@110128003(CustNo@1100525001 : Code[20];CustGrp@1210190001 : Code[20];ItemGrp@1210190000 : Code[20];RefDate@1100525000 : Date;VAR SurchargePerc@1210190003 : Decimal;JobNo@110128002 : Code[20]) : Boolean;
    VAR
      SalesLineDiscount@1210190002 : Record 7004;
      Cust@110128000 : Record 18;
      Job@110128001 : Record 11072003;
    BEGIN
      WITH SalesLineDiscount DO BEGIN
        SETRANGE(Type, Type::"Item Disc. Group");
        SETRANGE(Code, ItemGrp);
        SETRANGE("Sales Type", "Sales Type"::Customer);
        SETRANGE("Sales Code", CustNo);
        SETRANGE("Starting Date", 0D, RefDate);
        SETFILTER("Ending Date", '%1|>=%2', 0D, RefDate);
        SETFILTER("Minimum Quantity", '..%1', ABS(QuanDec));
        IF FINDLAST THEN BEGIN
          SurchargePerc := "Surcharge %";
          IF ShowSalesDiscount THEN
            PAGE.RUNMODAL(0, SalesLineDiscount);
          IF SurchargePerc = 0 THEN BEGIN
            IF Cust.GET(CustNo) THEN BEGIN
              SurchargePerc := Cust."Surcharge % Purchase Price";
            END;
          END;
          IF SurchargePerc = 0 THEN BEGIN
            IF Job.GET(JobNo) THEN BEGIN
              SurchargePerc := Job."Surcharge % Purchase Price";
            END;
          END;
          EXIT(TRUE);
        END ELSE BEGIN
          SETRANGE("Sales Type", "Sales Type"::"Customer Disc. Group");
          SETRANGE("Sales Code", CustGrp);
          IF FINDLAST THEN BEGIN
            SurchargePerc := "Surcharge %";
            IF ShowSalesDiscount THEN
              PAGE.RUNMODAL(0, SalesLineDiscount);
            IF SurchargePerc = 0 THEN BEGIN
              IF Cust.GET(CustNo) THEN BEGIN
                SurchargePerc := Cust."Surcharge % Purchase Price";
              END;
            END;
            IF SurchargePerc = 0 THEN BEGIN
              IF Job.GET(JobNo) THEN BEGIN
                SurchargePerc := Job."Surcharge % Purchase Price";
              END;
            END;
            EXIT(TRUE);
          END ELSE BEGIN
            SETRANGE("Sales Type", "Sales Type"::"All Customers");
            SETFILTER("Sales Code", '%1', '');
            IF FINDLAST THEN BEGIN
              SurchargePerc := "Surcharge %";
              IF ShowSalesDiscount THEN
                PAGE.RUNMODAL(0, SalesLineDiscount);
              IF SurchargePerc = 0 THEN BEGIN
                IF Cust.GET(CustNo) THEN BEGIN
                  SurchargePerc := Cust."Surcharge % Purchase Price";
                END;
              END;
              IF SurchargePerc = 0 THEN BEGIN
                IF Job.GET(JobNo) THEN BEGIN
                  SurchargePerc := Job."Surcharge % Purchase Price";
                END;
              END;
              EXIT(TRUE);
            END;
          END;
        END;
      END;

      IF SurchargePerc = 0 THEN BEGIN
        IF Cust.GET(CustNo) THEN BEGIN
          SurchargePerc := Cust."Surcharge % Purchase Price";
          IF SurchargePerc <> 0 THEN
            EXIT(TRUE);
        END;
      END;
      IF SurchargePerc = 0 THEN BEGIN
        IF Job.GET(JobNo) THEN BEGIN
          SurchargePerc := Job."Surcharge % Purchase Price";
          IF SurchargePerc <> 0 THEN
            EXIT(TRUE);
        END;
      END;

      SurchargePerc := 0;
      EXIT(FALSE);
    END;

    [External]
    PROCEDURE SurchargePercItemPresent@110128001(CustNo@1100485003 : Code[20];CustGrp@1100525000 : Code[20];ItemNo@1100485002 : Code[20];RefDate@1100485001 : Date;VAR SurchargePerc@1100485000 : Decimal;JobNo@110128002 : Code[20]) : Boolean;
    VAR
      SalesLineDiscount@1210190002 : Record 7004;
      Cust@110128000 : Record 18;
      Job@110128001 : Record 11072003;
    BEGIN
      WITH SalesLineDiscount DO BEGIN
        SETRANGE(Type, Type::Item);
        SETRANGE(Code, ItemNo);
        SETRANGE("Sales Type", "Sales Type"::Customer);
        SETRANGE("Sales Code", CustNo);
        SETRANGE("Starting Date", 0D, RefDate);
        SETFILTER("Ending Date", '%1|>=%2', 0D, RefDate);
        SETFILTER("Minimum Quantity", '..%1', ABS(QuanDec));
        IF FINDLAST THEN BEGIN
          SurchargePerc := "Surcharge %";
          IF ShowSalesDiscount THEN
            PAGE.RUNMODAL(0, SalesLineDiscount);
          IF SurchargePerc = 0 THEN BEGIN
            IF Cust.GET(CustNo) THEN BEGIN
              SurchargePerc := Cust."Surcharge % Purchase Price";
            END;
          END;
          IF SurchargePerc = 0 THEN BEGIN
            IF Job.GET(JobNo) THEN BEGIN
              SurchargePerc := Job."Surcharge % Purchase Price";
            END;
          END;
          EXIT(TRUE);
        END ELSE BEGIN
          SETRANGE("Sales Type", "Sales Type"::"Customer Disc. Group");
          SETRANGE("Sales Code", CustGrp);
          IF FINDLAST THEN BEGIN
            SurchargePerc := "Surcharge %";
            IF ShowSalesDiscount THEN
              PAGE.RUNMODAL(0, SalesLineDiscount);
            IF SurchargePerc = 0 THEN BEGIN
              IF Cust.GET(CustNo) THEN BEGIN
                SurchargePerc := Cust."Surcharge % Purchase Price";
              END;
            END;
            IF SurchargePerc = 0 THEN BEGIN
              IF Job.GET(JobNo) THEN BEGIN
                SurchargePerc := Job."Surcharge % Purchase Price";
              END;
            END;
            EXIT(TRUE);
          END ELSE BEGIN
            SETRANGE("Sales Type", "Sales Type"::"All Customers");
            SETFILTER("Sales Code", '%1', '');
            IF FINDLAST THEN BEGIN
              SurchargePerc := "Surcharge %";
              IF ShowSalesDiscount THEN
                PAGE.RUNMODAL(0, SalesLineDiscount);
              IF SurchargePerc = 0 THEN BEGIN
                IF Cust.GET(CustNo) THEN BEGIN
                  SurchargePerc := Cust."Surcharge % Purchase Price";
                END;
              END;
              IF SurchargePerc = 0 THEN BEGIN
                IF Job.GET(JobNo) THEN BEGIN
                  SurchargePerc := Job."Surcharge % Purchase Price";
                END;
              END;
              EXIT(TRUE);
            END;
          END;
        END;
      END;

      IF SurchargePerc = 0 THEN BEGIN
        IF Cust.GET(CustNo) THEN BEGIN
          SurchargePerc := Cust."Surcharge % Purchase Price";
          IF SurchargePerc <> 0 THEN
            EXIT(TRUE);
        END;
      END;
      IF SurchargePerc = 0 THEN BEGIN
        IF Job.GET(JobNo) THEN BEGIN
          SurchargePerc := Job."Surcharge % Purchase Price";
          IF SurchargePerc <> 0 THEN
            EXIT(TRUE);
        END;
      END;

      SurchargePerc := 0;
      EXIT(FALSE);
    END;

    [External]
    PROCEDURE GetSalesPriceItem@1210190010(CustNo@1100485002 : Code[20];CustGrp@1100525000 : Code[20];ItemNo@1100485001 : Code[20];RefDate@1100485000 : Date;VAR UnitPrice@1210190000 : Decimal) : Boolean;
    VAR
      SalesPrice@1210190001 : Record 7002;
    BEGIN
      WITH SalesPrice DO BEGIN
        SETRANGE("Item No.", ItemNo);
        SETRANGE("Sales Type", "Sales Type"::Customer);
        SETRANGE("Sales Code", CustNo);
        SETRANGE("Starting Date", 0D, RefDate);
        SETFILTER("Ending Date", '%1|>=%2', 0D, RefDate);
        SETFILTER("Minimum Quantity", '..%1', ABS(QuanDec));
        IF FINDLAST THEN BEGIN
          UnitPrice := "Unit Price";
          IF ShowSalesDiscount THEN
            PAGE.RUNMODAL(0, SalesPrice);
          EXIT(TRUE);
        END ELSE BEGIN
          SETRANGE("Sales Type", "Sales Type"::"Customer Price Group");
          SETRANGE("Sales Code", CustGrp);
          IF FINDLAST THEN BEGIN
            UnitPrice := "Unit Price";
            IF ShowSalesDiscount THEN
              PAGE.RUNMODAL(0, SalesPrice);
            EXIT(TRUE);
          END ELSE BEGIN
            SETRANGE("Sales Type", "Sales Type"::"All Customers");
            SETFILTER("Sales Code", '%1', '');
            IF FINDLAST THEN BEGIN
              UnitPrice := "Unit Price";
              IF ShowSalesDiscount THEN
                PAGE.RUNMODAL(0, SalesPrice);
              EXIT(TRUE);
            END;
          END;
        END;
      END;

      UnitPrice := 0;
      EXIT(FALSE);
    END;

    [External]
    PROCEDURE ValidateUnit@1210190002(ItemOption@11012000 : 'Item,Basic Item,Trade Item,,Trade Vendor';ItemNo@11012001 : Code[20];BasicItemNo@11012002 : Code[20];TradeItemNo@11012003 : Code[20];Manufacturer@11012005 : Code[20];VendorNo@11012006 : Code[20];VAR QuanDec@11012009 : Decimal;UnitCode@1210190000 : Code[10];VAR FactDec@1210190002 : Decimal);
    VAR
      Item@1100485003 : Record 27;
      ItemUnitofMeasure@1210190003 : Record 5404;
      BasicItem@1100485002 : Record 11012316;
      TradeItem@1100485001 : Record 11012317;
      QuanOld@1210190001 : Decimal;
      FactOld@1210190004 : Decimal;
      lvText000@1100485000 : TextConst 'ENU=Unit is %7, only switch between %1 %2 and %3 %4 supported for %5 %6.;SVE=Enheten r %7, byte mellan %1 %2 och %3 %4 stds fr %5 %6.';
    BEGIN
      QuanOld := QuanDec;
      FactOld := FactDec;

      IF ItemOption <> ItemOption::Item THEN BEGIN
        ItemSetup.GET;
        IF ItemSetup."Check Price/Quantity by Unit" <> ItemSetup."Check Price/Quantity by Unit"::Convert THEN EXIT;
      END;

      CASE ItemOption OF
        ItemOption::Item:
          BEGIN
            IF Item.GET(ItemNo) THEN BEGIN
              IF FactOld <> 0 THEN BEGIN
                QuanDec := QuanDec * FactOld;
                FactDec := FactDec / FactOld;
              END;
              IF NOT ItemUnitofMeasure.GET(ItemNo, UnitCode) THEN
                ItemUnitofMeasure.INIT;
              IF ItemUnitofMeasure."Qty. per Unit of Measure" <> 0 THEN BEGIN
                QuanDec := QuanDec / ItemUnitofMeasure."Qty. per Unit of Measure";
                FactDec := FactDec * ItemUnitofMeasure."Qty. per Unit of Measure";
              END;
              IF QuanOld <> QuanDec THEN BEGIN
                IF Item."Rounding in Decimals" THEN
                  QuanDec := ROUND(QuanDec, 0.00001, '=')
                ELSE
                  QuanDec := ROUND(QuanDec, 1, '>');
              END;
            END;
          END;
        ItemOption::"Basic Item":
          BEGIN
            IF BasicItem.GET(Manufacturer, BasicItemNo) THEN BEGIN
              IF BasicItem."Qty. per Unit of Measure" = 0 THEN
                BasicItem."Qty. per Unit of Measure" := 1;
              IF UnitCode = UPPERCASE(BasicItem."Application Unit") THEN BEGIN
                QuanDec := QuanDec * BasicItem."Qty. per Unit of Measure";
                FactDec := FactDec / BasicItem."Qty. per Unit of Measure";
              END ELSE BEGIN
                IF UnitCode = UPPERCASE(BasicItem."Packaging Unit") THEN BEGIN
                  QuanDec := QuanDec / BasicItem."Qty. per Unit of Measure";
                  FactDec := FactDec * BasicItem."Qty. per Unit of Measure";
                END ELSE BEGIN
                  IF SkipError THEN EXIT;
                  ERROR(lvText000,
                    BasicItem.FIELDCAPTION("Application Unit"), BasicItem."Application Unit",
                    BasicItem.FIELDCAPTION("Packaging Unit"), BasicItem."Packaging Unit",
                    BasicItem.TABLECAPTION, BasicItem."Product Code", UnitCode);
                END;
              END;
              IF QuanOld <> QuanDec THEN
                QuanDec := ROUND(QuanDec, 1, '>');
            END;
          END;
        ItemOption::"Trade Item":
          BEGIN
            IF TradeItem.GET(VendorNo, TradeItemNo) THEN BEGIN
              IF TradeItem."Qty. per Unit of Measure" = 0 THEN
                TradeItem."Qty. per Unit of Measure" := 1;
              IF TradeItem."Lot Size Quantity" = 0 THEN
                TradeItem."Lot Size Quantity" := 1;
              IF TradeItem."Application Unit Quantity" = 0 THEN
                TradeItem."Application Unit Quantity" := 1;
              IF UnitCode = UPPERCASE(TradeItem."Application Unit") THEN BEGIN
                QuanDec := QuanDec * TradeItem."Qty. per Unit of Measure";
                FactDec := FactDec / TradeItem."Qty. per Unit of Measure";
              END ELSE BEGIN
                IF UnitCode = UPPERCASE(TradeItem."Packaging Unit") THEN BEGIN
                  QuanDec := QuanDec / TradeItem."Qty. per Unit of Measure";
                  FactDec := FactDec * TradeItem."Qty. per Unit of Measure";
                END ELSE BEGIN
                  IF SkipError THEN EXIT;
                  ERROR(lvText000,
                    TradeItem.FIELDCAPTION("Application Unit"), TradeItem."Application Unit",
                    TradeItem.FIELDCAPTION("Packaging Unit"), TradeItem."Packaging Unit",
                    TradeItem.TABLECAPTION, TradeItem."Item Code", UnitCode);
                END;
              END;
              IF QuanOld <> QuanDec THEN BEGIN
                IF UnitCode = UPPERCASE(TradeItem."Packaging Unit") THEN
                  QuanDec := ROUND(QuanDec, TradeItem."Lot Size Quantity", '>')
                ELSE
                  QuanDec := ROUND(QuanDec, TradeItem."Application Unit Quantity", '>');
              END;
            END;
          END;
      END;
    END;

    [External]
    PROCEDURE GetCostComponent@1100485005(CostObject@1100485002 : Code[20];VAR CostComp@1100485000 : Code[10]);
    BEGIN
      IF CostObject <> '' THEN BEGIN
        IF DimensionValue.Code <> CostObject THEN BEGIN
          GetGLSetup;
          IF DimensionValue.GET(GLSetup."Global Dimension 2 Code", CostObject) THEN;
        END;
        CostComp := DimensionValue."Cost Component";
      END;
    END;

    PROCEDURE GetItemTranslation@42(ItemNo@1100485002 : Code[20];VAR Desc1@1100485003 : Text[100];VAR Desc2@1100485004 : Text[50]);
    VAR
      UserSetup@1100485000 : Record 91;
      Employee@1100485001 : Record 5200;
      Item@1100485006 : Record 27;
      ItemTranslation@1100485005 : Record 30;
    BEGIN
      IF NOT UserSetup.GET(USERID) THEN UserSetup.INIT;
      IF NOT Employee.GET(UserSetup."Employee No.") THEN Employee.INIT;

      GetInventSetup;
      IF InventSetup."Item Info Trade Item Leading" THEN EXIT;

      IF NOT Item.GET(ItemNo) THEN EXIT;
      Desc1 := Item.Description;
      Desc2 := Item."Description 2";

      IF ItemTranslation.GET(ItemNo,'',LanguageCode) THEN BEGIN
        Desc1 := ItemTranslation.Description;
        Desc2 := ItemTranslation."Description 2";
      END;
    END;

    [External]
    PROCEDURE GetDeliveryTimeItem@1100485002(ItemNo@1100485001 : Code[20];Manufacturer@1100485002 : Code[20];BasicItemNo@1100485003 : Code[20];VendorNo@1100485004 : Code[20];TradeItemNo@1100485000 : Code[20];DocType@1100485006 : Integer;DocNo@1100485007 : Code[20];NavisionVendor@1100485005 : Code[20]) DeliveryPeriod : Text[30];
    VAR
      Item@1100485008 : Record 27;
      BasicItem@1100485009 : Record 11012316;
      TradeItem@1100485010 : Record 11012317;
    BEGIN
      GetInventSetup;
      IF (NOT InventSetup."Item Info Trade Item Leading") AND (ItemNo <> '') THEN BEGIN
        IF Item.GET(ItemNo) THEN BEGIN
          DeliveryPeriod := STRSUBSTNO('%1', Item."Lead Time Calculation");
          IF DeliveryPeriod <> '' THEN
            EXIT(DeliveryPeriod);
        END;
      END;

      IF (TradeItemNo <> '') AND (VendorNo <> '') THEN BEGIN
        IF TradeItem.GET(VendorNo, TradeItemNo) THEN BEGIN
          TradeItem.CALCFIELDS("Delivery Time Unit");
          IF UPPERCASE(TradeItem."Delivery Time Unit") = 'U' THEN BEGIN
            TradeItem."Delivery Time Unit" := 'D';
            TradeItem."Delivery Period" := ROUND(TradeItem."Delivery Period" / 24, 1);
          END;
          IF UPPERCASE(TradeItem."Delivery Time Unit") = 'D' THEN
            TradeItem."Delivery Period" := ROUND(TradeItem."Delivery Period", 1);
          IF UPPERCASE(TradeItem."Delivery Time Unit") = 'W' THEN
            TradeItem."Delivery Period" := ROUND(TradeItem."Delivery Period", 1);
          IF (TradeItem."Delivery Period" <> 0) AND (TradeItem."Delivery Time Unit" <> '') THEN
            DeliveryPeriod := STRSUBSTNO('%1', TradeItem."Delivery Period") +
              UPPERCASE(COPYSTR(TradeItem."Delivery Time Unit",1,1));
          IF DeliveryPeriod <> '' THEN
            EXIT(DeliveryPeriod);
        END;
      END;

      IF (BasicItemNo <> '') AND (Manufacturer <> '') AND
         (TradeItemNo = '') AND (VendorNo = '') THEN BEGIN
        IF BasicItem.GET(Manufacturer, BasicItemNo) THEN BEGIN
          // Basic Item has no Delivery Period: Search for Trade Item with same number.
          IF TradeItem.GET(Manufacturer, BasicItemNo) THEN BEGIN
            TradeItem.CALCFIELDS("Delivery Time Unit");
            IF UPPERCASE(TradeItem."Delivery Time Unit") = 'U' THEN BEGIN
              TradeItem."Delivery Time Unit" := 'D';
              TradeItem."Delivery Period" := ROUND(TradeItem."Delivery Period" / 24, 1);
            END;
            IF UPPERCASE(TradeItem."Delivery Time Unit") = 'D' THEN
              TradeItem."Delivery Period" := ROUND(TradeItem."Delivery Period", 1);
            IF UPPERCASE(TradeItem."Delivery Time Unit") = 'W' THEN
              TradeItem."Delivery Period" := ROUND(TradeItem."Delivery Period", 1);
            IF (TradeItem."Delivery Period" <> 0) AND (TradeItem."Delivery Time Unit" <> '') THEN
              DeliveryPeriod := STRSUBSTNO('%1', TradeItem."Delivery Period") +
                UPPERCASE(COPYSTR(TradeItem."Delivery Time Unit",1,1));
          END;
          IF DeliveryPeriod <> '' THEN
            EXIT(DeliveryPeriod);
        END;
      END;
      IF ItemNo <> '' THEN BEGIN
        IF Item.GET(ItemNo) THEN BEGIN
          DeliveryPeriod := STRSUBSTNO('%1', Item."Lead Time Calculation");
          IF DeliveryPeriod <> '' THEN
            EXIT(DeliveryPeriod);
        END;
      END;

      IF DeliveryPeriod = '' THEN
        GetDefaultDeliveryTime(DocType, DocNo, NavisionVendor, DeliveryPeriod);
    END;

    [External]
    PROCEDURE GetDefaultDeliveryTime@1100485004(DocType@1100485005 : Integer;DocNo@1100485004 : Code[20];VendorNo@1100485002 : Code[20];VAR DeliveryPeriod@1100485003 : Text[30]);
    VAR
      Vendor@1100485000 : Record 23;
      PurchaseHeader@1100485006 : Record 38;
    BEGIN
      IF DocNo <> '' THEN BEGIN
        PurchaseHeader.GET(DocType, DocNo);
        DeliveryPeriod := STRSUBSTNO('%1', PurchaseHeader."Lead Time Calculation");
      END;

      IF DeliveryPeriod <> '' THEN EXIT;

      IF VendorNo <> '' THEN BEGIN
        Vendor.GET(VendorNo);
        DeliveryPeriod := STRSUBSTNO('%1', Vendor."Lead Time Calculation");
      END;

      IF DeliveryPeriod <> '' THEN EXIT;

      GetInventSetup;
      DeliveryPeriod := STRSUBSTNO('%1', InventSetup."Delivery Period");
    END;

    [External]
    PROCEDURE GetPriceTradeItem@1100485007(VAR TradeItem@1100485000 : Record 11012317;RefDate@1100485008 : Date;DiscRef1@1100485002 : Code[20];DiscRef2@1100485004 : Code[20];DiscPrio@1100525000 : Code[10]);
    VAR
      PriceHistoryTradeItem@1100485007 : Record 11012315;
      DiscountTermHistory@1100485010 : Record 11012312;
      convfact@1100485001 : Decimal;
      HistNetPrice@1100485003 : Decimal;
      DiscPerc0@1100485011 : Decimal;
      DiscPerc1@1100485006 : Decimal;
      DiscPerc2@1100485009 : Decimal;
      VendorDiscPerc@1100485012 : Decimal;
      VendorDiscPerc1@1100485013 : Decimal;
      VendorDiscPerc2@1100485014 : Decimal;
      DiscLevel@1100485005 : Integer;
      DiscPrio0@1100525001 : Integer;
      DiscPrio1@1100525002 : Integer;
      DiscPrio2@1100525003 : Integer;
      DiscPresent0@1100525004 : Boolean;
      DiscPresent1@1100525005 : Boolean;
      DiscPresent2@1100525006 : Boolean;
      DiscType@1100525007 : 'Purchase,Sales';
      CurrPrio@1100525008 : Integer;
    BEGIN
      WITH TradeItem DO BEGIN
        "Price Reference Date" := 0D;
        "Gross Price" := 0;
        "Discount Percentage" := 0;
        "Net Price" := 0;
        convfact := 1;
        HistNetPrice := 0;
        IF RefDate = 0D THEN
          RefDate := TODAY;

        GetGLSetup;

        //>>  ANCA 150529 IME-296 and IME-355
        HistNetPrice := 0;
        PriceHistFound := FALSE;
        PriceListVendorNo := '';
        IF PriceListCode <> '' THEN //<<
          PriceHistoryTradeItem.SETRANGE("Price List Code",PriceListCode); // LAHE 130116, using remote passed price list code, if any
        //<<
        PriceHistoryTradeItem.SETRANGE("Item Code", "Item Code");
        PriceHistoryTradeItem.SETRANGE(Vendor, Vendor);
        PriceHistoryTradeItem.SETRANGE("Starting Date", 0D, RefDate);
        IF PriceHistoryTradeItem.FINDLAST THEN BEGIN
          "Price Reference Date" := PriceHistoryTradeItem."Starting Date";
          IF PriceHistoryTradeItem."Quantity Per Price" <> 0 THEN
            convfact := convfact * PriceHistoryTradeItem."Quantity Per Price";

          "Gross Price" := PriceHistoryTradeItem."Gross Price" / convfact;
          HistNetPrice := PriceHistoryTradeItem."Net Price" / convfact;
        //>> LAHE 130116
          PriceHistFound := PriceListCode <> ''; //TRUE;
          PriceListVendorNo := PriceHistoryTradeItem.Vendor; // LAHE 130425
          //IF NOT CONFIRM('PriceHistFound: %1',TRUE,"Gross Price") THEN ERROR(''); // LAHE WIP
        END ELSE BEGIN
          //>> ANCA 150529 IME-296 and IME-355  PriceListCode is not set when run from Trade Item Page, Test PriceList <> '' to avoid displaying wrong prices in Trade Item Page
          IF (PriceListCode <> '') THEN BEGIN
            PriceHistoryTradeItem.SETCURRENTKEY("Item Code", "Starting Date", "Price List Code");  // Use Price History for current customer Pricelist, Use new Key to speed up things
            PriceHistoryTradeItem.SETRANGE(Vendor);
            IF PriceHistoryTradeItem.FINDLAST THEN BEGIN
              "Price Reference Date" := PriceHistoryTradeItem."Starting Date";
              IF PriceHistoryTradeItem."Quantity Per Price" <> 0 THEN
                convfact := convfact * PriceHistoryTradeItem."Quantity Per Price";

              "Gross Price" := PriceHistoryTradeItem."Gross Price" / convfact;
              HistNetPrice := PriceHistoryTradeItem."Net Price" / convfact;
              PriceHistFound := PriceListCode <> ''; //TRUE;
              PriceListVendorNo := PriceHistoryTradeItem.Vendor; // LAHE 130425
              //IF NOT CONFIRM('PriceHistNoVendorFound: %1',TRUE,"Gross Price") THEN ERROR(''); // LAHE WIP

            END ELSE BEGIN
              //>>   ANCA IME-355 150529
              PriceHistoryTradeItem.SETRANGE("Starting Date");      // ANCA 150529 Try to get a later record in price history
              IF PriceHistoryTradeItem.FINDFIRST THEN BEGIN
                "Price Reference Date" := PriceHistoryTradeItem."Starting Date";
                IF PriceHistoryTradeItem."Quantity Per Price" <> 0 THEN
                  convfact := convfact * PriceHistoryTradeItem."Quantity Per Price";

                "Gross Price" := PriceHistoryTradeItem."Gross Price" / convfact;
                HistNetPrice := PriceHistoryTradeItem."Net Price" / convfact;
                PriceHistFound := TRUE;
                PriceListVendorNo := PriceHistoryTradeItem.Vendor;
              //<< ANCA IME-355
              END ELSE BEGIN
                PriceHistoryTradeItem.SETCURRENTKEY(Vendor,"Item Code","Starting Date","Price List Code");
                PriceHistoryTradeItem.SETRANGE(Vendor, Vendor);
                PriceHistoryTradeItem.SETRANGE("Starting Date", 0D, RefDate);
                PriceHistoryTradeItem.SETRANGE("Price List Code"); // LAHE Try without pricelist filter

                IF PriceHistoryTradeItem.FINDLAST THEN BEGIN
                  "Price Reference Date" := PriceHistoryTradeItem."Starting Date";
                  IF PriceHistoryTradeItem."Quantity Per Price" <> 0 THEN
                    convfact := convfact * PriceHistoryTradeItem."Quantity Per Price";

                  "Gross Price" := PriceHistoryTradeItem."Gross Price" / convfact;
                  HistNetPrice := PriceHistoryTradeItem."Net Price" / convfact;

                END;
              END;
            END;
          END;
        //<< LAHE 130116
        END;

        IF "Factor Price-Purchase Unit" <> 0 THEN BEGIN
          "Gross Price" := "Gross Price" * "Factor Price-Purchase Unit";
          HistNetPrice := HistNetPrice * "Factor Price-Purchase Unit";
        END;

        "Gross Price" := ROUND("Gross Price", GLSetup."Unit-Amount Rounding Precision");

        IF (HistNetPrice <> 0) THEN BEGIN
          DiscLevel := 0;
          DiscPresent0 :=
            CheckDiscountLevel(TradeItem, DiscountTermHistory, FALSE, DiscLevel, '', RefDate, DiscType::Purchase);
          IF DiscPresent0 = FALSE THEN BEGIN
            IF "Gross Price" <> 0 THEN
              DiscPerc0 := 100 * ("Gross Price" - HistNetPrice) / "Gross Price";
          END;
        END;

        CheckDiscPrio(DiscRef1, DiscRef2, DiscPrio, DiscPrio0, DiscPrio1, DiscPrio2);
        IF (DiscPrio2 >= 0) AND (DiscRef2 <> '') THEN BEGIN
          DiscLevel := 2;
          DiscPresent2 :=
            CheckDiscountLevel(TradeItem, DiscountTermHistory, FALSE, DiscLevel, DiscRef2, RefDate, DiscType::Purchase);
          DiscPerc2 := TradeItem."Discount Percentage";
          VendorDiscPerc2 := CheckVendorDiscount(DiscLevel, DiscRef2, Vendor);
        END;
        IF (DiscPrio1 >= 0) AND (DiscRef1 <> '') THEN BEGIN
          DiscLevel := 1;
          DiscPresent1 :=
            CheckDiscountLevel(TradeItem, DiscountTermHistory, FALSE, DiscLevel, DiscRef1, RefDate, DiscType::Purchase);
          DiscPerc1 := TradeItem."Discount Percentage";
          VendorDiscPerc1 := CheckVendorDiscount(DiscLevel, DiscRef1, Vendor);
        END;
        IF DiscPrio0 >= 0 THEN BEGIN
          DiscLevel := 0;
          DiscPresent0 :=
            CheckDiscountLevel(TradeItem, DiscountTermHistory, FALSE, DiscLevel, '', RefDate, DiscType::Purchase);
          IF DiscPerc0 = 0 THEN
            DiscPerc0 := TradeItem."Discount Percentage";
      //  lvVendorDiscPerc0 := CheckVendorDiscount(lvDiscLevel, lvDiscRef0, Vendor); //no DiscRef for Company
        END;

        IF VendorDiscPerc2 > VendorDiscPerc THEN
          VendorDiscPerc := VendorDiscPerc2;
        IF VendorDiscPerc1 > VendorDiscPerc THEN
          VendorDiscPerc := VendorDiscPerc1;

        //C023137.sn
        TradeItem."Discount Percentage" := DiscPerc0;
        CurrPrio := DiscPrio0;
        IF ((DiscPrio1 = CurrPrio) AND (DiscPerc1 > TradeItem."Discount Percentage")) OR
           ((DiscPrio1 > CurrPrio) AND (DiscPresent1 = TRUE)) THEN BEGIN
          TradeItem."Discount Percentage" := DiscPerc1;
          CurrPrio := DiscPrio1;
        END;
        IF ((DiscPrio2 = CurrPrio) AND (DiscPerc2 > TradeItem."Discount Percentage")) OR
           ((DiscPrio2 > CurrPrio) AND (DiscPresent2 = TRUE)) THEN BEGIN
          TradeItem."Discount Percentage" := DiscPerc2;
          CurrPrio := DiscPrio2;
        END;
        TradeItem."Discount Percentage" := TradeItem."Discount Percentage" + VendorDiscPerc;
        //C023137.en

        TradeItem."Net Price" :=
          ROUND(TradeItem."Gross Price"*(100-TradeItem."Discount Percentage")/100,GLSetup."Unit-Amount Rounding Precision");
        IF (HistNetPrice <> 0) AND (TradeItem."Gross Price" = 0) THEN
          TradeItem."Net Price" := HistNetPrice;  //if gross price not filled, but only Net price without discount-condition
      END;
    END;

    [External]
    PROCEDURE PriceHistory0Exists@1100528601(ItemNo@1100528601 : Code[20];VendorNo@1100528602 : Code[15];RefDate@1100528603 : Date) : Boolean;
    VAR
      PriceHistoryTradeItem@1100528600 : Record 11012315;
    BEGIN
      PriceHistoryTradeItem.SETRANGE("Item Code", ItemNo);
      PriceHistoryTradeItem.SETRANGE(Vendor, VendorNo);
      PriceHistoryTradeItem.SETRANGE("Starting Date", 0D, RefDate);
      IF PriceHistoryTradeItem.FINDLAST THEN
        EXIT(PriceHistoryTradeItem."Gross Price" = 0);
    END;

    LOCAL PROCEDURE DiscountConditionPresent@1100528501(DiscType@1100528500 : 'Purchase,Sales';DiscountTermHistory@1100528501 : Record 11012312) ConditionFound : Boolean;
    BEGIN
      //C048804
      CASE DiscType OF
        DiscType::Sales: ConditionFound :=
          ((DiscountTermHistory."Sales Price" <> 0) OR
           (DiscountTermHistory."Sales Discount Percentage" <> 0) OR
           (DiscountTermHistory."Price Agreement (Sales)" = TRUE) OR
           (DiscountTermHistory."Sales Discount Group" <> ''));
        DiscType::Purchase: ConditionFound :=
          ((DiscountTermHistory."Purchase Price" <> 0) OR
           (DiscountTermHistory."Discount Percentage 1" <> 0) OR
           (DiscountTermHistory."Discount Percentage 2" <> 0) OR
           (DiscountTermHistory."Discount Percentage 3" <> 0) OR
           (DiscountTermHistory."Price Agreement (Purchase)" = TRUE));
      END;
      EXIT(ConditionFound);
    END;

    LOCAL PROCEDURE GetDiscountTerm@1100528500(VAR TradeItem@1100528506 : Record 11012317;VAR DiscountTermHistory@1100528505 : Record 11012312;CheckSales@1100528504 : Boolean;DiscLevel@1100528503 : Integer;DiscRef@1100528502 : Code[20];RefDate@1100528501 : Date;DiscType@1100528500 : 'Purchase,Sales';HGSCode@1100528509 : Code[20];iAction@1100528507 : Integer;VAR ConditionFound@1100528508 : Boolean);
    VAR
      DiscountTermHistory2@1100528510 : Record 11012312;
      posWildCard@1100528511 : Integer;
      lenHGS@1100528512 : Integer;
    BEGIN
      //C048804
      WITH TradeItem DO BEGIN
        DiscountTermHistory.SETRANGE(Vendor, Vendor);
        IF iAction = 10 THEN BEGIN  //Item
          DiscountTermHistory.SETFILTER("Discount Group", '%1', '');
          DiscountTermHistory.SETRANGE("Item Code", "Item Code");
        END;
        IF iAction = 20 THEN BEGIN  //Discount Group
          DiscountTermHistory.SETRANGE("Discount Group", "Discount Group Code");
          DiscountTermHistory.SETFILTER("Item Code", '%1', '');
        END;
        IF iAction = 30 THEN BEGIN  //WildCard
          DiscountTermHistory.SETFILTER("Discount Group", '%1', HGSCode + '*');
          DiscountTermHistory.SETFILTER("Item Code", '%1', '');
        END;
        IF iAction = 40 THEN BEGIN  //HGS-TU
          DiscountTermHistory.SETRANGE("Discount Group", HGSCode);
          DiscountTermHistory.SETFILTER("Item Code", '%1', '');
        END;
        IF iAction = 50 THEN BEGIN  //Vendor
          DiscountTermHistory.SETFILTER("Discount Group", '%1', '');
          DiscountTermHistory.SETFILTER("Item Code", '%1', '');
        END;
        DiscountTermHistory.SETRANGE("Discount Level", DiscLevel);
        DiscountTermHistory.SETRANGE("Discount Reference", DiscRef);
        DiscountTermHistory.SETRANGE("Starting Date", 0D, RefDate);
        DiscountTermHistory.SETFILTER("Ending Date", '%1|>=%2', 0D, RefDate);
        IF iAction = 30 THEN BEGIN
          lenHGS := STRLEN(HGSCode);
          IF DiscountTermHistory.FINDSET THEN BEGIN
            REPEAT
              posWildCard := STRPOS(DiscountTermHistory."Discount Group", '*');
              IF (posWildCard = lenHGS + 1) THEN BEGIN
                DiscountTermHistory2.COPY(DiscountTermHistory);
                DiscountTermHistory2.SETRANGE("Discount Group", DiscountTermHistory."Discount Group");
                IF DiscountTermHistory2.FINDLAST THEN BEGIN  //find last date for this condition
                  DiscountTermHistory.COPY(DiscountTermHistory2);
                  IF NOT CheckSales THEN
                    CheckDiscountTerm(TradeItem, DiscountTermHistory, RefDate, DiscType);
                  ConditionFound := DiscountConditionPresent(DiscType, DiscountTermHistory);
                END;
              END;
            UNTIL (DiscountTermHistory.NEXT = 0) OR (ConditionFound);
          END;
        END ELSE BEGIN
          IF DiscountTermHistory.FINDLAST THEN BEGIN
            IF NOT CheckSales THEN
              CheckDiscountTerm(TradeItem, DiscountTermHistory, RefDate, DiscType);
            ConditionFound := DiscountConditionPresent(DiscType, DiscountTermHistory);
          END;
        END;
      END;
    END;

    [External]
    PROCEDURE CheckDiscountLevel@1100485003(VAR TradeItem@1100485000 : Record 11012317;VAR DiscountTermHistory@1100525001 : Record 11012312;CheckSales@1100485003 : Boolean;DiscLevel@1100485006 : Integer;DiscRef@1100485007 : Code[20];RefDate@1100485008 : Date;DiscType@1100525000 : 'Purchase,Sales') : Boolean;
    VAR
      EtimVendor@1100485004 : Record 11012304;
      HGSCode@1210190000 : Text[250];
      lenHGS@1100485001 : Integer;
      ConditionFound@1100529400 : Boolean;
      iAction@1100528500 : Integer;
    BEGIN
      //C048804: redesign procedure
      //- Discount Level: 0=company, 1=customer, 2=project

      ConditionFound := FALSE;
      WITH TradeItem DO BEGIN
        IF NOT CheckSales THEN
          "Discount Percentage" := 0;
        iAction := 10;  //Item
        GetDiscountTerm(TradeItem, DiscountTermHistory, CheckSales, DiscLevel, DiscRef, RefDate, DiscType, '', iAction, ConditionFound);
        IF NOT ConditionFound THEN BEGIN
          iAction := 20;  //Discount Group
          GetDiscountTerm(TradeItem, DiscountTermHistory, CheckSales, DiscLevel, DiscRef, RefDate, DiscType, '', iAction, ConditionFound);
        END;
        IF NOT ConditionFound THEN BEGIN
          IF NOT EtimVendor.GET(Vendor) THEN EtimVendor.INIT;
          IF EtimVendor."Format Discount Term" = EtimVendor."Format Discount Term"::Wildcard THEN BEGIN
            iAction := 30;  //Wildcard
            //icc-format (instalnet) is based on discount terms like 02*, 016*, 1141* or 03225
            HGSCode := "Discount Group Code";
            lenHGS := STRLEN(HGSCode);
            WHILE lenHGS > 0 DO BEGIN
              GetDiscountTerm(TradeItem, DiscountTermHistory, CheckSales, DiscLevel, DiscRef, RefDate, DiscType, HGSCode, iAction, ConditionFound);
              lenHGS := lenHGS - 1;
              IF lenHGS > 0 THEN
                HGSCode := COPYSTR("Discount Group Code", 1, lenHGS);
              IF ConditionFound THEN
                lenHGS := 0;  //C038887
            END;
          END;
          IF EtimVendor."Format Discount Term" = EtimVendor."Format Discount Term"::HGS THEN BEGIN
            iAction := 40;  //HGS-TU
            IF COPYSTR("Discount Group Code", 5, 2) < '80' THEN BEGIN
              //With subgroup higher then 80 don't search for discount on higher level
              //TU supplies discount groups in format hhggss
              HGSCode := COPYSTR("Discount Group Code", 1, 4) + '99';
              GetDiscountTerm(TradeItem, DiscountTermHistory, CheckSales, DiscLevel, DiscRef, RefDate, DiscType, HGSCode, iAction, ConditionFound);
              IF NOT ConditionFound THEN BEGIN
                HGSCode := COPYSTR("Discount Group Code", 1, 2) + '9999';
                GetDiscountTerm(TradeItem, DiscountTermHistory, CheckSales, DiscLevel, DiscRef, RefDate, DiscType, HGSCode, iAction, ConditionFound);
              END;
            END;
          END;
          IF NOT ConditionFound THEN BEGIN
            iAction := 50;  //Vendor
            GetDiscountTerm(TradeItem, DiscountTermHistory, CheckSales, DiscLevel, DiscRef, RefDate, DiscType, '', iAction, ConditionFound);
          END;
        END;
      END;
      IF ShowSalesDiscount THEN
        PAGE.RUNMODAL(0, DiscountTermHistory);
      EXIT(ConditionFound);
    END;

    [External]
    PROCEDURE CheckDiscountTerm@1100485011(VAR TradeItem@1100485000 : Record 11012317;VAR DiscountTermHistory@1100485003 : Record 11012312;RefDate@1100485004 : Date;DiscType@1100525000 : 'Purchase,Sales');
    VAR
      PriceHistoryTradeItem@1100485002 : Record 11012315;
    BEGIN
      WITH TradeItem DO BEGIN
        IF DiscType = DiscType::Sales THEN BEGIN
          IF DiscountTermHistory."Sales Price" <> 0 THEN BEGIN
            PriceHistoryTradeItem.SETRANGE(Vendor, Vendor);
            PriceHistoryTradeItem.SETRANGE("Item Code", "Item Code");
            PriceHistoryTradeItem.SETRANGE("Starting Date", 0D, RefDate);
            //>> ANCA 150527 IME-355
            IF (PriceListCode <> '') THEN
              PriceHistoryTradeItem.SETRANGE("Price List Code",PriceListCode);
            //<<
            IF NOT PriceHistoryTradeItem.FINDLAST THEN
              PriceHistoryTradeItem.INIT;
            IF PriceHistoryTradeItem."Gross Price" = 0 THEN BEGIN
              "Discount Percentage" := 0;
              "Gross Price" := DiscountTermHistory."Sales Price";
              IF PriceHistoryTradeItem."Quantity Per Price" <> 0 THEN
                "Gross Price" := "Gross Price" / PriceHistoryTradeItem."Quantity Per Price";
            END ELSE BEGIN
              "Discount Percentage" :=
                100 * (PriceHistoryTradeItem."Gross Price"-DiscountTermHistory."Sales Price") / PriceHistoryTradeItem."Gross Price";
            END;
          END ELSE BEGIN
            "Discount Percentage" := DiscountTermHistory."Sales Discount Percentage";
          END;
          "Net Price" :=
            ROUND("Gross Price" * (100-"Discount Percentage")/100, GLSetup."Unit-Amount Rounding Precision");
        END;
        IF DiscType = DiscType::Purchase THEN BEGIN
          IF DiscountTermHistory."Purchase Price" <> 0 THEN BEGIN
            //price agreement is in same unit of measure as gross price in price history
            PriceHistoryTradeItem.SETRANGE(Vendor, Vendor);
            PriceHistoryTradeItem.SETRANGE("Item Code", "Item Code");
            PriceHistoryTradeItem.SETRANGE("Starting Date", 0D, RefDate);
            IF NOT PriceHistoryTradeItem.FINDLAST THEN
              PriceHistoryTradeItem.INIT;
            IF PriceHistoryTradeItem."Gross Price" = 0 THEN BEGIN
              "Discount Percentage" := 0;
              "Gross Price" := DiscountTermHistory."Purchase Price";
              IF PriceHistoryTradeItem."Quantity Per Price" <> 0 THEN
                "Gross Price" := "Gross Price" / PriceHistoryTradeItem."Quantity Per Price";
            END ELSE BEGIN
              "Discount Percentage" :=
                100 * (PriceHistoryTradeItem."Gross Price"-DiscountTermHistory."Purchase Price") / PriceHistoryTradeItem."Gross Price";
            END;
          END ELSE BEGIN
            "Discount Percentage" := DiscountTermHistory.GetPurchaseDiscount;
          END;
          "Net Price" :=
            ROUND("Gross Price" * (100-"Discount Percentage")/100, GLSetup."Unit-Amount Rounding Precision");
         END;
      END;
    END;

    [External]
    PROCEDURE CheckVendorDiscount@1100485014(lvDiscLevel@1100485002 : Integer;lvDiscRef@1100485001 : Code[20];lvVendor@1100485003 : Code[20]) : Decimal;
    VAR
      VendorDiscount@1100485000 : Record 11012339;
    BEGIN
      IF NOT VendorDiscount.GET(lvDiscLevel, lvDiscRef, lvVendor) THEN
        VendorDiscount.INIT;

      EXIT(VendorDiscount."Discount %");
    END;

    [External]
    PROCEDURE CheckUnitConversion@1100485008(UnitCode@1100485000 : Code[10]) : Text[30];
    VAR
      EtimUnit@1100485001 : Record 11012307;
    BEGIN
      IF EtimUnit.GET(UnitCode) THEN BEGIN
        IF EtimUnit."Unit (NAV)" <> '' THEN
          EXIT(EtimUnit."Unit (NAV)")
        ELSE
          EXIT(EtimUnit."Unit of Measure");
      END;

      EXIT(UnitCode);
    END;

    [External]
    PROCEDURE GetPriceBasicItem@1100485006(VAR BasicItem@1100485000 : Record 11012316;RefDate@1100485005 : Date;DiscRef1@1100485004 : Code[20];DiscRef2@1100485003 : Code[20];DiscPrio@1100525000 : Code[10];UpdateBln@1100485006 : Boolean);
    VAR
      TradeItem@1100485001 : Record 11012317;
      EtimVendor@1100485002 : Record 11012304;
    BEGIN
      WITH BasicItem DO BEGIN
        IF TradeItem.GET(Manufacturer, "Product Code") THEN BEGIN
          GetPriceTradeItem(TradeItem, RefDate, DiscRef1, DiscRef2, DiscPrio);
          CheckProductRelation(BasicItem, TradeItem, FALSE);
        END ELSE BEGIN
          IF NOT EtimVendor.GET(Manufacturer) THEN
            EtimVendor.INIT
          ELSE
            EtimVendor.CALCFIELDS("Vendor (Price/Discount)");
          TradeItem.RESET;
          IF "GTIN Code" <> '' THEN BEGIN
            TradeItem.SETCURRENTKEY("GTIN Code (Item)");
            TradeItem.SETRANGE("GTIN Code (Item)", "GTIN Code");
          END ELSE BEGIN
            TradeItem.SETCURRENTKEY("Product Code");
            TradeItem.SETRANGE(Manufacturer, Manufacturer);
            TradeItem.SETRANGE("Product Code", "Product Code");
          END;
          IF EtimVendor."Vendor (Price/Discount)" <> '' THEN
            TradeItem.SETRANGE(Vendor, EtimVendor."Vendor (Price/Discount)");
          IF TradeItem.FINDFIRST THEN BEGIN
            GetPriceTradeItem(TradeItem, RefDate, DiscRef1, DiscRef2, DiscPrio);
            CheckProductRelation(BasicItem, TradeItem, UpdateBln);
          END ELSE BEGIN
            TradeItem.SETRANGE(Vendor);
            IF TradeItem.FINDFIRST THEN BEGIN
              GetPriceTradeItem(TradeItem, RefDate, DiscRef1, DiscRef2, DiscPrio);
              CheckProductRelation(BasicItem, TradeItem, UpdateBln);
            END;
          END;
        END;
      END;
    END;

    [External]
    PROCEDURE CheckProductRelation@1100485009(VAR BasicItem@1100485000 : Record 11012316;TradeItem@1100485001 : Record 11012317;UpdateBln@1100485002 : Boolean);
    BEGIN
      BasicItem."Gross Price" := TradeItem."Gross Price";
      BasicItem."Net Price" := TradeItem."Net Price";
      BasicItem."Discount Percentage" := TradeItem."Discount Percentage";
      BasicItem."Application Unit" := TradeItem."Application Unit";
      BasicItem."Packaging Unit" := TradeItem."Packaging Unit";
      BasicItem."Qty. per Unit of Measure" := TradeItem."Qty. per Unit of Measure";
      BasicItem."Price Reference Date" := TradeItem."Price Reference Date";
      BasicItem."Cost Object" := TradeItem."Cost Object";
      BasicItem."Cost Object (Removal)" := TradeItem."Cost Object (Removal)";
      BasicItem."Removal Contribution" := TradeItem."Removal Contribution";

      IF UpdateBln = FALSE THEN EXIT;

      IF BasicItem."GTIN Code" = TradeItem."GTIN Code (Item)" THEN BEGIN
        BasicItem."Product Description" := TradeItem."Item Description";
        BasicItem."Product Description 2" := TradeItem."Item Description 2";
      END;
    END;

    [External]
    PROCEDURE GetAdditionalProductData@1100485013(VAR BasicItem@1100485001 : Record 11012316);
    BEGIN
      WITH BasicItem DO BEGIN
        GetProductClass(BasicItem);
        GetCostObject(BasicItem);
      END;
    END;

    [External]
    PROCEDURE GetProductClass@1100485012(VAR BasicItem@1100485001 : Record 11012316);
    VAR
      ProductClass@1210190008 : Record 11012303;
    BEGIN
      WITH BasicItem DO BEGIN
        IF ProductClass.GET(BasicItem."Product Group", BasicItem."Product Group Line No.") THEN BEGIN
          "Product Class" := ProductClass."Product Class";
          "Application Unit" := CheckUnitConversion(ProductClass."Unit ID");
        END;
      END;
    END;

    [External]
    PROCEDURE GetCostObject@1100485010(VAR BasicItem@1100485001 : Record 11012316);
    VAR
      ProductGroup@1210190007 : Record 11012302;
    BEGIN
      WITH BasicItem DO BEGIN
        IF ProductGroup.GET(BasicItem."Product Group") THEN BEGIN
          IF ProductGroup."Cost Object" <> '' THEN
            "Cost Object" := ProductGroup."Cost Object";
          IF ProductGroup."Cost Object (Removal)" <> '' THEN
            "Cost Object (Removal)" := ProductGroup."Cost Object (Removal)";
        END;
      END;
    END;

    [External]
    PROCEDURE GetRefDiscEstimate@1100525002(Estimate@1100525001 : Record 11012151;VAR DiscRef1@1100485001 : Code[20];VAR DiscRef2@1100485002 : Code[20];DiscType@1100525000 : 'Purchase,Sales');
    BEGIN
      IF DiscType = DiscType::Purchase THEN BEGIN
        DiscRef1 := Estimate."Purch Discount Term Group 1";
        DiscRef2 := Estimate."Purch Discount Term Group 2";
      END;
      IF DiscType = DiscType::Sales THEN BEGIN
        DiscRef1 := Estimate."Sales Discount Term Group 1";
        DiscRef2 := Estimate."Sales Discount Term Group 2";
      END;
    END;

    [External]
    PROCEDURE GetRefDiscProject@1100525003(Job@1100525002 : Record 11072003;VAR DiscRef1@1100485001 : Code[20];VAR DiscRef2@1100485002 : Code[20];DiscType@1100525000 : 'Purchase,Sales');
    BEGIN
      IF DiscType = DiscType::Purchase THEN BEGIN
        DiscRef1 := Job."Purch Discount Term Group 1";
        DiscRef2 := Job."Purch Discount Term Group 2";
      END;
      IF DiscType = DiscType::Sales THEN BEGIN
        DiscRef1 := Job."Sales Discount Term Group 1";
        DiscRef2 := Job."Sales Discount Term Group 2";
      END;
    END;

    [External]
    PROCEDURE GetRefDiscServContract@1100525004(ServiceContract@1100525001 : Record 11012812;VAR DiscRef1@1100485001 : Code[20];VAR DiscRef2@1100485002 : Code[20];DiscType@1100525000 : 'Purchase,Sales');
    BEGIN
      IF DiscType = DiscType::Purchase THEN BEGIN
        DiscRef1 := ServiceContract."Purch Discount Term Group 1";
        DiscRef2 := ServiceContract."Purch Discount Term Group 2";
      END;
      IF DiscType = DiscType::Sales THEN BEGIN
        DiscRef1 := ServiceContract."Sales Discount Term Group 1";
        DiscRef2 := ServiceContract."Sales Discount Term Group 2";
      END;
    END;

    [External]
    PROCEDURE GetRefDiscServOrder@1100525005(ServiceOrder@1100525001 : Record 11012823;VAR DiscRef1@1100485001 : Code[20];VAR DiscRef2@1100485002 : Code[20];DiscType@1100525000 : 'Purchase,Sales');
    BEGIN
      IF DiscType = DiscType::Purchase THEN BEGIN
        DiscRef1 := ServiceOrder."Purch Discount Term Group 1";
        DiscRef2 := ServiceOrder."Purch Discount Term Group 2";
      END;
      IF DiscType = DiscType::Sales THEN BEGIN
        DiscRef1 := ServiceOrder."Sales Discount Term Group 1";
        DiscRef2 := ServiceOrder."Sales Discount Term Group 2";
      END;
    END;

    [External]
    PROCEDURE GetRefDiscCustomer@1100528900(Customer@1100525001 : Record 18;VAR DiscRef1@1100485001 : Code[20];VAR DiscRef2@1100485002 : Code[20];DiscType@1100525000 : 'Purchase,Sales');
    BEGIN
      //C062378
      IF DiscType = DiscType::Purchase THEN BEGIN
        DiscRef1 := Customer."Purch Discount Term Group";
        DiscRef2 := '';
      END;
      IF DiscType = DiscType::Sales THEN BEGIN
        DiscRef1 := Customer."Sales Discount Term Group";
        DiscRef2 := '';
      END;
    END;

    [External]
    PROCEDURE GetRefPrioEstimate@1100525000(Estimate@1100485000 : Record 11012151;DiscType@1100525000 : 'Purchase,Sales') RefPrio : Code[10];
    BEGIN
      CASE DiscType OF
        DiscType::Purchase:
          BEGIN
            IF Estimate."Priority Purch Disc Term Grp 0" = '' THEN
              RefPrio := RefPrio + '~'
            ELSE
              RefPrio := RefPrio + Estimate."Priority Purch Disc Term Grp 0";
            IF Estimate."Priority Purch Disc Term Grp 1" = '' THEN
              RefPrio := RefPrio + '~'
            ELSE
              RefPrio := RefPrio + Estimate."Priority Purch Disc Term Grp 1";
            IF Estimate."Priority Purch Disc Term Grp 2" = '' THEN
              RefPrio := RefPrio + '~'
            ELSE
              RefPrio := RefPrio + Estimate."Priority Purch Disc Term Grp 2";
          END;
        DiscType::Sales:
          BEGIN
            IF Estimate."Priority Sales Disc Term Grp 0" = '' THEN
              RefPrio := RefPrio + '~'
            ELSE
              RefPrio := RefPrio + Estimate."Priority Sales Disc Term Grp 0";
            IF Estimate."Priority Sales Disc Term Grp 1" = '' THEN
              RefPrio := RefPrio + '~'
            ELSE
              RefPrio := RefPrio + Estimate."Priority Sales Disc Term Grp 1";
            IF Estimate."Priority Sales Disc Term Grp 2" = '' THEN
              RefPrio := RefPrio + '~'
            ELSE
              RefPrio := RefPrio + Estimate."Priority Sales Disc Term Grp 2";
          END;
      END;

      IF RefPrio = PADSTR('', STRLEN(RefPrio), '~') THEN
        RefPrio := '';

      EXIT(RefPrio);
    END;

    [External]
    PROCEDURE GetRefPrioProject@1100525007(Job@1100525001 : Record 11072003;DiscType@1100525000 : 'Purchase,Sales') RefPrio : Code[10];
    BEGIN
      CASE DiscType OF
        DiscType::Purchase:
          BEGIN
            IF Job."Priority Purch Disc Term Grp 0" = '' THEN
              RefPrio := RefPrio + '~'
            ELSE
              RefPrio := RefPrio + Job."Priority Purch Disc Term Grp 0";
            IF Job."Priority Purch Disc Term Grp 1" = '' THEN
              RefPrio := RefPrio + '~'
            ELSE
              RefPrio := RefPrio + Job."Priority Purch Disc Term Grp 1";
            IF Job."Priority Purch Disc Term Grp 2" = '' THEN
              RefPrio := RefPrio + '~'
            ELSE
              RefPrio := RefPrio + Job."Priority Purch Disc Term Grp 2";
          END;
        DiscType::Sales:
          BEGIN
            IF Job."Priority Sales Disc Term Grp 0" = '' THEN
              RefPrio := RefPrio + '~'
            ELSE
              RefPrio := RefPrio + Job."Priority Sales Disc Term Grp 0";
            IF Job."Priority Sales Disc Term Grp 1" = '' THEN
              RefPrio := RefPrio + '~'
            ELSE
              RefPrio := RefPrio + Job."Priority Sales Disc Term Grp 1";
            IF Job."Priority Sales Disc Term Grp 2" = '' THEN
              RefPrio := RefPrio + '~'
            ELSE
              RefPrio := RefPrio + Job."Priority Sales Disc Term Grp 2";
          END;
      END;

      IF RefPrio = PADSTR('', STRLEN(RefPrio), '~') THEN
        RefPrio := '';

      EXIT(RefPrio);
    END;

    [External]
    PROCEDURE GetRefPrioServContract@1100525009(ServiceContract@1100525001 : Record 11012812;DiscType@1100525000 : 'Purchase,Sales') RefPrio : Code[10];
    BEGIN
      CASE DiscType OF
        DiscType::Purchase:
          BEGIN
            IF ServiceContract."Priority Purch Disc Term Grp 0" = '' THEN
              RefPrio := RefPrio + '~'
            ELSE
              RefPrio := RefPrio + ServiceContract."Priority Purch Disc Term Grp 0";
            IF ServiceContract."Priority Purch Disc Term Grp 1" = '' THEN
              RefPrio := RefPrio + '~'
            ELSE
              RefPrio := RefPrio + ServiceContract."Priority Purch Disc Term Grp 1";
            IF ServiceContract."Priority Purch Disc Term Grp 2" = '' THEN
              RefPrio := RefPrio + '~'
            ELSE
              RefPrio := RefPrio + ServiceContract."Priority Purch Disc Term Grp 2";
          END;
        DiscType::Sales:
          BEGIN
            IF ServiceContract."Priority Sales Disc Term Grp 0" = '' THEN
              RefPrio := RefPrio + '~'
            ELSE
              RefPrio := RefPrio + ServiceContract."Priority Sales Disc Term Grp 0";
            IF ServiceContract."Priority Sales Disc Term Grp 1" = '' THEN
              RefPrio := RefPrio + '~'
            ELSE
              RefPrio := RefPrio + ServiceContract."Priority Sales Disc Term Grp 1";
            IF ServiceContract."Priority Sales Disc Term Grp 2" = '' THEN
              RefPrio := RefPrio + '~'
            ELSE
              RefPrio := RefPrio + ServiceContract."Priority Sales Disc Term Grp 2";
          END;
      END;
      IF ServiceContract."No." = '' THEN RefPrio := '012';  //db, 07-04-17: no contract, may be DiscRef1/2 filled on service order

      IF RefPrio = PADSTR('', STRLEN(RefPrio), '~') THEN
        RefPrio := '';

      EXIT(RefPrio);
    END;

    [External]
    PROCEDURE CheckDiscPrio@1100525001(DiscRef1@1100525000 : Code[20];DiscRef2@1100525001 : Code[20];DiscPrio@1100525005 : Code[10];VAR DiscPrio0@1100525002 : Integer;VAR DiscPrio1@1100525003 : Integer;VAR DiscPrio2@1100525004 : Integer);
    BEGIN
      IF DiscPrio = '' THEN BEGIN
        DiscPrio0 := 0;
        DiscPrio1 := 0;
        DiscPrio2 := 0;
      END ELSE BEGIN
        IF NOT EVALUATE(DiscPrio0, COPYSTR(DiscPrio, 1, 1)) THEN DiscPrio0 := -1;
        IF NOT EVALUATE(DiscPrio1, COPYSTR(DiscPrio, 2, 1)) THEN DiscPrio1 := -1;
        IF NOT EVALUATE(DiscPrio2, COPYSTR(DiscPrio, 3, 1)) THEN DiscPrio2 := -1;
      END;
    END;

    [External]
    PROCEDURE GetRefDateEstimate@1100485015(Estimate@1100485000 : Record 11012151) RefDate : Date;
    BEGIN
      RefDate := Estimate."Reference Date (Item)";

      IF RefDate = 0D THEN
        RefDate := CheckRefDateLevel(Estimate."Customer No.");

      EXIT(RefDate);
    END;

    [External]
    PROCEDURE GetRefDateProject@1100485017(Job@1100485000 : Record 11072003) RefDate : Date;
    BEGIN
      RefDate := Job."Reference Date (Item)";

      IF RefDate = 0D THEN
        RefDate := CheckRefDateLevel(Job."Bill-to Customer No.");

      EXIT(RefDate);
    END;

    [External]
    PROCEDURE GetRefDateServContract@1100485018(ServiceContract@1100485000 : Record 11012812) RefDate : Date;
    BEGIN
      RefDate := ServiceContract."Reference Date (Item)";

      IF RefDate = 0D THEN
        RefDate := CheckRefDateLevel(ServiceContract."Bill-to Customer No. (CP)");

      EXIT(RefDate);
    END;

    [External]
    PROCEDURE GetRefDateServOrder@1100485024(ServiceOrder@1100485000 : Record 11012823) RefDate : Date;
    BEGIN
      RefDate := ServiceOrder."Reference Date (Item)";

      IF RefDate = 0D THEN
        RefDate := CheckRefDateLevel(ServiceOrder."Bill-to Customer No.");

      EXIT(RefDate);
    END;

    [External]
    PROCEDURE CheckRefDateLevel@1100485016(CustNo@1100485000 : Code[20]) RefDate : Date;
    BEGIN
      IF RefDate = 0D THEN
        IF CustNo <> '' THEN BEGIN
          GetCust(CustNo);
          RefDate := Customer."Reference Date (Item)";
        END;
      IF RefDate = 0D THEN BEGIN
        GetInventSetup;
        RefDate := InventSetup."Reference Date (Item)";
      END;

      IF RefDate = 0D THEN
        RefDate := TODAY;

      EXIT(RefDate);
    END;

    [External]
    PROCEDURE EvaluateSalesDiscount@1100525006(TradeItem@1100525007 : Record 11012317;VAR NetPrice@1100525003 : Decimal;VAR DiscPerc@1100525002 : Decimal;GrossPrice@1100525001 : Decimal;CustCde@1100525022 : Code[20];CustGrp@1100525005 : Code[20];RefDate@1100525006 : Date;DiscRef1@1100525011 : Code[20];DiscRef2@1100525010 : Code[20];DiscPrio@1100525009 : Code[10]) : Boolean;
    VAR
      ItemGrp@1100525004 : Code[20];
      DiscountTermHistory@1100525000 : Record 11012312;
      DiscLevel@1100525008 : Integer;
      DiscPrio0@1100525021 : Integer;
      DiscPrio1@1100525020 : Integer;
      DiscPrio2@1100525019 : Integer;
      DiscPresent0@1100525018 : Boolean;
      DiscPresent1@1100525017 : Boolean;
      DiscPresent2@1100525016 : Boolean;
      DiscPerc2@1100525015 : Decimal;
      DiscPerc1@1100525014 : Decimal;
      DiscPerc0@1100525013 : Decimal;
      DiscType@1100525012 : 'Purchase,Sales';
      PriceAgreement0@1100528200 : Boolean;
      PriceAgreement1@1100528201 : Boolean;
      PriceAgreement2@1100528202 : Boolean;
    BEGIN
      TradeItem."Gross Price" := GrossPrice;  //C018893
      IF InventSetup."Sales Disc Trade Item based on" = InventSetup."Sales Disc Trade Item based on"::DiscTerm THEN BEGIN
        CheckDiscPrio(DiscRef1, DiscRef2, DiscPrio, DiscPrio0, DiscPrio1, DiscPrio2);
        IF (DiscPrio2 >= 0) AND (DiscRef2 <> '') THEN BEGIN
          DiscLevel := 2;
          DiscPresent2 :=
            CheckDiscountLevel(TradeItem, DiscountTermHistory, FALSE, DiscLevel, DiscRef2, RefDate, DiscType::Sales);
          DiscPerc2 := TradeItem."Discount Percentage";
          PriceAgreement2 := DiscountTermHistory."Price Agreement (Sales)" AND DiscPresent2;
        END;
        IF (DiscPrio1 >= 0) AND (DiscRef1 <> '') THEN BEGIN
          DiscLevel := 1;
          DiscPresent1 :=
            CheckDiscountLevel(TradeItem, DiscountTermHistory, FALSE, DiscLevel, DiscRef1, RefDate, DiscType::Sales);
          DiscPerc1 := TradeItem."Discount Percentage";
          PriceAgreement1 := DiscountTermHistory."Price Agreement (Sales)" AND DiscPresent1;
        END;
        IF DiscPrio0 >= 0 THEN BEGIN
          DiscLevel := 0;
          DiscPresent0 :=
            CheckDiscountLevel(TradeItem, DiscountTermHistory, FALSE, DiscLevel, '', RefDate, DiscType::Sales);
          DiscPerc0 := TradeItem."Discount Percentage";
          PriceAgreement0 := DiscountTermHistory."Price Agreement (Sales)" AND DiscPresent0;
        END;
        DiscPerc := DiscPerc0;
        IF ((DiscPrio1 = DiscPrio0) AND (DiscPerc1 > DiscPerc) AND (DiscPerc1 <> 0)) OR  //C018893
           ((DiscPrio1 > DiscPrio0) AND (DiscPresent1 = TRUE)) THEN
          DiscPerc := DiscPerc1;
        IF ((DiscPrio2 = DiscPrio0) AND (DiscPerc2 > DiscPerc) AND (DiscPerc2 <> 0)) OR  //C018893
           ((DiscPrio2 > DiscPrio0) AND (DiscPresent2 = TRUE)) THEN
          DiscPerc := DiscPerc2;
        NetPrice := ROUND(GrossPrice * (100-DiscPerc)/100, GLSetup."Unit-Amount Rounding Precision");

        IF PriceAgreement2 OR PriceAgreement1 OR PriceAgreement0 THEN
          EXIT(TRUE);
        IF DiscPresent2 OR DiscPresent1 OR DiscPresent0 THEN
          IF DiscPerc <> 0 THEN
            EXIT(TRUE);
      END ELSE BEGIN
        CheckDiscountLevel(TradeItem, DiscountTermHistory, TRUE, 0, '', RefDate, DiscType::Sales);
        ItemGrp := DiscountTermHistory."Sales Discount Group";
        IF DiscountPercItemGroupPresent(CustCde, CustGrp, ItemGrp, RefDate, DiscPerc) THEN BEGIN
          NetPrice := ((100 - DiscPerc)/100 ) * GrossPrice;
          EXIT(TRUE);
        END;
      END;

      EXIT(FALSE);
    END;

    [External]
    PROCEDURE GetSalesBuyBackRates@1100525008(ItemNo@1100525000 : Code[20];PlantLocCode@1100525001 : Code[20];RefDate@1100525002 : Date;VAR SalesRate@1100525003 : Decimal;VAR BuyBackRate@1100525004 : Decimal);
    VAR
      Item2@1100525005 : Record 27;
      PlantOrder@1100525006 : Record 11012556;
      PlantOrderLine@1100525007 : Record 11012557;
      PlantOrderLine2@1100529000 : Record 11012557;
    BEGIN
      CLEAR(BuyBackRate);

      Item2.GET(ItemNo);
      IF Item2."Sales/Buy-Back Item (Plant)" THEN BEGIN
        PlantOrder."Transfer Date" := RefDate;
        PlantOrder."To Location" := PlantLocCode;
        PlantOrder.Type := PlantOrder.Type::Arrival;
        PlantOrderLine.SetOrderHeader(PlantOrder);
        PlantOrderLine.VALIDATE(Type,PlantOrderLine.Type::Item);
        PlantOrderLine.VALIDATE("Item No.",ItemNo);
        SalesRate := PlantOrderLine."Sales Rate";

        PlantOrder."From Location" := PlantLocCode;
        PlantOrder.Type := PlantOrder.Type::Removal;
        PlantOrderLine2.SetOrderHeader(PlantOrder);
        PlantOrderLine2.VALIDATE(Type,PlantOrderLine.Type::Item);
        PlantOrderLine2.VALIDATE("Item No.",ItemNo);
        BuyBackRate := PlantOrderLine2."Sales Rate";
      END;
    END;

    [External]
    PROCEDURE SetLanguageCode@1100525010(iLanguageCode@1100525000 : Code[10]);
    BEGIN
      LanguageCode := iLanguageCode;
    END;

    [External]
    PROCEDURE SetQuantity@1100525012(iQuanDec@1100525000 : Decimal);
    BEGIN
      QuanDec := iQuanDec;
    END;

    [External]
    PROCEDURE SetVendor@1100525013(iVendor@1100525000 : Code[20]);
    VAR
      Vendor@1100525001 : Record 23;
    BEGIN
      VendorNavItem := iVendor;  //C045045
      IF NOT Vendor.GET(iVendor) THEN Vendor.INIT;
      VendorTradeItem := Vendor."Vendor (Trade Item)";

      IF (VendorTradeItem = '') THEN BEGIN
        IF NOT Vendor.GET(Vendor."Main Vendor") THEN Vendor.INIT;
        VendorTradeItem := Vendor."Vendor (Trade Item)";
      END;
    END;

    [External]
    PROCEDURE GetBaseUnit@1100525011(IItem@1100525004 : Code[20];IBasicItem@1100525003 : Code[20];ITradeItem@1100525002 : Code[20];IManufacturer@1100525001 : Code[20];IVendor@1100525000 : Code[20]) : Text[10];
    VAR
      Item@1100525005 : Record 27;
      TradeItem@1100525006 : Record 11012317;
      BasicItem@1100525007 : Record 11012316;
    BEGIN
      IF ITradeItem <> '' THEN BEGIN
        IF TradeItem.GET(IVendor, ITradeItem) THEN
          EXIT(TradeItem."Application Unit");
      END ELSE BEGIN
        IF IBasicItem <> '' THEN BEGIN
          IF BasicItem.GET(IManufacturer, IBasicItem) THEN
            EXIT(BasicItem."Application Unit");
        END ELSE BEGIN
          IF IItem <> '' THEN BEGIN
            IF Item.GET(IItem) THEN
              EXIT(Item."Base Unit of Measure");
          END;
        END;
      END;

      EXIT('');
    END;

    [External]
    PROCEDURE GetItemRelationsPresent@1210190001() : Boolean;
    VAR
      ItemRelation@1210190000 : Record 11012319;
    BEGIN
      IF NOT ItemRelationsRead THEN
        ItemRelationsPresent := NOT ItemRelation.ISEMPTY;

      ItemRelationsRead:= TRUE;
      EXIT(ItemRelationsPresent);
    END;

    [External]
    PROCEDURE GetGLSetup@1210190014();
    BEGIN
      IF NOT GLSetupRead THEN BEGIN
        GLSetup.GET;
        GLSetupRead := TRUE;
      END;
    END;

    [External]
    PROCEDURE GetInventSetup@1210190005();
    BEGIN
      IF NOT InventSetupRead THEN BEGIN
        InventSetup.GET;
        InventSetupRead := TRUE;
      END;
    END;

    [External]
    PROCEDURE GetCust@1210190007(CustNo@1210190000 : Code[20]) : Boolean;
    BEGIN
      IF CustNo <> Customer."No." THEN BEGIN
        CustPresent := Customer.GET(CustNo);
        IF NOT CustPresent THEN
          Customer.INIT;
      END;
      Customer."No." := CustNo;  //db, 08-08-16: init doesn't clear key-field
      EXIT(CustPresent);
    END;

    LOCAL PROCEDURE GetNavisionItemInfo@1210190006(VAR ItemNo@1210190000 : Code[20];VAR DescTxt@1210190003 : Text[100];VAR DescTxt2@1210190002 : Text[50];VAR CostObject@1210190004 : Code[20];VAR CostComp@1210190001 : Code[10];CheckSetup@1210190006 : Boolean);
    VAR
      Item@1210190005 : Record 27;
    BEGIN
      IF ItemNo = '' THEN
        EXIT;

      IF CheckSetup THEN BEGIN
        GetInventSetup;
        IF InventSetup."Item Info Trade Item Leading" THEN
          EXIT;
      END;
      IF NOT Item.GET(ItemNo) THEN
        EXIT;

      CostObject := Item."Global Dimension 2 Code";
      GetCostComponent(CostObject, CostComp);
      DescTxt := Item.Description;
      DescTxt2 := Item."Description 2";
      GetItemTranslation(ItemNo, DescTxt, DescTxt2);
    END;

    [External]
    PROCEDURE GetNavisionItemPrices@1210190008(ItemCde@1210190004 : Code[20];VAR UnitCde@1210190003 : Code[10];VAR NetPrice@1210190002 : Decimal;VAR DiscPerc@1210190001 : Decimal;VAR GrossPrice@1210190000 : Decimal;RefDate@1100525003 : Date;CheckSetup@1210190005 : Boolean);
    VAR
      Item@1210190006 : Record 27;
      PurchasePrice@1100525000 : Record 7012;
      PurchaseLineDiscount@1100525001 : Record 7014;
      VendorPrice@1100525002 : Decimal;
      VendorDiscount@1100525004 : Decimal;
    BEGIN
      //call 33754
      IF ItemCde = '' THEN
        EXIT;

      GetInventSetup;
      IF CheckSetup AND InventSetup."Price Info Trade Item Leading" THEN
          EXIT;

      IF NOT Item.GET(ItemCde) THEN
        EXIT;

      UnitCde := Item."Base Unit of Measure";
      IF (InventSetup."Use Direct Unit Cost as Budget") AND
         (Item."Replenishment System" = Item."Replenishment System"::Purchase ) THEN
        NetPrice := Item."Last Direct Cost"
      ELSE
        NetPrice := Item."Unit Cost";
      GrossPrice := Item."Unit Price";

      //C045045.sn
      IF GetCostPriceItem(VendorNavItem, ItemCde, RefDate, VendorPrice) THEN
        NetPrice := VendorPrice;
      IF GetPurchaseDiscountItem(VendorNavItem, ItemCde, RefDate, VendorDiscount) THEN
        NetPrice := NetPrice * (100-VendorDiscount)/100;
      //C045045.en

      IF GrossPrice = 0 THEN GrossPrice := NetPrice;  //C018215
      DiscPerc := 0;
      IF GrossPrice <> 0 THEN
        DiscPerc := 100 * (GrossPrice - NetPrice) / GrossPrice;
    END;

    [External]
    PROCEDURE SkipErrorUnitConversion@1100409000(iSkipError@1100409000 : Boolean);
    BEGIN
      //C002191
      SkipError := iSkipError;
    END;

    [External]
    PROCEDURE ShowSalesCondition@1100525014(CustNo@1100525013 : Code[20];ItemNo@1100525012 : Code[20];BasicItemNo@1100525011 : Code[20];TradeItemNo@1100525010 : Code[20];lvManufacturer@1100525009 : Code[20];VendorNo@1100525008 : Code[20];NetPrice@1100525007 : Decimal;DiscPerc@1100525006 : Decimal;GrossPrice@1100525005 : Decimal;RefDate@1100525004 : Date;CustDiscGrp@1100525003 : Code[20];DiscRef1@1100525002 : Code[20];DiscRef2@1100525001 : Code[20];DiscPrio@1100525000 : Code[10]);
    BEGIN
      //C015604
      ShowSalesDiscount := TRUE;
      GetSalesDiscount(
        CustNo, ItemNo, BasicItemNo, TradeItemNo, lvManufacturer, VendorNo,
        NetPrice, DiscPerc, GrossPrice, RefDate, CustDiscGrp,
        DiscRef1, DiscRef2, DiscPrio);
      ShowSalesDiscount := FALSE;
    END;

    [External]
    PROCEDURE GetCostPriceItem@1100525017(VendorNo@1100485002 : Code[20];ItemNo@1100485001 : Code[20];RefDate@1100485000 : Date;VAR CostPrice@1210190000 : Decimal) : Boolean;
    VAR
      PurchasePrice@1210190001 : Record 7012;
    BEGIN
      //C045045
      WITH PurchasePrice DO BEGIN
        SETRANGE("Item No.", ItemNo);
        SETRANGE("Vendor No.", VendorNo);
        SETRANGE("Starting Date", 0D, RefDate);
        SETFILTER("Ending Date", '%1|>=%2', 0D, RefDate);
        SETFILTER("Minimum Quantity", '..%1', ABS(QuanDec));
        IF FINDLAST THEN BEGIN
          CostPrice := "Direct Unit Cost";
          EXIT(TRUE);
        END;
      END;
      CostPrice := 0;
      EXIT(FALSE);
    END;

    [External]
    PROCEDURE GetPurchaseDiscountItem@1100525016(VendorNo@1100525000 : Code[20];ItemNo@1100485002 : Code[20];RefDate@1100485001 : Date;VAR DiscPerc@1100485000 : Decimal) : Boolean;
    VAR
      PurchaseLineDiscount@1210190002 : Record 7014;
    BEGIN
      //C045045
      WITH PurchaseLineDiscount DO BEGIN
        SETRANGE("Item No.", ItemNo);
        SETRANGE("Vendor No.", VendorNo);
        SETRANGE("Starting Date", 0D, RefDate);
        SETFILTER("Ending Date", '%1|>=%2', 0D, RefDate);
        SETFILTER("Minimum Quantity", '..%1', ABS(QuanDec));
        IF FINDLAST THEN BEGIN
          DiscPerc := "Line Discount %";
          EXIT(TRUE);
        END;
      END;

      DiscPerc := 0;
      EXIT(FALSE);
    END;

    LOCAL PROCEDURE "---EVRY---"@1100290003();
    BEGIN
    END;

    PROCEDURE SetPriceListCode@1100290004(_code@1100290000 : Code[10]);
    BEGIN
      // LAHE 130116
      PriceListCode := _code;
    END;

    PROCEDURE GetPriceHistFound@1100290001() : Boolean;
    BEGIN
      // LAHE 130116
      EXIT(PriceHistFound);
    END;

    PROCEDURE GetPriceHistVendorNo@1000000000() : Code[20];
    BEGIN
      // LAHE 130116
      EXIT(PriceListVendorNo);
    END;

    PROCEDURE GetLatestCustGrossPrice@1100409003() : Decimal;
    BEGIN
      // ANCA 150527
      EXIT(LatestCustGrossPrice);
    END;

    LOCAL PROCEDURE "--ITERO---"@5();
    BEGIN
    END;

    PROCEDURE SetDontUseSingleGTIN@7(setFlag@1000 : Boolean);
    BEGIN
      DontUseSingleGTIN := setFlag;
    END;

    PROCEDURE GetFoundSalesDiscRef@1100285002() : Code[20];
    BEGIN
      // 150914 ITERO.AC RFC001-2
      EXIT(gvFoundSalesDiscRef);
    END;

    BEGIN
    {
      4PS01 HBK 06-08-09: Added function SetLanguageCode and changed GetItemTranslation

      -SE EVRY-
      LAHE 130116 "Price List Code"


      150608 ITERO.DL SYM086, Error unit of measure NAV
      150912 ITERO.AC IME413 Bugfix in Sales price calculation when DetermineSalesDiscount is called from Project Cost Plus Entry and (customer) Price List Code = ''
      150914 ITERO.AC RFC001-2 Save found Discount Reference in gvFoundSalesDiscRef in order to read set the value in table "Project Cost Plus Entry", Get Function GetFoundSalesDiscRef(), Modified DetermineSalesDiscount()
      200331 ORANGO.PR Certego Price 3 New Functions: SurchargePercItemPresent, SurchargePercItemGroupPresent, GetSalesDiscountSurcharge
    }
    END.
  }
}

