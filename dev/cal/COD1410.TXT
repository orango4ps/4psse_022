OBJECT Codeunit 1410 Doc. Exch. Service Mgt.
{
  OBJECT-PROPERTIES
  {
    Date=;
    Time=;
    Version List=NAVW114.01;
  }
  PROPERTIES
  {
    Permissions=TableData 112=m,
                TableData 114=m;
    OnRun=BEGIN
          END;

  }
  CODE
  {
    VAR
      MissingCredentialsQst@1000 : TextConst '@@@="%1=Doc. Exch. Service Setup";ENU=The %1 is missing the secret keys or tokens. Do you want to open the %1 window?;NOR=%1 mangler hemmelige n›kler eller tokener. Vil du †pne vinduet %1?;SVE=%1 saknar hemliga nycklar eller token. Vill du ”ppna f”nstret %1?';
      MissingCredentialsErr@1001 : TextConst '@@@="%1 = Doc. Exch. Service Setup";ENU=The tokens and secret keys must be filled in the %1 window.;NOR=Tokener og hemmelige n›kler m† fylles ut i vinduet %1.;SVE=Token och hemliga nycklar m†ste anges i f”nstret %1.';
      ResponseTempBlob@1006 : Record 99008535;
      TempTraceTempBlob@1028 : TEMPORARY Record 99008535;
      Trace@1027 : Codeunit 1292;
      HttpWebRequestMgt@1005 : Codeunit 1297;
      ConnectionSuccessMsg@1012 : TextConst 'ENU=The connection test was successful. The settings are valid.;NOR=Tilkoblingstesten er fullf›rt. Innstillingene er gyldige.;SVE=Anslutningstestet har utf”rts. Inst„llningarna „r giltiga.';
      DocSendSuccessMsg@1007 : TextConst '@@@=%1 is the actual document no.;ENU=The document was successfully sent to the document exchange service for processing.;NOR=Dokumentet er sendt til dokumentutvekslingstjenesten for behandling.;SVE=Dokumentet har skickats till dokumentv„xlingstj„nsten f”r bearbetning.';
      DocUploadSuccessMsg@1030 : TextConst '@@@=%1 is the actual document no.;ENU=The document was successfully uploaded to the document exchange service for processing.;NOR=Dokumentet er lastet opp til dokumentutvekslingstjenesten for behandling.;SVE=Dokumentet har laddats upp till dokumentv„xlingstj„nsten f”r bearbetning.';
      DocDispatchSuccessMsg@1017 : TextConst '@@@=%1 is the actual document no.;ENU=The document was successfully sent for dispatching.;NOR=Dokumentet er sendt til fordeling.;SVE=Dokumentet har skickats f”r avs„ndning.';
      DocDispatchFailedMsg@1018 : TextConst '@@@=%1 is the actual document no.;ENU="The document was not successfully dispatched. ";NOR="Dokumentet ble ikke fordelt. ";SVE="Dokumentet kunde inte skickas. "';
      DocStatusOKMsg@1016 : TextConst '@@@=%1 is the returned value.;ENU=The current status of the electronic document is %1.;NOR=Gjeldende status for det elektroniske dokumentet er %1.;SVE=Aktuell status f”r det elektroniska dokumentet „r %1.';
      NotEnabledErr@1010 : TextConst 'ENU=The document exchange service is not enabled.;NOR=Dokumentutvekslingstjenesten er ikke aktivert.;SVE=Dokumentv„xlingstj„nsten „r inte aktiverad.';
      DocExchLinks@1020 : Codeunit 1411;
      XMLDOMMgt@1033 : Codeunit 6224;
      GLBResponseInStream@1011 : InStream;
      CheckConnectionTxt@1013 : TextConst 'ENU=Check connection.;NOR=Kontroller tilkobling.;SVE=Kontrollera anslutning.';
      SendDocTxt@1014 : TextConst 'ENU=Send document.;NOR=Send dokumentet.;SVE=Skicka dokument.';
      GLBHttpStatusCode@1008 : DotNet "'System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Net.HttpStatusCode";
      GLBResponseHeaders@1019 : DotNet "'System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Collections.Specialized.NameValueCollection";
      GLBLastUsedGUID@1015 : Text;
      DispatchDocTxt@1009 : TextConst 'ENU=Dispatch document.;NOR=Fordel dokumentet.;SVE=Skicka dokument.';
      GetDocStatusTxt@1002 : TextConst 'ENU=Check document status.;NOR=Kontroller dokumentstatusen.;SVE=Kontrollera dokumentstatus.';
      GetDocsTxt@1021 : TextConst 'ENU=Get received documents.;NOR=Hent mottatte dokumenter.;SVE=H„mta mottagna dokument.';
      LoggingConstTxt@1003 : TextConst 'ENU=Document exchange service.;NOR=Dokumentutvekslingstjeneste.;SVE=Dokumentv„xlingstj„nst.';
      GetDocErrorTxt@1004 : TextConst 'ENU=Check document dispatch errors.;NOR=Kontroller feil for dokumentutsending.;SVE=Kontrollera dokumentutskicksfel.';
      MarkBusinessProcessedTxt@1022 : TextConst 'ENU=Mark as Business Processed.;NOR=Merk som forretningsbehandlet.;SVE=Markera som bearbetad.';
      DocIdImportedTxt@1023 : TextConst '@@@=%1 is the actual doc id.;ENU=The document ID %1 is imported into incoming documents.;NOR=Dokument-ID-en %1 er importert til inng†ende dokumenter.;SVE=Dokument-ID %1 „r importerat till inkommande dokument.';
      FileInvalidTxt@1024 : TextConst '@@@=%1 is the actual doc id;ENU="The document ID %1 is not a valid XML format. ";NOR="Dokument-ID-en %1 har ikke et gyldig XML-format. ";SVE="Dokument-ID %1 „r inte ett giltigt XML-format. "';
      GLBTraceLogEnabled@1026 : Boolean;
      UnSupportedTableTypeErr@1025 : TextConst '@@@=%1 is the table.;ENU=The %1 table is not supported.;NOR=Tabellen %1 st›ttes ikke.;SVE=Tabellen %1 st”ds inte.';
      InvalidHeaderResponseMsg@1029 : TextConst 'ENU=The document exchange service did not return a document identifier.;NOR=Dokumentutvekslingstjenesten returnerte ikke en dokumentidentifikator.;SVE=Dokumentv„xlingstj„nsten returnerade inte en dokumentidentifierare.';
      CannotResendErr@1031 : TextConst 'ENU=You cannot send this electronic document because it is already delivered or in progress.;NOR=Du kan ikke sende dette elektroniske dokumentet fordi det allerede er levert eller til behandling.;SVE=Du kan inte skicka det h„r elektroniska dokumentet eftersom det redan „r levererat eller bearbetas.';
      MalformedGuidErr@1032 : TextConst 'ENU=The document exchange service did not return a valid document identifier.;NOR=Dokumentutvekslingstjenesten returnerte ikke en gyldig dokumentidentifikator.;SVE=Dokumentv„xlingstj„nsten returnerade inte en giltig dokumentidentifierare.';
      DocExchServiceDocumentSuccessfullySentTxt@1036 : TextConst '@@@={Locked};ENU=The user successfully sent a document via the exchange service.;NOR=The user successfully sent a document via the exchange service.';
      DocExchServiceDocumentSuccessfullyReceivedTxt@1035 : TextConst '@@@={Locked};ENU=The user successfully received a document via the exchange service.;NOR=The user successfully received a document via the exchange service.';
      TelemetryCategoryTok@1034 : TextConst '@@@={Locked};ENU=AL Document Exchange Service;NOR=AL Document Exchange Service';

    [External]
    PROCEDURE SetURLsToDefault@2(VAR DocExchServiceSetup@1000 : Record 1275);
    BEGIN
      WITH DocExchServiceSetup DO BEGIN
        "Sign-up URL" := 'https://go.tradeshift.com/register';
        "Service URL" := 'https://api.tradeshift.com/tradeshift/rest/external';
        "Sign-in URL" := 'https://go.tradeshift.com/login';
        "User Agent" := COPYSTR(COMPANYNAME + '/v1.0',1,MAXSTRLEN("User Agent"));
      END;
    END;

    [Internal]
    PROCEDURE CheckConnection@10();
    VAR
      DocExchServiceSetup@1000 : Record 1275;
    BEGIN
      VerifyPrerequisites(TRUE);
      Initialize(GetCheckConnectionURL,'GET','');

      DocExchServiceSetup.GET;
      IF NOT ExecuteWebServiceRequest THEN
        LogActivityFailedAndError(DocExchServiceSetup.RECORDID,CheckConnectionTxt,'');

      LogActivitySucceeded(DocExchServiceSetup.RECORDID,CheckConnectionTxt,ConnectionSuccessMsg);

      MESSAGE(ConnectionSuccessMsg);

      IF GLBTraceLogEnabled THEN
        Trace.LogStreamToTempFile(GLBResponseInStream,'checkstatus',TempTraceTempBlob);
    END;

    [Internal]
    PROCEDURE SendUBLDocument@36(DocVariant@1003 : Variant;FileName@1000 : Text) : Text;
    VAR
      DocRecRef@1002 : RecordRef;
    BEGIN
      CheckServiceEnabled;

      DocRecRef.GETTABLE(DocVariant);

      CheckDocumentStatus(DocRecRef);

      Initialize(GetPostSalesURL(DocRecRef),'POST',FileName);

      IF NOT ExecuteWebServiceRequest THEN
        LogActivityFailedAndError(DocRecRef.RECORDID,SendDocTxt,'');

      LogActivitySucceeded(DocRecRef.RECORDID,SendDocTxt,DocSendSuccessMsg);

      DocExchLinks.UpdateDocumentRecord(DocRecRef,GLBLastUsedGUID,'');

      LogTelemetryDocumentSent;

      IF GUIALLOWED THEN
        MESSAGE(DocSendSuccessMsg);

      EXIT(GLBLastUsedGUID);
    END;

    [Internal]
    PROCEDURE SendDocument@20(DocVariant@1003 : Variant;FileName@1001 : Text) : Text;
    VAR
      DocRecRef@1002 : RecordRef;
      DocIdentifier@1000 : Text;
    BEGIN
      CheckServiceEnabled;

      DocIdentifier := GetGUID;
      DocRecRef.GETTABLE(DocVariant);

      CheckDocumentStatus(DocRecRef);

      PutDocument(FileName,DocIdentifier,DocRecRef);
      DispatchDocument(DocIdentifier,DocRecRef);

      LogTelemetryDocumentSent;

      IF GUIALLOWED THEN
        MESSAGE(DocSendSuccessMsg);

      EXIT(DocIdentifier);
    END;

    LOCAL PROCEDURE PutDocument@26(FileName@1003 : Text;DocIdentifier@1000 : Text;DocRecRef@1002 : RecordRef);
    BEGIN
      Initialize(GetPUTDocURL(DocIdentifier),'PUT',FileName);

      IF NOT ExecuteWebServiceRequest THEN
        LogActivityFailedAndError(DocRecRef.RECORDID,SendDocTxt,'');

      IF NOT GLBHttpStatusCode.Equals(GLBHttpStatusCode.NoContent) THEN
        LogActivityFailedAndError(DocRecRef.RECORDID,SendDocTxt,'');

      LogActivitySucceeded(DocRecRef.RECORDID,SendDocTxt,DocUploadSuccessMsg);

      IF GLBTraceLogEnabled THEN
        Trace.LogStreamToTempFile(GLBResponseInStream,'put',TempTraceTempBlob);
    END;

    LOCAL PROCEDURE DispatchDocument@31(DocOrigIdentifier@1000 : Text;DocRecRef@1001 : RecordRef);
    VAR
      DocIdentifier@1003 : Text;
      PlaceholderGuid@1002 : GUID;
    BEGIN
      Initialize(GetDispatchDocURL(DocOrigIdentifier),'POST','');

      IF NOT ExecuteWebServiceRequest THEN
        LogActivityFailedAndError(DocRecRef.RECORDID,DispatchDocTxt,'');

      IF NOT GLBHttpStatusCode.Equals(GLBHttpStatusCode.Created) THEN BEGIN
        DocExchLinks.UpdateDocumentRecord(DocRecRef,'',DocOrigIdentifier);
        LogActivityFailedAndError(DocRecRef.RECORDID,DispatchDocTxt,DocDispatchFailedMsg);
      END;

      IF GLBTraceLogEnabled THEN
        Trace.LogStreamToTempFile(GLBResponseInStream,'dispatch',TempTraceTempBlob);

      DocIdentifier := GLBResponseHeaders.Get(GetDocumentIDKey);
      IF NOT EVALUATE(PlaceholderGuid,DocIdentifier) THEN
        LogActivityFailedAndError(DocRecRef.RECORDID,DispatchDocTxt,InvalidHeaderResponseMsg);
      DocExchLinks.UpdateDocumentRecord(DocRecRef,DocIdentifier,DocOrigIdentifier);

      LogActivitySucceeded(DocRecRef.RECORDID,DispatchDocTxt,DocDispatchSuccessMsg);
    END;

    [Internal]
    PROCEDURE GetDocumentStatus@18(DocRecordID@1000 : RecordID;DocIdentifier@1003 : Text[50];DocOrigIdentifier@1002 : Text[50]) : Text;
    VAR
      Errors@1005 : Text;
    BEGIN
      CheckServiceEnabled;

      // Check for dispatch errors first
      IF DocOrigIdentifier <> '' THEN
        IF GetDocDispatchErrors(DocRecordID,DocOrigIdentifier,Errors) THEN
          IF Errors <> '' THEN
            EXIT('FAILED');

      // Check metadata
      IF NOT GetDocumentMetadata(DocRecordID,DocIdentifier,Errors) THEN
        EXIT('PENDING');

      // If metadata exist it means doc has been dispatched
      EXIT(Errors);
    END;

    LOCAL PROCEDURE GetDocDispatchErrors@27(DocRecordID@1000 : RecordID;DocIdentifier@1003 : Text;VAR Errors@1002 : Text) : Boolean;
    VAR
      XmlDoc@1004 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlDocument";
    BEGIN
      CheckServiceEnabled;

      Initialize(GetDispatchErrorsURL(DocIdentifier),'GET','');

      IF NOT ExecuteWebServiceRequest THEN BEGIN
        LogActivityFailed(DocRecordID,GetDocErrorTxt,'');
        EXIT(FALSE);
      END;

      IF NOT HttpWebRequestMgt.TryLoadXMLResponse(GLBResponseInStream,XmlDoc) THEN BEGIN
        LogActivityFailed(DocRecordID,GetDocErrorTxt,'');
        EXIT(FALSE);
      END;

      Errors := XMLDOMMgt.FindNodeTextWithNamespace(XmlDoc.DocumentElement,GetErrorXPath,
          GetPrefix,GetApiNamespace);

      LogActivitySucceeded(DocRecordID,GetDocErrorTxt,Errors);

      IF GLBTraceLogEnabled THEN
        Trace.LogStreamToTempFile(GLBResponseInStream,'dispatcherrors',TempTraceTempBlob);

      EXIT(TRUE);
    END;

    [Internal]
    PROCEDURE GetDocumentMetadata@19(DocRecordID@1000 : RecordID;DocIdentifier@1003 : Text[50];VAR NewStatus@1002 : Text) : Boolean;
    VAR
      XmlDoc@1004 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlDocument";
    BEGIN
      CheckServiceEnabled;
      NewStatus := '';

      Initialize(GetDocStatusURL(DocIdentifier),'GET','');

      IF NOT ExecuteWebServiceRequest THEN BEGIN
        LogActivityFailed(DocRecordID,GetDocStatusTxt,'');
        EXIT(FALSE);
      END;

      IF NOT HttpWebRequestMgt.TryLoadXMLResponse(GLBResponseInStream,XmlDoc) THEN BEGIN
        LogActivityFailed(DocRecordID,GetDocStatusTxt,'');
        EXIT(FALSE);
      END;

      IF GLBTraceLogEnabled THEN
        Trace.LogStreamToTempFile(GLBResponseInStream,'checkstatus',TempTraceTempBlob);

      NewStatus := XMLDOMMgt.FindNodeTextWithNamespace(XmlDoc.DocumentElement,GetStatusXPath,GetPrefix,GetPublicNamespace);
      LogActivitySucceeded(DocRecordID,GetDocStatusTxt,STRSUBSTNO(DocStatusOKMsg,NewStatus));
      EXIT(TRUE);
    END;

    [Internal]
    PROCEDURE ReceiveDocuments@9(ContextRecordID@1002 : RecordID);
    VAR
      XmlDoc@1001 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlDocument";
    BEGIN
      CheckServiceEnabled;

      Initialize(GetRetrieveDocsURL,'GET','');

      IF NOT ExecuteWebServiceRequest THEN
        LogActivityFailedAndError(ContextRecordID,GetDocsTxt,'');

      IF NOT HttpWebRequestMgt.TryLoadXMLResponse(GLBResponseInStream,XmlDoc) THEN
        LogActivityFailedAndError(ContextRecordID,GetDocsTxt,'');

      ProcessReceivedDocs(ContextRecordID,XmlDoc);
    END;

    LOCAL PROCEDURE ProcessReceivedDocs@126(ContextRecordID@1004 : RecordID;XmlDocs@1001 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlDocument");
    VAR
      IncomingDocument@1003 : Record 130;
      XMLRootNode@1005 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlNode";
      Node@1009 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlNode";
      DummyGuid@1010 : GUID;
      DocIdentifier@1002 : Text;
      Description@1000 : Text;
    BEGIN
      XMLRootNode := XmlDocs.DocumentElement;

      FOREACH Node IN XMLRootNode.ChildNodes DO BEGIN
        DocIdentifier := XMLDOMMgt.FindNodeTextWithNamespace(Node,GetDocumentIDXPath,
            GetPrefix,GetPublicNamespace);

        IF NOT EVALUATE(DummyGuid,DocIdentifier) THEN
          LogActivityFailedAndError(ContextRecordID,GetDocsTxt,MalformedGuidErr);
        IF TryGetDocumentDescription(Node,Description) THEN;
        IF DELCHR(Description,'<>',' ') = '' THEN
          Description := DocIdentifier;
        GetOriginalDocument(ContextRecordID,DocIdentifier);
        CreateIncomingDocEntry(IncomingDocument,ContextRecordID,DocIdentifier,Description);

        IF NOT MarkDocBusinessProcessed(DocIdentifier) THEN BEGIN
          IncomingDocument.DELETE;
          LogActivityFailed(ContextRecordID,MarkBusinessProcessedTxt,'');
        END ELSE
          LogActivitySucceeded(ContextRecordID,MarkBusinessProcessedTxt,STRSUBSTNO(DocIdImportedTxt,DocIdentifier));
        COMMIT;

        IncomingDocument.FIND;
        LogTelemetryDocumentReceived;
        OnAfterIncomingDocReceivedFromDocExch(IncomingDocument);
      END;
    END;

    LOCAL PROCEDURE GetOriginalDocument@42(ContextRecordID@1002 : RecordID;DocIdentifier@1000 : Text);
    BEGIN
      CheckServiceEnabled;

      Initialize(GetRetrieveOriginalDocIDURL(DocIdentifier),'GET','');

      // If can't get the original, it means it was not a 2-step. Get the actual TS-UBL
      IF NOT ExecuteWebServiceRequest THEN
        GetDocument(ContextRecordID,DocIdentifier);
    END;

    LOCAL PROCEDURE GetDocument@29(ContextRecordID@1002 : RecordID;DocIdentifier@1000 : Text);
    BEGIN
      CheckServiceEnabled;

      Initialize(GetRetrieveDocIDURL(DocIdentifier),'GET','');

      IF NOT ExecuteWebServiceRequest THEN
        LogActivityFailedAndError(ContextRecordID,GetDocsTxt,'');
    END;

    [TryFunction]
    LOCAL PROCEDURE MarkDocBusinessProcessed@41(DocIdentifier@1001 : Text);
    BEGIN
      CheckServiceEnabled;

      Initialize(GetSetTagURL(DocIdentifier),'PUT','');

      ExecuteWebServiceRequest;
    END;

    LOCAL PROCEDURE CreateIncomingDocEntry@131(VAR IncomingDocument@1001 : Record 130;ContextRecordID@1004 : RecordID;DocIdentifier@1003 : Text;Description@1005 : Text);
    VAR
      IncomingDocumentAttachment@1002 : Record 133;
      XmlDoc@1000 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlDocument";
    BEGIN
      // Assert response is XML
      IF NOT HttpWebRequestMgt.TryLoadXMLResponse(GLBResponseInStream,XmlDoc) THEN
        LogActivityFailedAndError(ContextRecordID,GetDocsTxt,STRSUBSTNO(FileInvalidTxt,DocIdentifier));

      IncomingDocument.CreateIncomingDocument(
        COPYSTR(Description,1,MAXSTRLEN(IncomingDocument.Description)),GetExternalDocURL(DocIdentifier));

      // set received XML as main attachment and extract additional ones as secondary attachments
      IncomingDocument.AddAttachmentFromStream(IncomingDocumentAttachment,DocIdentifier,'xml',GLBResponseInStream);
      ProcessAttachments(IncomingDocument,XmlDoc);
    END;

    LOCAL PROCEDURE ProcessAttachments@51(VAR IncomingDocument@1003 : Record 130;XmlDoc@1002 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlDocument");
    VAR
      NodeList@1001 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlNodeList";
      Node@1000 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlNode";
    BEGIN
      XMLDOMMgt.FindNodesWithNamespace(XmlDoc.DocumentElement,GetEmbeddedDocXPath,GetPrefix,GetCBCNamespace,
        NodeList);
      FOREACH Node IN NodeList DO
        ExtractAdditionalAttachment(IncomingDocument,Node);
    END;

    LOCAL PROCEDURE ExtractAdditionalAttachment@49(VAR IncomingDocument@1007 : Record 130;Node@1006 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlNode");
    VAR
      FileMgt@1004 : Codeunit 419;
      Convert@1003 : DotNet "'mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Convert";
      TempFile@1002 : DotNet "'mscorlib, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.IO.File";
      FilePath@1001 : Text;
      FileName@1000 : Text;
    BEGIN
      FileName := XMLDOMMgt.GetAttributeValue(Node,'filename');
      FilePath := FileMgt.ServerTempFileName(FileMgt.GetExtension(FileName));
      FileMgt.IsAllowedPath(FilePath,FALSE);
      TempFile.WriteAllBytes(FilePath,Convert.FromBase64String(Node.InnerText));
      IncomingDocument.AddAttachmentFromServerFile(FileName,FilePath);
    END;

    LOCAL PROCEDURE Initialize@3(URL@1002 : Text;Method@1001 : Text[6];BodyFilePath@1003 : Text);
    VAR
      DocExchServiceSetup@1000 : Record 1275;
      OAuthAuthorization@1006 : DotNet "'Microsoft.Dynamics.Nav.OAuth, Version=14.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35'.Microsoft.Dynamics.Nav.OAuthHelper.OAuthAuthorization";
      OAuthConsumer@1005 : DotNet "'Microsoft.Dynamics.Nav.OAuth, Version=14.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35'.Microsoft.Dynamics.Nav.OAuthHelper.Consumer";
      OAuthToken@1004 : DotNet "'Microsoft.Dynamics.Nav.OAuth, Version=14.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35'.Microsoft.Dynamics.Nav.OAuthHelper.Token";
    BEGIN
      CheckCredentials;

      WITH DocExchServiceSetup DO BEGIN
        GET;
        OAuthConsumer := OAuthConsumer.Consumer(GetPassword("Consumer Key"),GetPassword("Consumer Secret"));
        OAuthToken := OAuthToken.Token(GetPassword(Token),GetPassword("Token Secret"));
        OAuthAuthorization := OAuthAuthorization.OAuthAuthorization(OAuthConsumer,OAuthToken);
      END;

      CLEAR(HttpWebRequestMgt);
      HttpWebRequestMgt.Initialize(URL);
      HttpWebRequestMgt.SetMethod(Method);
      HttpWebRequestMgt.AddHeader('Authorization',OAuthAuthorization.GetAuthorizationHeader(URL,Method));

      SetDefaults(BodyFilePath);
    END;

    LOCAL PROCEDURE SetDefaults@16(BodyFilePath@1000 : Text);
    VAR
      DocExchServiceSetup@1001 : Record 1275;
    BEGIN
      HttpWebRequestMgt.SetContentType('text/xml');
      HttpWebRequestMgt.SetReturnType('text/xml');
      HttpWebRequestMgt.SetUserAgent(GetUserAgent);
      HttpWebRequestMgt.AddHeader('X-Tradeshift-TenantId',GetTenantID);
      HttpWebRequestMgt.AddHeader('Accept-Encoding','utf-8');
      HttpWebRequestMgt.AddBody(BodyFilePath);

      // Set tracing
      DocExchServiceSetup.GET;
      GLBTraceLogEnabled := DocExchServiceSetup."Log Web Requests";
      HttpWebRequestMgt.SetTraceLogEnabled(DocExchServiceSetup."Log Web Requests");
    END;

    [External]
    PROCEDURE CheckCredentials@4();
    VAR
      DocExchServiceSetup@1000 : Record 1275;
    BEGIN
      IF NOT VerifyPrerequisites(FALSE) THEN
        IF CONFIRM(STRSUBSTNO(MissingCredentialsQst,DocExchServiceSetup.TABLECAPTION),TRUE) THEN BEGIN
          COMMIT;
          PAGE.RUNMODAL(PAGE::"Doc. Exch. Service Setup",DocExchServiceSetup);
          IF NOT VerifyPrerequisites(FALSE) THEN
            ERROR(MissingCredentialsErr,DocExchServiceSetup.TABLECAPTION);
        END ELSE
          ERROR(MissingCredentialsErr,DocExchServiceSetup.TABLECAPTION);
    END;

    [TryFunction]
    LOCAL PROCEDURE ExecuteWebServiceRequest@1();
    BEGIN
      CLEAR(ResponseTempBlob);
      ResponseTempBlob.INIT;
      ResponseTempBlob.Blob.CREATEINSTREAM(GLBResponseInStream);

      IF NOT GUIALLOWED THEN
        HttpWebRequestMgt.DisableUI;

      IF NOT HttpWebRequestMgt.GetResponse(GLBResponseInStream,GLBHttpStatusCode,GLBResponseHeaders) THEN
        HttpWebRequestMgt.ProcessFaultXMLResponse('',GetErrorXPath,GetPrefix,GetApiNamespace);
    END;

    [External]
    PROCEDURE CheckServiceEnabled@6();
    VAR
      DocExchServiceSetup@1000 : Record 1275;
    BEGIN
      DocExchServiceSetup.GET;
      IF NOT DocExchServiceSetup.Enabled THEN
        ERROR(NotEnabledErr);
    END;

    LOCAL PROCEDURE CheckDocumentStatus@28(DocRecRef@1000 : RecordRef);
    VAR
      SalesInvoiceHeader@1001 : Record 112;
      SalesCrMemoHeader@1002 : Record 114;
      ServiceInvoiceHeader@1003 : Record 5992;
      ServiceCrMemoHeader@1004 : Record 5994;
    BEGIN
      CASE DocRecRef.NUMBER OF
        DATABASE::"Sales Invoice Header":
          BEGIN
            DocRecRef.SETTABLE(SalesInvoiceHeader);
            IF SalesInvoiceHeader."Document Exchange Status" IN
               [SalesInvoiceHeader."Document Exchange Status"::"Sent to Document Exchange Service",
                SalesInvoiceHeader."Document Exchange Status"::"Delivered to Recipient",
                SalesInvoiceHeader."Document Exchange Status"::"Pending Connection to Recipient"]
            THEN
              ERROR(CannotResendErr);
          END;
        DATABASE::"Sales Cr.Memo Header":
          BEGIN
            DocRecRef.SETTABLE(SalesCrMemoHeader);
            IF SalesCrMemoHeader."Document Exchange Status" IN
               [SalesCrMemoHeader."Document Exchange Status"::"Sent to Document Exchange Service",
                SalesCrMemoHeader."Document Exchange Status"::"Delivered to Recipient",
                SalesCrMemoHeader."Document Exchange Status"::"Pending Connection to Recipient"]
            THEN
              ERROR(CannotResendErr);
          END;
        DATABASE::"Service Invoice Header":
          BEGIN
            DocRecRef.SETTABLE(ServiceInvoiceHeader);
            IF ServiceInvoiceHeader."Document Exchange Status" IN
               [ServiceInvoiceHeader."Document Exchange Status"::"Sent to Document Exchange Service",
                ServiceInvoiceHeader."Document Exchange Status"::"Delivered to Recipient",
                ServiceInvoiceHeader."Document Exchange Status"::"Pending Connection to Recipient"]
            THEN
              ERROR(CannotResendErr);
          END;
        DATABASE::"Service Cr.Memo Header":
          BEGIN
            DocRecRef.SETTABLE(ServiceCrMemoHeader);
            IF ServiceCrMemoHeader."Document Exchange Status" IN
               [ServiceCrMemoHeader."Document Exchange Status"::"Sent to Document Exchange Service",
                ServiceCrMemoHeader."Document Exchange Status"::"Delivered to Recipient",
                ServiceCrMemoHeader."Document Exchange Status"::"Pending Connection to Recipient"]
            THEN
              ERROR(CannotResendErr);
          END;
        ELSE
          ERROR(UnSupportedTableTypeErr,DocRecRef.NUMBER);
      END;
    END;

    LOCAL PROCEDURE GetTenantID@11() : Text;
    VAR
      DocExchServiceSetup@1000 : Record 1275;
    BEGIN
      WITH DocExchServiceSetup DO BEGIN
        GET;
        EXIT(GetPassword("Doc. Exch. Tenant ID"));
      END;
    END;

    LOCAL PROCEDURE GetUserAgent@17() : Text;
    VAR
      DocExchServiceSetup@1000 : Record 1275;
    BEGIN
      WITH DocExchServiceSetup DO BEGIN
        GET;
        TESTFIELD("User Agent");
        EXIT("User Agent");
      END;
    END;

    LOCAL PROCEDURE GetFullURL@47(PartialURL@1000 : Text) : Text;
    VAR
      DocExchServiceSetup@1001 : Record 1275;
    BEGIN
      WITH DocExchServiceSetup DO BEGIN
        GET;
        TESTFIELD("Service URL");
        EXIT("Service URL" + PartialURL);
      END;
    END;

    LOCAL PROCEDURE GetCheckConnectionURL@5() : Text;
    BEGIN
      EXIT(GetFullURL('/account/info'));
    END;

    LOCAL PROCEDURE GetPostSalesURL@46(DocRecRef@1000 : RecordRef) : Text;
    BEGIN
      CASE DocRecRef.NUMBER OF
        DATABASE::"Sales Invoice Header",DATABASE::"Service Invoice Header":
          EXIT(GetPostSalesInvURL);
        DATABASE::"Sales Cr.Memo Header",DATABASE::"Service Cr.Memo Header":
          EXIT(GetPostSalesCrMemoURL);
        ELSE
          ERROR(UnSupportedTableTypeErr,DocRecRef.NUMBER);
      END;
    END;

    LOCAL PROCEDURE GetPostSalesInvURL@1110() : Text;
    BEGIN
      EXIT(GetFullURL(STRSUBSTNO('/documents/dispatcher?documentId=%1&documentProfileId=tradeshift.invoice.ubl.1.0',
            GetGUID)));
    END;

    LOCAL PROCEDURE GetPostSalesCrMemoURL@12() : Text;
    BEGIN
      EXIT(GetFullURL(STRSUBSTNO('/documents/dispatcher?documentId=%1&documentProfileId=tradeshift.creditnote.ubl.1.0',
            GetGUID)));
    END;

    LOCAL PROCEDURE GetDocStatusURL@15(DocIdentifier@1001 : Text) : Text;
    BEGIN
      EXIT(GetFullURL(STRSUBSTNO('/documents/%1/metadata',DocIdentifier)));
    END;

    LOCAL PROCEDURE GetPUTDocURL@119(FileName@1000 : Text) : Text;
    BEGIN
      EXIT(GetFullURL(STRSUBSTNO('/documentfiles/%1/file?directory=outbox',FileName)));
    END;

    LOCAL PROCEDURE GetDispatchDocURL@30(FileName@1000 : Text) : Text;
    BEGIN
      EXIT(GetFullURL(STRSUBSTNO('/documentfiles/%1/dispatcher?directory=outbox',FileName)));
    END;

    LOCAL PROCEDURE GetDispatchErrorsURL@23(DocIdentifier@1001 : Text) : Text;
    BEGIN
      EXIT(GetFullURL(STRSUBSTNO('/documentfiles/%1/errors',DocIdentifier)));
    END;

    LOCAL PROCEDURE GetRetrieveDocsURL@123() : Text;
    BEGIN
      EXIT(GetFullURL(STRSUBSTNO('/documents?stag=inbox&withouttag=BusinessDelivered&limit=%1',GetChunckSize)));
    END;

    LOCAL PROCEDURE GetRetrieveDocIDURL@130(DocIdentifier@1003 : Text) : Text;
    BEGIN
      EXIT(GetFullURL(STRSUBSTNO('/documents/%1',DocIdentifier)));
    END;

    LOCAL PROCEDURE GetRetrieveOriginalDocIDURL@21(DocIdentifier@1003 : Text) : Text;
    BEGIN
      EXIT(GetFullURL(STRSUBSTNO('/documents/%1/original',DocIdentifier)));
    END;

    LOCAL PROCEDURE GetSetTagURL@127(DocIdentifier@1002 : Text) : Text;
    BEGIN
      EXIT(GetFullURL(STRSUBSTNO('/documents/%1/tags/BusinessDelivered',DocIdentifier)));
    END;

    LOCAL PROCEDURE GetGUID@1111() : Text;
    BEGIN
      GLBLastUsedGUID := DELCHR(DELCHR(FORMAT(CREATEGUID),'=','{'),'=','}');

      EXIT(GLBLastUsedGUID);
    END;

    LOCAL PROCEDURE GetChunckSize@33() : Integer;
    BEGIN
      EXIT(100);
    END;

    LOCAL PROCEDURE GetApiNamespace@13() : Text;
    BEGIN
      EXIT('http://tradeshift.com/api/1.0');
    END;

    LOCAL PROCEDURE GetPublicNamespace@40() : Text;
    BEGIN
      EXIT('http://tradeshift.com/api/public/1.0');
    END;

    LOCAL PROCEDURE GetCBCNamespace@43() : Text;
    BEGIN
      EXIT('urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2');
    END;

    LOCAL PROCEDURE GetErrorXPath@48() : Text;
    BEGIN
      EXIT(STRSUBSTNO('//%1:Message',GetPrefix));
    END;

    LOCAL PROCEDURE GetStatusXPath@22() : Text;
    BEGIN
      EXIT(STRSUBSTNO('//%1:DeliveryState',GetPrefix));
    END;

    LOCAL PROCEDURE GetDocumentIDXPath@39() : Text;
    BEGIN
      EXIT(STRSUBSTNO('.//%1:DocumentId',GetPrefix));
    END;

    LOCAL PROCEDURE GetDocumentTypeXPath@44() : Text;
    BEGIN
      EXIT(STRSUBSTNO('.//%1:DocumentType',GetPrefix));
    END;

    LOCAL PROCEDURE GetDocumentIDForDescriptionXPath@38() : Text;
    BEGIN
      EXIT(STRSUBSTNO('.//%1:ID',GetPrefix));
    END;

    LOCAL PROCEDURE GetEmbeddedDocXPath@14() : Text;
    BEGIN
      EXIT(STRSUBSTNO('//%1:EmbeddedDocumentBinaryObject',GetPrefix));
    END;

    LOCAL PROCEDURE GetPrefix@45() : Text;
    BEGIN
      EXIT('newnamespace');
    END;

    LOCAL PROCEDURE GetDocumentIDKey@34() : Text;
    BEGIN
      EXIT('X-Tradeshift-DocumentId');
    END;

    [TryFunction]
    LOCAL PROCEDURE TryGetDocumentDescription@35(Node@1001 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlNode";VAR Description@1003 : Text);
    VAR
      SrchNode@1000 : DotNet "'System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.System.Xml.XmlNode";
    BEGIN
      Description := '';
      XMLDOMMgt.FindNodeWithNamespace(Node,GetDocumentTypeXPath,GetPrefix,
        GetPublicNamespace,SrchNode);
      Description := MapDocumentType(XMLDOMMgt.GetAttributeValue(SrchNode,'type'));
      Description += ' ' + XMLDOMMgt.FindNodeTextWithNamespace(Node,GetDocumentIDForDescriptionXPath,
          GetPrefix,GetPublicNamespace);
    END;

    LOCAL PROCEDURE MapDocumentType@37(DocType@1000 : Text) : Text;
    VAR
      PurchaseHeader@1001 : Record 38;
    BEGIN
      CASE DocType OF
        'invoice':
          PurchaseHeader."Document Type" := PurchaseHeader."Document Type"::Invoice;
        'creditnote':
          PurchaseHeader."Document Type" := PurchaseHeader."Document Type"::"Credit Memo";
        ELSE
          EXIT('');
      END;
      EXIT(FORMAT(PurchaseHeader."Document Type"));
    END;

    LOCAL PROCEDURE LogActivitySucceeded@25(RelatedRecordID@1001 : RecordID;ActivityDescription@1002 : Text;ActivityMessage@1003 : Text);
    VAR
      ActivityLog@1000 : Record 710;
    BEGIN
      ActivityLog.LogActivity(RelatedRecordID,ActivityLog.Status::Success,LoggingConstTxt,
        ActivityDescription,ActivityMessage);
    END;

    LOCAL PROCEDURE LogActivityFailed@24(RelatedRecordID@1001 : RecordID;ActivityDescription@1002 : Text;ActivityMessage@1003 : Text);
    VAR
      ActivityMessageVar@1000 : Text;
    BEGIN
      ActivityMessageVar := ActivityMessage;
      LogActivityFailedCommon(RelatedRecordID,ActivityDescription,ActivityMessageVar);
    END;

    LOCAL PROCEDURE LogActivityFailedAndError@53(RelatedRecordID@1001 : RecordID;ActivityDescription@1002 : Text;ActivityMessage@1003 : Text);
    BEGIN
      LogActivityFailedCommon(RelatedRecordID,ActivityDescription,ActivityMessage);
      IF DELCHR(ActivityMessage,'<>',' ') <> '' THEN
        ERROR(ActivityMessage);
    END;

    LOCAL PROCEDURE LogActivityFailedCommon@54(RelatedRecordID@1001 : RecordID;ActivityDescription@1002 : Text;VAR ActivityMessage@1003 : Text);
    VAR
      ActivityLog@1000 : Record 710;
    BEGIN
      ActivityMessage := GETLASTERRORTEXT + ' ' + ActivityMessage;
      CLEARLASTERROR;

      ActivityLog.LogActivity(RelatedRecordID,ActivityLog.Status::Failed,LoggingConstTxt,
        ActivityDescription,ActivityMessage);

      IF ActivityMessage = '' THEN
        ActivityLog.SetDetailedInfoFromStream(GLBResponseInStream);

      COMMIT;
    END;

    [External]
    PROCEDURE EnableTraceLog@8(NewTraceLogEnabled@1000 : Boolean);
    BEGIN
      GLBTraceLogEnabled := NewTraceLogEnabled;
    END;

    [EventSubscriber(Table,1400,OnRegisterServiceConnection)]
    [External]
    PROCEDURE HandleVANRegisterServiceConnection@122(VAR ServiceConnection@1000 : Record 1400);
    VAR
      DocExchServiceSetup@1001 : Record 1275;
      RecRef@1002 : RecordRef;
    BEGIN
      IF NOT DocExchServiceSetup.GET THEN BEGIN
        DocExchServiceSetup.INIT;
        DocExchServiceSetup.INSERT;
      END;

      RecRef.GETTABLE(DocExchServiceSetup);

      IF DocExchServiceSetup.Enabled THEN
        ServiceConnection.Status := ServiceConnection.Status::Enabled
      ELSE
        ServiceConnection.Status := ServiceConnection.Status::Disabled;

      WITH DocExchServiceSetup DO
        ServiceConnection.InsertServiceConnection(
          ServiceConnection,RecRef.RECORDID,TABLENAME,"Service URL",PAGE::"Doc. Exch. Service Setup");
    END;

    [Integration(TRUE)]
    PROCEDURE OnAfterIncomingDocReceivedFromDocExch@32(VAR IncomingDocument@1000 : Record 130);
    BEGIN
    END;

    [External]
    PROCEDURE GetExternalDocURL@7(DocID@1000 : Text) : Text;
    VAR
      URLPart@1001 : Text;
    BEGIN
      URLPart := 'www';
      IF STRPOS(GetFullURL(''),'sandbox') > 0 THEN
        URLPart := 'sandbox';

      EXIT(STRSUBSTNO('https://%1.tradeshift.com/app/Tradeshift.Migration#::conversation/view/%2::',URLPart,DocID));
    END;

    [External]
    PROCEDURE VerifyPrerequisites@50(ShowFailure@1000 : Boolean) : Boolean;
    VAR
      DocExchServiceSetup@1001 : Record 1275;
    BEGIN
      WITH DocExchServiceSetup DO
        IF NOT (GET AND HasPassword("Consumer Key") AND HasPassword("Consumer Secret") AND
                HasPassword(Token) AND HasPassword("Token Secret") AND HasPassword("Doc. Exch. Tenant ID"))
        THEN
          IF ShowFailure THEN
            ERROR(MissingCredentialsErr,TABLECAPTION);
      EXIT(TRUE)
    END;

    LOCAL PROCEDURE LogTelemetryDocumentSent@52();
    VAR
      DocExchServiceSetup@1000 : Record 1275;
    BEGIN
      DocExchServiceSetup.GET;
      SENDTRACETAG('000089R',TelemetryCategoryTok,VERBOSITY::Normal,
        DocExchServiceDocumentSuccessfullySentTxt,DATACLASSIFICATION::SystemMetadata);
      SENDTRACETAG('000089S',TelemetryCategoryTok,VERBOSITY::Normal,
        DocExchServiceSetup."Service URL",DATACLASSIFICATION::SystemMetadata);
    END;

    LOCAL PROCEDURE LogTelemetryDocumentReceived@57();
    VAR
      DocExchServiceSetup@1000 : Record 1275;
    BEGIN
      DocExchServiceSetup.GET;
      SENDTRACETAG('000089T',TelemetryCategoryTok,VERBOSITY::Normal,
        DocExchServiceDocumentSuccessfullyReceivedTxt,DATACLASSIFICATION::SystemMetadata);
      SENDTRACETAG('000089U',TelemetryCategoryTok,VERBOSITY::Normal,
        DocExchServiceSetup."Service URL",DATACLASSIFICATION::SystemMetadata);
    END;

    BEGIN
    END.
  }
}

