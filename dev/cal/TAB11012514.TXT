OBJECT Table 11012514 Option Quote Line
{
  OBJECT-PROPERTIES
  {
    Date=;
    Time=;
    Version List=4PS14.00;
  }
  PROPERTIES
  {
    OnInsert=BEGIN
               OptionQuoteHeaderRec.GET("Option Quote No.");
               OptionQuoteHeaderRec.TESTFIELD("Project No.");
               OptionQuoteHeaderRec.TESTFIELD("Plot No.");
               IF OptionQuoteHeaderRec.Status >= OptionQuoteHeaderRec.Status::Order THEN
                 OptionQuoteHeaderRec.FIELDERROR(Status);
               TESTFIELD("House Model");
               TESTFIELD("Main Group");
               TESTFIELD(Group);
               TESTFIELD("Sub Group");
               TESTFIELD(Option);
             END;

    OnModify=BEGIN
               OnModifyGroupsChanged();
             END;

    OnDelete=VAR
               lvOptionTextRec@1210190000 : Record 11012511;
             BEGIN
               lvOptionTextRec.SETRANGE(Table, lvOptionTextRec.Table::"Option Quote Line");
               lvOptionTextRec.SETRANGE("Quote No.", "Option Quote No.");
               lvOptionTextRec.SETRANGE("Quote Line No.", "Line No.");
               lvOptionTextRec.DELETEALL;
             END;

    CaptionML=[ENU=Option Quote Line;
               NOR=Alternativtilbudrad;
               SVE=Alternativoffertrad];
    PasteIsValid=No;
  }
  FIELDS
  {
    { 10  ;   ;Option Quote No.    ;Code20        ;TableRelation="Option Quote Header";
                                                   CaptionML=[ENU=Option Quote No.;
                                                              NOR=Alternativtilbudnr.;
                                                              SVE=Alternativoffertnr] }
    { 20  ;   ;Line No.            ;Integer       ;CaptionML=[ENU=Line No.;
                                                              NOR=Linjenr.;
                                                              SVE=Radnummer] }
    { 30  ;   ;Project No.         ;Code20        ;TableRelation=Job;
                                                   CaptionML=[ENU=Project No.;
                                                              NOR=Prosjektnr;
                                                              SVE=Projektnr];
                                                   Editable=No }
    { 40  ;   ;Plot No.            ;Code10        ;TableRelation=Plot."Plot No." WHERE (Project No.=FIELD(Project No.));
                                                   CaptionML=[ENU=Plot No.;
                                                              NOR=Tegningnr;
                                                              SVE=Ritningnr];
                                                   Editable=No }
    { 45  ;   ;House Model         ;Code20        ;CaptionML=[ENU=House Model;
                                                              NOR=Husmodell;
                                                              SVE=Husmodell];
                                                   Editable=No }
    { 50  ;   ;Main Group          ;Code20        ;TableRelation="Option Main Group".Code WHERE (Project No.=FIELD(Project No.),
                                                                                                 Plot No.=FIELD(Plot No.));
                                                   OnValidate=BEGIN
                                                                IF "Main Group" <> '' THEN BEGIN
                                                                  CheckHouseModel();
                                                                  IF (Status IN [Status::Order, Status::Invoice]) AND
                                                                     ("Main Group" <> xRec."Main Group") AND  (CurrFieldNo = FIELDNO("Main Group"))
                                                                  THEN
                                                                    FIELDERROR(Status, STRSUBSTNO(Text005, Status, FIELDCAPTION("Main Group")));
                                                                  IF (Group <> '') AND ("Sub Group" <> '') AND (Option <> '') AND
                                                                     ("Main Group" <> xRec."Main Group") AND  (CurrFieldNo = FIELDNO("Main Group"))
                                                                  THEN
                                                                    VALIDATE(Option);
                                                                END;
                                                              END;

                                                   CaptionML=[ENU=Main Group;
                                                              NOR=Hovedgruppe;
                                                              SVE=Huvudgrupp];
                                                   NotBlank=Yes }
    { 51  ;   ;Main Group Description;Text50      ;FieldClass=FlowField;
                                                   CalcFormula=Lookup("Option Main Group".Description WHERE (Project No.=FIELD(Project No.),
                                                                                                             Code=FIELD(Main Group),
                                                                                                             Plot No.=FIELD(Plot No.)));
                                                   CaptionML=[ENU=Main Group Description;
                                                              NOR=Hovedgruppesbeskrivelse;
                                                              SVE=Huvudgruppsbeskrivning];
                                                   Editable=No }
    { 60  ;   ;Group               ;Code20        ;TableRelation="Option Group".Code WHERE (Project No.=FIELD(Project No.),
                                                                                            Plot No.=FIELD(Plot No.));
                                                   OnValidate=BEGIN
                                                                IF Group <> '' THEN BEGIN
                                                                  CheckHouseModel();
                                                                  TESTFIELD("Main Group");
                                                                  IF (Status IN [Status::Order, Status::Invoice]) AND
                                                                     (Group <> xRec.Group) AND  (CurrFieldNo = FIELDNO(Group))
                                                                  THEN
                                                                    FIELDERROR(Status, STRSUBSTNO(Text005, Status, FIELDCAPTION(Group)));
                                                                  IF ("Sub Group" <> '') AND (Option <> '') AND (Group <> xRec.Group) AND  (CurrFieldNo = FIELDNO(Group)) THEN
                                                                    VALIDATE(Option);
                                                                END;
                                                              END;

                                                   CaptionML=[ENU=Group;
                                                              NOR=Gruppe;
                                                              SVE=Grupp];
                                                   NotBlank=Yes }
    { 61  ;   ;Group Description   ;Text30        ;FieldClass=FlowField;
                                                   CalcFormula=Lookup("Option Group".Description WHERE (Code=FIELD(Group),
                                                                                                        Project No.=FIELD(Project No.),
                                                                                                        Plot No.=FIELD(Plot No.)));
                                                   CaptionML=[ENU=Group Description;
                                                              NOR=Gruppebeskrivelse;
                                                              SVE=Gruppbeskrivning];
                                                   Editable=No }
    { 70  ;   ;Sub Group           ;Code20        ;TableRelation="Option Sub Group".Code WHERE (Project No.=FIELD(Project No.),
                                                                                                Plot No.=FIELD(Plot No.));
                                                   OnValidate=BEGIN
                                                                IF "Sub Group" <> '' THEN BEGIN
                                                                  CheckHouseModel();
                                                                  TESTFIELD("Main Group");
                                                                  TESTFIELD(Group);
                                                                  IF (Status IN [Status::Order, Status::Invoice]) AND
                                                                     ("Sub Group" <> xRec."Sub Group") AND  (CurrFieldNo = FIELDNO("Sub Group"))
                                                                  THEN
                                                                    FIELDERROR(Status, STRSUBSTNO(Text005, Status, FIELDCAPTION("Sub Group")));
                                                                  IF (Option <> '') AND ("Sub Group" <> xRec."Sub Group") AND  (CurrFieldNo = FIELDNO("Sub Group")) THEN
                                                                    VALIDATE(Option);
                                                                END;
                                                              END;

                                                   CaptionML=[ENU=Sub Group;
                                                              NOR=Undergruppe;
                                                              SVE=Undergrupp];
                                                   NotBlank=Yes }
    { 71  ;   ;Sub Group Description;Text50       ;FieldClass=FlowField;
                                                   CalcFormula=Lookup("Option Sub Group".Description WHERE (Project No.=FIELD(Project No.),
                                                                                                            Code=FIELD(Sub Group),
                                                                                                            Plot No.=FIELD(Plot No.)));
                                                   CaptionML=[ENU=Sub Group Description;
                                                              NOR=Undergruppebeskrivelse;
                                                              SVE=Undergruppsbeskrivning];
                                                   Editable=No }
    { 80  ;   ;Option              ;Code20        ;OnValidate=BEGIN
                                                                IF Option <> '' THEN BEGIN
                                                                  CheckHouseModel();
                                                                  TESTFIELD("Main Group");
                                                                  TESTFIELD(Group);
                                                                  TESTFIELD("Sub Group");
                                                                  IF (Status IN [Status::Order, Status::Invoice]) AND
                                                                     (Option <> xRec.Option) AND  (CurrFieldNo = FIELDNO(Option))
                                                                  THEN
                                                                    FIELDERROR(Status, STRSUBSTNO(Text005, Status, FIELDCAPTION(Option)));

                                                                  OptionLevel := ReadOptionLevel(Rec);
                                                                  IF OptionLevel = OptionLevel::Plot THEN BEGIN
                                                                    IF OptionRec.Status >= OptionRec.Status::Order THEN
                                                                      ERROR(Text000, "Main Group", Group, "Sub Group", Option, OptionRec.Status, "Project No.", "Plot No.");
                                                                  END;
                                                                  IF OptionLevel <> OptionLevel::None THEN BEGIN
                                                                    IF (TODAY < OptionRec."Valid from") AND (OptionRec."Valid from" <> 0D) THEN BEGIN
                                                                      IF (OptionRec."Valid Until" <> 0D) THEN
                                                                        OptionRec.FIELDERROR(Option, STRSUBSTNO(Text001, OptionRec."Valid from", OptionRec."Valid Until"))
                                                                      ELSE
                                                                        OptionRec.FIELDERROR(Option, STRSUBSTNO(Text002, OptionRec."Valid from"));
                                                                    END;
                                                                    IF (TODAY > OptionRec."Valid Until") AND (OptionRec."Valid Until" <> 0D) THEN BEGIN
                                                                      IF (OptionRec."Valid from" <> 0D) THEN
                                                                        OptionRec.FIELDERROR(Option, STRSUBSTNO(Text001, OptionRec."Valid from", OptionRec."Valid Until"))
                                                                      ELSE
                                                                        OptionRec.FIELDERROR(Option, STRSUBSTNO(Text003, OptionRec."Valid Until"));
                                                                    END;
                                                                  END;
                                                                  IF NOT BuyerMgtCU.BmCheckOptionOnQuote("Project No.","Plot No.","House Model","Option Quote No.",OptionRec,"Line No.") THEN
                                                                    ERROR('');

                                                                  IF OptionLevel <> OptionLevel::None THEN BEGIN
                                                                    IF ((Option <> xRec.Option) AND  (CurrFieldNo = FIELDNO(Option))) OR
                                                                       (("Main Group" <> xRec."Main Group") AND  (CurrFieldNo = FIELDNO("Main Group"))) OR
                                                                       ((Group <> xRec.Group) AND  (CurrFieldNo = FIELDNO(Group))) OR
                                                                       (("Sub Group" <> xRec."Sub Group") AND  (CurrFieldNo = FIELDNO("Sub Group")))
                                                                    THEN BEGIN
                                                                      Description := OptionRec.Description;
                                                                      VALIDATE(Quantity, OptionRec.Quantity);
                                                                      "VAT Prod. Posting Group" := OptionRec."VAT Prod. Posting Group";
                                                                      "VAT Bus. Posting Group" := OptionRec."VAT Bus. Posting Group";
                                                                      VALIDATE("Net Price", OptionRec."Net Price");
                                                                      "Unit of Measure Code" := OptionRec."Unit of Measure Code";
                                                                    END;
                                                                  END;

                                                                END;
                                                              END;

                                                   OnLookup=BEGIN
                                                              LookupOption();
                                                            END;

                                                   CaptionML=[ENU=Option;
                                                              NOR=Alternativ;
                                                              SVE=Alternativ];
                                                   NotBlank=Yes }
    { 90  ;   ;Description         ;Text100       ;CaptionML=[ENU=Description;
                                                              NOR=Beskrivelse;
                                                              SVE=Beskrivning] }
    { 100 ;   ;Quantity            ;Decimal       ;InitValue=1;
                                                   OnValidate=BEGIN
                                                                OptionLevel := ReadOptionLevel(Rec);
                                                                IF (OptionLevel <> OptionLevel::None) AND (NOT OptionRec.Quantities) AND (Quantity <> 1) THEN
                                                                  Quantity := 1;

                                                                BuyerMgtCU.BmCalcQuoteLineTotal(Rec);
                                                              END;

                                                   CaptionML=[ENU=Quantity;
                                                              NOR=Antall;
                                                              SVE=Antal] }
    { 110 ;   ;Sales Price excl. VAT;Decimal      ;OnValidate=BEGIN
                                                                CALCFIELDS("VAT Percentage");
                                                                VALIDATE("Sales Price incl. VAT", ROUND("Sales Price excl. VAT" * (1 + ("VAT Percentage" / 100))));
                                                              END;

                                                   CaptionML=[ENU=Sales Price excl. VAT;
                                                              NOR=Salgspris Ekskludert Moms;
                                                              SVE=F”rs„ljningspris exkl. moms];
                                                   AutoFormatType=1 }
    { 120 ;   ;Sales Price incl. VAT;Decimal      ;OnValidate=BEGIN
                                                                BuyerMgtCU.BmCalcQuoteLineTotal(Rec);
                                                              END;

                                                   CaptionML=[ENU=Sales Price incl. VAT;
                                                              NOR=Salgspris Inkludert Moms;
                                                              SVE=Ber„knat f”rs„ljningspris inkl. moms] }
    { 150 ;   ;VAT Prod. Posting Group;Code20     ;TableRelation="VAT Product Posting Group".Code;
                                                   OnValidate=BEGIN
                                                                BuyerMgtCU.BmCalcQuoteLineTotal(Rec);
                                                              END;

                                                   CaptionML=[ENU=VAT Prod. Posting Group;
                                                              NOR=Mva-bokf›ringsgruppe - vare;
                                                              SVE=Moms produktbokf”ringsmall] }
    { 160 ;   ;VAT Bus. Posting Group;Code20      ;TableRelation="VAT Business Posting Group".Code;
                                                   OnValidate=BEGIN
                                                                BuyerMgtCU.BmCalcQuoteLineTotal(Rec);
                                                              END;

                                                   CaptionML=[ENU=VAT Bus. Posting Group;
                                                              NOR=Mva-bokf›ringsgruppe - firma;
                                                              SVE=Moms r”relsebokf”ringsmall] }
    { 170 ;   ;VAT Percentage      ;Decimal       ;FieldClass=FlowField;
                                                   CalcFormula=Lookup("VAT Posting Setup"."VAT %" WHERE (VAT Bus. Posting Group=FIELD(VAT Bus. Posting Group),
                                                                                                         VAT Prod. Posting Group=FIELD(VAT Prod. Posting Group)));
                                                   CaptionML=[ENU=VAT Percentage;
                                                              NOR=Mva.-sats;
                                                              SVE=Momsprocentsats];
                                                   Editable=No }
    { 180 ;   ;Net Price           ;Decimal       ;OnValidate=BEGIN
                                                                IF ("Net Price" <> xRec."Net Price") AND (CurrFieldNo = FIELDNO("Net Price")) AND (Status < Status::Order) THEN BEGIN
                                                                  IF CONFIRM(Text004) THEN BEGIN
                                                                    CALCFIELDS("VAT Percentage");
                                                                    VALIDATE("Sales Price incl. VAT", ROUND("Net Price" * (1 + ("VAT Percentage" / 100))));
                                                                    BuyerMgtCU.BmCalcQuoteLineTotal(Rec);
                                                                  END;
                                                                END;
                                                              END;

                                                   CaptionML=[ENU=Net Price;
                                                              NOR=Nettopris;
                                                              SVE=Nettopris];
                                                   AutoFormatType=1 }
    { 190 ;   ;VAT Amount          ;Decimal       ;CaptionML=[ENU=VAT Amount;
                                                              NOR=Mva-bel›p;
                                                              SVE=Momsbelopp];
                                                   Editable=No }
    { 200 ;   ;Sales Amount incl. VAT;Decimal     ;CaptionML=[ENU=Sales Amount incl. VAT;
                                                              NOR=Salgsbel›p inkl. moms;
                                                              SVE=F”rs„ljningsbelopp inkl. moms];
                                                   Editable=No }
    { 210 ;   ;Sales Amount excl. VAT;Decimal     ;CaptionML=[ENU=Sales Amount excl. VAT;
                                                              NOR=Salgsbel›p eks. Moms;
                                                              SVE=F”rs„ljningsbelopp exkl. moms];
                                                   Editable=No }
    { 220 ;   ;Quote Amount incl. VAT;Decimal     ;FieldClass=FlowField;
                                                   CalcFormula=Sum("Option Quote Line"."Sales Amount incl. VAT" WHERE (Option Quote No.=FIELD(Option Quote No.),
                                                                                                                       Status=FILTER(<>Expired)));
                                                   CaptionML=[ENU=Quote Amount incl. VAT;
                                                              NOR=Tilbudsbel›p inkl. Moms;
                                                              SVE=Offertbelopp inkl. moms];
                                                   Editable=No }
    { 230 ;   ;Quote Amount excl. VAT;Decimal     ;FieldClass=FlowField;
                                                   CalcFormula=Sum("Option Quote Line"."Sales Amount excl. VAT" WHERE (Option Quote No.=FIELD(Option Quote No.),
                                                                                                                       Status=FILTER(<>Expired)));
                                                   CaptionML=[ENU=Quote Amount excl. VAT;
                                                              NOR=Tilbudsbel›p eks. Moms;
                                                              SVE=Offertbelopp exkl. moms];
                                                   Editable=No }
    { 240 ;   ;Status              ;Option        ;OnValidate=BEGIN
                                                                CheckIfChangingStatusAllowed;
                                                              END;

                                                   CaptionML=[ENU=Status;
                                                              NOR=Status;
                                                              SVE=Status];
                                                   OptionCaptionML=[ENU=Applied,Offered,Order,Chargeable,Expired;
                                                                    NOR=Anvendt,Tilbudt,Ordre,Avgiftspliktig,Forfalt;
                                                                    SVE=Till„mpat,Anbud,Order,Avgiftsbel„ggs,F”rfallit];
                                                   OptionString=Applied,Offered,Order,Invoice,Expired }
    { 250 ;   ;Quantities          ;Boolean       ;FieldClass=Normal;
                                                   OnValidate=BEGIN
                                                                IF (NOT Quantities) AND (Quantity <> 1) THEN
                                                                  VALIDATE(Quantity, 1);
                                                              END;

                                                   CaptionML=[ENU=Quantities;
                                                              NOR=Antall;
                                                              SVE=Antal] }
    { 260 ;   ;Sales Text          ;Boolean       ;FieldClass=FlowField;
                                                   CalcFormula=Exist("Buyer Management Text" WHERE (Table=CONST(Option Quote Line),
                                                                                                    Text Type=CONST(Sales),
                                                                                                    Quote No.=FIELD(Option Quote No.),
                                                                                                    Quote Line No.=FIELD(Line No.)));
                                                   CaptionML=[ENU=Sales Text;
                                                              NOR=Salgstekst;
                                                              SVE=F”rs„ljningstext];
                                                   Editable=No }
    { 265 ;   ;Technical Text      ;Boolean       ;FieldClass=FlowField;
                                                   CalcFormula=Exist("Buyer Management Text" WHERE (Table=CONST(Option Quote Line),
                                                                                                    Text Type=CONST(Technical),
                                                                                                    Quote No.=FIELD(Option Quote No.),
                                                                                                    Quote Line No.=FIELD(Line No.)));
                                                   CaptionML=[ENU=Technical Text;
                                                              NOR=Teknisk tekst;
                                                              SVE=Teknisk text];
                                                   Editable=No }
    { 270 ;   ;Developers Discount Percentage;Decimal;
                                                   OnValidate=BEGIN
                                                                //C-018215
                                                                IF "Developers Discount Percentage" <> 0 THEN
                                                                  TESTFIELD("Contractor Surcharge %", 0);
                                                                BuyerMgtCU.BmDetermineVATOptQuote(Rec);
                                                                BuyerMgtCU.BmDetermineSalesPriceOptQuote(Rec);
                                                              END;

                                                   CaptionML=[ENU=Developers Discount (%);
                                                              NOR=Utviklers Rabatt (%);
                                                              SVE=Utvecklarrabatt (%)] }
    { 275 ;   ;Sales Price incl. VAT (Buyer);Decimal;
                                                   OnValidate=BEGIN
                                                                //C-018215
                                                                VALIDATE("Sales Price incl. VAT", ROUND("Sales Price incl. VAT (Buyer)" * InverseBuyerFactor));
                                                              END;

                                                   CaptionML=[ENU=Sales Price incl. VAT (Buyer);
                                                              NOR=Salgspris inkl. Moms (Kj›per);
                                                              SVE=F”rs„ljningspris inkl. moms (k”pare)];
                                                   AutoFormatType=1 }
    { 280 ;   ;Unit of Measure Code;Code10        ;TableRelation="Unit of Measure";
                                                   CaptionML=[ENU=Unit of Measure Code;
                                                              NOR=M†leenhetskode;
                                                              SVE=Enhetskod] }
    { 290 ;   ;Contractor Surcharge %;Decimal     ;OnValidate=BEGIN
                                                                IF "Contractor Surcharge %" <> 0 THEN
                                                                  TESTFIELD("Developers Discount Percentage", 0);
                                                                "Sales Price incl. VAT (Buyer)" := ROUND("Sales Price incl. VAT" * BuyerFactor);
                                                                "Sales Price excl. VAT (Buyer)" := ROUND("Sales Price excl. VAT" * BuyerFactor);
                                                              END;

                                                   CaptionML=ENU=Contractor Surcharge %;
                                                   DecimalPlaces=2:15 }
    { 300 ;   ;Sales Price excl. VAT (Buyer);Decimal;
                                                   OnValidate=BEGIN
                                                                "Sales Price excl. VAT" := ROUND("Sales Price excl. VAT (Buyer)" * InverseBuyerFactor);
                                                                CALCFIELDS("VAT Percentage");
                                                                VALIDATE("Sales Price incl. VAT", ROUND("Sales Price excl. VAT" * (1 + ("VAT Percentage" / 100))));
                                                              END;

                                                   CaptionML=ENU=Sales Price excl. VAT (Buyer);
                                                   AutoFormatType=1 }
    { 310 ;   ;Generate Installments;Boolean      ;CaptionML=[ENU=Generate Installments;
                                                              SVE=Generera avbetalningar] }
    { 320 ;   ;Installment Scheme  ;Code10        ;TableRelation="Installment Scheme".Code;
                                                   CaptionML=[ENU=Installment Scheme;
                                                              SVE=Betalplan] }
    { 330 ;   ;Fixed Sales Price   ;Boolean       ;CaptionML=[ENU=Fixed Sales Price;
                                                              SVE=Fast f”rs„ljningspris] }
    { 340 ;   ;House Model from Option;Code20     ;CaptionML=ENU=House Model from Option;
                                                   Editable=No }
  }
  KEYS
  {
    {    ;Option Quote No.,Line No.               ;Clustered=Yes }
    {    ;Project No.,Plot No.,House Model,Main Group,Group,Sub Group,Option }
    {    ;Option Quote No.,Status                 ;SumIndexFields=Sales Amount incl. VAT,Sales Amount excl. VAT }
  }
  FIELDGROUPS
  {
  }
  CODE
  {
    VAR
      OptionQuoteHeaderRec@1210190000 : Record 11012513;
      OptionRec@1210190001 : Record 11012502;
      Text000@1210190002 : TextConst 'ENU=Option %1,%2,%3,%4 is already present with status ''%5'' for project %6, plot %7.;NOR=Alternativ %1,%2,%3,%4 finnes allerede med status ''%5'' for prosjekt %6, tegning %7.;SVE=Alternativ %1,%2,%3,%4 finns redan med status ''%5'' f”r projekt %6, ritning %7.';
      PlotRec@1210190008 : Record 11012500;
      Text001@1210190005 : TextConst 'ENU=is not valid, valid from %1 upto %2;NOR=er ikke gyldig, gyldig fra %1 frem til %2;SVE=„r inte giltigt, giltigt fr†n %1 upp till %2';
      BuyerMgtCU@1210190006 : Codeunit 11012500;
      OptionLevel@1210190007 : 'None,Standard,Project,Plot';
      Text002@1210190004 : TextConst 'ENU=is not valid, valid from %;NOR=er ikke gyldig, gyldig fra %;SVE=„r inte giltigt, giltigt fr†n %';
      Text003@1210190009 : TextConst 'ENU=is not valid, valid upto %1;NOR=er ikke gyldig, gyldig frem til %1;SVE=„r inte giltigt, giltigt upp till %1';
      Text004@1210190010 : TextConst 'ENU="Recalculate Sales Price ? ";NOR=Omberegne salgspris?;SVE="Omber„kna f”rs„ljningspris? "';
      Text005@1100485000 : TextConst 'ENU=is ''%1'', rename %2 not allowed;NOR=er ''%1'', gi nytt navn til %2 ikke tillatt;SVE=„r ''%1'', att ge nytt namn †t %2 „r inte till†tet';

    PROCEDURE InitRecord@1210190000();
    BEGIN
      IF "Option Quote No." = '' THEN
        EXIT;

      OptionQuoteHeaderRec.GET("Option Quote No.");
      "Project No." := OptionQuoteHeaderRec."Project No.";
      "Plot No." := OptionQuoteHeaderRec."Plot No.";
      OptionQuoteHeaderRec.CALCFIELDS("House Model");
      "House Model" := OptionQuoteHeaderRec."House Model";
    END;

    PROCEDURE ReadOptionLevel@1210190001(IRec@1100485000 : Record 11012514) : Integer;
    BEGIN
      WITH IRec DO BEGIN
        IF OptionRec.GET("Project No.", "Plot No.", "House Model", "Main Group", Group, "Sub Group", Option) THEN
          EXIT(OptionLevel::Plot);

        IF OptionRec.GET("Project No.", '', "House Model", "Main Group", Group, "Sub Group", Option) THEN
          EXIT(OptionLevel::Project);

        IF OptionRec.GET('', '', "House Model", "Main Group", Group, "Sub Group", Option) THEN
          EXIT(OptionLevel::Standard);

        OptionRec.INIT;
        OptionRec."Project No." := '';
        OptionRec."Plot No." := '';
        OptionRec."House Model" := '';
        OptionRec."Main Group" := "Main Group";
        OptionRec.Group := Group;
        OptionRec."Sub Group" := "Sub Group";
        OptionRec.Option := Option;
        EXIT(OptionLevel::None);
      END;
    END;

    PROCEDURE LookupOption@1210190003();
    VAR
      lvOptionRec@1210190000 : Record 11012502;
    BEGIN
      lvOptionRec.SETRANGE("Project No.", "Project No.");
      lvOptionRec.SETRANGE("Plot No.", "Plot No.");
      IF NOT lvOptionRec.FINDFIRST THEN BEGIN
        lvOptionRec.SETRANGE("Plot No.");
        lvOptionRec."Plot No." := '';
      END;
      lvOptionRec."Project No." := "Project No.";
      lvOptionRec."House Model" := "House Model";
      lvOptionRec."Main Group" := "Main Group";
      lvOptionRec.Group := Group;
      lvOptionRec."Sub Group" := "Sub Group";
      lvOptionRec.Option := Option;
      IF PAGE.RUNMODAL(PAGE::"Option List", lvOptionRec) = ACTION::LookupOK THEN
        VALIDATE(Option, lvOptionRec.Option);
    END;

    PROCEDURE CheckHouseModel@1210190002();
    BEGIN
      IF ("House Model" <> '') OR ("Project No." = '') OR ("Plot No." = '') THEN
        EXIT;

      IF PlotRec.GET("Project No.", "Plot No.") THEN
        PlotRec.TESTFIELD("House Model");
    END;

    PROCEDURE OnModifyGroupsChanged@1100485000();
    VAR
      lvOldLineRec@1100485000 : Record 11012514;
      lvOptionRec@1100485013 : Record 11012502;
      lvOptionRec2@1100485014 : Record 11012502;
      lvOptionBudgetRec@1100485010 : Record 11012503;
      lvOptionBudgetRec2@1100485009 : Record 11012503;
      lvOptionBudgetSummaryRec@1100485008 : Record 11012064;
      lvOptionBudgetSummaryRec2@1100485007 : Record 11012064;
      lvOptionSurchargesRec@1100485006 : Record 11012512;
      lvOptionSurchargesRec2@1100485005 : Record 11012512;
      lvOptionTextRec@1100485004 : Record 11012511;
      lvOptionTextRec2@1100485003 : Record 11012511;
      lvOptionLevelNew@1100485001 : Option;
      lvOptionLevelOld@1100485002 : Option;
      lvProjectNo@1100485011 : Code[20];
      lvPlotNo@1100485012 : Code[20];
    BEGIN
      //* C009865: Als wijzigen hoofdgroep, groep of subgroep dan maar optiebegroting toevoegen op project-woningmodel
      //*          niveau (indien voor nieuwe nog niet aanwezig). Alleen maar als optie gelijk blijft (voorlopig).
      //*          NB: Mag hier niet op bouwnummer niveau toegevoegd worden!

      IF ("Option Quote No." = '') OR ("Line No." = 0) OR
         ("Project No." = '') OR ("Plot No." = '') OR ("House Model" = '') OR
         ("Main Group" = '') OR (Group = '') OR ("Sub Group" = '') OR (Option = '')
      THEN
        EXIT;
      IF NOT lvOldLineRec.GET("Option Quote No.", "Line No.") THEN
        EXIT;
      IF (lvOldLineRec."Main Group" = '') OR (lvOldLineRec.Group = '') OR
         (lvOldLineRec."Sub Group" = '') OR (lvOldLineRec.Option = '')
      THEN
        EXIT;
      IF (("Main Group" = lvOldLineRec."Main Group") AND (Group = lvOldLineRec.Group) AND
          ("Sub Group" = lvOldLineRec."Sub Group") ) OR
         (Option <> lvOldLineRec.Option)
      THEN
        EXIT;

      lvOptionLevelNew := ReadOptionLevel(Rec);
      IF lvOptionLevelNew <> OptionLevel::None THEN  //* Als aanwezig bij 'new' dan optiebegroting kopieren niet nodig
        EXIT;

      lvOptionLevelOld := ReadOptionLevel(lvOldLineRec);
      CASE lvOptionLevelOld OF
         OptionLevel::Standard:
           BEGIN
             lvProjectNo := '';
             lvPlotNo := '';
           END;
         OptionLevel::Project:
           BEGIN
             lvProjectNo := lvOldLineRec."Project No.";
             lvPlotNo := '';
           END;
         OptionLevel::Plot:
           BEGIN
             lvProjectNo := lvOldLineRec."Project No.";
             lvPlotNo := lvOldLineRec."Plot No.";
           END;
         ELSE
           EXIT;  //* Alleen mogelijk als aanwezig bij 'old'
      END;

      lvOptionRec.SETRANGE("Project No.", lvProjectNo);
      lvOptionRec.SETRANGE("Plot No.", lvPlotNo);
      lvOptionRec.SETRANGE("House Model", lvOldLineRec."House Model");
      lvOptionRec.SETRANGE("Main Group", lvOldLineRec."Main Group");
      lvOptionRec.SETRANGE(Group, lvOldLineRec.Group);
      lvOptionRec.SETRANGE("Sub Group", lvOldLineRec."Sub Group");
      lvOptionRec.SETRANGE(Option, lvOldLineRec.Option);
      IF lvOptionRec.FINDSET(TRUE, FALSE) THEN BEGIN
        REPEAT
          lvOptionRec2 := lvOptionRec;
          lvOptionRec2."Project No." := "Project No.";
          lvOptionRec2."Plot No." := '';
          lvOptionRec2."House Model" := "House Model";
          lvOptionRec2."Main Group" := "Main Group";
          lvOptionRec2.Group := Group;
          lvOptionRec2."Sub Group" := "Sub Group";
          lvOptionRec2.Option := Option;
          lvOptionRec2.INSERT;
        UNTIL lvOptionRec.NEXT = 0;
      END;

      lvOptionBudgetRec.SETRANGE("Project No.", lvProjectNo);
      lvOptionBudgetRec.SETRANGE("Plot No.", lvPlotNo);
      lvOptionBudgetRec.SETRANGE("House Model", lvOldLineRec."House Model");
      lvOptionBudgetRec.SETRANGE("Main Group", lvOldLineRec."Main Group");
      lvOptionBudgetRec.SETRANGE(Group, lvOldLineRec.Group);
      lvOptionBudgetRec.SETRANGE("Sub Group", lvOldLineRec."Sub Group");
      lvOptionBudgetRec.SETRANGE(Option, lvOldLineRec.Option);
      IF lvOptionBudgetRec.FINDSET(TRUE, FALSE) THEN BEGIN
        REPEAT
          lvOptionBudgetRec2 := lvOptionBudgetRec;
          lvOptionBudgetRec2."Project No." := "Project No.";
          lvOptionBudgetRec2."Plot No." := '';
          lvOptionBudgetRec2."House Model" := "House Model";
          lvOptionBudgetRec2."Main Group" := "Main Group";
          lvOptionBudgetRec2.Group := Group;
          lvOptionBudgetRec2."Sub Group" := "Sub Group";
          lvOptionBudgetRec2.Option := Option;
          lvOptionBudgetRec2.INSERT;
        UNTIL lvOptionBudgetRec.NEXT = 0;
      END;

      lvOptionBudgetSummaryRec.SETRANGE("Project No.", lvProjectNo);
      lvOptionBudgetSummaryRec.SETRANGE("Plot No.", lvPlotNo);
      lvOptionBudgetSummaryRec.SETRANGE("House Model", lvOldLineRec."House Model");
      lvOptionBudgetSummaryRec.SETRANGE("Main Group", lvOldLineRec."Main Group");
      lvOptionBudgetSummaryRec.SETRANGE(Group, lvOldLineRec.Group);
      lvOptionBudgetSummaryRec.SETRANGE("Sub Group", lvOldLineRec."Sub Group");
      lvOptionBudgetSummaryRec.SETRANGE(Option, lvOldLineRec.Option);
      IF lvOptionBudgetSummaryRec.FIND('-') THEN BEGIN
        REPEAT
          lvOptionBudgetSummaryRec2 := lvOptionBudgetSummaryRec;
          lvOptionBudgetSummaryRec2."Project No." := "Project No.";
          lvOptionBudgetSummaryRec2."Plot No." := '';
          lvOptionBudgetSummaryRec2."House Model" := "House Model";
          lvOptionBudgetSummaryRec2."Main Group" := "Main Group";
          lvOptionBudgetSummaryRec2.Group := Group;
          lvOptionBudgetSummaryRec2."Sub Group" := "Sub Group";
          lvOptionBudgetSummaryRec2.Option := Option;
          lvOptionBudgetSummaryRec2.INSERT;
        UNTIL lvOptionBudgetSummaryRec.NEXT = 0;
      END;

      lvOptionSurchargesRec.SETRANGE("Project No.", lvProjectNo);
      lvOptionSurchargesRec.SETRANGE("Plot No.", lvPlotNo);
      lvOptionSurchargesRec.SETRANGE("House Model", lvOldLineRec."House Model");
      lvOptionSurchargesRec.SETRANGE("Main Group", lvOldLineRec."Main Group");
      lvOptionSurchargesRec.SETRANGE(Group, lvOldLineRec.Group);
      lvOptionSurchargesRec.SETRANGE("Sub Group", lvOldLineRec."Sub Group");
      lvOptionSurchargesRec.SETRANGE(Option, lvOldLineRec.Option);
      IF lvOptionSurchargesRec.FIND('-') THEN BEGIN
        REPEAT
          lvOptionSurchargesRec2 := lvOptionSurchargesRec;
          lvOptionSurchargesRec2."Project No." := "Project No.";
          lvOptionSurchargesRec2."Plot No." := '';
          lvOptionSurchargesRec2."House Model" := "House Model";
          lvOptionSurchargesRec2."Main Group" := "Main Group";
          lvOptionSurchargesRec2.Group := Group;
          lvOptionSurchargesRec2."Sub Group" := "Sub Group";
          lvOptionSurchargesRec2.Option := Option;
          lvOptionSurchargesRec2.INSERT;
        UNTIL lvOptionSurchargesRec.NEXT = 0;
      END;

      lvOptionTextRec.SETRANGE(Table, lvOptionTextRec.Table::Option);
      lvOptionTextRec.SETRANGE("Project No.", lvProjectNo);
      lvOptionTextRec.SETRANGE("Plot No.", lvPlotNo);
      lvOptionTextRec.SETRANGE("House Model", lvOldLineRec."House Model");
      lvOptionTextRec.SETRANGE("Option Main Group", lvOldLineRec."Main Group");
      lvOptionTextRec.SETRANGE("Option Sub Group", lvOldLineRec."Sub Group");
      lvOptionTextRec.SETRANGE("Option Group", lvOldLineRec.Group);
      lvOptionTextRec.SETRANGE(Option, lvOldLineRec.Option);
      IF lvOptionTextRec.FIND('-') THEN BEGIN
        REPEAT
          lvOptionTextRec2 := lvOptionTextRec;
          lvOptionTextRec2."Project No." := "Project No.";
          lvOptionTextRec2."Plot No." := '';
          lvOptionTextRec2."House Model" := "House Model";
          lvOptionTextRec2."Option Main Group" := "Main Group";
          lvOptionTextRec2."Option Sub Group" := "Sub Group";
          lvOptionTextRec2."Option Group" := Group;
          lvOptionTextRec2.Option := Option;
          lvOptionTextRec2.INSERT;
        UNTIL lvOptionTextRec.NEXT = 0;
      END;
    END;

    PROCEDURE BuyerFactor@1100528400() : Decimal;
    BEGIN
      IF "Developers Discount Percentage" = 100 THEN
        FIELDERROR("Developers Discount Percentage");

      EXIT(
        (100 / (100 - "Developers Discount Percentage")) *
        ((100 + "Contractor Surcharge %") / 100));
    END;

    PROCEDURE InverseBuyerFactor@1100528401() : Decimal;
    BEGIN
      IF "Contractor Surcharge %" = -100 THEN
        FIELDERROR("Contractor Surcharge %");

      EXIT(
        ((100 - "Developers Discount Percentage") / 100) *
        (100 / (100 + "Contractor Surcharge %")));
    END;

    PROCEDURE ProcessStatusChange@1210190006(OldStatus@1210190001 : Option;NewStatus@1210190002 : Option;HeaderStatusChange@1100528402 : Boolean;VAR Option2@1100528401 : Record 11012502);
    VAR
      OptionQuoteHeader@1210190007 : Record 11012513;
      BuyersManagement@1210190003 : Codeunit 11012500;
      Level@1210190006 : 'Standard,Project,Plot';
      NewCopy@1100485000 : Boolean;
      KeepCurrentStatus@1100528400 : Boolean;
      Option3@1100527350 : Record 11012502;
    BEGIN
      TESTFIELD("Project No.");
      TESTFIELD("Plot No.");
      TESTFIELD("House Model");
      TESTFIELD("Main Group");
      TESTFIELD(Group);
      TESTFIELD("Sub Group");
      TESTFIELD(Option);
      OptionQuoteHeader.GET("Option Quote No.");
      OptionQuoteHeader.CALCFIELDS("House Model");
      TESTFIELD("Project No.", OptionQuoteHeader."Project No.");
      TESTFIELD("Plot No.", OptionQuoteHeader."Plot No.");
      TESTFIELD("House Model", OptionQuoteHeader."House Model");
      TESTFIELD(Quantity);

      IF Option2.GET("Project No.", "Plot No.", "House Model", "Main Group", Group, "Sub Group", Option) THEN BEGIN
        IF NOT Option2.Quantities THEN
          IF Option2.Status >= Option2.Status::Order THEN
            ERROR(Text000, "Main Group", Group, "Sub Group", Option, Option2.Status, "Project No.", "Plot No.");
        IF NOT Option2.Quantities THEN
            TESTFIELD(Quantity, 1);
      END ELSE BEGIN
        IF Option2.GET("Project No.", '', "House Model", "Main Group", Group, "Sub Group", Option) THEN BEGIN
          IF NOT Option2.Quantities THEN
            TESTFIELD(Quantity, 1);
          BuyersManagement.BmCopyOptions(
            Level::Project, Level::Plot,
            "Project No.", "Project No.",
            '', "Plot No.",
            "House Model", "House Model",
            "Main Group", "Main Group",
            Group, Group,
            "Sub Group", "Sub Group",
            Option, Option,TRUE);
          NewCopy := TRUE;
        END;
      END;

      IF Option2.GET("Project No.", "Plot No.", "House Model", "Main Group", Group, "Sub Group", Option) THEN BEGIN
        IF Option2.Quantities AND
            (NOT NewCopy) AND
            (Option2.Status IN [Option2.Status::Order,Option2.Status::Invoice])
        THEN BEGIN
          IF NewStatus = Status::Expired THEN BEGIN
            Option2.Quantity -= Quantity;
            IF Option2.Quantity <> 0 THEN
              KeepCurrentStatus := TRUE;
          END ELSE
            Option2.Quantity += Quantity;
          IF Option2."Installments Generated" THEN
            Option2."Installments Generated" := FALSE;
        END ELSE BEGIN
          Option2.Description := Description;
          Option2.Quantity := Quantity;
          Option2.Quantities := Quantities;
        END;
        Option2."Sales Price incl. VAT" := "Sales Price incl. VAT";
        Option2.OnValidateSalesPriceInclVAT(HeaderStatusChange);
        IF NOT KeepCurrentStatus THEN
          Option2.VALIDATE(Status, NewStatus);
        Option2."Modified by" := USERID;
        Option2."Last Date Modified" := TODAY;
        Option2.MODIFY(TRUE);
        Option2.UpdateWorkBudgetOnChanges(Option2, FALSE, FALSE);
      END ELSE BEGIN
        Option2.INIT;

        Option2."Project No." := "Project No.";
        Option2."Plot No." := "Plot No.";
        Option2."House Model" := "House Model";
        Option2."Main Group" := "Main Group";
        Option2.Group := Group;
        Option2."Sub Group" := "Sub Group";
        Option2.Option := Option;
        Option2.Status := NewStatus;
        Option2.Description := Description;
        Option2.Quantities := Quantities;
        Option2.Quantity := Quantity;
        Option2."Computed Sales Price Incl. VAT" := "Sales Amount incl. VAT";
        Option2."Sales Amount incl. VAT" := "Sales Amount excl. VAT";
        Option2."Contract Amount" := "Sales Amount excl. VAT";
        Option2."Offered Amount" := "Sales Amount excl. VAT";
        Option2."VAT Prod. Posting Group" := "VAT Prod. Posting Group";
        Option2."VAT Bus. Posting Group" := "VAT Bus. Posting Group";
        Option2."Computed VAT Amount" := "VAT Amount";
        Option2."Unit of Measure Code" := "Unit of Measure Code";

        Option2."VAT Amount" := "VAT Amount";
        Option2."Developers Discount Percentage" := "Developers Discount Percentage"; //C-025544
        Option2."Contractor Surcharge %" := "Contractor Surcharge %";
        Option2."Sales Price incl. VAT (Buyer)" := "Sales Price incl. VAT (Buyer)"; //C-025544
        Option2."Sales Price excl. VAT (Buyer)" := "Sales Price excl. VAT (Buyer)";
        Option2."Sales Price incl. VAT" := "Sales Price incl. VAT";
        Option2."Net Price" := "Net Price";
        Option2."Generate Installments" := "Generate Installments";
        Option2."Installment Scheme" := "Installment Scheme";
        Option2."Fixed Sales Price" := "Fixed Sales Price" ;
        Option2.OnValidateSalesPriceInclVAT(HeaderStatusChange);

        Option2.INSERT(TRUE);
        Option2.VALIDATE(Status, NewStatus);
        Option2.MODIFY(TRUE);

        IF Option3.GET("Project No.", '', "House Model from Option", "Main Group", Group, "Sub Group", Option) THEN BEGIN
          BuyersManagement.BmCopyOptionBudget(
            Option3, Option2."Project No.", Option2."Plot No.", Option2."House Model",
            Option2."Main Group", Option2.Group, Option2."Sub Group", Option2.Option);
          BuyersManagement.BmCopyOptionSummarySheet(
            Option3, Option2."Project No.", Option2."Plot No.", Option2."House Model",
            Option2."Main Group", Option2.Group, Option2."Sub Group", Option2.Option);
          BuyersManagement.BmCopyOptionSurcharges(
            Option3, Option2."Project No.", Option2."Plot No.", Option2."House Model",
            Option2."Main Group", Option2.Group, Option2."Sub Group", Option2.Option);
        END;
        Option2.UpdateWorkBudgetOnChanges(Option2, FALSE, FALSE);
      END;
      BuyersManagement.BmCopyQuoteLineTextToOption("Option Quote No.", "Line No.",
        "Project No.", "Plot No.", "House Model", "Main Group", Group, "Sub Group", Option);
    END;

    LOCAL PROCEDURE CheckIfChangingStatusAllowed@1100528402();
    VAR
      OptionQuoteHeader@1100528400 : Record 11012513;
    BEGIN
      IF OptionQuoteHeader.GET("Option Quote No.") THEN
        IF OptionQuoteHeader.Status <> OptionQuoteHeader.Status::Applied THEN
          TESTFIELD(Status, OptionQuoteHeader.Status);
    END;

    PROCEDURE RoundSalesPriceInclVATBuyer@1100528403();
    BEGIN
      TESTFIELD("Developers Discount Percentage", 0);
      IF "Sales Price incl. VAT" = 0 THEN
        VALIDATE("Sales Price incl. VAT (Buyer)", 0)
      ELSE BEGIN
        "Sales Price incl. VAT (Buyer)" := ROUND("Sales Price incl. VAT (Buyer)", 1);
        "Contractor Surcharge %" := BuyerMgtCU.CalculateContractorSurchargePercentage(
          "Sales Price incl. VAT", "Sales Price incl. VAT (Buyer)", 15);
        VALIDATE("Sales Price incl. VAT (Buyer)");
      END;
    END;

    PROCEDURE RoundSalesPriceInclVATBuyerOfSelectedLines@1100528404();
    BEGIN
      IF FINDSET(TRUE) THEN
        REPEAT
          RoundSalesPriceInclVATBuyer;
          MODIFY;
        UNTIL NEXT = 0;
    END;

    PROCEDURE RoundSalesPriceExclVATBuyer@1100528406();
    BEGIN
      TESTFIELD("Developers Discount Percentage", 0);
      IF "Sales Price excl. VAT" = 0 THEN
        VALIDATE("Sales Price excl. VAT (Buyer)", 0)
      ELSE BEGIN
        "Sales Price excl. VAT (Buyer)" := ROUND("Sales Price excl. VAT (Buyer)", 1);
        "Contractor Surcharge %" := BuyerMgtCU.CalculateContractorSurchargePercentage(
          "Sales Price excl. VAT", "Sales Price excl. VAT (Buyer)", 15);
        VALIDATE("Sales Price excl. VAT (Buyer)");
      END;
    END;

    PROCEDURE RoundSalesPriceExclVATBuyerOfSelectedLines@1100528405();
    BEGIN
      IF FINDSET(TRUE) THEN
        REPEAT
          RoundSalesPriceExclVATBuyer;
          MODIFY;
        UNTIL NEXT = 0;
    END;

    BEGIN
    END.
  }
}

