OBJECT Codeunit 11012256 Project Forecast Management
{
  OBJECT-PROPERTIES
  {
    Date=;
    Time=;
    Version List=4PS14.00;
  }
  PROPERTIES
  {
    Permissions=TableData 11012034=im,
                TableData 11012035=im;
    OnRun=BEGIN
          END;

  }
  CODE
  {
    VAR
      ProjectSetup@1100529601 : Record 315;
      Project@1100525002 : Record 11072003;
      ProjectForecastHeader@1100525001 : Record 11020630;
      ProjForecastInPeriod@1100528500 : Record 11020632;
      CurrencyBuff@1100529410 : TEMPORARY Record 4;
      CostContMgt@1100525000 : Codeunit 11012006;
      Text001@1100525004 : TextConst 'DEU=Forecast mit ''verfÅgbar'' ausfÅllen?;ENU=Fill Forecast with Available ?;NLD=Forecast met beschikbaar vullen ?;NOR=Vil du fylle ut Varsel med Tilgjengelige?;SVE=Vill du fylla i prognos med tillgÑngliga?';
      Text002@1100525005 : TextConst 'DEU=Forecast mit ''zulÑssig'' ausfÅllen?;ENU=Fill Forecast with Allowed ?;NLD=Forecast met toegestaan vullen ?;NOR=Vil du fylle ut Varsel med Tillatte?;SVE=Vill du fylla i prognos med tillÜtna?';
      Text003@1100525006 : TextConst 'DEU=Forecast mit ''Prognose'' ausfÅllen?;ENU=Fill Forecast with Prognosis ?;NLD=Forecast met prognose vullen ?;NOR=Vil du fylle ut Varsel med Prognose?;SVE=Vill du fylla i prognos med prognos?';
      Text004@1100525007 : TextConst 'DEU=Voriger Forecast kopieren?;ENU=Copy Previous Forecast ?;NLD=Vorige forecast kopiâren ?;NOR=Kopiere forrige Prognose?;SVE=Kopiera fîregÜende prognos?';
      Text005@1100525008 : TextConst 'DEU=Forecast linear verteilen?;ENU=Distribute Forecast Linear ?;NLD=Forecast lineair verdelen ?;NOR=Distribuere Prognose Lineërt?;SVE=Distribuera prognos linjÑrt?';
      Text007@1100525010 : TextConst 'DEU=%1 %2 nicht in Prognose unterstÅtzt.;ENU=%1 %2 is not supported in Prognosis.;NLD=%1 %2 niet ondersteund in prognose.;NOR=%1 %2 stõttes ikke i Prognose.;SVE=%1 %2 stîds inte i prognos.';
      Text008@1100525011 : TextConst 'DEU=Prognose bereits vorhanden. öberschreiben?;ENU=Prognosis already exists, overwrite ?;NLD=Prognose reeds aanwezig, overschrijven ?;NOR=Det finnes allerede en Prognose. Vil du overskrive den?;SVE=Det finns redan en prognos. Vill du skriva îver den?';
      Text009@1210190000 : TextConst 'DEU=Projekt %1 - Element %2 nicht vorhanden (vom Zuschlag);ENU=Project %1 -  Element %2 does not exist (from surcharges);NLD=Project %1 -  Element %2 bestaat niet (vanuit opslag);NOR=Prosjekt %1 Õ Element %2 finnes ikke (fra tileggsgebyrer);SVE=Projekt %1 Õ elementet %2 finns inte (frÜn tillÑggsavgifter)';
      Text010@1100528800 : TextConst 'DEU=Es kann keine Prognose erstellt werden. Es gibt eine Zeile mit einer Differenz von %1, das ist mehr als die %2 %3 in %4.;ENU=It is not possible to create a Prognosis. There is a line with a difference of %1, which is more than the %2 %3 in the %4.;NLD=Er kan geen prognose worden aangemaakt, omdat er een regel is met een verschil van %1. Dit is meer dan het %2 %3 in de %4.';
      Text011@1100529400 : TextConst 'DEU=Forecast als S-Kurve ausgeben?;ENU=Distribute Forecast by S-Curve ?;NLD=Forecast van S-Curve verdelen ?';
      IncludeVATAmount@1100529600 : Boolean;
      HasGotProjectSetup@1100529602 : Boolean;

    PROCEDURE CreateForecastLines@1100525000(Rec@1100525000 : Record 11020630);
    VAR
      PurchSetup@1100529600 : Record 312;
      DetermineProgressDate@1100525003 : Codeunit 11012014;
      DeterminePrognosisDate@1100525001 : Codeunit 11012029;
    BEGIN
      ProjectForecastHeader.COPY(Rec);
      Project.GET(ProjectForecastHeader."Project No.");
      Project.SETRANGE("Period Filter",0D, ProjectForecastHeader."Forecast Date");
      DetermineProgressDate.DetermineDate(Project,FALSE);
      DeterminePrognosisDate.DetermineDate(Project);

      //Build Cost Control
      Project.BuildCostControl;
      CODEUNIT.RUN(CODEUNIT::CreateControlLinesProjCostType, Project);
      CASE Project."Forecast Level" OF
        Project."Forecast Level"::"Element - Cost Object":
          CODEUNIT.RUN(CODEUNIT::CreateControlLinesElemCostObj, Project);
        Project."Forecast Level"::"Element - Cost Type":
          BEGIN
            CODEUNIT.RUN(CODEUNIT::CreateControlLinesElemCostObj, Project);
            CreateControlLinesElemCostTyp;
          END;
        Project."Forecast Level"::"Cost Object":
          CODEUNIT.RUN(CODEUNIT::CreateControlLinesProjCostObj,Project);
        Project."Forecast Level"::"Cost Type":;
      END;
      COMMIT;

      //**4PS.sn BI042 KD 22-09-16
      DeletePrevForecast;
      GetCurrencyBuff;
      //**4PS.en BI042 KD 22-09-16
      PurchSetup.GET;
      IncludeVATAmount := (PurchSetup."VAT Indicator (Purchase)" = PurchSetup."VAT Indicator (Purchase)"::"No VAT") AND
                          (Project."VAT Indicator (Purchase)" = Project."VAT Indicator (Purchase)"::"No VAT");

      CASE Project."Forecast Level" OF
        Project."Forecast Level"::"Element - Cost Object":
          CreateForecastElemCostObject;
        Project."Forecast Level"::"Element - Cost Type":
          CreateForecastElemCostType;
        Project."Forecast Level"::"Cost Object":
          CreateForecastCostObject;
        Project."Forecast Level"::"Cost Type":
          CreateForecastCostType;
      END;
      CreateForecastRevenues;
      CreateForecastTotals;
    END;

    PROCEDURE CreateControlLinesElemCostTyp@1100525017();
    VAR
      ControlProjElemCostObject@1100525000 : Record 11012050;
    BEGIN
      ControlProjElemCostObject.SETRANGE("Project No.", ProjectForecastHeader."Project No.");
      ControlProjElemCostObject.SETRANGE("Cumulation Filter", 0D, ProjectForecastHeader."Forecast Date");
      ControlProjElemCostObject.SETRANGE("Period Filter",0D,ProjectForecastHeader."Forecast Date"); //C040378.n
      ControlProjElemCostObject.SETRANGE("Main Project No.", Project."Main Project");
      IF Project."No." <> Project."Main Project" THEN
        ControlProjElemCostObject.SETRANGE("Project Filter", Project."No.");
      ControlProjElemCostObject.SETFILTER(Element, '<>%1', '');
      IF ControlProjElemCostObject.FINDSET THEN
        REPEAT
          Project.SETRANGE("Multipurpose Filter", ControlProjElemCostObject.Element);
          CODEUNIT.RUN(CODEUNIT::CreateControlLinesProjCostType,Project);
        UNTIL ControlProjElemCostObject.NEXT = 0;
    END;

    LOCAL PROCEDURE CreateForecastElemCostObject@1100525005() : Decimal;
    VAR
      ControlProjElemCostObject@1100525003 : Record 11012050;
      ProjectForecastLine@1100525000 : Record 11020631;
      ProjectForecastLinePurch@1100529401 : TEMPORARY Record 11020631;
      ProjectForecastinPeriodPurch@1100529400 : TEMPORARY Record 11020632;
      EmptyProjectForecastLine@1100528100 : Record 11020631;
      Dummy@1100525001 : Decimal;
    BEGIN
      ProjectForecastLine.SetUseDialogOnce(TRUE);
      Project.COPYFILTER("Progress Filter", ControlProjElemCostObject."Progress Filter");
      Project.COPYFILTER("Prognosis Filter", ControlProjElemCostObject."Prognosis Filter");
      //**4PS.sn BI042 KD 13-12-16
      IF ProjectForecastHeader."Forecast by Currency" THEN
         CostContMgt.POControlLineAmtFCY(Project, ProjectForecastHeader, ProjectForecastLinePurch, ProjectForecastinPeriodPurch);
      //**4PS.en BI042 KD 13-12-16
      ControlProjElemCostObject.SETRANGE("Project No.", ProjectForecastHeader."Project No.");
      ControlProjElemCostObject.SETRANGE("Cumulation Filter", 0D, ProjectForecastHeader."Forecast Date");
      ControlProjElemCostObject.SETRANGE("Period Filter",0D,ProjectForecastHeader."Forecast Date"); //C040378.n
      ControlProjElemCostObject.SETRANGE("Main Project No.", Project."Main Project");
      ControlProjElemCostObject.SETRANGE("Cost Type",
        ControlProjElemCostObject."Cost Type"::Labor, ControlProjElemCostObject."Cost Type"::Sundry);
      IF Project."No." <> Project."Main Project" THEN
        ControlProjElemCostObject.SETRANGE("Project Filter", Project."No.");
      IF ControlProjElemCostObject.FINDSET THEN
        REPEAT
          //**4PS.sn BI042 KD 25-08-16
          IF ProjectForecastHeader."Forecast by Currency" THEN BEGIN
            IF NOT ProjectForecastLine.GET(
              ProjectForecastHeader."Project No.",
              ProjectForecastHeader."Forecast Date",
              ControlProjElemCostObject."Cost Type",
              ControlProjElemCostObject.Element,
              ControlProjElemCostObject."Cost Object",
              '')
            THEN BEGIN
              ControlProjElemCostObject.SETRANGE("Currency Code Filter",'');
              ControlProjElemCostObject.CALCFIELDS(
                "Budget (FCY)", "Actual Costs (FCY)", Prognosis,
                "Open (Inventory)","Open Ovh. Surch. (Inventory)"); //C003394

              ProjectForecastLine := EmptyProjectForecastLine;
              ProjectForecastLine."Project No." := ProjectForecastHeader."Project No.";
              ProjectForecastLine."Forecast Date" := ProjectForecastHeader."Forecast Date";
              ProjectForecastLine."Cost Type" := ControlProjElemCostObject."Cost Type";
              ProjectForecastLine.Element := ControlProjElemCostObject.Element;
              ProjectForecastLine.VALIDATE("Cost Object",ControlProjElemCostObject."Cost Object");
              ProjectForecastLine.Budget := ControlProjElemCostObject."Budget (FCY)";
              ProjectForecastLine."Actual Costs" := ControlProjElemCostObject."Actual Costs (FCY)";
              ProjectForecastLine.Prognosis := ControlProjElemCostObject.Prognosis;
              ProjectForecastLine."Prognosis Hours" := DeterminePrognosisHours(ProjectForecastLine);

              CostContMgt.AllowedAndPurchElemCostObj(
                ControlProjElemCostObject,
                ProjectForecastLine.Allowed,
                ProjectForecastLine."Allowed Hours",
                Dummy, Dummy, Dummy, Dummy, Dummy, Dummy, Dummy, TRUE);

              IF NOT ProjectForecastLinePurch.GET(
                ProjectForecastHeader."Project No.",
                ProjectForecastHeader."Forecast Date",
                ProjectForecastLine."Cost Type",
                ProjectForecastLine.Element,
                ProjectForecastLine."Cost Object",
                '')
              THEN
                CLEAR(ProjectForecastLinePurch);

              ProjectForecastLine."Open (Purchase)" := ProjectForecastLinePurch."Open (Purchase)";
              ProjectForecastLine."Received/Not Invoiced" := ProjectForecastLinePurch."Received/Not Invoiced";
              IF CostContMgt.InclOpenPurchase THEN
                ProjectForecastLine."Open Ovh. Surch. (Purchase)" := ProjectForecastLinePurch."Open Ovh. Surch. (Purchase)" + ProjectForecastLinePurch."Open Ovh. Surch. (Inventory)"
              ELSE
                ProjectForecastLine."Open Ovh. Surch. (Purchase)" := ProjectForecastLinePurch."Open Ovh. Surch. (Inventory)";

              //C003394.sn
              ProjectForecastLine."Open (Inventory)" := ControlProjElemCostObject."Open (Inventory)";
              ProjectForecastLine."Open Ovh. Surch. (Inventory)" := ControlProjElemCostObject."Open Ovh. Surch. (Inventory)";
              ProjectForecastLine.CalcTotalOpenPurch;
              //C003394.en
              ProjectForecastLine.VALIDATE("Total Cost", CostContMgt.TotCostElemCostObjFCY(ControlProjElemCostObject,TRUE,
                ProjectForecastLinePurch."Open (Purchase)", ProjectForecastLinePurch."Received/Not Invoiced",
                ProjectForecastLinePurch."Open Ovh. Surch. (Inventory)", ProjectForecastLinePurch."Open Ovh. Surch. (Purchase)", ''));

              IF ControlProjElemCostObject."Cost Type" = ControlProjElemCostObject."Cost Type"::Labor THEN BEGIN
                ControlProjElemCostObject.CALCFIELDS("Budget Hours (FCY)", "Actual Hours (FCY)", "Open Hours (FCY)");
                ProjectForecastLine."Budget Hours" := ControlProjElemCostObject."Budget Hours (FCY)";
                ProjectForecastLine."Actual Hours" := ControlProjElemCostObject."Actual Hours (FCY)";
                ProjectForecastLine."Open Hours" := ControlProjElemCostObject."Open Hours (FCY)";
                ProjectForecastLine."Total Hours" := ControlProjElemCostObject."Actual Hours (FCY)" + ProjectForecastLinePurch."Total Hours" + ControlProjElemCostObject."Open Hours (FCY)";
              END;

              ProjectForecastLine.INSERT(TRUE);
              CreateForecastInPeriodFromPurcFCY(ProjectForecastLine, ProjectForecastinPeriodPurch);
              CreateForecastInPeriodFromHrs(ProjectForecastLine);
              CreateForecastInPeriodFromInv(ProjectForecastLine); //C003394
            END;

            IF CurrencyBuff.FINDSET THEN
              REPEAT
                IF NOT ProjectForecastLine.GET(
                  ProjectForecastHeader."Project No.",
                  ProjectForecastHeader."Forecast Date",
                  ControlProjElemCostObject."Cost Type",
                  ControlProjElemCostObject.Element,
                  ControlProjElemCostObject."Cost Object",
                  CurrencyBuff.Code)
                THEN BEGIN
                  ControlProjElemCostObject.SETRANGE("Currency Code Filter",CurrencyBuff.Code);
                  ControlProjElemCostObject.CALCFIELDS("Budget (FCY)", "Actual Costs (FCY)");

                  ProjectForecastLine := EmptyProjectForecastLine;
                  ProjectForecastLine."Project No." := ProjectForecastHeader."Project No.";
                  ProjectForecastLine."Forecast Date" := ProjectForecastHeader."Forecast Date";
                  ProjectForecastLine."Currency Code" := CurrencyBuff.Code;
                  ProjectForecastLine."Cost Type" := ControlProjElemCostObject."Cost Type";
                  ProjectForecastLine.Element := ControlProjElemCostObject.Element;
                  ProjectForecastLine.VALIDATE("Cost Object",ControlProjElemCostObject."Cost Object");
                  ProjectForecastLine.Budget := ControlProjElemCostObject."Budget (FCY)";
                  ProjectForecastLine."Actual Costs" := ControlProjElemCostObject."Actual Costs (FCY)";

                  IF NOT ProjectForecastLinePurch.GET(
                    ProjectForecastHeader."Project No.",
                    ProjectForecastHeader."Forecast Date",
                    ProjectForecastLine."Cost Type",
                    ProjectForecastLine.Element,
                    ProjectForecastLine."Cost Object",
                    CurrencyBuff.Code)
                  THEN
                    CLEAR(ProjectForecastLinePurch);

                  ProjectForecastLine."Open (Purchase)" := ProjectForecastLinePurch."Open (Purchase)";
                  ProjectForecastLine."Received/Not Invoiced" := ProjectForecastLinePurch."Received/Not Invoiced";
                  IF CostContMgt.InclOpenPurchase THEN
                    ProjectForecastLine."Open Ovh. Surch. (Purchase)" := ProjectForecastLinePurch."Open Ovh. Surch. (Purchase)" + ProjectForecastLinePurch."Open Ovh. Surch. (Inventory)"
                  ELSE
                    ProjectForecastLine."Open Ovh. Surch. (Purchase)" := ProjectForecastLinePurch."Open Ovh. Surch. (Inventory)";

                  ProjectForecastLine.CalcTotalOpenPurch;
                  ProjectForecastLine.VALIDATE("Total Cost", CostContMgt.TotCostElemCostObjFCY(ControlProjElemCostObject,TRUE,
                    ProjectForecastLinePurch."Open (Purchase)", ProjectForecastLinePurch."Received/Not Invoiced",
                    ProjectForecastLinePurch."Open Ovh. Surch. (Inventory)", ProjectForecastLinePurch."Open Ovh. Surch. (Purchase)", CurrencyBuff.Code));

                  IF ControlProjElemCostObject."Cost Type" = ControlProjElemCostObject."Cost Type"::Labor THEN BEGIN
                    ControlProjElemCostObject.CALCFIELDS("Budget Hours (FCY)", "Actual Hours (FCY)", "Open Hours (FCY)");
                    ProjectForecastLine."Budget Hours" := ControlProjElemCostObject."Budget Hours (FCY)";
                    ProjectForecastLine."Actual Hours" := ControlProjElemCostObject."Actual Hours (FCY)";
                    ProjectForecastLine."Open Hours" := ControlProjElemCostObject."Open Hours (FCY)";
                    ProjectForecastLine."Total Hours" := ControlProjElemCostObject."Actual Hours (FCY)" + ProjectForecastLinePurch."Total Hours" + ControlProjElemCostObject."Open Hours (FCY)";
                  END;

                  ProjectForecastLine.INSERT(TRUE);
                  CreateForecastInPeriodFromPurcFCY(ProjectForecastLine, ProjectForecastinPeriodPurch);
                  CreateForecastInPeriodFromHrs(ProjectForecastLine);
                END;
              UNTIL CurrencyBuff.NEXT = 0;
          END ELSE
          //**4PS.en BI042 KD 25-08-16
            IF NOT ProjectForecastLine.GET(
              ProjectForecastHeader."Project No.",
              ProjectForecastHeader."Forecast Date",
              ControlProjElemCostObject."Cost Type",
              ControlProjElemCostObject.Element,
              ControlProjElemCostObject."Cost Object",
              '') //**4PS.n BI042 KD 25-08-16
            THEN BEGIN
              ControlProjElemCostObject.CALCFIELDS(
                Budget, "Actual Costs", Prognosis,
                "Open (Inventory)","Open Ovh. Surch. (Inventory)"); //C003394

              ProjectForecastLine := EmptyProjectForecastLine;
              ProjectForecastLine."Project No." := ProjectForecastHeader."Project No.";
              ProjectForecastLine."Forecast Date" := ProjectForecastHeader."Forecast Date";
              ProjectForecastLine."Cost Type" := ControlProjElemCostObject."Cost Type";
              ProjectForecastLine.Element := ControlProjElemCostObject.Element;
              ProjectForecastLine.VALIDATE("Cost Object",ControlProjElemCostObject."Cost Object");
              ProjectForecastLine.Budget := ControlProjElemCostObject.Budget;
              ProjectForecastLine."Actual Costs" := ControlProjElemCostObject."Actual Costs";
              ProjectForecastLine.Prognosis := ControlProjElemCostObject.Prognosis;
              ProjectForecastLine."Prognosis Hours" := DeterminePrognosisHours(ProjectForecastLine);

              CostContMgt.AllowedAndPurchElemCostObj(
                ControlProjElemCostObject,
                ProjectForecastLine.Allowed,
                ProjectForecastLine."Allowed Hours",
                Dummy, Dummy, Dummy, Dummy, Dummy, Dummy, Dummy, TRUE);

              ProjectForecastLine."Open (Purchase)" := CostContMgt.OutstandingElemCostObj(ControlProjElemCostObject,TRUE);
              ProjectForecastLine."Received/Not Invoiced" := CostContMgt.ReceivedNotInvoicedElemCostObj(ControlProjElemCostObject,TRUE);
              ProjectForecastLine."Open Ovh. Surch. (Purchase)" := CostContMgt.OpenOvhPurchElemCostObj(ControlProjElemCostObject,TRUE);
              //C003394.sn
              ProjectForecastLine."Open (Inventory)" := ControlProjElemCostObject."Open (Inventory)";
              ProjectForecastLine."Open Ovh. Surch. (Inventory)" := ControlProjElemCostObject."Open Ovh. Surch. (Inventory)";
              ProjectForecastLine.CalcTotalOpenPurch;
              //C003394.en
              ProjectForecastLine.VALIDATE("Total Cost", CostContMgt.TotCostElemCostObj(ControlProjElemCostObject,TRUE));

              IF ControlProjElemCostObject."Cost Type" = ControlProjElemCostObject."Cost Type"::Labor THEN BEGIN
                ControlProjElemCostObject.CALCFIELDS("Budget Hours", "Actual Hours", "Open Hours");
                ProjectForecastLine."Budget Hours" := ControlProjElemCostObject."Budget Hours";
                ProjectForecastLine."Actual Hours" := ControlProjElemCostObject."Actual Hours";
                ProjectForecastLine."Open Hours" := ControlProjElemCostObject."Open Hours";
                ProjectForecastLine."Total Hours" := CostContMgt.TotHoursElemCostObj(ControlProjElemCostObject,TRUE);
              END;

              ProjectForecastLine.INSERT(TRUE);
              CreateForecastInPeriodFromPurc(ProjectForecastLine);
              CreateForecastInPeriodFromHrs(ProjectForecastLine);
              CreateForecastInPeriodFromInv(ProjectForecastLine); //C003394
            END;
        UNTIL ControlProjElemCostObject.NEXT = 0;
    END;

    LOCAL PROCEDURE CreateForecastElemCostType@1100525006();
    VAR
      ControlProjElemCostType@1100525002 : Record 11012049;
      ProjectForecastLine@1100525001 : Record 11020631;
      ProjectForecastLinePurch@1100529701 : TEMPORARY Record 11020631;
      ProjectForecastinPeriodPurch@1100529700 : TEMPORARY Record 11020632;
      EmptyProjectForecastLine@1100528100 : Record 11020631;
      Dummy@1100525000 : Decimal;
    BEGIN
      ProjectForecastLine.SetUseDialogOnce(TRUE);
      Project.COPYFILTER("Progress Filter", ControlProjElemCostType."Progress Filter");
      Project.COPYFILTER("Prognosis Filter", ControlProjElemCostType."Prognosis Filter");
      //**4PS.sn BI042 KD 13-12-16
      IF ProjectForecastHeader."Forecast by Currency" THEN
         CostContMgt.POControlLineAmtFCY(Project, ProjectForecastHeader, ProjectForecastLinePurch, ProjectForecastinPeriodPurch);
      //**4PS.en BI042 KD 13-12-16
      ControlProjElemCostType.SETRANGE("Project No.", ProjectForecastHeader."Project No.");
      ControlProjElemCostType.SETRANGE("Cumulation Filter", 0D, ProjectForecastHeader."Forecast Date");
      ControlProjElemCostType.SETRANGE("Period Filter",0D,ProjectForecastHeader."Forecast Date"); //C040378.n
      ControlProjElemCostType.SETRANGE("Main Project No.", Project."Main Project");
      ControlProjElemCostType.SETRANGE("Cost Type",
        ControlProjElemCostType."Cost Type"::Labor, ControlProjElemCostType."Cost Type"::Sundry);
      IF Project."No." <> Project."Main Project" THEN
        ControlProjElemCostType.SETRANGE("Project Filter", Project."No.");
      IF ControlProjElemCostType.FINDSET THEN
        REPEAT
          //**4PS.sn BI042 KD 25-08-16
          IF ProjectForecastHeader."Forecast by Currency" THEN BEGIN
            IF NOT ProjectForecastLine.GET(
              ProjectForecastHeader."Project No.",
              ProjectForecastHeader."Forecast Date",
              ControlProjElemCostType."Cost Type",
              ControlProjElemCostType.Element,
              '',
              '')
            THEN BEGIN
              ControlProjElemCostType.SETRANGE("Currency Code Filter",'');
              ControlProjElemCostType.CALCFIELDS(
                "Budget (FCY)", "Actual Costs (FCY)", Prognosis,
                "Open (Inventory)","Open Ovh. Surch. (Inventory)"); //C003394

              ProjectForecastLine := EmptyProjectForecastLine;
              ProjectForecastLine."Project No." := ProjectForecastHeader."Project No.";
              ProjectForecastLine."Forecast Date" := ProjectForecastHeader."Forecast Date";
              ProjectForecastLine."Cost Type" := ControlProjElemCostType."Cost Type";
              ProjectForecastLine.Element := ControlProjElemCostType.Element;
              ProjectForecastLine.Budget := ControlProjElemCostType."Budget (FCY)";
              ProjectForecastLine."Actual Costs" := ControlProjElemCostType."Actual Costs (FCY)";
              ProjectForecastLine.Prognosis := ControlProjElemCostType.Prognosis;
              ProjectForecastLine."Prognosis Hours" := DeterminePrognosisHours(ProjectForecastLine);

              CostContMgt.AllowedAndPurchElemCostType(
                ControlProjElemCostType,
                ProjectForecastLine.Allowed,
                ProjectForecastLine."Allowed Hours",
                Dummy, Dummy, TRUE);

              IF NOT ProjectForecastLinePurch.GET(
                ProjectForecastHeader."Project No.",
                ProjectForecastHeader."Forecast Date",
                ProjectForecastLine."Cost Type",
                ProjectForecastLine.Element,
                '',
                '')
              THEN
                CLEAR(ProjectForecastLinePurch);

              ProjectForecastLine."Open (Purchase)" := ProjectForecastLinePurch."Open (Purchase)";
              ProjectForecastLine."Received/Not Invoiced" := ProjectForecastLinePurch."Received/Not Invoiced";
              IF CostContMgt.InclOpenPurchase THEN
                ProjectForecastLine."Open Ovh. Surch. (Purchase)" := ProjectForecastLinePurch."Open Ovh. Surch. (Purchase)" + ProjectForecastLinePurch."Open Ovh. Surch. (Inventory)"
              ELSE
                ProjectForecastLine."Open Ovh. Surch. (Purchase)" := ProjectForecastLinePurch."Open Ovh. Surch. (Inventory)";

              //C003394.sn
              ProjectForecastLine."Open (Inventory)" := ControlProjElemCostType."Open (Inventory)";
              ProjectForecastLine."Open Ovh. Surch. (Inventory)" := ControlProjElemCostType."Open Ovh. Surch. (Inventory)";
              ProjectForecastLine.CalcTotalOpenPurch;
              //C003394.en

              ProjectForecastLine.VALIDATE("Total Cost", CostContMgt.TotCostElemCostTypeFCY(ControlProjElemCostType,TRUE,
                ProjectForecastLinePurch."Open (Purchase)", ProjectForecastLinePurch."Received/Not Invoiced",
                ProjectForecastLinePurch."Open Ovh. Surch. (Inventory)", ProjectForecastLinePurch."Open Ovh. Surch. (Purchase)", ''));

              IF ControlProjElemCostType."Cost Type" = ControlProjElemCostType."Cost Type"::Labor THEN BEGIN
                ControlProjElemCostType.CALCFIELDS("Budget Hours (FCY)", "Actual Hours (FCY)", "Open Hours (FCY)");
                ProjectForecastLine."Budget Hours" := ControlProjElemCostType."Budget Hours (FCY)";
                ProjectForecastLine."Actual Hours" := ControlProjElemCostType."Actual Hours (FCY)";
                ProjectForecastLine."Open Hours" := ControlProjElemCostType."Open Hours (FCY)";
                ProjectForecastLine."Total Hours" := ControlProjElemCostType."Actual Hours (FCY)" + ProjectForecastLinePurch."Total Hours" + ControlProjElemCostType."Open Hours (FCY)";
              END;

              ProjectForecastLine.INSERT(TRUE);
              CreateForecastInPeriodFromPurcFCY(ProjectForecastLine, ProjectForecastinPeriodPurch);
              CreateForecastInPeriodFromHrs(ProjectForecastLine);
              CreateForecastInPeriodFromInv(ProjectForecastLine); //C003394
            END;

            IF CurrencyBuff.FINDSET THEN
              REPEAT
                IF NOT ProjectForecastLine.GET(
                  ProjectForecastHeader."Project No.",
                  ProjectForecastHeader."Forecast Date",
                  ControlProjElemCostType."Cost Type",
                  ControlProjElemCostType.Element,
                  '',
                  CurrencyBuff.Code)
                THEN BEGIN
                  ControlProjElemCostType.SETRANGE("Currency Code Filter",CurrencyBuff.Code);
                  ControlProjElemCostType.CALCFIELDS("Budget (FCY)", "Actual Costs (FCY)");

                  ProjectForecastLine := EmptyProjectForecastLine;
                  ProjectForecastLine."Project No." := ProjectForecastHeader."Project No.";
                  ProjectForecastLine."Forecast Date" := ProjectForecastHeader."Forecast Date";
                  ProjectForecastLine."Cost Type" := ControlProjElemCostType."Cost Type";
                  ProjectForecastLine.Element := ControlProjElemCostType.Element;
                  ProjectForecastLine."Currency Code" := CurrencyBuff.Code;
                  ProjectForecastLine.Budget := ControlProjElemCostType."Budget (FCY)";
                  ProjectForecastLine."Actual Costs" := ControlProjElemCostType."Actual Costs (FCY)";

                  IF NOT ProjectForecastLinePurch.GET(
                    ProjectForecastHeader."Project No.",
                    ProjectForecastHeader."Forecast Date",
                    ProjectForecastLine."Cost Type",
                    ProjectForecastLine.Element,
                    '',
                    CurrencyBuff.Code)
                  THEN
                    CLEAR(ProjectForecastLinePurch);

                  ProjectForecastLine."Open (Purchase)" := ProjectForecastLinePurch."Open (Purchase)";
                  ProjectForecastLine."Received/Not Invoiced" := ProjectForecastLinePurch."Received/Not Invoiced";
                  IF CostContMgt.InclOpenPurchase THEN
                    ProjectForecastLine."Open Ovh. Surch. (Purchase)" := ProjectForecastLinePurch."Open Ovh. Surch. (Purchase)" + ProjectForecastLinePurch."Open Ovh. Surch. (Inventory)"
                  ELSE
                    ProjectForecastLine."Open Ovh. Surch. (Purchase)" := ProjectForecastLinePurch."Open Ovh. Surch. (Inventory)";

                  ProjectForecastLine.CalcTotalOpenPurch;

                  ProjectForecastLine.VALIDATE("Total Cost", CostContMgt.TotCostElemCostTypeFCY(ControlProjElemCostType,TRUE,
                    ProjectForecastLinePurch."Open (Purchase)", ProjectForecastLinePurch."Received/Not Invoiced",
                    ProjectForecastLinePurch."Open Ovh. Surch. (Inventory)", ProjectForecastLinePurch."Open Ovh. Surch. (Purchase)", CurrencyBuff.Code));

                  IF ControlProjElemCostType."Cost Type" = ControlProjElemCostType."Cost Type"::Labor THEN BEGIN
                    ControlProjElemCostType.CALCFIELDS("Budget Hours (FCY)", "Actual Hours (FCY)", "Open Hours (FCY)");
                    ProjectForecastLine."Budget Hours" := ControlProjElemCostType."Budget Hours (FCY)";
                    ProjectForecastLine."Actual Hours" := ControlProjElemCostType."Actual Hours (FCY)";
                    ProjectForecastLine."Open Hours" := ControlProjElemCostType."Open Hours (FCY)";
                    ProjectForecastLine."Total Hours" := ControlProjElemCostType."Actual Hours (FCY)" + ProjectForecastLinePurch."Total Hours" + ControlProjElemCostType."Open Hours (FCY)";
                  END;

                  ProjectForecastLine.INSERT(TRUE);
                  CreateForecastInPeriodFromPurcFCY(ProjectForecastLine, ProjectForecastinPeriodPurch);
                  CreateForecastInPeriodFromHrs(ProjectForecastLine);
                  // CreateForecastInPeriodFromInv(ProjectForecastLine); //C003394
                END;
              UNTIL CurrencyBuff.NEXT = 0;
          END ELSE
          //**4PS.en BI042 KD 25-08-16
            IF NOT ProjectForecastLine.GET(
              ProjectForecastHeader."Project No.",
              ProjectForecastHeader."Forecast Date",
              ControlProjElemCostType."Cost Type",
              ControlProjElemCostType.Element,
              '',
              '') //**4PS.n BI042 KD 25-08-16
            THEN BEGIN
              ControlProjElemCostType.CALCFIELDS(
                Budget, "Actual Costs", Prognosis,
                "Open (Inventory)","Open Ovh. Surch. (Inventory)"); //C003394

              ProjectForecastLine := EmptyProjectForecastLine;
              ProjectForecastLine."Project No." := ProjectForecastHeader."Project No.";
              ProjectForecastLine."Forecast Date" := ProjectForecastHeader."Forecast Date";
              ProjectForecastLine."Cost Type" := ControlProjElemCostType."Cost Type";
              ProjectForecastLine.Element := ControlProjElemCostType.Element;
              ProjectForecastLine.Budget := ControlProjElemCostType.Budget;
              ProjectForecastLine."Actual Costs" := ControlProjElemCostType."Actual Costs";
              ProjectForecastLine.Prognosis := ControlProjElemCostType.Prognosis;
              ProjectForecastLine."Prognosis Hours" := DeterminePrognosisHours(ProjectForecastLine);

              CostContMgt.AllowedAndPurchElemCostType(
                ControlProjElemCostType,
                ProjectForecastLine.Allowed,
                ProjectForecastLine."Allowed Hours",
                Dummy, Dummy, TRUE);

              ProjectForecastLine."Open (Purchase)" := CostContMgt.OutstandingElemCostType(ControlProjElemCostType,TRUE);
              ProjectForecastLine."Received/Not Invoiced" := CostContMgt.ReceivedNotInvoicedElemCostTyp(ControlProjElemCostType,TRUE);
              ProjectForecastLine."Open Ovh. Surch. (Purchase)" := CostContMgt.OpenOvhPurchElemCostType(ControlProjElemCostType,TRUE);
              //C003394.sn
              ProjectForecastLine."Open (Inventory)" := ControlProjElemCostType."Open (Inventory)";
              ProjectForecastLine."Open Ovh. Surch. (Inventory)" := ControlProjElemCostType."Open Ovh. Surch. (Inventory)";
              ProjectForecastLine.CalcTotalOpenPurch;
              //C003394.en
              ProjectForecastLine.VALIDATE("Total Cost", CostContMgt.TotCostElemCostType(ControlProjElemCostType,TRUE));

              IF ControlProjElemCostType."Cost Type" = ControlProjElemCostType."Cost Type"::Labor THEN BEGIN
                ControlProjElemCostType.CALCFIELDS("Budget Hours", "Actual Hours", "Open Hours");
                ProjectForecastLine."Budget Hours" := ControlProjElemCostType."Budget Hours";
                ProjectForecastLine."Actual Hours" := ControlProjElemCostType."Actual Hours";
                ProjectForecastLine."Open Hours" := ControlProjElemCostType."Open Hours";
                ProjectForecastLine."Total Hours" := CostContMgt.TotHoursElemCostType(ControlProjElemCostType,TRUE);
              END;
              ProjectForecastLine.INSERT(TRUE);
              CreateForecastInPeriodFromPurc(ProjectForecastLine);
              CreateForecastInPeriodFromHrs(ProjectForecastLine);
              CreateForecastInPeriodFromInv(ProjectForecastLine); //C003394
            END;
        UNTIL ControlProjElemCostType.NEXT = 0;
    END;

    LOCAL PROCEDURE CreateForecastCostObject@1100525007();
    VAR
      ControlProjectCostObject@1100525001 : Record 11012047;
      ProjectForecastLine@1100525002 : Record 11020631;
      ProjectForecastLinePurch@1100529701 : TEMPORARY Record 11020631;
      ProjectForecastinPeriodPurch@1100529700 : TEMPORARY Record 11020632;
      EmptyProjectForecastLine@1100528100 : Record 11020631;
      Dummy@1100525000 : Decimal;
    BEGIN
      ProjectForecastLine.SetUseDialogOnce(TRUE);
      Project.COPYFILTER("Progress Filter", ControlProjectCostObject."Progress Filter");
      Project.COPYFILTER("Prognosis Filter", ControlProjectCostObject."Prognosis Filter");
      //**4PS.sn BI042 KD 13-12-16
      IF ProjectForecastHeader."Forecast by Currency" THEN
         CostContMgt.POControlLineAmtFCY(Project, ProjectForecastHeader, ProjectForecastLinePurch, ProjectForecastinPeriodPurch);
      //**4PS.en BI042 KD 13-12-16
      ControlProjectCostObject.SETRANGE("Project No.", ProjectForecastHeader."Project No.");
      ControlProjectCostObject.SETRANGE("Cumulation Filter", 0D, ProjectForecastHeader."Forecast Date");
      ControlProjectCostObject.SETRANGE("Period Filter", 0D, ProjectForecastHeader."Forecast Date"); //C040378.n
      ControlProjectCostObject.SETRANGE("Main Project No.", Project."Main Project");
      ControlProjectCostObject.SETRANGE("Cost Type",
        ControlProjectCostObject."Cost Type"::Labor, ControlProjectCostObject."Cost Type"::Sundry);
      IF Project."No." <> Project."Main Project" THEN
        ControlProjectCostObject.SETRANGE("Project Filter", Project."No.");
      IF ControlProjectCostObject.FINDSET THEN
        REPEAT
          //**4PS.sn BI042 KD 25-08-16
          IF ProjectForecastHeader."Forecast by Currency" THEN BEGIN
            IF NOT ProjectForecastLine.GET(
              ProjectForecastHeader."Project No.",
              ProjectForecastHeader."Forecast Date",
              ControlProjectCostObject."Cost Type",
              '',
              ControlProjectCostObject."Cost Object",
              '')
            THEN BEGIN
              ControlProjectCostObject.SETRANGE("Currency Code Filter",'');
              ControlProjectCostObject.CALCFIELDS(
                "Budget (FCY)", "Actual Costs (FCY)", Prognosis,
                "Open (Inventory)","Open Ovh. Surch. (Inventory)"); //C003394

              ProjectForecastLine := EmptyProjectForecastLine;
              ProjectForecastLine."Project No." := ProjectForecastHeader."Project No.";
              ProjectForecastLine."Forecast Date" := ProjectForecastHeader."Forecast Date";
              ProjectForecastLine."Cost Type" := ControlProjectCostObject."Cost Type";
              ProjectForecastLine.VALIDATE("Cost Object",ControlProjectCostObject."Cost Object");
              ProjectForecastLine.Budget := ControlProjectCostObject."Budget (FCY)";
              ProjectForecastLine."Actual Costs" := ControlProjectCostObject."Actual Costs (FCY)";
              ProjectForecastLine.Prognosis := ControlProjectCostObject.Prognosis;
              ProjectForecastLine."Prognosis Hours" := DeterminePrognosisHours(ProjectForecastLine);

              CostContMgt.AllowedAndPurchCostObj(
                ControlProjectCostObject,
                ProjectForecastLine.Allowed,
                ProjectForecastLine."Allowed Hours",
                Dummy, Dummy, Dummy, Dummy, Dummy, Dummy, Dummy, TRUE);

              IF NOT ProjectForecastLinePurch.GET(
                ProjectForecastHeader."Project No.",
                ProjectForecastHeader."Forecast Date",
                ProjectForecastLine."Cost Type",
                '',
                ProjectForecastLine."Cost Object",
                '')
              THEN
                CLEAR(ProjectForecastLinePurch);

              ProjectForecastLine."Open (Purchase)" := ProjectForecastLinePurch."Open (Purchase)";
              ProjectForecastLine."Received/Not Invoiced" := ProjectForecastLinePurch."Received/Not Invoiced";
              IF CostContMgt.InclOpenPurchase THEN
                ProjectForecastLine."Open Ovh. Surch. (Purchase)" := ProjectForecastLinePurch."Open Ovh. Surch. (Purchase)" + ProjectForecastLinePurch."Open Ovh. Surch. (Inventory)"
              ELSE
                ProjectForecastLine."Open Ovh. Surch. (Purchase)" := ProjectForecastLinePurch."Open Ovh. Surch. (Inventory)";

              //C003394.sn
              ProjectForecastLine."Open (Inventory)" := ControlProjectCostObject."Open (Inventory)";
              ProjectForecastLine."Open Ovh. Surch. (Inventory)" := ControlProjectCostObject."Open Ovh. Surch. (Inventory)";
              ProjectForecastLine.CalcTotalOpenPurch;
              //C003394.en
              ProjectForecastLine.VALIDATE("Total Cost", CostContMgt.TotCostCostObjFCY(ControlProjectCostObject,TRUE,
                ProjectForecastLinePurch."Open (Purchase)", ProjectForecastLinePurch."Received/Not Invoiced",
                ProjectForecastLinePurch."Open Ovh. Surch. (Inventory)", ProjectForecastLinePurch."Open Ovh. Surch. (Purchase)", ''));

              IF ControlProjectCostObject."Cost Type" = ControlProjectCostObject."Cost Type"::Labor THEN BEGIN
                ControlProjectCostObject.CALCFIELDS("Budget Hours (FCY)", "Actual Hours (FCY)", "Open Hours (FCY)");
                ProjectForecastLine."Budget Hours" := ControlProjectCostObject."Budget Hours (FCY)";
                ProjectForecastLine."Actual Hours" := ControlProjectCostObject."Actual Hours (FCY)";
                ProjectForecastLine."Open Hours" := ControlProjectCostObject."Open Hours (FCY)";
                ProjectForecastLine."Total Hours" := ControlProjectCostObject."Actual Hours (FCY)" + ProjectForecastLinePurch."Total Hours" + ControlProjectCostObject."Open Hours (FCY)";
              END;

              ProjectForecastLine.INSERT(TRUE);

              CreateForecastInPeriodFromPurcFCY(ProjectForecastLine, ProjectForecastinPeriodPurch);
              CreateForecastInPeriodFromHrs(ProjectForecastLine);
              CreateForecastInPeriodFromInv(ProjectForecastLine); //C003394
            END;

            IF CurrencyBuff.FINDSET THEN
              REPEAT
                IF NOT ProjectForecastLine.GET(
                  ProjectForecastHeader."Project No.",
                  ProjectForecastHeader."Forecast Date",
                  ControlProjectCostObject."Cost Type",
                  '',
                  ControlProjectCostObject."Cost Object",
                  CurrencyBuff.Code)
                THEN BEGIN
                  ControlProjectCostObject.SETRANGE("Currency Code Filter",CurrencyBuff.Code);
                  ControlProjectCostObject.CALCFIELDS("Budget (FCY)", "Actual Costs (FCY)");

                  ProjectForecastLine := EmptyProjectForecastLine;
                  ProjectForecastLine."Project No." := ProjectForecastHeader."Project No.";
                  ProjectForecastLine."Forecast Date" := ProjectForecastHeader."Forecast Date";
                  ProjectForecastLine."Currency Code" := CurrencyBuff.Code;
                  ProjectForecastLine."Cost Type" := ControlProjectCostObject."Cost Type";
                  ProjectForecastLine.VALIDATE("Cost Object",ControlProjectCostObject."Cost Object");
                  ProjectForecastLine.Budget := ControlProjectCostObject."Budget (FCY)";
                  ProjectForecastLine."Actual Costs" := ControlProjectCostObject."Actual Costs (FCY)";

                  IF NOT ProjectForecastLinePurch.GET(
                    ProjectForecastHeader."Project No.",
                    ProjectForecastHeader."Forecast Date",
                    ProjectForecastLine."Cost Type",
                    '',
                    ProjectForecastLine."Cost Object",
                    CurrencyBuff.Code)
                  THEN
                    CLEAR(ProjectForecastLinePurch);

                  ProjectForecastLine."Open (Purchase)" := ProjectForecastLinePurch."Open (Purchase)";
                  ProjectForecastLine."Received/Not Invoiced" := ProjectForecastLinePurch."Received/Not Invoiced";
                  IF CostContMgt.InclOpenPurchase THEN
                    ProjectForecastLine."Open Ovh. Surch. (Purchase)" := ProjectForecastLinePurch."Open Ovh. Surch. (Purchase)" + ProjectForecastLinePurch."Open Ovh. Surch. (Inventory)"
                  ELSE
                    ProjectForecastLine."Open Ovh. Surch. (Purchase)" := ProjectForecastLinePurch."Open Ovh. Surch. (Inventory)";

                  ProjectForecastLine.CalcTotalOpenPurch;

                  ProjectForecastLine.VALIDATE("Total Cost", CostContMgt.TotCostCostObjFCY(ControlProjectCostObject,TRUE,
                    ProjectForecastLinePurch."Open (Purchase)", ProjectForecastLinePurch."Received/Not Invoiced",
                    ProjectForecastLinePurch."Open Ovh. Surch. (Inventory)", ProjectForecastLinePurch."Open Ovh. Surch. (Purchase)", CurrencyBuff.Code));

                  IF ControlProjectCostObject."Cost Type" = ControlProjectCostObject."Cost Type"::Labor THEN BEGIN
                    ControlProjectCostObject.CALCFIELDS("Budget Hours (FCY)", "Actual Hours (FCY)", "Open Hours (FCY)");
                    ProjectForecastLine."Budget Hours" := ControlProjectCostObject."Budget Hours (FCY)";
                    ProjectForecastLine."Actual Hours" := ControlProjectCostObject."Actual Hours (FCY)";
                    ProjectForecastLine."Open Hours" := ControlProjectCostObject."Open Hours (FCY)";
                    ProjectForecastLine."Total Hours" := ControlProjectCostObject."Actual Hours (FCY)" + ProjectForecastLinePurch."Total Hours" + ControlProjectCostObject."Open Hours (FCY)";
                  END;

                  ProjectForecastLine.INSERT(TRUE);
                  CreateForecastInPeriodFromPurcFCY(ProjectForecastLine, ProjectForecastinPeriodPurch);
                  CreateForecastInPeriodFromHrs(ProjectForecastLine);
                END;
              UNTIL CurrencyBuff.NEXT = 0;
          END ELSE
          //**4PS.en BI042 KD 25-08-16
            IF NOT ProjectForecastLine.GET(
              ProjectForecastHeader."Project No.",
              ProjectForecastHeader."Forecast Date",
              ControlProjectCostObject."Cost Type",
              '',
              ControlProjectCostObject."Cost Object",
              '') //**4PS.n BI042 KD 25-08-16
            THEN BEGIN
              ControlProjectCostObject.CALCFIELDS(
                Budget, "Actual Costs", Prognosis,
                "Open (Inventory)","Open Ovh. Surch. (Inventory)"); //C003394


              ProjectForecastLine := EmptyProjectForecastLine;
              ProjectForecastLine."Project No." := ProjectForecastHeader."Project No.";
              ProjectForecastLine."Forecast Date" := ProjectForecastHeader."Forecast Date";
              ProjectForecastLine."Cost Type" := ControlProjectCostObject."Cost Type";
              ProjectForecastLine.VALIDATE("Cost Object",ControlProjectCostObject."Cost Object");
              ProjectForecastLine.Budget := ControlProjectCostObject.Budget;
              ProjectForecastLine."Actual Costs" := ControlProjectCostObject."Actual Costs";
              ProjectForecastLine.Prognosis := ControlProjectCostObject.Prognosis;
              ProjectForecastLine."Prognosis Hours" := DeterminePrognosisHours(ProjectForecastLine);

              CostContMgt.AllowedAndPurchCostObj(
                ControlProjectCostObject,
                ProjectForecastLine.Allowed,
                ProjectForecastLine."Allowed Hours",
                Dummy, Dummy, Dummy, Dummy, Dummy, Dummy, Dummy, TRUE);

              ProjectForecastLine."Open (Purchase)" := CostContMgt.OutstandingCostObj(ControlProjectCostObject,TRUE);
              ProjectForecastLine."Received/Not Invoiced" := CostContMgt.ReceivedNotInvoicedCostObj(ControlProjectCostObject,TRUE);
              ProjectForecastLine."Open Ovh. Surch. (Purchase)" := CostContMgt.OpenOvhPurchCostObj(ControlProjectCostObject,TRUE);
              //C003394.sn
              ProjectForecastLine."Open (Inventory)" := ControlProjectCostObject."Open (Inventory)";
              ProjectForecastLine."Open Ovh. Surch. (Inventory)" := ControlProjectCostObject."Open Ovh. Surch. (Inventory)";
              ProjectForecastLine.CalcTotalOpenPurch;
              //C003394.en
              ProjectForecastLine.VALIDATE("Total Cost", CostContMgt.TotCostCostObj(ControlProjectCostObject,TRUE));

              IF ControlProjectCostObject."Cost Type" = ControlProjectCostObject."Cost Type"::Labor THEN BEGIN
                ControlProjectCostObject.CALCFIELDS("Budget Hours", "Actual Hours", "Open Hours");
                ProjectForecastLine."Budget Hours" := ControlProjectCostObject."Budget Hours";
                ProjectForecastLine."Actual Hours" := ControlProjectCostObject."Actual Hours";
                ProjectForecastLine."Open Hours" := ControlProjectCostObject."Open Hours";
                ProjectForecastLine."Total Hours" := CostContMgt.TotHoursCostObj(ControlProjectCostObject,TRUE);
              END;
              ProjectForecastLine.INSERT(TRUE);
              CreateForecastInPeriodFromPurc(ProjectForecastLine);
              CreateForecastInPeriodFromHrs(ProjectForecastLine);
              CreateForecastInPeriodFromInv(ProjectForecastLine); //C003394
            END;
        UNTIL ControlProjectCostObject.NEXT = 0;
    END;

    LOCAL PROCEDURE CreateForecastCostType@1100525008();
    VAR
      ControlProjectCostType@1100525000 : Record 11012046;
      ProjectForecastLine@1100525002 : Record 11020631;
      ProjectForecastLinePurch@1100529701 : TEMPORARY Record 11020631;
      ProjectForecastinPeriodPurch@1100529700 : TEMPORARY Record 11020632;
      EmptyProjectForecastLine@1100528100 : Record 11020631;
      Dummy@1100525001 : Decimal;
    BEGIN
      ProjectForecastLine.SetUseDialogOnce(TRUE);
      Project.COPYFILTER("Progress Filter", ControlProjectCostType."Progress Filter");
      Project.COPYFILTER("Prognosis Filter", ControlProjectCostType."Prognosis Filter");
      //**4PS.sn BI042 KD 13-12-16
      IF ProjectForecastHeader."Forecast by Currency" THEN
         CostContMgt.POControlLineAmtFCY(Project, ProjectForecastHeader, ProjectForecastLinePurch, ProjectForecastinPeriodPurch);
      //**4PS.en BI042 KD 13-12-16
      ControlProjectCostType.SETRANGE("Project No.", ProjectForecastHeader."Project No.");
      ControlProjectCostType.SETRANGE("Cumulation Filter", 0D, ProjectForecastHeader."Forecast Date");
      ControlProjectCostType.SETRANGE("Period Filter",0D,ProjectForecastHeader."Forecast Date"); //C040378.n
      ControlProjectCostType.SETRANGE("Main Project No.", Project."Main Project");
      IF Project."No." <> Project."Main Project" THEN
        ControlProjectCostType.SETRANGE("Project Filter", Project."No.");
      ControlProjectCostType.SETRANGE("Cost Type",
        ControlProjectCostType."Cost Type"::Labor, ControlProjectCostType."Cost Type"::Sundry);
      IF ControlProjectCostType.FINDSET THEN
        REPEAT
          //**4PS.sn BI042 KD 19-08-16
          IF ProjectForecastHeader."Forecast by Currency" THEN BEGIN
            IF NOT ProjectForecastLine.GET(
              ProjectForecastHeader."Project No.",
              ProjectForecastHeader."Forecast Date",
              ControlProjectCostType."Cost Type",
              '',
              '',
              '')
            THEN BEGIN
              ControlProjectCostType.SETRANGE("Currency Code Filter",'');
              ControlProjectCostType.CALCFIELDS(
                "Budget (FCY)", "Actual Costs (FCY)", Prognosis,
                "Open (Inventory)","Open Ovh. Surch. (Inventory)"); //C003394

              ProjectForecastLine := EmptyProjectForecastLine;
              ProjectForecastLine."Project No." := ProjectForecastHeader."Project No.";
              ProjectForecastLine."Forecast Date" := ProjectForecastHeader."Forecast Date";
              ProjectForecastLine."Cost Type" := ControlProjectCostType."Cost Type";
              ProjectForecastLine.Budget := ControlProjectCostType."Budget (FCY)";
              ProjectForecastLine."Actual Costs" := ControlProjectCostType."Actual Costs (FCY)";
              ProjectForecastLine.Prognosis := ControlProjectCostType.Prognosis;
              ProjectForecastLine."Prognosis Hours" := DeterminePrognosisHours(ProjectForecastLine);

              CostContMgt.AllowedAndPurchCostType(
                ControlProjectCostType,
                ProjectForecastLine.Allowed,
                ProjectForecastLine."Allowed Hours",
                Dummy, Dummy, Dummy, Dummy, Dummy, Dummy, Dummy, TRUE);

              IF NOT ProjectForecastLinePurch.GET(
                ProjectForecastHeader."Project No.",
                ProjectForecastHeader."Forecast Date",
                ProjectForecastLine."Cost Type",
                '',
                '',
                '')
              THEN
                CLEAR(ProjectForecastLinePurch);

              ProjectForecastLine."Open (Purchase)" := ProjectForecastLinePurch."Open (Purchase)";
              ProjectForecastLine."Received/Not Invoiced" := ProjectForecastLinePurch."Received/Not Invoiced";
              IF CostContMgt.InclOpenPurchase THEN
                ProjectForecastLine."Open Ovh. Surch. (Purchase)" := ProjectForecastLinePurch."Open Ovh. Surch. (Purchase)" + ProjectForecastLinePurch."Open Ovh. Surch. (Inventory)"
              ELSE
                ProjectForecastLine."Open Ovh. Surch. (Purchase)" := ProjectForecastLinePurch."Open Ovh. Surch. (Inventory)";

              //C003394.sn
              ProjectForecastLine."Open (Inventory)" := ControlProjectCostType."Open (Inventory)";
              ProjectForecastLine."Open Ovh. Surch. (Inventory)" := ControlProjectCostType."Open Ovh. Surch. (Inventory)";
              ProjectForecastLine.CalcTotalOpenPurch;
              //C003394.en
              ProjectForecastLine.VALIDATE("Total Cost", CostContMgt.TotCostCostTypeFCY(ControlProjectCostType,TRUE,
                ProjectForecastLinePurch."Open (Purchase)", ProjectForecastLinePurch."Received/Not Invoiced",
                ProjectForecastLinePurch."Open Ovh. Surch. (Inventory)", ProjectForecastLinePurch."Open Ovh. Surch. (Purchase)", ''));

              IF ControlProjectCostType."Cost Type" = ControlProjectCostType."Cost Type"::Labor THEN BEGIN
                ControlProjectCostType.CALCFIELDS("Budget Hours (FCY)", "Actual Hours (FCY)", "Open Hours (FCY)");
                ProjectForecastLine."Budget Hours" := ControlProjectCostType."Budget Hours (FCY)";
                ProjectForecastLine."Actual Hours" := ControlProjectCostType."Actual Hours (FCY)";
                ProjectForecastLine."Open Hours" := ControlProjectCostType."Open Hours (FCY)";
                ProjectForecastLine."Total Hours" := ControlProjectCostType."Actual Hours (FCY)" + ProjectForecastLinePurch."Total Hours" + ControlProjectCostType."Open Hours (FCY)";
              END;

              ProjectForecastLine.INSERT(TRUE);
              CreateForecastInPeriodFromPurcFCY(ProjectForecastLine, ProjectForecastinPeriodPurch);
              CreateForecastInPeriodFromHrs(ProjectForecastLine);
              CreateForecastInPeriodFromInv(ProjectForecastLine); //C003394
            END;

            IF CurrencyBuff.FINDSET THEN
              REPEAT
                IF NOT ProjectForecastLine.GET(
                  ProjectForecastHeader."Project No.",
                  ProjectForecastHeader."Forecast Date",
                  ControlProjectCostType."Cost Type",
                  '',
                  '',
                  CurrencyBuff.Code)
                THEN BEGIN
                  ControlProjectCostType.SETRANGE("Currency Code Filter",CurrencyBuff.Code);
                  ControlProjectCostType.CALCFIELDS("Budget (FCY)", "Actual Costs (FCY)");

                  ProjectForecastLine := EmptyProjectForecastLine;
                  ProjectForecastLine."Project No." := ProjectForecastHeader."Project No.";
                  ProjectForecastLine."Forecast Date" := ProjectForecastHeader."Forecast Date";
                  ProjectForecastLine."Cost Type" := ControlProjectCostType."Cost Type";
                  ProjectForecastLine."Currency Code" := CurrencyBuff.Code;
                  ProjectForecastLine.Budget := ControlProjectCostType."Budget (FCY)";
                  ProjectForecastLine."Actual Costs" := ControlProjectCostType."Actual Costs (FCY)";

                  IF NOT ProjectForecastLinePurch.GET(
                    ProjectForecastHeader."Project No.",
                    ProjectForecastHeader."Forecast Date",
                    ProjectForecastLine."Cost Type",
                    '',
                    '',
                    CurrencyBuff.Code)
                  THEN
                    CLEAR(ProjectForecastLinePurch);

                  ProjectForecastLine."Open (Purchase)" := ProjectForecastLinePurch."Open (Purchase)";
                  ProjectForecastLine."Received/Not Invoiced" := ProjectForecastLinePurch."Received/Not Invoiced";
                  IF CostContMgt.InclOpenPurchase THEN
                    ProjectForecastLine."Open Ovh. Surch. (Purchase)" := ProjectForecastLinePurch."Open Ovh. Surch. (Purchase)" + ProjectForecastLinePurch."Open Ovh. Surch. (Inventory)"
                  ELSE
                    ProjectForecastLine."Open Ovh. Surch. (Purchase)" := ProjectForecastLinePurch."Open Ovh. Surch. (Inventory)";

                  ProjectForecastLine.CalcTotalOpenPurch;
                  ProjectForecastLine.VALIDATE("Total Cost", CostContMgt.TotCostCostTypeFCY(ControlProjectCostType,TRUE,
                    ProjectForecastLinePurch."Open (Purchase)", ProjectForecastLinePurch."Received/Not Invoiced",
                    ProjectForecastLinePurch."Open Ovh. Surch. (Inventory)", ProjectForecastLinePurch."Open Ovh. Surch. (Purchase)", CurrencyBuff.Code));

                  IF ControlProjectCostType."Cost Type" = ControlProjectCostType."Cost Type"::Labor THEN BEGIN
                    ControlProjectCostType.CALCFIELDS("Budget Hours (FCY)", "Actual Hours (FCY)", "Open Hours (FCY)");
                    ProjectForecastLine."Budget Hours" := ControlProjectCostType."Budget Hours (FCY)";
                    ProjectForecastLine."Actual Hours" := ControlProjectCostType."Actual Hours (FCY)";
                    ProjectForecastLine."Open Hours" := ControlProjectCostType."Open Hours (FCY)";
                    ProjectForecastLine."Total Hours" := ControlProjectCostType."Actual Hours (FCY)" + ProjectForecastLinePurch."Total Hours" + ControlProjectCostType."Open Hours (FCY)";
                  END;

                  ProjectForecastLine.INSERT(TRUE);
                  CreateForecastInPeriodFromPurcFCY(ProjectForecastLine, ProjectForecastinPeriodPurch);
                  CreateForecastInPeriodFromHrs(ProjectForecastLine);
                END;
              UNTIL CurrencyBuff.NEXT = 0;
          END ELSE
          //**4PS.en BI042 KD 19-08-16
            IF NOT ProjectForecastLine.GET(
              ProjectForecastHeader."Project No.",
              ProjectForecastHeader."Forecast Date",
              ControlProjectCostType."Cost Type",
              '',
              '',
              '') //**4PS.n BI042 KD 19-08-16
            THEN BEGIN
              ControlProjectCostType.CALCFIELDS(
                Budget, "Actual Costs", Prognosis,
                "Open (Inventory)","Open Ovh. Surch. (Inventory)"); //C003394

              ProjectForecastLine := EmptyProjectForecastLine;
              ProjectForecastLine."Project No." := ProjectForecastHeader."Project No.";
              ProjectForecastLine."Forecast Date" := ProjectForecastHeader."Forecast Date";
              ProjectForecastLine."Cost Type" := ControlProjectCostType."Cost Type";
              ProjectForecastLine.Budget := ControlProjectCostType.Budget;
              ProjectForecastLine."Actual Costs" := ControlProjectCostType."Actual Costs";
              ProjectForecastLine.Prognosis := ControlProjectCostType.Prognosis;
              ProjectForecastLine."Prognosis Hours" := DeterminePrognosisHours(ProjectForecastLine);

              CostContMgt.AllowedAndPurchCostType(
                ControlProjectCostType,
                ProjectForecastLine.Allowed,
                ProjectForecastLine."Allowed Hours",
                Dummy, Dummy, Dummy, Dummy, Dummy, Dummy, Dummy, TRUE);

              ProjectForecastLine."Open (Purchase)" := CostContMgt.OutstandingCostType(ControlProjectCostType,TRUE);
              ProjectForecastLine."Received/Not Invoiced" := CostContMgt.ReceivedNotInvoicedCostType(ControlProjectCostType,TRUE);
              ProjectForecastLine."Open Ovh. Surch. (Purchase)" := CostContMgt.OpenOvhPurchCostType(ControlProjectCostType,TRUE);
              //C003394.sn
              ProjectForecastLine."Open (Inventory)" := ControlProjectCostType."Open (Inventory)";
              ProjectForecastLine."Open Ovh. Surch. (Inventory)" := ControlProjectCostType."Open Ovh. Surch. (Inventory)";
              ProjectForecastLine.CalcTotalOpenPurch;
              //C003394.en
              ProjectForecastLine.VALIDATE("Total Cost", CostContMgt.TotCostCostType(ControlProjectCostType,TRUE));

              IF ControlProjectCostType."Cost Type" = ControlProjectCostType."Cost Type"::Labor THEN BEGIN
                ControlProjectCostType.CALCFIELDS("Budget Hours", "Actual Hours", "Open Hours");
                ProjectForecastLine."Budget Hours" := ControlProjectCostType."Budget Hours";
                ProjectForecastLine."Actual Hours" := ControlProjectCostType."Actual Hours";
                ProjectForecastLine."Open Hours" := ControlProjectCostType."Open Hours";
                ProjectForecastLine."Total Hours" := CostContMgt.TotHoursCostType(ControlProjectCostType,TRUE);
              END;
              ProjectForecastLine.INSERT(TRUE);
              CreateForecastInPeriodFromPurc(ProjectForecastLine);
              CreateForecastInPeriodFromHrs(ProjectForecastLine);
              CreateForecastInPeriodFromInv(ProjectForecastLine); //C003394
            END;
          UNTIL ControlProjectCostType.NEXT = 0;
    END;

    LOCAL PROCEDURE CreateForecastRevenues@1100525016();
    VAR
      SubProject@1100525000 : Record 11072003;
      ProjectInstallment@1100525001 : Record 11012018;
      ProjLedgEntry@1100526200 : Record 11072005;
      ProjectForecastLine@1100525002 : Record 11020631;
      EmptyProjectForecastLine@1100528100 : Record 11020631;
      StartDate@1100525003 : Date;
      AmountToApplyInPeriod@1100525004 : Decimal;
    BEGIN
      ProjectForecastLine.SetUseDialogOnce(TRUE);
      ProjectForecastLine.SETRANGE("Project No.", ProjectForecastHeader."Project No.");
      ProjectForecastLine.SETRANGE("Forecast Date", ProjectForecastHeader."Forecast Date");
      ProjectForecastLine.SETRANGE("Cost Type", ProjectForecastLine."Cost Type"::Revenue);
      IF NOT ProjectForecastLine.ISEMPTY THEN
        EXIT;

      SubProject.SETCURRENTKEY("Main Project");
      SubProject.SETRANGE("Main Project", Project."Main Project");
      IF Project."Single/Main/Sub Project" <> Project."Single/Main/Sub Project"::"Main Project" THEN
        SubProject.SETRANGE("No.", ProjectForecastHeader."Project No.");
      IF SubProject.FINDSET THEN
        REPEAT
          //*C005733.sn
          ProjLedgEntry.RESET;
          ProjLedgEntry.SETCURRENTKEY("Job No.", "Cost Type", "Entry Type", "Posting Date");
          ProjLedgEntry.SETRANGE("Job No.", SubProject."No.");
          ProjLedgEntry.SETRANGE("Cost Type", ProjLedgEntry."Cost Type"::Revenues);
          ProjLedgEntry.SETRANGE("Entry Type", ProjLedgEntry."Entry Type"::Sale);
          ProjLedgEntry.SETRANGE("Posting Date", 0D, ProjectForecastHeader."Forecast Date");  //*C005725.n
          ProjLedgEntry.SETRANGE("Advance Payment", FALSE);
          IF ProjLedgEntry.FINDSET THEN BEGIN
            REPEAT
              ProjectForecastLine := EmptyProjectForecastLine;
              ProjectForecastLine."Project No." := ProjectForecastHeader."Project No.";
              ProjectForecastLine."Forecast Date" := ProjectForecastHeader."Forecast Date";
              ProjectForecastLine."Cost Type" := ProjectForecastLine."Cost Type"::Revenue;
              CASE Project."Forecast Level" OF
                Project."Forecast Level"::"Element - Cost Object":
                  BEGIN
                    ProjectForecastLine."Cost Object" := ProjLedgEntry."Global Dimension 2 Code";
                    ProjectForecastLine.Element := ProjLedgEntry.Element;
                  END;
                Project."Forecast Level"::"Element - Cost Type":
                  ProjectForecastLine.Element := ProjLedgEntry.Element;
                Project."Forecast Level"::"Cost Object":
                  ProjectForecastLine."Cost Object" := ProjLedgEntry."Global Dimension 2 Code";
                Project."Forecast Level"::"Cost Type":;
              END;
              //**4PS.sn BI042 KD 19-08-16
              IF ProjectForecastHeader."Forecast by Currency" THEN
                ProjectForecastLine."Currency Code" := ProjLedgEntry."Currency Code";
              //**4PS.en BI042 KD 19-08-16

              IF NOT ProjectForecastLine.GET(
                ProjectForecastHeader."Project No.",
                ProjectForecastHeader."Forecast Date",
                ProjectForecastLine."Cost Type"::Revenue,
                ProjectForecastLine.Element,
                ProjectForecastLine."Cost Object",
                ProjectForecastLine."Currency Code") //**4PS.n BI042 KD 19-08-16
              THEN BEGIN
                //**4PS.sn BI042 KD 19-08-16
                IF ProjectForecastHeader."Forecast by Currency" THEN
                  ProjectForecastLine.Invoiced := - ProjLedgEntry."Total Price"
                ELSE
                //**4PS.en BI042 KD 19-08-16
                  ProjectForecastLine.Invoiced := - ProjLedgEntry."Total Price (LCY)";  //Note: Total Price neg. in Proj. Ledger Entry
                ProjectForecastLine.INSERT(TRUE);
              END ELSE BEGIN
                //**4PS.sn BI042 KD 19-08-16
                IF ProjectForecastHeader."Forecast by Currency" THEN
                  ProjectForecastLine.Invoiced := ProjectForecastLine.Invoiced - ProjLedgEntry."Total Price"
                ELSE
                //**4PS.en BI042 KD 19-08-16
                  ProjectForecastLine.Invoiced := ProjectForecastLine.Invoiced - ProjLedgEntry."Total Price (LCY)";
                ProjectForecastLine.MODIFY(TRUE);
              END;
            UNTIL ProjLedgEntry.NEXT = 0;
          END;
          //*C005733.en

          ProjectInstallment.RESET;
          ProjectInstallment.SETRANGE("Project No.", SubProject."No.");
          IF ProjectInstallment.FINDSET THEN
            REPEAT
              IF NOT SkipInstallment(ProjectInstallment) THEN BEGIN  //*C005931.n
                ProjectForecastLine := EmptyProjectForecastLine;
                ProjectForecastLine."Project No." := ProjectForecastHeader."Project No.";
                ProjectForecastLine."Forecast Date" := ProjectForecastHeader."Forecast Date";
                ProjectForecastLine."Cost Type" := ProjectForecastLine."Cost Type"::Revenue;
                CASE Project."Forecast Level" OF
                  Project."Forecast Level"::"Element - Cost Object":
                    BEGIN
                      ProjectForecastLine."Cost Object" := ProjectInstallment."Cost Object";
                      ProjectForecastLine.Element := ProjectInstallment.Element;
                    END;
                  Project."Forecast Level"::"Element - Cost Type":
                    ProjectForecastLine.Element := ProjectInstallment.Element;
                  Project."Forecast Level"::"Cost Object":
                    ProjectForecastLine."Cost Object" := ProjectInstallment."Cost Object";
                  Project."Forecast Level"::"Cost Type":;
                END;
                //**4PS.sn BI042 KD 19-08-16
                IF ProjectForecastHeader."Forecast by Currency" THEN BEGIN
                  ProjectForecastLine."Currency Code" := ProjectInstallment."Currency Code";
                  CalcInstallmentInvoicedPriceFCY(ProjectInstallment);
                END ELSE
                //**4PS.en BI042 KD 19-08-16
                //ProjectInstallment.CALCFIELDS("Invoiced Price (LCY)");  //*C005725.o
                  CalcInstallmentInvoicedPrice(ProjectInstallment);  //*C005725.n
                IF NOT ProjectForecastLine.GET(
                  ProjectForecastHeader."Project No.",
                  ProjectForecastHeader."Forecast Date",
                  ProjectForecastLine."Cost Type"::Revenue,
                  ProjectForecastLine.Element,
                  ProjectForecastLine."Cost Object",
                  ProjectForecastLine."Currency Code") //**4PS.n BI042 KD 19-08-16
                THEN BEGIN
                  //**4PS.sn BI042 KD 19-08-16
                  IF ProjectForecastHeader."Forecast by Currency" THEN
                    ProjectForecastLine.VALIDATE(Amount,
                      ProjectInstallment."Installment Amount" - ProjectInstallment."Invoiced Price")
                  ELSE
                  //**4PS.en BI042 KD 19-08-16
                    ProjectForecastLine.VALIDATE(Amount,
                      ProjectInstallment."Installment Amount (LCY)" - ProjectInstallment."Invoiced Price (LCY)");
                  //ProjectForecastLine.Invoiced := ProjectInstallment."Invoiced Price (LCY)"; //*C005733.o
                  IF ProjectForecastLine.Amount <> 0 THEN
                    ProjectForecastLine.INSERT(TRUE);
                END ELSE BEGIN
                  //**4PS.sn BI042 KD 19-08-16
                  IF ProjectForecastHeader."Forecast by Currency" THEN
                    ProjectForecastLine.VALIDATE(Amount,
                      ProjectForecastLine.Amount + ProjectInstallment."Installment Amount" -
                      ProjectInstallment."Invoiced Price")
                  ELSE
                  //**4PS.en BI042 KD 19-08-16
                    ProjectForecastLine.VALIDATE(Amount,
                      ProjectForecastLine.Amount + ProjectInstallment."Installment Amount (LCY)" -
                      ProjectInstallment."Invoiced Price (LCY)");
                  //ProjectForecastLine.Invoiced := ProjectForecastLine.Invoiced+ProjectInstallment."Invoiced Price (LCY)";//*C005733.o
                  ProjectForecastLine.MODIFY(TRUE);
                END;

                //**4PS.sn BI042 KD 19-08-16
                IF ProjectForecastHeader."Forecast by Currency" THEN
                  AmountToApplyInPeriod := ProjectInstallment."Installment Amount" - ProjectInstallment."Invoiced Price"
                ELSE
                //**4PS.en BI042 KD 19-08-16
                  AmountToApplyInPeriod := ProjectInstallment."Installment Amount (LCY)" - ProjectInstallment."Invoiced Price (LCY)";
                StartDate := ProjectInstallment."Expected Invoice Date";
                IF StartDate = 0D THEN
                  StartDate := ProjectInstallment."Due Date Actual";
                IF StartDate = 0D THEN
                  StartDate := ProjectInstallment."Due Date Base";
                IF StartDate <> 0D THEN BEGIN //Call 25931
                  //IF StartDate < ProjectForecastHeader."Forecast Date" THEN //*C005733.o
                  //  StartDate := ProjectForecastHeader."Forecast Date";     //*C005733.o
                  IF StartDate <= ProjectForecastHeader."Forecast Date" THEN  //*C005733.n
                    StartDate := ProjectForecastHeader."Forecast Date" + 1;   //*C005733.n
                  CreateForecastInPeriod(
                    ProjectForecastLine, StartDate, AmountToApplyInPeriod);
                END;
              END;  //*C005931.n
            UNTIL ProjectInstallment.NEXT = 0;
        UNTIL SubProject.NEXT = 0;
    END;

    PROCEDURE SkipInstallment@1100526202(ProjectInstallment@1100526200 : Record 11012018) : Boolean;
    VAR
      ExtensionContract@1100526201 : Record 11012004;
      Option@1100526202 : Record 11012502;
    BEGIN
      //*C005931
      IF ProjectInstallment."Extension Contract" <> '' THEN BEGIN
        IF ExtensionContract.GET(ProjectInstallment."Project No.", ProjectInstallment."Extension Contract") THEN
          IF ExtensionContract."Version Date" > ProjectForecastHeader."Forecast Date" THEN
            EXIT(TRUE);
      END;
      IF (ProjectInstallment."Plot No." <> '') AND (ProjectInstallment.Option <> '') THEN BEGIN
        ProjectInstallment.CALCFIELDS("House Model");
        IF Option.GET(
          ProjectInstallment."Project No.", ProjectInstallment."Plot No.", ProjectInstallment."House Model",
          ProjectInstallment."Main Group", ProjectInstallment.Group, ProjectInstallment."Sub Group", ProjectInstallment.Option)
        THEN
          IF Option."Version Date" > ProjectForecastHeader."Forecast Date" THEN
            EXIT(TRUE);
      END;
      IF ProjectInstallment."Advance Payment" THEN
        EXIT(TRUE);
    END;

    PROCEDURE CalcInstallmentInvoicedPrice@1100526203(VAR ProjectInstallment@1100526200 : Record 11012018);
    VAR
      ProjLedgEntry@1100526201 : Record 11072005;
    BEGIN
      //*C005725
      ProjectInstallment.CALCFIELDS("Invoiced Price (LCY)");

      //* Minus invoiced after forecast date, use same filters as in flowfield but extra filter on posting date
      ProjLedgEntry.SETCURRENTKEY("Job No.", "Posting Date");
      ProjLedgEntry.SETRANGE("Job No.", ProjectInstallment."Project No.");
      ProjLedgEntry.SETRANGE("Project Invoice", TRUE);
      ProjLedgEntry.SETRANGE("Installment Invoice", TRUE);
      ProjLedgEntry.SETRANGE(Principal, ProjectInstallment.Principal);
      ProjLedgEntry.SETRANGE("Installment No.", ProjectInstallment."Installment No.");
      ProjLedgEntry.SETRANGE("Plot No.", ProjectInstallment."Plot No.");
      ProjLedgEntry.SETFILTER("Posting Date", '>%1', ProjectForecastHeader."Forecast Date");
      IF ProjLedgEntry.FINDSET THEN BEGIN
        REPEAT
          //Note: Total Price neg. in Proj. Ledger Entry so use plus (+) then it will be minus (-)
          ProjectInstallment."Invoiced Price (LCY)" += ProjLedgEntry."Total Price (LCY)";
        UNTIL ProjLedgEntry.NEXT =0;
      END;
    END;

    PROCEDURE CalcInstallmentInvoicedPriceFCY@1100529402(VAR ProjectInstallment@1100526200 : Record 11012018);
    VAR
      ProjLedgEntry@1100526201 : Record 11072005;
    BEGIN
      //**4PS.sn BI042 KD 19-08-16
      ProjectInstallment.CALCFIELDS("Invoiced Price");

      //* Minus invoiced after forecast date, use same filters as in flowfield but extra filter on posting date
      ProjLedgEntry.SETCURRENTKEY("Job No.", "Posting Date");
      ProjLedgEntry.SETRANGE("Job No.", ProjectInstallment."Project No.");
      ProjLedgEntry.SETRANGE("Project Invoice", TRUE);
      ProjLedgEntry.SETRANGE("Installment Invoice", TRUE);
      ProjLedgEntry.SETRANGE(Principal, ProjectInstallment.Principal);
      ProjLedgEntry.SETRANGE("Installment No.", ProjectInstallment."Installment No.");
      ProjLedgEntry.SETRANGE("Plot No.", ProjectInstallment."Plot No.");
      ProjLedgEntry.SETFILTER("Posting Date", '>%1', ProjectForecastHeader."Forecast Date");
      ProjLedgEntry.SETRANGE("Currency Code",ProjectInstallment."Currency Code");
      IF ProjLedgEntry.FINDSET THEN BEGIN
        REPEAT
          //Note: Total Price neg. in Proj. Ledger Entry so use plus (+) then it will be minus (-)
          ProjectInstallment."Invoiced Price" += ProjLedgEntry."Total Price";
        UNTIL ProjLedgEntry.NEXT =0;
      END;
      //**4PS.en BI042 KD 19-08-16
    END;

    PROCEDURE CreateForecastTotals@1100525018();
    VAR
      ProjectForecastTotalLine@1100525000 : Record 11020633;
      ProjectForecastLineLoc@1100529402 : Record 11020631;
    BEGIN
      //**4PS.sn BI042 KD 01-09-16
      IF ProjectForecastHeader."Forecast by Currency" THEN BEGIN
        DeleteEmptyLines;
        ProjectForecastLineLoc.SETRANGE("Project No.",ProjectForecastHeader."Project No.");
        ProjectForecastLineLoc.SETRANGE("Forecast Date",ProjectForecastHeader."Forecast Date");
      END;
      //**4PS.en BI042 KD 01-09-16

      ProjectForecastTotalLine."Project No." := ProjectForecastHeader."Project No.";
      ProjectForecastTotalLine."Forecast Date" := ProjectForecastHeader."Forecast Date";
      FOR ProjectForecastTotalLine."Line No." := 1 TO 7 DO BEGIN
        ProjectForecastTotalLine."Currency Code" := ''; //**4PS.n BI042 KD 19-08-16
        IF ProjectForecastTotalLine."Line No." <= 5 THEN BEGIN
          ProjectForecastTotalLine."Cost Type" := ProjectForecastTotalLine."Line No." - 1;
          ProjectForecastTotalLine."Cost Type Filter" := STRSUBSTNO('%1', ProjectForecastTotalLine."Line No." - 1);
        END ELSE
          IF ProjectForecastTotalLine."Line No." = 6 THEN BEGIN
            ProjectForecastTotalLine."Cost Type" := 6;
            ProjectForecastTotalLine."Cost Type Filter" := '0..4';
          END ELSE BEGIN
            ProjectForecastTotalLine."Cost Type" := 5;
            ProjectForecastTotalLine."Cost Type Filter" := '5';
          END;
        IF NOT ProjectForecastHeader."Forecast by Currency" THEN BEGIN //**4PS.n BI042 KD 19-08-16
          IF ProjectForecastTotalLine.INSERT(TRUE) THEN;
        //**4PS.sn BI042 KD 19-08-16
        END ELSE BEGIN
          ProjectForecastLineLoc.SETFILTER("Cost Type",ProjectForecastTotalLine."Cost Type Filter");
          ProjectForecastLineLoc.SETRANGE("Currency Code",'');
          IF ProjectForecastLineLoc.ISEMPTY THEN BEGIN
            ProjectForecastLineLoc.SETFILTER("Currency Code",'<>''''');
            IF ProjectForecastLineLoc.ISEMPTY THEN
              IF ProjectForecastTotalLine.INSERT(TRUE) THEN;
          END ELSE
            IF ProjectForecastTotalLine.INSERT(TRUE) THEN;

          IF CurrencyBuff.FINDSET THEN
            REPEAT
              ProjectForecastLineLoc.SETRANGE("Currency Code",CurrencyBuff.Code);
              IF NOT ProjectForecastLineLoc.ISEMPTY THEN BEGIN
                ProjectForecastTotalLine."Currency Code" := CurrencyBuff.Code;
                IF ProjectForecastTotalLine.INSERT(TRUE) THEN;
              END;
            UNTIL CurrencyBuff.NEXT = 0;
        END;
        //**4PS.en BI042 KD 19-08-16
      END;
    END;

    LOCAL PROCEDURE CreateForecastInPeriodFromPurc@1100525001(ProjectForecastLine@1100525000 : Record 11020631);
    VAR
      PurchLine@1100525001 : Record 39;
      PurchOrderControlLine@1100525003 : Record 11020221;
      ProjectForecastSurchLine@1210190000 : Record 11020631;
      BlanketScheme@1100529600 : Record 11012066;
      Currency@1100529602 : Record 4;
      ExpectedReceiptDate@1100525007 : Date;
      OutstandingAmount@1100525004 : Decimal;
      ReceivedNotInvoicedAmount@1100525005 : Decimal;
      OutstandingAmountSurch@1100528501 : Decimal;
      ReceivedNotInvoicedAmountSurch@1100528500 : Decimal;
      InvoicedAmount@1100529605 : Decimal;
      BlanketSchemeReceivedAmount@1100529601 : Decimal;
      TotAmtLoc@1100529604 : Decimal;
      UnitPrice@1100529603 : Decimal;
    BEGIN
      IF ProjectForecastLine."Cost Type" = ProjectForecastLine."Cost Type"::Labor THEN
        EXIT;

      PurchLine.SETRANGE("Document Type", PurchLine."Document Type"::Order);
      PurchLine.SETRANGE("Main Project No.", Project."Main Project");
      IF Project."No." <> Project."Main Project" THEN
        PurchLine.SETRANGE("Job No.", ProjectForecastLine."Project No.");
      //**4PS.sn BI042 KD 25-08-16
      IF ProjectForecastHeader."Forecast by Currency" THEN
        PurchLine.SETRANGE("Currency Code",ProjectForecastLine."Currency Code");
      //**4PS.en BI042 KD 25-08-16

      CASE Project."Forecast Level" OF
        Project."Forecast Level"::"Element - Cost Object":
          BEGIN
            PurchLine.SETCURRENTKEY(
              "Document Type","Main Project No.","Job No.",Element,"Shortcut Dimension 2 Code");
            PurchLine.SETRANGE(Element, ProjectForecastLine.Element);
            PurchLine.SETRANGE("Shortcut Dimension 2 Code", ProjectForecastLine."Cost Object");
          END;
        Project."Forecast Level"::"Element - Cost Type":
          BEGIN
            PurchLine.SETCURRENTKEY(
              "Document Type","Main Project No.","Job No.",Element,"Cost Type");
            PurchLine.SETRANGE(Element, ProjectForecastLine.Element);
            PurchLine.SETRANGE("Cost Type", ProjectForecastLine."Cost Type" + 1);
          END;
        Project."Forecast Level"::"Cost Object":
          BEGIN
            PurchLine.SETCURRENTKEY(
              "Document Type","Main Project No.","Job No.","Cost Type", "Shortcut Dimension 2 Code");
            PurchLine.SETRANGE("Shortcut Dimension 2 Code", ProjectForecastLine."Cost Object");
          END;
        Project."Forecast Level"::"Cost Type":
          BEGIN
            PurchLine.SETCURRENTKEY(
              "Document Type","Main Project No.","Job No.","Cost Type");
            PurchLine.SETRANGE("Cost Type", ProjectForecastLine."Cost Type" + 1);
          END;
      END;
      PurchLine.SETRANGE("Order Date", 0D, ProjectForecastLine."Forecast Date"); //C003388
      PurchLine.SETAUTOCALCFIELDS("Purchase Order Type");
      Currency.InitRoundingPrecision;

      IF PurchLine.FINDSET THEN
        REPEAT
          //C003388.sn
          OutstandingAmount := 0;
          ReceivedNotInvoicedAmount := 0;
          OutstandingAmountSurch := 0;
          ReceivedNotInvoicedAmountSurch := 0;
          //C003388.en
          InvoicedAmount := 0;

          PurchOrderControlLine.SETRANGE("Order No.", PurchLine."Document No.");
          PurchOrderControlLine.SETRANGE("Order Line No.", PurchLine."Line No.");
          PurchOrderControlLine.SETRANGE(Date, 0D, ProjectForecastLine."Forecast Date"); //C003388
          IF PurchOrderControlLine.FINDSET THEN
            REPEAT
              OutstandingAmount += PurchOrderControlLine."Outstanding Amount";
              ReceivedNotInvoicedAmount += PurchOrderControlLine."Amt. Rcd. Not Invoiced";
              OutstandingAmountSurch += PurchOrderControlLine."Overhead Surcharge Soft";
              ReceivedNotInvoicedAmountSurch += PurchOrderControlLine."Overhead Surcharge Firm";
              IF PurchOrderControlLine."Line Type" = PurchOrderControlLine."Line Type"::Invoice THEN
                InvoicedAmount -= PurchOrderControlLine."Amt. Rcd. Not Invoiced";
            UNTIL PurchOrderControlLine.NEXT = 0;

          IF (PurchLine."Purchase Order Type" = PurchLine."Purchase Order Type"::"Blanket Order") AND
             ((OutstandingAmount <> 0) OR (ReceivedNotInvoicedAmount <> 0))
          THEN BEGIN
            BlanketScheme.SETRANGE("Document No.", PurchLine."Document No.");
            BlanketScheme.SETRANGE("Document Line No.", PurchLine."Line No.");
            IF NOT BlanketScheme.ISEMPTY THEN BEGIN
              IF IncludeVATAmount THEN
                UnitPrice := PurchLine."Amount (LCY)" * (1 + PurchLine."VAT %" / 100)
              ELSE
                UnitPrice := PurchLine."Amount (LCY)";
              IF PurchLine."Quantity (Base)" <> 0 THEN
                UnitPrice := UnitPrice / PurchLine."Quantity (Base)";

              BlanketScheme.SETRANGE("Receipts Created", TRUE);
              BlanketScheme.SETRANGE("Blanket Date", 0D, ProjectForecastLine."Forecast Date");
              BlanketScheme.CALCSUMS(Quantity);
              BlanketSchemeReceivedAmount := ROUND(BlanketScheme.Quantity * UnitPrice, Currency."Amount Rounding Precision");
              IF ReceivedNotInvoicedAmount >= BlanketSchemeReceivedAmount THEN
                ReceivedNotInvoicedAmount -= BlanketSchemeReceivedAmount
              ELSE BEGIN
                BlanketSchemeReceivedAmount := ReceivedNotInvoicedAmount;
                ReceivedNotInvoicedAmount := 0;
              END;

              BlanketScheme.SETRANGE("Receipts Created");
              BlanketScheme.SETRANGE("Blanket Date");
              BlanketScheme.FINDSET;
              REPEAT
                TotAmtLoc := ROUND(BlanketScheme.Quantity * UnitPrice, Currency."Amount Rounding Precision");
                IF (TotAmtLoc <> 0) AND (InvoicedAmount <> 0) THEN
                  IF InvoicedAmount > TotAmtLoc THEN BEGIN
                    InvoicedAmount -= TotAmtLoc;
                    TotAmtLoc := 0;
                  END ELSE BEGIN
                    TotAmtLoc -= InvoicedAmount;
                    InvoicedAmount := 0;
                  END;

                IF TotAmtLoc <> 0 THEN BEGIN
                  IF BlanketScheme."Blanket Date" <= ProjectForecastLine."Forecast Date" THEN
                    ExpectedReceiptDate := CALCDATE('<1D>', ProjectForecastLine."Forecast Date")
                  ELSE
                    ExpectedReceiptDate := BlanketScheme."Blanket Date";

                  IF BlanketScheme."Receipts Created" AND (BlanketScheme."Blanket Date" <= ProjectForecastLine."Forecast Date") THEN
                    InsertForecastInPeriodAmoutWithAmountCheck(BlanketSchemeReceivedAmount, TotAmtLoc,
                      ProjectForecastLine, PurchLine."Document No.", ExpectedReceiptDate,
                      ProjForecastInPeriod.Source::"Received Not Invoiced");

                  InsertForecastInPeriodAmoutWithAmountCheck(ReceivedNotInvoicedAmount, TotAmtLoc,
                    ProjectForecastLine, PurchLine."Document No.", ExpectedReceiptDate,
                    ProjForecastInPeriod.Source::"Received Not Invoiced");

                  InsertForecastInPeriodAmoutWithAmountCheck(OutstandingAmount, TotAmtLoc,
                    ProjectForecastLine, PurchLine."Document No.", ExpectedReceiptDate,
                    ProjForecastInPeriod.Source::"Outstanding Purchase");
                END;
              UNTIL (BlanketScheme.NEXT = 0) OR
                    ((OutstandingAmount = 0) AND (ReceivedNotInvoicedAmount = 0) AND (BlanketSchemeReceivedAmount = 0));
            END;
          END;

          IF (OutstandingAmount <> 0) THEN BEGIN
            IF PurchLine."Expected Receipt Date" <= ProjectForecastLine."Forecast Date" THEN
              ExpectedReceiptDate := CALCDATE('<1D>', ProjectForecastLine."Forecast Date")
            ELSE
              ExpectedReceiptDate := PurchLine."Expected Receipt Date";

            InsertForecastInPeriod(
              ProjectForecastLine, PurchLine."Document No.", ExpectedReceiptDate, 0, OutstandingAmount,
              ProjForecastInPeriod.Source::"Outstanding Purchase");
          END;
          IF (ReceivedNotInvoicedAmount <> 0) THEN BEGIN
            ExpectedReceiptDate := CALCDATE('<1D>', ProjectForecastLine."Forecast Date");

            InsertForecastInPeriod(
              ProjectForecastLine, PurchLine."Document No.", ExpectedReceiptDate, 0, ReceivedNotInvoicedAmount,
              ProjForecastInPeriod.Source::"Received Not Invoiced");
          END;

          //Handle Surcharges
          IF (OutstandingAmountSurch <> 0) OR (ReceivedNotInvoicedAmountSurch <> 0) THEN BEGIN
            IF PurchOrderControlLine.FINDSET THEN
              REPEAT
                ProjectForecastSurchLine."Project No." := ProjectForecastLine."Project No.";
                ProjectForecastSurchLine."Forecast Date" := ProjectForecastLine."Forecast Date";
                CASE Project."Forecast Level" OF
                  Project."Forecast Level"::"Element - Cost Object":
                    BEGIN
                      ProjectForecastSurchLine.Element := PurchOrderControlLine.Element;
                      ProjectForecastSurchLine."Cost Object" := PurchOrderControlLine."Shortcut Dimension 2 Code";
                    END;
                  Project."Forecast Level"::"Element - Cost Type":
                    BEGIN
                      ProjectForecastSurchLine.Element := PurchOrderControlLine.Element;
                      ProjectForecastSurchLine."Cost Object" := '';
                    END;
                  Project."Forecast Level"::"Cost Object":
                    BEGIN
                      ProjectForecastSurchLine.Element := '';
                      ProjectForecastSurchLine."Cost Object" := PurchOrderControlLine."Shortcut Dimension 2 Code";
                    END;
                  Project."Forecast Level"::"Cost Type":
                    BEGIN
                      ProjectForecastSurchLine.Element := '';
                      ProjectForecastSurchLine."Cost Object" := '';
                    END;
                END;
                ProjectForecastSurchLine."Cost Type" := PurchOrderControlLine."Cost Type" - 1;

                IF (PurchOrderControlLine."Overhead Surcharge Soft" <> 0) THEN BEGIN
                  IF PurchLine."Expected Receipt Date" <= ProjectForecastSurchLine."Forecast Date" THEN
                    ExpectedReceiptDate := CALCDATE('<1D>', ProjectForecastSurchLine."Forecast Date")
                  ELSE
                    ExpectedReceiptDate := PurchLine."Expected Receipt Date";

                  InsertForecastInPeriod(
                    ProjectForecastSurchLine, PurchLine."Document No.",
                    ExpectedReceiptDate, 0, PurchOrderControlLine."Overhead Surcharge Soft",
                    ProjForecastInPeriod.Source::"Outstanding Purchase");

                END;
                IF (PurchOrderControlLine."Overhead Surcharge Firm" <> 0) THEN BEGIN
                  ExpectedReceiptDate := CALCDATE('<1D>', ProjectForecastSurchLine."Forecast Date");

                  InsertForecastInPeriod(
                    ProjectForecastSurchLine, PurchLine."Document No.",
                    ExpectedReceiptDate, 0, PurchOrderControlLine."Overhead Surcharge Firm",
                    ProjForecastInPeriod.Source::"Received Not Invoiced");

                END;

              UNTIL PurchOrderControlLine.NEXT = 0;
          END;
          //
        UNTIL PurchLine.NEXT = 0;
    END;

    LOCAL PROCEDURE CreateForecastInPeriodFromHrs@1210190000(ProjectForecastLine@1100525000 : Record 11020631);
    VAR
      HourAccountingLine@1100525001 : Record 11012039;
      HourAccountingSurcharge@1100528500 : Record 11020308;
      ProjectForecastSurchLine@1100528501 : Record 11020631;
      PostingDate@1100528502 : Date;
    BEGIN
      IF ProjectForecastLine."Cost Type" <> ProjectForecastLine."Cost Type"::Labor THEN
        EXIT;

      HourAccountingLine.SETRANGE("Main Project No.", Project."Main Project");
      IF Project."No." <> Project."Main Project" THEN
        HourAccountingLine.SETRANGE("Project No.", ProjectForecastLine."Project No.");
      //HourAccountingLine.SETFILTER("Posting Date", '>%1', ProjectForecastLine."Forecast Date"); //C003394

      //**4PS.sn BI042 KD 19-08-16
      IF ProjectForecastHeader."Forecast by Currency" THEN
        HourAccountingLine.SETRANGE("Currency Code",ProjectForecastLine."Currency Code");
      //**4PS.en BI042 KD 19-08-16

      CASE Project."Forecast Level" OF
        Project."Forecast Level"::"Element - Cost Object":
          BEGIN
            HourAccountingLine.SETCURRENTKEY(
              "Main Project No.","Project No.",Element);
            HourAccountingLine.SETRANGE(Element, ProjectForecastLine.Element);
            HourAccountingLine.SETRANGE("Cost Object", ProjectForecastLine."Cost Object");
          END;
        Project."Forecast Level"::"Element - Cost Type":
          BEGIN
            HourAccountingLine.SETCURRENTKEY(
              "Main Project No.","Project No.",Element);
            HourAccountingLine.SETRANGE(Element, ProjectForecastLine.Element);
            HourAccountingLine.SETRANGE("Cost Type", ProjectForecastLine."Cost Type");
          END;
        Project."Forecast Level"::"Cost Object":
          BEGIN
            HourAccountingLine.SETCURRENTKEY(
              "Main Project No.","Cost Type", "Cost Object");
            HourAccountingLine.SETRANGE("Cost Object", ProjectForecastLine."Cost Object");
          END;
        Project."Forecast Level"::"Cost Type":
          BEGIN
            HourAccountingLine.SETCURRENTKEY(
              "Main Project No.","Cost Type");
            HourAccountingLine.SETRANGE("Cost Type", ProjectForecastLine."Cost Type");
          END;
      END;
      HourAccountingLine.SETRANGE("Posting Date", 0D, ProjectForecastLine."Forecast Date");  //*C003388.n

      IF HourAccountingLine.FINDSET THEN
        REPEAT
          //C003394 Posting Date in the past is moved to tomorrow
          IF HourAccountingLine."Posting Date" <= ProjectForecastLine."Forecast Date" THEN
            PostingDate := CALCDATE('<1D>', ProjectForecastLine."Forecast Date")
          ELSE
            PostingDate := HourAccountingLine."Posting Date";

          InsertForecastInPeriod(
            ProjectForecastLine, HourAccountingLine."Document No.",
            PostingDate, HourAccountingLine."Total Line", HourAccountingLine."Amount (LCY)",
            ProjForecastInPeriod.Source::"Outstanding Hours");
          //call C003387.sn
          HourAccountingSurcharge.SETRANGE(Year, HourAccountingLine.Year);
          HourAccountingSurcharge.SETRANGE(Week, HourAccountingLine.Week);
          HourAccountingSurcharge.SETRANGE("Employee No.", HourAccountingLine."Employee No.");
          HourAccountingSurcharge.SETRANGE("Hour Line No.", HourAccountingLine."Line No.");
          IF HourAccountingSurcharge.FINDSET THEN
            REPEAT
              ProjectForecastSurchLine := ProjectForecastLine;
              ProjectForecastSurchLine."Cost Type" := HourAccountingSurcharge."Cost Type";
              ProjectForecastSurchLine.Element := HourAccountingSurcharge.Element;
              ProjectForecastSurchLine."Cost Object" := HourAccountingSurcharge."Cost Object";
              //**4PS.sn BI042 KD 19-08-16
              IF ProjectForecastHeader."Forecast by Currency" THEN
                ProjectForecastSurchLine."Currency Code" := HourAccountingLine."Currency Code";
              //**4PS.en BI042 KD 19-08-16
              InsertForecastInPeriod(
                ProjectForecastSurchLine, HourAccountingLine."Document No.",
                PostingDate, 0,
                HourAccountingSurcharge."Overhead Surcharge Project",
                ProjForecastInPeriod.Source::"Outstanding Hours");
            UNTIL HourAccountingSurcharge.NEXT = 0;
          //call C003387.en
        UNTIL HourAccountingLine.NEXT = 0;
    END;

    LOCAL PROCEDURE CreateForecastInPeriodFromInv@1100528502(ProjectForecastLine@1100525000 : Record 11020631);
    VAR
      ItemJournalLine@1100525001 : Record 83;
      ItemJournalSurcharge@1100528500 : Record 11020585;
      ProjectForecastSurchLine@1100528501 : Record 11020631;
      DeliveryDate@1100528502 : Date;
    BEGIN
      //C003394
      IF ProjectForecastLine."Cost Type" = ProjectForecastLine."Cost Type"::Labor THEN
        EXIT;

      ItemJournalLine.SETCURRENTKEY("Main Project No.","Job No.");
      ItemJournalLine.SETRANGE("Main Project No.", Project."Main Project");
      IF Project."No." <> Project."Main Project" THEN
        ItemJournalLine.SETRANGE("Job No.", ProjectForecastLine."Project No.");
      ItemJournalLine.SETRANGE("Posting Date", 0D, ProjectForecastLine."Forecast Date");
      CASE Project."Forecast Level" OF
        Project."Forecast Level"::"Element - Cost Object":
          BEGIN
            ItemJournalLine.SETRANGE(Element, ProjectForecastLine.Element);
            ItemJournalLine.SETRANGE("Shortcut Dimension 2 Code", ProjectForecastLine."Cost Object");
          END;
        Project."Forecast Level"::"Element - Cost Type":
          BEGIN
            ItemJournalLine.SETRANGE(Element, ProjectForecastLine.Element);
            ItemJournalLine.SETRANGE("Cost Type", ProjectForecastLine."Cost Type" + 1);
          END;
        Project."Forecast Level"::"Cost Object":
          ItemJournalLine.SETRANGE("Shortcut Dimension 2 Code", ProjectForecastLine."Cost Object");
        Project."Forecast Level"::"Cost Type":
          ItemJournalLine.SETRANGE("Cost Type", ProjectForecastLine."Cost Type" + 1);
      END;

      IF ItemJournalLine.FINDSET THEN
        REPEAT
          IF ItemJournalLine."Delivery Date" <= ProjectForecastLine."Forecast Date" THEN
            DeliveryDate := CALCDATE('<1D>', ProjectForecastLine."Forecast Date")
          ELSE
            DeliveryDate := ItemJournalLine."Delivery Date";

          InsertForecastInPeriod(
            ProjectForecastLine, ItemJournalLine."Document No.",
            DeliveryDate, 0, ItemJournalLine.Amount,
            ProjForecastInPeriod.Source::"Outstanding Inventory");

          ItemJournalSurcharge.SETRANGE("Journal Template Name", ItemJournalLine."Journal Template Name");
          ItemJournalSurcharge.SETRANGE("Journal Batch Name", ItemJournalLine."Journal Batch Name");
          ItemJournalSurcharge.SETRANGE("Journal Line No.", ItemJournalLine."Line No.");
          IF ItemJournalSurcharge.FINDSET THEN
            REPEAT
              ProjectForecastSurchLine := ProjectForecastLine;
              ProjectForecastSurchLine."Cost Type" := ItemJournalSurcharge."Cost Type" - 1;
              ProjectForecastSurchLine.Element := ItemJournalSurcharge.Element;
              ProjectForecastSurchLine."Cost Object" := ItemJournalSurcharge."Shortcut Dimension 2 Code";
              InsertForecastInPeriod(
                ProjectForecastSurchLine, ItemJournalLine."Document No.",
                DeliveryDate, 0,
                ItemJournalSurcharge."Overhead Surcharge Project",
                ProjForecastInPeriod.Source::"Outstanding Inventory");
            UNTIL ItemJournalSurcharge.NEXT = 0;
        UNTIL ItemJournalLine.NEXT = 0;
    END;

    LOCAL PROCEDURE InsertForecastInPeriodAmoutWithAmountCheck@1100529604(VAR CheckAmount@1100529600 : Decimal;VAR TotalAmount@1100529601 : Decimal;ProjectForecastLine@1100525000 : Record 11020631;DocumentNo@1100525005 : Code[20];ExpectedDate@1100525001 : Date;Source@1100525002 : Option);
    VAR
      AmtLoc@1100529602 : Decimal;
    BEGIN
      //C039897
      IF (CheckAmount = 0) OR (TotalAmount = 0) THEN
        EXIT;

      IF CheckAmount >= TotalAmount THEN
        AmtLoc := TotalAmount
      ELSE
        AmtLoc := CheckAmount;
      CheckAmount -= AmtLoc;
      TotalAmount -= AmtLoc;

      InsertForecastInPeriod(ProjectForecastLine, DocumentNo, ExpectedDate, 0, AmtLoc, Source);
    END;

    LOCAL PROCEDURE InsertForecastInPeriod@1100525020(ProjectForecastLine@1100525000 : Record 11020631;DocumentNo@1100525005 : Code[20];ExpectedDate@1100525001 : Date;QuantityToInsert@1100525004 : Decimal;AmountToInsert@1210190000 : Decimal;Source@1100525002 : Option);
    VAR
      ProjectForecastInPeriod@1100525003 : Record 11020632;
    BEGIN
      //IF AmountToInsert = 0 THEN  //C005685.o
      //  EXIT;
      //C005685.sn
      IF (ProjectForecastLine."Cost Type" = ProjectForecastLine."Cost Type"::Labor) THEN BEGIN
        IF (AmountToInsert = 0) AND (QuantityToInsert = 0) THEN
          EXIT;
      END ELSE BEGIN
        IF AmountToInsert = 0 THEN
          EXIT;
      END;
      //C005685.en

      ProjectForecastInPeriod.SETRANGE("Project No.", ProjectForecastLine."Project No.");
      ProjectForecastInPeriod.SETRANGE("Forecast Date", ProjectForecastLine."Forecast Date");
      ProjectForecastInPeriod.SETRANGE("Cost Type", ProjectForecastLine."Cost Type");
      ProjectForecastInPeriod.SETRANGE(Element, ProjectForecastLine.Element);
      ProjectForecastInPeriod.SETRANGE("Cost Object", ProjectForecastLine."Cost Object");
      ProjectForecastInPeriod.SETRANGE("Currency Code", ProjectForecastLine."Currency Code"); //**4PS.n BI042 KD 19-08-16
      ProjectForecastInPeriod.SETRANGE(Date, ExpectedDate);
      ProjectForecastInPeriod.SETRANGE(Source, Source);
      ProjectForecastInPeriod.SETRANGE("Document No.", DocumentNo);
      IF NOT ProjectForecastInPeriod.FINDFIRST THEN BEGIN
        ProjectForecastInPeriod.INIT;
        ProjectForecastInPeriod."Project No." := ProjectForecastLine."Project No.";
        ProjectForecastInPeriod."Forecast Date" := ProjectForecastLine."Forecast Date";
        ProjectForecastInPeriod."Cost Type" := ProjectForecastLine."Cost Type";
        ProjectForecastInPeriod.Element := ProjectForecastLine.Element;
        ProjectForecastInPeriod."Cost Object" := ProjectForecastLine."Cost Object";
        ProjectForecastInPeriod."Currency Code" := ProjectForecastLine."Currency Code"; //**4PS.n BI042 KD 19-08-16
        ProjectForecastInPeriod.Date := ExpectedDate;
        ProjectForecastInPeriod."Line No." :=
          GetForecastInPeriodNewLineNo(ProjectForecastInPeriod);
        ProjectForecastInPeriod.Quantity := QuantityToInsert;
        ProjectForecastInPeriod.Amount := AmountToInsert;
        ProjectForecastInPeriod.Source := Source;
        ProjectForecastInPeriod."Document No." := DocumentNo;
        ProjectForecastInPeriod.INSERT(TRUE);
      END ELSE BEGIN
        ProjectForecastInPeriod.Quantity := ProjectForecastInPeriod.Quantity + QuantityToInsert;  //C005685.n
        ProjectForecastInPeriod.Amount := ProjectForecastInPeriod.Amount + AmountToInsert;
        ProjectForecastInPeriod.MODIFY(TRUE);
      END;
    END;

    PROCEDURE CreateForecastInPeriod@1100525003(ProjectForecastLine@1100525000 : Record 11020631;StartDate@1100525003 : Date;VAR Forecast@1100525001 : Decimal);
    VAR
      ProjectForecastInPeriod@1100525002 : Record 11020632;
      Currency@1100525005 : Record 4;
    BEGIN
      GetProjectSetup;
      IF NOT ProjectForecastLine.CalceForecastBasedOnQuantity THEN BEGIN
        Currency.InitRoundingPrecision;
        Forecast := ROUND(Forecast, Currency."Amount Rounding Precision");
      END;
      IF Forecast = 0 THEN
        EXIT;

      ProjectForecastInPeriod.INIT;
      ProjectForecastInPeriod."Project No." := ProjectForecastLine."Project No.";
      ProjectForecastInPeriod."Forecast Date" := ProjectForecastLine."Forecast Date";
      ProjectForecastInPeriod."Cost Type" := ProjectForecastLine."Cost Type";
      ProjectForecastInPeriod.Element := ProjectForecastLine.Element;
      ProjectForecastInPeriod.VALIDATE("Cost Object", ProjectForecastLine."Cost Object");
      ProjectForecastInPeriod."Currency Code" := ProjectForecastLine."Currency Code"; //**4PS.n BI042 KD 19-08-16
      ProjectForecastInPeriod.Date := StartDate;
      ProjectForecastInPeriod."Line No." := GetForecastInPeriodNewLineNo(ProjectForecastInPeriod);
      IF ProjectForecastLine."Cost Type" = ProjectForecastLine."Cost Type"::Labor THEN BEGIN
        ProjectForecastInPeriod.InitLaborRate;
        IF ProjectSetup."Forecast Labour in Amounts" THEN BEGIN
          ProjectForecastInPeriod.Amount := Forecast;
          IF ProjectForecastInPeriod.Rate <> 0 THEN
            ProjectForecastInPeriod.Quantity := ROUND(ProjectForecastInPeriod.Amount / ProjectForecastInPeriod.Rate, 0.00001);
        END ELSE
          ProjectForecastInPeriod.VALIDATE(Quantity, Forecast);
      END ELSE BEGIN
        ProjectForecastInPeriod.Amount := Forecast;
        //DP01426.sn
        ProjectForecastInPeriod.Price := ProjectForecastLine.Price;
        IF ProjectForecastInPeriod.Price <> 0 THEN
          ProjectForecastInPeriod.Quantity := ROUND(ProjectForecastInPeriod.Amount / ProjectForecastInPeriod.Price, 0.00001);
        //DP01426.en
      END;
      ProjectForecastInPeriod.Source := ProjectForecastInPeriod.Source::Forecast;

      ProjectForecastInPeriod.INSERT(TRUE);
    END;

    PROCEDURE GetForecastInPeriodNewLineNo@1100525019(ProjectForecastInPeriod@1100525000 : Record 11020632) NewLineNo : Integer;
    BEGIN
      ProjectForecastInPeriod.SETRANGE("Project No.", ProjectForecastInPeriod."Project No.");
      ProjectForecastInPeriod.SETRANGE("Forecast Date", ProjectForecastInPeriod."Forecast Date");
      ProjectForecastInPeriod.SETRANGE("Cost Type", ProjectForecastInPeriod."Cost Type");
      ProjectForecastInPeriod.SETRANGE(Element, ProjectForecastInPeriod.Element);
      ProjectForecastInPeriod.SETRANGE("Cost Object", ProjectForecastInPeriod."Cost Object");
      ProjectForecastInPeriod.SETRANGE("Currency Code", ProjectForecastInPeriod."Currency Code"); //**4PS.n BI042 KD 19-08-16
      ProjectForecastInPeriod.SETRANGE(Date, ProjectForecastInPeriod.Date);
      IF ProjectForecastInPeriod.FINDLAST THEN
        NewLineNo := ProjectForecastInPeriod."Line No.";
      NewLineNo := NewLineNo + 10000;
    END;

    PROCEDURE FillForecastWithAvailable@1100525012(ProjectForecastHeader@1100525000 : Record 11020630);
    VAR
      ProjectForecastLine@1100525003 : Record 11020631;
      AvailableQuan@1100525002 : Decimal;
      AvailableAmount@1100525001 : Decimal;
    BEGIN
      IF NOT CONFIRM(Text001, TRUE) THEN
        EXIT;

      GetProjectSetup;

      ProjectForecastLine.SETRANGE("Project No.", ProjectForecastHeader."Project No.");
      ProjectForecastLine.SETRANGE("Forecast Date", ProjectForecastHeader."Forecast Date");
      ProjectForecastLine.SETRANGE("Cost Type", ProjectForecastLine."Cost Type"::Labor, ProjectForecastLine."Cost Type"::Sundry);
      IF ProjectForecastLine.FINDSET(TRUE) THEN
        REPEAT
          IF ProjectForecastLine.CalceForecastBasedOnQuantity THEN BEGIN
            IF ProjectSetup."Calculate Available" = ProjectSetup."Calculate Available"::"Budget - Allowed Cost" THEN
              AvailableQuan := ProjectForecastLine."Budget Hours" - ProjectForecastLine."Allowed Hours"
            ELSE
              AvailableQuan := ProjectForecastLine."Budget Hours" - ProjectForecastLine."Total Hours";
            IF (AvailableQuan < 0) AND (ProjectSetup."Fill Forecast with Available" =
               ProjectSetup."Fill Forecast with Available"::"Forecast may not be Negative") THEN
              AvailableQuan := 0;
            ProjectForecastLine.VALIDATE(Quantity, AvailableQuan);
          END ELSE BEGIN
            IF ProjectSetup."Calculate Available" = ProjectSetup."Calculate Available"::"Budget - Allowed Cost" THEN
              AvailableAmount := ProjectForecastLine.Budget - ProjectForecastLine.Allowed - ProjectForecastLine."Open (Purchase)"
            ELSE
              AvailableAmount := ProjectForecastLine.Budget - ProjectForecastLine."Total Cost";
            IF (AvailableAmount < 0) AND (ProjectSetup."Fill Forecast with Available" =
               ProjectSetup."Fill Forecast with Available"::"Forecast may not be Negative") THEN
              AvailableAmount := 0;
            ProjectForecastLine.VALIDATE(Amount, AvailableAmount);
          END;
          ProjectForecastLine.MODIFY(TRUE);
        UNTIL ProjectForecastLine.NEXT = 0;
    END;

    PROCEDURE FillForecastWithAllowed@1100525013(ProjectForecastHeader@1100525000 : Record 11020630);
    VAR
      ProjectForecastLine@1100525001 : Record 11020631;
    BEGIN
      IF NOT CONFIRM(Text002, TRUE) THEN
        EXIT;

      ProjectForecastLine.SETRANGE("Project No.", ProjectForecastHeader."Project No.");
      ProjectForecastLine.SETRANGE("Forecast Date", ProjectForecastHeader."Forecast Date");
      ProjectForecastLine.SETRANGE("Cost Type", ProjectForecastLine."Cost Type"::Labor, ProjectForecastLine."Cost Type"::Sundry);
      IF ProjectForecastLine.FINDSET(TRUE) THEN
        REPEAT
          IF ProjectForecastLine.CalceForecastBasedOnQuantity THEN
            ProjectForecastLine.VALIDATE(Quantity, ProjectForecastLine."Allowed Hours")
          ELSE
            ProjectForecastLine.VALIDATE(Amount, ProjectForecastLine.Allowed);
          ProjectForecastLine.MODIFY(TRUE);
        UNTIL ProjectForecastLine.NEXT = 0;
    END;

    PROCEDURE FillForecastWithPrognosis@1100525014(ProjectForecastHeader@1100525000 : Record 11020630);
    VAR
      ProjectForecastLine@1100525001 : Record 11020631;
    BEGIN
      IF NOT CONFIRM(Text003, TRUE) THEN
        EXIT;

      ProjectForecastLine.SETRANGE("Project No.", ProjectForecastHeader."Project No.");
      ProjectForecastLine.SETRANGE("Forecast Date", ProjectForecastHeader."Forecast Date");
      ProjectForecastLine.SETRANGE("Currency Code", ''); //**4PS.n BI042 KD 26-08-16
      IF ProjectForecastLine.FINDSET(TRUE) THEN
        REPEAT
          IF ProjectForecastLine."Cost Type" = ProjectForecastLine."Cost Type"::Revenue THEN
            ProjectForecastLine.Prognosis := DeterminePrognosisRevenue(ProjectForecastLine);
          IF ProjectForecastLine."Cost Type" = ProjectForecastLine."Cost Type"::Labor THEN BEGIN
            ProjectForecastLine.ValidateRateCode(DeterminePrognosisRateCode(ProjectForecastLine), TRUE);
            ProjectForecastLine.ValidateRate(DeterminePrognosisRate(ProjectForecastLine), TRUE);
          END;
          IF ProjectForecastLine.CalceForecastBasedOnQuantity THEN
            ProjectForecastLine.VALIDATE(Quantity, ProjectForecastLine."Prognosis Hours")
          ELSE
            ProjectForecastLine.VALIDATE(Amount, ProjectForecastLine.Prognosis);
          ProjectForecastLine.MODIFY(TRUE);
        UNTIL ProjectForecastLine.NEXT = 0;
    END;

    PROCEDURE CopyPreviousForecast@1100525015(ProjectForecastHeader@1100525000 : Record 11020630;MinusActuals@1100409000 : Boolean);
    VAR
      ProjectForecastLine@1100525004 : Record 11020631;
      ProjectForecastLine2@1100525001 : Record 11020631;
      ProjectForecastInPeriod@1100525002 : Record 11020632;
      ProjectForecastInPeriod2@1100525003 : Record 11020632;
      ProjectForecastHeader2@1100529400 : Record 11020630;
      ProjectForecastHeaderTmp@1100529600 : TEMPORARY Record 11020630;
      DocumentLinkManagement@1100529601 : Codeunit 11012401;
      SourceRecRef@1100529602 : RecordRef;
      TargetRecRef@1100529603 : RecordRef;
      ProjectForecastHeader3@1100527450 : Record 11020630;
    BEGIN
      IF NOT CONFIRM(Text004, TRUE) THEN
        EXIT;

      ProjectForecastLine.SETRANGE("Project No.", ProjectForecastHeader."Project No.");
      ProjectForecastLine.SETRANGE("Forecast Date", ProjectForecastHeader."Forecast Date");
      IF ProjectForecastLine.FINDSET(TRUE) THEN BEGIN
        //Delete Forecast in Period
        ProjectForecastInPeriod.SETRANGE("Project No.", ProjectForecastLine."Project No.");
        ProjectForecastInPeriod.SETRANGE("Forecast Date", ProjectForecastLine."Forecast Date");
        ProjectForecastInPeriod.SETFILTER("Cost Type", '<%1', ProjectForecastInPeriod."Cost Type"::Revenue);
        ProjectForecastInPeriod.SETRANGE(Source, ProjectForecastInPeriod.Source::Forecast);
        ProjectForecastInPeriod.DELETEALL(TRUE);
        ProjectForecastHeader3.SETRANGE("Project No.", ProjectForecastHeader."Project No.");
        ProjectForecastHeader3.SETFILTER("Forecast Date", '<%1', ProjectForecastHeader."Forecast Date");
        IF NOT ProjectForecastHeader3.FINDSET THEN
          EXIT;
        REPEAT
          ProjectForecastLine2.SETRANGE("Project No.", ProjectForecastHeader3."Project No.");
          ProjectForecastLine2.SETRANGE("Forecast Date", ProjectForecastHeader3."Forecast Date");
          IF ProjectForecastLine2.FINDSET THEN
            REPEAT
              CLEAR(ProjectForecastLine);
              ProjectForecastLine := ProjectForecastLine2;
              ProjectForecastLine.SETRECFILTER;
              ProjectForecastLine.SETRANGE("Forecast Date", ProjectForecastHeader."Forecast Date");
              IF NOT ProjectForecastLine.FINDLAST THEN BEGIN
                ProjectForecastLine := ProjectForecastLine2;
                ProjectForecastLine."Forecast Date" := ProjectForecastHeader."Forecast Date";
                ProjectForecastLine.INSERT(TRUE);
              END;
            UNTIL ProjectForecastLine2.NEXT = 0;
        UNTIL ProjectForecastHeader3.NEXT = 0;
        CLEAR(ProjectForecastLine);
        ProjectForecastLine.SETRANGE("Project No.", ProjectForecastHeader."Project No.");
        ProjectForecastLine.SETRANGE("Forecast Date", ProjectForecastHeader."Forecast Date");
        ProjectForecastLine.FINDSET(TRUE);
        REPEAT
          ProjectForecastLine2 := ProjectForecastLine;
          ProjectForecastLine2.SETRECFILTER;
          ProjectForecastLine2.SETFILTER("Forecast Date", '<%1', ProjectForecastLine."Forecast Date");
          IF ProjectForecastLine2.FINDLAST THEN BEGIN
            //**4PS.sn BI042 KD 26-08-16
            IF (ProjectForecastHeader2."Forecast Date" <> ProjectForecastLine2."Forecast Date") THEN BEGIN
              ProjectForecastHeader2.GET(ProjectForecastLine2."Project No.",ProjectForecastLine2."Forecast Date");
              ProjectForecastHeader2.TESTFIELD("Forecast by Currency",ProjectForecastHeader."Forecast by Currency");
              IF NOT ProjectForecastHeaderTmp.GET(ProjectForecastHeader2."Project No.", ProjectForecastHeader2."Forecast Date") THEN BEGIN
                ProjectForecastHeaderTmp := ProjectForecastHeader2;
                ProjectForecastHeaderTmp.INSERT;
              END;
            END;
            //**4PS.en BI042 KD 26-08-16

            IF ProjectForecastLine."Cost Type" = ProjectForecastLine."Cost Type"::Labor THEN BEGIN
              ProjectForecastLine."Rate Code" := ProjectForecastLine2."Rate Code";
              ProjectForecastLine.Rate := ProjectForecastLine2.Rate;
            END;
            IF ProjectForecastLine.CalceForecastBasedOnQuantity THEN BEGIN
              //C003392.sn
              IF MinusActuals THEN BEGIN
                ProjectForecastLine.VALIDATE(Quantity,
                    ProjectForecastLine2.Quantity +
                    (ProjectForecastLine."Budget Hours" - ProjectForecastLine2."Budget Hours") -
                    (ProjectForecastLine."Total Hours" - ProjectForecastLine2."Total Hours"));
              END ELSE
              //C003392.en
                ProjectForecastLine.VALIDATE(Quantity, ProjectForecastLine2.Quantity);
            END ELSE BEGIN
              ProjectForecastLine.Quantity := ProjectForecastLine2.Quantity; //DP01426.n
              //C003392.sn
              IF MinusActuals THEN BEGIN
                ProjectForecastLine.VALIDATE(Amount,
                    ProjectForecastLine2.Amount +
                    (ProjectForecastLine.Budget - ProjectForecastLine2.Budget) -
                    (ProjectForecastLine."Total Cost" - ProjectForecastLine2."Total Cost"));
              END ELSE
              //C003392.en
                ProjectForecastLine.VALIDATE(Amount, ProjectForecastLine2.Amount);
            END;
            ProjectForecastLine."Best Case" := ProjectForecastLine2."Best Case";
            ProjectForecastLine."Worst Case" := ProjectForecastLine2."Worst Case";
            ProjectForecastLine."S-Curve" := ProjectForecastLine2."S-Curve";  //4PS.n UKR-C21180
            ProjectForecastLine.Comment := ProjectForecastLine2.Comment;
            ProjectForecastLine.MODIFY(TRUE);

            ProjectForecastInPeriod.SETRANGE("Project No.", ProjectForecastLine2."Project No.");
            ProjectForecastInPeriod.SETRANGE("Forecast Date", ProjectForecastLine2."Forecast Date");
            ProjectForecastInPeriod.SETRANGE("Cost Type", ProjectForecastLine2."Cost Type");
            ProjectForecastInPeriod.SETRANGE(Element, ProjectForecastLine2.Element);
            ProjectForecastInPeriod.SETRANGE("Cost Object", ProjectForecastLine2."Cost Object");
            ProjectForecastInPeriod.SETRANGE("Currency Code", ProjectForecastLine2."Currency Code"); //**4PS.n BI042 KD 26-08-16
            ProjectForecastInPeriod.SETFILTER(Date, '%1..', ProjectForecastLine."Forecast Date");
            ProjectForecastInPeriod.SETRANGE(Source, ProjectForecastInPeriod.Source::Forecast);
            IF ProjectForecastInPeriod.FINDSET THEN
              REPEAT
                ProjectForecastInPeriod2 := ProjectForecastInPeriod;
                ProjectForecastInPeriod2."Forecast Date" := ProjectForecastLine."Forecast Date";
                ProjectForecastInPeriod2."Line No." := 0;
                ProjectForecastInPeriod2.INSERT(TRUE);
              UNTIL ProjectForecastInPeriod.NEXT = 0;
          END;
        UNTIL ProjectForecastLine.NEXT = 0;
      END;

      IF ProjectForecastHeaderTmp.FINDLAST THEN BEGIN
        ProjectForecastHeader2.GET(ProjectForecastHeaderTmp."Project No.", ProjectForecastHeaderTmp."Forecast Date");
        SourceRecRef.GETTABLE(ProjectForecastHeader2);
        TargetRecRef.GETTABLE(ProjectForecastHeader);
        DocumentLinkManagement.CopyDocLinks(SourceRecRef, TargetRecRef);
      END;
    END;

    PROCEDURE DistributeLinear@1100525002(ProjectForecastHeader@1100525000 : Record 11020630;VAR ProjectForecastLine@1100525014 : Record 11020631;PeriodType@1100525001 : Integer);
    VAR
      ProjectForecastInPeriod@1100525013 : Record 11020632;
      ProjectForecastInPeriod2@1100525012 : Record 11020632;
      Date@1100525011 : Record 2000000007;
      AccountingPeriod@1100525015 : Record 50;
      AccountingPeriod2@1100525016 : Record 50;
      StartDate@1100525010 : Date;
      EndDate@1100525009 : Date;
      StartDatePeriod@1210190000 : Date;
      EndDatePeriod@1210190001 : Date;
      DeleteUntilDate@1100525008 : Date;
      DeleteFromDate@1100525007 : Date;
      NumberOfPeriods@1100525006 : Integer;
      ForecastToDistributeInPeriod@1100525005 : Decimal;
      ForecastDistributedInPeriod@1100525004 : Decimal;
      ForecastToApplyInPeriod@1100525003 : Decimal;
      TotalForecastDistributed@1100525002 : Decimal;
    BEGIN
      IF NOT CONFIRM(Text005, TRUE) THEN
        EXIT;
      GetProjectSetup;

      ProjectForecastLine.SETRANGE("Project No.", ProjectForecastHeader."Project No.");
      ProjectForecastLine.SETRANGE("Forecast Date", ProjectForecastHeader."Forecast Date");
      ProjectForecastLine.FILTERGROUP(9);
      ProjectForecastLine.SETRANGE("Cost Type", ProjectForecastLine."Cost Type"::Labor, ProjectForecastLine."Cost Type"::Sundry);
      ProjectForecastLine.FILTERGROUP(0);
      ProjectForecastLine.MARKEDONLY(TRUE);
      IF ProjectForecastLine.ISEMPTY THEN
        ProjectForecastLine.MARKEDONLY(FALSE);
      IF ProjectForecastLine.FINDSET THEN
        REPEAT
          DetermineStartAndEndDate(ProjectForecastLine, StartDate, EndDate);
          NumberOfPeriods := DetermineNumberOfPeriods(StartDate, EndDate, PeriodType);

          ProjectForecastInPeriod.RESET;
          ProjectForecastInPeriod.SETCURRENTKEY(
            "Project No.","Forecast Date","Cost Type",Element,"Cost Object",Source,Date);
          ProjectForecastInPeriod.SETRANGE("Project No.", ProjectForecastLine."Project No.");
          ProjectForecastInPeriod.SETRANGE("Forecast Date", ProjectForecastLine."Forecast Date");
          ProjectForecastInPeriod.SETRANGE("Cost Type", ProjectForecastLine."Cost Type");
          ProjectForecastInPeriod.SETRANGE(Element, ProjectForecastLine.Element);
          ProjectForecastInPeriod.SETRANGE("Cost Object", ProjectForecastLine."Cost Object");
          ProjectForecastInPeriod.SETRANGE(Source, ProjectForecastInPeriod.Source::Forecast);
          ProjectForecastInPeriod.SETRANGE("Currency Code", ProjectForecastLine."Currency Code"); //**4PS.n BI042 KD 26-08-16

          IF (PeriodType <> Date."Period Type"::Year + 1) THEN BEGIN  // <> Accounting Period
            Date.SETRANGE("Period Type", PeriodType);
            IF PeriodType = Date."Period Type"::Date THEN
              Date.SETRANGE("Period Start", StartDate, EndDate)
            ELSE BEGIN
              Date.SETFILTER("Period Start", '..%1', EndDate);
              Date.SETFILTER("Period End", '%1..', StartDate);
            END;
            IF Date.FINDSET THEN BEGIN
              IF Date."Period Start" < StartDate THEN
                DeleteUntilDate := CALCDATE('<-1D>', StartDate)
              ELSE
                DeleteUntilDate := CALCDATE('<-1D>', Date."Period Start");
              TotalForecastDistributed := 0;
              REPEAT
                IF Date."Period Start" < StartDate THEN
                  StartDatePeriod := StartDate
                ELSE
                  StartDatePeriod := Date."Period Start";
                IF Date."Period End" > EndDate THEN
                  EndDatePeriod := EndDate
                ELSE
                  EndDatePeriod := Date."Period End";

                ProjectForecastInPeriod.SETRANGE(Date, StartDatePeriod, EndDatePeriod);
                IF ProjectForecastLine.CalceForecastBasedOnQuantity THEN BEGIN
                  ProjectForecastInPeriod.CALCSUMS(Quantity);
                  ForecastDistributedInPeriod := ProjectForecastInPeriod.Quantity;
                  ForecastToDistributeInPeriod := (ProjectForecastLine.Quantity - TotalForecastDistributed)/NumberOfPeriods;
                END ELSE BEGIN
                  ProjectForecastInPeriod.CALCSUMS(Amount);
                  ForecastDistributedInPeriod := ProjectForecastInPeriod.Amount;
                  ForecastToDistributeInPeriod := (ProjectForecastLine.Amount - TotalForecastDistributed)/NumberOfPeriods;
                END;
                ForecastToApplyInPeriod := ForecastToDistributeInPeriod - ForecastDistributedInPeriod;
                CreateForecastInPeriod(
                  ProjectForecastLine, StartDatePeriod, ForecastToApplyInPeriod); //ForecastToApplyInPeriod is Rounded here
                ForecastToDistributeInPeriod := ForecastToApplyInPeriod + ForecastDistributedInPeriod;

                TotalForecastDistributed := TotalForecastDistributed + ForecastToDistributeInPeriod;
                NumberOfPeriods := NumberOfPeriods - 1;
                DeleteFromDate := CALCDATE('<+1D>', EndDatePeriod);
              UNTIL Date.NEXT = 0;
            END;
          END ELSE BEGIN
            AccountingPeriod.SETFILTER("Starting Date", '<=%1', StartDate);
            IF AccountingPeriod.FINDLAST THEN BEGIN
              AccountingPeriod.SETFILTER("Starting Date", '>=%1', AccountingPeriod."Starting Date");
              AccountingPeriod.FINDSET;
              IF AccountingPeriod."Starting Date" < StartDate THEN
                DeleteUntilDate := CALCDATE('<-1D>', StartDate)
              ELSE
                DeleteUntilDate := CALCDATE('<-1D>', AccountingPeriod."Starting Date");
              TotalForecastDistributed := 0;
              REPEAT
                AccountingPeriod2.SETFILTER("Starting Date", '>%1', AccountingPeriod."Starting Date");
                AccountingPeriod2.FINDFIRST;  //Read next period -> End date curr period is start date next period - 1
                IF AccountingPeriod."Starting Date" < StartDate THEN
                  StartDatePeriod := StartDate
                ELSE
                  StartDatePeriod := AccountingPeriod."Starting Date";
                IF (AccountingPeriod2."Starting Date" - 1) > EndDate THEN
                  EndDatePeriod := EndDate
                ELSE
                  EndDatePeriod := AccountingPeriod2."Starting Date" - 1;

                ProjectForecastInPeriod.SETRANGE(Date, StartDatePeriod, EndDatePeriod);
                IF ProjectForecastLine."Cost Type" = ProjectForecastLine."Cost Type"::Labor THEN BEGIN
                  ProjectForecastInPeriod.CALCSUMS(Quantity);
                  ForecastDistributedInPeriod := ProjectForecastInPeriod.Quantity;
                  ForecastToDistributeInPeriod := (ProjectForecastLine.Quantity - TotalForecastDistributed)/NumberOfPeriods;
                END ELSE BEGIN
                  ProjectForecastInPeriod.CALCSUMS(Amount);
                  ForecastDistributedInPeriod := ProjectForecastInPeriod.Amount;
                  ForecastToDistributeInPeriod := (ProjectForecastLine.Amount - TotalForecastDistributed)/NumberOfPeriods;
                END;
                ForecastToApplyInPeriod := ForecastToDistributeInPeriod - ForecastDistributedInPeriod;
                CreateForecastInPeriod(
                  ProjectForecastLine, StartDatePeriod, ForecastToApplyInPeriod); //ForecastToApplyInPeriod is Rounded here
                ForecastToDistributeInPeriod := ForecastToApplyInPeriod + ForecastDistributedInPeriod;
                TotalForecastDistributed := TotalForecastDistributed + ForecastToDistributeInPeriod;
                NumberOfPeriods := NumberOfPeriods - 1;
                DeleteFromDate := CALCDATE('<+1D>', EndDatePeriod);
              UNTIL (AccountingPeriod.NEXT = 0) OR (AccountingPeriod2."Starting Date" > EndDate);
            END;
          END;

          //Apply Forecast outside date boundaries
          ProjectForecastInPeriod.SETFILTER(Date, '..%1|%2..', DeleteUntilDate, DeleteFromDate);
          IF ProjectForecastInPeriod.FINDSET THEN
            REPEAT
              ProjectForecastInPeriod2.COPY(ProjectForecastInPeriod);
              ProjectForecastInPeriod2.SETRANGE(Date, ProjectForecastInPeriod.Date);
              IF ProjectForecastLine."Cost Type" = ProjectForecastLine."Cost Type"::Labor THEN BEGIN
                ProjectForecastInPeriod2.CALCSUMS(Quantity);
                ForecastToApplyInPeriod := -ProjectForecastInPeriod2.Quantity;
              END ELSE BEGIN
                ProjectForecastInPeriod2.CALCSUMS(Amount); //hier ook
                ForecastToApplyInPeriod := -ProjectForecastInPeriod2.Amount;
              END;
              CreateForecastInPeriod(
                ProjectForecastLine, ProjectForecastInPeriod.Date,
                ForecastToApplyInPeriod);
            UNTIL ProjectForecastInPeriod.NEXT = 0;

        UNTIL ProjectForecastLine.NEXT = 0;
    END;

    PROCEDURE DistributeBySCurve@1100525022(ProjectForecastHeader@1100525000 : Record 11020630;VAR ProjectForecastLine@1100525014 : Record 11020631;PeriodType@1100525001 : Integer);
    VAR
      ProjectForecastInPeriod@1100525013 : Record 11020632;
      TempForecastSCurveLines@1100525020 : TEMPORARY Record 11229319;
      Date@1100525011 : Record 2000000007;
      ForecastSCurveHeader@1100525017 : Record 11229318;
      StartDate@1100525010 : Date;
      EndDate@1100525009 : Date;
      StartDatePeriod@1210190000 : Date;
      NumberOfPeriods@1100525006 : Integer;
      ForecastToDistributeInPeriod@1100525005 : Decimal;
      ForecastToApplyInPeriod@1100525003 : Decimal;
      TotalForecastDistributed@1100525002 : Decimal;
    BEGIN
      //4PS.n UKR-C21180
      IF NOT CONFIRM(Text011, TRUE) THEN
        EXIT;
      PeriodType := 0;  //calculation is always in days

      ProjectForecastLine.SETRANGE("Project No.", ProjectForecastHeader."Project No.");
      ProjectForecastLine.SETRANGE("Forecast Date", ProjectForecastHeader."Forecast Date");
      ProjectForecastLine.SETFILTER("S-Curve",'<>%1','');
      ProjectForecastLine.FILTERGROUP(9);
      ProjectForecastLine.SETRANGE("Cost Type", ProjectForecastLine."Cost Type"::Labor, ProjectForecastLine."Cost Type"::Sundry);
      ProjectForecastLine.FILTERGROUP(0);
      ProjectForecastLine.MARKEDONLY(TRUE);
      IF ProjectForecastLine.ISEMPTY THEN
        ProjectForecastLine.MARKEDONLY(FALSE);
      IF ProjectForecastLine.FINDSET THEN
        REPEAT
          IF ProjectForecastLine.CalceForecastBasedOnQuantity THEN
            ForecastToDistributeInPeriod := ProjectForecastLine.Quantity
          ELSE
            ForecastToDistributeInPeriod := ProjectForecastLine.Amount;
          CLEAR(TotalForecastDistributed);

          DetermineStartAndEndDate(ProjectForecastLine, StartDate, EndDate);
          Date.SETRANGE("Period Type", PeriodType);
          Date.SETRANGE("Period Start", StartDate, EndDate);

          IF Date.FINDSET THEN BEGIN
            NumberOfPeriods := Date.COUNT;
            ForecastSCurveHeader.GET(ProjectForecastLine."S-Curve");
            ForecastSCurveHeader.GetDistributionBySCurve(TempForecastSCurveLines,NumberOfPeriods);

            ProjectForecastInPeriod.SETRANGE("Project No.",ProjectForecastLine."Project No.");
            ProjectForecastInPeriod.SETRANGE("Forecast Date",ProjectForecastLine."Forecast Date");
            ProjectForecastInPeriod.SETRANGE(Source, ProjectForecastInPeriod.Source::Forecast);
            ProjectForecastInPeriod.SETRANGE("Cost Type",ProjectForecastLine."Cost Type");
            ProjectForecastInPeriod.SETRANGE("Cost Object",ProjectForecastLine."Cost Object");
            ProjectForecastInPeriod.SETRANGE(Element,ProjectForecastLine.Element);
            ProjectForecastInPeriod.SETRANGE("Currency Code",ProjectForecastLine."Currency Code"); //**4PS.n BI042 KD 26-08-16
            ProjectForecastInPeriod.DELETEALL;

            REPEAT
              IF Date."Period Start" < StartDate THEN
                StartDatePeriod := StartDate
              ELSE
                StartDatePeriod := Date."Period Start";

              ForecastToApplyInPeriod := ForecastToDistributeInPeriod * TempForecastSCurveLines.Percentage / 100;
              IF NumberOfPeriods = 1 THEN
                ForecastToApplyInPeriod := ForecastToDistributeInPeriod - TotalForecastDistributed;

              CreateForecastInPeriod(
                ProjectForecastLine, StartDatePeriod, ForecastToApplyInPeriod); //ForecastToApplyInPeriod is Rounded here

              TotalForecastDistributed += ForecastToApplyInPeriod;

              NumberOfPeriods := NumberOfPeriods - 1;
              TempForecastSCurveLines.NEXT;
            UNTIL Date.NEXT = 0;
          END;

        UNTIL ProjectForecastLine.NEXT = 0;
    END;

    PROCEDURE DetermineStartAndEndDate@1100525010(ProjectForecastLine@1100525002 : Record 11020631;VAR StartDate@1100525004 : Date;VAR EndDate@1100525003 : Date);
    VAR
      ProjectElement@1100525001 : Record 11012010;
      Project@1100525000 : Record 11072003;
    BEGIN
      StartDate := 0D;
      EndDate := 0D;

      IF ProjectForecastLine.Element <> '' THEN BEGIN
        IF ProjectElement.GET(ProjectForecastLine."Project No.", ProjectForecastLine.Element) THEN BEGIN
          //IF needed in case of elements Main Project differ from Sub Projects
          StartDate := ProjectElement."Starting Date";
          EndDate := ProjectElement."Ending Date";
        END;
      END;

      IF (StartDate = 0D) OR (EndDate = 0D) THEN BEGIN
        Project.GET(ProjectForecastLine."Project No.");
        IF (StartDate = 0D) THEN
          StartDate := Project."Starting Date";
        IF (EndDate = 0D) THEN BEGIN
          Project.TESTFIELD("Ending Date");
          EndDate := Project."Ending Date";
        END;
      END;
      IF StartDate <= ProjectForecastLine."Forecast Date" THEN
        StartDate := CALCDATE('<+1D>', ProjectForecastLine."Forecast Date");
      IF EndDate < StartDate THEN
        EndDate := StartDate;
    END;

    PROCEDURE DetermineNumberOfPeriods@1100525011(StartDate@1100525001 : Date;EndDate@1100525000 : Date;PeriodType@1100525003 : Integer) : Integer;
    VAR
      Date@1100525002 : Record 2000000007;
      AccountingPeriod@1100525004 : Record 50;
      StartDateFirst@1100525005 : Date;
      StartDateLast@1100525006 : Date;
    BEGIN
      IF (PeriodType <> Date."Period Type"::Year + 1) THEN BEGIN  // <> Accounting Period
        Date.SETRANGE("Period Type", PeriodType);
        IF PeriodType = Date."Period Type"::Date THEN
          Date.SETRANGE("Period Start", StartDate, EndDate)
        ELSE BEGIN
          Date.SETFILTER("Period Start", '..%1', EndDate);
          Date.SETFILTER("Period End", '%1..', StartDate);
        END;
        EXIT(Date.COUNT);
      END ELSE BEGIN
        AccountingPeriod.SETFILTER("Starting Date", '<=%1', StartDate);
        AccountingPeriod.FINDLAST;
        StartDateFirst := AccountingPeriod."Starting Date";
        AccountingPeriod.SETFILTER("Starting Date", '<=%1', EndDate);
        AccountingPeriod.FINDLAST;
        StartDateLast := AccountingPeriod."Starting Date";
        AccountingPeriod.SETRANGE("Starting Date", StartDateFirst, StartDateLast);
        EXIT(AccountingPeriod.COUNT);
      END;
    END;

    LOCAL PROCEDURE DeterminePrognosisHours@1100525009(ProjectForecastLine@1100525000 : Record 11020631) : Decimal;
    VAR
      PrognosisLine@1100525001 : Record 11012035;
    BEGIN
      IF ProjectForecastLine."Cost Type" <> ProjectForecastLine."Cost Type"::Labor THEN
        EXIT(0);

      FilterPrognosisLine(PrognosisLine, Project, ProjectForecastLine);

      PrognosisLine.CALCSUMS(Quantity);
      EXIT(PrognosisLine.Quantity);
    END;

    LOCAL PROCEDURE DeterminePrognosisRateCode@1100528100(ProjectForecastLine@1100525000 : Record 11020631) : Code[10];
    VAR
      PrognosisLine@1100525001 : Record 11012035;
      Job@1100528100 : Record 11072003;
      DeterminePrognosisDate@1100528400 : Codeunit 11012029;
    BEGIN
      IF ProjectForecastLine."Cost Type" <> ProjectForecastLine."Cost Type"::Labor THEN
        EXIT('');

      Job.GET(ProjectForecastLine."Project No.");
      Job.SETRANGE("Period Filter", 0D, ProjectForecastLine."Forecast Date");
      DeterminePrognosisDate.DetermineDate(Job);
      FilterPrognosisLine(PrognosisLine, Job, ProjectForecastLine);

      IF PrognosisLine.FINDFIRST THEN
        EXIT(PrognosisLine."Rate Code");
    END;

    LOCAL PROCEDURE DeterminePrognosisRate@1100528102(ProjectForecastLine@1100525000 : Record 11020631) : Decimal;
    VAR
      PrognosisLine@1100528101 : Record 11012035;
      Job@1100528100 : Record 11072003;
      DeterminePrognosisDate@1100528400 : Codeunit 11012029;
    BEGIN
      IF ProjectForecastLine."Cost Type" <> ProjectForecastLine."Cost Type"::Labor THEN
        EXIT(0);

      Job.GET(ProjectForecastLine."Project No.");
      Job.SETRANGE("Period Filter", 0D, ProjectForecastLine."Forecast Date");
      DeterminePrognosisDate.DetermineDate(Job);
      FilterPrognosisLine(PrognosisLine, Job, ProjectForecastLine);

      IF PrognosisLine.FINDFIRST THEN
        EXIT(PrognosisLine.Rate);
    END;

    LOCAL PROCEDURE DeterminePrognosisRevenue@1100528101(ProjectForecastLine@1100525000 : Record 11020631) : Decimal;
    VAR
      PrognosisLine@1100525001 : Record 11012035;
      Job@1100528100 : Record 11072003;
      DeterminePrognosisDate@1100528400 : Codeunit 11012029;
    BEGIN
      IF ProjectForecastLine."Cost Type" <> ProjectForecastLine."Cost Type"::Revenue THEN
        EXIT(0);

      Job.GET(ProjectForecastLine."Project No.");
      Job.SETRANGE("Period Filter", 0D, ProjectForecastLine."Forecast Date");
      DeterminePrognosisDate.DetermineDate(Job);
      FilterPrognosisLine(PrognosisLine, Job, ProjectForecastLine);

      PrognosisLine.CALCSUMS("Amount Revenue");
      EXIT(PrognosisLine."Amount Revenue");
    END;

    LOCAL PROCEDURE FilterPrognosisLine@1100528106(VAR PrognosisLine@1100528102 : Record 11012035;VAR Job@1100528100 : Record 11072003;ProjectForecastLine@1100528101 : Record 11020631);
    BEGIN
      PrognosisLine.SETCURRENTKEY("Main Project No.");
      PrognosisLine.SETRANGE("Main Project No.", Job."Main Project");
      IF Job."No." <> Job."Main Project" THEN
        PrognosisLine.SETRANGE("Project No.", Job."No.");

      CASE Job."Forecast Level" OF
        Job."Forecast Level"::"Element - Cost Object":
          BEGIN
            PrognosisLine.SETRANGE(Element, ProjectForecastLine.Element);
            PrognosisLine.SETRANGE("Cost Object", ProjectForecastLine."Cost Object");
          END;
        Job."Forecast Level"::"Element - Cost Type":
          BEGIN
            PrognosisLine.SETRANGE(Element, ProjectForecastLine.Element);
            PrognosisLine.SETRANGE("Cost Type", ProjectForecastLine."Cost Type");
          END;
        Job."Forecast Level"::"Cost Object":
          PrognosisLine.SETRANGE("Cost Object", ProjectForecastLine."Cost Object");
        Job."Forecast Level"::"Cost Type":
          PrognosisLine.SETRANGE("Cost Type", ProjectForecastLine."Cost Type");
      END;
      Job.COPYFILTER("Prognosis Filter", PrognosisLine."Prognosis Date");
    END;

    PROCEDURE CreatePrognosis@1100525004(ProjectForecastHeader@1100525000 : Record 11020630);
    VAR
      Prognosis@1100525001 : Record 11012034;
      PrognosisLine@1100525004 : Record 11012035;
      ProjectForecastLine@1100525003 : Record 11020631;
      ProjectForecastTotalLine@1210190000 : Record 11020633;
      PrognosisForm@1100409001 : Page 11012085;
      OvhSurchargesCalculated@1210190002 : Boolean;
      PrognosisManagement@1100409000 : Codeunit 11020217;
      ProjectForecastMgt@1100528816 : Codeunit 11012256;
      GenPrognosisFromForecast@1100528815 : Report 11020304;
      StartProcess@1100528814 : Boolean;
      PrognosisDate@1100528813 : Date;
      CopyPrevCostPrognosis@1100528812 : Boolean;
      CopyPrevPrognosisEndResult@1100528811 : Boolean;
      CopyPrevRevenuePrognosis@1100528810 : Boolean;
      CopyPrevPrognosisTotalRev@1100528809 : Boolean;
      CopyCommentsPrevPrognosis@1100528808 : Boolean;
      FillProgWithAvailableCost@1100528807 : Boolean;
      FillProgWithExtrapolatedCosts@1100528806 : Boolean;
      FillProgFromProjPlanningAct@1100528805 : Boolean;
      FillProgFromRequestedActCap@1100528804 : Boolean;
      FillProgFromAssignedActCap@1100528803 : Boolean;
      FillProgRevenues@1100528802 : Boolean;
      CalcSurcharges@1100528801 : Boolean;
      CalcRiscCoverage@1100528800 : Boolean;
      ProjectCurrExchRate@1100529401 : Record 11020628;
      AmtLoc@1100529402 : Decimal;
    BEGIN
      //DP00699.sn.mve 2015-02-09
      TestNoProjectForecastLineDeviation(ProjectForecastHeader);

      GenPrognosisFromForecast.SetSelections(ProjectForecastHeader."Forecast Date");
      GenPrognosisFromForecast.RUNMODAL;
      GenPrognosisFromForecast.GetSelections(StartProcess,PrognosisDate,
        CopyPrevCostPrognosis,CopyPrevPrognosisEndResult,CopyPrevRevenuePrognosis,CopyPrevPrognosisTotalRev,
        CopyCommentsPrevPrognosis,FillProgWithAvailableCost,FillProgWithExtrapolatedCosts,FillProgFromProjPlanningAct,
        FillProgFromRequestedActCap,FillProgFromAssignedActCap,FillProgRevenues,CalcSurcharges,CalcRiscCoverage);
      IF NOT StartProcess THEN
        ERROR('');

      ProjectForecastHeader."Ovh. Surcharges Calculated" := TRUE;
      ProjectForecastHeader."Altered After Calculation" := FALSE;
      ProjectForecastHeader.MODIFY;

      ProjectForecastMgt.CalculateSurcharges(ProjectForecastHeader);

      ProjectForecastHeader."Ovh. Surcharges Calculated" := TRUE; //M28187
      ProjectForecastHeader."Altered After Calculation" := FALSE; //M28187
      ProjectForecastHeader.MODIFY;                               //M28187

      //IF NOT CONFIRM(Text006, TRUE) THEN
      //  EXIT;
      //DP00699.en.mve 2015-02-09

      GetProjectSetup;

      Project.GET(ProjectForecastHeader."Project No.");
      CASE Project."Forecast Level" OF
        Project."Forecast Level"::"Element - Cost Object":
          Project.TESTFIELD("Prognosis per Element", TRUE);
        Project."Forecast Level"::"Cost Object":
          Project.TESTFIELD("Prognosis per Element", FALSE);
        Project."Forecast Level"::"Element - Cost Type",
        Project."Forecast Level"::"Cost Type":
          ERROR(Text007, Project.FIELDCAPTION("Forecast Level"), Project."Forecast Level");
      END;

      IF Prognosis.GET(ProjectForecastHeader."Project No.", ProjectForecastHeader."Forecast Date") THEN BEGIN
        Prognosis.TESTFIELD(Fixed, FALSE);
        IF NOT CONFIRM(Text008) THEN
          EXIT;
      END ELSE BEGIN
        Prognosis.INIT;
        Prognosis.VALIDATE("Project No.", ProjectForecastHeader."Project No.");
        Prognosis.VALIDATE("Prognosis Date", ProjectForecastHeader."Forecast Date");
        Prognosis."Fix Prognosis Line" := ProjectSetup."Fix Prognosis Line";
        Prognosis.INSERT(TRUE);
      END;
      Prognosis."Prognosis Level" := Prognosis."Prognosis Level"::Detailed;

      ProjectForecastTotalLine.SETRANGE("Project No.", ProjectForecastHeader."Project No.");
      ProjectForecastTotalLine.SETRANGE("Forecast Date", ProjectForecastHeader."Forecast Date");
      ProjectForecastTotalLine.SETRANGE("Cost Type", ProjectForecastTotalLine."Cost Type"::"Total Cost");
      ProjectForecastTotalLine.SETRANGE("Currency Code", ''); //**4PS.n BI042 KD 26-08-16
      IF ProjectForecastTotalLine.FINDFIRST THEN BEGIN
        ProjectForecastTotalLine.CALCFIELDS("Best Case", "Worst Case");
        Prognosis."Best Case Cost Forecast" := ProjectForecastTotalLine."Best Case";
        Prognosis."Worst Case Cost Forecast" := ProjectForecastTotalLine."Worst Case";
      END;

      //**4PS.sn BI042 KD 26-08-16
      GetCurrencyBuff;

      IF ProjectForecastHeader."Forecast by Currency" THEN BEGIN
        IF CurrencyBuff.FINDSET THEN
          REPEAT
            ProjectForecastTotalLine.SETRANGE("Currency Code", CurrencyBuff.Code);
            IF ProjectForecastTotalLine.FINDFIRST THEN BEGIN
              ProjectForecastTotalLine.CALCFIELDS("Best Case", "Worst Case");
              IF ProjectForecastTotalLine."Best Case" <> 0 THEN
                Prognosis."Best Case Cost Forecast" += ProjectCurrExchRate.ExchangeAmtFCYToLCY(
                  ProjectForecastTotalLine."Best Case",FALSE,FALSE,
                  ProjectForecastTotalLine."Currency Code",ProjectForecastTotalLine."Project No.",
                  '',ProjectForecastTotalLine."Forecast Date");
              IF ProjectForecastTotalLine."Worst Case" <> 0 THEN
                Prognosis."Worst Case Cost Forecast" += ProjectCurrExchRate.ExchangeAmtFCYToLCY(
                  ProjectForecastTotalLine."Worst Case",FALSE,FALSE,
                  ProjectForecastTotalLine."Currency Code",ProjectForecastTotalLine."Project No.",
                  '',ProjectForecastTotalLine."Forecast Date");
            END;
          UNTIL CurrencyBuff.NEXT = 0;
      END;
      ProjectForecastTotalLine.SETRANGE("Currency Code", '');
      //**4PS.en BI042 KD 26-08-16

      ProjectForecastTotalLine.SETRANGE("Cost Type", ProjectForecastTotalLine."Cost Type"::Revenue);
      IF ProjectForecastTotalLine.FINDFIRST THEN BEGIN
        ProjectForecastTotalLine.CALCFIELDS("Best Case", "Worst Case");
        Prognosis."Best Case Revenue Forecast" := ProjectForecastTotalLine."Best Case";
        Prognosis."Worst Case Revenue Forecast" := ProjectForecastTotalLine."Worst Case";
      END;

      //**4PS.sn BI042 KD 26-08-16
      IF ProjectForecastHeader."Forecast by Currency" THEN BEGIN
        IF CurrencyBuff.FINDSET THEN
          REPEAT
            ProjectForecastTotalLine.SETRANGE("Currency Code", CurrencyBuff.Code);
            IF ProjectForecastTotalLine.FINDFIRST THEN BEGIN
              ProjectForecastTotalLine.CALCFIELDS("Best Case", "Worst Case");
              IF ProjectForecastTotalLine."Best Case" <> 0 THEN
                Prognosis."Best Case Revenue Forecast" += ProjectCurrExchRate.ExchangeAmtFCYToLCY(
                  ProjectForecastTotalLine."Best Case",FALSE,FALSE,
                  ProjectForecastTotalLine."Currency Code",ProjectForecastTotalLine."Project No.",
                  '',ProjectForecastTotalLine."Forecast Date");
              IF ProjectForecastTotalLine."Worst Case" <> 0 THEN
                Prognosis."Worst Case Revenue Forecast" += ProjectCurrExchRate.ExchangeAmtFCYToLCY(
                  ProjectForecastTotalLine."Worst Case",FALSE,FALSE,
                  ProjectForecastTotalLine."Currency Code",ProjectForecastTotalLine."Project No.",
                  '',ProjectForecastTotalLine."Forecast Date");
            END;
          UNTIL CurrencyBuff.NEXT = 0;
      END;
      //**4PS.en BI042 KD 26-08-16

      Prognosis."Last Date Modified" := TODAY;
      Prognosis."Modified by" := USERID;
      Prognosis.MODIFY;
      PrognosisForm.SETRECORD(Prognosis);
      PrognosisManagement.CreatePrognosis(Prognosis,2);

      ProjectForecastLine.SETRANGE("Project No.", ProjectForecastHeader."Project No.");
      ProjectForecastLine.SETRANGE("Forecast Date", ProjectForecastHeader."Forecast Date");
      IF ProjectForecastLine.FINDSET THEN
        REPEAT
          PrognosisLine.SETRANGE("Project No.", ProjectForecastLine."Project No.");
          PrognosisLine.SETRANGE("Prognosis Date", ProjectForecastLine."Forecast Date");
          PrognosisLine.SETRANGE("Cost Type", ProjectForecastLine."Cost Type");
          PrognosisLine.SETRANGE(Element, ProjectForecastLine.Element);
          PrognosisLine.SETRANGE("Cost Object", ProjectForecastLine."Cost Object");
          IF NOT PrognosisLine.FINDFIRST THEN BEGIN
            PrognosisLine.INIT;
            PrognosisLine."Project No." := ProjectForecastLine."Project No.";
            PrognosisLine."Prognosis Date" := ProjectForecastLine."Forecast Date";
            PrognosisLine."Cost Type" := ProjectForecastLine."Cost Type";
            PrognosisLine.Element := ProjectForecastLine.Element;
            PrognosisLine."Cost Object" := ProjectForecastLine."Cost Object";
            PrognosisLine.INSERT(TRUE);
          END;

          PrognosisLine."Ovh. Surcharge" := ProjectForecastLine."Overhead Surcharge Forecast";
          CASE ProjectForecastLine."Cost Type" OF
            ProjectForecastLine."Cost Type"::Labor:
              BEGIN
                PrognosisLine."Rate Code" := ProjectForecastLine."Rate Code";
                IF ProjectForecastLine."Currency Code" = '' THEN //**4PS.n BI042 KD 26-08-16
                  PrognosisLine.Rate := ProjectForecastLine.Rate;
                //PrognosisLine.Quantity := ProjectForecastLine.Quantity; //C003259.o
                ProjectForecastLine.SetForceCalcQty(TRUE);
                PrognosisLine.Quantity += ProjectForecastLine.TotalDistributedForecast; //C003259.n
                ProjectForecastLine.CALCFIELDS("Total Distributed Forecast Amt");
                //**4PS.sn BI042 KD 26-08-16
                // PrognosisLine.VALIDATE(Amount, ProjectForecastLine."Total Distributed Forecast Amt");
                IF ProjectForecastLine."Total Distributed Forecast Amt" <> 0 THEN BEGIN
                  AmtLoc := PrognosisLine.Amount + ProjectCurrExchRate.ExchangeAmtFCYToLCY(
                    ProjectForecastLine."Total Distributed Forecast Amt",FALSE,FALSE,
                    ProjectForecastLine."Currency Code",ProjectForecastLine."Project No.",
                    '',ProjectForecastLine."Forecast Date");
                  PrognosisLine.VALIDATE(Amount, AmtLoc);
                END;
                //**4PS.en BI042 KD 26-08-16
              END;
            ProjectForecastLine."Cost Type"::Revenue:
              //**4PS.sn BI042 KD 26-08-16
              // PrognosisLine.VALIDATE("Amount Revenue", ProjectForecastLine.Amount);
              IF ProjectForecastLine.Amount <> 0 THEN BEGIN
                AmtLoc := PrognosisLine."Amount Revenue" + ProjectCurrExchRate.ExchangeAmtFCYToLCY(
                  ProjectForecastLine.Amount,FALSE,FALSE,
                  ProjectForecastLine."Currency Code",ProjectForecastLine."Project No.",
                  '',ProjectForecastLine."Forecast Date");
                PrognosisLine.Quantity += ProjectForecastLine.Quantity; //DP01426.n
                PrognosisLine.VALIDATE("Amount Revenue", AmtLoc);
              END;
              //**4PS.en BI042 KD 26-08-16
            ELSE
              //**4PS.sn BI042 KD 26-08-16
              // PrognosisLine.VALIDATE(Amount, ProjectForecastLine.Amount);
              IF ProjectForecastLine.Amount <> 0 THEN BEGIN
                AmtLoc := PrognosisLine.Amount + ProjectCurrExchRate.ExchangeAmtFCYToLCY(
                  ProjectForecastLine.Amount,FALSE,FALSE,
                  ProjectForecastLine."Currency Code",ProjectForecastLine."Project No.",
                  '',ProjectForecastLine."Forecast Date");
                PrognosisLine.Quantity += ProjectForecastLine.Quantity; //DP01426.n
                PrognosisLine.VALIDATE(Amount, AmtLoc);
              END;
              //**4PS.en BI042 KD 26-08-16
          END;
          PrognosisLine.MODIFY(TRUE);

          IF ProjectForecastLine."Overhead Surcharge Forecast" <> 0 THEN
            OvhSurchargesCalculated := TRUE;

        UNTIL ProjectForecastLine.NEXT = 0;

      IF CalcSurcharges THEN BEGIN
        PrognosisManagement.RemoveSurcharges(Prognosis);
        PrognosisManagement.CalculateSurcharges(Prognosis);
        OvhSurchargesCalculated := TRUE;
      END;

      IF OvhSurchargesCalculated <> Prognosis."Ovh. Surcharges Calculated" THEN BEGIN
        Prognosis.FIND;
        Prognosis."Ovh. Surcharges Calculated" := OvhSurchargesCalculated;
        Prognosis.MODIFY;
      END;
    END;

    PROCEDURE RemoveSurcharges@1210190003(ProjectForecastHeader@1210190000 : Record 11020630);
    VAR
      ProjectForecastLine@1100525000 : Record 11020631;
      ProjectForecastInPeriod@1210190001 : Record 11020632;
    BEGIN
      ProjectForecastLine.SETRANGE("Project No.", ProjectForecastHeader."Project No.");
      ProjectForecastLine.SETRANGE("Forecast Date", ProjectForecastHeader."Forecast Date");
      ProjectForecastLine.SETRANGE("Cost Type", ProjectForecastLine."Cost Type"::Labor, ProjectForecastLine."Cost Type"::Sundry);
      IF ProjectForecastLine.FINDSET(TRUE, FALSE) THEN
        REPEAT
          ProjectForecastLine."Overhead Surcharge Forecast" := 0;
          ProjectForecastLine.VALIDATE("Amount incl. Surcharge", ProjectForecastLine.Amount);
          ProjectForecastLine.MODIFY(TRUE);
        UNTIL ProjectForecastLine.NEXT = 0;

      ProjectForecastInPeriod.SETRANGE("Project No.", ProjectForecastHeader."Project No.");
      ProjectForecastInPeriod.SETRANGE("Forecast Date", ProjectForecastHeader."Forecast Date");
      ProjectForecastInPeriod.SETRANGE(Source, ProjectForecastInPeriod.Source::"Overhead Surcharge Forecast");
      ProjectForecastInPeriod.DELETEALL;
    END;

    PROCEDURE CalculateSurcharges@1210190002(ProjectForecastHeader@1210190000 : Record 11020630);
    VAR
      ProjectForecastLine@1210190001 : Record 11020631;
      DimVal@1210190004 : Record 349;
      DimMgt@1210190003 : Codeunit 408;
    BEGIN
      //Copied from Prognosis
      GetProjectSetup;

      RemoveSurcharges(ProjectForecastHeader);

      Project.GET(ProjectForecastHeader."Project No.");
      Project.TESTFIELD("Project Type");

      ProjectForecastLine.SETRANGE("Project No.", ProjectForecastHeader."Project No.");
      ProjectForecastLine.SETRANGE("Forecast Date", ProjectForecastHeader."Forecast Date");
      IF ProjectSetup."Prognosis Ovh Surcharge Labor" THEN
        ProjectForecastLine.SETRANGE("Cost Type", ProjectForecastLine."Cost Type"::Labor, ProjectForecastLine."Cost Type"::Sundry)
      ELSE
        ProjectForecastLine.SETRANGE("Cost Type", ProjectForecastLine."Cost Type"::Material, ProjectForecastLine."Cost Type"::Sundry);
      IF ProjectForecastLine.FINDSET(TRUE, FALSE) THEN
        REPEAT
          DimMgt.GetDimValueRec(2, ProjectForecastLine."Cost Object", DimVal, FALSE, '');

          CalcSurcharge(ProjectForecastLine, DimVal);
          CalcSurchargeInPeriod(ProjectForecastLine, DimVal);
        UNTIL ProjectForecastLine.NEXT = 0;
    END;

    PROCEDURE CalcSurcharge@1210190009(ProjectForecastLine@1210190000 : Record 11020631;DimVal@1210190001 : Record 349);
    VAR
      OverheadSurcharge@1100525003 : Record 11020208;
      SurchDimVal@1100525004 : Record 349;
      ProjectForecastLine2@1100525005 : Record 11020631;
      ProjectForecastSurchLine@1210190003 : Record 11020631;
      ProjectElement@1100525008 : Record 11012010;
      Origin@1100525002 : 'Project,Service';
      TotSurchAmount@1100525006 : Decimal;
    BEGIN
      //Copied from Prognosis
      CLEAR(ProjectForecastSurchLine);
      IF OverheadSurcharge.GetSurcharges(
           Origin::Project, Project."Project Type", ProjectForecastLine."Project No.",
           (DimVal."Cost Type" <> DimVal."Cost Type"::Revenue),
           DimVal."Cost Type", DimVal.Code, '',
           Project."Global Dimension 1 Code", '',
           '', ProjectForecastLine."Forecast Date",
           OverheadSurcharge) THEN
        REPEAT
          OverheadSurcharge.GetSurchargeDimVal(DimVal, SurchDimVal);
          ProjectForecastLine2 := ProjectForecastLine;
          ProjectForecastLine2."Overhead Surcharge Forecast" := 0;

          InitSurcharge(
            ProjectForecastLine2, SurchDimVal,
            OverheadSurcharge, TotSurchAmount);

          ProjectForecastSurchLine.INIT;
          IF ProjectForecastSurchLine.GET(
               ProjectForecastLine2."Project No.",
               ProjectForecastLine2."Forecast Date",
               ProjectForecastLine2."Cost Type",
               ProjectForecastLine2.Element,
               ProjectForecastLine2."Cost Object",
               ProjectForecastLine2."Currency Code") //**4PS.n BI042 KD 26-08-16
          THEN BEGIN
            ProjectForecastSurchLine."Overhead Surcharge Forecast" :=
              ProjectForecastSurchLine."Overhead Surcharge Forecast" + ProjectForecastLine2."Overhead Surcharge Forecast";
            ProjectForecastSurchLine.VALIDATE(Amount);
            ProjectForecastSurchLine.MODIFY;
          END ELSE BEGIN
            IF ProjectForecastLine2.Element <> '' THEN BEGIN
              IF NOT ProjectElement.GET(ProjectForecastLine2."Project No.", ProjectForecastLine2.Element) THEN
                ERROR(STRSUBSTNO(Text009, ProjectForecastLine2."Project No.", ProjectForecastLine2.Element));
            END;
            ProjectForecastSurchLine."Project No." := ProjectForecastLine2."Project No.";
            ProjectForecastSurchLine."Forecast Date" := ProjectForecastLine2."Forecast Date";
            ProjectForecastSurchLine."Cost Type" := ProjectForecastLine2."Cost Type";
            ProjectForecastSurchLine.Element := ProjectForecastLine2.Element;
            ProjectForecastSurchLine."Cost Object" := ProjectForecastLine2."Cost Object";
            ProjectForecastSurchLine."Currency Code" := ProjectForecastLine2."Currency Code"; //**4PS.n BI042 KD 26-08-16
            ProjectForecastSurchLine."Overhead Surcharge Forecast" :=
              ProjectForecastLine2."Overhead Surcharge Forecast";
            ProjectForecastSurchLine.VALIDATE(Amount);
            ProjectForecastSurchLine.INSERT(TRUE);
          END;

        UNTIL OverheadSurcharge.NEXT = 0;
    END;

    PROCEDURE InitSurcharge@1210190001(VAR ProjectForecastLine@1210190000 : Record 11020631;SurchDimVal@1210190009 : Record 349;OverheadSurcharge@1210190004 : Record 11020208;VAR TotSurchAmount@1100485002 : Decimal);
    VAR
      BaseAmount@1210190002 : Decimal;
    BEGIN
      IF OverheadSurcharge.Percentage <> 0 THEN BEGIN
        IF ProjectForecastLine."Cost Type" = ProjectForecastLine."Cost Type"::Labor THEN BEGIN
          ProjectForecastLine.CALCFIELDS("Total Distributed Forecast Amt");
          BaseAmount := ProjectForecastLine."Total Distributed Forecast Amt";
        END ELSE
          BaseAmount := ProjectForecastLine.Amount;

        IF OverheadSurcharge."Surcharge over Surcharge" THEN
          ProjectForecastLine."Overhead Surcharge Forecast" :=
            ROUND((BaseAmount + TotSurchAmount) * OverheadSurcharge.Percentage/100)
        ELSE
          ProjectForecastLine."Overhead Surcharge Forecast" :=
            ROUND(BaseAmount * OverheadSurcharge.Percentage/100)
      END ELSE
        ProjectForecastLine."Overhead Surcharge Forecast" := ROUND(OverheadSurcharge.Amount * ProjectForecastLine.Quantity);

      CASE Project."Forecast Level" OF
        Project."Forecast Level"::"Element - Cost Object":
          BEGIN
            IF OverheadSurcharge."Element Surcharge" <> '' THEN
              ProjectForecastLine.Element := OverheadSurcharge."Element Surcharge";
            ProjectForecastLine."Cost Object" := SurchDimVal.Code;
          END;
        Project."Forecast Level"::"Element - Cost Type":
          BEGIN
            IF OverheadSurcharge."Element Surcharge" <> '' THEN
              ProjectForecastLine.Element := OverheadSurcharge."Element Surcharge";
            ProjectForecastLine."Cost Object" := '';
          END;
        Project."Forecast Level"::"Cost Object":
          BEGIN
            ProjectForecastLine.Element := '';
            ProjectForecastLine."Cost Object" := SurchDimVal.Code;
          END;
        Project."Forecast Level"::"Cost Type":
          BEGIN
            ProjectForecastLine.Element := '';
            ProjectForecastLine."Cost Object" := '';
          END;
      END;
      ProjectForecastLine."Cost Type" := SurchDimVal."Cost Type";

      TotSurchAmount := TotSurchAmount + ProjectForecastLine."Overhead Surcharge Forecast";
    END;

    PROCEDURE CalcSurchargeInPeriod@1210190011(ProjectForecastLine@1210190000 : Record 11020631;DimVal@1210190001 : Record 349);
    VAR
      OverheadSurcharge@1100525003 : Record 11020208;
      SurchDimVal@1100525004 : Record 349;
      ProjectForecastInPeriod@1210190003 : Record 11020632;
      ProjectForecastInPeriod2@1210190002 : Record 11020632;
      ProjectForecastInPeriodSurch@1210190004 : Record 11020632;
      Origin@1100525002 : 'Project,Service';
      SurchAmount@1210190005 : Decimal;
      TotSurchAmount@1100525006 : Decimal;
    BEGIN
      ProjectForecastInPeriod.SETRANGE("Project No.", ProjectForecastLine."Project No.");
      ProjectForecastInPeriod.SETRANGE("Forecast Date", ProjectForecastLine."Forecast Date");
      ProjectForecastInPeriod.SETRANGE("Cost Type", ProjectForecastLine."Cost Type");
      ProjectForecastInPeriod.SETRANGE(Element, ProjectForecastLine.Element);
      ProjectForecastInPeriod.SETRANGE("Cost Object", ProjectForecastLine."Cost Object");
      ProjectForecastInPeriod.SETRANGE(Source, ProjectForecastInPeriod.Source::Forecast);
      ProjectForecastInPeriod.SETRANGE("Currency Code",ProjectForecastLine."Currency Code"); //**4PS.n BI042 KD 26-08-16
      IF ProjectForecastInPeriod.FINDSET(TRUE, FALSE) THEN
        REPEAT
          TotSurchAmount := 0;
          IF OverheadSurcharge.GetSurcharges(
               Origin::Project, Project."Project Type", ProjectForecastInPeriod."Project No.",
               (DimVal."Cost Type" <> DimVal."Cost Type"::Revenue),
               DimVal."Cost Type", DimVal.Code, '',
               Project."Global Dimension 1 Code", '',
               '', ProjectForecastInPeriod.Date,
               OverheadSurcharge) THEN
            REPEAT
              OverheadSurcharge.GetSurchargeDimVal(DimVal, SurchDimVal);

              ProjectForecastInPeriod2 := ProjectForecastInPeriod;

              InitSurchargeInPeriod(
                ProjectForecastInPeriod2, SurchDimVal,
                OverheadSurcharge, SurchAmount, TotSurchAmount);

              IF SurchAmount <> 0 THEN BEGIN
                ProjectForecastInPeriodSurch.SETRANGE("Project No.", ProjectForecastInPeriod2."Project No.");
                ProjectForecastInPeriodSurch.SETRANGE("Forecast Date", ProjectForecastInPeriod2."Forecast Date");
                ProjectForecastInPeriodSurch.SETRANGE("Cost Type", ProjectForecastInPeriod2."Cost Type");
                ProjectForecastInPeriodSurch.SETRANGE(Element, ProjectForecastInPeriod2.Element);
                ProjectForecastInPeriodSurch.SETRANGE("Cost Object", ProjectForecastInPeriod2."Cost Object");
                ProjectForecastInPeriodSurch.SETRANGE(Date, ProjectForecastInPeriod2.Date);
                ProjectForecastInPeriodSurch.SETRANGE(Source, ProjectForecastInPeriodSurch.Source::"Overhead Surcharge Forecast");
                ProjectForecastInPeriodSurch.SETRANGE("Currency Code", ProjectForecastInPeriod2."Currency Code"); //**4PS.n BI042 KD 26-08-16
                IF ProjectForecastInPeriodSurch.FINDFIRST THEN BEGIN
                  ProjectForecastInPeriodSurch.Amount := ProjectForecastInPeriodSurch.Amount + SurchAmount;
                  ProjectForecastInPeriodSurch.VALIDATE(Amount);
                  ProjectForecastInPeriodSurch.MODIFY;
                END ELSE BEGIN
                  ProjectForecastInPeriodSurch.INIT;
                  ProjectForecastInPeriodSurch."Project No." := ProjectForecastInPeriod2."Project No.";
                  ProjectForecastInPeriodSurch."Forecast Date" := ProjectForecastInPeriod2."Forecast Date";
                  ProjectForecastInPeriodSurch."Cost Type" := ProjectForecastInPeriod2."Cost Type";
                  ProjectForecastInPeriodSurch.Element := ProjectForecastInPeriod2.Element;
                  ProjectForecastInPeriodSurch."Cost Object" := ProjectForecastInPeriod2."Cost Object";
                  ProjectForecastInPeriodSurch."Currency Code" := ProjectForecastInPeriod2."Currency Code"; //**4PS.n BI042 KD 26-08-16
                  ProjectForecastInPeriodSurch.Date := ProjectForecastInPeriod2.Date;
                  ProjectForecastInPeriodSurch."Line No." :=
                    GetForecastInPeriodNewLineNo(ProjectForecastInPeriodSurch);
                  ProjectForecastInPeriodSurch.Source := ProjectForecastInPeriod2.Source::"Overhead Surcharge Forecast";
                  ProjectForecastInPeriodSurch.Amount := SurchAmount;
                  ProjectForecastInPeriodSurch.VALIDATE(Amount);
                  ProjectForecastInPeriodSurch.INSERT(TRUE);
                END;
              END;

            UNTIL OverheadSurcharge.NEXT = 0;

        UNTIL ProjectForecastInPeriod.NEXT = 0;
    END;

    PROCEDURE InitSurchargeInPeriod@1210190015(VAR ProjectForecastInPeriod@1210190000 : Record 11020632;SurchDimVal@1210190009 : Record 349;OverheadSurcharge@1210190004 : Record 11020208;VAR SurchAmount@1210190002 : Decimal;VAR TotSurchAmount@1100485002 : Decimal);
    BEGIN
      IF OverheadSurcharge.Percentage <> 0 THEN BEGIN
        IF OverheadSurcharge."Surcharge over Surcharge" THEN
          SurchAmount :=
            ROUND((ProjectForecastInPeriod.Amount + TotSurchAmount) * OverheadSurcharge.Percentage/100)
        ELSE
          SurchAmount :=
            ROUND(ProjectForecastInPeriod.Amount * OverheadSurcharge.Percentage/100)
      END ELSE
        SurchAmount := ROUND(OverheadSurcharge.Amount * ProjectForecastInPeriod.Quantity);

      CASE Project."Forecast Level" OF
        Project."Forecast Level"::"Element - Cost Object":
          BEGIN
            IF OverheadSurcharge."Element Surcharge" <> '' THEN
              ProjectForecastInPeriod.Element := OverheadSurcharge."Element Surcharge";
            ProjectForecastInPeriod."Cost Object" := SurchDimVal.Code;
          END;
        Project."Forecast Level"::"Element - Cost Type":
          BEGIN
            IF OverheadSurcharge."Element Surcharge" <> '' THEN
              ProjectForecastInPeriod.Element := OverheadSurcharge."Element Surcharge";
            ProjectForecastInPeriod."Cost Object" := '';
          END;
        Project."Forecast Level"::"Cost Object":
          BEGIN
            ProjectForecastInPeriod.Element := '';
            ProjectForecastInPeriod."Cost Object" := SurchDimVal.Code;
          END;
        Project."Forecast Level"::"Cost Type":
          BEGIN
            ProjectForecastInPeriod.Element := '';
            ProjectForecastInPeriod."Cost Object" := '';
          END;
      END;
      ProjectForecastInPeriod."Cost Type" := SurchDimVal."Cost Type";

      TotSurchAmount := TotSurchAmount + SurchAmount;
    END;

    PROCEDURE TestNoProjectForecastLineDeviation@1100528800(ProjectForecastHeader@1100528800 : Record 11020630);
    VAR
      ProjectForecastLine@1100528801 : Record 11020631;
    BEGIN
      GetProjectSetup;
      ProjectForecastLine.SETRANGE("Project No.", ProjectForecastHeader."Project No.");
      ProjectForecastLine.SETRANGE("Forecast Date", ProjectForecastHeader."Forecast Date");
      IF ProjectForecastLine.FINDSET THEN
        REPEAT
          IF ABS(ProjectForecastLine.Deviation) > ProjectSetup."Max. Diff. Forecast/Prognosis" THEN
            ERROR(
              Text010, ABS(ProjectForecastLine.Deviation), ProjectSetup.FIELDCAPTION("Max. Diff. Forecast/Prognosis"),
              ProjectSetup."Max. Diff. Forecast/Prognosis", ProjectSetup.TABLECAPTION);
        UNTIL ProjectForecastLine.NEXT = 0;
    END;

    PROCEDURE FillForecastFromPlanning@1100529400(ProjectForecastHeaderLoc@1100529400 : Record 11020630;PeriodType@1100529404 : 'Day,Week,Month,Quarter,Year,Accounting Period');
    VAR
      BudgetLine@1100529401 : Record 11012001;
      BudgetPlanningActivity@1100529402 : Record 11229302;
      ProjectPlanningActivity@1100529403 : Record 11012431;
      PeriodTmp@1100529407 : TEMPORARY Record 2000000007;
      ProjectForecastLine@1100529412 : Record 11020631;
      ProjectForecastinPeriod@1100529607 : Record 11020632;
      StartDate@1100529408 : Date;
      EndDate@1100529409 : Date;
      AmtLoc@1100529603 : Decimal;
      TotAmtLoc@1100529602 : Decimal;
      CheckAmtLoc@1100529601 : Decimal;
      TotalCheckAmtLoc@1100529608 : Decimal;
      DiffAmountLoc@1100529600 : Decimal;
      AmtToDivide@1100529604 : Decimal;
      LinesCount@1100529605 : Integer;
      TotalLinesCount@1100529606 : Integer;
      LineNo@1100529609 : Integer;
    BEGIN
      //**4PS.sn BI045 KD 09-08-16
      ProjectForecastHeader := ProjectForecastHeaderLoc;
      ProjectForecastHeader.TESTFIELD("Project No.");
      ProjectForecastHeader.TESTFIELD("Forecast Date");

      Project.GET(ProjectForecastHeader."Project No.");

      IF NOT SetFiltersAndCheckLines(BudgetLine, BudgetPlanningActivity, ProjectPlanningActivity, ProjectForecastLine) THEN
        EXIT;

      ProjectPlanningActivity.SETCURRENTKEY("Starting Date");
      IF ProjectPlanningActivity.FINDFIRST THEN
        StartDate := DT2DATE(ProjectPlanningActivity."Starting Date");
      IF StartDate < ProjectForecastHeader."Forecast Date" THEN
        StartDate := ProjectForecastHeader."Forecast Date";

      ProjectPlanningActivity.SETCURRENTKEY("Ending Date");
      IF ProjectPlanningActivity.FINDLAST THEN
        EndDate := DT2DATE(ProjectPlanningActivity."Ending Date");

      GetPeriodTmp(PeriodTmp, PeriodType, StartDate, EndDate);

      DeletePlanningLines;

      ProjectForecastLine.FINDSET;
      REPEAT
        TotAmtLoc := AmountToDistribute(ProjectForecastLine);
        IF TotAmtLoc > 0 THEN BEGIN
          TotalCheckAmtLoc := 0;
          CheckAmtLoc := 0;
          DiffAmountLoc := 0;

          CASE Project."Forecast Level" OF
            Project."Forecast Level"::"Element - Cost Object":
              BEGIN
                BudgetLine.SETRANGE(Element,ProjectForecastLine.Element);
                BudgetLine.SETRANGE("Cost Type",ProjectForecastLine."Cost Type");
                BudgetLine.SETRANGE("Cost Object",ProjectForecastLine."Cost Object");
              END;
            Project."Forecast Level"::"Element - Cost Type":
              BEGIN
                BudgetLine.SETRANGE(Element,ProjectForecastLine.Element);
                BudgetLine.SETRANGE("Cost Type",ProjectForecastLine."Cost Type");
              END;
            Project."Forecast Level"::"Cost Object":
              BEGIN
                BudgetLine.SETRANGE("Cost Type",ProjectForecastLine."Cost Type");
                BudgetLine.SETRANGE("Cost Object",ProjectForecastLine."Cost Object");
              END;
            Project."Forecast Level"::"Cost Type":
              BEGIN
                BudgetLine.SETRANGE("Cost Type",ProjectForecastLine."Cost Type");
              END;
          END;

          IF ProjectForecastHeader."Forecast by Currency" THEN
            BudgetLine.SETRANGE("Currency Code",ProjectForecastLine."Currency Code");

          IF BudgetLine.FINDSET THEN BEGIN
            TotalLinesCount := BudgetLine.COUNT;
            LinesCount := 0;
            REPEAT
              LinesCount += 1;
              IF LinesCount = TotalLinesCount THEN
                AmtToDivide := TotAmtLoc - CheckAmtLoc
              ELSE BEGIN
                AmtLoc := BudgetLine."Amount (FCY)" * TotAmtLoc / ProjectForecastLine.Budget;
                AmtToDivide := ROUND(AmtLoc + DiffAmountLoc, 0.01);
                DiffAmountLoc := AmtLoc - AmtToDivide;
                CheckAmtLoc += AmtToDivide;
              END;

              BudgetPlanningActivity.SETRANGE(Adjustment, BudgetLine.Adjustment);
              BudgetPlanningActivity.SETRANGE("Extension Contract", BudgetLine."Extension Contract");
              BudgetPlanningActivity.SETRANGE(Option, BudgetLine.Option);
              BudgetPlanningActivity.SETRANGE("Budget Line No.", BudgetLine."Line No.");
              IF BudgetPlanningActivity.FINDSET THEN
                REPEAT
                  DistributeAmtByPlanning(BudgetPlanningActivity."Project Planning Activity No.", ProjectForecastLine,
                    PeriodTmp, AmtToDivide * BudgetPlanningActivity.Percentage / 100, TotalCheckAmtLoc);
                UNTIL BudgetPlanningActivity.NEXT = 0;
            UNTIL BudgetLine.NEXT = 0;
          END;

          IF TotAmtLoc - TotalCheckAmtLoc > 0 THEN BEGIN
            LineNo := 10000;
            ProjectForecastinPeriod.SETRANGE("Project No.",ProjectForecastLine."Project No.");
            ProjectForecastinPeriod.SETRANGE("Forecast Date",ProjectForecastLine."Forecast Date");
            ProjectForecastinPeriod.SETRANGE("Cost Type",ProjectForecastLine."Cost Type");
            ProjectForecastinPeriod.SETRANGE(Element,ProjectForecastLine.Element);
            ProjectForecastinPeriod.SETRANGE("Cost Object",ProjectForecastLine."Cost Object");
            ProjectForecastinPeriod.SETRANGE("Currency Code",ProjectForecastLine."Currency Code");
            ProjectForecastinPeriod.SETRANGE(Date, ProjectForecastLine."Forecast Date");
            IF ProjectForecastinPeriod.FINDLAST THEN
              LineNo += ProjectForecastinPeriod."Line No.";

            ProjectForecastinPeriod.INIT;
            ProjectForecastinPeriod."Project No." := ProjectForecastLine."Project No.";
            ProjectForecastinPeriod."Forecast Date" := ProjectForecastLine."Forecast Date";
            ProjectForecastinPeriod."Cost Type" := ProjectForecastLine."Cost Type";
            ProjectForecastinPeriod.Element := ProjectForecastLine.Element;
            ProjectForecastinPeriod."Cost Object" := ProjectForecastLine."Cost Object";
            ProjectForecastinPeriod."Currency Code" := ProjectForecastLine."Currency Code";
            ProjectForecastinPeriod.Date := ProjectForecastLine."Forecast Date";
            ProjectForecastinPeriod."Line No." := LineNo;
            ProjectForecastinPeriod.Rate := ProjectForecastLine.Rate;
            ProjectForecastinPeriod.Price := ProjectForecastLine.Price; //DP01426.n
            ProjectForecastinPeriod.Amount := ROUND(TotAmtLoc - TotalCheckAmtLoc, 0.01);
            IF (ProjectForecastinPeriod."Cost Type" = ProjectForecastinPeriod."Cost Type"::Labor) AND (ProjectForecastinPeriod.Rate <> 0) THEN
              ProjectForecastinPeriod.Quantity := ROUND(ProjectForecastinPeriod.Amount / ProjectForecastinPeriod.Rate, 0.00001);
            //DP01426.sn
            IF (ProjectForecastinPeriod."Cost Type" <> ProjectForecastinPeriod."Cost Type"::Labor) AND (ProjectForecastinPeriod.Price <> 0) THEN
              ProjectForecastinPeriod.Quantity := ROUND(ProjectForecastinPeriod.Amount / ProjectForecastinPeriod.Price, 0.00001);
            //DP01426.en
            ProjectForecastinPeriod.Source := ProjectForecastinPeriod.Source::"Planning-error";
            ProjectForecastinPeriod.INSERT(TRUE);
          END;
        END;
      UNTIL ProjectForecastLine.NEXT = 0;
      //**4PS.en BI045 KD 09-08-16
    END;

    LOCAL PROCEDURE SetFiltersAndCheckLines@1100529710(VAR BudgetLine@1100529706 : Record 11012001;VAR BudgetPlanningActivity@1100529705 : Record 11229302;VAR ProjectPlanningActivity@1100529703 : Record 11012431;VAR ProjectForecastLine@1100529707 : Record 11020631) : Boolean;
    BEGIN
      //**4PS.sn BI045 KD 29-12-16
      ProjectForecastLine.SETRANGE("Project No.", ProjectForecastHeader."Project No.");
      ProjectForecastLine.SETRANGE("Forecast Date", ProjectForecastHeader."Forecast Date");
      ProjectForecastLine.SETRANGE("Cost Type", ProjectForecastLine."Cost Type"::Labor, ProjectForecastLine."Cost Type"::Sundry);
      IF ProjectForecastLine.ISEMPTY THEN
        EXIT(FALSE);

      BudgetLine.SETRANGE("Project No.", ProjectForecastHeader."Project No.");

      BudgetPlanningActivity.SETRANGE("Project No.", ProjectForecastHeader."Project No.");

      ProjectPlanningActivity.SETRANGE("Project No.", ProjectForecastHeader."Project No.");
      ProjectPlanningActivity.SETRANGE(Type, ProjectPlanningActivity.Type::Activity);
      ProjectPlanningActivity.SETFILTER("Ending Date",'>=%1', CREATEDATETIME(ProjectForecastHeader."Forecast Date",0T));

      EXIT(TRUE);
      //**4PS.en BI045 KD 29-12-16
    END;

    LOCAL PROCEDURE GetPeriodTmp@1100529705(VAR PeriodTmp@1100529707 : TEMPORARY Record 2000000007;PeriodType@1100529404 : 'Day,Week,Month,Quarter,Year,Accounting Period';StartDate@1100529706 : Date;EndDate@1100529705 : Date);
    VAR
      DateRec@1100529405 : Record 2000000007;
      AccPeriod@1100529700 : Record 50;
    BEGIN
      //**4PS.sn BI045 KD 29-12-16
      PeriodTmp.RESET;
      PeriodTmp.DELETEALL;

      IF PeriodType = PeriodType::"Accounting Period" THEN BEGIN
        AccPeriod.SETFILTER("Starting Date",'<=%1',StartDate);
        IF AccPeriod.FINDLAST THEN
          StartDate := AccPeriod."Starting Date";
        AccPeriod.SETFILTER("Starting Date",'>=%1&<=%2',StartDate,EndDate);
        IF AccPeriod.ISEMPTY THEN
          EXIT;

        DateRec.SETRANGE("Period Type", DateRec."Period Type"::Date);
        CLEAR(PeriodTmp);

        AccPeriod.FINDSET;
        REPEAT
          IF PeriodTmp."Period Start" <> 0D THEN BEGIN
            DateRec.SETFILTER("Period Start", '<%1', AccPeriod."Starting Date");
            IF DateRec.FINDLAST THEN BEGIN
              PeriodTmp."Period End" := DateRec."Period Start";
              PeriodTmp.MODIFY;
            END;
          END;

          PeriodTmp."Period Start" := AccPeriod."Starting Date";
          PeriodTmp.INSERT;
        UNTIL AccPeriod.NEXT = 0;

        DateRec.SETRANGE("Period Start");
        IF DateRec.FINDLAST THEN BEGIN
          PeriodTmp."Period End" := DateRec."Period Start";
          PeriodTmp.MODIFY;
        END;

        EXIT;
      END;

      DateRec.SETRANGE("Period Type",PeriodType);
      DateRec.SETFILTER("Period Start",'<=%1',StartDate);
      IF DateRec.FINDLAST THEN
        StartDate := DateRec."Period Start";
      DateRec.SETFILTER("Period Start",'>=%1&<=%2',StartDate,EndDate);
      IF DateRec.ISEMPTY THEN
        EXIT;

      DateRec.FINDSET;
      REPEAT
        PeriodTmp := DateRec;
        PeriodTmp.INSERT;
      UNTIL DateRec.NEXT = 0;
      //**4PS.en BI045 KD 29-12-16
    END;

    LOCAL PROCEDURE DeletePlanningLines@1100529723();
    VAR
      ProjectForecastInPeriod@1100529700 : Record 11020632;
    BEGIN
      //**4PS.sn BI045 KD 29-12-16
      ProjectForecastInPeriod.SETRANGE("Project No.", ProjectForecastHeader."Project No.");
      ProjectForecastInPeriod.SETRANGE("Forecast Date", ProjectForecastHeader."Forecast Date");
      ProjectForecastInPeriod.SETRANGE(Source, ProjectForecastInPeriod.Source::Planning, ProjectForecastInPeriod.Source::"Planning-error");
      IF ProjectForecastInPeriod.FINDSET THEN
        ProjectForecastInPeriod.DELETEALL;
      //**4PS.en BI045 KD 29-12-16
    END;

    LOCAL PROCEDURE AmountToDistribute@1100529600(ProjectForecastLine@1100529704 : Record 11020631) : Decimal;
    VAR
      ProjectForecastInPeriod@1100529706 : Record 11020632;
    BEGIN
      //**4PS.sn BI045 KD 15-02-17
      ProjectForecastInPeriod.SETRANGE("Project No.", ProjectForecastLine."Project No.");
      ProjectForecastInPeriod.SETRANGE("Forecast Date", ProjectForecastLine."Forecast Date");
      ProjectForecastInPeriod.SETRANGE("Cost Type", ProjectForecastLine."Cost Type");
      ProjectForecastInPeriod.SETRANGE(Element, ProjectForecastLine.Element);
      ProjectForecastInPeriod.SETRANGE("Cost Object", ProjectForecastLine."Cost Object");
      ProjectForecastInPeriod.SETRANGE("Currency Code", ProjectForecastLine."Currency Code");
      ProjectForecastInPeriod.CALCSUMS(Amount);
      EXIT(ProjectForecastLine."Total Open Purch.plus Forecast" - ProjectForecastInPeriod.Amount);
      //**4PS.en BI045 KD 15-02-17
    END;

    LOCAL PROCEDURE DistributeAmtByPlanning@1100529718(ProjectPlanningActivityNo@1100529702 : Code[30];ProjectForecastLine@1100529704 : Record 11020631;VAR PeriodTmp@1100529703 : TEMPORARY Record 2000000007;AmountToDivide@1100529600 : Decimal;VAR TotalCheckAmt@1100529601 : Decimal);
    VAR
      ProjectPlanningActivity@1100529403 : Record 11012431;
      ProjectForecastInPeriod@1100529706 : Record 11020632;
      DateRec@1100529405 : Record 2000000007;
      StartDate@1100529408 : Date;
      AmtLoc@1100529415 : Decimal;
      TotAmtLoc@1100529420 : Decimal;
      CheckAmtLoc@1100529421 : Decimal;
      DiffAmountLoc@1100529423 : Decimal;
      PeriodLineNo@1100529422 : Integer;
      PlanningDaysTotal@1100529700 : Integer;
      PlanningDaysInForecast@1100529701 : Integer;
    BEGIN
      //**4PS.sn BI045 KD 29-12-16
      ProjectPlanningActivity.SETRANGE("No.", ProjectPlanningActivityNo);
      IF NOT ProjectPlanningActivity.FINDFIRST THEN
        EXIT;

      DateRec.SETRANGE("Period Type", DateRec."Period Type"::Date);
      DateRec.FILTERGROUP(2);
      DateRec.SETRANGE("Period Start", DT2DATE(ProjectPlanningActivity."Starting Date"), DT2DATE(ProjectPlanningActivity."Ending Date"));
      PlanningDaysTotal := DateRec.COUNT;
      IF DT2DATE(ProjectPlanningActivity."Starting Date") >= ProjectForecastHeader."Forecast Date" THEN
        PlanningDaysInForecast := PlanningDaysTotal
      ELSE BEGIN
        DateRec.SETRANGE("Period Start", ProjectForecastHeader."Forecast Date", DT2DATE(ProjectPlanningActivity."Ending Date"));
        PlanningDaysInForecast := DateRec.COUNT;
      END;
      DateRec.FILTERGROUP(0);

      IF PlanningDaysInForecast = 0 THEN
        EXIT;

      StartDate := DT2DATE(ProjectPlanningActivity."Starting Date");
      PeriodTmp.SETFILTER("Period Start",'<=%1',StartDate);
      IF PeriodTmp.FINDLAST THEN
        StartDate := PeriodTmp."Period Start";
      PeriodTmp.SETRANGE("Period Start", StartDate, DT2DATE(ProjectPlanningActivity."Ending Date"));
      IF PeriodTmp.ISEMPTY THEN
        EXIT;

      ProjectForecastInPeriod.SETRANGE("Project No.",ProjectForecastLine."Project No.");
      ProjectForecastInPeriod.SETRANGE("Forecast Date",ProjectForecastLine."Forecast Date");
      ProjectForecastInPeriod.SETRANGE("Cost Type",ProjectForecastLine."Cost Type");
      ProjectForecastInPeriod.SETRANGE(Element,ProjectForecastLine.Element);
      ProjectForecastInPeriod.SETRANGE("Cost Object",ProjectForecastLine."Cost Object");
      ProjectForecastInPeriod.SETRANGE("Currency Code",ProjectForecastLine."Currency Code");

      TotAmtLoc := ROUND(AmountToDivide * (1 - ProjectPlanningActivity."Completed Perc." / 100) * PlanningDaysInForecast / PlanningDaysTotal, 0.01);

      CheckAmtLoc := 0;
      DiffAmountLoc := 0;

      PeriodTmp.FINDSET;
      REPEAT
        DateRec.SETRANGE("Period Start", PeriodTmp."Period Start", PeriodTmp."Period End");

        PeriodLineNo := 10000;
        ProjectForecastInPeriod.SETRANGE(Date,PeriodTmp."Period Start");
        IF ProjectForecastInPeriod.FINDLAST THEN
          PeriodLineNo += ProjectForecastInPeriod."Line No.";

        ProjectForecastInPeriod.INIT;
        ProjectForecastInPeriod."Project No." := ProjectForecastLine."Project No.";
        ProjectForecastInPeriod."Forecast Date" := ProjectForecastLine."Forecast Date";
        ProjectForecastInPeriod."Cost Type" := ProjectForecastLine."Cost Type";
        ProjectForecastInPeriod.Element := ProjectForecastLine.Element;
        ProjectForecastInPeriod."Cost Object" := ProjectForecastLine."Cost Object";
        ProjectForecastInPeriod."Currency Code" := ProjectForecastLine."Currency Code";
        ProjectForecastInPeriod.Date := PeriodTmp."Period Start";
        ProjectForecastInPeriod."Line No." := PeriodLineNo;
        ProjectForecastInPeriod.Rate := ProjectForecastLine.Rate;
        ProjectForecastInPeriod.Price := ProjectForecastLine.Price; //DP01426.n
        AmtLoc := TotAmtLoc * DateRec.COUNT / PlanningDaysInForecast;
        ProjectForecastInPeriod.Amount := ROUND(AmtLoc + DiffAmountLoc,0.01);
        DiffAmountLoc := AmtLoc - ProjectForecastInPeriod.Amount;
        CheckAmtLoc += ProjectForecastInPeriod.Amount;
        IF (ProjectForecastInPeriod."Cost Type" = ProjectForecastInPeriod."Cost Type"::Labor) AND (ProjectForecastInPeriod.Rate <> 0) THEN
          ProjectForecastInPeriod.Quantity := ROUND(ProjectForecastInPeriod.Amount / ProjectForecastInPeriod.Rate, 0.00001);
        //DP01426.sn
        IF (ProjectForecastInPeriod."Cost Type" <> ProjectForecastInPeriod."Cost Type"::Labor) AND (ProjectForecastInPeriod.Price <> 0) THEN
          ProjectForecastInPeriod.Quantity := ROUND(ProjectForecastInPeriod.Amount / ProjectForecastInPeriod.Price, 0.00001);
        //DP01426.en
        ProjectForecastInPeriod.Source := ProjectForecastInPeriod.Source::Planning;
        ProjectForecastInPeriod.INSERT(TRUE);
      UNTIL PeriodTmp.NEXT = 0;

      IF CheckAmtLoc <> TotAmtLoc THEN BEGIN
        ProjectForecastInPeriod.Amount += TotAmtLoc - CheckAmtLoc;
        IF (ProjectForecastInPeriod."Cost Type" = ProjectForecastInPeriod."Cost Type"::Labor) AND (ProjectForecastInPeriod.Rate <> 0) THEN
          ProjectForecastInPeriod.Quantity := ROUND(ProjectForecastInPeriod.Amount / ProjectForecastInPeriod.Rate, 0.00001);
        //DP01426.sn
        IF (ProjectForecastInPeriod."Cost Type" <> ProjectForecastInPeriod."Cost Type"::Labor) AND (ProjectForecastInPeriod.Price <> 0) THEN
          ProjectForecastInPeriod.Quantity := ROUND(ProjectForecastInPeriod.Amount / ProjectForecastInPeriod.Price, 0.00001);
        //DP01426.en
        ProjectForecastInPeriod.MODIFY;
      END;

      TotalCheckAmt += TotAmtLoc;
      //**4PS.en BI045 KD 29-12-16
    END;

    LOCAL PROCEDURE DeleteEmptyLines@1100529401();
    VAR
      ProjectForecastLineLoc@1100529400 : Record 11020631;
    BEGIN
      //**4PS.sn BI042 KD 01-09-16
      IF NOT ProjectForecastHeader."Forecast by Currency" THEN
        EXIT;

      ProjectForecastLineLoc.SETRANGE("Project No.",ProjectForecastHeader."Project No.");
      ProjectForecastLineLoc.SETRANGE("Forecast Date",ProjectForecastHeader."Forecast Date");
      IF ProjectForecastLineLoc.FINDSET THEN
        REPEAT
          IF IsEmptyLine(ProjectForecastLineLoc) THEN
            ProjectForecastLineLoc.MARK(TRUE);
        UNTIL ProjectForecastLineLoc.NEXT = 0;

      ProjectForecastLineLoc.MARKEDONLY(TRUE);
      IF ProjectForecastLineLoc.FINDSET THEN
        ProjectForecastLineLoc.DELETEALL;
      //**4PS.en BI042 KD 01-09-16
    END;

    LOCAL PROCEDURE IsEmptyLine@1100529403(ProjectForecastLineLoc@1100529400 : Record 11020631) : Boolean;
    VAR
      BudgetLine@1100529600 : Record 11012001;
    BEGIN
      //**4PS.sn BI042 KD 01-09-16
      WITH ProjectForecastLineLoc DO BEGIN
        IF Budget <> 0 THEN
          EXIT(FALSE);
        IF "Budget Hours" <> 0 THEN
          EXIT(FALSE);
        IF "Actual Costs" <> 0 THEN
          EXIT(FALSE);
        IF "Actual Hours" <> 0 THEN
          EXIT(FALSE);
        IF "Open (Purchase)" <> 0 THEN
          EXIT(FALSE);
        IF "Received/Not Invoiced" <> 0 THEN
          EXIT(FALSE);
        IF "Open Ovh. Surch. (Purchase)" <> 0 THEN
          EXIT(FALSE);
        IF "Total Open Purchase" <> 0 THEN
          EXIT(FALSE);
        IF "Total Cost" <> 0 THEN
          EXIT(FALSE);
        IF "Total Hours" <> 0 THEN
          EXIT(FALSE);
        IF Allowed <> 0 THEN
          EXIT(FALSE);
        IF "Allowed Hours" <> 0 THEN
          EXIT(FALSE);
        IF Prognosis <> 0 THEN
          EXIT(FALSE);
        IF "Prognosis Hours" <> 0 THEN
          EXIT(FALSE);
        IF Quantity <> 0 THEN
          EXIT(FALSE);
        IF Amount <> 0 THEN
          EXIT(FALSE);
        IF "Overhead Surcharge Forecast" <> 0 THEN
          EXIT(FALSE);
        IF "Amount incl. Surcharge" <> 0 THEN
          EXIT(FALSE);
        IF "Best Case" <> 0 THEN
          EXIT(FALSE);
        IF "Worst Case" <> 0 THEN
          EXIT(FALSE);
        IF "Forecast Total Cost" <> 0 THEN
          EXIT(FALSE);
        IF "Total Open Purch.plus Forecast" <> 0 THEN
          EXIT(FALSE);
        IF Invoiced <> 0 THEN
          EXIT(FALSE);
        CALCFIELDS("Total Distributed Forecast Amt");
        IF "Total Distributed Forecast Amt" <> 0 THEN
          EXIT(FALSE);

        BudgetLine.SETRANGE("Main Project No.", Project."Main Project");
        BudgetLine.SETRANGE("Project No.", Project."No.");
        CASE Project."Forecast Level" OF
          Project."Forecast Level"::"Element - Cost Object":
            BEGIN
              BudgetLine.SETRANGE(Element, Element);
              BudgetLine.SETRANGE("Cost Type", "Cost Type");
              BudgetLine.SETRANGE("Cost Object", "Cost Object");
            END;
          Project."Forecast Level"::"Element - Cost Type":
            BEGIN
              BudgetLine.SETRANGE(Element, Element);
              BudgetLine.SETRANGE("Cost Type", "Cost Type");
            END;
          Project."Forecast Level"::"Cost Object":
            BEGIN
              BudgetLine.SETRANGE("Cost Type", "Cost Type");
              BudgetLine.SETRANGE("Cost Object", "Cost Object");
            END;
          Project."Forecast Level"::"Cost Type":
            BEGIN
              BudgetLine.SETRANGE("Cost Type", "Cost Type");
            END;
        END;
        BudgetLine.SETRANGE("Currency Code", "Currency Code");
        IF NOT BudgetLine.ISEMPTY THEN
          EXIT(FALSE);

      END;
      EXIT(TRUE);
      //**4PS.en BI042 KD 01-09-16
    END;

    LOCAL PROCEDURE DeletePrevForecast@1100529404();
    VAR
      ProjectForecastLineLoc@1100529400 : Record 11020631;
      ProjectForecastTotalLineLoc@1100529401 : Record 11020633;
    BEGIN
      //**4PS.sn BI042 KD 22-09-16
      WITH ProjectForecastHeader DO BEGIN
        IF Fixed THEN
          EXIT;

        ProjectForecastLineLoc.SETRANGE("Project No.",ProjectForecastHeader."Project No.");
        ProjectForecastLineLoc.SETRANGE("Forecast Date","Forecast Date");
        IF ProjectForecastLineLoc.FINDSET THEN
          ProjectForecastLineLoc.DELETEALL(TRUE);

        ProjectForecastTotalLineLoc.SETRANGE("Project No.","Project No.");
        ProjectForecastTotalLineLoc.SETRANGE("Forecast Date","Forecast Date");
        IF ProjectForecastTotalLineLoc.FINDSET THEN
          ProjectForecastTotalLineLoc.DELETEALL;
      END;
      //**4PS.en BI042 KD 22-09-16
    END;

    LOCAL PROCEDURE GetCurrencyBuff@1100529414();
    VAR
      Currency@1100529400 : Record 4;
      BudgetLine@1100529401 : Record 11012001;
      JobLedgerEntry@1100529402 : Record 11072005;
      HourAccountingLine@1100529404 : Record 11012039;
      PurchaseLine@1100529403 : Record 39;
      SubProject@1100529600 : Record 11072003;
      ProjectInstallment@1100529601 : Record 11012018;
    BEGIN
      //**4PS.sn BI042 KD 01-12-16
      CurrencyBuff.RESET;
      CurrencyBuff.DELETEALL;

      IF NOT ProjectForecastHeader."Forecast by Currency" THEN
        EXIT;

      BudgetLine.SETRANGE("Main Project No.", Project."Main Project");
      BudgetLine.SETRANGE("Project No.", Project."No.");
      JobLedgerEntry.SETRANGE("Main Project No.", Project."Main Project");
      JobLedgerEntry.SETRANGE("Job No.", Project."No.");
      HourAccountingLine.SETRANGE("Main Project No.", Project."Main Project");
      HourAccountingLine.SETRANGE("Project No.", Project."No.");
      PurchaseLine.SETRANGE("Main Project No.", Project."Main Project");
      PurchaseLine.SETRANGE("Job No.", Project."No.");
      SubProject.SETCURRENTKEY("Main Project");
      SubProject.SETRANGE("Main Project", Project."Main Project");
      IF Project."Single/Main/Sub Project" <> Project."Single/Main/Sub Project"::"Main Project" THEN
        SubProject.SETRANGE("No.", ProjectForecastHeader."Project No.");

      Currency.FINDSET;
      REPEAT
        CLEAR(CurrencyBuff);

        BudgetLine.SETRANGE("Currency Code",Currency.Code);
        IF NOT BudgetLine.ISEMPTY THEN BEGIN
          CurrencyBuff := Currency;
          CurrencyBuff.INSERT;
        END;

        IF CurrencyBuff.Code = '' THEN BEGIN
          JobLedgerEntry.SETRANGE("Currency Code",Currency.Code);
          IF NOT JobLedgerEntry.ISEMPTY THEN BEGIN
            CurrencyBuff := Currency;
            CurrencyBuff.INSERT;
          END;
        END;

        IF CurrencyBuff.Code = '' THEN BEGIN
          HourAccountingLine.SETRANGE("Currency Code",Currency.Code);
          IF NOT HourAccountingLine.ISEMPTY THEN BEGIN
            CurrencyBuff := Currency;
            CurrencyBuff.INSERT;
          END;
        END;

        IF CurrencyBuff.Code = '' THEN BEGIN
          PurchaseLine.SETRANGE("Currency Code",Currency.Code);
          IF NOT PurchaseLine.ISEMPTY THEN BEGIN
            CurrencyBuff := Currency;
            CurrencyBuff.INSERT;
          END;
        END;

        IF (CurrencyBuff.Code = '') AND SubProject.FINDSET THEN BEGIN
          ProjectInstallment.SETRANGE("Currency Code", Currency.Code);
          REPEAT
            ProjectInstallment.SETRANGE("Project No.", SubProject."No.");
            IF NOT ProjectInstallment.ISEMPTY THEN BEGIN
              CurrencyBuff := Currency;
              CurrencyBuff.INSERT;
            END;
          UNTIL (SubProject.NEXT = 0) OR (CurrencyBuff.Code <> '');
        END;
      UNTIL Currency.NEXT = 0;
      //**4PS.en BI042 KD 01-12-16
    END;

    LOCAL PROCEDURE CreateForecastInPeriodFromPurcFCY@1100529406(ProjectForecastLine@1100525000 : Record 11020631;VAR ProjectForecastinPeriodPurch@1100529400 : TEMPORARY Record 11020632);
    BEGIN
      //**4PS.sn BI042 KD 13-12-16
      IF ProjectForecastLine."Cost Type" = ProjectForecastLine."Cost Type"::Labor THEN
        EXIT;

      ProjectForecastinPeriodPurch.SETRANGE("Project No.", ProjectForecastLine."Project No.");
      ProjectForecastinPeriodPurch.SETRANGE("Forecast Date", ProjectForecastLine."Forecast Date");
      CASE Project."Forecast Level" OF
        Project."Forecast Level"::"Element - Cost Object":
          BEGIN
            ProjectForecastinPeriodPurch.SETRANGE(Element, ProjectForecastLine.Element);
            ProjectForecastinPeriodPurch.SETRANGE("Cost Object", ProjectForecastLine."Cost Object");
          END;
        Project."Forecast Level"::"Element - Cost Type":
          BEGIN
            ProjectForecastinPeriodPurch.SETRANGE(Element, ProjectForecastLine.Element);
            ProjectForecastinPeriodPurch.SETRANGE("Cost Type", ProjectForecastLine."Cost Type");
          END;
        Project."Forecast Level"::"Cost Object":
          BEGIN
            ProjectForecastinPeriodPurch.SETRANGE("Cost Object", ProjectForecastLine."Cost Object");
          END;
        Project."Forecast Level"::"Cost Type":
          BEGIN
            ProjectForecastinPeriodPurch.SETRANGE("Cost Type", ProjectForecastLine."Cost Type");
          END;
      END;
      ProjectForecastinPeriodPurch.SETRANGE("Currency Code", ProjectForecastLine."Currency Code");

      IF ProjectForecastinPeriodPurch.FINDSET THEN
        REPEAT
          InsertForecastInPeriod(
            ProjectForecastLine, ProjectForecastinPeriodPurch."Document No.", ProjectForecastinPeriodPurch.Date,
            ProjectForecastinPeriodPurch.Quantity, ProjectForecastinPeriodPurch.Amount,
            ProjectForecastinPeriodPurch.Source);
        UNTIL ProjectForecastinPeriodPurch.NEXT = 0;
      //**4PS.en BI042 KD 13-12-16
    END;

    LOCAL PROCEDURE GetProjectSetup@1100529601();
    BEGIN
      IF HasGotProjectSetup THEN
        EXIT;
      ProjectSetup.GET;
      HasGotProjectSetup := TRUE;
    END;

    PROCEDURE AddRisksAndOpportunities@1100528201(IProjectForecastHeader@1100528800 : Record 11020630) Successful : Boolean;
    VAR
      Job@1100528200 : Record 11072003;
      ProjectElement@1100528210 : Record 11012010;
      Amounts@1100528203 : ARRAY [4] OF Decimal;
      CostObjects@1100528208 : ARRAY [4] OF Code[20];
    BEGIN
      ProjectForecastHeader := IProjectForecastHeader;
      WITH ProjectForecastHeader DO BEGIN
        Job.GET("Project No.");
        IF Job."Forecast Level" IN [Job."Forecast Level"::"Cost Type", Job."Forecast Level"::"Element - Cost Type"] THEN
          EXIT;
        GetCostObjects(CostObjects);
        GetRiskAndOpportunityValues(CostObjects,Amounts);
        IF (Job."Forecast Level" = Job."Forecast Level"::"Element - Cost Object") THEN BEGIN
          ProjectElement.SETRANGE("Project No.","Project No.");
          IF ProjectElement.FINDFIRST THEN;
        END;
        RemoveRiskAndOpportunityForecastLines(ProjectElement.Element,CostObjects);
        Successful := AddRiskAndOpportunityForecastLines(ProjectElement.Element,CostObjects,Amounts);
        CreateForecastTotals;
      END;
    END;

    LOCAL PROCEDURE GetCostObjects@1100528204(VAR CostObjects@1100528204 : ARRAY [4] OF Code[10]);
    VAR
      JobsSetup@1100528200 : Record 315;
    BEGIN
      JobsSetup.GET;
      JobsSetup.TESTFIELD("Cost Object Risk Cost");
      JobsSetup.TESTFIELD("Cost Object Risk Revenue");
      JobsSetup.TESTFIELD("Cost Object Opportunity Cost");
      JobsSetup.TESTFIELD("Cost Object Opport. Revenue");
      CostObjects[1] := JobsSetup."Cost Object Risk Cost";
      CostObjects[2] := JobsSetup."Cost Object Risk Revenue";
      CostObjects[3] := JobsSetup."Cost Object Opportunity Cost";
      CostObjects[4] := JobsSetup."Cost Object Opport. Revenue";
    END;

    LOCAL PROCEDURE GetRiskAndOpportunityValues@1100528202(CostObjects@1100528204 : ARRAY [4] OF Code[10];VAR Amounts@1100528203 : ARRAY [4] OF Decimal);
    VAR
      RiskOpportunitySchedule@1100528207 : Record 11229900;
      RiskLine@1100528206 : Record 11229903;
      OpportunityLine@1100528205 : Record 11229904;
    BEGIN
      WITH ProjectForecastHeader DO BEGIN
        RiskOpportunitySchedule.SETCURRENTKEY(Source,"Source Code",Date);
        RiskOpportunitySchedule.SETRANGE(Source,RiskOpportunitySchedule.Source::Project);
        RiskOpportunitySchedule.SETRANGE("Source Code","Project No.");
        RiskOpportunitySchedule.SETFILTER(Date, '..%1',"Forecast Date");
        RiskOpportunitySchedule.FINDLAST; //Error when schedule is not present is intentional.
        RiskLine.SETCURRENTKEY(Source,"Source Code","Schedule Date","Line No.");
        RiskLine.SETRANGE(Source,RiskLine.Source::Project);
        RiskLine.SETRANGE("Source Code","Project No.");
        RiskLine.SETRANGE("Schedule Date",RiskOpportunitySchedule.Date);
        IF RiskLine.FINDFIRST THEN BEGIN
          RiskLine.CALCFIELDS("Total Anticipated Cost","Total Anticipated Sales");
          Amounts[1] := RiskLine."Total Anticipated Cost";
          Amounts[2] := RiskLine."Total Anticipated Sales";
        END;
        OpportunityLine.SETCURRENTKEY(Source,"Source Code","Schedule Date","Line No.");
        OpportunityLine.SETRANGE(Source,OpportunityLine.Source::Project);
        OpportunityLine.SETRANGE("Source Code","Project No.");
        OpportunityLine.SETRANGE("Schedule Date", RiskOpportunitySchedule.Date);
        IF OpportunityLine.FINDFIRST THEN BEGIN
          OpportunityLine.CALCFIELDS("Total Anticipated Cost","Total Anticipated Sales");
          Amounts[3] := OpportunityLine."Total Anticipated Cost";
          Amounts[4] := OpportunityLine."Total Anticipated Sales";
        END;
      END;
    END;

    LOCAL PROCEDURE RemoveRiskAndOpportunityForecastLines@1100528206(ProjectElement@1100528203 : Code[20];CostObjects@1100528202 : ARRAY [4] OF Code[20]);
    VAR
      DimensionValue@1100528201 : Record 349;
      ProjectForecastLine@1100528200 : Record 11020631;
      I@1100528205 : Integer;
    BEGIN
      WITH ProjectForecastHeader DO BEGIN
        FOR I := 1 TO 4 DO BEGIN
          DimensionValue.SETRANGE("Global Dimension No.",2);
          DimensionValue.SETRANGE(Code,CostObjects[I]);
          DimensionValue.FINDFIRST;
          IF ProjectForecastLine.GET("Project No.","Forecast Date",DimensionValue."Cost Type",ProjectElement,DimensionValue.Code, '') THEN BEGIN
            ProjectForecastLine.VALIDATE(Amount,0);
            ProjectForecastLine.MODIFY(TRUE);
          END;
        END;
      END;
    END;

    LOCAL PROCEDURE AddRiskAndOpportunityForecastLines@1100528205(ProjectElement@1100528204 : Code[20];CostObjects@1100528201 : ARRAY [4] OF Code[20];Amounts@1100528206 : ARRAY [4] OF Decimal) Successful : Boolean;
    VAR
      DimensionValue@1100528202 : Record 349;
      ProjectForecastLine@1100528203 : Record 11020631;
      I@1100528205 : Integer;
    BEGIN
      WITH ProjectForecastHeader DO BEGIN
        FOR I := 1 TO 4 DO BEGIN
          DimensionValue.SETRANGE("Global Dimension No.",2);
          DimensionValue.SETRANGE(Code,CostObjects[I]);
          DimensionValue.FINDFIRST;
          IF (I IN [2,4]) AND (DimensionValue."Cost Type" <> DimensionValue."Cost Type"::Revenue) THEN
            Amounts[I] := -1 * Amounts[I];
          IF ProjectForecastLine.GET("Project No.","Forecast Date",DimensionValue."Cost Type",ProjectElement,DimensionValue.Code, '') THEN BEGIN
            ProjectForecastLine.VALIDATE(Amount,ProjectForecastLine.Amount+Amounts[I]);
            ProjectForecastLine.MODIFY(TRUE);
            Successful := TRUE;
          END ELSE BEGIN
            ProjectForecastLine.INIT;
            ProjectForecastLine."Project No." := "Project No.";
            ProjectForecastLine."Forecast Date" := "Forecast Date";
            ProjectForecastLine."Cost Type" := DimensionValue."Cost Type";
            ProjectForecastLine.Element := ProjectElement;
            ProjectForecastLine."Cost Object" := DimensionValue.Code;
            ProjectForecastLine."Currency Code" := '';
            ProjectForecastLine.VALIDATE(Amount,Amounts[I]);
            ProjectForecastLine.INSERT(TRUE);
            Successful := TRUE;
          END;
        END;
      END;
    END;

    BEGIN
    {
      4PS 27-07-2016 UKR-C21180 OTRO: added distribution by S-Curve (BI019)
      4PS 09-08-16 UKR-C25269 KD: Fill forecast & progress with planning activities (BI045) - Added trigger FillForecastFromPlanning
      4PS 19-08-16 UKR-C26352 KD: Foreign currency in the forecast (BI042) - added sorting by "Currency Code" added to triggers; added trigger CalcInstallmentInvoicedPriceFCY
    }
    END.
  }
}

