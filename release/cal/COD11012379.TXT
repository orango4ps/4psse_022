OBJECT Codeunit 11012379 PostingMercashMgt
{
  OBJECT-PROPERTIES
  {
    Date=;
    Time=;
    Version List=4PS14.00;
  }
  PROPERTIES
  {
    OnRun=BEGIN
          END;

  }
  CODE
  {
    VAR
      GLSetup@1100525005 : Record 98;
      JobJnlLine@1100525000 : Record 11072008;
      ServJnlLine@1100525003 : Record 11012820;
      JobJnlPostLine@1100525001 : Codeunit 11072003;
      ServJnlPostLine@1100525002 : Codeunit 11012802;

    PROCEDURE Post4PS@1100525002(GenJnlLine@1100525001 : Record 81;VAR GenJnlPostLine@1100525000 : Codeunit 12);
    BEGIN
      GLSetup.GET;

      WITH GenJnlLine DO BEGIN
        IF "Receiving Company" = '' THEN BEGIN
          IF "Job No." <> '' THEN BEGIN
            PostProject(GenJnlLine,TRUE);
            PostComplementaryWIPProj(GenJnlLine,GenJnlPostLine);
            PostSurcharge(GenJnlLine,0,GenJnlPostLine);
          END;
          IF "Service Order No." <> '' THEN BEGIN
            PostService(GenJnlLine);
            PostComplementaryWIPServ(GenJnlLine,GenJnlPostLine);
            PostSurcharge(GenJnlLine,1,GenJnlPostLine);
          END;
        END ELSE BEGIN
          CheckPostIC(GenJnlLine);
          IF "Job No." <> '' THEN BEGIN
            PostProject(GenJnlLine,FALSE);
            PostComplementaryWIPProj(GenJnlLine,GenJnlPostLine);
            PostSurchargeIC(GenJnlLine,0,GenJnlPostLine);
          END;
          IF "Service Order No." <> '' THEN BEGIN
            PostComplementaryWIPServ(GenJnlLine,GenJnlPostLine);
            PostSurchargeIC(GenJnlLine,1,GenJnlPostLine);
          END;
        END;

      END;
    END;

    PROCEDURE PostProject@1210190007(GenJnlLine@1100525002 : Record 81;lvPost@1100525000 : Boolean);
    VAR
      DimVal@1100525001 : Record 349;
      DimMgt@1100525003 : Codeunit 408;
    BEGIN
      WITH GenJnlLine DO BEGIN

        IF ("Receiving Company" <> '') THEN
          DimVal.CHANGECOMPANY("Receiving Company");

        DimMgt.GetDimValueRec(2, "Shortcut Dimension 2 Code", DimVal, TRUE, "Job No.");

        // Post project entries
        JobJnlLine.INIT;
        JobJnlLine."Posting Date" := "Posting Date";
        JobJnlLine."Document Date" := "Document Date";
        JobJnlLine."Job No." := "Job No.";
        JobJnlLine."No." := "Account No.";
        JobJnlLine.Description := Description;
        JobJnlLine."Description 2" := "Description 2";
        JobJnlLine."Posting Group" := "Posting Group";
        JobJnlLine."Shortcut Dimension 1 Code" := "Shortcut Dimension 1 Code";
        JobJnlLine."Shortcut Dimension 2 Code" := "Shortcut Dimension 2 Code";
        JobJnlLine."Dimension Set ID" := "Dimension Set ID";
        JobJnlLine."Gen. Bus. Posting Group" := "Gen. Bus. Posting Group";
        JobJnlLine."Gen. Prod. Posting Group" := "Gen. Prod. Posting Group";
        JobJnlLine."Document No." := "Document No.";
        JobJnlLine."External Document No." := "External Document No.";
        JobJnlLine.Type := JobJnlLine.Type::"G/L Account";
      //JobJnlLine.Quantity := Quantity; //C030182.o
        JobJnlLine."Unit of Measure Code" := "Unit of Measure Code";
        IF DimVal."Cost Type" = DimVal."Cost Type"::Revenue THEN BEGIN
          JobJnlLine."Entry Type" := JobJnlLine."Entry Type"::Sale;
          JobJnlLine.Quantity := -Quantity; //C030182.n
          IF Quantity = 0 THEN
            JobJnlLine."Unit Price (LCY)" := -"VAT Base Amount (LCY)"
          ELSE
            JobJnlLine."Unit Price (LCY)" := -"VAT Base Amount (LCY)"/Quantity;
          JobJnlLine."Total Price (LCY)" := -ROUND("VAT Base Amount (LCY)");
          JobJnlLine."Source Currency Total Price" := -ROUND("Source Curr. VAT Base Amount");
        END ELSE BEGIN
          JobJnlLine."Entry Type" := JobJnlLine."Entry Type"::Usage;
          JobJnlLine.Quantity := Quantity; //C030182.n
          IF Quantity = 0 THEN
            JobJnlLine."Direct Unit Cost (LCY)" := "VAT Base Amount (LCY)"
          ELSE
            JobJnlLine."Direct Unit Cost (LCY)" := "VAT Base Amount (LCY)"/Quantity;
          JobJnlLine."Unit Cost (LCY)" := JobJnlLine."Direct Unit Cost (LCY)";
          JobJnlLine."Total Cost (LCY)" := ROUND("VAT Base Amount (LCY)");
          JobJnlLine."Source Currency Total Cost" := ROUND("Source Curr. VAT Base Amount");
        END;
        JobJnlLine."Reason Code" := "Reason Code";
        JobJnlLine."Source Code" := "Source Code";
        JobJnlLine."Posting No. Series" := "Posting No. Series";
        JobJnlLine."Source Currency Code" := "Currency Code";
        JobJnlLine."Employee No." := "Employee No.";
        JobJnlLine."Wage Component" := "Wage Component";
        JobJnlLine.Element := Element;
        JobJnlLine."Extension Contract" := "Extension Contract";
        JobJnlLine."Item No." := "Item No.";
        JobJnlLine."Basic Item" := "Basic Item";
        JobJnlLine."Trade Item" := "Trade Item";
        JobJnlLine."Vendor (Trade Item)" := "Vendor (Trade Item)";
        JobJnlLine.Manufacturer := Manufacturer;
        JobJnlLine."Service Order No." := "Service Order No.";
        JobJnlLine."Service Contract No." := "Service Contract No.";
        JobJnlLine."Service Location No." := "Service Location No.";
        JobJnlLine."Rental Unit" := "Rental Unit";
        JobJnlLine."Purchase Action" := "Purchase Action";
        JobJnlLine."Project Interest" := "Project Interest";
        JobJnlLine."Cost Component" := "Cost Component";
        JobJnlLine."Execution Date" := "Expected Enddate";

        IF NOT lvPost THEN
          EXIT;

        JobJnlPostLine.SetOriginSalaryApplication("Origin Salary Application");
        JobJnlPostLine.RunWithCheck(JobJnlLine);
        JobJnlPostLine.SetOriginSalaryApplication(FALSE);
      END;
    END;

    PROCEDURE PostService@1210190002(GenJnlLine@1100525000 : Record 81);
    VAR
      DimVal@1100525002 : Record 349;
      DimMgt@1100525001 : Codeunit 408;
    BEGIN
      WITH GenJnlLine DO BEGIN

        IF ("Receiving Company" <> '') THEN
          DimVal.CHANGECOMPANY("Receiving Company");

        DimMgt.GetDimValueRec(2, "Shortcut Dimension 2 Code", DimVal, TRUE, "Job No.");

        ServJnlLine.INIT;
        ServJnlLine."Service Contract No." := "Service Contract No.";
        ServJnlLine."Service Order No." := "Service Order No.";
        ServJnlLine."Service Location No." := "Service Location No.";
        ServJnlLine."Service Category" := "Service Category";
        ServJnlLine."Document No." := "Document No.";
        ServJnlLine."G/L Account" := "Account No.";
        ServJnlLine."Posting Date" := "Posting Date";
        ServJnlLine."Shortcut Dimension 1 Code" := "Shortcut Dimension 1 Code";
        ServJnlLine."Shortcut Dimension 2 Code" := "Shortcut Dimension 2 Code";
        ServJnlLine."Dimension Set ID" := "Dimension Set ID";
        ServJnlLine.Description := Description;
        ServJnlLine."Description 2" := "Description 2";
        ServJnlLine.Quantity := Quantity;
        ServJnlLine."Unit of Measure Code" := "Unit of Measure Code";
        ServJnlLine."Currency Code" := "Currency Code";
        IF DimVal."Cost Type" = DimVal."Cost Type"::Revenue THEN BEGIN
          IF Quantity = 0 THEN
            ServJnlLine.VALIDATE("Sales Price (LCY)", -"VAT Base Amount (LCY)")
          ELSE
            ServJnlLine.VALIDATE("Sales Price (LCY)", -"VAT Base Amount (LCY)"/Quantity);
          ServJnlLine.VALIDATE("Total Revenue (LCY)", -ROUND("VAT Base Amount (LCY)"));
        END ELSE BEGIN
          IF Quantity = 0 THEN
            ServJnlLine.VALIDATE("Unit Cost (LCY)", "VAT Base Amount (LCY)")
          ELSE
            ServJnlLine.VALIDATE("Unit Cost (LCY)", "VAT Base Amount (LCY)" / Quantity);
          ServJnlLine.VALIDATE("Total Cost (LCY)", ROUND("VAT Base Amount (LCY)"));
        END;
        ServJnlLine."Employee No." := "Employee No.";
        ServJnlLine."Wage Component" := "Wage Component";
        ServJnlLine."Source Code" := "Source Code";
        ServJnlLine."Reason Code" := "Reason Code";
        ServJnlLine."Item No." := "Item No.";
        ServJnlLine."Basic Item" := "Basic Item";
        ServJnlLine."Trade Item" := "Trade Item";
        ServJnlLine."Vendor (Trade Item)" := "Vendor (Trade Item)";
        ServJnlLine.Manufacturer := Manufacturer;
        ServJnlLine."Project No." := "Job No.";
        ServJnlLine."Additional Cost" := "Additional Cost (Service)";
        ServJnlLine."Cost Component" := "Cost Component";
        ServJnlLine."Execution Date" := "Expected Enddate";

        ServJnlPostLine.RunWithCheck(ServJnlLine);
      END;
    END;

    PROCEDURE PostSurcharge@1210190009(GenJnlLine@1100525000 : Record 81;lvOrigin@1210190002 : 'Project,Service';VAR GenJnlPostLine@1100525013 : Codeunit 12);
    VAR
      ProjectType@1100525003 : Record 11012009;
      Project@1100525002 : Record 11072003;
      ServiceOrder@1100525001 : Record 11012823;
      ServiceType@1100525004 : Record 11012814;
      Employee@1100525007 : Record 5200;
      SurchargeRec@1100525008 : Record 11020208;
      DimVal@1100525006 : Record 349;
      SurchDimVal@1100525009 : Record 349;
      JobJnlLine2@1100525011 : Record 11072008;
      ServJnlLine2@1100525010 : Record 11012820;
      GenJnlLine2@1100525012 : Record 81;
      DimMgt@1100525005 : Codeunit 408;
      lvType@1210190003 : Code[20];
      lvOrigDim1@1210190009 : Code[20];
      lvOrigDim2@1210190010 : Code[20];
      lvDim1@1210190004 : Code[20];
      lvDim2@1210190005 : Code[20];
      lvAccount@1210190008 : Code[20];
      lvDesc@1210190006 : Text[50];
      lvDesc2@1100485000 : Text[50];
      lvCostTotal@1210190007 : Decimal;
      lvCostComp@1100485002 : Code[20];
      lvTotSurchAmount@1100485003 : Decimal;
      lvTotSurchAmount2@1100485004 : Decimal;
      DimensionSetID@1100525014 : Integer;
    BEGIN
      //lvOrigin: 0=project, 1=service

      WITH GenJnlLine DO BEGIN
        IF lvOrigin = lvOrigin::Project THEN BEGIN
          IF "Service Order No." <> '' THEN EXIT;
          Project.GET("Job No.");
          lvType := Project."Project Type";
          ProjectType.GET(Project."Project Type");
        END;
        IF lvOrigin = lvOrigin::Service THEN BEGIN
          ServiceOrder.GET("Service Order No.");
          IF "Additional Cost (Service)" THEN
            lvType := ServiceOrder."Service Type (Other)"
          ELSE
            lvType := ServiceOrder."Service Type";
          ServiceType.GET(lvType);
        END;

        lvOrigDim1 := "Shortcut Dimension 1 Code";
        lvOrigDim2 := "Shortcut Dimension 2 Code";
        DimMgt.GetDimValueRec(2, lvOrigDim2, DimVal, TRUE, '');

        IF ("Employee No." <> '') THEN
          IF Employee.GET("Employee No.") THEN;

        IF SurchargeRec.GetSurcharges(
          lvOrigin, lvType, "Job No.",
          (DimVal."Cost Type" <> DimVal."Cost Type"::Revenue),
          DimVal."Cost Type", DimVal.Code, "Wage Component",
          lvOrigDim1, Employee."Trade Association", "Cost Component", "Posting Date",
          SurchargeRec) THEN
        BEGIN
          REPEAT
            SurchargeRec.GetSurchargeDimVal(DimVal, SurchDimVal);
            SurchargeRec.TESTFIELD("Coverage Account");

            IF lvOrigin = lvOrigin::Project THEN BEGIN
              JobJnlLine2 := JobJnlLine;
              JobJnlLine2.InitSurcharge(JobJnlLine2, DimVal, SurchDimVal,
                                        SurchargeRec, lvOrigDim1, lvType, lvTotSurchAmount, '');
              lvDim1 := JobJnlLine2."Shortcut Dimension 1 Code";
              lvDim2 := JobJnlLine2."Shortcut Dimension 2 Code";
              DimensionSetID := JobJnlLine2."Dimension Set ID"; //C027276
              lvCostComp := JobJnlLine2."Cost Component";
              lvDesc := JobJnlLine2.Description;
              lvDesc2 := JobJnlLine2."Description 2";
              lvCostTotal := JobJnlLine2."Total Cost (LCY)";
              lvAccount:= JobJnlLine2."No.";
            END;
            IF lvOrigin = lvOrigin::Service THEN BEGIN
              ServJnlLine2 := ServJnlLine;
              ServJnlLine2.InitSurcharge(ServJnlLine2, DimVal, SurchDimVal,
                                         SurchargeRec, lvOrigDim1, lvType, lvTotSurchAmount, '');
              lvDim1 := ServJnlLine2."Shortcut Dimension 1 Code";
              lvDim2 := ServJnlLine2."Shortcut Dimension 2 Code";
              DimensionSetID := ServJnlLine2."Dimension Set ID"; //C027276
              lvCostComp := ServJnlLine2."Cost Component";
              lvDesc := ServJnlLine2.Description;
              lvDesc2 := ServJnlLine2."Description 2";
              lvCostTotal := ServJnlLine2."Total Cost (LCY)";
              lvAccount:= ServJnlLine2."G/L Account";
            END;

            IF lvOrigin = lvOrigin::Project THEN BEGIN
              JobJnlPostLine.SetOriginSalaryApplication("Origin Salary Application");
              JobJnlPostLine.RunWithCheck(JobJnlLine2);
              JobJnlPostLine.SetOriginSalaryApplication(FALSE);
            END;
            IF lvOrigin = lvOrigin::Service THEN BEGIN
              ServJnlPostLine.RunWithCheck(ServJnlLine2);
              IF "Job No." <> '' THEN BEGIN
                Project.GET("Job No.");
                lvType := Project."Project Type";
                JobJnlLine2 := JobJnlLine;
                JobJnlLine2.InitSurcharge(JobJnlLine2, DimVal, SurchDimVal,
                                          SurchargeRec, lvOrigDim1, lvType, lvTotSurchAmount2,'');
                JobJnlLine2."Direct Unit Cost (LCY)" := lvCostTotal;
                JobJnlLine2."Unit Cost (LCY)" := lvCostTotal;
                JobJnlLine2."Total Cost (LCY)" := lvCostTotal;
                JobJnlLine2."No." := lvAccount;
                JobJnlPostLine.SetOriginSalaryApplication("Origin Salary Application");
                JobJnlPostLine.RunWithCheck(JobJnlLine2);
                JobJnlPostLine.SetOriginSalaryApplication(FALSE);
              END;
            END;

            GenJnlLine2.INIT;
            GenJnlLine2."Source Code" := GenJnlLine."Source Code";
            GenJnlLine2."Reason Code" := GenJnlLine."Reason Code";
            GenJnlLine2."Journal Template Name" := GenJnlLine."Journal Template Name";
            GenJnlLine2."Journal Batch Name" := GenJnlLine."Journal Batch Name";
            GenJnlLine2."Line No." := GenJnlLine."Line No.";
            GenJnlLine2."Account Type" := GenJnlLine2."Account Type"::"G/L Account";
            GenJnlLine2."Account No." := lvAccount;
            GenJnlLine2."Posting Date" := GenJnlLine."Posting Date";
            GenJnlLine2."Document Type" := GenJnlLine."Document Type";
            GenJnlLine2."Document No." := GenJnlLine."Document No.";
            GenJnlLine2."Document Date" := GenJnlLine."Document Date";
            GenJnlLine2."System-Created Entry" := TRUE;
            GenJnlLine2."Job No." := GenJnlLine."Job No.";
            IF (GenJnlLine."Job No." <> '') AND (SurchargeRec."Element Surcharge" <> '') THEN
              GenJnlLine2.Element := SurchargeRec."Element Surcharge"
            ELSE
              GenJnlLine2.Element := GenJnlLine.Element;
            GenJnlLine2."Extension Contract" := GenJnlLine."Extension Contract";
            GenJnlLine2."Service Order No." := GenJnlLine."Service Order No.";
            GenJnlLine2."Service Contract No." := GenJnlLine."Service Contract No.";
            GenJnlLine2."Service Location No." := GenJnlLine."Service Location No.";
            GenJnlLine2."Service Category" := GenJnlLine."Service Category";
            GenJnlLine2."Shortcut Dimension 1 Code" := lvDim1;
            GenJnlLine2."Shortcut Dimension 2 Code" := lvDim2;
            GenJnlLine2."Dimension Set ID" := DimensionSetID; //C027276
      //C027276.so
      //    DimMgt.ValidateShortcutDimValues(1,GenJnlLine2."Shortcut Dimension 1 Code",GenJnlLine2."Dimension Set ID");
      //    DimMgt.ValidateShortcutDimValues(2,GenJnlLine2."Shortcut Dimension 2 Code",GenJnlLine2."Dimension Set ID");
      //C027276.eo
            GenJnlLine2."Cost Component" := lvCostComp;
            GenJnlLine2.Description := lvDesc;
            GenJnlLine2."Description 2" := lvDesc2;
            GenJnlLine2.Amount := lvCostTotal;
            GenJnlLine2.VALIDATE(Amount);

            //Post Debit Line
            GenJnlPostLine.RunWithoutCheck(GenJnlLine2);

            IF (lvOrigin = lvOrigin::Project) AND ProjectType."Post Complementary Surcharge" THEN
              PostComplementaryWIPSurcharge(lvOrigin,ProjectType.GetComplWipAccSurch(DimVal."Cost Type",''),GenJnlLine2,GenJnlPostLine);

            IF (lvOrigin = lvOrigin::Service) AND ServiceType."Post Complementary Surcharge" THEN
              PostComplementaryWIPSurcharge(lvOrigin,ServiceType.GetComplWipAccSurch(DimVal."Cost Type",''),GenJnlLine2,GenJnlPostLine);

            //Post Credit Line
            GenJnlLine2."Account No." := SurchargeRec."Coverage Account";
            GenJnlLine2."Shortcut Dimension 1 Code" := '';
            CASE SurchargeRec."Source Type Department" OF
              SurchargeRec."Source Type Department"::Employee:
                IF Employee.GET("Employee No.") THEN
                  GenJnlLine2."Shortcut Dimension 1 Code" := Employee."Global Dimension 1 Code";
              SurchargeRec."Source Type Department"::Job:
                GenJnlLine2."Shortcut Dimension 1 Code" := lvDim1;
              SurchargeRec."Source Type Department"::Fixed:
                GenJnlLine2."Shortcut Dimension 1 Code" := SurchargeRec."Coverage Department"
            END;
            GenJnlLine2."Shortcut Dimension 2 Code" := lvDim2;
            DimMgt.ValidateShortcutDimValues(1,GenJnlLine2."Shortcut Dimension 1 Code",GenJnlLine2."Dimension Set ID");
            DimMgt.ValidateShortcutDimValues(2,GenJnlLine2."Shortcut Dimension 2 Code",GenJnlLine2."Dimension Set ID");

            IF SurchargeRec."Compress Coverage Posting" THEN BEGIN
              GenJnlLine2."Cost Component" := '';
              GenJnlLine2."Job No." := '';
              GenJnlLine2.Element := '';
              GenJnlLine2."Extension Contract" := '';
              GenJnlLine2."Service Order No." := '';
              GenJnlLine2."Service Contract No." := '';
              GenJnlLine2."Service Location No." := '';
              GenJnlLine2."Service Category" := '';
            END;

            GenJnlLine2.Amount := lvCostTotal * -1;

            GenJnlPostLine.RunWithoutCheck(GenJnlLine2);

            GenJnlLine2."Shortcut Dimension 1 Code" := lvDim1;
            GenJnlLine2."Shortcut Dimension 2 Code" := lvDim2;
            DimMgt.ValidateShortcutDimValues(1,GenJnlLine2."Shortcut Dimension 1 Code",GenJnlLine2."Dimension Set ID");
            DimMgt.ValidateShortcutDimValues(2,GenJnlLine2."Shortcut Dimension 2 Code",GenJnlLine2."Dimension Set ID");
            GenJnlLine2."Cost Component" := lvCostComp;

            IF lvOrigin = lvOrigin::Project THEN BEGIN
              GenJnlLine2."Closed Project No." := JobJnlLine."Job No.";
              GenJnlLine2."Closed Service Order No." := JobJnlLine."Service Order No.";
              GenJnlLine2."Closed Service Contract No." := JobJnlLine."Service Contract No.";
            END;
            IF lvOrigin = lvOrigin::Service THEN BEGIN
              GenJnlLine2."Closed Project No." := ServJnlLine."Project No.";
              GenJnlLine2."Closed Service Order No." := ServJnlLine."Service Order No.";
              GenJnlLine2."Closed Service Contract No." := ServJnlLine."Service Contract No.";
            END;

            IF (lvOrigin = lvOrigin::Project) AND ProjectType."Post Complementary Surcharge" THEN
              PostComplementaryWIPSurcharge(
                lvOrigin,ProjectType.GetComplWIPCoverAccSurch(DimVal."Cost Type",''),GenJnlLine2,GenJnlPostLine);

            IF (lvOrigin = lvOrigin::Service) AND ServiceType."Post Complementary Surcharge" THEN
              PostComplementaryWIPSurcharge(
                lvOrigin,ServiceType.GetComplWIPCoverAccSurch(DimVal."Cost Type",''),GenJnlLine2,GenJnlPostLine);

          UNTIL SurchargeRec.NEXT = 0;
        END;
      END;
    END;

    PROCEDURE PostSurchargeIC@1100525000(GenJnlLine@1100525006 : Record 81;lvOrigin@1210190000 : 'Project,Service,Indirect,InterCompany';VAR GenJnlPostLine@1100525003 : Codeunit 12);
    VAR
      IntercompanyRelation@1100525000 : Record 11012057;
      lvPostingSetup@1100525002 : Record 11020565;
      Project@1100525007 : Record 11072003;
      ServiceOrder@1100525009 : Record 11012823;
      SurchargeRec@1100525011 : Record 11020208;
      DimVal@1100525008 : Record 349;
      JobJnlLine2@1100525015 : Record 11072008;
      ServJnlLine2@1100525014 : Record 11012820;
      GenJnlLine2@1100525013 : Record 81;
      SurchDimVal@1100525012 : Record 349;
      DimMgt@1100525010 : Codeunit 408;
      lvType@1210190008 : Code[20];
      lvOrigDim1@1210190007 : Code[20];
      lvOrigDim2@1210190006 : Code[20];
      lvDim1@1210190005 : Code[20];
      lvDim2@1210190004 : Code[20];
      lvAccount@1210190003 : Code[20];
      lvDesc@1210190002 : Text[50];
      lvCostTotal@1210190001 : Decimal;
      lvcostComp@1100485001 : Code[20];
      lvTotSurchAmount@1100485002 : Decimal;
      lvSourceType@1100525001 : 'Fixed,EmplOrFixed';
    BEGIN
      IntercompanyRelation.GET(COMPANYNAME, GenJnlLine."Receiving Company");

      IF lvOrigin = lvOrigin::Project THEN BEGIN
        IF GenJnlLine."Service Order No." <> '' THEN EXIT;
        Project.CHANGECOMPANY(GenJnlLine."Receiving Company");
        DimVal.CHANGECOMPANY(GenJnlLine."Receiving Company");
        Project.GET(GenJnlLine."Job No.");
        lvType := Project."Project Type";
        lvOrigDim1 := Project."Global Dimension 1 Code";
      END;

      IF lvOrigin = lvOrigin::Service THEN BEGIN
        ServiceOrder.CHANGECOMPANY(GenJnlLine."Receiving Company");
        DimVal.CHANGECOMPANY(GenJnlLine."Receiving Company");
        ServiceOrder.GET(GenJnlLine."Service Order No.");
        IF GenJnlLine."Additional Cost (Service)" = TRUE THEN
          lvType := ServiceOrder."Service Type (Other)"
        ELSE
          lvType := ServiceOrder."Service Type";
        lvOrigDim1 := ServiceOrder."Global Dimension 1 Code";
      END;

      lvOrigDim2 := GenJnlLine."Shortcut Dimension 2 Code";
      DimMgt.GetDimValueRec(2, lvOrigDim2, DimVal, TRUE, '');

      IF SurchargeRec.GetSurchargesIC(
        lvOrigin::InterCompany,lvType, GenJnlLine."Job No.",
        (DimVal."Cost Type" <> DimVal."Cost Type"::Revenue),
        DimVal."Cost Type", DimVal.Code, '',
        lvOrigDim1, '', GenJnlLine."Cost Component", GenJnlLine."Posting Date",
        SurchargeRec, COMPANYNAME, lvSourceType::Fixed) THEN
      BEGIN
        REPEAT
          SurchargeRec.GetSurchargeDimVal(DimVal, SurchDimVal);
          SurchargeRec.TESTFIELD("Coverage Account");

          IF lvOrigin = lvOrigin::Project THEN BEGIN
            JobJnlLine2."Job No." := GenJnlLine."Job No.";
            JobJnlLine2."Total Cost (LCY)" := GenJnlLine.Amount;
            JobJnlLine2."Quantity (Base)" := GenJnlLine.Quantity;
            JobJnlLine2.Quantity := GenJnlLine.Quantity;

            JobJnlLine2.InitSurchargeIC(JobJnlLine2, DimVal, SurchDimVal, SurchargeRec, lvOrigDim1, lvType,
                                        lvTotSurchAmount, GenJnlLine."Receiving Company");

            lvDim1 := JobJnlLine2."Shortcut Dimension 1 Code";
            lvDim2 := JobJnlLine2."Shortcut Dimension 2 Code";
            lvcostComp := JobJnlLine2."Cost Component";
            lvDesc := JobJnlLine2.Description;
            lvCostTotal := JobJnlLine2."Total Cost (LCY)";
            lvAccount:= JobJnlLine2."No.";
          END;

          IF lvOrigin = lvOrigin::Service THEN BEGIN
            ServJnlLine2."Service Order No." := GenJnlLine."Service Order No.";
            ServJnlLine2."Service Category" := GenJnlLine."Service Category";
            ServJnlLine2."Total Cost (LCY)" := GenJnlLine.Amount;
            ServJnlLine2.Quantity := GenJnlLine.Quantity;

            ServJnlLine2.InitSurchargeIC(ServJnlLine2, DimVal, SurchDimVal, SurchargeRec, lvOrigDim1,
                                         lvType, lvTotSurchAmount, GenJnlLine."Receiving Company");

            lvDim1 := ServJnlLine2."Shortcut Dimension 1 Code";
            lvDim2 := ServJnlLine2."Shortcut Dimension 2 Code";
            lvcostComp := ServJnlLine2."Cost Component";
            lvDesc := ServJnlLine2.Description;
            lvCostTotal := ServJnlLine2."Total Cost (LCY)";
            lvAccount:= ServJnlLine2."G/L Account";
          END;

          //Post Debit Line
          GenJnlLine2.INIT;
          GenJnlLine2."Source Code" := GenJnlLine."Source Code";
          GenJnlLine2."Reason Code" := GenJnlLine."Reason Code";
          GenJnlLine2."Journal Template Name" := GenJnlLine."Journal Template Name";
          GenJnlLine2."Journal Batch Name" := GenJnlLine."Journal Batch Name";
          GenJnlLine2."Line No." := GenJnlLine."Line No.";
          GenJnlLine2."Account Type" := GenJnlLine2."Account Type"::"G/L Account";
          GenJnlLine2."Account No." := IntercompanyRelation.GetICAccountOfCurrentCompany;
          GenJnlLine2."Posting Date" := GenJnlLine."Posting Date";
          GenJnlLine2."Document Type" := GenJnlLine."Document Type";
          GenJnlLine2."Document No." := GenJnlLine."Document No.";
          GenJnlLine2."Document Date" := GenJnlLine."Document Date";
          GenJnlLine2."System-Created Entry" := TRUE;
          GenJnlLine2."Receiving Company" := GenJnlLine."Receiving Company";
          GenJnlLine2."Intercompany Transaction" := TRUE;
          GenJnlLine2."Employee No." := GenJnlLine."Employee No.";
          GenJnlLine2."Shortcut Dimension 1 Code" := lvDim1;
          GenJnlLine2.Description := lvDesc;
          GenJnlLine2.Amount := lvCostTotal;
          GenJnlLine2.VALIDATE(Amount);

          DimMgt.SetCompany(GenJnlLine2."Receiving Company");                                                           //**4PS DP00387 sn
          DimMgt.ValidateShortcutDimValues(1,GenJnlLine2."Shortcut Dimension 1 Code",GenJnlLine2."Dimension Set ID");
          DimMgt.ValidateShortcutDimValues(2,GenJnlLine2."Shortcut Dimension 2 Code",GenJnlLine2."Dimension Set ID");
          DimMgt.SetCompany(COMPANYNAME);

          CheckPostIC(GenJnlLine2); // ??
          GenJnlLine2.VALIDATE(Amount);

          GenJnlPostLine.RunWithoutCheck(GenJnlLine2);

          lvPostingSetup.INIT;

          IF (lvOrigin IN [lvOrigin::Project,lvOrigin::Service]) AND
             (lvPostingSetup.GET(GenJnlLine."Source Code", COMPANYNAME, GenJnlLine."Receiving Company")) THEN
          BEGIN
            lvPostingSetup.TESTFIELD("Prod. Account Debit");
            lvPostingSetup.TESTFIELD("Prod. Account Credit");
            PostComplementaryWIPSurcharge(
              lvOrigin,lvPostingSetup."Prod. Account Debit",GenJnlLine2,GenJnlPostLine);
          END;

          //Post Credit Line
          GenJnlLine2."Account No." := SurchargeRec."Coverage Account";
          GenJnlLine2."Shortcut Dimension 1 Code" := '';
          CASE SurchargeRec."Source Type Department" OF
            SurchargeRec."Source Type Department"::Job:
              GenJnlLine2."Shortcut Dimension 1 Code" := lvDim1;
            SurchargeRec."Source Type Department"::Fixed:
              GenJnlLine2."Shortcut Dimension 1 Code" := SurchargeRec."Coverage Department"
          END;
          GenJnlLine2."Receiving Company" := '';
          GenJnlLine2."Intercompany Transaction" := FALSE;
          DimMgt.ValidateShortcutDimValues(1,GenJnlLine2."Shortcut Dimension 1 Code",GenJnlLine2."Dimension Set ID");
          DimMgt.ValidateShortcutDimValues(2,GenJnlLine2."Shortcut Dimension 2 Code",GenJnlLine2."Dimension Set ID");

          IF SurchargeRec."Compress Coverage Posting" THEN BEGIN
            GenJnlLine2."Cost Component" := '';
            GenJnlLine2."Job No." := '';
            GenJnlLine2.Element := '';
            GenJnlLine2."Extension Contract" := '';
            GenJnlLine2."Service Order No." := '';
            GenJnlLine2."Service Contract No." := '';
            GenJnlLine2."Service Location No." := '';
            GenJnlLine2."Service Category" := '';
          END;
          GenJnlLine2.Amount := lvCostTotal * -1;

          GenJnlPostLine.RunWithoutCheck(GenJnlLine2);

          GenJnlLine2."Shortcut Dimension 1 Code" := lvDim1;
          GenJnlLine2."Shortcut Dimension 2 Code" := lvDim2;
          DimMgt.ValidateShortcutDimValues(1,GenJnlLine2."Shortcut Dimension 1 Code",GenJnlLine2."Dimension Set ID");
          DimMgt.ValidateShortcutDimValues(2,GenJnlLine2."Shortcut Dimension 2 Code",GenJnlLine2."Dimension Set ID");
          GenJnlLine2."Cost Component" := lvcostComp;

          IF lvOrigin = lvOrigin::Project THEN BEGIN
            GenJnlLine2."Closed Project No." := JobJnlLine."Job No.";
            GenJnlLine2."Closed Service Order No." := JobJnlLine."Service Order No.";
            GenJnlLine2."Closed Service Contract No." := JobJnlLine."Service Contract No.";
          END;
          IF lvOrigin = lvOrigin::Service THEN BEGIN
            GenJnlLine2."Closed Project No." := ServJnlLine."Project No.";
            GenJnlLine2."Closed Service Order No." := ServJnlLine."Service Order No.";
            GenJnlLine2."Closed Service Contract No." := ServJnlLine."Service Contract No.";
          END;

          IF (lvOrigin = lvOrigin::Project) AND (lvPostingSetup."Prod. Account Credit" <> '') THEN
            PostComplementaryWIPSurcharge(
              lvOrigin,lvPostingSetup."Prod. Account Credit",GenJnlLine2,GenJnlPostLine);

          IF (lvOrigin = lvOrigin::Service) AND (lvPostingSetup."Prod. Account Credit" <> '')  THEN
            PostComplementaryWIPSurcharge(
              lvOrigin,lvPostingSetup."Prod. Account Credit",GenJnlLine2,GenJnlPostLine);

        UNTIL SurchargeRec.NEXT = 0;
      END;
    END;

    PROCEDURE PostComplementaryWIPProj@1100485002(GenJnlLine@1100485004 : Record 81;VAR GenJnlPostLine@1100525006 : Codeunit 12);
    VAR
      VendorRec@1100485002 : Record 23;
      Customer@1100529600 : Record 18;
      GenJnlLine1@1100485006 : Record 81;
      ProjectType@1100525003 : Record 11012009;
      Project@1100525002 : Record 11072003;
      DimVal@1100525005 : Record 349;
      DimMgt@1100525004 : Codeunit 408;
      AccountNo@1100485005 : Code[20];
      Dim1@1100485007 : Code[20];
      lvPostingSetup@1100525000 : Record 11020565;
    BEGIN
      IF GenJnlLine."Account No." = '' THEN
        EXIT;

      IF (JobJnlLine."Total Cost (LCY)" = 0) AND
         (JobJnlLine."Total Price (LCY)" = 0) THEN
        EXIT;

      WITH GenJnlLine DO BEGIN

        IF "Receiving Company" = '' THEN BEGIN
          Project.GET("Job No.");
          Project.TESTFIELD("Project Type");
          ProjectType.GET(Project."Project Type");
          DimMgt.GetDimValueRec(2,"Shortcut Dimension 2 Code",DimVal,TRUE,'');

          IF DimVal."Cost Type" <> DimVal."Cost Type"::Revenue THEN BEGIN
            IF (JobJnlLine."Total Cost (LCY)" = 0) OR
               (NOT ProjectType."Post Complementary Costs") THEN
              EXIT;
          END ELSE BEGIN
            IF (JobJnlLine."Total Price (LCY)" = 0) OR
               (NOT ProjectType."Post Complementary Revenues") OR
               JobJnlLine."Advance Payment"
            THEN
              EXIT;
          END;
        END ELSE BEGIN
          IF (JobJnlLine."Total Cost (LCY)" = 0) THEN
            EXIT;
          IF NOT lvPostingSetup.GET("Source Code", COMPANYNAME, "Receiving Company") THEN
            EXIT;
        END;

        IF ("Account Type" = "Account Type"::Vendor) THEN
          VendorRec.GET("Account No.");
        IF "Account Type" = "Account Type"::Customer THEN
          Customer.GET("Account No.");

        IF "Receiving Company" = '' THEN
          DimMgt.GetDimValueRec(2,"Shortcut Dimension 2 Code",DimVal,TRUE,'')
        ELSE
          "Shortcut Dimension 2 Code" := '';

        //Dimensions
        Dim1 := '';

        IF "Receiving Company" = '' THEN
          Dim1 := JobJnlLine."Shortcut Dimension 1 Code";

        DimMgt.ValidateShortcutDimValues(1,GenJnlLine."Shortcut Dimension 1 Code",GenJnlLine."Dimension Set ID");
        DimMgt.ValidateShortcutDimValues(2,GenJnlLine."Shortcut Dimension 2 Code",GenJnlLine."Dimension Set ID");

        //Post Debit Line
        IF "Receiving Company" = '' THEN
          AccountNo := ProjectType.GetComplWIPCoverAcc(DimVal."Cost Type",VendorRec."Vendor Posting Group",Customer."Customer Posting Group")
        ELSE BEGIN
          lvPostingSetup.TESTFIELD("Prod. Account Debit");
          AccountNo := lvPostingSetup."Prod. Account Debit";
        END;

        GenJnlLine1.INIT;
        GenJnlLine1."Journal Template Name" := "Journal Template Name";
        GenJnlLine1."Journal Batch Name" := "Journal Batch Name";
        GenJnlLine1."Source Code" := "Source Code";
        GenJnlLine1."Reason Code":= "Reason Code";
        GenJnlLine1."Account Type" := GenJnlLine1."Account Type"::"G/L Account";
        GenJnlLine1."Account No." := AccountNo;
        GenJnlLine1."Posting Date" := "Posting Date";
        GenJnlLine1."Document Type" := "Document Type";
        GenJnlLine1."Document No." := "Document No.";
        GenJnlLine1."System-Created Entry" := TRUE;
        GenJnlLine1."Document Date" := "Document Date";
        GenJnlLine1.Description := Description;
        GenJnlLine1."Description 2" := "Description 2";
        GenJnlLine1."Bal. Account No." := '';
        IF ("Receiving Company" = '') AND
           (DimVal."Cost Type" = DimVal."Cost Type"::Revenue) THEN
          GenJnlLine1.Amount := -JobJnlLine."Total Price (LCY)"
        ELSE
          GenJnlLine1.Amount := -JobJnlLine."Total Cost (LCY)";
        GenJnlLine1.VALIDATE(Amount);
        GenJnlLine1."Shortcut Dimension 1 Code" := Dim1;
        GenJnlLine1."Shortcut Dimension 2 Code" := "Shortcut Dimension 2 Code";
        GenJnlLine1."Dimension Set ID" := "Dimension Set ID";
        DimMgt.ValidateShortcutDimValues(1,GenJnlLine1."Shortcut Dimension 1 Code",GenJnlLine1."Dimension Set ID");
        DimMgt.ValidateShortcutDimValues(2,GenJnlLine1."Shortcut Dimension 2 Code",GenJnlLine1."Dimension Set ID");

        GenJnlLine1."Closed Project No." := "Job No.";
        GenJnlLine1."Origin Type" := "Origin Type";
        GenJnlLine1."Cost Component" := "Cost Component";

        GenJnlPostLine.RunWithCheck(GenJnlLine1);

        //Post Credit Line
        IF "Receiving Company" = '' THEN
          AccountNo := ProjectType.GetComplWipAcc(DimVal."Cost Type",VendorRec."Vendor Posting Group",Customer."Customer Posting Group")
        ELSE BEGIN
          lvPostingSetup.TESTFIELD("Prod. Account Credit");
          AccountNo := lvPostingSetup."Prod. Account Credit";
        END;

        GenJnlLine1.INIT;
        GenJnlLine1."Journal Template Name" := "Journal Template Name";
        GenJnlLine1."Journal Batch Name" := "Journal Batch Name";
        GenJnlLine1."Source Code" := "Source Code";
        GenJnlLine1."Reason Code":= "Reason Code";
        GenJnlLine1."Account Type" := GenJnlLine1."Account Type"::"G/L Account";
        GenJnlLine1."Account No." := AccountNo;
        GenJnlLine1."Posting Date" := "Posting Date";
        GenJnlLine1."Document Type" := "Document Type";
        GenJnlLine1."Document No." := "Document No.";
        GenJnlLine1."System-Created Entry" := TRUE;
        GenJnlLine1."Document Date" := "Document Date";
        GenJnlLine1.Description := Description;
        GenJnlLine1."Description 2" := "Description 2";
        GenJnlLine1."Bal. Account No." := '';
        IF ("Receiving Company" = '') AND
           (DimVal."Cost Type" = DimVal."Cost Type"::Revenue) THEN
          GenJnlLine1.Amount := JobJnlLine."Total Price (LCY)"
        ELSE
          GenJnlLine1.Amount := JobJnlLine."Total Cost (LCY)";
        GenJnlLine1.VALIDATE(Amount);
        GenJnlLine1."Shortcut Dimension 1 Code" := Dim1;
        GenJnlLine1."Shortcut Dimension 2 Code" := "Shortcut Dimension 2 Code";
        GenJnlLine1."Dimension Set ID" := "Dimension Set ID";
        DimMgt.ValidateShortcutDimValues(1,GenJnlLine1."Shortcut Dimension 1 Code",GenJnlLine1."Dimension Set ID");
        DimMgt.ValidateShortcutDimValues(2,GenJnlLine1."Shortcut Dimension 2 Code",GenJnlLine1."Dimension Set ID");

        GenJnlLine1."Closed Project No." := "Job No.";
        GenJnlLine1."Origin Type" := "Origin Type";
        GenJnlLine1."Cost Component" := "Cost Component";

        GenJnlPostLine.RunWithCheck(GenJnlLine1);
      END;
    END;

    PROCEDURE PostComplementaryWIPServ@1100485005(GenJnlLine@1100485004 : Record 81;VAR GenJnlPostLine@1100525001 : Codeunit 12);
    VAR
      Vendor@1100485002 : Record 23;
      Customer@1100529600 : Record 18;
      ServiceOrder@1100525004 : Record 11012823;
      ServiceType@1100485003 : Record 11012814;
      GenJnlLine1@1100485006 : Record 81;
      AccountNo@1100485005 : Code[20];
      Dim1@1100485007 : Code[20];
      lvPostingSetup@1100525000 : Record 11020565;
      DimVal@1100525003 : Record 349;
      DimMgt@1100525002 : Codeunit 408;
    BEGIN
      IF GenJnlLine."Account No." = '' THEN
        EXIT;

      IF DimVal."Cost Type" = DimVal."Cost Type"::Revenue THEN
        EXIT;

      IF ServJnlLine."Total Cost (LCY)" = 0 THEN
        EXIT;

      WITH GenJnlLine DO BEGIN

        IF "Receiving Company" = '' THEN BEGIN
          ServiceOrder.GET("Service Order No.");
          ServiceOrder.TESTFIELD("Service Type");
          ServiceType.GET(ServiceOrder."Service Type");
          IF NOT ServiceType."Post Complementary Costs" THEN
            EXIT;
        END ELSE BEGIN
          IF NOT lvPostingSetup.GET("Source Code", COMPANYNAME, GenJnlLine."Receiving Company") THEN
            EXIT;
        END;

        IF ("Account Type" = "Account Type"::Vendor) THEN
          Vendor.GET("Account No.");
        IF "Account Type" = "Account Type"::Customer THEN
          Customer.GET("Account No.");

        IF GenJnlLine."Receiving Company" = '' THEN
          DimMgt.GetDimValueRec(2,"Shortcut Dimension 2 Code",DimVal,TRUE,'')
        ELSE
          "Shortcut Dimension 2 Code" := '';

        //Dimensions
        Dim1 := '';
        IF GenJnlLine."Receiving Company" = '' THEN
          Dim1 := ServJnlLine."Shortcut Dimension 1 Code";
        DimMgt.ValidateShortcutDimValues(1,GenJnlLine."Shortcut Dimension 1 Code",GenJnlLine."Dimension Set ID");
        DimMgt.ValidateShortcutDimValues(2,GenJnlLine."Shortcut Dimension 2 Code",GenJnlLine."Dimension Set ID");

        //Post Debit Line
        IF "Receiving Company" = '' THEN
          AccountNo := ServiceType.GetComplWIPCoverAcc(DimVal."Cost Type",Vendor."Vendor Posting Group",Customer."Customer Posting Group",ServiceOrder)
        ELSE BEGIN
          lvPostingSetup.TESTFIELD("Prod. Account Debit");
          AccountNo := lvPostingSetup."Prod. Account Debit";
        END;

        GenJnlLine1.INIT;
        GenJnlLine1."Journal Template Name" := GenJnlLine."Journal Template Name";
        GenJnlLine1."Journal Batch Name" := GenJnlLine."Journal Batch Name";
        GenJnlLine1."Source Code" := "Source Code";
        GenJnlLine1."Reason Code" := "Reason Code";
        GenJnlLine1."Account Type" := GenJnlLine1."Account Type"::"G/L Account";
        GenJnlLine1."Account No." := AccountNo;
        GenJnlLine1."Posting Date" := "Posting Date";
        GenJnlLine1."Document Type" := "Document Type";
        GenJnlLine1."Document No." := "Document No.";
        GenJnlLine1."System-Created Entry" := TRUE;
        GenJnlLine1."Document Date" := "Document Date";
        GenJnlLine1.Description := GenJnlLine.Description;
        GenJnlLine1."Bal. Account No." := '';
        GenJnlLine1.Amount := -ServJnlLine."Total Cost (LCY)";
        GenJnlLine1.VALIDATE(Amount);
        GenJnlLine1."Shortcut Dimension 1 Code" := Dim1;
        GenJnlLine1."Shortcut Dimension 2 Code" := "Shortcut Dimension 2 Code";
        GenJnlLine1."Dimension Set ID" := "Dimension Set ID";
        DimMgt.ValidateShortcutDimValues(1,GenJnlLine1."Shortcut Dimension 1 Code",GenJnlLine1."Dimension Set ID");
        DimMgt.ValidateShortcutDimValues(2,GenJnlLine1."Shortcut Dimension 2 Code",GenJnlLine1."Dimension Set ID");

        GenJnlLine1."Cost Component" := "Cost Component";
        GenJnlLine1."Closed Service Contract No." := "Service Contract No.";
        GenJnlLine1."Closed Service Order No." := "Service Order No.";
        GenJnlLine1."Origin Type" := "Origin Type";
        GenJnlPostLine.RunWithCheck(GenJnlLine1);

        //Post Credit Line
        IF "Receiving Company" = '' THEN
          AccountNo := ServiceType.GetComplWipAcc(DimVal."Cost Type",Vendor."Vendor Posting Group",Customer."Customer Posting Group")
        ELSE BEGIN
          lvPostingSetup.TESTFIELD("Prod. Account Credit");
          AccountNo := lvPostingSetup."Prod. Account Credit";
        END;

        GenJnlLine1.INIT;
        GenJnlLine1."Journal Template Name" := GenJnlLine."Journal Template Name";
        GenJnlLine1."Journal Batch Name" := GenJnlLine."Journal Batch Name";
        GenJnlLine1."Source Code" := "Source Code";
        GenJnlLine1."Reason Code" := "Reason Code";
        GenJnlLine1."Account Type" := GenJnlLine1."Account Type"::"G/L Account";
        GenJnlLine1."Account No." := AccountNo;
        GenJnlLine1."Posting Date" := "Posting Date";
        GenJnlLine1."Document Type" := "Document Type";
        GenJnlLine1."Document No." := "Document No.";
        GenJnlLine1."System-Created Entry" := TRUE;
        GenJnlLine1."Document Date" := "Document Date";
        GenJnlLine1.Description := Description;
        GenJnlLine1."Bal. Account No." := '';
        GenJnlLine1.Amount := ServJnlLine."Total Cost (LCY)";
        GenJnlLine1.VALIDATE(Amount);
        GenJnlLine1."Shortcut Dimension 1 Code" := Dim1;
        GenJnlLine1."Shortcut Dimension 2 Code" := "Shortcut Dimension 2 Code";
        GenJnlLine1."Dimension Set ID" := "Dimension Set ID";
        DimMgt.ValidateShortcutDimValues(1,GenJnlLine1."Shortcut Dimension 1 Code",GenJnlLine1."Dimension Set ID");
        DimMgt.ValidateShortcutDimValues(2,GenJnlLine1."Shortcut Dimension 2 Code",GenJnlLine1."Dimension Set ID");

        GenJnlLine1."Cost Component" := "Cost Component";
        GenJnlLine1."Closed Service Contract No." := "Service Contract No.";
        GenJnlLine1."Closed Service Order No." := "Service Order No.";
        GenJnlLine1."Origin Type" := "Origin Type";
        GenJnlPostLine.RunWithCheck(GenJnlLine1);
      END;
    END;

    PROCEDURE PostComplementaryWIPSurcharge@1100485008(lvOrigin@1100485000 : Integer;lvAccount@1100485004 : Code[20];GenJnlLine@1100485002 : Record 81;VAR GenJnlPostLine@1100525000 : Codeunit 12);
    BEGIN
      //lvOrigin: 0=project, 1=service

      IF GenJnlLine.Amount = 0 THEN
        EXIT;

      WITH GenJnlLine DO BEGIN
        "Account No." := lvAccount;
        GenJnlPostLine.RunWithoutCheck(GenJnlLine);
      END;
    END;

    PROCEDURE CheckPostIC@1100485001(GenJnlLine@1100525000 : Record 81) : Boolean;
    VAR
      GenJnlLineSave@1100525001 : Record 81;
      IntercompanyRelation@1100525002 : Record 11012057;
      DimMgt@1100525003 : Codeunit 408;
    BEGIN
      IF (GenJnlLine."Account Type" <> GenJnlLine."Account Type"::"G/L Account") OR
         (GenJnlLine."Receiving Company" = '') THEN
        EXIT(FALSE);

      GenJnlLineSave := GenJnlLine;

      IntercompanyRelation.GET(COMPANYNAME, GenJnlLine."Receiving Company");

      //C030182.sn
      GenJnlLine."Dimension Set ID" := 0;
      DimMgt.SetCompany(GenJnlLine."Receiving Company");
      DimMgt.ValidateShortcutDimValues(1,GenJnlLine."Shortcut Dimension 1 Code",GenJnlLine."Dimension Set ID");
      DimMgt.ValidateShortcutDimValues(2,GenJnlLine."Shortcut Dimension 2 Code",GenJnlLine."Dimension Set ID");
      //C030182.en

      CreateICEntry(GenJnlLine,IntercompanyRelation);

      GenJnlLine."Account No." := IntercompanyRelation.GetICAccountOfCurrentCompany;
      GenJnlLine."Account Type" := GenJnlLine."Account Type"::"G/L Account";
      GenJnlLine."Job No." := '';
      GenJnlLine.Element := '';
      GenJnlLine."Extension Contract" := '';
      GenJnlLine."Service Order No." := '';
      GenJnlLine."Service Contract No." := '';
      GenJnlLine."Service Location No." := '';
      GenJnlLine."Service Category" := '';
      GenJnlLine."Shortcut Dimension 1 Code" := '';
      GenJnlLine."Shortcut Dimension 2 Code" := '';
      GenJnlLine."Dimension Set ID" := 0;
      GenJnlLine."System-Created Entry" := TRUE;

      GenJnlLine.SetSkipModify(TRUE);
      GenJnlLine."Receiving Company" := '';

      GenJnlLine."Plant Type" := '';
      GenJnlLine.VALIDATE("Account No.");
      IF GenJnlLine."Currency Code" <> GenJnlLineSave."Currency Code" THEN
        GenJnlLine.VALIDATE("Currency Code", GenJnlLineSave."Currency Code");

      GenJnlLine."Receiving Company" := GenJnlLineSave."Receiving Company";
      GenJnlLine."Plant Type" := GenJnlLineSave."Plant Type";
      GenJnlLine.GetPlantPostingGroup;
      //T007402.sn
      IntercompanyRelation.AddICRelationDimsOfCurrentCompany(
        GenJnlLine."Dimension Set ID",GenJnlLine."Shortcut Dimension 1 Code",GenJnlLine."Shortcut Dimension 2 Code");
      //T007402.en
      GenJnlLine.SetSkipModify(FALSE);

      EXIT(TRUE);
    END;

    PROCEDURE CreateICEntry@27(GenJnlLine@1100525002 : Record 81;IntercompanyRelation@1100525003 : Record 11012057);
    VAR
      ICEntryRec@1100525001 : Record 11012058;
      ICCounter@11012000 : Integer;
      lvPostingSetup@1100525000 : Record 11020565;
    BEGIN
      ICEntryRec.LOCKTABLE;
      IF ICEntryRec.FINDLAST THEN
        ICCounter := ICEntryRec."Line No."
      ELSE
        ICCounter := 0;

      ICEntryRec.INIT;
      ICEntryRec."Line No." := ICCounter + 1;
      ICEntryRec."Post in Company" := GenJnlLine."Receiving Company";
      ICEntryRec."Supplying Company" := COMPANYNAME;
      ICEntryRec."Receiving Company" := GenJnlLine."Receiving Company";
      ICEntryRec."Account No." := IntercompanyRelation."Receiving Company IC Account";
      ICEntryRec."Account Type" := GenJnlLine."Account Type";
      ICEntryRec."Bal. Account No." := GenJnlLine."Account No.";
      ICEntryRec.Description := GenJnlLine.Description;
      ICEntryRec."Description 2" := GenJnlLine."Description 2";
      ICEntryRec."Project No." := GenJnlLine."Job No.";
      ICEntryRec.Element := GenJnlLine.Element;
      ICEntryRec."Extension Contract" := GenJnlLine."Extension Contract";
      ICEntryRec."Service Order No." := GenJnlLine."Service Order No.";
      ICEntryRec."Service Contract No." := GenJnlLine."Service Contract No.";
      ICEntryRec."Service Location No." := GenJnlLine."Service Location No.";
      ICEntryRec."Additional Cost (Service)" := GenJnlLine."Additional Cost (Service)";
      ICEntryRec."Item No." := GenJnlLine."Item No.";
      ICEntryRec."Basic Item" := GenJnlLine."Basic Item";
      ICEntryRec."Trade Item" := GenJnlLine."Trade Item";
      ICEntryRec.Manufacturer := GenJnlLine.Manufacturer;
      ICEntryRec."Vendor (Trade Item)" := GenJnlLine."Vendor (Trade Item)";
      ICEntryRec."Cost Object" := GenJnlLine."Shortcut Dimension 2 Code";
      ICEntryRec."Global Dimension 1 Code" := GenJnlLine."Shortcut Dimension 1 Code";
      ICEntryRec."Dimension Set ID" := GenJnlLine."Dimension Set ID";

      ICEntryRec.Quantity := GenJnlLine.Quantity;
      ICEntryRec."Unit of Measure Code" := GenJnlLine."Unit of Measure Code";

      IF (GenJnlLine."Gen. Posting Type" <> 0) AND
         (GenJnlLine."VAT Amount" <> 0 ) AND
         (GenJnlLine."VAT Amount" + GenJnlLine."VAT Base Amount" = GenJnlLine.Amount )
      THEN
        ICEntryRec.Amount := GenJnlLine."VAT Base Amount"
      ELSE
        ICEntryRec.Amount := GenJnlLine.Amount;

      IF ICEntryRec.Quantity = 0 THEN
        ICEntryRec.Price := ICEntryRec.Amount
      ELSE
        ICEntryRec.Price := ICEntryRec.Amount / ICEntryRec.Quantity;
      ICEntryRec."Document No." := GenJnlLine."Document No.";
      ICEntryRec."Posting Date" := GenJnlLine."Posting Date";
      ICEntryRec."Interest Date" := GenJnlLine."Interest Date";
      ICEntryRec."Gen. Bus. Posting Group" := GenJnlLine."Gen. Bus. Posting Group";
      ICEntryRec."Gen. Prod. Posting Group" := GenJnlLine."Gen. Prod. Posting Group";

      IF NOT ((GenJnlLine."Gen. Posting Type" <> 0) AND
              (GenJnlLine."VAT Amount" <> 0 ) AND
              (GenJnlLine."VAT Amount" + GenJnlLine."VAT Base Amount" = GenJnlLine.Amount ))
      THEN BEGIN
        ICEntryRec."Gen. Posting Type" := GenJnlLine."Gen. Posting Type";
        ICEntryRec."VAT Bus. Posting Group" := GenJnlLine."VAT Bus. Posting Group";
        ICEntryRec."VAT Prod. Posting Group" := GenJnlLine."VAT Prod. Posting Group";
      END;

      ICEntryRec."Posting Group" := GenJnlLine."Posting Group";
      ICEntryRec."Plant Type" := GenJnlLine."Plant Type";
      ICEntryRec."Plant No." := GenJnlLine."Plant No.";
      ICEntryRec."Cost Component Plant" := GenJnlLine."Cost Component Plant";
      ICEntryRec."Cost Component" := GenJnlLine."Cost Component";

      ICEntryRec.TESTFIELD("Account No.");
      ICEntryRec.TESTFIELD("Bal. Account No.");
      IF ICEntryRec."Project No." <> '' THEN
        ICEntryRec.TESTFIELD("Cost Object");
      ICEntryRec."Origin Salary Application" := GenJnlLine."Origin Salary Application";

      ICEntryRec."Applies-to Doc. Type" := GenJnlLine."Applies-to Doc. Type";
      ICEntryRec."Applies-to Doc. No." := GenJnlLine."Applies-to Doc. No.";

      ICEntryRec.CheckProjStatusReceivingComp();
      ICEntryRec.CheckProjElemBlockedRecComp();

      IF lvPostingSetup.GET(GenJnlLine."Source Code", COMPANYNAME, GenJnlLine."Receiving Company") THEN
        ICEntryRec."Use IC Vendor Posting Group" := TRUE;

      ICEntryRec."Employee No." := GenJnlLine."Employee No.";
      ICEntryRec."Wage Component" := GenJnlLine."Wage Component";
      ICEntryRec."Execution Date Hours" := GenJnlLine."Expected Enddate";

      ICEntryRec.AddICRelationDims(IntercompanyRelation);

      ICEntryRec.INSERT(TRUE);
    END;

    BEGIN
    END.
  }
}

