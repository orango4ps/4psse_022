OBJECT Page 232 Apply Customer Entries
{
  OBJECT-PROPERTIES
  {
    Date=;
    Time=;
    Version List=NAVW114.04,4PS14.00;
  }
  PROPERTIES
  {
    CaptionML=[ENU=Apply Customer Entries;
               NOR=Utlign kundeposter;
               SVE=Koppla kundtransaktioner];
    InsertAllowed=No;
    DeleteAllowed=No;
    LinksAllowed=No;
    SourceTable=Table21;
    DataCaptionFields=Customer No.;
    PageType=Worksheet;
    PromotedActionCategoriesML=[ENU=New,Process,Report,Line,Entry;
                                NOR=Ny,Prosess,Rapport,Linje,Oppfõring;
                                SVE=Ny,Process,Rapport,Rad,Transaktion];
    ShowFilter=Yes;
    OnInit=BEGIN
             AppliesToIDVisible := TRUE;
           END;

    OnOpenPage=BEGIN
                 //**4PS Generated Code. Do Not Change.sn01
                 DPA_IsHardFilter := DPA_SetFilters(CurrPage.OBJECTID(FALSE));
                 //**4PS Generated Code.en01
                 IF CalcType = CalcType::Direct THEN BEGIN
                   Cust.GET("Customer No.");
                   ApplnCurrencyCode := Cust."Currency Code";
                   FindApplyingEntry;
                 END;

                 SalesSetup.GET;
                 CustNameVisible := SalesSetup."Copy Customer Name to Entries";

                 AppliesToIDVisible := ApplnType <> ApplnType::"Applies-to Doc. No.";

                 GLSetup.GET;

                 IF ApplnType = ApplnType::"Applies-to Doc. No." THEN
                   CalcApplnAmount;
                 PostingDone := FALSE;
               END;

    OnAfterGetRecord=BEGIN
                       StyleTxt := SetStyle;
                     END;

    OnNewRecord=BEGIN
                  //**4PS Generated Code. Do Not Change.sn02
                  DPA_SetDefaultDepartment;
                  //**4PS Generated Code.en02
                END;

    OnInsertRecord=VAR
                     xRecRef@1100000999 : RecordRef;
                   BEGIN
                     //**4PS Generated Code. Do Not Change.sn05
                     xRecRef.GETTABLE(xRec);
                     DPA_SetDefaultDpmtFromNoSeries(xRecRef);
                     //**4PS Generated Code.en05
                   END;

    OnModifyRecord=BEGIN
                     CODEUNIT.RUN(CODEUNIT::"Cust. Entry-Edit",Rec);
                     IF "Applies-to ID" <> xRec."Applies-to ID" THEN
                       CalcApplnAmount;
                     EXIT(FALSE);
                   END;

    OnQueryClosePage=VAR
                       RaiseError@1001 : Boolean;
                     BEGIN
                       IF CloseAction = ACTION::LookupOK THEN
                         LookupOKOnPush;
                       IF ApplnType = ApplnType::"Applies-to Doc. No." THEN BEGIN
                         IF OK THEN BEGIN
                           RaiseError := ApplyingCustLedgEntry."Posting Date" < "Posting Date";
                           OnBeforeEarlierPostingDateError(ApplyingCustLedgEntry,Rec,RaiseError,CalcType);
                           IF RaiseError THEN BEGIN
                             OK := FALSE;
                             //**4PS.so
                             //ERROR(
                             //  EarlierPostingDateErr,ApplyingCustLedgEntry."Document Type",ApplyingCustLedgEntry."Document No.",
                             //  "Document Type","Document No.");
                             //**4PS.eo
                             //**4PS.sn
                             MESSAGE(
                               Text11012001, ApplyingCustLedgEntry."Document Type",ApplyingCustLedgEntry."Document No.",
                               "Document Type","Document No.");
                             //**4PS.en
                           END;
                         END;
                         IF OK THEN BEGIN
                           IF "Amount to Apply" = 0 THEN
                             "Amount to Apply" := "Remaining Amount";
                           IF (NOT gToOtherCompany) AND ("Entry No." <> 0)  THEN  //**4PS.n call 30959
                             CODEUNIT.RUN(CODEUNIT::"Cust. Entry-Edit",Rec);
                         END;
                       END;
                       IF (CalcType = CalcType::Direct) AND NOT OK AND NOT PostingDone THEN BEGIN
                         Rec := ApplyingCustLedgEntry;
                         "Applying Entry" := FALSE;
                         "Applies-to ID" := '';
                         "Amount to Apply" := 0;
                         IF (NOT gToOtherCompany) AND ("Entry No." <> 0)  THEN  //**4PS.n
                           CODEUNIT.RUN(CODEUNIT::"Cust. Entry-Edit",Rec);
                       END;
                     END;

    OnAfterGetCurrRecord=BEGIN
                           IF ApplnType = ApplnType::"Applies-to Doc. No." THEN
                             CalcApplnAmount;
                           HasDocumentAttachment := HasPostedDocAttachment;
                         END;

    ActionList=ACTIONS
    {
      { 1900000003;0 ;ActionContainer;
                      ActionContainerType=RelatedInformation }
      { 37      ;1   ;ActionGroup;
                      CaptionML=[ENU=Ent&ry;
                                 NOR=Po&st;
                                 SVE=Tra&nsaktion];
                      Image=Entry }
      { 38      ;2   ;Action    ;
                      CaptionML=[ENU=Reminder/Fin. Charge Entries;
                                 NOR=Purre-/renteposter;
                                 SVE=Bet.pÜminnelse-/rÑntetrans.];
                      ToolTipML=[ENU=View the reminders and finance charge entries that you have entered for the customer.;
                                 NOR=Vis pÜminnelsene og rentepostene du har angitt for kunden.;
                                 SVE=Visa pÜminnelseavgifterna och rÑnteavgifterna som du har pÜfîrt kunden.];
                      ApplicationArea=#Suite;
                      RunObject=Page 444;
                      RunPageView=SORTING(Customer Entry No.);
                      RunPageLink=Customer Entry No.=FIELD(Entry No.);
                      Promoted=Yes;
                      Image=Reminder;
                      PromotedCategory=Category5 }
      { 95      ;2   ;Action    ;
                      CaptionML=[ENU=Applied E&ntries;
                                 NOR=Utlignede &poster;
                                 SVE=&Kopplade transaktioner];
                      ToolTipML=[ENU=View the ledger entries that have been applied to this record.;
                                 NOR=Vis postene som har blitt brukt for denne posten.;
                                 SVE=Visa transaktionerna som har tillÑmpats pÜ denna post.];
                      ApplicationArea=#Basic,#Suite;
                      RunObject=Page 61;
                      RunPageOnRec=Yes;
                      Promoted=Yes;
                      Image=Approve;
                      PromotedCategory=Category5 }
      { 53      ;2   ;Action    ;
                      AccessByPermission=TableData 348=R;
                      ShortCutKey=Shift+Ctrl+D;
                      CaptionML=[ENU=Dimensions;
                                 NOR=Dimensjoner;
                                 SVE=Dimensioner];
                      ToolTipML=[ENU=View or edit dimensions, such as area, project, or department, that you can assign to sales and purchase documents to distribute costs and analyze transaction history.;
                                 NOR=Vis eller rediger dimensjoner, for eksempel omrÜde, prosjekt eller avdeling, som du kan tilordne til salgs- og kjõpsdokumenter for Ü distribuere kostnader og analysere transaksjonshistorikk.;
                                 SVE=Visa eller redigera mÜtt, till exempel omrÜde, projekt eller avdelning, som du kan tilldela till fîrsÑljnings- och inkîpsdokument fîr att fîrdela kostnader och analysera transaktionshistorik.];
                      ApplicationArea=#Dimensions;
                      Promoted=Yes;
                      Image=Dimensions;
                      PromotedCategory=Category5;
                      OnAction=BEGIN
                                 ShowDimensions;
                               END;
                                }
      { 62      ;2   ;Action    ;
                      ShortCutKey=Ctrl+F7;
                      CaptionML=[ENU=Detailed &Ledger Entries;
                                 NOR=Deta&ljerte poster;
                                 SVE=Detaljerad &reskontra];
                      ToolTipML=[ENU=View a summary of the all posted entries and adjustments related to a specific customer ledger entry.;
                                 NOR=Vis et sammendrag av alle bokfõrte poster og justeringer som er knyttet til en bestemt kundepost.;
                                 SVE=Visa en îversikt av alla bokfîrda transaktioner och justeringar som rîr en viss kundreskontratransaktion.];
                      ApplicationArea=#Basic,#Suite;
                      RunObject=Page 573;
                      RunPageView=SORTING(Cust. Ledger Entry No.,Posting Date);
                      RunPageLink=Cust. Ledger Entry No.=FIELD(Entry No.);
                      Promoted=Yes;
                      Image=View;
                      PromotedCategory=Category5 }
      { 15      ;2   ;Action    ;
                      CaptionML=[ENU=&Navigate;
                                 NOR=&Naviger;
                                 SVE=Anal&ysera];
                      ToolTipML=[ENU=Find all entries and documents that exist for the document number and posting date on the selected entry or document.;
                                 NOR=Finn alle oppfõringer og dokumenter som finnes for dokumentnummeret og bokfõringsdatoen i den valgte oppfõringen eller dokumentet.;
                                 SVE=Sîk efter alla transaktioner och dokument som existerar fîr dokumentnumret och bokfîringsdatumet fîr den valda transaktionen eller det valda dokumentet.];
                      ApplicationArea=#Basic,#Suite;
                      Promoted=Yes;
                      Image=Navigate;
                      PromotedCategory=Category5;
                      OnAction=BEGIN
                                 Navigate.SetDoc("Posting Date","Document No.");
                                 Navigate.RUN;
                               END;
                                }
      { 1900000004;0 ;ActionContainer;
                      ActionContainerType=ActionItems }
      { 13      ;1   ;ActionGroup;
                      CaptionML=[ENU=&Application;
                                 NOR=U&tligning;
                                 SVE=&Koppling];
                      Image=Apply }
      { 11      ;2   ;Action    ;
                      Name=Set Applies-to ID;
                      ShortCutKey=Shift+F11;
                      CaptionML=[ENU=Set Applies-to ID;
                                 NOR=Angi utlignings-ID;
                                 SVE=Koppla till ID];
                      ToolTipML=[ENU=Set the Applies-to ID field on the posted entry to automatically be filled in with the document number of the entry in the journal.;
                                 NOR=Setter Utlignings-ID i den bokfõrte posten ti automatisk utfylling med postens bilagsnummer i kladden.;
                                 SVE=StÑll in fÑltet Koppla till ID pÜ den bokfîrda transaktionen fîr automatisk ifyllning med transaktionens verifikationsnummer i journalen.];
                      ApplicationArea=#Basic,#Suite;
                      Promoted=Yes;
                      Image=SelectLineToApply;
                      PromotedCategory=Process;
                      OnAction=BEGIN
                                 IF (CalcType = CalcType::GenJnlLine) AND (ApplnType = ApplnType::"Applies-to Doc. No.") THEN
                                   ERROR(CannotSetAppliesToIDErr);

                                 SetCustApplId(FALSE);
                               END;
                                }
      { 9       ;2   ;Action    ;
                      Name=Post Application;
                      ShortCutKey=F9;
                      Ellipsis=Yes;
                      CaptionML=[ENU=Post Application;
                                 NOR=Etterutligne;
                                 SVE=Bokfîr kopplade trans.];
                      ToolTipML=[ENU=Define the document number of the ledger entry to use to perform the application. In addition, you specify the Posting Date for the application.;
                                 NOR=Definerer bilagsnummeret i posten som skal brukes til Ü utfõre utligningen. I tillegg kan du angi bokfõringsdatoen for utligningen.;
                                 SVE=Definiera verifikationsnummer pÜ transaktionen som anvÑnds fîr att utfîra kopplingen. Dessutom anges kopplingens bokfîringsdatum.];
                      ApplicationArea=#Basic,#Suite;
                      Promoted=Yes;
                      Image=PostApplication;
                      PromotedCategory=Process;
                      OnAction=BEGIN
                                 PostDirectApplication(FALSE);
                               END;
                                }
      { 7       ;2   ;Action    ;
                      Name=Preview;
                      CaptionML=[ENU=Preview Posting;
                                 NOR=ForhÜndsvis bokfõring;
                                 SVE=Fîrhandsgranska bokfîring];
                      ToolTipML=[ENU=Review the different types of entries that will be created when you post the document or journal.;
                                 NOR=Se gjennom de ulike typene poster som blir opprettet nÜr du bokfõrer dokumentet eller kladden.;
                                 SVE=Granska de olika typer av transaktioner som skapas nÑr du bokfîr dokumentet eller journalen.];
                      ApplicationArea=#Basic,#Suite;
                      Promoted=Yes;
                      Image=ViewPostedOrder;
                      PromotedCategory=Process;
                      OnAction=BEGIN
                                 PostDirectApplication(TRUE);
                               END;
                                }
      { 5       ;2   ;Separator ;
                      CaptionML=[ENU=-;
                                 NOR=-;
                                 SVE=-] }
      { 3       ;2   ;Action    ;
                      CaptionML=[ENU=Show Only Selected Entries to Be Applied;
                                 NOR=Vis bare utvalgte poster som skal utlignes;
                                 SVE=Visa endast valda transaktioner som ska kopplas];
                      ToolTipML=[ENU=View the selected ledger entries that will be applied to the specified record.;
                                 NOR=Viser de valgte finanspostene som utlignes mot den angitte posten.;
                                 SVE=Visa valda transaktioner som kopplas till den angivna posten.];
                      ApplicationArea=#Basic,#Suite;
                      Promoted=Yes;
                      Image=ShowSelected;
                      PromotedCategory=Process;
                      OnAction=BEGIN
                                 ShowAppliedEntries := NOT ShowAppliedEntries;
                                 IF ShowAppliedEntries THEN
                                   IF CalcType = CalcType::GenJnlLine THEN
                                     SETRANGE("Applies-to ID",GenJnlLine."Applies-to ID")
                                   ELSE BEGIN
                                     CustEntryApplID := USERID;
                                     IF CustEntryApplID = '' THEN
                                       CustEntryApplID := '***';
                                     SETRANGE("Applies-to ID",CustEntryApplID);
                                   END
                                 ELSE
                                   SETRANGE("Applies-to ID");
                               END;
                                }
      { 23      ;1   ;Action    ;
                      Name=ShowPostedDocument;
                      CaptionML=[ENU=Show Posted Document;
                                 NOR=Vis bokfõrt dokument;
                                 SVE=Visa bokfîrt dokument];
                      ToolTipML=[ENU=Show details for the posted payment, invoice, or credit memo.;
                                 NOR=Vis detaljer for den bokfõrte betalingen, fakturaen eller kreditnotaen.;
                                 SVE=Visa detaljer om den bokfîrda betalningen, fakturan eller kreditnotan.];
                      ApplicationArea=#Basic,#Suite;
                      Promoted=Yes;
                      PromotedIsBig=Yes;
                      Image=Document;
                      PromotedCategory=Category4;
                      OnAction=BEGIN
                                 ShowDoc
                               END;
                                }
      { 21      ;1   ;Action    ;
                      Name=ShowDocumentAttachment;
                      CaptionML=[ENU=Show Document Attachment;
                                 NOR=Vis dokumentvedlegg;
                                 SVE=Visa dokumentbilaga];
                      ToolTipML=[ENU=View documents or images that are attached to the posted invoice or credit memo.;
                                 NOR=Vis dokumenter eller bilder som er knyttet til den bokfõrte fakturaen eller kreditnotaen.;
                                 SVE=Visa dokument eller bilder som Ñr kopplade till den bokfîrda fakturan eller kreditnotan.];
                      ApplicationArea=#Basic,#Suite;
                      Promoted=Yes;
                      Enabled=HasDocumentAttachment;
                      PromotedIsBig=Yes;
                      Image=Attach;
                      PromotedCategory=Category4;
                      OnAction=BEGIN
                                 ShowPostedDocAttachment;
                               END;
                                }
    }
  }
  CONTROLS
  {
    { 1900000001;0;Container;
                ContainerType=ContentArea }

    { 70  ;1   ;Group     ;
                CaptionML=[ENU=General;
                           NOR=Generelt;
                           SVE=AllmÑnt] }

    { 73  ;2   ;Field     ;
                CaptionML=[ENU=Posting Date;
                           NOR=Bokfõringsdato;
                           SVE=Bokfîringsdatum];
                ToolTipML=[ENU=Specifies the posting date of the entry to be applied.;
                           NOR=Angir bokfõringsdatoen for posten som skal utlignes.;
                           SVE=Anger den kopplade transaktionens bokfîringsdatum.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr=ApplyingCustLedgEntry."Posting Date";
                Editable=FALSE }

    { 75  ;2   ;Field     ;
                CaptionML=[ENU=Document Type;
                           NOR=Bilagstype;
                           SVE=Dokumenttyp];
                ToolTipML=[ENU=Specifies the document type of the entry to be applied.;
                           NOR=Angir dokumenttypen for posten som skal utlignes.;
                           SVE=Anger den kopplade transaktionens dokumenttyp.];
                OptionCaptionML=[ENU=" ,Payment,Invoice,Credit Memo,Finance Charge Memo,Reminder,Refund";
                                 NOR=" ,Betaling,Faktura,Kreditnota,Rentenota,Purring,Refusjon";
                                 SVE=" ,Betalning,Faktura,Kreditnota,RÑntefaktura,BetalningspÜminnelse,èterbetalning"];
                ApplicationArea=#Basic,#Suite;
                SourceExpr=ApplyingCustLedgEntry."Document Type";
                Editable=FALSE }

    { 77  ;2   ;Field     ;
                CaptionML=[ENU=Document No.;
                           NOR=Bilagsnr.;
                           SVE=Dokumentnr];
                ToolTipML=[ENU=Specifies the document number of the entry to be applied.;
                           NOR=Angir bilagsnummeret for posten som skal utlignes.;
                           SVE=Anger den kopplade transaktionens dokumentnummer.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr=ApplyingCustLedgEntry."Document No.";
                Editable=FALSE }

    { 71  ;2   ;Field     ;
                Name=ApplyingCustomerNo;
                CaptionML=[ENU=Customer No.;
                           NOR=Kundenr.;
                           SVE=Kundnr];
                ToolTipML=[ENU=Specifies the customer number of the entry to be applied.;
                           NOR=Angir kundenummeret for posten som skal utlignes.;
                           SVE=Anger den kopplade transaktionens kundnummer.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr=ApplyingCustLedgEntry."Customer No.";
                Visible=FALSE;
                Editable=FALSE }

    { 27  ;2   ;Field     ;
                Name=ApplyingCustomerName;
                CaptionML=[ENU=Customer Name;
                           NOR=Kundenavn;
                           SVE=Kundens namn];
                ToolTipML=[ENU=Specifies the customer name of the entry to be applied.;
                           NOR=Angir kundenummeret for oppfõringen som skal brukes.;
                           SVE=Anger den kopplade transaktionens kundnamn.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr=ApplyingCustLedgEntry."Customer Name";
                Visible=CustNameVisible }

    { 85  ;2   ;Field     ;
                Name=ApplyingDescription;
                CaptionML=[ENU=Description;
                           NOR=Beskrivelse;
                           SVE=Beskrivning];
                ToolTipML=[ENU=Specifies the description of the entry to be applied.;
                           NOR=Angir beskrivelsen for posten som skal utlignes.;
                           SVE=Anger den kopplade transaktionens beskrivning.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr=ApplyingCustLedgEntry.Description;
                Visible=FALSE;
                Editable=FALSE }

    { 79  ;2   ;Field     ;
                CaptionML=[ENU=Currency Code;
                           NOR=Valutakode;
                           SVE=Valutakod];
                ToolTipML=[ENU=Specifies the code for the currency that amounts are shown in.;
                           NOR=Angir koden for valutaen som belõpene vises i.;
                           SVE=Anger i vilken valuta beloppen visas.];
                ApplicationArea=#Suite;
                SourceExpr=ApplyingCustLedgEntry."Currency Code";
                Editable=FALSE }

    { 81  ;2   ;Field     ;
                CaptionML=[ENU=Amount;
                           NOR=Belõp;
                           SVE=Belopp];
                ToolTipML=[ENU=Specifies the amount on the entry to be applied.;
                           NOR=Angir belõpet pÜ posten som skal utlignes.;
                           SVE=Anger den kopplade transaktionens belopp.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr=ApplyingCustLedgEntry.Amount;
                Editable=FALSE }

    { 83  ;2   ;Field     ;
                CaptionML=[ENU=Remaining Amount;
                           NOR=Restbelõp;
                           SVE=èterstÜende belopp];
                ToolTipML=[ENU=Specifies the amount on the entry to be applied.;
                           NOR=Angir belõpet pÜ posten som skal utlignes.;
                           SVE=Anger den kopplade transaktionens belopp.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr=ApplyingCustLedgEntry."Remaining Amount";
                Editable=FALSE }

    { 1   ;1   ;Group     ;
                GroupType=Repeater }

    { 22  ;2   ;Field     ;
                Name=AppliesToID;
                ToolTipML=[ENU=Specifies the ID of entries that will be applied to when you choose the Apply Entries action.;
                           NOR=Angir ID-en for postene som blir utlignet nÜr du velger handlingen Utlign poster.;
                           SVE=Anger id-numret fîr transaktioner som kommer att tillÑmpas nÑr du vÑljer ÜtgÑrden Koppla transaktioner.];
                ApplicationArea=#All;
                SourceExpr="Applies-to ID";
                Visible=AppliesToIDVisible;
                OnValidate=BEGIN
                             IF (CalcType = CalcType::GenJnlLine) AND (ApplnType = ApplnType::"Applies-to Doc. No.") THEN
                               ERROR(CannotSetAppliesToIDErr);

                             SetCustApplId(TRUE);

                             CurrPage.UPDATE(FALSE);
                           END;
                            }

    { 2   ;2   ;Field     ;
                ToolTipML=[ENU=Specifies the customer entry's posting date.;
                           NOR=Angir kundepostens bokfõringsdato.;
                           SVE=Anger kundtransaktionens bokfîringsdatum.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr="Posting Date";
                Editable=FALSE }

    { 4   ;2   ;Field     ;
                ToolTipML=[ENU=Specifies the document type that the customer entry belongs to.;
                           NOR=Angir dokumenttypen som kundeposten tilhõrer.;
                           SVE=Anger dokumenttypen som kundtransaktionen tillhîr.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr="Document Type";
                Editable=FALSE;
                StyleExpr=StyleTxt }

    { 6   ;2   ;Field     ;
                ToolTipML=[ENU=Specifies the entry's document number.;
                           NOR=Angir postens dokumentnummer.;
                           SVE=Anger transaktionens verifikationsnummer.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr="Document No.";
                Editable=FALSE;
                StyleExpr=StyleTxt }

    { 1100485000;2;Field  ;
                SourceExpr="External Document No.";
                Visible=FALSE;
                Editable=FALSE }

    { 8   ;2   ;Field     ;
                ToolTipML=[ENU=Specifies the customer account number that the entry is linked to.;
                           NOR=Angir nummeret pÜ kundekontoen som er knyttet til posten.;
                           SVE=Anger kundkontonumret som posten Ñr kopplad till.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr="Customer No.";
                Editable=FALSE }

    { 25  ;2   ;Field     ;
                ToolTipML=[ENU=Specifies the customer name that the entry is linked to.;
                           NOR=Angir kundenavnet som oppfõringen er koblet til.;
                           SVE=Anger kundnamnet som posten Ñr kopplad till.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr="Customer Name";
                Visible=CustNameVisible;
                Editable=FALSE }

    { 1100485002;2;Field  ;
                DrillDown=No;
                SourceExpr="Actual Customer Name";
                Visible=FALSE }

    { 10  ;2   ;Field     ;
                ToolTipML=[ENU=Specifies a description of the customer entry.;
                           NOR=Angir en beskrivelse av kundeposten.;
                           SVE=Anger en beskrivning av kundtransaktionen.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr=Description;
                Editable=FALSE }

    { 39  ;2   ;Field     ;
                ToolTipML=[ENU=Specifies the currency code for the amount on the line.;
                           NOR=Angir valutakoden for belõpet pÜ linjen.;
                           SVE=Anger valutakoden fîr beloppet pÜ raden.];
                ApplicationArea=#Suite;
                SourceExpr="Currency Code" }

    { 60  ;2   ;Field     ;
                ToolTipML=[ENU=Specifies the amount of the original entry.;
                           NOR=Angir belõpet for den opprinnelige posten.;
                           SVE=Anger den ursprungliga transaktionens belopp.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr="Original Amount";
                Visible=FALSE;
                Editable=FALSE }

    { 12  ;2   ;Field     ;
                ToolTipML=[ENU=Specifies the amount of the entry.;
                           NOR=Angir belõpet for posten.;
                           SVE=Anger transaktionsbeloppet.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr=Amount;
                Visible=FALSE;
                Editable=FALSE }

    { 17  ;2   ;Field     ;
                ToolTipML=[ENU=Specifies the total of the ledger entries that represent debits.;
                           NOR=Angir summen for postene som representerer debet.;
                           SVE=Anger summan av transaktionerna som representerar debet.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr="Debit Amount";
                Visible=FALSE }

    { 19  ;2   ;Field     ;
                ToolTipML=[ENU=Specifies the total of the ledger entries that represent credits.;
                           NOR=Angir summen for postene som representerer kredit.;
                           SVE=Anger summan av transaktionerna som representerar krediter.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr="Credit Amount";
                Visible=FALSE }

    { 14  ;2   ;Field     ;
                ToolTipML=[ENU=Specifies the amount that remains to be applied to before the entry has been completely applied.;
                           NOR=Angir belõpet som gjenstÜr for utligning fõr posten er fullstendig utlignet.;
                           SVE=Anger beloppet som ÜterstÜr att anvÑnda innan transaktionen har tillÑmpats helt.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr="Remaining Amount";
                Editable=FALSE }

    { 33  ;2   ;Field     ;
                CaptionML=[ENU=Appln. Remaining Amount;
                           NOR=Utlign restbelõp;
                           SVE=Koppling Üterst. belopp];
                ToolTipML=[ENU=Specifies the amount that remains to be applied to before the entry is totally applied to.;
                           NOR=Angir belõpet som gjenstÜr Ü bli utlignet, fõr posten utlignes helt.;
                           SVE=Anger beloppet som ÜterstÜr att anvÑnda innan transaktionen Ñr helt anvÑnd.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr=CalcApplnRemainingAmount("Remaining Amount");
                AutoFormatType=1;
                AutoFormatExpr=ApplnCurrencyCode }

    { 89  ;2   ;Field     ;
                ToolTipML=[ENU=Specifies the amount to apply.;
                           NOR=Angir belõpet som skal utlignes.;
                           SVE=Anger belopp att koppla.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr="Amount to Apply";
                OnValidate=BEGIN
                             CODEUNIT.RUN(CODEUNIT::"Cust. Entry-Edit",Rec);

                             IF (xRec."Amount to Apply" = 0) OR ("Amount to Apply" = 0) AND
                                ((ApplnType = ApplnType::"Applies-to ID") OR (CalcType = CalcType::Direct))
                             THEN
                               SetCustApplId(FALSE);
                             GET("Entry No.");
                             AmountToApplyOnAfterValidate;
                           END;
                            }

    { 93  ;2   ;Field     ;
                Name=ApplnAmountToApply;
                CaptionML=[ENU=Appln. Amount to Apply;
                           NOR=Belõp som skal utlignes;
                           SVE=Belopp att koppla];
                ToolTipML=[ENU=Specifies the amount to apply.;
                           NOR=Angir belõpet som skal utlignes.;
                           SVE=Anger belopp att koppla.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr=CalcApplnAmountToApply("Amount to Apply");
                AutoFormatType=1;
                AutoFormatExpr=ApplnCurrencyCode }

    { 16  ;2   ;Field     ;
                ToolTipML=[ENU=Specifies the due date on the entry.;
                           NOR=Angir forfallsdatoen pÜ posten.;
                           SVE=Anger transaktionens fîrfallodatum.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr="Due Date";
                StyleExpr=StyleTxt }

    { 18  ;2   ;Field     ;
                ToolTipML=[ENU=Specifies the date on which the amount in the entry must be paid for a payment discount to be granted.;
                           NOR=Angir datoen da belõpet i posten mÜ vëre betalt for at det kan oppnÜs kontantrabatt.;
                           SVE=Anger datumet dÜ transaktionens belopp mÜste vara betalt fîr att kassarabatten pÜ ordern ska gÑlla.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr="Pmt. Discount Date";
                OnValidate=BEGIN
                             RecalcApplnAmount;
                           END;
                            }

    { 65  ;2   ;Field     ;
                ToolTipML=[ENU=Specifies the last date the amount in the entry must be paid in order for a payment discount tolerance to be granted.;
                           NOR=Angir den siste datoen da belõpet i posten mÜ vëre betalt for at det kan oppnÜs kontantrabatt.;
                           SVE=Anger det sista datumet dÜ transaktionens belopp mÜste vara betalt fîr att kassarabattoleransen ska gÑlla.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr="Pmt. Disc. Tolerance Date" }

    { 20  ;2   ;Field     ;
                ToolTipML=[ENU=Specifies the discount that the customer can obtain if the entry is applied to before the payment discount date.;
                           NOR=Angir rabatten som kunden kan oppnÜ hvis posten blir utlignet fõr kontantrabattdatoen.;
                           SVE=Anger den rabatt som kunden kan fÜ om transaktionen anvÑnds fîre datumet fîr kassarabatt.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr="Original Pmt. Disc. Possible";
                Visible=FALSE }

    { 63  ;2   ;Field     ;
                ToolTipML=[ENU=Specifies the remaining payment discount which can be received if the payment is made before the payment discount date.;
                           NOR=Angir resterende kontantrabatt som kan mottas hvis betalingen foretas fõr kontantrabattdatoen.;
                           SVE=Anger den ÜterstÜende kassarabatt som kan erhÜllas om betalningen gîrs fîre kassarabattsdatumet.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr="Remaining Pmt. Disc. Possible";
                OnValidate=BEGIN
                             RecalcApplnAmount;
                           END;
                            }

    { 51  ;2   ;Field     ;
                CaptionML=[ENU=Appln. Pmt. Disc. Possible;
                           NOR=Mulig utlign.kont.rabatt;
                           SVE=Kopp. erbjudet kassarab.belopp];
                ToolTipML=[ENU=Specifies the discount that the customer can obtain if the entry is applied to before the payment discount date.;
                           NOR=Angir rabatten som kunden kan oppnÜ hvis posten blir utlignet fõr kontantrabattdatoen.;
                           SVE=Anger den rabatt som kunden kan fÜ om transaktionen anvÑnds fîre datumet fîr kassarabatt.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr=CalcApplnRemainingAmount("Remaining Pmt. Disc. Possible");
                AutoFormatType=1;
                AutoFormatExpr=ApplnCurrencyCode }

    { 67  ;2   ;Field     ;
                ToolTipML=[ENU=Specifies the maximum tolerated amount the entry can differ from the amount on the invoice or credit memo.;
                           NOR=Angir det maksimalt tillatte belõpet som posten kan avvike fra belõpet pÜ fakturaen eller kreditnotaen.;
                           SVE=Anger det hîgsta tolererade beloppet som posten fÜr avvika frÜn beloppet pÜ fakturan eller kreditnotan.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr="Max. Payment Tolerance" }

    { 24  ;2   ;Field     ;
                ToolTipML=[ENU=Specifies whether the amount on the entry has been fully paid or there is still a remaining amount that must be applied to.;
                           NOR=Angir om posten er helt utlignet, eller om det stadig gjenstÜr Ü utligne et belõp.;
                           SVE=Anger om postens belopp har betalats eller om det ÜterstÜr ett belopp som mÜste betalas.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr=Open;
                Editable=FALSE }

    { 26  ;2   ;Field     ;
                ToolTipML=[ENU=Specifies if the entry to be applied is positive.;
                           NOR=Angir om posten som skal utlignes er positiv.;
                           SVE=Anger om transaktionen som kopplas Ñr positiv.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr=Positive;
                Editable=FALSE }

    { 54  ;2   ;Field     ;
                ToolTipML=[ENU=Specifies the code for the global dimension that is linked to the record or entry for analysis purposes. Two global dimensions, typically for the company's most important activities, are available on all cards, documents, reports, and lists.;
                           NOR=Angir koden for den globale dimensjonen som er koblet til posten eller oppfõringen for analyse. To globale dimensjoner, vanligvis for selskapets viktigste aktiviteter, er tilgjengelige pÜ alle kort, dokumenter, rapporter og lister.;
                           SVE=Anger koden fîr den globala dimension som Ñr kopplad till posten eller transaktionen fîr analys. TvÜ globala dimensioner, vanligtvis fîr fîretagets viktigaste aktiviteter, finns pÜ alla kort, dokument, rapporter och listor.];
                ApplicationArea=#Dimensions;
                SourceExpr="Global Dimension 1 Code";
                OnValidate=BEGIN
                             //**4PS Generated Code. Do Not Change.sn03
                             DPA_ChkDepartmentCodeAllowed(DPA_IsHardFilter);
                             //**4PS Generated Code.en03
                           END;
                            }

    { 56  ;2   ;Field     ;
                ToolTipML=[ENU=Specifies the code for the global dimension that is linked to the record or entry for analysis purposes. Two global dimensions, typically for the company's most important activities, are available on all cards, documents, reports, and lists.;
                           NOR=Angir koden for den globale dimensjonen som er koblet til posten eller oppfõringen for analyse. To globale dimensjoner, vanligvis for selskapets viktigste aktiviteter, er tilgjengelige pÜ alle kort, dokumenter, rapporter og lister.;
                           SVE=Anger koden fîr den globala dimension som Ñr kopplad till posten eller transaktionen fîr analys. TvÜ globala dimensioner, vanligtvis fîr fîretagets viktigaste aktiviteter, finns pÜ alla kort, dokument, rapporter och listor.];
                ApplicationArea=#Dimensions;
                SourceExpr="Global Dimension 2 Code" }

    { 1100528500;2;Field  ;
                SourceExpr="Blocked Amount (Subcontracting";
                Editable=FALSE }

    { 41  ;1   ;Group      }

    { 1903222401;2;Group  ;
                GroupType=FixedLayout }

    { 1901742001;3;Group  ;
                CaptionML=[ENU=Appln. Currency;
                           NOR=Utlign. valuta;
                           SVE=Koppling valuta] }

    { 48  ;4   ;Field     ;
                ToolTipML=[ENU=Specifies the currency code that the amount will be applied in, in case of different currencies.;
                           NOR=Angir valutakoden som belõpet skal utlignes i, i tilfelle forskjellige valutaer.;
                           SVE=Anger valutakoden som beloppet kopplas till i hÑndelse av olika valutor.];
                ApplicationArea=#Suite;
                SourceExpr=ApplnCurrencyCode;
                TableRelation=Currency;
                Editable=FALSE;
                ShowCaption=No }

    { 1903098801;3;Group  ;
                CaptionML=[ENU=Amount to Apply;
                           NOR=Belõp som skal utlignes;
                           SVE=Belopp att koppla] }

    { 44  ;4   ;Field     ;
                Name=AmountToApply;
                CaptionML=[ENU=Amount to Apply;
                           NOR=Belõp som skal utlignes;
                           SVE=Belopp att koppla];
                ToolTipML=[ENU=Specifies the sum of the amounts on all the selected customer ledger entries that will be applied by the entry shown in the Available Amount field. The amount is in the currency represented by the code in the Currency Code field.;
                           NOR=Angir summen av belõpene for alle valgte kundeposter som skal utlignes av posten i Disponibelt belõp-feltet. Belõpet er i valutaen angitt av koden i Valutakode-feltet.;
                           SVE=Anger summan av beloppen fîr alla valda kundreskontratransaktioner som kopplas till transaktionen som visas i fÑltet Disponibelt belopp. Beloppet Ñr i valutan som representeras av koden i fÑltet Valutakod.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr=AppliedAmount;
                AutoFormatType=1;
                AutoFormatExpr=ApplnCurrencyCode;
                Editable=FALSE }

    { 1902760701;3;Group  ;
                CaptionML=[ENU=Pmt. Disc. Amount;
                           NOR=Betalingsrabattbelõp;
                           SVE=Kassarabattbelopp] }

    { 91  ;4   ;Field     ;
                Name=PmtDiscountAmount;
                CaptionML=[ENU=Pmt. Disc. Amount;
                           NOR=Betalingsrabattbelõp;
                           SVE=Kassarabattbelopp];
                ToolTipML=[ENU=Specifies the sum of the payment discount amounts granted on all the selected customer ledger entries that will be applied by the entry shown in the Available Amount field. The amount is in the currency represented by the code in the Currency Code field.;
                           NOR=Angir summen av kontantrabattbelõpene som er gitt for alle valgte kundeposter som skal utlignes av posten i Disponibelt belõp-feltet. Belõpet er i valutaen angitt av koden i Valutakode-feltet.;
                           SVE=Anger summan av beloppen fîr beviljade kassarabatter pÜ alla valda kundreskontratransaktioner som kopplas till transaktionen som visas i fÑltet Disponibelt belopp. Beloppet Ñr i valutan som representeras av koden i fÑltet Valutakod.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr=-PmtDiscAmount;
                AutoFormatType=1;
                AutoFormatExpr=ApplnCurrencyCode;
                Editable=FALSE }

    { 1901741901;3;Group  ;
                CaptionML=[ENU=Rounding;
                           NOR=Avrunding;
                           SVE=Avrundning] }

    { 58  ;4   ;Field     ;
                CaptionML=[ENU=Rounding;
                           NOR=Avrunding;
                           SVE=Avrundning];
                ToolTipML=[ENU=Specifies the rounding difference when you apply entries in different currencies to one another. The amount is in the currency represented by the code in the Currency Code field.;
                           NOR=Angir avrundingsdifferansen nÜr du utligner poster i forskjellige valutaer mot hverandre. Belõpet er i valutaen angitt av koden i Valutakode-feltet.;
                           SVE=Anger avrundningsdifferensen nÑr du kopplar transaktioner i olika valutor till varandra. Beloppet Ñr i valutan som representeras av koden i fÑltet Valutakod.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr=ApplnRounding;
                AutoFormatType=1;
                AutoFormatExpr=ApplnCurrencyCode;
                Editable=FALSE }

    { 1900546301;3;Group  ;
                CaptionML=[ENU=Applied Amount;
                           NOR=Utlignet belõp;
                           SVE=Kopplat belopp] }

    { 97  ;4   ;Field     ;
                Name=AppliedAmount;
                CaptionML=[ENU=Applied Amount;
                           NOR=Utlignet belõp;
                           SVE=Kopplat belopp];
                ToolTipML=[ENU=Specifies the sum of the amounts in the Amount to Apply field, Pmt. Disc. Amount field, and the Rounding. The amount is in the currency represented by the code in the Currency Code field.;
                           NOR=Angir summen av belõpene i feltene Belõp som skal utlignes, Betalingsrabattbelõp og Avrunding. Belõpet er i valutaen angitt av koden i Valutakode-feltet.;
                           SVE=Anger summan av beloppen i fÑlten Belopp att koppla, Kassarabattbelopp och Avrundning. Beloppet visas i valutan som motsvaras av koden i fÑltet Valutakod.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr=AppliedAmount + (-PmtDiscAmount) + ApplnRounding;
                AutoFormatType=1;
                AutoFormatExpr=ApplnCurrencyCode;
                Editable=FALSE }

    { 1901991601;3;Group  ;
                CaptionML=[ENU=Available Amount;
                           NOR=Disponibelt belõp;
                           SVE=Disponibelt belopp] }

    { 46  ;4   ;Field     ;
                CaptionML=[ENU=Available Amount;
                           NOR=Disponibelt belõp;
                           SVE=Disponibelt belopp];
                ToolTipML=[ENU=Specifies the amount of the journal entry, sales credit memo, or current customer ledger entry that you have selected as the applying entry.;
                           NOR=Angir belõpet for kladdeposten, salgskreditnotaen eller den gjeldende kundeposten du har valgt som utligningspost.;
                           SVE=Anger beloppet fîr journaltransaktionen, fîrsÑljningskreditnotan eller den aktuella kundreskontratransaktionen som du har valt som kopplingstransaktion.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr=ApplyingAmount;
                AutoFormatType=1;
                AutoFormatExpr=ApplnCurrencyCode;
                Editable=FALSE }

    { 1900206001;3;Group  ;
                CaptionML=[ENU=Balance;
                           NOR=Saldo;
                           SVE=Saldo] }

    { 42  ;4   ;Field     ;
                Name=ControlBalance;
                CaptionML=[ENU=Balance;
                           NOR=Saldo;
                           SVE=Saldo];
                ToolTipML=[ENU=Specifies any extra amount that will remain after the application.;
                           NOR=Angir det eventuelle overskytende belõpet etter at utligningen er gjennomfõrt.;
                           SVE=Anger eventuella extra belopp som stÜr kvar efter kopplingen.];
                ApplicationArea=#Basic,#Suite;
                SourceExpr=AppliedAmount + (-PmtDiscAmount) + ApplyingAmount + ApplnRounding;
                AutoFormatType=1;
                AutoFormatExpr=ApplnCurrencyCode;
                Editable=FALSE }

    { 1900000007;0;Container;
                ContainerType=FactBoxArea }

    { 1903096107;1;Part   ;
                ApplicationArea=#Basic,#Suite;
                SubPageLink=Entry No.=FIELD(Entry No.);
                PagePartID=Page9106;
                Visible=TRUE;
                PartType=Page }

  }
  CODE
  {
    VAR
      ApplyingCustLedgEntry@1035 : TEMPORARY Record 21;
      AppliedCustLedgEntry@1001 : Record 21;
      Currency@1002 : Record 4;
      CurrExchRate@1003 : Record 330;
      GenJnlLine@1004 : Record 81;
      GenJnlLine2@1005 : Record 81;
      SalesHeader@1006 : Record 36;
      ServHeader@1045 : Record 5900;
      Cust@1007 : Record 18;
      CustLedgEntry@1008 : Record 21;
      GLSetup@1009 : Record 98;
      SalesSetup@1049 : Record 311;
      TotalSalesLine@1010 : Record 37;
      TotalSalesLineLCY@1011 : Record 37;
      TotalServLine@1046 : Record 5902;
      TotalServLineLCY@1047 : Record 5902;
      CustEntrySetApplID@1013 : Codeunit 101;
      GenJnlApply@1014 : Codeunit 225;
      SalesPost@1015 : Codeunit 80;
      PaymentToleranceMgt@1048 : Codeunit 426;
      Navigate@1012 : Page 344;
      AppliedAmount@1017 : Decimal;
      ApplyingAmount@1018 : Decimal;
      PmtDiscAmount@1041 : Decimal;
      ApplnDate@1019 : Date;
      ApplnCurrencyCode@1020 : Code[10];
      ApplnRoundingPrecision@1021 : Decimal;
      ApplnRounding@1022 : Decimal;
      ApplnType@1023 : ' ,Applies-to Doc. No.,Applies-to ID';
      AmountRoundingPrecision@1024 : Decimal;
      VATAmount@1025 : Decimal;
      VATAmountText@1026 : Text[30];
      StyleTxt@1016 : Text;
      ProfitLCY@1027 : Decimal;
      ProfitPct@1028 : Decimal;
      CalcType@1029 : 'Direct,GenJnlLine,SalesHeader,ServHeader';
      CustEntryApplID@1031 : Code[50];
      ValidExchRate@1032 : Boolean;
      DifferentCurrenciesInAppln@1034 : Boolean;
      Text002@1037 : TextConst 'ENU=You must select an applying entry before you can post the application.;NOR=Du mÜ velge en utligningspost fõr du kan bokfõre utligningen.;SVE=Du mÜste vÑlja en kopplingstransaktion innan du kan bokfîra kopplingen.';
      ShowAppliedEntries@1038 : Boolean;
      Text003@1039 : TextConst 'ENU=You must post the application from the window where you entered the applying entry.;NOR=Du mÜ bokfõre utligningen fra vinduet der du angav utligningsposten.;SVE=Du mÜste bokfîra kopplingen i det fînster dÑr du registrerade kopplingstransaktionen.';
      CannotSetAppliesToIDErr@1030 : TextConst 'ENU=You cannot set Applies-to ID while selecting Applies-to Doc. No.;NOR=Du kan ikke angi utlignings-ID nÜr du velger utligningsbilagsnummer.;SVE=Du fÜr inte ange Koppla till ID nÑr du vÑljer Kopplas till ver.nr.';
      OK@1043 : Boolean;
      EarlierPostingDateErr@1044 : TextConst 'ENU=You cannot apply and post an entry to an entry with an earlier posting date.\\Instead, post the document of type %1 with the number %2 and then apply it to the document of type %3 with the number %4.;NOR=Du kan ikke utligne og bokfõre en post mot en post med en tidligere bokfõringsdato.\\I stedet mÜ du bokfõre dokumentet av typen %1 med nummeret %2 og deretter utligne det mot dokumentet av typen %3 med nummeret %4.;SVE=Det gÜr inte att koppla och bokfîra en transaktion till en transaktion med ett tidigare bokfîringsdatum.\\Bokfîr i stÑllet dokumentet av typen %1 med numret %2 och koppla det till dokumentet av typen %3 med numret %4.';
      PostingDone@1000 : Boolean;
      AppliesToIDVisible@19043506 : Boolean INDATASET;
      Text11012001@1100485000 : TextConst 'ENU=Watch out, %1 %2 has an earlier posting date than %3 %4.;SVE=Observera att %1 %2 har ett tidigare bokfîringsdatum Ñn %3 %4.';
      gToOtherCompany@1100485001 : Boolean;
      DPA_IsHardFilter@1100000999 : Boolean;
      Text012@1036 : TextConst 'ENU=The application was successfully posted.;NOR=Utligningen ble bokfõrt pÜ riktig mÜte.;SVE=Kopplingen Ñr bokfîrd.';
      Text013@1033 : TextConst 'ENU=The %1 entered must not be before the %1 on the %2.;NOR=%1 som er angitt, kan ikke komme fõr %1 pÜ %2.;SVE=Det angivna %1 fÜr inte vara fîre %1 pÜ %2.';
      Text019@1040 : TextConst 'ENU=Post application process has been canceled.;NOR=Etterutligningsprosessen er avbrutt.;SVE=Processen Bokfîr kopplade trans. har avbrutits.';
      HasDocumentAttachment@1042 : Boolean;
      CustNameVisible@1050 : Boolean;

    [External]
    PROCEDURE SetGenJnlLine@1(NewGenJnlLine@1000 : Record 81;ApplnTypeSelect@1001 : Integer);
    BEGIN
      GenJnlLine := NewGenJnlLine;

      IF GenJnlLine."Account Type" = GenJnlLine."Account Type"::Customer THEN
      //**4PS.sn
      BEGIN
        IF GenJnlLine."Receiving Company" <> '' THEN BEGIN
          IF (GenJnlLine."Receiving Company" <> COMPANYNAME) AND (GenJnlLine."Receiving Company" <> '') THEN
            gToOtherCompany := TRUE;
          CHANGECOMPANY(GenJnlLine."Receiving Company");
        END;
      //**4PS.en
        ApplyingAmount := GenJnlLine.Amount;
      END; //**4PS

      IF GenJnlLine."Bal. Account Type" = GenJnlLine."Bal. Account Type"::Customer THEN
        ApplyingAmount := -GenJnlLine.Amount;
      ApplnDate := GenJnlLine."Posting Date";
      ApplnCurrencyCode := GenJnlLine."Currency Code";
      CalcType := CalcType::GenJnlLine;

      CASE ApplnTypeSelect OF
        GenJnlLine.FIELDNO("Applies-to Doc. No."):
          ApplnType := ApplnType::"Applies-to Doc. No.";
        GenJnlLine.FIELDNO("Applies-to ID"):
          ApplnType := ApplnType::"Applies-to ID";
      END;

      SetApplyingCustLedgEntry;
    END;

    [External]
    PROCEDURE SetSales@2(NewSalesHeader@1000 : Record 36;VAR NewCustLedgEntry@1001 : Record 21;ApplnTypeSelect@1002 : Integer);
    VAR
      TotalAdjCostLCY@1003 : Decimal;
    BEGIN
      SalesHeader := NewSalesHeader;
      COPYFILTERS(NewCustLedgEntry);

      SalesPost.SumSalesLines(
        SalesHeader,0,TotalSalesLine,TotalSalesLineLCY,
        VATAmount,VATAmountText,ProfitLCY,ProfitPct,TotalAdjCostLCY);

      CASE SalesHeader."Document Type" OF
        SalesHeader."Document Type"::"Return Order",
        SalesHeader."Document Type"::"Credit Memo":
          ApplyingAmount := -TotalSalesLine."Amount Including VAT"
        ELSE
          ApplyingAmount := TotalSalesLine."Amount Including VAT";
      END;

      ApplnDate := SalesHeader."Posting Date";
      ApplnCurrencyCode := SalesHeader."Currency Code";
      CalcType := CalcType::SalesHeader;

      CASE ApplnTypeSelect OF
        SalesHeader.FIELDNO("Applies-to Doc. No."):
          ApplnType := ApplnType::"Applies-to Doc. No.";
        SalesHeader.FIELDNO("Applies-to ID"):
          ApplnType := ApplnType::"Applies-to ID";
      END;

      SetApplyingCustLedgEntry;
    END;

    [External]
    PROCEDURE SetService@8(NewServHeader@1000 : Record 5900;VAR NewCustLedgEntry@1001 : Record 21;ApplnTypeSelect@1002 : Integer);
    VAR
      ServAmountsMgt@1003 : Codeunit 5986;
      TotalAdjCostLCY@1004 : Decimal;
    BEGIN
      ServHeader := NewServHeader;
      COPYFILTERS(NewCustLedgEntry);

      ServAmountsMgt.SumServiceLines(
        ServHeader,0,TotalServLine,TotalServLineLCY,
        VATAmount,VATAmountText,ProfitLCY,ProfitPct,TotalAdjCostLCY);

      CASE ServHeader."Document Type" OF
        ServHeader."Document Type"::"Credit Memo":
          ApplyingAmount := -TotalServLine."Amount Including VAT"
        ELSE
          ApplyingAmount := TotalServLine."Amount Including VAT";
      END;

      ApplnDate := ServHeader."Posting Date";
      ApplnCurrencyCode := ServHeader."Currency Code";
      CalcType := CalcType::ServHeader;

      CASE ApplnTypeSelect OF
        ServHeader.FIELDNO("Applies-to Doc. No."):
          ApplnType := ApplnType::"Applies-to Doc. No.";
        ServHeader.FIELDNO("Applies-to ID"):
          ApplnType := ApplnType::"Applies-to ID";
      END;

      SetApplyingCustLedgEntry;
    END;

    [External]
    PROCEDURE SetCustLedgEntry@13(NewCustLedgEntry@1000 : Record 21);
    BEGIN
      Rec := NewCustLedgEntry;
    END;

    [External]
    PROCEDURE SetApplyingCustLedgEntry@9();
    VAR
      Customer@1001 : Record 18;
    BEGIN
      OnBeforeSetApplyingCustLedgEntry(AppliedCustLedgEntry,GenJnlLine);

      CASE CalcType OF
        CalcType::SalesHeader:
          BEGIN
            ApplyingCustLedgEntry."Entry No." := 1;
            ApplyingCustLedgEntry."Posting Date" := SalesHeader."Posting Date";
            IF SalesHeader."Document Type" = SalesHeader."Document Type"::"Return Order" THEN
              ApplyingCustLedgEntry."Document Type" := SalesHeader."Document Type"::"Credit Memo"
            ELSE
              ApplyingCustLedgEntry."Document Type" := SalesHeader."Document Type";
            ApplyingCustLedgEntry."Document No." := SalesHeader."No.";
            ApplyingCustLedgEntry."Customer No." := SalesHeader."Bill-to Customer No.";
            ApplyingCustLedgEntry.Description := SalesHeader."Posting Description";
            ApplyingCustLedgEntry."Currency Code" := SalesHeader."Currency Code";
            IF ApplyingCustLedgEntry."Document Type" = ApplyingCustLedgEntry."Document Type"::"Credit Memo" THEN  BEGIN
              ApplyingCustLedgEntry.Amount := -TotalSalesLine."Amount Including VAT";
              ApplyingCustLedgEntry."Remaining Amount" := -TotalSalesLine."Amount Including VAT";
            END ELSE BEGIN
              ApplyingCustLedgEntry.Amount := TotalSalesLine."Amount Including VAT";
              ApplyingCustLedgEntry."Remaining Amount" := TotalSalesLine."Amount Including VAT";
            END;
            CalcApplnAmount;
          END;
        CalcType::ServHeader:
          BEGIN
            ApplyingCustLedgEntry."Entry No." := 1;
            ApplyingCustLedgEntry."Posting Date" := ServHeader."Posting Date";
            ApplyingCustLedgEntry."Document Type" := ServHeader."Document Type";
            ApplyingCustLedgEntry."Document No." := ServHeader."No.";
            ApplyingCustLedgEntry."Customer No." := ServHeader."Bill-to Customer No.";
            ApplyingCustLedgEntry.Description := ServHeader."Posting Description";
            ApplyingCustLedgEntry."Currency Code" := ServHeader."Currency Code";
            IF ApplyingCustLedgEntry."Document Type" = ApplyingCustLedgEntry."Document Type"::"Credit Memo" THEN  BEGIN
              ApplyingCustLedgEntry.Amount := -TotalServLine."Amount Including VAT";
              ApplyingCustLedgEntry."Remaining Amount" := -TotalServLine."Amount Including VAT";
            END ELSE BEGIN
              ApplyingCustLedgEntry.Amount := TotalServLine."Amount Including VAT";
              ApplyingCustLedgEntry."Remaining Amount" := TotalServLine."Amount Including VAT";
            END;
            CalcApplnAmount;
          END;
        CalcType::Direct:
          BEGIN
            IF "Applying Entry" THEN BEGIN
              IF ApplyingCustLedgEntry."Entry No." <> 0 THEN
                CustLedgEntry := ApplyingCustLedgEntry;
              CODEUNIT.RUN(CODEUNIT::"Cust. Entry-Edit",Rec);
              IF "Applies-to ID" = '' THEN
                SetCustApplId(FALSE);
              CALCFIELDS(Amount);
              ApplyingCustLedgEntry := Rec;
              IF CustLedgEntry."Entry No." <> 0 THEN BEGIN
                Rec := CustLedgEntry;
                "Applying Entry" := FALSE;
                SetCustApplId(FALSE);
              END;
              SETFILTER("Entry No.",'<> %1',ApplyingCustLedgEntry."Entry No.");
              ApplyingAmount := ApplyingCustLedgEntry."Remaining Amount";
              ApplnDate := ApplyingCustLedgEntry."Posting Date";
              ApplnCurrencyCode := ApplyingCustLedgEntry."Currency Code";
            END;
            CalcApplnAmount;
          END;
        CalcType::GenJnlLine:
          BEGIN
            ApplyingCustLedgEntry."Entry No." := 1;
            ApplyingCustLedgEntry."Posting Date" := GenJnlLine."Posting Date";
            ApplyingCustLedgEntry."Document Type" := GenJnlLine."Document Type";
            ApplyingCustLedgEntry."Document No." := GenJnlLine."Document No.";
            IF GenJnlLine."Bal. Account Type" = GenJnlLine."Account Type"::Customer THEN BEGIN
              ApplyingCustLedgEntry."Customer No." := GenJnlLine."Bal. Account No.";
              Customer.GET(ApplyingCustLedgEntry."Customer No.");
              ApplyingCustLedgEntry.Description := Customer.Name;
            END ELSE BEGIN
              ApplyingCustLedgEntry."Customer No." := GenJnlLine."Account No.";
              ApplyingCustLedgEntry.Description := GenJnlLine.Description;
            END;
            ApplyingCustLedgEntry."Currency Code" := GenJnlLine."Currency Code";
            ApplyingCustLedgEntry.Amount := GenJnlLine.Amount;
            ApplyingCustLedgEntry."Remaining Amount" := GenJnlLine.Amount;
            CalcApplnAmount;
          END;
      END;
    END;

    [External]
    PROCEDURE SetCustApplId@11(CurrentRec@1000 : Boolean);
    VAR
      RaiseError@1001 : Boolean;
    BEGIN
      IF CalcType = CalcType::GenJnlLine THEN BEGIN
        RaiseError := ApplyingCustLedgEntry."Posting Date" < "Posting Date";
        OnBeforeEarlierPostingDateError(ApplyingCustLedgEntry,Rec,RaiseError,CalcType);
        IF RaiseError THEN
          ERROR(
            EarlierPostingDateErr,ApplyingCustLedgEntry."Document Type",ApplyingCustLedgEntry."Document No.",
            "Document Type","Document No.");
      END;

      IF ApplyingCustLedgEntry."Entry No." <> 0 THEN
        GenJnlApply.CheckAgainstApplnCurrency(
          ApplnCurrencyCode,"Currency Code",GenJnlLine."Account Type"::Customer,TRUE);

      CustLedgEntry.COPY(Rec);
      IF CurrentRec THEN BEGIN
        CustLedgEntry.SETRECFILTER;
        CustEntrySetApplID.SetApplId(CustLedgEntry,ApplyingCustLedgEntry,"Applies-to ID")
      END ELSE BEGIN
        CurrPage.SETSELECTIONFILTER(CustLedgEntry);
        CustEntrySetApplID.SetApplId(CustLedgEntry,ApplyingCustLedgEntry,GetAppliesToID)
      END;

      CalcApplnAmount;
    END;

    LOCAL PROCEDURE GetAppliesToID@16() AppliesToID : Code[50];
    BEGIN
      CASE CalcType OF
        CalcType::GenJnlLine:
          AppliesToID := GenJnlLine."Applies-to ID";
        CalcType::SalesHeader:
          AppliesToID := SalesHeader."Applies-to ID";
        CalcType::ServHeader:
          AppliesToID := ServHeader."Applies-to ID";
      END;
    END;

    [External]
    PROCEDURE CalcApplnAmount@4();
    BEGIN
      OnBeforeCalcApplnAmount(Rec,GenJnlLine);

      AppliedAmount := 0;
      PmtDiscAmount := 0;
      DifferentCurrenciesInAppln := FALSE;

      CASE CalcType OF
        CalcType::Direct:
          BEGIN
            FindAmountRounding;
            CustEntryApplID := USERID;
            IF CustEntryApplID = '' THEN
              CustEntryApplID := '***';

            CustLedgEntry := ApplyingCustLedgEntry;

            AppliedCustLedgEntry.SETCURRENTKEY("Customer No.",Open,Positive);
            AppliedCustLedgEntry.SETRANGE("Customer No.","Customer No.");
            AppliedCustLedgEntry.SETRANGE(Open,TRUE);
            AppliedCustLedgEntry.SETRANGE("Applies-to ID",CustEntryApplID);

            IF ApplyingCustLedgEntry."Entry No." <> 0 THEN BEGIN
              CustLedgEntry.CALCFIELDS("Remaining Amount");
              AppliedCustLedgEntry.SETFILTER("Entry No.",'<>%1',ApplyingCustLedgEntry."Entry No.");
            END;

            HandleChosenEntries(0,CustLedgEntry."Remaining Amount",CustLedgEntry."Currency Code",CustLedgEntry."Posting Date");
          END;
        CalcType::GenJnlLine:
          BEGIN
            FindAmountRounding;
            IF GenJnlLine."Bal. Account Type" = GenJnlLine."Bal. Account Type"::Customer THEN
              CODEUNIT.RUN(CODEUNIT::"Exchange Acc. G/L Journal Line",GenJnlLine);

            CASE ApplnType OF
              ApplnType::"Applies-to Doc. No.":
                BEGIN
                  AppliedCustLedgEntry := Rec;
                  WITH AppliedCustLedgEntry DO BEGIN
                    CALCFIELDS("Remaining Amount");
                    IF "Currency Code" <> ApplnCurrencyCode THEN BEGIN
                      "Remaining Amount" :=
                        CurrExchRate.ExchangeAmtFCYToFCY(
      //                  ApplnDate,"Currency Code",ApplnCurrencyCode,"Remaining Amount"); //**4PS.o
                          ApplnDate,"Currency Code",ApplnCurrencyCode,"Remaining Amount",TRUE); //**4PS.n
                      "Remaining Pmt. Disc. Possible" :=
                        CurrExchRate.ExchangeAmtFCYToFCY(
      //                  ApplnDate,"Currency Code",ApplnCurrencyCode,"Remaining Pmt. Disc. Possible"); //**4PS.o
                          ApplnDate,"Currency Code",ApplnCurrencyCode,"Remaining Pmt. Disc. Possible",TRUE); //**4PS.n
                      // **4PS.sn
                      "Remain. Pmt. Disc. Possible 2" :=
                        CurrExchRate.ExchangeAmtFCYToFCY(
                          ApplnDate,"Currency Code",ApplnCurrencyCode,"Remain. Pmt. Disc. Possible 2",TRUE);
                      "Remain. Pmt. Disc. Possible 3" :=
                        CurrExchRate.ExchangeAmtFCYToFCY(
                          ApplnDate,"Currency Code",ApplnCurrencyCode,"Remain. Pmt. Disc. Possible 3",TRUE);
                      // **4PS.en
                      "Amount to Apply" :=
                        CurrExchRate.ExchangeAmtFCYToFCY(
      //                  ApplnDate,"Currency Code",ApplnCurrencyCode,"Amount to Apply");  //**4PS.o
                          ApplnDate,"Currency Code",ApplnCurrencyCode,"Amount to Apply",TRUE); //**4PS.n
                    END;

                    IF "Amount to Apply" <> 0 THEN
                      AppliedAmount := ROUND("Amount to Apply",AmountRoundingPrecision)
                    ELSE
                      AppliedAmount := ROUND("Remaining Amount",AmountRoundingPrecision);

                    IF PaymentToleranceMgt.CheckCalcPmtDiscGenJnlCust(
                       //GenJnlLine,AppliedCustLedgEntry,0,FALSE) AND //**4PS.o
                         GenJnlLine,AppliedCustLedgEntry,0,FALSE,0) AND //**4PS.n
                       ((ABS(GenJnlLine.Amount) + ApplnRoundingPrecision >=
                         ABS(AppliedAmount - "Remaining Pmt. Disc. Possible")) OR
                        (GenJnlLine.Amount = 0))
                    THEN
                      PmtDiscAmount := "Remaining Pmt. Disc. Possible"
                    //**4PS.sn
                    ELSE
                      IF PaymentToleranceMgt.CheckCalcPmtDiscGenJnlCust(
                         GenJnlLine,AppliedCustLedgEntry,0,FALSE,1) AND
                         ((ABS(GenJnlLine.Amount) + ApplnRoundingPrecision >=
                         ABS(AppliedAmount - "Remain. Pmt. Disc. Possible 2")) OR
                         (GenJnlLine.Amount = 0))
                      THEN
                        PmtDiscAmount := "Remain. Pmt. Disc. Possible 2"
                      ELSE
                        IF PaymentToleranceMgt.CheckCalcPmtDiscGenJnlCust(
                           GenJnlLine,AppliedCustLedgEntry,0,FALSE,2) AND
                           ((ABS(GenJnlLine.Amount) + ApplnRoundingPrecision >=
                           ABS(AppliedAmount - "Remain. Pmt. Disc. Possible 3")) OR
                           (GenJnlLine.Amount = 0))
                        THEN
                          PmtDiscAmount := "Remain. Pmt. Disc. Possible 3";
                    //**4PS.en

                    IF NOT DifferentCurrenciesInAppln THEN
                      DifferentCurrenciesInAppln := ApplnCurrencyCode <> "Currency Code";
                  END;
                  CheckRounding;
                END;
              ApplnType::"Applies-to ID":
                BEGIN
                  GenJnlLine2 := GenJnlLine;
                  AppliedCustLedgEntry.SETCURRENTKEY("Customer No.",Open,Positive);
                  AppliedCustLedgEntry.SETRANGE("Customer No.",GenJnlLine."Account No.");
                  AppliedCustLedgEntry.SETRANGE(Open,TRUE);
                  AppliedCustLedgEntry.SETRANGE("Applies-to ID",GenJnlLine."Applies-to ID");

                  HandleChosenEntries(1,GenJnlLine2.Amount,GenJnlLine2."Currency Code",GenJnlLine2."Posting Date");
                END;
            END;
          END;
        CalcType::SalesHeader,CalcType::ServHeader:
          BEGIN
            FindAmountRounding;

            CASE ApplnType OF
              ApplnType::"Applies-to Doc. No.":
                BEGIN
                  AppliedCustLedgEntry := Rec;
                  WITH AppliedCustLedgEntry DO BEGIN
                    CALCFIELDS("Remaining Amount");

                    IF "Currency Code" <> ApplnCurrencyCode THEN
                      "Remaining Amount" :=
                        CurrExchRate.ExchangeAmtFCYToFCY(
      //                  ApplnDate,"Currency Code",ApplnCurrencyCode,"Remaining Amount"); //**4PS.o
                          ApplnDate,"Currency Code",ApplnCurrencyCode,"Remaining Amount",TRUE); //**4PS.n

                    AppliedAmount := ROUND("Remaining Amount",AmountRoundingPrecision);

                    IF NOT DifferentCurrenciesInAppln THEN
                      DifferentCurrenciesInAppln := ApplnCurrencyCode <> "Currency Code";
                  END;
                  CheckRounding;
                END;
              ApplnType::"Applies-to ID":
                BEGIN
                  AppliedCustLedgEntry.SETCURRENTKEY("Customer No.",Open,Positive);
                  IF CalcType = CalcType::SalesHeader THEN
                    AppliedCustLedgEntry.SETRANGE("Customer No.",SalesHeader."Bill-to Customer No.")
                  ELSE
                    AppliedCustLedgEntry.SETRANGE("Customer No.",ServHeader."Bill-to Customer No.");
                  AppliedCustLedgEntry.SETRANGE(Open,TRUE);
                  AppliedCustLedgEntry.SETRANGE("Applies-to ID",GetAppliesToID);

                  HandleChosenEntries(2,ApplyingAmount,ApplnCurrencyCode,ApplnDate);
                END;
            END;
          END;
      END;

      OnAfterCalcApplnAmount(Rec,AppliedAmount,ApplyingAmount);
    END;

    LOCAL PROCEDURE CalcApplnRemainingAmount@6(Amount@1000 : Decimal) : Decimal;
    VAR
      ApplnRemainingAmount@1001 : Decimal;
    BEGIN
      ValidExchRate := TRUE;
      IF ApplnCurrencyCode = "Currency Code" THEN
        EXIT(Amount);

      IF ApplnDate = 0D THEN
        ApplnDate := "Posting Date";
      ApplnRemainingAmount :=
        CurrExchRate.ApplnExchangeAmtFCYToFCY(
      //  ApplnDate,"Currency Code",ApplnCurrencyCode,Amount,ValidExchRate); //**4PS.o
          ApplnDate,"Currency Code",ApplnCurrencyCode,Amount,ValidExchRate,TRUE); //**4PS.n

      OnAfterCalcApplnRemainingAmount(Rec,ApplnRemainingAmount);
      EXIT(ApplnRemainingAmount);
    END;

    LOCAL PROCEDURE CalcApplnAmountToApply@10(AmountToApply@1000 : Decimal) : Decimal;
    VAR
      ApplnAmountToApply@1001 : Decimal;
    BEGIN
      ValidExchRate := TRUE;

      IF ApplnCurrencyCode = "Currency Code" THEN
        EXIT(AmountToApply);

      IF ApplnDate = 0D THEN
        ApplnDate := "Posting Date";
      ApplnAmountToApply :=
        CurrExchRate.ApplnExchangeAmtFCYToFCY(
      //  ApplnDate,"Currency Code",ApplnCurrencyCode,AmounttoApply,ValidExchRate); //**4PS.o;
          ApplnDate,"Currency Code",ApplnCurrencyCode,AmountToApply,ValidExchRate,TRUE); //**4PS.n

      OnAfterCalcApplnAmountToApply(Rec,ApplnAmountToApply);
      EXIT(ApplnAmountToApply);
    END;

    LOCAL PROCEDURE FindAmountRounding@7();
    BEGIN
      IF ApplnCurrencyCode = '' THEN BEGIN
        Currency.INIT;
        Currency.Code := '';
        Currency.InitRoundingPrecision;
      END ELSE
        IF ApplnCurrencyCode <> Currency.Code THEN
          Currency.GET(ApplnCurrencyCode);

      AmountRoundingPrecision := Currency."Amount Rounding Precision";
    END;

    [External]
    PROCEDURE CheckRounding@3();
    BEGIN
      ApplnRounding := 0;

      CASE CalcType OF
        CalcType::SalesHeader,CalcType::ServHeader:
          EXIT;
        CalcType::GenJnlLine:
          IF (GenJnlLine."Document Type" <> GenJnlLine."Document Type"::Payment) AND
             (GenJnlLine."Document Type" <> GenJnlLine."Document Type"::Refund)
          THEN
            EXIT;
      END;

      IF ApplnCurrencyCode = '' THEN
        ApplnRoundingPrecision := GLSetup."Appln. Rounding Precision"
      ELSE BEGIN
        IF ApplnCurrencyCode <> "Currency Code" THEN
          Currency.GET(ApplnCurrencyCode);
        ApplnRoundingPrecision := Currency."Appln. Rounding Precision";
      END;

      IF (ABS((AppliedAmount - PmtDiscAmount) + ApplyingAmount) <= ApplnRoundingPrecision) AND DifferentCurrenciesInAppln THEN
        ApplnRounding := -((AppliedAmount - PmtDiscAmount) + ApplyingAmount);
    END;

    [External]
    PROCEDURE GetCustLedgEntry@5(VAR CustLedgEntry@1000 : Record 21);
    BEGIN
      CustLedgEntry := Rec;
    END;

    LOCAL PROCEDURE FindApplyingEntry@12();
    BEGIN
      IF CalcType = CalcType::Direct THEN BEGIN
        CustEntryApplID := USERID;
        IF CustEntryApplID = '' THEN
          CustEntryApplID := '***';

        CustLedgEntry.SETCURRENTKEY("Customer No.","Applies-to ID",Open);
        CustLedgEntry.SETRANGE("Customer No.","Customer No.");
        CustLedgEntry.SETRANGE("Applies-to ID",CustEntryApplID);
        CustLedgEntry.SETRANGE(Open,TRUE);
        CustLedgEntry.SETRANGE("Applying Entry",TRUE);
        IF CustLedgEntry.FINDFIRST THEN BEGIN
          CustLedgEntry.CALCFIELDS(Amount,"Remaining Amount");
          ApplyingCustLedgEntry := CustLedgEntry;
          SETFILTER("Entry No.",'<>%1',CustLedgEntry."Entry No.");
          ApplyingAmount := CustLedgEntry."Remaining Amount";
          ApplnDate := CustLedgEntry."Posting Date";
          ApplnCurrencyCode := CustLedgEntry."Currency Code";
        END;
        CalcApplnAmount;
      END;
    END;

    LOCAL PROCEDURE HandleChosenEntries@14(Type@1000 : 'Direct,GenJnlLine,SalesHeader';CurrentAmount@1001 : Decimal;CurrencyCode@1002 : Code[10];PostingDate@1003 : Date);
    VAR
      TempAppliedCustLedgEntry@1004 : TEMPORARY Record 21;
      PossiblePmtDisc@1007 : Decimal;
      OldPmtDisc@1008 : Decimal;
      CorrectionAmount@1009 : Decimal;
      RemainingAmountExclDiscounts@1012 : Decimal;
      CanUseDisc@1005 : Boolean;
      FromZeroGenJnl@1010 : Boolean;
      IsHandled@1006 : Boolean;
    BEGIN
      IsHandled := FALSE;
      OnBeforeHandledChosenEntries(Type,CurrentAmount,CurrencyCode,PostingDate,AppliedCustLedgEntry,IsHandled);
      IF IsHandled THEN
        EXIT;

      IF NOT AppliedCustLedgEntry.FINDSET(FALSE,FALSE) THEN
        EXIT;

      REPEAT
        TempAppliedCustLedgEntry := AppliedCustLedgEntry;
        TempAppliedCustLedgEntry.INSERT;
      UNTIL AppliedCustLedgEntry.NEXT = 0;

      FromZeroGenJnl := (CurrentAmount = 0) AND (Type = Type::GenJnlLine);

      REPEAT
        IF NOT FromZeroGenJnl THEN
          TempAppliedCustLedgEntry.SETRANGE(Positive,CurrentAmount < 0);
        IF TempAppliedCustLedgEntry.FINDFIRST THEN BEGIN
          ExchangeAmountsOnLedgerEntry(Type,CurrencyCode,TempAppliedCustLedgEntry,PostingDate);

          CASE Type OF
            Type::Direct:
              //CanUseDisc := PaymentToleranceMgt.CheckCalcPmtDiscCust(CustLedgEntry,TempAppliedCustLedgEntry,0,FALSE,FALSE); //**4PS.o
              CanUseDisc := PaymentToleranceMgt.CheckCalcPmtDiscCust(CustLedgEntry,TempAppliedCustLedgEntry,0,FALSE,FALSE,0); //**4PS.n
            Type::GenJnlLine:
              //CanUseDisc := PaymentToleranceMgt.CheckCalcPmtDiscGenJnlCust(GenJnlLine2,TempAppliedCustLedgEntry,0,FALSE) //**4PS.o
              CanUseDisc := PaymentToleranceMgt.CheckCalcPmtDiscGenJnlCust(GenJnlLine2,TempAppliedCustLedgEntry,0,FALSE,0) //**4PS.n
            ELSE
              CanUseDisc := FALSE;
          END;

          IF CanUseDisc AND
             (ABS(TempAppliedCustLedgEntry."Amount to Apply") >=
              ABS(TempAppliedCustLedgEntry."Remaining Amount" - TempAppliedCustLedgEntry."Remaining Pmt. Disc. Possible"))
          THEN
            IF (ABS(CurrentAmount) >
                ABS(TempAppliedCustLedgEntry."Remaining Amount" - TempAppliedCustLedgEntry."Remaining Pmt. Disc. Possible"))
            THEN BEGIN
              PmtDiscAmount += TempAppliedCustLedgEntry."Remaining Pmt. Disc. Possible";
              CurrentAmount += TempAppliedCustLedgEntry."Remaining Amount" - TempAppliedCustLedgEntry."Remaining Pmt. Disc. Possible";
            END ELSE
              IF (ABS(CurrentAmount) =
                  ABS(TempAppliedCustLedgEntry."Remaining Amount" - TempAppliedCustLedgEntry."Remaining Pmt. Disc. Possible"))
              THEN BEGIN
                PmtDiscAmount += TempAppliedCustLedgEntry."Remaining Pmt. Disc. Possible";
                CurrentAmount +=
                  TempAppliedCustLedgEntry."Remaining Amount" - TempAppliedCustLedgEntry."Remaining Pmt. Disc. Possible";
                AppliedAmount += CorrectionAmount;
              END ELSE
                IF FromZeroGenJnl THEN BEGIN
                  PmtDiscAmount += TempAppliedCustLedgEntry."Remaining Pmt. Disc. Possible";
                  CurrentAmount +=
                    TempAppliedCustLedgEntry."Remaining Amount" - TempAppliedCustLedgEntry."Remaining Pmt. Disc. Possible";
                END ELSE BEGIN
                  PossiblePmtDisc := TempAppliedCustLedgEntry."Remaining Pmt. Disc. Possible";
                  RemainingAmountExclDiscounts :=
                    TempAppliedCustLedgEntry."Remaining Amount" - PossiblePmtDisc - TempAppliedCustLedgEntry."Max. Payment Tolerance";
                  IF ABS(CurrentAmount) + ABS(CalcOppositeEntriesAmount(TempAppliedCustLedgEntry)) >=
                     ABS(RemainingAmountExclDiscounts)
                  THEN BEGIN
                    PmtDiscAmount += PossiblePmtDisc;
                    AppliedAmount += CorrectionAmount;
                  END;
                  CurrentAmount +=
                    TempAppliedCustLedgEntry."Remaining Amount" - TempAppliedCustLedgEntry."Remaining Pmt. Disc. Possible";
                END
          ELSE BEGIN
            IF ((CurrentAmount + TempAppliedCustLedgEntry."Amount to Apply") * CurrentAmount) <= 0 THEN
              AppliedAmount += CorrectionAmount;
            CurrentAmount += TempAppliedCustLedgEntry."Amount to Apply";
          END
        END ELSE BEGIN
          TempAppliedCustLedgEntry.SETRANGE(Positive);
          TempAppliedCustLedgEntry.FINDFIRST;
          ExchangeAmountsOnLedgerEntry(Type,CurrencyCode,TempAppliedCustLedgEntry,PostingDate);
        END;

        IF OldPmtDisc <> PmtDiscAmount THEN
          AppliedAmount += TempAppliedCustLedgEntry."Remaining Amount"
        ELSE
          AppliedAmount += TempAppliedCustLedgEntry."Amount to Apply";
        OldPmtDisc := PmtDiscAmount;

        IF PossiblePmtDisc <> 0 THEN
          CorrectionAmount := TempAppliedCustLedgEntry."Remaining Amount" - TempAppliedCustLedgEntry."Amount to Apply"
        ELSE
          CorrectionAmount := 0;

        IF NOT DifferentCurrenciesInAppln THEN
          DifferentCurrenciesInAppln := ApplnCurrencyCode <> TempAppliedCustLedgEntry."Currency Code";

        TempAppliedCustLedgEntry.DELETE;
        TempAppliedCustLedgEntry.SETRANGE(Positive);

      UNTIL NOT TempAppliedCustLedgEntry.FINDFIRST;
      CheckRounding;
    END;

    LOCAL PROCEDURE AmountToApplyOnAfterValidate@19038179();
    BEGIN
      IF ApplnType <> ApplnType::"Applies-to Doc. No." THEN BEGIN
        CalcApplnAmount;
        CurrPage.UPDATE(FALSE);
      END;
    END;

    LOCAL PROCEDURE RecalcApplnAmount@19051222();
    BEGIN
      CurrPage.UPDATE(TRUE);
      CalcApplnAmount;
    END;

    LOCAL PROCEDURE LookupOKOnPush@19031339();
    BEGIN
      OK := TRUE;
    END;

    LOCAL PROCEDURE PostDirectApplication@15(PreviewMode@1005 : Boolean);
    VAR
      CustEntryApplyPostedEntries@1000 : Codeunit 226;
      PostApplication@1002 : Page 579;
      Applied@1006 : Boolean;
      ApplicationDate@1001 : Date;
      NewApplicationDate@1003 : Date;
      NewDocumentNo@1004 : Code[20];
    BEGIN
      IF CalcType = CalcType::Direct THEN BEGIN
        IF ApplyingCustLedgEntry."Entry No." <> 0 THEN BEGIN
          Rec := ApplyingCustLedgEntry;
          ApplicationDate := CustEntryApplyPostedEntries.GetApplicationDate(Rec);

          PostApplication.SetValues("Document No.",ApplicationDate);
          IF ACTION::OK = PostApplication.RUNMODAL THEN BEGIN
            PostApplication.GetValues(NewDocumentNo,NewApplicationDate);
            IF NewApplicationDate < ApplicationDate THEN
              ERROR(Text013,FIELDCAPTION("Posting Date"),TABLECAPTION);
          END ELSE
            ERROR(Text019);

          IF PreviewMode THEN
            CustEntryApplyPostedEntries.PreviewApply(Rec,NewDocumentNo,NewApplicationDate)
          ELSE
            Applied := CustEntryApplyPostedEntries.Apply(Rec,NewDocumentNo,NewApplicationDate);

          IF (NOT PreviewMode) AND Applied THEN BEGIN
            MESSAGE(Text012);
            PostingDone := TRUE;
            CurrPage.CLOSE;
          END;
        END ELSE
          ERROR(Text002);
      END ELSE
        ERROR(Text003);
    END;

    [External]
    PROCEDURE ExchangeAmountsOnLedgerEntry@20(Type@1003 : 'Direct,GenJnlLine,SalesHeader';CurrencyCode@1000 : Code[10];VAR CalcCustLedgEntry@1001 : Record 21;PostingDate@1004 : Date);
    VAR
      CalculateCurrency@1002 : Boolean;
    BEGIN
      CalcCustLedgEntry.CALCFIELDS("Remaining Amount");

      IF Type = Type::Direct THEN
        CalculateCurrency := ApplyingCustLedgEntry."Entry No." <> 0
      ELSE
        CalculateCurrency := TRUE;

      IF (CurrencyCode <> CalcCustLedgEntry."Currency Code") AND CalculateCurrency THEN BEGIN
        CalcCustLedgEntry."Remaining Amount" :=
          CurrExchRate.ExchangeAmount(
            //CalcCustLedgEntry."Remaining Amount",CalcCustLedgEntry."Currency Code",CurrencyCode,PostingDate); //**4PS.o
            CalcCustLedgEntry."Remaining Amount",CalcCustLedgEntry."Currency Code",CurrencyCode,PostingDate,TRUE); //**4PS.n
        CalcCustLedgEntry."Remaining Pmt. Disc. Possible" :=
          CurrExchRate.ExchangeAmount(
            //CalcCustLedgEntry."Remaining Pmt. Disc. Possible",CalcCustLedgEntry."Currency Code",CurrencyCode,PostingDate); //**4PS.o
            CalcCustLedgEntry."Remaining Pmt. Disc. Possible",CalcCustLedgEntry."Currency Code",CurrencyCode,PostingDate,TRUE); //**4PS.n
        CalcCustLedgEntry."Amount to Apply" :=
          CurrExchRate.ExchangeAmount(
            //CalcCustLedgEntry."Amount to Apply",CalcCustLedgEntry."Currency Code",CurrencyCode,PostingDate); //**4PS.so
            CalcCustLedgEntry."Amount to Apply",CalcCustLedgEntry."Currency Code",CurrencyCode,PostingDate,TRUE); //**4PS.n
      END;

      OnAfterExchangeAmountsOnLedgerEntry(CalcCustLedgEntry,CustLedgEntry,CurrencyCode);
    END;

    [External]
    PROCEDURE CalcOppositeEntriesAmount@17(VAR TempAppliedCustLedgerEntry@1000 : TEMPORARY Record 21) Result : Decimal;
    VAR
      SavedAppliedCustLedgerEntry@1002 : Record 21;
      CurrPosFilter@1001 : Text;
    BEGIN
      WITH TempAppliedCustLedgerEntry DO BEGIN
        CurrPosFilter := GETFILTER(Positive);
        IF CurrPosFilter <> '' THEN BEGIN
          SavedAppliedCustLedgerEntry := TempAppliedCustLedgerEntry;
          SETRANGE(Positive,NOT Positive);
          IF FINDSET THEN
            REPEAT
              CALCFIELDS("Remaining Amount");
              Result += "Remaining Amount";
            UNTIL NEXT = 0;
          SETFILTER(Positive,CurrPosFilter);
          TempAppliedCustLedgerEntry := SavedAppliedCustLedgerEntry;
        END;
      END;
    END;

    [External]
    PROCEDURE GetCalcType@24() : Integer;
    BEGIN
      EXIT(CalcType);
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterCalcApplnAmount@18(CustLedgerEntry@1000 : Record 21;VAR AppliedAmount@1001 : Decimal;VAR ApplyingAmount@1002 : Decimal);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterCalcApplnAmountToApply@25(CustLedgerEntry@1000 : Record 21;VAR ApplnAmountToApply@1001 : Decimal);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterCalcApplnRemainingAmount@21(CustLedgerEntry@1000 : Record 21;VAR ApplnRemainingAmount@1001 : Decimal);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterExchangeAmountsOnLedgerEntry@27(VAR CalcCustLedgEntry@1000 : Record 21;CustLedgerEntry@1001 : Record 21;CurrencyCode@1002 : Code[10]);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeCalcApplnAmount@22(VAR CustLedgerEntry@1000 : Record 21;VAR GenJournalLine@1001 : Record 81);
    BEGIN
    END;

    [Integration(TRUE,TRUE)]
    LOCAL PROCEDURE OnBeforeHandledChosenEntries@23(Type@1003 : 'Direct,GenJnlLine,SalesHeader';CurrentAmount@1002 : Decimal;CurrencyCode@1001 : Code[10];PostingDate@1000 : Date;VAR AppliedCustLedgerEntry@1004 : Record 21;VAR IsHandled@1005 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeEarlierPostingDateError@19(ApplyingCustLedgerEntry@1000 : Record 21;CustLedgerEntry@1001 : Record 21;VAR RaiseError@1002 : Boolean;CalcType@1003 : Option);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeSetApplyingCustLedgEntry@26(VAR ApplyingCustLedgEntry@1000 : Record 21;GenJournalLine@1001 : Record 81);
    BEGIN
    END;

    BEGIN
    END.
  }
}

