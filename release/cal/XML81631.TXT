OBJECT XMLport 81631 Imp. Prognosis
{
  OBJECT-PROPERTIES
  {
    Date=;
    Time=;
    Version List=;
  }
  PROPERTIES
  {
    DefaultFieldsValidation=No;
    OnInitXMLport=BEGIN
                    XMLNo := 81631;
                    MainTableID := 11128270;
                    GenSetupRec.GET();
                    MainTableID2 := 11012035;
                  END;

    OnPreXMLport=BEGIN
                   IF NOT currXMLport.IMPORTFILE THEN BEGIN
                     AddConversionFileFormatLine;
                     FillConversionXMLPortFields;
                     COMMIT;
                     ERROR('');
                   END;

                   ContactSetupRec.GET();

                   ConvMgt.DeleteConComment(XMLNo);
                   ConvMgt.CreateConComment(XMLNo,'Start');
                 END;

    OnPostXMLport=BEGIN
                    IF NOT RunIsImportRunBln THEN
                      currXMLport.BREAK;

                    ConvMgt.CreateConComment(XMLNo,'Stop');
                    ConvMgt.CreateConComment(XMLNo,ConvMgt.CreateNoOfLinesCommentTxt(MainTableID,ImpLineCounter));
                    BDateSave:=DateInFile; //140430D;

                    CLEAR(Prognosis);
                    Prognosis.SETRANGE("Prognosis Date",BDateSave);
                    Prognosis.SETRANGE(Fixed,FALSE);
                    //MESSAGE('Date:%1',BDateSave);
                    IF Prognosis.FINDSET THEN REPEAT
                      Prognosis2:=Prognosis;
                      {
                      IF PrognosisLine3.GET(Prognosis."Project No.",Prognosis."Prognosis Date",'7O') THEN BEGIN
                        PrognosisLine4.SETRANGE("Project No.",Prognosis."Project No.");
                        PrognosisLine4.SETRANGE("Prognosis Date",Prognosis."Prognosis Date");
                        PrognosisLine4.CALCSUMS("Prognosis Total Cost");
                        //MESSAGE(
                        PrognosisLine3.VALIDATE("Prognosis Total Cost",((PrognosisLine4."Prognosis Total Cost"-PrognosisLine3."Prognosis Total Cost")*0.12));//*1.12));
                        //IF PrognosisLine3."Prognosis Amount Revenue" = 0 THEN
                          //PrognosisLine3.VALIDATE("Prognosis Amount Revenue",PrognosisLine3."Prognosis Total Revenues"-PrognosisLine3."Actual Revenues");
                        PrognosisLine3.MODIFY(TRUE);
                      END;
                      }
                      IF PrognosisLine3.GET(Prognosis."Project No.",Prognosis."Prognosis Date",'1I') THEN BEGIN
                        PrognosisLine3.VALIDATE("Prognosis Amount Revenue",PrognosisLine3."Prognosis Total Revenues"-PrognosisLine3."Actual Revenues");
                        IF PrognosisLine3."Prognosis Amount Revenue"=0 THEN
                          PrognosisLine3."Prognosis Amount Revenue":=1;
                        PrognosisLine3.MODIFY(TRUE);
                      END ELSE BEGIN

                        PrognosisLine3.INIT;
                        PrognosisLine3.VALIDATE("Cost Component Code",'1I');
                        PrognosisLine3.VALIDATE("Project No.",Prognosis."Project No.");
                        PrognosisLine3.VALIDATE("Prognosis Date",Prognosis."Prognosis Date");
                        PrognosisLine3.INSERT(TRUE);
                        PrognosisLine3.VALIDATE("Prognosis Amount Revenue",1);
                        PrognosisLine3.MODIFY(TRUE);
                      END;

                      Prognosis2.VALIDATE(Fixed,TRUE);
                      Prognosis2.MODIFY(TRUE);
                    UNTIL Prognosis.NEXT=0;

                    //PrognosisLine3.SETRANGE("Prognosis Date",BDate);
                  END;

    Format=Variable Text;
    FieldSeparator=[;];
  }
  ELEMENTS
  {
    { [{755F5B7F-F062-4834-8364-DC4CD51C5A62}];  ;Root                ;Element ;Text     }

    { [{A7DBD164-8D3E-4F8D-B3A0-89F91BC12205}];1 ;PrognosisLineCC     ;Element ;Table   ;
                                                  SourceTable=Table11128270;
                                                  SourceTableView=SORTING(Field10,Field20,Field40);
                                                  Import::OnAfterInitRecord=BEGIN
                                                                              ClearFields;

                                                                              //IF PrevNo <> A THEN BEGIN
                                                                                //IF PrognosisLine3.GET(PrevNo,BDate,'7O') THEN
                                                                                  //PrognosisLine3.VALIDATE("Prognosis Total Cost",(Tot*0.12));
                                                                                //Tot:=0;
                                                                              //END;
                                                                            END;

                                                  Import::OnBeforeInsertRecord=VAR
                                                                                 ContactPerson@1100409000 : Record 5050;
                                                                               BEGIN
                                                                                 StripData;
                                                                                 ImpLineCounter := ImpLineCounter + 1;
                                                                                 CLEAR("Prognosis Line CC");
                                                                                 CLEAR(Prognosis);
                                                                                 CLEAR(PrognosisLine2);
                                                                                 CLEAR(DimensionValue);

                                                                                 WITH "Prognosis Line CC" DO BEGIN
                                                                                   IF NOT Prognosis.GET(A,BDate) THEN BEGIN
                                                                                     Prognosis.INIT;
                                                                                     Prognosis.VALIDATE("Project No.",A);
                                                                                     Prognosis.VALIDATE("Prognosis Date",BDate);
                                                                                     Prognosis.INSERT(TRUE);
                                                                                     Prognosis.GET(A,BDate);
                                                                                     ProcessPrognosisCC(Prognosis);

                                                                                     //Prognosis.GET(A,BDate);
                                                                                     PrognosisLine5.SETRANGE("Project No.",Prognosis."Project No.");
                                                                                     PrognosisLine5.SETRANGE("Prognosis Date",BDate);
                                                                                     IF PrognosisLine5.FINDSET(TRUE) THEN REPEAT
                                                                                       PrognosisLine6:=PrognosisLine5;
                                                                                       PrognosisLine6.VALIDATE("Prognosis Total Cost",0);//*1.12));
                                                                                       PrognosisLine6.VALIDATE("Prognosis Total Revenues",0);
                                                                                       PrognosisLine6.MODIFY(TRUE);
                                                                                     UNTIL PrognosisLine5.NEXT=0;
                                                                                   END;

                                                                                   Prognosis.GET(A,BDate);
                                                                                   DimensionValue.GET('KOSTNADSOBJEKT',C);

                                                                                   IF PrognosisLine2.GET(A,BDate,DimensionValue."Cost Component") THEN BEGIN
                                                                                     //MESSAGE('rad %1 %2 %3',PrognosisLine2."Project No.",PrognosisLine2."Prognosis Date",PrognosisLine2."Cost Component Code");
                                                                                     PrognosisLine2.VALIDATE("Prognosis Hours",FDec-PrognosisLine2."Actual Hours");
                                                                                     PrognosisLine2.VALIDATE("Prognosis Total Cost",DDec);//*1.12));
                                                                                     PrognosisLine2.VALIDATE("Prognosis Total Revenues",PrognosisLine2."Prognosis Total Revenues"+EDec);
                                                                                     PrognosisLine2.MODIFY(TRUE);
                                                                                   END ELSE BEGIN
                                                                                     PrognosisLine2.INIT;
                                                                                     PrognosisLine2.VALIDATE("Cost Component Code",DimensionValue."Cost Component");
                                                                                     PrognosisLine2.VALIDATE("Project No.",A);
                                                                                     PrognosisLine2.VALIDATE("Prognosis Date",BDate);
                                                                                     PrognosisLine2.INSERT(TRUE);
                                                                                     PrognosisLine2.VALIDATE("Prognosis Hours",FDec-PrognosisLine2."Actual Hours");
                                                                                     PrognosisLine2.VALIDATE("Prognosis Total Cost",DDec);//*1.12));
                                                                                     PrognosisLine2.VALIDATE("Prognosis Total Revenues",EDec);
                                                                                     PrognosisLine2.MODIFY(TRUE);
                                                                                   END;

                                                                                 END;

                                                                                 ClearFields;
                                                                                 currXMLport.SKIP;

                                                                                 //Tot:=Tot+DDec;
                                                                                 //PrevNo:=A;
                                                                                 IF BDate<>0D THEN
                                                                                   BDateSave:=BDate;
                                                                               END;
                                                                                }

    { [{5C900A9C-2240-4551-8D3B-A67A2D629F53}];2 ;A                   ;Element ;Text     }

    { [{5E5EE9AF-296C-4B48-B3A4-71FD1D3BDBB8}];2 ;B                   ;Element ;Text    ;
                                                  Import::OnAfterAssignVariable=BEGIN
                                                                                  IF B <> '' THEN
                                                                                    EVALUATE(BDate,B);
                                                                                END;
                                                                                 }

    { [{81EF86E1-A401-49BA-998E-C96326459340}];2 ;C                   ;Element ;Text     }

    { [{A4D141C2-7800-4941-8428-EBDFE695445E}];2 ;D                   ;Element ;Text    ;
                                                  Import::OnAfterAssignVariable=BEGIN
                                                                                  IF D <> '' THEN
                                                                                    EVALUATE(DDec,D);
                                                                                END;
                                                                                 }

    { [{7009774A-5D5B-4893-B574-E0BA7086A95E}];2 ;E                   ;Element ;Text    ;
                                                  Import::OnAfterAssignVariable=BEGIN
                                                                                  IF E <> '' THEN
                                                                                    EVALUATE(EDec,E);
                                                                                END;
                                                                                 }

    { [{0A9B17D2-9415-44A2-9EE3-6C0F4EBF3DD8}];2 ;F                   ;Element ;Text    ;
                                                  Import::OnAfterAssignVariable=BEGIN
                                                                                  IF F <> '' THEN
                                                                                    EVALUATE(FDec,F);
                                                                                END;
                                                                                 }

  }
  EVENTS
  {
  }
  REQUESTPAGE
  {
    PROPERTIES
    {
      CaptionML=[ENU=Lookup Main Project No. based on old Main Project No.;
                 SVE=Val av huvudprojekt baserat p† gammalt huvudprojektnr];
      OnOpenPage=BEGIN
                   RunIsImportRunBln := TRUE;
                 END;

    }
    CONTROLS
    {
      { 1000000001;;Container;
                  Name=Imp. Prognosis;
                  ContainerType=ContentArea }

      { 1000000000;1;Group  ;
                  CaptionML=[ENU=Options;
                             SVE=Alternativ];
                  GroupType=Group }

      { 1000000002;2;Field  ;
                  CaptionML=[ENU=Prognosis Date (in file);
                             SVE=Prognosdatum (i filen)];
                  SourceExpr=DateInFile }

    }
  }
  CODE
  {
    VAR
      "// GENERAL"@1100525045 : Integer;
      CommentRec@1100525044 : Record 97;
      ConvMgt@1100525043 : Codeunit 11020212;
      NoSerieMgt@1100525042 : Codeunit 396;
      XMLNo@1100525040 : Integer;
      MainTableID@1100525039 : Integer;
      CreateNewNosBln@1100525038 : Boolean;
      ImpLineCounter@1100525037 : Integer;
      CommentCde@1100525036 : Code[10];
      UserSetup@1100285000 : Record 91;
      ContactSetupRec@1100525035 : Record 5079;
      ConversionFileFormat@1100525033 : Record 11020691;
      RunIsImportRunBln@1100525032 : Boolean;
      xRec@1100525031 : Record 11012312;
      GenSetupRec@1100525030 : Record 98;
      Text001@1100525016 : TextConst 'ENU=Third Dimension must be filled;SVE=Tredje dimensionen m†ste fyllas i';
      Text002@1100525015 : TextConst 'ENU=Fourth Dimension must be filled;SVE=Fj„rde dimensionen m†ste fyllas i';
      Text003@1100525010 : TextConst 'ENU="<empty>=Male, [1]=Female";SVE="<tom>=Man, [1]=Kvinna"';
      Text004@1100525009 : TextConst 'ENU=Third Dimension;SVE=Tredje dimensionen';
      Text005@1100525008 : TextConst 'ENU=Fourth Dimension;SVE=Fj„rde dimensionen';
      ExceptionalSalesPriceDate@1100285501 : Record 11020389;
      TableID2@1100285502 : Integer;
      ProjCommentCde@1100285505 : Code[20];
      UseOldProjNoBln@1100285503 : Boolean;
      ProjCde@1100285504 : Code[20];
      BDate@1100285001 : Date;
      EDec@1100285002 : Decimal;
      DDec@1100285003 : Decimal;
      PrognosisMgmt@1100285005 : Codeunit 11020217;
      AutomaticGeneratePrognosis@1100285545 : Report 11012668;
      AutomaticGeneratePrognosisCC@1100285544 : Report 11128270;
      StartProcess@1100285543 : Boolean;
      PrognosisDate@1100285542 : Date;
      CopyPrevCostPrognosis@1100285541 : Boolean;
      CopyPrevPrognosisEndResult@1100285540 : Boolean;
      CopyPrevRevenuePrognosis@1100285539 : Boolean;
      CopyPrevPrognosisTotalRev@1100285538 : Boolean;
      CopyCommentsPrevPrognosis@1100285537 : Boolean;
      FillProgWithAvailableCost@1100285536 : Boolean;
      FillProgWithExtrapolatedCosts@1100285535 : Boolean;
      FillProgFromProjPlanningAct@1100285534 : Boolean;
      FillProgFromRequestedActCap@1100285533 : Boolean;
      FillProgFromAssignedActCap@1100285532 : Boolean;
      FillProgRevenues@1100285531 : Boolean;
      CalcSurcharges@1100285530 : Boolean;
      GenerateCostPlusEntries@1100285529 : Boolean;
      CopyPrevRevenuePrognosis2@1100285528 : Boolean;
      CopyPrevPrognosisEndResRevenue@1100285527 : Boolean;
      FillPrognosisExpectedRevenue@1100285526 : Boolean;
      CostTypes@1100285525 : 'Cost,Revenue,Both';
      ProjRec@1100285524 : Record 11072003;
      PrevPrognosis1@1100285523 : Record 11012034;
      newPrognosisLine@1100285522 : Record 11128270;
      tempCostComp@1100285521 : TEMPORARY Record 37;
      BudgetLine@1100285520 : Record 11012001;
      JobLedgEntry@1100285519 : Record 11072005;
      PurchLine@1100285518 : Record 39;
      HourAccLine@1100285517 : Record 11012039;
      PostedHourLine@1100285516 : Record 11012085;
      PurchOrderCtrlLine@1100285515 : Record 11020221;
      PrognosisLine@1100285514 : Record 11128270;
      SalesLine@1100285513 : Record 37;
      SalesInvLine@1100285512 : Record 113;
      ProjectInstallment@1100285511 : Record 11012018;
      ProjCostPlusEntry@1100285510 : Record 11012019;
      ProjPrincipal@1100285509 : Record 11012005;
      GLSetup@1100285508 : Record 98;
      DimVal@1100285507 : Record 349;
      CreateProjectCostPlus@1100285506 : Report 11012013;
      SubProject@1100285500 : Record 11072003;
      PrognosisLine2@1100285546 : Record 11128270;
      DimensionValue@1100285547 : Record 349;
      Prognosis2@1100285549 : Record 11012034;
      Prognosis@1100285548 : Record 11012034;
      PrognosisLineA@1100285550 : Record 11012035;
      MainTableID2@1100285551 : Integer;
      FDec@1000000000 : Decimal;
      PrevNo@1000000001 : Code[20];
      Tot@1000000002 : Decimal;
      PrognosisLine3@1000000003 : Record 11128270;
      PrognosisLine4@1000000004 : Record 11128270;
      BDateSave@1100285004 : Date;
      PrognosisLine5@1100285006 : Record 11128270;
      PrognosisLine6@1100285007 : Record 11128270;
      DateInFile@1000000005 : Date;

    PROCEDURE StripData@1100485001();
    BEGIN
      A := DELCHR(A,'<>',' ');
      B := DELCHR(B,'<>',' ');
      C := DELCHR(C,'<>',' ');
      D := DELCHR(D,'<>',' ');
      E := DELCHR(E,'<>',' ');
      F := DELCHR(F,'<>',' ');
    END;

    PROCEDURE AddConversionFileFormatLine@1100529901();
    VAR
      DefaultDimension@1100529900 : Record 352;
    BEGIN
      // This function stores the file format into table [Conversion File Format].
      // There is no other standard documentation; so please maintain this function in case of customization.
      //
      // Parameters: 1: [Dataport No.],
      //             2: [csv-Column],
      //             3: [NAV Table ID],
      //             4: [NAV Field Name],
      //             5: [Data Type of dataport field],
      //             6: [extra Comment].
      //

      WITH ConversionFileFormat DO BEGIN
        ConversionFileFormat.DeleteColumnLines(XMLNo);
        InsertColumnLine(XMLNo,'A',MainTableID,"Prognosis Line CC".FIELDNAME("Project No."),'Code20','');
        InsertColumnLine(XMLNo,'B',MainTableID,"Prognosis Line CC".FIELDNAME("Prognosis Date"),'Date','');
        InsertColumnLine(XMLNo,'C',MainTableID2,PrognosisLineA.FIELDNAME("Cost Object"),'Code20','');
        InsertColumnLine(XMLNo,'D',MainTableID,"Prognosis Line CC".FIELDNAME("Prognosis Costs"),'Decimal','');
        InsertColumnLine(XMLNo,'E',MainTableID,"Prognosis Line CC".FIELDNAME("Prognosis Revenue"),'Decimal','');
        InsertColumnLine(XMLNo,'F',MainTableID,"Prognosis Line CC".FIELDNAME(Quantity),'Decimal','');


      END;
    END;

    PROCEDURE ClearFields@1100529903();
    BEGIN
      CLEAR(Prognosis);
      CLEAR("Prognosis Line CC");
      CLEAR(PrognosisLine2);
      A := '';
      B := '';
      C := '';
      D := '';
      E := '';
      F := '';
      BDate:=0D;
      EDec := 0;
      DDec:=0;
      FDec := 0;
    END;

    PROCEDURE FillConversionXMLPortFields@1100409004();
    VAR
      ConversionXMLPort@1100409000 : Record 11020640;
    BEGIN
      ConversionXMLPort.GET(XMLNo);
      ConversionXMLPort."Main Table ID" := MainTableID;
      ConversionXMLPort."Page ID" := 11128277;
      ConversionXMLPort.MODIFY;
    END;

    PROCEDURE "*Copied from CU 11020217*"@1100285506();
    BEGIN
      //Copied functions from 11020217 (Do not show req. page)
    END;

    PROCEDURE ProcessPrognosisCC@1100290000(VAR Prognosis@1100528800 : Record 11012034);
    VAR
      _costComp@1000000002 : Record 11012012;
      _dimVal@1000000003 : Record 349;
      _dec@1100290000 : Decimal;
      _revLoop@1000000000 : Integer;
      _revenue@1000000001 : Boolean;
      HourAccountingLine@1100285001 : Record 11012039;
      ItemJournalLine@1100285000 : Record 83;
      lCostComponent@1100285500 : Record 11012012;
      ExtensionContract@1100285501 : Record 11012004;
    BEGIN
      // LAHE 121213 For Cost Component
      GLSetup.GET();
      // pop up selection for end user
      CLEAR(AutomaticGeneratePrognosisCC);
      //AutomaticGeneratePrognosisCC.SetSelections(Prognosis."Prognosis Date");
      //AutomaticGeneratePrognosisCC.RUNMODAL;
      PrognosisDate:=Prognosis."Prognosis Date";
      StartProcess:=TRUE;
      CopyPrevCostPrognosis:=FALSE;
      CopyPrevPrognosisEndResult:=FALSE;
      FillProgWithAvailableCost:=TRUE;
      GenerateCostPlusEntries:=FALSE;
      CopyPrevRevenuePrognosis2:=FALSE;
      CopyPrevPrognosisEndResRevenue:=FALSE;
      FillPrognosisExpectedRevenue:=FALSE;

      {
      AutomaticGeneratePrognosisCC.GetSelections(StartProcess
        ,PrognosisDate
        ,CopyPrevCostPrognosis
        ,CopyPrevPrognosisEndResult
        ,FillProgWithAvailableCost
        ,GenerateCostPlusEntries
        ,CopyPrevRevenuePrognosis2
        ,CopyPrevPrognosisEndResRevenue
        ,FillPrognosisExpectedRevenue
        );
      }
      IF NOT StartProcess THEN
        EXIT;

      //>>IME076
      //check if new date will overwrite exitsing fixed prognosis
      IF (PrognosisDate <> 0D) AND Prognosis.GET(Prognosis."Project No.", PrognosisDate) THEN
        Prognosis.TESTFIELD(Fixed,FALSE);
      //<<IME076

      // create prognosis for date if not there
      IF Prognosis."Prognosis Date" <> PrognosisDate THEN BEGIN
        Prognosis."Prognosis Date" := PrognosisDate;

        IF NOT Prognosis.GET(Prognosis."Project No.", PrognosisDate) THEN BEGIN
          Prognosis.INIT;
          Prognosis."Project No." := Prognosis."Project No.";
          Prognosis.VALIDATE("Prognosis Date",PrognosisDate);
          Prognosis.INSERT(TRUE);
        END;
      END;

      ProjRec.GET(Prognosis."Project No."); // delib. error

      //PrevPrognosis.RESET;
      //PrevPrognosis.SETRANGE("Project No.",ProjRec."No.");
      //PrevPrognosis.SETRANGE("Prognosis Date",0D,PrognosisDate -1);
      //IF NOT PrevPrognosis.FINDLAST THEN
      //  PrevPrognosis := Prognosis;

      ProjRec.SETRECFILTER();
      IF GenerateCostPlusEntries THEN BEGIN
        CLEAR(CreateProjectCostPlus);
        // Commission No.?
        CreateProjectCostPlus.USEREQUESTPAGE(FALSE);
        //CreateProjectCostPlus.SETTABLEVIEW(ProjRec);
        //CreateProjectCostPlus.RUNMODAL;

        // from Proj Card call
        JobLedgEntry.RESET;
        JobLedgEntry.SETRANGE("Cost Plus Entry Created", FALSE);
        PostedHourLine.RESET;
        PostedHourLine.SETRANGE("Cost Plus Entry Created", FALSE);
        HourAccLine.RESET;
        HourAccLine.SETRANGE("Cost Plus Entry Created", FALSE);

        CreateProjectCostPlus.SETTABLEVIEW(ProjRec);
        CreateProjectCostPlus.SETTABLEVIEW(JobLedgEntry);
        CreateProjectCostPlus.SETTABLEVIEW(PostedHourLine);
        CreateProjectCostPlus.SETTABLEVIEW(HourAccLine);
        CreateProjectCostPlus.SetDefault(ProjRec."No.");
        CreateProjectCostPlus.SetReqForm(NOT GUIALLOWED);
        CreateProjectCostPlus.RUNMODAL;

        // repeat for sub projects if main project
        IF ProjRec."Single/Main/Sub Project" = ProjRec."Single/Main/Sub Project"::"Main Project" THEN BEGIN
          SubProject.RESET;
          SubProject.SETRANGE("Main Project",ProjRec."No.");
          IF SubProject.FINDSET THEN REPEAT
            SubProject.SETRECFILTER();
            CLEAR(CreateProjectCostPlus);
            // Commission No.?
            CreateProjectCostPlus.USEREQUESTPAGE(FALSE);
            //CreateProjectCostPlus.SETTABLEVIEW(ProjRec);
            //CreateProjectCostPlus.RUNMODAL;

            // from Proj Card call
            JobLedgEntry.RESET;
            JobLedgEntry.SETRANGE("Cost Plus Entry Created", FALSE);
            PostedHourLine.RESET;
            PostedHourLine.SETRANGE("Cost Plus Entry Created", FALSE);
            HourAccLine.RESET;
            HourAccLine.SETRANGE("Cost Plus Entry Created", FALSE);

            CreateProjectCostPlus.SETTABLEVIEW(SubProject);
            CreateProjectCostPlus.SETTABLEVIEW(JobLedgEntry);
            CreateProjectCostPlus.SETTABLEVIEW(PostedHourLine);
            CreateProjectCostPlus.SETTABLEVIEW(HourAccLine);
            CreateProjectCostPlus.SetDefault(SubProject."No.");
            CreateProjectCostPlus.SetReqForm(NOT GUIALLOWED);
            CreateProjectCostPlus.RUNMODAL;
            SubProject.SETRANGE("No.");
          UNTIL SubProject.NEXT = 0;
        END;

      END;    //IF GenerateCostPlusEntries


      //IF NOT ProjRec."Prognosis per Element" THEN BEGIN
      IF TRUE THEN BEGIN
        //One line for each cost component in that occurs in the budget, project ledger,
        //purchase control, hour accounting line (purchase order line) or previous prognosis.
        //Each cost component will only have one line.

        tempCostComp.RESET;  // Sales Line table
        tempCostComp.DELETEALL;

        WITH BudgetLine DO BEGIN
          RESET;
          IF ProjRec."Single/Main/Sub Project" = ProjRec."Single/Main/Sub Project"::"Main Project" THEN
            SETRANGE("Main Project No.",ProjRec."No.")
          ELSE
            SETRANGE("Project No.",ProjRec."No.");
          SETFILTER("Cost Component",'<>%1','');
          SETRANGE("Version Date",0D,Prognosis."Prognosis Date");
          //>>IME-096
          SETFILTER("Extension Contract Status",'%1|%2|%3',
            "Extension Contract Status"::"Not Applicable",      //no extension connected
            "Extension Contract Status"::Order,"Extension Contract Status"::"Invoicing Allowed");
          //<<IME-096
          IF FINDSET THEN REPEAT
            IF "Cost Component" <> '' THEN BEGIN
              IF NOT tempCostComp.GET(-1,"Cost Component",0) THEN BEGIN
                // save new occurance
                tempCostComp."Document Type" := -1;
                tempCostComp."Document No." := "Cost Component";
                tempCostComp."Line No." := 0;
                tempCostComp.INIT;
                tempCostComp.INSERT;
              END;
              //IF NOT CONFIRM('Component "%1"',TRUE,tempCostComp."Document No.") THEN ERROR('');
              //Total amount in the budget lines of the project with the version date equal or before the prognosis date.
              //Total hours in the budget lines of the project with the version date equal or before the prognosis date.
              //IF "Version Date" <= PrevPrognosis."Prognosis Date" THEN BEGIN
              IF "Version Date" <= Prognosis."Prognosis Date" THEN BEGIN
                //TotAmountBudget += Amount;
                //TotHoursBudget += Hours;
                tempCostComp.Amount += "Amount (LCY)"; // carrierfield budget amount
                tempCostComp.Quantity += Hours; // carrierfield budget hours
                tempCostComp.MODIFY;
              END;
            END;
          UNTIL NEXT = 0;
        END;

      //>>ENH-025
      //a cost plus project
      IF (ProjRec."Settlement Method" = ProjRec."Settlement Method"::"Cost Plus") AND
          (ProjPrincipal.GET(ProjRec."No.",ProjRec."Bill-to Customer No.")) THEN BEGIN
        GLSetup.GET;
        DimVal.GET(GLSetup."Global Dimension 2 Code",ProjPrincipal."Cost Object");
        IF DimVal."Cost Component" <> '' THEN BEGIN
          IF NOT tempCostComp.GET(-1,DimVal."Cost Component",0) THEN BEGIN
            // save new occurance
            tempCostComp."Document Type" := -1;
            tempCostComp."Document No." := DimVal."Cost Component";
            tempCostComp."Line No." := 0;
            tempCostComp.INIT;
            tempCostComp.INSERT;
          END;
        END;
      END;
      //a project which has a cost plus extension
      //ExtensionContract.key: "Project No.","Contract No."
      ExtensionContract.SETRANGE("Project No.",ProjRec."No.");
      ExtensionContract.SETRANGE("Settlement Method",ExtensionContract."Settlement Method"::"Cost Plus");
      IF ExtensionContract.FINDSET(FALSE) THEN
      REPEAT
        IF ProjPrincipal.GET(ProjRec."No.",ExtensionContract.Principal) THEN BEGIN
          GLSetup.GET;
          DimVal.GET(GLSetup."Global Dimension 2 Code",ProjPrincipal."Cost Object");
          IF DimVal."Cost Component" <> '' THEN BEGIN
            IF NOT tempCostComp.GET(-1,DimVal."Cost Component",0) THEN BEGIN
              // save new occurance
              tempCostComp."Document Type" := -1;
              tempCostComp."Document No." := DimVal."Cost Component";
              tempCostComp."Line No." := 0;
              tempCostComp.INIT;
              tempCostComp.INSERT;
            END;
          END;
        END;
      UNTIL ExtensionContract.NEXT=0;
      //<<ENH-025

        // proj ledg entries
        WITH JobLedgEntry DO BEGIN
          RESET;
          SETCURRENTKEY("Job No.");
          IF ProjRec."Single/Main/Sub Project" = ProjRec."Single/Main/Sub Project"::"Main Project" THEN
            SETRANGE("Main Project No.",ProjRec."No.")
          ELSE
            SETRANGE("Job No.",ProjRec."No.");
          SETFILTER("Cost Component",'<>%1','');
          SETRANGE("Posting Date",0D,Prognosis."Prognosis Date");
          IF FINDSET THEN REPEAT
            IF "Cost Component" <> '' THEN BEGIN
              IF NOT tempCostComp.GET(-1,"Cost Component",0) THEN BEGIN
                // save new occurance
                tempCostComp."Document Type" := -1;
                tempCostComp."Document No." := "Cost Component";
                tempCostComp."Line No." := 0;
                tempCostComp.INIT;
                tempCostComp.INSERT;
              END;
              //Total of the project ledger entries for the project
              //with a posting date equal or before the prognosis date (Field: Total price)
              //Total of the project ledger entries for the project with a posting date equal or before the prognosis date
              //and cost type = ÊLaborË (Field: Quantity)
              //IF JobLedgEntry."Posting Date" <= PrevPrognosis."Prognosis Date" THEN BEGIN
              IF JobLedgEntry."Posting Date" <= Prognosis."Prognosis Date" THEN BEGIN
                //TotActualAmount += JobLedgEntry."Total Price (LCY)";
                //IF "Cost Type" = "Cost Type"::Labor THEN
                //  TotActualHours += JobLedgEntry.Quantity;
                //tempCostComp."Outstanding Amount" += -JobLedgEntry."Total Price (LCY)"; // carrierfield actual amount
                tempCostComp."Outstanding Amount" += JobLedgEntry."Total Cost (LCY)"; // carrierfield actual amount
      //>>ENH-011
                IF lCostComponent.GET("Cost Component") THEN
                  IF lCostComponent."Cost Type" = lCostComponent."Cost Type"::Labor THEN
      //<<ENH-011
                tempCostComp."Qty. Invoiced (Base)" += JobLedgEntry.Quantity; // carrierfield actual hours
                tempCostComp.MODIFY;
              END;
            END;
          UNTIL JobLedgEntry.NEXT = 0;
        END;
        // Hour Accounting Lines
        WITH HourAccLine DO BEGIN
          RESET;
          SETCURRENTKEY("Project No.");
          IF ProjRec."Single/Main/Sub Project" = ProjRec."Single/Main/Sub Project"::"Main Project" THEN
            SETRANGE("Main Project No.",ProjRec."No.")
          ELSE
            SETRANGE("Project No.",ProjRec."No.");
          SETFILTER("Cost Component",'<>%1','');
          SETRANGE("Posting Date",0D,Prognosis."Prognosis Date");
          IF FINDSET THEN REPEAT
            IF "Cost Component" <> '' THEN BEGIN
              IF NOT tempCostComp.GET(-1,"Cost Component",0) THEN BEGIN
                // save new occurance
                tempCostComp."Document Type" := -1;
                tempCostComp."Document No." := "Cost Component";
                tempCostComp."Line No." := 0;
                tempCostComp.INIT;
                tempCostComp.INSERT;
              END;
              //Total of the hour accounting lines (Field: Amount) for the project
              //where the posting date is equal or before the prognosis date
              //Total of the hour accounting lines (Field: Total line) for the project
              //where the posting date is equal or before the prognosis date
              //IF "Posting Date" <= PrevPrognosis."Prognosis Date" THEN BEGIN
              IF "Posting Date" <= Prognosis."Prognosis Date" THEN BEGIN
                //TotOpenAmtHours += Amount;
                //TotOpenHours += "Total Line";
                tempCostComp."Net Weight" += Amount;
      //>>ENH-011
                IF lCostComponent.GET("Cost Component") THEN
                  IF lCostComponent."Cost Type" = lCostComponent."Cost Type"::Labor THEN
      //<<ENH-011
                tempCostComp."Qty. to Invoice" += "Total Line";
                tempCostComp.MODIFY;
              END;
            END;
          UNTIL NEXT = 0;
        END;
        // Posted Hour Lines
        WITH PostedHourLine DO BEGIN
          RESET;
          SETCURRENTKEY("Project No.");
          IF ProjRec."Single/Main/Sub Project" = ProjRec."Single/Main/Sub Project"::"Main Project" THEN BEGIN
          //  SETRANGE("Main Project No.",ProjRec."No.")
            SubProject.RESET;
            SubProject.SETRANGE("Main Project",ProjRec."No.");
            IF SubProject.FINDSET THEN REPEAT
              // duplicate code as below
              SETRANGE("Project No.",SubProject."No.");
              SETFILTER("Cost Component",'<>%1','');
              IF FINDSET THEN REPEAT
                IF "Cost Component" <> '' THEN BEGIN
                  IF NOT tempCostComp.GET(-1,"Cost Component",0) THEN BEGIN
                    // save new occurance
                    tempCostComp."Document Type" := -1;
                    tempCostComp."Document No." := "Cost Component";
                    tempCostComp."Line No." := 0;
                    tempCostComp.INIT;
                    tempCostComp."Quantity Invoiced" := Amount;
      //>>4PS-001
                    tempCostComp."Gross Weight" := PostedHourLine."Surcharge Overtime" + PostedHourLine."Precalc. Surcharge Expenses";
      //<<4PS-001

                    tempCostComp.INSERT;
                  END ELSE BEGIN
                    tempCostComp."Quantity Invoiced" += Amount;
      //>>4PS-001
                    tempCostComp."Gross Weight" += PostedHourLine."Surcharge Overtime" + PostedHourLine."Precalc. Surcharge Expenses";
      //<<4PS-001
                    tempCostComp.MODIFY;
                  END;
                END;
              UNTIL NEXT = 0;
            UNTIL SubProject.NEXT = 0;
          END ELSE BEGIN
            // duplicate code as above
            SETRANGE("Project No.",ProjRec."No.");
            SETFILTER("Cost Component",'<>%1','');
            IF FINDSET THEN REPEAT
              IF "Cost Component" <> '' THEN BEGIN
                IF NOT tempCostComp.GET(-1,"Cost Component",0) THEN BEGIN
                  // save new occurance
                  tempCostComp."Document Type" := -1;
                  tempCostComp."Document No." := "Cost Component";
                  tempCostComp."Line No." := 0;
                  tempCostComp.INIT;
                  tempCostComp."Quantity Invoiced" := Amount;
                  tempCostComp.INSERT;
                END ELSE BEGIN
                  tempCostComp."Quantity Invoiced" += Amount;
                  tempCostComp.MODIFY;
                END;
              END;
            UNTIL NEXT = 0;
          END;
        END;

        // Prognosis Lines (cost component)
        //IF Prognosis."Prognosis Date" <> PrevPrognosis."Prognosis Date" THEN
          WITH PrognosisLine DO BEGIN
            RESET;
            SETCURRENTKEY("Project No.");
            IF ProjRec."Single/Main/Sub Project" = ProjRec."Single/Main/Sub Project"::"Main Project" THEN
              SETRANGE("Main Project No.",ProjRec."No.")
            ELSE
              SETRANGE("Project No.",ProjRec."No.");
            //SETRANGE("Prognosis Date",PrevPrognosis."Prognosis Date");
            SETRANGE("Prognosis Date",Prognosis."Prognosis Date");
            SETFILTER("Cost Component Code",'<>%1','');
            IF FINDSET THEN REPEAT
              IF "Cost Component Code" <> '' THEN BEGIN
                IF NOT tempCostComp.GET(-1,"Cost Component Code",0) THEN BEGIN
                  // save new occurance
                  tempCostComp."Document Type" := -1;
                  tempCostComp."Document No." := "Cost Component Code";
                  tempCostComp."Line No." := 0;
                  tempCostComp.INIT;
                  //tempCostComp.Description := FORMAT(Amount);
                  tempCostComp."Qty. to Ship (Base)" := "Prognosis Costs";
                  tempCostComp.INSERT;
                END ELSE BEGIN
                  //EVALUATE(_dec,tempCostComp.Description);
                  //tempCostComp.Description := FORMAT(Amount +_dec);
                  tempCostComp."Qty. to Ship (Base)" += "Prognosis Costs";
                  tempCostComp.MODIFY;
                END;
              END;
            UNTIL NEXT = 0;
          END;

        // Purchase Order Control Lines
        WITH PurchOrderCtrlLine DO BEGIN
          RESET;
          SETCURRENTKEY("Project No.");
          IF ProjRec."Single/Main/Sub Project" = ProjRec."Single/Main/Sub Project"::"Main Project" THEN
            SETRANGE("Main Project No.",ProjRec."No.")
          ELSE
            SETRANGE("Project No.",ProjRec."No.");
          SETFILTER("Cost Component",'<>%1','');
          SETRANGE(Date,0D,Prognosis."Prognosis Date");
          IF FINDSET THEN REPEAT
            IF "Cost Component" <> '' THEN BEGIN
              IF NOT tempCostComp.GET(-1,"Cost Component",0) THEN BEGIN
                // save new occurance
                tempCostComp."Document Type" := -1;
                tempCostComp."Document No." := "Cost Component";
                tempCostComp."Line No." := 0;
                tempCostComp.INIT;
                tempCostComp.INSERT;
              END;
              //Total of the Purchase order control lines with the date equal or before the prognosis date
              //IF Date <= PrevPrognosis."Prognosis Date" THEN BEGIN
              IF Date <= Prognosis."Prognosis Date" THEN BEGIN
                tempCostComp."Line Discount Amount" += "Outstanding Amount"
                  //+"Overhead Surcharge Soft"
                  //+"Overhead Surcharge Firm"
                  +"Amt. Rcd. Not Invoiced";
      //>>4PS-001
                tempCostComp."Surcharge Amount (FCY)" += "Overhead Surcharge Soft" + "Overhead Surcharge Firm";
      //<<4PS-001
                tempCostComp.MODIFY;
              END;
            END;
          UNTIL NEXT = 0;
        END;

        // Sales Lines (collect any other component)
        WITH SalesLine DO BEGIN
          RESET;
          SETCURRENTKEY("Document Type","Job No.");
          SETFILTER("Cost Component",'<>%1','');
          IF ProjRec."Single/Main/Sub Project" = ProjRec."Single/Main/Sub Project"::"Main Project" THEN BEGIN
          //  SETRANGE("Main Project No.",ProjRec."No.")
            SubProject.RESET;
            SubProject.SETRANGE("Main Project",ProjRec."No.");
            IF SubProject.FINDSET THEN REPEAT
              // duplicate code as below
              SETRANGE("Job No.",SubProject."No.");
              IF FINDSET THEN REPEAT
                IF "Cost Component" <> '' THEN BEGIN
                  IF NOT tempCostComp.GET(-1,"Cost Component",0) THEN BEGIN
                    // save new occurance
                    tempCostComp."Document Type" := -1;
                    tempCostComp."Document No." := "Cost Component";
                    tempCostComp."Line No." := 0;
                    tempCostComp.INIT;
                    tempCostComp.INSERT;
                  END;
                END;
              UNTIL NEXT = 0;
            UNTIL SubProject.NEXT = 0;
          END ELSE BEGIN
            // duplicate code as above
            SETRANGE("Job No.",ProjRec."No.");
            IF FINDSET THEN REPEAT
              IF "Cost Component" <> '' THEN BEGIN
                IF NOT tempCostComp.GET(-1,"Cost Component",0) THEN BEGIN
                  // save new occurance
                  tempCostComp."Document Type" := -1;
                  tempCostComp."Document No." := "Cost Component";
                  tempCostComp."Line No." := 0;
                  tempCostComp.INIT;
                  tempCostComp.INSERT;
                END;
              END;
            UNTIL NEXT = 0;
          END;
        END;
        // Project Installment (collect any other component)
        WITH ProjectInstallment DO BEGIN
          RESET;
          SETCURRENTKEY("Project No.");
          SETFILTER("Cost Component",'<>%1','');
          IF ProjRec."Single/Main/Sub Project" = ProjRec."Single/Main/Sub Project"::"Main Project" THEN BEGIN
          //  SETRANGE("Main Project No.",ProjRec."No.")
            SubProject.RESET;
            SubProject.SETRANGE("Main Project",ProjRec."No.");
            IF SubProject.FINDSET THEN REPEAT
              // duplicate code as below
              SETRANGE("Project No.",SubProject."No.");
              IF FINDSET THEN REPEAT
                IF "Cost Component" <> '' THEN
                  IF NOT tempCostComp.GET(-1,"Cost Component",0) THEN BEGIN
                    // save new occurance
                    tempCostComp."Document Type" := -1;
                    tempCostComp."Document No." := "Cost Component";
                    tempCostComp."Line No." := 0;
                    tempCostComp.INIT;
                    tempCostComp.INSERT;
                  END;
              UNTIL NEXT = 0;
            UNTIL SubProject.NEXT = 0;
          END ELSE BEGIN
            // duplicate code as above
            SETRANGE("Project No.",ProjRec."No.");
            IF FINDSET THEN REPEAT
              IF "Cost Component" <> '' THEN
                IF NOT tempCostComp.GET(-1,"Cost Component",0) THEN BEGIN
                  // save new occurance
                  tempCostComp."Document Type" := -1;
                  tempCostComp."Document No." := "Cost Component";
                  tempCostComp."Line No." := 0;
                  tempCostComp.INIT;
                  tempCostComp.INSERT;
                END;
            UNTIL NEXT = 0;
          END;
        END;
      //>>4PS-001
      //  { ** LAHE: will have other then Revenue cost objects but treated based on Principal cost object
        GLSetup.GET;
      //<<4PS-001
        // Project Cost Plus Entry (collect any other component)
        WITH ProjCostPlusEntry DO BEGIN
          RESET;
          SETCURRENTKEY("Project No.");
          SETRANGE("Project No.",ProjRec."No.");
          SETFILTER("Cost Component",'<>%1','');
      //>>4PS-001
          SETRANGE("Entry No. Project Ledger", 0);
          SETRANGE(Invoiced,FALSE);
      //<<4PS-001
          IF FINDSET THEN REPEAT
            IF NOT tempCostComp.GET(-1,"Cost Component",0) THEN BEGIN
              // save new occurance
              tempCostComp."Document Type" := -1;
              tempCostComp."Document No." := "Cost Component";
              tempCostComp."Line No." := 0;
              tempCostComp.INIT;
              tempCostComp.INSERT;
            END;

      //>>4PS-001
            IF ProjPrincipal.GET("Project No.",Principal) THEN
              IF DimVal.GET(GLSetup."Global Dimension 2 Code",ProjPrincipal."Cost Object") THEN
                IF NOT tempCostComp.GET(-1,DimVal."Cost Component",0) THEN BEGIN
                  // save new occurance
                  tempCostComp."Document Type" := -1;
                  tempCostComp."Document No." := DimVal."Cost Component";
                  tempCostComp."Line No." := 0;
                  tempCostComp.INIT;
                  tempCostComp.INSERT;
                END;
      //<<4PS-001
          UNTIL NEXT = 0;
        END;
      //>>4PS-001
      //  ** }
      //<<4PS-001

      //>>4PS-001
        WITH HourAccountingLine DO BEGIN
          RESET;
          SETCURRENTKEY("Project No.");
          IF ProjRec."Single/Main/Sub Project" = ProjRec."Single/Main/Sub Project"::"Main Project" THEN
            SETRANGE("Main Project No.",ProjRec."No.")
          ELSE
            SETRANGE("Project No.",ProjRec."No.");
          //<>%1
          //
          SETFILTER("Cost Component",'',' save new occurance');
          SETRANGE("Posting Date",0D,Prognosis."Prognosis Date");
          IF FINDSET THEN REPEAT
            IF "Cost Component" <> 'IF "Posting Date" <= PrevPrognosis."Prognosis Date" THEN BEGIN' THEN
              IF NOT tempCostComp.GET(-1,"Cost Component",0) THEN BEGIN
                //SETRANGE("Main Project No.",ProjRec."Main Project");
                tempCostComp."Document Type" := -1;
                tempCostComp."Document No." := "Cost Component";
                tempCostComp."Line No." := 0;
                tempCostComp.INIT;
                tempCostComp.INSERT;
              END;
              //SETRANGE("Job No.", ProjRec."No.");
              IF "Posting Date" <= Prognosis."Prognosis Date" THEN BEGIN
                tempCostComp."Unit Volume" += HourAccountingLine."Amount (LCY)";
                tempCostComp.MODIFY;
              END;
          UNTIL NEXT = 0;
        END;

        WITH ItemJournalLine DO BEGIN
          RESET;
          SETCURRENTKEY("Main Project No.");
          IF ProjRec."Single/Main/Sub Project" = ProjRec."Single/Main/Sub Project"::"Main Project" THEN
            SETRANGE("Main Project No.",ProjRec."No.")
          ELSE
            SETRANGE("Job No.",ProjRec."No.");
          //<>%1
          //
          SETFILTER("Cost Component",'',' save new occurance');
          SETRANGE("Posting Date",0D,Prognosis."Prognosis Date");
          IF FINDSET THEN REPEAT
            IF "Cost Component" <> 'IF "Posting Date" <= PrevPrognosis."Prognosis Date" THEN BEGIN' THEN
              IF NOT tempCostComp.GET(-1,"Cost Component",0) THEN BEGIN
                //<<4PS-001
                tempCostComp."Document Type" := -1;
                tempCostComp."Document No." := "Cost Component";
                tempCostComp."Line No." := 0;
                tempCostComp.INIT;
                tempCostComp.INSERT;
              END;
              // _revLoop for seperate non-revenue lines from renevue lines is now useless but does no harm
              IF "Posting Date" <= Prognosis."Prognosis Date" THEN BEGIN
                tempCostComp."Units per Parcel" += ItemJournalLine.Amount;
                tempCostComp.MODIFY;
              END;
          UNTIL NEXT = 0;
        END;
      //Exist("Dimension Value" WHERE (Cost Type=CONST(Revenue),Cost Component=FIELD(Cost Component Code)))

        //
        FOR _revLoop := 1 TO 2 DO BEGIN
         IF tempCostComp.FINDSET THEN REPEAT
         // PK: Project No.,Prognosis Date,Cost Component Code
          DimVal.RESET();
          DimVal.SETRANGE("Cost Type",DimVal."Cost Type"::Revenue);
          DimVal.SETRANGE("Cost Component",tempCostComp."Document No.");
          _revenue := NOT DimVal.ISEMPTY;
          IF ((_revLoop = 1) AND NOT _revenue)
            OR ((_revLoop = 2) AND _revenue)
          THEN BEGIN
            IF tempCostComp."Document No." <> ' LAHE 130214' THEN BEGIN
              // LAHE 130214
              IF NOT newPrognosisLine.GET(ProjRec."No.",PrognosisDate,tempCostComp."Document No.") THEN BEGIN // LAHE 130308
                newPrognosisLine.INIT;
                newPrognosisLine.VALIDATE("Project No.",ProjRec."No.");
                newPrognosisLine.VALIDATE("Prognosis Date",PrognosisDate);
                newPrognosisLine.VALIDATE("Cost Component Code",tempCostComp."Document No."); //>> LAHE 130528 IMSE-005
                newPrognosisLine.VALIDATE("Main Project No.",ProjRec."Main Project"); // LAHE 130708 - what to say, just dont validate..
      //>>ENH-011
                IF lCostComponent.GET(newPrognosisLine."Cost Component Code") THEN
                  newPrognosisLine."Cost Type" := lCostComponent."Cost Type"-1;
      //<<ENH-011
                newPrognosisLine.INSERT;
              END;

              //IF JobLedgEntry."Entry Type" = JobLedgEntry."Entry Type"::Sale THEN
              newPrognosisLine.CALCFIELDS(Revenue);
              IF newPrognosisLine.Revenue THEN BEGIN
                newPrognosisLine.Quantity := 0; ////SalesInvLine."Amount (LCY)";
                newPrognosisLine."Actual Revenues" := 0;
                JobLedgEntry.RESET;
                JobLedgEntry.SETCURRENTKEY("Job No.");
                IF ProjRec."Single/Main/Sub Project" = ProjRec."Single/Main/Sub Project"::"Main Project" THEN
                  JobLedgEntry.SETRANGE("Main Project No.",ProjRec."No.")
                ELSE
                  JobLedgEntry.SETRANGE("Job No.",ProjRec."No.");
                JobLedgEntry.SETRANGE("Cost Component",tempCostComp."Document No.");
                JobLedgEntry.SETRANGE("Entry Type", JobLedgEntry."Entry Type"::Sale);
                IF JobLedgEntry.FINDSET THEN REPEAT
                  // credit lines?
                    newPrognosisLine."Actual Revenues" -= JobLedgEntry."Total Price (LCY)"; //  SETRANGE("Main Project No.",ProjRec."No.")
                UNTIL JobLedgEntry.NEXT = 0; // duplicate code as below

                newPrognosisLine."Open Revenues" := 0;
                SalesLine.RESET;
                SalesLine.SETCURRENTKEY("Document Type","Job No.");
                SalesLine.SETRANGE("Document Type",SalesLine."Document Type"::Invoice,SalesLine."Document Type"::"Credit Memo");
                SalesLine.SETRANGE("Cost Component",tempCostComp."Document No.");
                IF ProjRec."Single/Main/Sub Project" = ProjRec."Single/Main/Sub Project"::"Main Project" THEN BEGIN
                // remove Blanket Order etc?
                  SubProject.RESET;
                  SubProject.SETRANGE("Main Project",ProjRec."No.");
                  IF SubProject.FINDSET THEN REPEAT
                    // duplicate code as above
                    SalesLine.SETRANGE("Job No.",SubProject."No.");
                    IF SalesLine.FINDSET THEN REPEAT
                      IF SalesLine."Document Type" IN
                        [SalesLine."Document Type"::"Credit Memo",SalesLine."Document Type"::"Return Order"]
                      THEN
                        newPrognosisLine."Open Revenues" -= SalesLine."Amount (LCY)"
                      ELSE
                        newPrognosisLine."Open Revenues" += SalesLine."Amount (LCY)";
                      // remove Blanket Order etc?
                    UNTIL SalesLine.NEXT = 0;
                  UNTIL SubProject.NEXT = 0;
                END ELSE BEGIN
                  //  SETRANGE("Main Project No.",ProjRec."No.")
                  SalesLine.SETRANGE("Job No.",ProjRec."No.");
                  IF SalesLine.FINDSET THEN REPEAT
                    IF SalesLine."Document Type" IN
                      [SalesLine."Document Type"::"Credit Memo",SalesLine."Document Type"::"Return Order"]
                    THEN
                      newPrognosisLine."Open Revenues" -= SalesLine."Amount (LCY)"
                    ELSE
                      newPrognosisLine."Open Revenues" += SalesLine."Amount (LCY)";
                    // duplicate code as below
                  UNTIL SalesLine.NEXT = 0;
                END;

                newPrognosisLine."Expected Revenues Installments" := 0;
                ProjectInstallment.RESET;
                ProjectInstallment.SETCURRENTKEY("Project No.");
                IF ProjRec."Single/Main/Sub Project" = ProjRec."Single/Main/Sub Project"::"Main Project" THEN BEGIN
                //MAHA *** 4PS-015 blocked*** <<
                  SubProject.RESET;
                  SubProject.SETRANGE("Main Project",ProjRec."No.");
                  IF SubProject.FINDSET THEN REPEAT
                    // ProjectInstallment.SETRANGE("Cost Component",tempCostComp."Document No.");
                    ProjectInstallment.SETRANGE("Project No.",SubProject."No.");
                    // >>
                    // value removed when invoicing begins or check flowfield "Invoice in Process (LCY)" etc?
                    // duplicate code as above
                    IF ProjectInstallment.FINDSET THEN REPEAT
                      // MAHA *** 4PS-015 blocked*** <<
                      newPrognosisLine."Expected Revenues Installments" += ProjectInstallment."Invoice Price (LCY)";
                    UNTIL ProjectInstallment.NEXT = 0;
                  UNTIL SubProject.NEXT = 0;
                END ELSE BEGIN
                  //ProjectInstallment.SETRANGE("Cost Component",tempCostComp."Document No.");
                  ProjectInstallment.SETRANGE("Project No.",ProjRec."No.");
                  // >>
                  // value removed when invoicing begins or check flowfield "Invoice in Process (LCY)" etc?
                  // In case of expected revenue for costplus entries, the cost object should be selected from the project principal card
                  IF ProjectInstallment.FINDSET THEN REPEAT
                    //use the cost componeent which is related to this cost object, instead of using the cost object from the costplus entry.
                    newPrognosisLine."Expected Revenues Installments" += ProjectInstallment."Invoice Price (LCY)";
                  UNTIL ProjectInstallment.NEXT = 0;
                END;

                GLSetup.GET;
                GLSetup.TESTFIELD("Global Dimension 2 Code");
                newPrognosisLine."Expected Revenues Cost Plus" := 0;
                ProjCostPlusEntry.RESET;
                //IF Prinicipal.Cost Object = Revenue Style then collect all cost plus for this project
                //>>4PS-001
                //<<4PS-001
                ProjCostPlusEntry.SETCURRENTKEY("Project No.");
      //  ProjCostPlusEntry.SETRANGE("Main Project No.",ProjRec."No.")
      // duplicate code as below
                ProjCostPlusEntry.SETRANGE(Invoiced,FALSE);
      // duplicate code as above
                IF ProjRec."Single/Main/Sub Project" = ProjRec."Single/Main/Sub Project"::"Main Project" THEN BEGIN
                //>>Call 4PS-001
                  SubProject.RESET;
                  SubProject.SETRANGE("Main Project",ProjRec."No.");
                  IF SubProject.FINDSET THEN REPEAT
                    //newPrognosisLine."Total Revenues"
                    ProjCostPlusEntry.SETRANGE("Project No.",SubProject."No.");
                    IF ProjCostPlusEntry.FINDSET THEN REPEAT
                      IF ProjPrincipal.GET(ProjCostPlusEntry."Project No.",ProjCostPlusEntry.Principal) THEN
                        IF DimVal.GET(GLSetup."Global Dimension 2 Code",ProjPrincipal."Cost Object") THEN
                          IF DimVal."Cost Type" = DimVal."Cost Type"::Revenue THEN
                            newPrognosisLine."Expected Revenues Cost Plus" += ProjCostPlusEntry."Sales Amount (LCY)"
                    UNTIL ProjCostPlusEntry.NEXT = 0;
                  UNTIL SubProject.NEXT = 0;
                END ELSE BEGIN
                  //<<Call 4PS-001
                  ProjCostPlusEntry.SETRANGE("Project No.",ProjRec."No.");
                  IF ProjCostPlusEntry.FINDSET THEN REPEAT
                    IF ProjPrincipal.GET(ProjCostPlusEntry."Project No.",ProjCostPlusEntry.Principal) THEN
                      IF DimVal.GET(GLSetup."Global Dimension 2 Code",ProjPrincipal."Cost Object") THEN
                        IF DimVal."Cost Type" = DimVal."Cost Type"::Revenue THEN
                          newPrognosisLine."Expected Revenues Cost Plus" += ProjCostPlusEntry."Sales Amount (LCY)"
                  UNTIL ProjCostPlusEntry.NEXT = 0;
                END;

                IF FillPrognosisExpectedRevenue THEN
                  newPrognosisLine."Prognosis Amount Revenue" := newPrognosisLine."Expected Revenues Installments"
                    +newPrognosisLine."Expected Revenues Cost Plus";

                newPrognosisLine."Total Revenues" :=
                  newPrognosisLine."Actual Revenues"
                  +newPrognosisLine."Open Revenues"
                  +newPrognosisLine."Expected Revenues Installments"
                  +newPrognosisLine."Expected Revenues Cost Plus";
                newPrognosisLine."Prognosis Total Revenues" :=
      // Manual input field
                  // NOT newPrognosisLine.Revenue
                  newPrognosisLine."Open Revenues" +
                  newPrognosisLine."Actual Revenues"
      //TotAmountBudget);
                  +newPrognosisLine."Prognosis Amount Revenue"; //TotHoursBudget);
              END ELSE BEGIN  //TotOpenAmtHours);
                newPrognosisLine.VALIDATE("Budget Amount",tempCostComp.Amount); //TotOpenHours);
                newPrognosisLine.VALIDATE("Budget Hours",tempCostComp.Quantity); //TotActualAmount);
                newPrognosisLine.VALIDATE("Open (Purchase)",tempCostComp."Line Discount Amount");
                newPrognosisLine.VALIDATE("Open Amount (Hours)",tempCostComp."Net Weight"); //TotActualHours);
                newPrognosisLine.VALIDATE("Open Hours",tempCostComp."Qty. to Invoice"); // flowfield! newPrognosisLine.VALIDATE("Previous Prognosis",tempCostComp."Payments (LCY)");
                newPrognosisLine.VALIDATE("Actual Costs",tempCostComp."Outstanding Amount"); //>> LAHE 130214
                newPrognosisLine.VALIDATE("Actual Hours",tempCostComp."Qty. Invoiced (Base)"); //>>4PS-001

                newPrognosisLine.VALIDATE("Total Cost",tempCostComp."Line Discount Amount"
                                                        +tempCostComp."Net Weight" +tempCostComp."Outstanding Amount");
                newPrognosisLine.VALIDATE("Total Hours",tempCostComp."Qty. to Invoice" +tempCostComp."Qty. Invoiced (Base)");

                newPrognosisLine.VALIDATE(Available,newPrognosisLine."Budget Amount" -newPrognosisLine."Total Cost");
                newPrognosisLine.VALIDATE("Available Hours",newPrognosisLine."Budget Hours" -newPrognosisLine."Total Hours");
                //newPrognosisLine."Prognosis Total Cost" := newPrognosisLine."Total Cost" +newPrognosisLine."Prognosis Costs";
                //<< 4PS-001
      //<< LAHE 130214
                //>>4PS-001
                newPrognosisLine."Prognosis Total Cost" := newPrognosisLine."Total Cost" +newPrognosisLine."Prognosis Costs" + newPrognosisLine."Overhead Surch. Progn. Costs" + newPrognosisLine."Ovh. Surcharge";
      // if minus then zero
                newPrognosisLine."Prognosis Total Hours" := newPrognosisLine."Total Hours" +newPrognosisLine."Prognosis Hours";
                newPrognosisLine."Prognosis End Result" := newPrognosisLine."Budget Amount" -newPrognosisLine."Prognosis Total Cost";
                //<<4PS-001
      //<< LAHE 130528
                newPrognosisLine."Open Ovh. Surch. (Purchase)" := tempCostComp."Surcharge Amount (FCY)";
                newPrognosisLine."Open Ovh. Surch. (Hours)" := tempCostComp."Gross Weight";
                newPrognosisLine."Open Amount (Hours)" := tempCostComp."Unit Volume";
                newPrognosisLine."Open (Inventory)" := tempCostComp."Units per Parcel";

                newPrognosisLine.Quantity := 1;
                newPrognosisLine.Price := newPrognosisLine.Available;
      //ENH-011 newPrognosisLine.VALIDATE("Prognosis Hours",newPrognosisLine."Budget Hours" -newPrognosisLine."Prognosis Hours");
                newPrognosisLine.VALIDATE("Prognosis Costs",newPrognosisLine.Quantity *newPrognosisLine.Price);
                newPrognosisLine.VALIDATE("Rate Code");
                // ***

      //>>ENH-011
                newPrognosisLine.VALIDATE("Prognosis Hours",0);
                IF (newPrognosisLine."Cost Type" = newPrognosisLine."Cost Type"::Labor) AND
                    (newPrognosisLine."Actual Hours"<>0) AND (newPrognosisLine."Actual Costs"<>0) THEN
                  newPrognosisLine.VALIDATE("Prognosis Hours",
                    newPrognosisLine."Prognosis Costs"/(newPrognosisLine."Actual Costs"/newPrognosisLine."Actual Hours"));
      //<<ENH-011

                IF newPrognosisLine."Prognosis Hours" < 0 THEN
                  newPrognosisLine.VALIDATE("Prognosis Hours",0);
                IF newPrognosisLine."Prognosis Costs" < 0 THEN
                  newPrognosisLine.VALIDATE("Prognosis Costs",0);
      //Budget: Total amount in the budget lines of the project with the version date equal or before the prognosis date.
              END;
              //Budget Hours: Total hours in the budget lines of the project with the version date equal or before the prognosis date.
      //>>ENH-011
              newPrognosisLine."Prognosis Total Hours" := newPrognosisLine."Total Hours" +newPrognosisLine."Prognosis Hours";
              IF lCostComponent.GET(newPrognosisLine."Cost Component Code") THEN
                newPrognosisLine."Cost Type" := lCostComponent."Cost Type"-1;
      //<<ENH-011
              newPrognosisLine.MODIFY;
            END;
          END;
         UNTIL tempCostComp.NEXT = 0;
        END;
      END;

      {Open purchase: Total of the Purchase order control lines with the date equal or before the prognosis date of the following fields:
      "Outstanding amount
      "Overhead surcharge soft commitments
      "Amount Rcd. Not invoiced
      "Overhead surcharge firm commitments
      Open Amount hours: Total of the hour accounting lines (Field: Amount) for the project where the posting date is equal or before th
      Open hours: Total of the hour accounting lines (Field: Total line) for the project where the posting date is equal or before the p
      Actual: Total of the project ledger entries for the project with a posting date equal or before the prognosis date (Field: Total p
      Actual hours: Total of the project ledger entries for the project with a posting date equal or before the prognosis date and cost
      Total cost: Open purchase + Open amount hours + Actual
      Total hours: Open hours + Actual hours
      Available: Budget -/- Total cost
      Available hours: Budget hours -/- total hours
      Previous prognosis: Amount from the previous prognosis for this project for this combination of element and cost component
      ***
      >>4PS-001
      <<4PS-001
      *** }

      IF CopyPrevCostPrognosis THEN
        CopyPrevPrognosisCC(Prognosis,FALSE);
      IF CopyPrevPrognosisEndResult THEN
        CopyPrevPrognosisCC(Prognosis,TRUE);
      IF FillProgWithAvailableCost THEN
        FillPrognosisWithAvailableCC(Prognosis);

      IF CopyPrevRevenuePrognosis2 THEN
        CopyPrevPrognosisRevenueCC(Prognosis);
      IF CopyPrevPrognosisEndResRevenue THEN
        CopyPrevPrognosisEndResRevCC(Prognosis);

      //>>4PS-001
      CalcPrognosisSurchargesCC(newPrognosisLine);
      CalcHoursSurchargesCC(newPrognosisLine);
      CalcPurchSurchargesCC(newPrognosisLine);
      //<<4PS-001
    END;

    PROCEDURE CopyPrevPrognosisCC@1100290001(IPrognosisHeader@1100525004 : Record 11012034;ICopyEndResult@1210190000 : Boolean);
    VAR
      PrevPrognosis@1100285000 : Record 11012034;
      newPrognEndRes@1100285001 : Decimal;
      lvType@1100285006 : Code[20];
      TEMPlPrognLineRec2@1100285005 : TEMPORARY Record 11128270;
      TEMPlPrognLineRec3@1100285010 : TEMPORARY Record 11128270;
      DimValRec@1100285003 : Record 349;
      DimMgt@1100285002 : Codeunit 408;
      SurchargeRec@1100285007 : Record 11020208;
      SurchDimValRec@1100285004 : Record 349;
      lvTotSurchAmount@1100285008 : Decimal;
      lvTotSurchPct@1100285009 : Decimal;
      CostComponent@1100285011 : Record 11012012;
    BEGIN
      PrevPrognosis.RESET;
      PrevPrognosis.SETRANGE("Project No.",IPrognosisHeader."Project No.");
      PrevPrognosis.SETRANGE("Prognosis Date",0D,IPrognosisHeader."Prognosis Date" -1);
      IF NOT PrevPrognosis.FINDLAST THEN
        EXIT;

      TEMPlPrognLineRec3.RESET;
      TEMPlPrognLineRec3.DELETEALL;
      DimMgt.GetDimValueRec(1, ProjRec."Global Dimension 1 Code", DimValRec, FALSE, ProjRec."No.");

      //For each line of the prognosis the fields will be filled with the value of the previous prognosis of the project.
      WITH PrognosisLine DO BEGIN
        RESET;
        IF ProjRec."Single/Main/Sub Project" = ProjRec."Single/Main/Sub Project"::"Main Project" THEN
          SETRANGE("Main Project No.",ProjRec."No.")
        ELSE
          SETRANGE("Project No.",PrevPrognosis."Project No.");
        SETRANGE("Prognosis Date",PrevPrognosis."Prognosis Date");
        IF FINDSET THEN
        REPEAT
          IF newPrognosisLine.GET("Project No.",IPrognosisHeader."Prognosis Date","Cost Component Code") THEN BEGIN

            newPrognosisLine.VALIDATE(Price, Price);
            newPrognosisLine.VALIDATE(Quantity, Quantity);
            newPrognosisLine."Prognosis Hours" := "Prognosis Hours";
            newPrognosisLine."Unit of Measure" := "Unit of Measure";
            newPrognosisLine.VALIDATE("Prognosis Costs", (newPrognosisLine.Quantity *newPrognosisLine.Price)
              +(newPrognosisLine."Prognosis Hours" *newPrognosisLine.Rate));

      //>>IME066
            IF NOT CostComponent.GET("Cost Component Code") THEN
              CostComponent.INIT;
            IF CostComponent."Used for surcharge" AND (newPrognosisLine."Prognosis Costs" <> 0) THEN
              newPrognosisLine.VALIDATE("Prognosis Costs",0);
      //<<IME066

            IF newPrognosisLine.Quantity <>0 THEN
              newPrognosisLine.Price := newPrognosisLine."Prognosis Costs" / newPrognosisLine.Quantity;

      //>>IME065
            //newPrognosisLine."Prognosis Total Revenues" := "Prognosis Total Revenues"; //4PSSE131002
      //<<IME065

            IF NOT ICopyEndResult THEN
              newPrognosisLine."Rate Code" := "Rate Code"
            ELSE BEGIN
              //?newPrognosisLine."Actual Hours"
              //?newPrognosisLine."Actual Costs"
      //>>ENH-011
              newPrognosisLine.VALIDATE("Prognosis Hours",0);
              IF (newPrognosisLine."Cost Type" = newPrognosisLine."Cost Type"::Labor) AND
                  (newPrognosisLine."Actual Hours"<>0) AND (newPrognosisLine."Actual Costs"<>0) THEN
                newPrognosisLine.VALIDATE("Prognosis Hours",
                  newPrognosisLine."Prognosis Costs"/(newPrognosisLine."Actual Costs"/newPrognosisLine."Actual Hours"));
      //<<ENH-011
            END;
            newPrognosisLine.Rate := Rate;
            newPrognosisLine.Comment := Comment;

            //newPrognosisLine.CheckSurchargesCalculated;
            newPrognosisLine.CalculateAmount;

            IF ICopyEndResult THEN
              IF PrognosisLine."Prognosis End Result" <> newPrognosisLine."Prognosis End Result" THEN BEGIN

                //get "Overhead Surch. Progn. Costs"  from "Prognosis Costs"
                TEMPlPrognLineRec2 := newPrognosisLine;
                lvTotSurchAmount := 0;
                lvType := ProjRec."Project Type";
                IF newPrognosisLine."Overhead Surch. Progn. Costs" <> 0 THEN BEGIN
                  IF SurchargeRec.GetSurcharges(0, lvType, newPrognosisLine."Project No.",
                                                (DimValRec."Cost Type" <> DimValRec."Cost Type"::Revenue),
                                                DimValRec."Cost Type", DimValRec.Code, '',
                                                ProjRec."Global Dimension 1 Code", '',      //M21761
                                                newPrognosisLine."Cost Component Code", newPrognosisLine."Prognosis Date",
                                                SurchargeRec) THEN
                  BEGIN
                    REPEAT
                      SurchargeRec.GetSurchargeDimVal(DimValRec, SurchDimValRec);
                      InitPrognosisSurcharge(TEMPlPrognLineRec2,
                                TEMPlPrognLineRec2."Prognosis Costs",
                                TEMPlPrognLineRec2."Overhead Surch. Progn. Costs",
                                DimValRec, SurchDimValRec, SurchargeRec, '', lvType, lvTotSurchAmount, '');

                    UNTIL SurchargeRec.NEXT = 0;
                  END;
                  IF TEMPlPrognLineRec2."Prognosis Costs" <> 0 THEN
                    lvTotSurchPct :=
                                lvTotSurchAmount / TEMPlPrognLineRec2."Prognosis Costs";

                  newPrognosisLine.Comment := FORMAT(lvTotSurchPct) + ' ' + FORMAT(TEMPlPrognLineRec2."Overhead Surch. Progn. Costs");
                END
                ELSE BEGIN
                  IF SurchargeRec.GetSurcharges(0, lvType, newPrognosisLine."Project No.",
                                                (DimValRec."Cost Type" <> DimValRec."Cost Type"::Revenue),
                                                DimValRec."Cost Type", DimValRec.Code, '',
                                                ProjRec."Global Dimension 1 Code", '',      //M21761
                                                newPrognosisLine."Cost Component Code", newPrognosisLine."Prognosis Date",
                                                SurchargeRec) THEN
                  BEGIN
                    REPEAT
                      SurchargeRec.GetSurchargeDimVal(DimValRec, SurchDimValRec);
                      IF newPrognosisLine."Cost Component Code" <> SurchDimValRec."Cost Component" THEN BEGIN
                        TEMPlPrognLineRec3.INIT;
                        TEMPlPrognLineRec3."Project No." := newPrognosisLine."Project No.";
                        TEMPlPrognLineRec3."Prognosis Date" := newPrognosisLine."Prognosis Date";
                        TEMPlPrognLineRec3."Cost Component Code" := SurchDimValRec."Cost Component";
                        IF TEMPlPrognLineRec3.INSERT THEN;
                      END;
                    UNTIL SurchargeRec.NEXT = 0;
                  END;
                END;
                //newPrognosisLine.CalculateAmount;
                newPrognosisLine.VALIDATE("Prognosis Costs",
                  newPrognosisLine."Prognosis Costs" + (newPrognosisLine."Prognosis End Result" - PrognosisLine."Prognosis End Result"));
      //>>IME066
                IF CostComponent."Used for surcharge" AND (newPrognosisLine."Prognosis Costs" <> 0) THEN
                  newPrognosisLine.VALIDATE("Prognosis Costs",0);
      //<<IME066
                IF newPrognosisLine.Quantity <>0 THEN
                  newPrognosisLine.Price := newPrognosisLine."Prognosis Costs" / newPrognosisLine.Quantity;
                //recalc of surchagelines


      //>>IME066
                //CalcPrognosisSurchargesCC(newPrognosisLine);
                newPrognosisLine.MODIFY;
                CalcPrognosisSurchargesCC(newPrognosisLine);
                newPrognosisLine.GET("Project No.",IPrognosisHeader."Prognosis Date","Cost Component Code");
      //<<IME066
              END;

            newPrognosisLine.MODIFY;
          END;
        UNTIL NEXT = 0;
      END;


      //4PSSE131002
      IF TEMPlPrognLineRec3.FINDSET THEN
      REPEAT
        WITH PrognosisLine DO BEGIN
          RESET;
          IF ProjRec."Single/Main/Sub Project" = ProjRec."Single/Main/Sub Project"::"Main Project" THEN
            SETRANGE("Main Project No.",ProjRec."No.")
          ELSE
            SETRANGE("Project No.",PrevPrognosis."Project No.");
          SETRANGE("Prognosis Date",PrevPrognosis."Prognosis Date");
          SETRANGE("Cost Component Code", TEMPlPrognLineRec3."Cost Component Code");
          IF FINDSET THEN
          REPEAT
            IF newPrognosisLine.GET("Project No.",IPrognosisHeader."Prognosis Date","Cost Component Code") THEN BEGIN

              newPrognosisLine.VALIDATE(Price, Price);
              newPrognosisLine.VALIDATE(Quantity, Quantity);
              newPrognosisLine."Prognosis Hours" := "Prognosis Hours";
              newPrognosisLine."Unit of Measure" := "Unit of Measure";
              newPrognosisLine.VALIDATE("Prognosis Costs", (newPrognosisLine.Quantity *newPrognosisLine.Price)
                +(newPrognosisLine."Prognosis Hours" *newPrognosisLine.Rate));
      //>>IME066
            IF NOT CostComponent.GET("Cost Component Code") THEN
              CostComponent.INIT;
            IF CostComponent."Used for surcharge" AND (newPrognosisLine."Prognosis Costs" <> 0) THEN
              newPrognosisLine.VALIDATE("Prognosis Costs",0);
      //<<IME066
              IF newPrognosisLine.Quantity <>0 THEN
                newPrognosisLine.Price := newPrognosisLine."Prognosis Costs" / newPrognosisLine.Quantity;

      //>>IME065
              //newPrognosisLine."Prognosis Total Revenues" := "Prognosis Total Revenues"; //?newPrognosisLine."Actual Hours"
              newPrognosisLine.VALIDATE("Prognosis Amount Revenue", "Prognosis Amount Revenue");
      //<<IME065

              IF NOT ICopyEndResult THEN
                newPrognosisLine."Rate Code" := "Rate Code"
              ELSE BEGIN
                //?newPrognosisLine."Actual Costs"
                //?newPrognosisLine."Actual Costs"
      //>>ENH-011
                newPrognosisLine.VALIDATE("Prognosis Hours",0);
                IF (newPrognosisLine."Cost Type" = newPrognosisLine."Cost Type"::Labor) AND
                    (newPrognosisLine."Actual Hours"<>0) AND (newPrognosisLine."Actual Costs"<>0) THEN
                  newPrognosisLine.VALIDATE("Prognosis Hours",
                    newPrognosisLine."Prognosis Costs"/(newPrognosisLine."Actual Costs"/newPrognosisLine."Actual Hours"));
      //<<ENH-011
              END;
              newPrognosisLine.Rate := Rate;
              newPrognosisLine.Comment := Comment;

              //newPrognosisLine.CheckSurchargesCalculated;
              newPrognosisLine.CalculateAmount;

              IF ICopyEndResult THEN
                IF PrognosisLine."Prognosis End Result" <> newPrognosisLine."Prognosis End Result" THEN BEGIN
                  newPrognosisLine.VALIDATE("Prognosis Costs",
                    newPrognosisLine."Prognosis Costs" + (newPrognosisLine."Prognosis End Result" - PrognosisLine."Prognosis End Result"));
      //>>IME066
                  IF CostComponent."Used for surcharge" AND (newPrognosisLine."Prognosis Costs" <> 0) THEN
                    newPrognosisLine.VALIDATE("Prognosis Costs",0);
      //<<IME066
                  IF newPrognosisLine.Quantity <>0 THEN
                    newPrognosisLine.Price := newPrognosisLine."Prognosis Costs" / newPrognosisLine.Quantity;
                  //newPrognosisLine.CalculateAmount;


      //>>IME066
                  //CalcPrognosisSurchargesCC(newPrognosisLine);
                  newPrognosisLine.MODIFY;
                  CalcPrognosisSurchargesCC(newPrognosisLine);
                  newPrognosisLine.GET("Project No.",IPrognosisHeader."Prognosis Date","Cost Component Code");
      //<<IME066
                END;

              newPrognosisLine.MODIFY;
            END;
          UNTIL NEXT = 0;
        END;
      UNTIL TEMPlPrognLineRec3.NEXT = 0;
    END;

    PROCEDURE FillPrognosisWithAvailableCC@1100290002(IPrognosisHeader@1100525002 : Record 11012034);
    VAR
      ProjSetup@1100525005 : Record 315;
      lPrognLineRec@11012000 : Record 11128270;
      RateRec@1100525000 : Record 11012000;
      DimValRec@1100525004 : Record 349;
      DimMgt@1100525003 : Codeunit 408;
      lvRate@1100525001 : Decimal;
      CostComponent@1100285000 : Record 11012012;
    BEGIN
      //PrevPrognosis.RESET;
      //PrevPrognosis.SETRANGE("Project No.",IPrognosisHeader."Project No.");
      //PrevPrognosis.SETRANGE("Prognosis Date",0D,IPrognosisHeader."Prognosis Date" -1);
      //IF NOT PrevPrognosis.FINDLAST THEN
      //  EXIT;

      //For each line of the prognosis the fields will be filled with the value of the previous prognosis of the project.
      WITH PrognosisLine DO BEGIN
        RESET;
        IF ProjRec."Single/Main/Sub Project" = ProjRec."Single/Main/Sub Project"::"Main Project" THEN
          SETRANGE("Main Project No.",ProjRec."No.")
        ELSE
          //SETRANGE("Project No.",PrevPrognosis."Project No.");
          SETRANGE("Project No.",ProjRec."No.");
        //SETRANGE("Prognosis Date",PrevPrognosis."Prognosis Date");
        SETRANGE("Prognosis Date",IPrognosisHeader."Prognosis Date");
        IF FINDSET THEN REPEAT
          IF newPrognosisLine.GET("Project No.",IPrognosisHeader."Prognosis Date","Cost Component Code") THEN BEGIN
            newPrognosisLine.Quantity := 1;
            newPrognosisLine.Price := newPrognosisLine.Available;
            //ENH-011  newPrognosisLine.VALIDATE("Prognosis Hours",newPrognosisLine."Budget Hours" -"Prognosis Hours");
            newPrognosisLine.VALIDATE("Prognosis Costs",newPrognosisLine.Quantity *newPrognosisLine.Price);
            newPrognosisLine.VALIDATE("Unit of Measure","Unit of Measure");
            newPrognosisLine.VALIDATE("Rate Code","Rate Code");
            newPrognosisLine.VALIDATE(Rate,Rate);

      //>>ENH-011
            newPrognosisLine.VALIDATE("Prognosis Hours",0);
            IF (newPrognosisLine."Cost Type" = newPrognosisLine."Cost Type"::Labor) AND
                (newPrognosisLine."Actual Hours"<>0) AND (newPrognosisLine."Actual Costs"<>0) THEN
              newPrognosisLine.VALIDATE("Prognosis Hours",
                newPrognosisLine."Prognosis Costs"/(newPrognosisLine."Actual Costs"/newPrognosisLine."Actual Hours"));
      //<<ENH-011

            // if minus then zero
            IF newPrognosisLine."Prognosis Hours" < 0 THEN
              newPrognosisLine.VALIDATE("Prognosis Hours",0);
            IF newPrognosisLine."Prognosis Costs" < 0 THEN
              newPrognosisLine.VALIDATE("Prognosis Costs",0);
      //>>IME066
            IF NOT CostComponent.GET("Cost Component Code") THEN
              CostComponent.INIT;
            IF CostComponent."Used for surcharge" THEN
              newPrognosisLine.VALIDATE("Prognosis Costs",0);
      //<<IME066
            newPrognosisLine.Comment := Comment;
            newPrognosisLine.MODIFY;
          END;
        UNTIL NEXT = 0;
      END;
    END;

    PROCEDURE CopyPrevPrognosisRevenueCC@1000000005(IPrognosisHeader@1100525004 : Record 11012034);
    VAR
      PrevPrognosis@1100285000 : Record 11012034;
    BEGIN
      PrevPrognosis.RESET;
      PrevPrognosis.SETRANGE("Project No.",IPrognosisHeader."Project No.");
      PrevPrognosis.SETRANGE("Prognosis Date",0D,IPrognosisHeader."Prognosis Date" -1);
      IF NOT PrevPrognosis.FINDLAST THEN
        EXIT;

      //This will enter the same prognosis amount in the prognosis for the revenue lines
      //as the last prognosis for the same cost component
      WITH PrognosisLine DO BEGIN
        RESET;
        IF ProjRec."Single/Main/Sub Project" = ProjRec."Single/Main/Sub Project"::"Main Project" THEN
          SETRANGE("Main Project No.",ProjRec."No.")
        ELSE
          SETRANGE("Project No.",PrevPrognosis."Project No.");
        SETRANGE("Prognosis Date",PrevPrognosis."Prognosis Date");
        IF FINDSET THEN REPEAT
          IF newPrognosisLine.GET("Project No.",IPrognosisHeader."Prognosis Date","Cost Component Code") THEN BEGIN
            newPrognosisLine.CALCFIELDS(Revenue);
            IF newPrognosisLine.Revenue THEN BEGIN
              newPrognosisLine.VALIDATE("Prognosis Amount Revenue","Prognosis Amount Revenue");
              newPrognosisLine.Comment := Comment;
              newPrognosisLine.MODIFY;
            END;
          END;
        UNTIL NEXT = 0;
      END;
    END;

    PROCEDURE CopyPrevPrognosisEndResRevCC@1000000004(IPrognosisHeader@1100525002 : Record 11012034);
    VAR
      ProjSetup@1100525005 : Record 315;
      lPrognLineRec@11012000 : Record 11128270;
      RateRec@1100525000 : Record 11012000;
      DimValRec@1100525004 : Record 349;
      DimMgt@1100525003 : Codeunit 408;
      lvRate@1100525001 : Decimal;
      PrevPrognosis@1100285000 : Record 11012034;
      CostComponent@1100285001 : Record 11012012;
    BEGIN
      PrevPrognosis.RESET;
      PrevPrognosis.SETRANGE("Project No.",IPrognosisHeader."Project No.");
      PrevPrognosis.SETRANGE("Prognosis Date",0D,IPrognosisHeader."Prognosis Date" -1);
      IF NOT PrevPrognosis.FINDLAST THEN
        EXIT;

      //Copy Previous Prognosis End Result Revenue
      //This will enter the prognosis amount so that the result of the line is the same as in the last prognosis .
      WITH PrognosisLine DO BEGIN
        RESET;
        IF ProjRec."Single/Main/Sub Project" = ProjRec."Single/Main/Sub Project"::"Main Project" THEN
          SETRANGE("Main Project No.",ProjRec."No.")
        ELSE
          SETRANGE("Project No.",PrevPrognosis."Project No.");
        SETRANGE("Prognosis Date",PrevPrognosis."Prognosis Date");
        IF FINDSET THEN REPEAT
          IF newPrognosisLine.GET("Project No.",IPrognosisHeader."Prognosis Date","Cost Component Code") THEN BEGIN
      //>>IME066
            IF NOT CostComponent.GET("Cost Component Code") THEN
              CostComponent.INIT;
            IF CostComponent."Used for surcharge" THEN BEGIN
              newPrognosisLine.VALIDATE("Prognosis Costs",0);
              newPrognosisLine.Comment := Comment;
              newPrognosisLine.MODIFY;
            END;
      //<<IME066

            newPrognosisLine.CALCFIELDS(Revenue);
            IF newPrognosisLine.Revenue THEN BEGIN
      //>>Call 4PS-001
              //newPrognosisLine."Prognosis Amount Revenue" := "Total Revenues" -newPrognosisLine."Prognosis Total Revenues";
      //>>IME065
              //newPrognosisLine."Prognosis Amount Revenue" := "Actual Revenues" + "Open Revenues" -newPrognosisLine."Prognosis Total Revenues";
              newPrognosisLine.VALIDATE("Prognosis Amount Revenue", "Actual Revenues" + "Open Revenues" -newPrognosisLine."Prognosis Total Revenues");
      //<<IME065
      //<<Call 4PS-001
              newPrognosisLine.Comment := Comment;
              newPrognosisLine.MODIFY;
            END;
          END;
        UNTIL NEXT = 0;
      END;
    END;

    PROCEDURE CalcPrognosisSurchargesCC@11128001(VAR lPrognLineRec@1100285000 : Record 11128270);
    VAR
      Text001@1100285013 : TextConst 'ENU=Project %1 -  Element %2 does not exist (from surcharges);SVE=Projekt %1 Í elementet %2 finns inte (fr†n till„ggsavgifter)';
      lvType@1100285001 : Code[20];
      lPrognLineRec2@1100285005 : Record 11128270;
      lPrognLineRec3@1100285002 : Record 11128270;
      DimValRec@1100285004 : Record 349;
      DimMgt@1100285003 : Codeunit 408;
    BEGIN
      //4PSSE, 4PS-001

      //>>ENH025
      //ProjRec.GET(lPrognLineRec."Project No.");
      IF NOT ProjRec.GET(lPrognLineRec."Project No.") THEN
        EXIT;
      //<<ENH025

      lvType := ProjRec."Project Type";
      lPrognLineRec."Overhead Surch. Progn. Costs" := 0;
      lPrognLineRec."Ovh. Surcharge" := 0;

      lPrognLineRec3.RESET;
      lPrognLineRec3.SETRANGE("Project No.", lPrognLineRec."Project No.");
      lPrognLineRec3.SETRANGE("Prognosis Date", lPrognLineRec."Prognosis Date");
      //lPrognLineRec3.SETFILTER("Cost Component Code",'<>%1',lPrognLineRec."Cost Component Code");
      IF NOT lPrognLineRec3.ISEMPTY THEN
        lPrognLineRec3.MODIFYALL("Overhead Surch. Progn. Costs", 0, FALSE);

      lPrognLineRec3.RESET;
      lPrognLineRec3 := lPrognLineRec;

      DimMgt.GetDimValueRec(1, ProjRec."Global Dimension 1 Code", DimValRec, FALSE, ProjRec."No.");

      CalcPrognosisSurcharge(lPrognLineRec3, DimValRec, ProjRec, lvType);


      lPrognLineRec2.RESET;
      lPrognLineRec2.SETRANGE("Project No.",ProjRec."No.");
      lPrognLineRec2.SETRANGE("Prognosis Date",lPrognLineRec."Prognosis Date");
      lPrognLineRec2.SETFILTER("Cost Component Code",'<>%1',lPrognLineRec."Cost Component Code");
      //lPrognLineRec2.SETFILTER("Prognosis Costs",'<>0');
      IF lPrognLineRec2.FINDSET THEN
      REPEAT
        CalcPrognosisSurcharge(lPrognLineRec2, DimValRec, ProjRec, lvType);
      UNTIL lPrognLineRec2.NEXT=0;
    END;

    LOCAL PROCEDURE CalcPrognosisSurcharge@1100285000(lPrognLineRec@1100285000 : Record 11128270;DimValRec@1100285005 : Record 349;ProjRec@1100285004 : Record 11072003;lvType@1100285003 : Code[20]);
    VAR
      ProjectTypeRec@1100285011 : Record 11012009;
      SurchargeRec@1100285010 : Record 11020208;
      SurchDimValRec@1100285009 : Record 349;
      lPrognLineRec2@1100285008 : Record 11128270;
      lPrognLineRec3@1100285007 : Record 11128270;
      lProjectElementRec@1100285006 : Record 11012010;
      lvOrigin@1100285002 : 'Project,Service';
      lvTotSurchAmount@1100285001 : Decimal;
    BEGIN
      //4PSSE, 4PS-001
      IF SurchargeRec.GetSurcharges(lvOrigin::Project, lvType, lPrognLineRec."Project No.",
                                    (DimValRec."Cost Type" <> DimValRec."Cost Type"::Revenue),
                                    DimValRec."Cost Type", DimValRec.Code, '',
                                    ProjRec."Global Dimension 1 Code", '',      //M21761
                                    lPrognLineRec."Cost Component Code", lPrognLineRec."Prognosis Date",
                                    SurchargeRec) THEN
      BEGIN
        lPrognLineRec."Overhead Surch. Progn. Costs" := 0;

        REPEAT
          SurchargeRec.GetSurchargeDimVal(DimValRec, SurchDimValRec);

          lPrognLineRec2 := lPrognLineRec;

          InitPrognosisSurcharge(lPrognLineRec2,
                    lPrognLineRec2."Prognosis Costs",
                    lPrognLineRec2."Overhead Surch. Progn. Costs",
                    DimValRec, SurchDimValRec, SurchargeRec, '', lvType, lvTotSurchAmount, '');

          //There is now a line filled with a cost and a surcharge.
          //The corresponding line should be looked up in the table and the
          //storage fee should be rehearsal.

            lPrognLineRec3.INIT;
            lPrognLineRec3.RESET;
            IF lPrognLineRec3.GET(lPrognLineRec2."Project No.",
                                  lPrognLineRec2."Prognosis Date",
                                  SurchDimValRec."Cost Component") THEN
            BEGIN
              lPrognLineRec3."Overhead Surch. Progn. Costs" := lPrognLineRec3."Overhead Surch. Progn. Costs" + lPrognLineRec2."Overhead Surch. Progn. Costs";
              lPrognLineRec3.VALIDATE("Prognosis Date", lPrognLineRec2."Prognosis Date");
              lPrognLineRec3.CalculatePrognosisFields;
              lPrognLineRec3.VALIDATE("Prognosis Total Cost");
              lPrognLineRec3.MODIFY;
            END ELSE BEGIN
              IF lPrognLineRec2.Element <> '' THEN BEGIN
                IF NOT lProjectElementRec.GET(lPrognLineRec2."Project No.", lPrognLineRec2.Element) THEN
                  ERROR(STRSUBSTNO(Text001, lPrognLineRec2."Project No.", lPrognLineRec2.Element));
              END;
              lPrognLineRec3."Project No." := lPrognLineRec2."Project No.";
              lPrognLineRec3."Cost Component Code" := SurchDimValRec."Cost Component";
              lPrognLineRec3.VALIDATE("Prognosis Date", lPrognLineRec2."Prognosis Date");
              lPrognLineRec3."Cost Type" := SurchDimValRec."Cost Type";
              lPrognLineRec3."Overhead Surch. Progn. Costs" := lPrognLineRec2."Overhead Surch. Progn. Costs";
              lPrognLineRec3.CalculatePrognosisFields;
              lPrognLineRec3.VALIDATE("Prognosis Total Cost");
              lPrognLineRec3.INSERT(TRUE);   //db, 21-12-12: apply insert-trigger
            END;

        UNTIL SurchargeRec.NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE InitPrognosisSurcharge@11128003(VAR lProgLineRec@1210190002 : Record 11128270;VAR BaseAmt@1100285001 : Decimal;VAR OHSurch@1100285000 : Decimal;OrigDimRec@1210190001 : Record 349;SurchDimRec@1210190009 : Record 349;SurchargeRec@1210190004 : Record 11020208;Dim1@1210190005 : Code[20];ProjType@1210190006 : Code[20];VAR vTotSurchAmount@1100485002 : Decimal;VendorPostingGroup@1100525000 : Code[20]);
    BEGIN
      //4PSSE, 4PS-001
      IF SurchargeRec.Percentage <> 0 THEN
        IF SurchargeRec."Surcharge over Surcharge" THEN
          OHSurch := ROUND((BaseAmt + vTotSurchAmount) * SurchargeRec.Percentage/100)
        ELSE
          OHSurch := ROUND(BaseAmt * SurchargeRec.Percentage/100)
      ELSE
        OHSurch := ROUND(SurchargeRec.Amount * lProgLineRec.Quantity);

      lProgLineRec."Unit of Measure" := SurchDimRec."Unit of Measure";
      lProgLineRec."Cost Type" := SurchDimRec."Cost Type";

      IF SurchargeRec."Element Surcharge" <> '' THEN     //** CALL 19699 10-06-2010
        lProgLineRec.Element := SurchargeRec."Element Surcharge";

      vTotSurchAmount := vTotSurchAmount + OHSurch;
    END;

    PROCEDURE CalcHoursSurchargesCC@1100285002(VAR lPrognLineRec@1100285000 : Record 11128270);
    VAR
      lvType@1100285005 : Code[20];
      lPrognLineRec2@1100285004 : Record 11128270;
      lPrognLineRec3@1100285003 : Record 11128270;
      DimValRec@1100285002 : Record 349;
      DimMgt@1100285001 : Codeunit 408;
    BEGIN
      //4PSSE, 4PS-001
      //>>ENH025
      //ProjRec.GET(lPrognLineRec."Project No.");
      IF NOT ProjRec.GET(lPrognLineRec."Project No.") THEN
        EXIT;
      //<<ENH025
      lvType := ProjRec."Project Type";

      lPrognLineRec3.RESET;
      lPrognLineRec3.SETRANGE("Project No.", lPrognLineRec."Project No.");
      lPrognLineRec3.SETRANGE("Prognosis Date", lPrognLineRec."Prognosis Date");
      lPrognLineRec3.SETFILTER("Cost Component Code",'<>%1',lPrognLineRec."Cost Component Code");
      IF NOT lPrognLineRec3.ISEMPTY THEN
        lPrognLineRec3.MODIFYALL("Open Ovh. Surch. (Hours)", 0, FALSE);
      lPrognLineRec."Open Ovh. Surch. (Hours)" := 0;

      lPrognLineRec3.RESET;
      lPrognLineRec3 := lPrognLineRec;

      DimMgt.GetDimValueRec(1, ProjRec."Global Dimension 1 Code", DimValRec, FALSE, ProjRec."No.");

      CalcHoursSurchargeCC(lPrognLineRec3, DimValRec, ProjRec, lvType);

      lPrognLineRec2.RESET;
      lPrognLineRec2.SETRANGE("Project No.",ProjRec."No.");
      lPrognLineRec2.SETRANGE("Prognosis Date",lPrognLineRec."Prognosis Date");
      lPrognLineRec2.SETFILTER("Cost Component Code",'<>%1',lPrognLineRec."Cost Component Code");
      lPrognLineRec2.SETFILTER("Open Amount (Hours)",'<>0');
      IF lPrognLineRec2.FINDSET THEN
      REPEAT
        CalcHoursSurchargeCC(lPrognLineRec2, DimValRec, ProjRec, lvType);
      UNTIL lPrognLineRec2.NEXT=0;
    END;

    LOCAL PROCEDURE CalcHoursSurchargeCC@1100285011(lPrognLineRec@1100285003 : Record 11128270;DimValRec@1100285002 : Record 349;ProjRec@1100285001 : Record 11072003;lvType@1100285000 : Code[20]);
    VAR
      ProjectTypeRec@1100285011 : Record 11012009;
      SurchargeRec@1100285010 : Record 11020208;
      SurchDimValRec@1100285009 : Record 349;
      lPrognLineRec2@1100285008 : Record 11128270;
      lPrognLineRec3@1100285007 : Record 11128270;
      lProjectElementRec@1100285006 : Record 11012010;
      lvOrigin@1100285005 : 'Project,Service';
      lvTotSurchAmount@1100285004 : Decimal;
    BEGIN
      //4PSSE, 4PS-001
      IF SurchargeRec.GetSurcharges(lvOrigin::Project, lvType, lPrognLineRec."Project No.",
                                    (DimValRec."Cost Type" <> DimValRec."Cost Type"::Revenue),
                                    DimValRec."Cost Type", DimValRec.Code, '',
                                    ProjRec."Global Dimension 1 Code", '',      //M21761
                                    lPrognLineRec."Cost Component Code", lPrognLineRec."Prognosis Date",
                                    SurchargeRec) THEN
      BEGIN
        REPEAT
          SurchargeRec.GetSurchargeDimVal(DimValRec, SurchDimValRec);

          lPrognLineRec2 := lPrognLineRec;
          lPrognLineRec2."Open Ovh. Surch. (Hours)" := 0;

          InitPrognosisSurcharge(lPrognLineRec2,
                lPrognLineRec2."Open Amount (Hours)",
                lPrognLineRec2."Open Ovh. Surch. (Hours)",
                DimValRec, SurchDimValRec, SurchargeRec, '', lvType, lvTotSurchAmount, '');

          //There is now a line filled with a cost and a surcharge.
          //The corresponding line should be looked up in the table and the
          //storage fee should be rehearsal.
          IF lPrognLineRec2."Open Ovh. Surch. (Hours)" <> 0 THEN BEGIN
            lPrognLineRec3.INIT;
            lPrognLineRec3.RESET;
            IF lPrognLineRec3.GET(lPrognLineRec2."Project No.",
                                  lPrognLineRec2."Prognosis Date",
                                  SurchDimValRec."Cost Component") THEN
            BEGIN
              lPrognLineRec3."Open Ovh. Surch. (Hours)" := lPrognLineRec3."Open Ovh. Surch. (Hours)" + lPrognLineRec2."Open Ovh. Surch. (Hours)";
              lPrognLineRec3.VALIDATE("Prognosis Date", lPrognLineRec2."Prognosis Date");
              lPrognLineRec3.CalculatePrognosisFields;
              lPrognLineRec3.MODIFY;
            END ELSE BEGIN
              IF lPrognLineRec2.Element <> '' THEN BEGIN
                IF NOT lProjectElementRec.GET(lPrognLineRec2."Project No.", lPrognLineRec2.Element) THEN
                  ERROR(STRSUBSTNO(Text001, lPrognLineRec2."Project No.", lPrognLineRec2.Element));
              END;
              lPrognLineRec3."Project No." := lPrognLineRec2."Project No.";
              lPrognLineRec3."Cost Component Code" := SurchDimValRec."Cost Component";
              lPrognLineRec3.VALIDATE("Prognosis Date", lPrognLineRec2."Prognosis Date");
              lPrognLineRec3."Cost Type" := SurchDimValRec."Cost Type";
              lPrognLineRec3."Open Ovh. Surch. (Hours)" := lPrognLineRec2."Open Ovh. Surch. (Hours)";
              lPrognLineRec3.CalculatePrognosisFields;
              lPrognLineRec3.INSERT(TRUE);   //db, 21-12-12: apply insert-trigger
            END;
          END;
        UNTIL SurchargeRec.NEXT = 0;
      END;
    END;

    PROCEDURE CalcPurchSurchargesCC@1100285003(VAR lPrognLineRec@1100285000 : Record 11128270);
    VAR
      lvType@1100285005 : Code[20];
      lPrognLineRec2@1100285004 : Record 11128270;
      lPrognLineRec3@1100285003 : Record 11128270;
      DimValRec@1100285002 : Record 349;
      DimMgt@1100285001 : Codeunit 408;
    BEGIN
      //4PSSE, 4PS-001
      //>>ENH025
      //ProjRec.GET(lPrognLineRec."Project No.");
      IF NOT ProjRec.GET(lPrognLineRec."Project No.") THEN
        EXIT;
      //<<ENH025
      lvType := ProjRec."Project Type";

      lPrognLineRec3.RESET;
      lPrognLineRec3.SETRANGE("Project No.", lPrognLineRec."Project No.");
      lPrognLineRec3.SETRANGE("Prognosis Date", lPrognLineRec."Prognosis Date");
      lPrognLineRec3.SETFILTER("Cost Component Code",'<>%1',lPrognLineRec."Cost Component Code");
      lPrognLineRec3.SETFILTER("Open Ovh. Surch. (Inventory)", '<>0');
      IF NOT lPrognLineRec3.ISEMPTY THEN
        lPrognLineRec3.MODIFYALL("Open Ovh. Surch. (Inventory)", 0, FALSE);
      lPrognLineRec."Open Ovh. Surch. (Inventory)" := 0;

      lPrognLineRec3.RESET;
      lPrognLineRec3 := lPrognLineRec;

      DimMgt.GetDimValueRec(1, ProjRec."Global Dimension 1 Code", DimValRec, FALSE, ProjRec."No.");

      CalcPurchSurchargeCC(lPrognLineRec3, DimValRec, ProjRec, lvType);


      lPrognLineRec2.RESET;
      lPrognLineRec2.SETRANGE("Project No.",ProjRec."No.");
      lPrognLineRec2.SETRANGE("Prognosis Date",lPrognLineRec."Prognosis Date");
      lPrognLineRec2.SETFILTER("Cost Component Code",'<>%1',lPrognLineRec."Cost Component Code");
      lPrognLineRec2.SETFILTER("Open (Inventory)",'<>0');
      IF lPrognLineRec2.FINDSET THEN
      REPEAT
        CalcPurchSurchargeCC(lPrognLineRec2, DimValRec, ProjRec, lvType);
      UNTIL lPrognLineRec2.NEXT=0;
    END;

    LOCAL PROCEDURE CalcPurchSurchargeCC@1100285006(lPrognLineRec@1100285003 : Record 11128270;DimValRec@1100285002 : Record 349;ProjRec@1100285001 : Record 11072003;lvType@1100285000 : Code[20]);
    VAR
      ProjectTypeRec@1100285011 : Record 11012009;
      SurchargeRec@1100285010 : Record 11020208;
      SurchDimValRec@1100285009 : Record 349;
      lPrognLineRec2@1100285008 : Record 11128270;
      lPrognLineRec3@1100285007 : Record 11128270;
      lProjectElementRec@1100285006 : Record 11012010;
      lvOrigin@1100285005 : 'Project,Service';
      lvTotSurchAmount@1100285004 : Decimal;
    BEGIN
      //4PSSE, 4PS-001
      IF SurchargeRec.GetSurcharges(lvOrigin::Project, lvType, lPrognLineRec."Project No.",
                                    (DimValRec."Cost Type" <> DimValRec."Cost Type"::Revenue),
                                    DimValRec."Cost Type", DimValRec.Code, '',
                                    ProjRec."Global Dimension 1 Code", '',      //M21761
                                    lPrognLineRec."Cost Component Code", lPrognLineRec."Prognosis Date",
                                    SurchargeRec) THEN
      BEGIN
        REPEAT
          SurchargeRec.GetSurchargeDimVal(DimValRec, SurchDimValRec);

          lPrognLineRec2 := lPrognLineRec;
          lPrognLineRec2."Open Ovh. Surch. (Inventory)" := 0;

          InitPrognosisSurcharge(lPrognLineRec2,
                lPrognLineRec2."Open (Inventory)",
                lPrognLineRec2."Open Ovh. Surch. (Inventory)",
                DimValRec, SurchDimValRec, SurchargeRec, '', lvType, lvTotSurchAmount, '');

          //There is now a line filled with a cost and a surcharge.
          //The corresponding line should be looked up in the table and the
          //storage fee should be rehearsal.
          IF lPrognLineRec2."Open Ovh. Surch. (Inventory)" <> 0 THEN BEGIN
            lPrognLineRec3.INIT;
            lPrognLineRec3.RESET;
            IF lPrognLineRec3.GET(lPrognLineRec2."Project No.",
                                  lPrognLineRec2."Prognosis Date",
                                  SurchDimValRec."Cost Component") THEN
            BEGIN
              lPrognLineRec3."Open Ovh. Surch. (Inventory)" := lPrognLineRec3."Open Ovh. Surch. (Inventory)" + lPrognLineRec2."Open Ovh. Surch. (Inventory)";
              lPrognLineRec3.VALIDATE("Prognosis Date", lPrognLineRec2."Prognosis Date");
              lPrognLineRec3.CalculatePrognosisFields;
              lPrognLineRec3.MODIFY;
            END ELSE BEGIN
              IF lPrognLineRec2.Element <> '' THEN BEGIN
                IF NOT lProjectElementRec.GET(lPrognLineRec2."Project No.", lPrognLineRec2.Element) THEN
                  ERROR(STRSUBSTNO(Text001, lPrognLineRec2."Project No.", lPrognLineRec2.Element));
              END;
              lPrognLineRec3."Project No." := lPrognLineRec2."Project No.";
              lPrognLineRec3."Cost Component Code" := SurchDimValRec."Cost Component";
              lPrognLineRec3.VALIDATE("Prognosis Date", lPrognLineRec2."Prognosis Date");
              lPrognLineRec3."Cost Type" := SurchDimValRec."Cost Type";
              lPrognLineRec3."Open Ovh. Surch. (Inventory)" := lPrognLineRec2."Open Ovh. Surch. (Inventory)";
              lPrognLineRec3.CalculatePrognosisFields;
              lPrognLineRec3.INSERT(TRUE);
            END;
          END;
        UNTIL SurchargeRec.NEXT = 0;
      END;
    END;

    BEGIN
    END.
  }
}

