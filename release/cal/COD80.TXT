OBJECT Codeunit 80 Sales-Post
{
  OBJECT-PROPERTIES
  {
    Date=;
    Time=;
    Version List=NAVW114.05,4PS14.00,NAVSE.DK.NO.FI,4PSSE,PE6.03;
  }
  PROPERTIES
  {
    TableNo=36;
    Permissions=TableData 37=imd,
                TableData 38=m,
                TableData 39=m,
                TableData 49=imd,
                TableData 110=imd,
                TableData 111=imd,
                TableData 112=imd,
                TableData 113=imd,
                TableData 114=imd,
                TableData 115=imd,
                TableData 120=imd,
                TableData 121=imd,
                TableData 223=imd,
                TableData 252=imd,
                TableData 914=i,
                TableData 6507=ri,
                TableData 6508=rid,
                TableData 6660=imd,
                TableData 6661=imd,
                TableData 11020500=r,
                TableData 11072005=rm,
                TableData 2000000068=rimd;
    OnRun=VAR
            SalesHeader@1005 : Record 36;
            TempInvoicePostBuffer@1000 : TEMPORARY Record 49;
            TempItemLedgEntryNotInvoiced@1006 : TEMPORARY Record 32;
            CustLedgEntry@1013 : Record 21;
            TempServiceItem2@1040 : TEMPORARY Record 5940;
            TempServiceItemComp2@1038 : TEMPORARY Record 5941;
            TempVATAmountLine@1043 : TEMPORARY Record 290;
            TempVATAmountLineRemainder@1042 : TEMPORARY Record 290;
            TempDropShptPostBuffer@1009 : TEMPORARY Record 223;
            UpdateAnalysisView@1002 : Codeunit 410;
            UpdateItemAnalysisView@1014 : Codeunit 7150;
            HasATOShippedNotInvoiced@1012 : Boolean;
            EverythingInvoiced@1034 : Boolean;
            SavedPreviewMode@1003 : Boolean;
            SavedSuppressCommit@1004 : Boolean;
            BiggestLineNo@1020 : Integer;
            ICGenJnlLineNo@1032 : Integer;
            LineCount@1035 : Integer;
            PostingMgt@1100525000 : Codeunit 11012360;
            ReferenceNo@1090000 : Code[20];
            TotalROT@1100285500 : Decimal;
            TotalRUT@1101285000 : Decimal;
          BEGIN
            OnBeforePostSalesDoc(Rec,SuppressCommit,PreviewMode,HideProgressWindow);

            ValidatePostingAndDocumentDate(Rec);

            SavedPreviewMode := PreviewMode;
            SavedSuppressCommit := SuppressCommit;
            ClearAllVariables;
            SuppressCommit := SavedSuppressCommit;
            PreviewMode := SavedPreviewMode;

            GetGLSetup;
            GetCurrency("Currency Code");

            SalesSetup.GET;
            //**4PS.sn
            JobSetUp.GET;

            IF Invoice AND
              ((("Document Type" = "Document Type"::Order) AND
                (SalesSetup."Invoice Sales Orders" = SalesSetup."Invoice Sales Orders"::NotPosted)) OR
               (("Document Type" = "Document Type"::"Return Order") AND
                (SalesSetup."Invoice Return Orders" = SalesSetup."Invoice Return Orders"::NotPosted)))
            THEN BEGIN
              Invoice := FALSE;
              InvoiceOrderNotPostedInvoice := TRUE;
              TempSalesOrderLineForInv.RESET;
              TempSalesOrderLineForInv.DELETEALL;
            END;
            //**4PS.en

            SalesHeader := Rec;
            FillTempLines(SalesHeader,TempSalesLineGlobal);
            TempServiceItem2.DELETEALL;
            TempServiceItemComp2.DELETEALL;

            // Check that the invoice amount is zero or greater
            IF SalesHeader.Invoice THEN
              IF "Document Type" IN ["Document Type"::Invoice,"Document Type"::Order] THEN BEGIN
                TempSalesLineGlobal.CalcVATAmountLines(1,SalesHeader,TempSalesLineGlobal,TempVATAmountLine);
                IF TempVATAmountLine.GetTotalLineAmount(FALSE,'') < 0 THEN
                  ERROR(TotalInvoiceAmountNegativeErr);
              END;

            // Header
            //CheckAndUpdate(SalesHeader);
            CheckAndUpdate(SalesHeader,ReferenceNo,TotalROT,TotalRUT);  //NAVFI, INC#270175

            //**4PS.sn
            IF "Document Type" = "Document Type"::"Invoice Proposal" THEN BEGIN
              PostInvoiceProposal(SalesHeader);
              Rec := SalesHeader;
              EXIT;
            END;

            IF ("Document Type" = "Document Type"::Order) AND
                (("Sales Document Type" = "Sales Document Type"::"Sales Logistics Separated") OR
                ("Sales Document Type" = "Sales Document Type"::RentalContract))
            THEN BEGIN
              Rec := SalesHeader;
              EXIT;
            END;
            //**4PS.en

            TempDeferralHeader.DELETEALL;
            TempDeferralLine.DELETEALL;
            TempInvoicePostBuffer.DELETEALL;
            TempDropShptPostBuffer.DELETEALL;
            //**4PS.sn
            TempSurchargePostingBuffer[1].DELETEALL;
            TempRequisitionPostingBuffer[1].DELETEALL;
            TempComplWIPPostingBuffer[1].DELETEALL;
            TempRetentionPostingBuffer[1].DELETEALL;
            TempGenJnlRateCompBuffer.RESET;
            TempGenJnlRateCompBuffer.DELETEALL;
            PlantTransportInternalCust := FALSE;
            //**4PS.en
            EverythingInvoiced := TRUE;

            // Lines
            OnBeforePostLines(TempSalesLineGlobal,SalesHeader,SuppressCommit,PreviewMode);

            LineCount := 0;
            RoundingLineInserted := FALSE;
            AdjustFinalInvWith100PctPrepmt(TempSalesLineGlobal);

            TempVATAmountLineRemainder.DELETEALL;
            TempSalesLineGlobal.CalcVATAmountLines(1,SalesHeader,TempSalesLineGlobal,TempVATAmountLine);

            SalesLinesProcessed := FALSE;
            IF TempSalesLineGlobal.FINDSET THEN
              REPEAT
                ItemJnlRollRndg := FALSE;
                LineCount := LineCount + 1;
                IF NOT HideProgressWindow THEN
                  Window.UPDATE(2,LineCount);

                PostSalesLine(
                  SalesHeader,TempSalesLineGlobal,EverythingInvoiced,TempInvoicePostBuffer,TempVATAmountLine,TempVATAmountLineRemainder,
                  TempItemLedgEntryNotInvoiced,HasATOShippedNotInvoiced,TempDropShptPostBuffer,ICGenJnlLineNo,
                  TempServiceItem2,TempServiceItemComp2);

                IF RoundingLineInserted THEN
                  LastLineRetrieved := TRUE
                ELSE BEGIN
                  BiggestLineNo := MAX(BiggestLineNo,TempSalesLineGlobal."Line No.");
                  LastLineRetrieved := TempSalesLineGlobal.NEXT = 0;
                  IF LastLineRetrieved AND SalesSetup."Invoice Rounding" THEN
                    InvoiceRounding(SalesHeader,TempSalesLineGlobal,FALSE,BiggestLineNo);
                END;
              UNTIL LastLineRetrieved;

            OnAfterPostSalesLines(
              SalesHeader,SalesShptHeader,SalesInvHeader,SalesCrMemoHeader,ReturnRcptHeader,WhseShip,WhseReceive,SalesLinesProcessed,
              SuppressCommit,EverythingInvoiced);

            IF NOT SalesHeader.IsCreditDocType THEN BEGIN
              ReverseAmount(TotalSalesLine);
              ReverseAmount(TotalSalesLineLCY);
              TotalSalesLineLCY."Unit Cost (LCY)" := -TotalSalesLineLCY."Unit Cost (LCY)";
            END;

            PostDropOrderShipment(SalesHeader,TempDropShptPostBuffer);
            IF SalesHeader.Invoice THEN
              //PostGLAndCustomer(SalesHeader,TempInvoicePostBuffer,CustLedgEntry);
              PostGLAndCustomer(SalesHeader,TempInvoicePostBuffer,CustLedgEntry,ReferenceNo,TotalROT,TotalRUT);  //NAVFI RFC188 INC#270175

            //**4PS.sn
            PostingMgt.PostSurchargesFromSalesLine(FALSE,SrcCode,GenJnlLineDocType,GenJnlLineDocNo,SalesHeader,GenJnlPostLine,TempSurchargePostingBuffer);
            PostPlantRateComponentBuffer(SalesHeader);
            PostRequisitionPostingBuffer(SalesHeader);
            PostingMgt.PostSurchargesFromSalesLine(TRUE,SrcCode,GenJnlLineDocType,GenJnlLineDocNo,SalesHeader,GenJnlPostLine,TempComplWIPPostingBuffer);
            //**4PS.en

            IF ICGenJnlLineNo > 0 THEN
              PostICGenJnl;

            MakeInventoryAdjustment;
            UpdateLastPostingNos(SalesHeader);

            OnRunOnBeforeFinalizePosting(
              SalesHeader,SalesShptHeader,SalesInvHeader,SalesCrMemoHeader,ReturnRcptHeader,GenJnlPostLine,SuppressCommit);

            FinalizePosting(SalesHeader,EverythingInvoiced,TempDropShptPostBuffer);

            Rec := SalesHeader;
            SynchBOMSerialNo(TempServiceItem2,TempServiceItemComp2);
            IF NOT (InvtPickPutaway OR SuppressCommit) THEN BEGIN
              COMMIT;
              UpdateAnalysisView.UpdateAll(0,TRUE);
              UpdateItemAnalysisView.UpdateAll(0,TRUE);
            END;

            OnAfterPostSalesDoc(
              Rec,GenJnlPostLine,SalesShptHeader."No.",ReturnRcptHeader."No.",
              SalesInvHeader."No.",SalesCrMemoHeader."No.",SuppressCommit,InvtPickPutaway);
            OnAfterPostSalesDocDropShipment(PurchRcptHeader."No.",SuppressCommit);
          END;

  }
  CODE
  {
    VAR
      NothingToPostErr@1000 : TextConst 'ENU=There is nothing to post.;NOR=Det finnes ingenting Ü bokfõre.;SVE=Det finns inget att bokfîra.';
      PostingLinesMsg@1001 : TextConst '@@@=Counter;ENU=Posting lines              #2######\;NOR=Bokfõrer linjer            #2######\;SVE=Bokfîring rader            #2######\';
      PostingSalesAndVATMsg@1002 : TextConst '@@@=Counter;ENU=Posting sales and VAT      #3######\;NOR=Bokfõrer salg og mva.      #3######\;SVE=Bokf. fîrs. och moms       #3######\';
      PostingCustomersMsg@1003 : TextConst '@@@=Counter;ENU=Posting to customers       #4######\;NOR=Bokfõrer til kunder        #4######\;SVE=Bokfîring till kunder      #4######\';
      PostingBalAccountMsg@1004 : TextConst '@@@=Counter;ENU=Posting to bal. account    #5######;NOR=Bokfõrer til motkonto      #5######;SVE=Bokfîring till motkonto    #5######';
      PostingLines2Msg@1005 : TextConst '@@@=Counter;ENU=Posting lines              #2######;NOR=Bokfõrer linjer            #2######;SVE=Bokfîring rader            #2######';
      InvoiceNoMsg@1006 : TextConst '@@@="%1 = Document Type, %2 = Document No, %3 = Invoice No.";ENU=%1 %2 -> Invoice %3;NOR=%1 %2 -> Faktura %3;SVE=%1 %2 -> Faktura %3';
      CreditMemoNoMsg@1007 : TextConst '@@@="%1 = Document Type, %2 = Document No, %3 = Credit Memo No.";ENU=%1 %2 -> Credit Memo %3;NOR=%1 %2 -> Kreditnota %3;SVE=%1 %2 -> Kreditnota %3';
      DropShipmentErr@1008 : TextConst '@@@="%1 = Line No.";ENU=You cannot ship sales order line %1. The line is marked as a drop shipment and is not yet associated with a purchase order.;NOR=Du kan ikke levere ordrelinje %1. Linjen er merket som en direkte levering og er ennÜ ikke knyttet mot en bestilling.;SVE=Du kan inte leverera fîrsÑljningsorderrad %1. Raden Ñr markerad som en direktutleverans och Ñr Ñnnu inte kopplad till en inkîpsorder.';
      ShipmentSameSignErr@1010 : TextConst 'ENU=must have the same sign as the shipment;NOR=mÜ ha samme fortegn som fõlgeseddelen;SVE=mÜste ha samma tecken som utleveransen';
      ShipmentLinesDeletedErr@1011 : TextConst 'ENU=The shipment lines have been deleted.;NOR=Fõlgeseddellinjene er slettet.;SVE=Utleveransraderna har tagits bort.';
      InvoiceMoreThanShippedErr@1012 : TextConst '@@@="%1 = Order No.";ENU=You cannot invoice more than you have shipped for order %1.;NOR=Du kan ikke fakturere mer enn du har levert for ordre %1.;SVE=Du kan inte fakturera fîr mer Ñn vad du har levererat i order %1.';
      VATAmountTxt@1013 : TextConst 'ENU=VAT Amount;NOR=Mva-belõp;SVE=Momsbelopp';
      VATRateTxt@1014 : TextConst '@@@="%1 = VAT Rate";ENU=%1% VAT;NOR=%1% Mva.;SVE=%1% moms';
      BlanketOrderQuantityGreaterThanErr@1015 : TextConst '@@@="%1 = Quantity";ENU=in the associated blanket order must not be greater than %1;NOR=i tilhõrende rammeordre kan ikke vëre stõrre enn %1;SVE=i den kopplade avropsordern, fÜr inte vara stîrre Ñn %1';
      BlanketOrderQuantityReducedErr@1016 : TextConst 'ENU=in the associated blanket order must not be reduced;NOR=i tilhõrende rammeordre skal ikke reduseres;SVE=i den kopplade avropsordern fÜr inte reduceras';
      ShipInvoiceReceiveErr@1017 : TextConst 'ENU=Please enter "Yes" in Ship and/or Invoice and/or Receive.;NOR=Skriv Ja i Levere og/eller Faktura og/eller Motta.;SVE=Ange "Ja" i Leverera och/eller Faktura och/eller Inleverera.';
      WarehouseRequiredErr@1018 : TextConst '@@@="%1/%2 = Document Type, %3/%4 - Document No.,%5/%6 = Line No.";ENU="Warehouse handling is required for %1 = %2, %3 = %4, %5 = %6.";NOR="Det kreves lagerhÜndtering for %1 = %2, %3 = %4, %5 = %6.";SVE="Dist.lager hantering krÑvs fîr %1 = %2, %3 = %4, %5 = %6."';
      ReturnReceiptSameSignErr@1021 : TextConst 'ENU=must have the same sign as the return receipt;NOR=mÜ ha samme fortegn som returseddelen;SVE=mÜste ha samma tecken som returinleveransen';
      ReturnReceiptInvoicedErr@1022 : TextConst '@@@="%1 = Line No., %2 = Document No.";ENU=Line %1 of the return receipt %2, which you are attempting to invoice, has already been invoiced.;NOR=Linje %1 i returseddel %2, som du forsõker Ü fakturere, er allerede fakturert.;SVE=Rad %1 pÜ returinleverans %2 som du fîrsîker att fakturera har redan fakturerats.';
      ShipmentInvoiceErr@1023 : TextConst '@@@="%1 = Line No., %2 = Document No.";ENU=Line %1 of the shipment %2, which you are attempting to invoice, has already been invoiced.;NOR=Linje %1 i fõlgeseddel %2, som du prõver Ü fakturere, er allerede fakturert.;SVE=Rad %1 av utleveransen %2 som du fîrsîker att fakturera har redan fakturerats.';
      QuantityToInvoiceGreaterErr@1024 : TextConst '@@@="%1 = Document No.";ENU=The quantity you are attempting to invoice is greater than the quantity in shipment %1.;NOR=Antallet du prõver Ü fakturere er stõrre enn antallet i fõlgeseddel %1.;SVE=Antalet som du fîrsîker att fakturera Ñr stîrre Ñn antalet i utleveransen %1.';
      CannotAssignMoreErr@1029 : TextConst '@@@="%1 = Quantity, %2/%3 = Document Type, %4/%5 - Document No.,%6/%7 = Line No.";ENU="You cannot assign more than %1 units in %2 = %3, %4 = %5,%6 = %7.";NOR="Du kan ikke tilordne mer enn %1 enheter i %2 = %3, %4 = %5,%6 = %7.";SVE="Du kan inte tilldela mer Ñn %1 enheter i %2 = %3, %4 = %5,%6 = %7."';
      MustAssignErr@1030 : TextConst 'ENU=You must assign all item charges, if you invoice everything.;NOR=Du mÜ tilordne alle varegebyr hvis du fakturerer alt.;SVE=Du mÜste fîrdela alla artikelomkostnader om du fakturerar allt.';
      Item@1164 : Record 27;
      SalesSetup@1032 : Record 311;
      GLSetup@1033 : Record 98;
      GLEntry@1034 : Record 17;
      TempSalesLineGlobal@1051 : TEMPORARY Record 37;
      xSalesLine@1038 : Record 37;
      SalesLineACY@1039 : Record 37;
      TotalSalesLine@1040 : Record 37;
      TotalSalesLineLCY@1041 : Record 37;
      SalesShptHeader@1043 : Record 110;
      SalesInvHeader@1045 : Record 112;
      SalesCrMemoHeader@1047 : Record 114;
      ReturnRcptHeader@1049 : Record 6660;
      PurchRcptHeader@1053 : Record 120;
      ItemChargeAssgntSales@1042 : Record 5809;
      TempItemChargeAssgntSales@1037 : TEMPORARY Record 5809;
      SourceCodeSetup@1061 : Record 242;
      Currency@1068 : Record 4;
      WhseRcptHeader@1019 : Record 7316;
      TempWhseRcptHeader@1145 : TEMPORARY Record 7316;
      WhseShptHeader@1148 : Record 7320;
      TempWhseShptHeader@1149 : TEMPORARY Record 7320;
      PostedWhseRcptHeader@1142 : Record 7318;
      PostedWhseRcptLine@1146 : Record 7319;
      PostedWhseShptHeader@1150 : Record 7322;
      PostedWhseShptLine@1151 : Record 7323;
      Location@1080 : Record 14;
      TempHandlingSpecification@1088 : TEMPORARY Record 336;
      TempATOTrackingSpecification@1063 : TEMPORARY Record 336;
      TempTrackingSpecification@1139 : TEMPORARY Record 336;
      TempTrackingSpecificationInv@1160 : TEMPORARY Record 336;
      TempWhseSplitSpecification@1190 : TEMPORARY Record 336;
      TempValueEntryRelation@1140 : TEMPORARY Record 6508;
      JobTaskSalesLine@1167 : Record 37;
      TempICGenJnlLine@2165 : TEMPORARY Record 81;
      TempPrepmtDeductLCYSalesLine@1134 : TEMPORARY Record 37;
      TempSKU@1175 : TEMPORARY Record 5700;
      DeferralPostBuffer@1046 : Record 1706;
      TempDeferralHeader@1009 : TEMPORARY Record 1701;
      TempDeferralLine@1035 : TEMPORARY Record 1702;
      ErrorMessageMgt@1070 : Codeunit 28;
      GenJnlPostLine@1082 : Codeunit 12;
      ResJnlPostLine@1083 : Codeunit 212;
      ItemJnlPostLine@1085 : Codeunit 22;
      ReserveSalesLine@1086 : Codeunit 99000832;
      IdentityManagement@1044 : Codeunit 9801;
      ApprovalsMgmt@1165 : Codeunit 1535;
      ItemTrackingMgt@1196 : Codeunit 6500;
      WhseJnlPostLine@1141 : Codeunit 7301;
      WhsePostRcpt@1152 : Codeunit 5760;
      WhsePostShpt@1153 : Codeunit 5763;
      PurchPost@1159 : Codeunit 90;
      CostCalcMgt@1163 : Codeunit 5836;
      JobPostLine@1166 : Codeunit 11072006;
      AsmPost@1067 : Codeunit 900;
      DeferralUtilities@1048 : Codeunit 1720;
      UOMMgt@1025 : Codeunit 5402;
      Window@1097 : Dialog;
      UseDate@1099 : Date;
      GenJnlLineDocNo@1101 : Code[20];
      GenJnlLineExtDocNo@1102 : Code[35];
      SrcCode@1103 : Code[10];
      GenJnlLineDocType@1104 : Integer;
      ItemLedgShptEntryNo@1106 : Integer;
      FALineNo@1108 : Integer;
      RoundingLineNo@1109 : Integer;
      DeferralLineNo@1050 : Integer;
      InvDefLineNo@1058 : Integer;
      RemQtyToBeInvoiced@1111 : Decimal;
      RemQtyToBeInvoicedBase@1112 : Decimal;
      RemAmt@1136 : Decimal;
      RemDiscAmt@1137 : Decimal;
      TotalChargeAmt@1062 : Decimal;
      TotalChargeAmtLCY@1057 : Decimal;
      LastLineRetrieved@1116 : Boolean;
      RoundingLineInserted@1117 : Boolean;
      DropShipOrder@1119 : Boolean;
      CannotAssignInvoicedErr@1127 : TextConst '@@@="%1 = Sales Line, %2/%3 = Document Type, %4/%5 - Document No.,%6/%7 = Line No.";ENU="You cannot assign item charges to the %1 %2 = %3,%4 = %5, %6 = %7, because it has been invoiced.";NOR="Du kan ikke tilordne varegebyr til %1 %2 = %3,%4 = %5, %6 = %7, fordi faktureringen er ferdig.";SVE="Du kan inte fîrdela artikelomkostnader till %1 %2 = %3,%4 = %5, %6 = %7, dÑrfîr att den har fakturerats."';
      InvoiceMoreThanReceivedErr@1094 : TextConst '@@@="%1 = Order No.";ENU=You cannot invoice more than you have received for return order %1.;NOR=Du kan ikke fakturere mer enn du har mottatt for ordreretur %1.;SVE=Du kan inte fakturera fîr mer Ñn vad du har erhÜllit i returorder %1.';
      ReturnReceiptLinesDeletedErr@1095 : TextConst 'ENU=The return receipt lines have been deleted.;NOR=Returseddellinjene er slettet.;SVE=Returinleveransraderna har tagits bort.';
      InvoiceGreaterThanReturnReceiptErr@1130 : TextConst '@@@="%1 = Receipt No.";ENU=The quantity you are attempting to invoice is greater than the quantity in return receipt %1.;NOR=Antallet du forsõker Ü fakturere, er stõrre enn antallet i returseddel %1.;SVE=Antalet som du fîrsîker att fakturera Ñr stîrre Ñn antalet i returinleveransen %1.';
      ItemJnlRollRndg@1135 : Boolean;
      RelatedItemLedgEntriesNotFoundErr@1129 : TextConst 'ENU=Related item ledger entries cannot be found.;NOR=Finner ikke relaterte vareposter.;SVE=Knutna artikeltransaktioner kan inte hittas.';
      ItemTrackingWrongSignErr@1147 : TextConst 'ENU=Item Tracking is signed wrongly.;NOR=Varesporing er feil signert.;SVE=ArtikelspÜrning Ñr felaktigt signerat.';
      ItemTrackingMismatchErr@1143 : TextConst 'ENU=Item Tracking does not match.;NOR=Varesporingen har ingen treff.;SVE=ArtikelspÜrning matchar inte.';
      WhseShip@1110 : Boolean;
      WhseReceive@1154 : Boolean;
      InvtPickPutaway@1155 : Boolean;
      PostingDateNotAllowedErr@1157 : TextConst '@@@=%1 - Posting Date field caption;ENU=%1 is not within your range of allowed posting dates.;NOR=%1 er ikke innenfor omrÜdet for tillatte bokfõringsdatoer.;SVE=Ñr inte i ditt tillÜtna intervall fîr bokfîringsdatum';
      ItemTrackQuantityMismatchErr@1066 : TextConst '@@@="%1 = Quantity";ENU=The %1 does not match the quantity defined in item tracking for item %2.;NOR=%1 samsvarer ikke med antallet som er definert i varesporing.;SVE=%1 stÑmmer inte med det antal som har angetts vid artikelspÜrning.';
      CannotBeGreaterThanErr@1084 : TextConst '@@@="%1 = Amount";ENU=cannot be more than %1.;NOR=kan ikke vëre mer enn %1.;SVE=fÜr inte vara stîrre Ñn %1';
      CannotBeSmallerThanErr@1105 : TextConst '@@@="%1 = Amount";ENU=must be at least %1.;NOR=mÜ vëre minst %1.;SVE=mÜste vara minst %1.';
      JobContractLine@1172 : Boolean;
      GLSetupRead@1133 : Boolean;
      ItemTrkgAlreadyOverruled@1059 : Boolean;
      PrepAmountToDeductToBigErr@1076 : TextConst '@@@="%1 = Prepmt Amt to Deduct, %2 = Max Amount";ENU=The total %1 cannot be more than %2.;NOR=Totalen %1 kan ikke vëre mer enn %2.;SVE=Summan %1 kan inte vara mer Ñn %2.';
      PrepAmountToDeductToSmallErr@1091 : TextConst '@@@="%1 = Prepmt Amt to Deduct, %2 = Max Amount";ENU=The total %1 must be at least %2.;NOR=Totalen %1 mÜ vëre minst %2.;SVE=Summan %1 mÜste vara minst %2.';
      MustAssignItemChargeErr@1102601000 : TextConst '@@@="%1 = Item Charge No.";ENU=You must assign item charge %1 if you want to invoice it.;NOR=Du mÜ tilordne varegebyret %1 hvis du vil fakturere det.;SVE=Du mÜste tilldela artikelomkostnaden %1 om du vill fakturera den.';
      CannotInvoiceItemChargeErr@1102601001 : TextConst '@@@="%1 = Item Charge No.";ENU=You can not invoice item charge %1 because there is no item ledger entry to assign it to.;NOR=Du kan ikke fakturere varegebyret %1 fordi det ikke finnes noen tilordnet varepost.;SVE=Du kan inte fakturera artikelomkostnaden %1 eftersom det inte finns nÜgon artikeltransaktion att tilldela den till.';
      SalesLinesProcessed@1072 : Boolean;
      AssemblyCheckProgressMsg@1073 : TextConst '@@@="%1 = Text, %2 = Progress bar";ENU=#1#################################\\Checking Assembly #2###########;NOR=#1#################################\\Kontrollerer montering #2###########;SVE=#1#################################\\Kontrollerar montering #2###########';
      AssemblyPostProgressMsg@1090 : TextConst '@@@="%1 = Text, %2 = Progress bar";ENU=#1#################################\\Posting Assembly #2###########;NOR=#1#################################\\Bokfõrer montering #2###########;SVE=#1#################################\\Bokfîr montering #2###########';
      AssemblyFinalizeProgressMsg@1168 : TextConst '@@@="%1 = Text, %2 = Progress bar";ENU=#1#################################\\Finalizing Assembly #2###########;NOR=#1#################################\\Fullfõrer montering #2###########;SVE=#1#################################\\Slutfîr montering #2###########';
      ReassignItemChargeErr@1171 : TextConst 'ENU=The order line that the item charge was originally assigned to has been fully posted. You must reassign the item charge to the posted receipt or shipment.;NOR=Ordrelinjen som varegebyret opprinnelig ble tilordnet til, er fullstendig bokfõrt. Du mÜ tilordne varegebyret pÜ nytt til det bokfõrte mottaket eller den bokfõrte fõlgeseddelen.;SVE=Orderraden som artikelomkostnaden ursprungligen tilldelades har bokfîrts. Du mÜste omtilldela artikelomkostnaden till den bokfîrda in- eller utleveransen.';
      ReservationDisruptedQst@1132 : TextConst '@@@="One or more reservation entries exist for the item with No. = 1000, Location Code = SILVER, Variant Code = NEW which may be disrupted if you post this negative adjustment. Do you want to continue?";ENU="One or more reservation entries exist for the item with %1 = %2, %3 = %4, %5 = %6 which may be disrupted if you post this negative adjustment. Do you want to continue?";NOR="ên eller flere reservasjonsposter finnes for varen med %1 = %2, %3 = %4, %5 = %6, som kan avbrutt hvis du bokfõrer denne nedjusteringen. Vil du fortsette?";SVE="Det finns en eller flera reservationstransaktioner fîr artikeln med %1 = %2, %3 = %4, %5 = %6 som kan avbrytas om du bokfîr den hÑr negativa justeringen. Vill du fortsÑtta?"';
      NotSupportedDocumentTypeErr@1020 : TextConst '@@@="%1 = Document Type";ENU=Document type %1 is not supported.;NOR=Dokumenttypen %1 stõttes ikke.;SVE=Dokumenttyp %1 stîds inte.';
      PreviewMode@1031 : Boolean;
      TotalInvoiceAmountNegativeErr@1056 : TextConst 'ENU=The total amount for the invoice must be 0 or greater.;NOR=Det totale belõpet for fakturaen mÜ vëre 0 eller hõyere.';
      NoDeferralScheduleErr@1064 : TextConst '@@@="%1=The item number of the sales transaction line, %2=The Deferral Template Code";ENU=You must create a deferral schedule because you have specified the deferral code %2 in line %1.;NOR=Du mÜ opprette en tidsplan for periodisering fordi du har angitt periodiseringskoden %2 i linje %1.;SVE=Du mÜste skapa ett periodiseringsschema eftersom du har angett periodiseringskod %2 pÜ rad %1.';
      ZeroDeferralAmtErr@1060 : TextConst '@@@="%1=The item number of the sales transaction line, %2=The Deferral Template Code";ENU=Deferral amounts cannot be 0. Line: %1, Deferral Template: %2.;NOR=Periodiseringsbelõp kan ikke vëre 0. Linje: %1, periodiseringsmal: %2.;SVE=Periodiseringsbelopp fÜr inte vara 0. Rad: %1, Periodiseringsmall: %2.';
      DownloadShipmentAlsoQst@1036 : TextConst 'ENU=You can also download the Sales - Shipment document now. Alternatively, you can access it from the Posted Sales Shipments window later.\\Do you want to download the Sales - Shipment document now?;NOR=Du kan ogsÜ laste ned dokumentet Salg - fõlgeseddel nÜ. Eventuelt kan du Üpne det fra vinduet Bokfõrte fõlgesedler senere.\\Vil du laste ned dokumentet Salg - fõlgeseddel nÜ?;SVE=Du kan ocksÜ ladda ned dokumentet Fîrs. - utleverans nu. Om du vill kan du ocksÜ îppna det senare i fînstret Bokfîrda fîrsÑljningsutleveranser.\\Vill du ladda ned dokumentet Fîrs. - utleverans nu?';
      SuppressCommit@1052 : Boolean;
      PostingPreviewNoTok@1257 : TextConst '@@@={Locked};ENU=***;NOR=***';
      InvPickExistsErr@1069 : TextConst 'ENU=One or more related inventory picks must be registered before you can post the shipment.;NOR=ên eller flere relaterte lagerplukkinger mÜ registreres fõr du kan bokfõre leveringen.';
      InvPutAwayExistsErr@1065 : TextConst 'ENU=One or more related inventory put-aways must be registered before you can post the receipt.;NOR=ên eller flere relaterte lagerplasseringer mÜ registreres fõr du kan bokfõre kvitteringen.';
      CheckSalesHeaderMsg@1071 : TextConst 'ENU=Check sales document fields.;NOR=Kontroller felter i salgsdokument.';
      HideProgressWindow@1026 : Boolean;
      JobSetUp@1100525005 : Record 315;
      PlantSetup@1100525007 : Record 11012550;
      Project@1100525009 : Record 11072003;
      ServiceOrder@1100525010 : Record 11012823;
      TempGenJnlRateCompBuffer@1100525000 : TEMPORARY Record 81;
      TempJobJnlLine@1100525004 : TEMPORARY Record 11072008;
      TempSurchargePostingBuffer@1100525021 : ARRAY [2] OF TEMPORARY Record 49;
      TempComplWIPPostingBuffer@1100525023 : ARRAY [2] OF TEMPORARY Record 49;
      TempRequisitionPostingBuffer@1100525027 : ARRAY [2] OF TEMPORARY Record 49;
      TempSalesOrderLineForInv@1100525028 : TEMPORARY Record 37;
      TempRetentionPostingBuffer@1100525031 : ARRAY [2] OF TEMPORARY Record 49;
      SalesHeadInvFromOrder@1100525029 : Record 36;
      JobJnlPostLine@1100525002 : Codeunit 11072003;
      ServJnlPostLine@1100525022 : Codeunit 11012802;
      PlantJnlPostLine@1100525011 : Codeunit 11012569;
      PlantRateComponentPostLine@1100525025 : Codeunit 11020500;
      NSItemTrackingEntriesApply@1100525030 : Codeunit 11012352;
      LoanJnlPostLine@1100528501 : Codeunit 11012627;
      RentalUnitProjectNo@1100525008 : Code[20];
      AccountNoServEntry@1100525014 : Code[20];
      NoSeriesCde@1100525026 : Code[20];
      JobLedgEntryNo@1100525012 : Integer;
      ServLedgEntryNo@1100525013 : Integer;
      NextLineNoGLRateCompBuf@1100525024 : Integer;
      SetRentalUnitInvoice@1100525006 : Boolean;
      InvoiceOrderNotPostedInvoice@1100525003 : Boolean;
      PlantTransportInternalCust@1100525001 : Boolean;
      ReplaceDocLink@1100525015 : Boolean;
      Text11012001@1100525020 : TextConst 'ENU=Plant %1 %2;NOR=Maskin %1 %2;SVE=Maskin %1 %2';
      Text11012002@1100525019 : TextConst 'ENU=not (completely) found in table ''%1'' (%2 of %3);NOR=ikke (komplett) funnet i tabellen ''%1'' (%2 av %3);SVE=inte (helt) hittat i tabellen ''%1'' (%2 av %3)';
      Text11012003@1100525018 : TextConst 'ENU=Create invoice not possible, of order line %1-%2 still %3 present on not posted %4 %5-%6.;NOR=Kan ikke opprette faktura: Av ordrerad %1-%2 er fortsatt %3 tilstede pÜ ikke bokfõrte %4 %5-%6.;SVE=Det gÜr inte att skapa faktura: orderrad %1-%2 Ñr fortfarande %3 procent, eller sÜ har inte %4 %5-%6 bokfîrts.';
      Text11012004@1100525017 : TextConst 'ENU=BOM Item %1 has to be exploded;NOR=Stykklisteartikkel %1 mÜ utfoldes;SVE=Strukturartikel %1 mÜste expanderas';
      Text11012018@1100525016 : TextConst 'ENU=may only be selected when %1 is %2;NOR=kan kun velges nÜr %1 er %2;SVE=fÜr endast vÑljas nÑr %1 Ñr %2';
      GLAcc@1100285500 : Record 15;
      CreateReference@1090069 : Codeunit 11126182;
      ReferenceNumber@1090070 : Code[20];
      EInvoiceCheckSalesDocument@1080000 : Codeunit 11128503;
      OIOXMLCheckSalesHeader@1060000 : Codeunit 11128572;
      GenJnlLineExt@100000000 : Record 11128091;

    [External]
    PROCEDURE CopyToTempLines@180(SalesHeader@1000 : Record 36;VAR TempSalesLine@1002 : TEMPORARY Record 37);
    VAR
      SalesLine@1001 : Record 37;
    BEGIN
      SalesLine.SETRANGE("Document Type",SalesHeader."Document Type");
      SalesLine.SETRANGE("Document No.",SalesHeader."No.");
      OnCopyToTempLinesOnAfterSetFilters(SalesLine,SalesHeader);
      IF SalesLine.FINDSET THEN
        REPEAT
          TempSalesLine := SalesLine;
          TempSalesLine.INSERT;
        UNTIL SalesLine.NEXT = 0;
    END;

    [External]
    PROCEDURE FillTempLines@36(SalesHeader@1000 : Record 36;VAR TempSalesLine@1001 : TEMPORARY Record 37);
    BEGIN
      TempSalesLine.RESET;
      IF TempSalesLine.ISEMPTY THEN
        CopyToTempLines(SalesHeader,TempSalesLine);
    END;

    LOCAL PROCEDURE ModifyTempLine@184(VAR TempSalesLineLocal@1000 : TEMPORARY Record 37);
    VAR
      SalesLine@1001 : Record 37;
    BEGIN
      TempSalesLineLocal.MODIFY;
      SalesLine := TempSalesLineLocal;
      SalesLine.MODIFY;
    END;

    [External]
    PROCEDURE RefreshTempLines@28(SalesHeader@1000 : Record 36;VAR TempSalesLine@1001 : TEMPORARY Record 37);
    BEGIN
      TempSalesLine.RESET;
      TempSalesLine.SETRANGE("Prepayment Line",FALSE);
      TempSalesLine.DELETEALL;
      TempSalesLine.RESET;
      CopyToTempLines(SalesHeader,TempSalesLine);
    END;

    LOCAL PROCEDURE ResetTempLines@131(VAR TempSalesLineLocal@1000 : TEMPORARY Record 37);
    BEGIN
      TempSalesLineLocal.RESET;
      TempSalesLineLocal.COPY(TempSalesLineGlobal,TRUE);
      OnAfterResetTempLines(TempSalesLineLocal);
    END;

    LOCAL PROCEDURE CalcInvoice@145(SalesHeader@1000 : Record 36) NewInvoice : Boolean;
    VAR
      TempSalesLine@1001 : TEMPORARY Record 37;
    BEGIN
      WITH SalesHeader DO BEGIN
        ResetTempLines(TempSalesLine);
        TempSalesLine.SETFILTER(Quantity,'<>0');
        IF "Document Type" IN ["Document Type"::Order,"Document Type"::"Return Order"] THEN
          TempSalesLine.SETFILTER("Qty. to Invoice",'<>0');
        NewInvoice := NOT TempSalesLine.ISEMPTY;
        IF NewInvoice THEN
          CASE "Document Type" OF
            "Document Type"::Order:
              IF NOT Ship THEN BEGIN
                TempSalesLine.SETFILTER("Qty. Shipped Not Invoiced",'<>0');
                NewInvoice := NOT TempSalesLine.ISEMPTY;
              END;
            "Document Type"::"Return Order":
              IF NOT Receive THEN BEGIN
                TempSalesLine.SETFILTER("Return Qty. Rcd. Not Invd.",'<>0');
                NewInvoice := NOT TempSalesLine.ISEMPTY;
              END;
          END;
        EXIT(NewInvoice);
      END;
    END;

    LOCAL PROCEDURE CalcInvDiscount@18(VAR SalesHeader@1000 : Record 36);
    VAR
      SalesHeaderCopy@1005 : Record 36;
      SalesLine@1001 : Record 37;
    BEGIN
      WITH SalesHeader DO BEGIN
        IF NOT (SalesSetup."Calc. Inv. Discount" AND (Status <> Status::Open)) THEN
          EXIT;

        SalesHeaderCopy := SalesHeader;
        SalesLine.RESET;
        SalesLine.SETRANGE("Document Type","Document Type");
        SalesLine.SETRANGE("Document No.","No.");
        OnCalcInvDiscountSetFilter(SalesLine,SalesHeader);
        SalesLine.FINDFIRST;
        CODEUNIT.RUN(CODEUNIT::"Sales-Calc. Discount",SalesLine);
        RefreshTempLines(SalesHeader,TempSalesLineGlobal);
        GET("Document Type","No.");
        RestoreSalesHeader(SalesHeader,SalesHeaderCopy);
        IF NOT (PreviewMode OR SuppressCommit) THEN
          COMMIT;
      END;
    END;

    LOCAL PROCEDURE RestoreSalesHeader@232(VAR SalesHeader@1000 : Record 36;SalesHeaderCopy@1002 : Record 36);
    BEGIN
      WITH SalesHeader DO BEGIN
        Invoice := SalesHeaderCopy.Invoice;
        Receive := SalesHeaderCopy.Receive;
        Ship := SalesHeaderCopy.Ship;
        "Posting No." := SalesHeaderCopy."Posting No.";
        "Shipping No." := SalesHeaderCopy."Shipping No.";
        "Return Receipt No." := SalesHeaderCopy."Return Receipt No.";
      END;

      OnAfterRestoreSalesHeader(SalesHeader,SalesHeaderCopy);
    END;

    LOCAL PROCEDURE CheckAndUpdate@153(VAR SalesHeader@1000 : Record 36;VAR ReferenceNo@1090000 : Code[20];VAR TotalROT@1101285001 : Decimal;VAR TotalRUT@1101285000 : Decimal);
    VAR
      GenJnlCheckLine@1001 : Codeunit 11;
      CheckDimensions@1004 : Codeunit 481;
      SetupRecID@1002 : RecordID;
      ModifyHeader@1003 : Boolean;
      RefreshTempLinesNeeded@1005 : Boolean;
      NextLineNoGLRateCompBuf@1100525000 : Integer;
      CustPostingGr@1100525001 : Record 92;
    BEGIN
      WITH SalesHeader DO BEGIN
        // Check
        ErrorMessageMgt.PushContext(RECORDID,0,CheckSalesHeaderMsg);
        CheckMandatoryHeaderFields(SalesHeader);

        //>>NAVDK
        GetGLSetup;
        IF GLSetup."Danish Localization Active" THEN
          OIOXMLCheckSalesHeader.RUN(SalesHeader);  //NAVDK
        //<<NAVDK

        //>>NAVNO
        IF GLSetup."Norwegian Localization Active" THEN
          IF "E-Invoice" THEN
            CODEUNIT.RUN(CODEUNIT::"PEPPOL Validation",SalesHeader);
        //<<NAVNO

        IF GenJnlCheckLine.IsDateNotAllowed("Posting Date",SetupRecID) THEN
          ErrorMessageMgt.LogContextFieldError(
            FIELDNO("Posting Date"),STRSUBSTNO(PostingDateNotAllowedErr,FIELDCAPTION("Posting Date")),
            SetupRecID,ErrorMessageMgt.GetFieldNo(SetupRecID.TABLENO,GLSetup.FIELDNAME("Allow Posting From")),
            ErrorMessageMgt.GetHelpCodeForAllowedPostingDate);

        SetPostingFlags(SalesHeader);
        IF NOT HideProgressWindow THEN
          InitProgressWindow(SalesHeader);

        InvtPickPutaway := "Posting from Whse. Ref." <> 0;
        "Posting from Whse. Ref." := 0;

        CheckDimensions.CheckSalesDim(SalesHeader,TempSalesLineGlobal);

        CheckPostRestrictions(SalesHeader);

        //**4PS.sn
        IF ("Document Type" = "Document Type"::"Credit Memo") AND
            SalesSetup."Credit Reason Code Obligatory" THEN
          TESTFIELD("Reason Code");

        NextLineNoGLRateCompBuf := 1;
        SetRentalUnitInvoice := FALSE;
        JobSetUp.GET;
        IF JobSetUp."Rental Units active" AND ("Document Type" IN ["Document Type"::Invoice, "Document Type"::"Credit Memo"]) THEN
          CheckManualRentalUnitInvoice(SalesHeader);

        IF "Project Invoice" OR "Rental Unit Invoice" THEN
          IF NOT ChargeJobOrderToPlant(SalesHeader) THEN BEGIN
            CustPostingGr.GET(SalesHeader."Customer Posting Group");
            CustPostingGr.TESTFIELD("Receivables Account");
          END;

        IF "Document Type" = "Document Type"::"Invoice Proposal" THEN BEGIN
          Status := Status::Open;
          MODIFY;
          EXIT; //no further actions
        END;

        IF ("Document Type" = "Document Type"::Order) AND
            (("Sales Document Type" = "Sales Document Type"::"Sales Logistics Separated") OR
            ("Sales Document Type" = "Sales Document Type"::RentalContract))
        THEN
          EXIT; //no further actions

        IF InvoiceOrderNotPostedInvoice THEN
          CheckQtyToInvoicePresent(SalesHeader);
        //**4PS.en

        IF Invoice THEN
          Invoice := CalcInvoice(SalesHeader);

        //**4PS.n
        IF "Document Type" IN ["Document Type"::Invoice, "Document Type"::"Credit Memo"] THEN
          CheckRetention(SalesHeader);
        IF "Document Type" = "Document Type"::"Return Order" THEN
          CheckLogistics(SalesHeader);
        //**4PS.en

        IF Invoice THEN
          CopyAndCheckItemCharge(SalesHeader);

        IF Invoice AND NOT IsCreditDocType THEN
          //**4PS.sn
          IF (NOT ChargePlantToProject(SalesHeader)) AND (NOT ChargeJobOrderToPlant(SalesHeader)) AND
             (NOT ChargePlantToServOrder(SalesHeader)) AND (NOT ChargeSOToJobPlantLoc(SalesHeader)) THEN
          //**4PS.en
            TESTFIELD("Due Date");

        IF Ship THEN BEGIN
          InitPostATOs(SalesHeader);
          Ship := CheckTrackingAndWarehouseForShip(SalesHeader);
          IF NOT InvtPickPutaway THEN
            IF CheckIfInvPickExists(SalesHeader) THEN
              ERROR(InvPickExistsErr);
        END;

        IF Receive THEN BEGIN
          Receive := CheckTrackingAndWarehouseForReceive(SalesHeader);
          IF NOT InvtPickPutaway THEN
            IF CheckIfInvPutawayExists THEN
              ERROR(InvPutAwayExistsErr);
        END;

        IF NOT (Ship OR Invoice OR Receive) THEN
          IF NOT InvoiceOrderNotPostedInvoice THEN  //**4PS.n
            ERROR(NothingToPostErr);

        IF ("Shipping Advice" = "Shipping Advice"::Complete) AND Ship THEN
          CheckShippingAdvice;

        CheckAssosOrderLines(SalesHeader);

        OnAfterCheckSalesDoc(SalesHeader,SuppressCommit,WhseShip,WhseReceive);
        ErrorMessageMgt.Finish;

        // Update
        IF Invoice THEN
          CreatePrepaymentLines(SalesHeader,TRUE);

        ModifyHeader := UpdatePostingNos(SalesHeader);

        DropShipOrder := UpdateAssosOrderPostingNos(SalesHeader);

        OnBeforePostCommitSalesDoc(SalesHeader,GenJnlPostLine,PreviewMode,ModifyHeader,SuppressCommit,TempSalesLineGlobal);
        IF NOT PreviewMode AND ModifyHeader THEN BEGIN
          MODIFY;
          IF NOT SuppressCommit THEN
            COMMIT;
        END;

        RefreshTempLinesNeeded := FALSE;
        OnCheckAndUpdateOnBeforeCalcInvDiscount(
          SalesHeader,TempWhseRcptHeader,TempWhseShptHeader,WhseReceive,WhseShip,RefreshTempLinesNeeded);
        IF RefreshTempLinesNeeded THEN
          RefreshTempLines(SalesHeader,TempSalesLineGlobal);

        CalcInvDiscount(SalesHeader);
        ReleaseSalesDocument(SalesHeader);

        IF Ship OR Receive THEN
          ArchiveUnpostedOrder(SalesHeader);

        CheckICPartnerBlocked(SalesHeader);
        SendICDocument(SalesHeader,ModifyHeader);
        UpdateHandledICInboxTransaction(SalesHeader);

        LockTables(SalesHeader);

        SourceCodeSetup.GET;
        SrcCode := SourceCodeSetup.Sales;
        //**4PS.sn
        IF "Plant Invoice" AND NOT ChargeSOToJobPlantLoc(SalesHeader) AND NOT ChargeSOToCustomerPlantLoc(SalesHeader) THEN //DP00195
          SrcCode := SourceCodeSetup."Plant Invoice";
        //**4PS.en

        //InsertPostedHeaders(SalesHeader);
        InsertPostedHeaders(SalesHeader,ReferenceNo,TotalROT,TotalRUT);  //NAVFI INC#270175

        UpdateIncomingDocument("Incoming Document Entry No.","Posting Date",GenJnlLineDocNo);
      END;

      OnAfterCheckAndUpdate(SalesHeader,SuppressCommit,PreviewMode);
    END;

    LOCAL PROCEDURE PostSalesLine@161(VAR SalesHeader@1000 : Record 36;VAR SalesLine@1001 : Record 37;VAR EverythingInvoiced@1004 : Boolean;VAR TempInvoicePostBuffer@1017 : TEMPORARY Record 49;VAR TempVATAmountLine@1005 : TEMPORARY Record 290;VAR TempVATAmountLineRemainder@1006 : TEMPORARY Record 290;VAR TempItemLedgEntryNotInvoiced@1007 : TEMPORARY Record 32;HasATOShippedNotInvoiced@1008 : Boolean;VAR TempDropShptPostBuffer@1009 : TEMPORARY Record 223;VAR ICGenJnlLineNo@1010 : Integer;VAR TempServiceItem2@1012 : TEMPORARY Record 5940;VAR TempServiceItemComp2@1013 : TEMPORARY Record 5941);
    VAR
      SalesShptLine@1018 : Record 111;
      SalesInvLine@1014 : Record 113;
      SalesCrMemoLine@1015 : Record 115;
      TempPostedATOLink@1003 : TEMPORARY Record 914;
      InvoicePostBuffer@1016 : Record 49;
      CostBaseAmount@1002 : Decimal;
      IsHandled@1011 : Boolean;
      SavedQtyToinvoice@1100525000 : Decimal;
    BEGIN
      WITH SalesLine DO BEGIN
        IF Type = Type::Item THEN
          CostBaseAmount := "Line Amount";
        IF "Qty. per Unit of Measure" = 0 THEN
          "Qty. per Unit of Measure" := 1;

        TestSalesLine(SalesHeader,SalesLine);

        TempPostedATOLink.RESET;
        TempPostedATOLink.DELETEALL;
        IF SalesHeader.Ship THEN
          PostATO(SalesHeader,SalesLine,TempPostedATOLink);
        //**4PS.sn C041808
        SavedQtyToinvoice := SalesLine."Qty. to Invoice";
        //**4PS.en
        UpdateSalesLineBeforePost(SalesHeader,SalesLine);

      //TestUpdatedSalesLine(SalesLine); //**4PS.o
        TestUpdatedSalesLine(SalesHeader,SalesLine); //**4PS.n
        OnPostSalesLineOnAfterTestUpdatedSalesLine(SalesLine,EverythingInvoiced);

        IF "Qty. to Invoice" + "Quantity Invoiced" <> Quantity THEN
          EverythingInvoiced := FALSE;

        OnPostSalesLineOnAfterSetEverythingInvoiced(SalesLine,EverythingInvoiced);

        IF Quantity <> 0 THEN
          DivideAmount(SalesHeader,SalesLine,1,"Qty. to Invoice",TempVATAmountLine,TempVATAmountLineRemainder);

        CheckItemReservDisruption(SalesLine);
        //**4PS: Next line will round amounts but will also do a FCY to LCY
        RoundAmount(SalesHeader,SalesLine,"Qty. to Invoice");

        IF NOT IsCreditDocType THEN BEGIN
          ReverseAmount(SalesLine);
          ReverseAmount(SalesLineACY);
        END;

        PostICServiceProject(SalesHeader, SalesLine); //**4PS.n

        RemQtyToBeInvoiced := "Qty. to Invoice";
        RemQtyToBeInvoicedBase := "Qty. to Invoice (Base)";

        OnPostSalesLineOnBeforePostItemTrackingLine(SalesHeader,SalesLine,WhseShip,WhseReceive,InvtPickPutaway);

        PostItemTrackingLine(SalesHeader,SalesLine,TempItemLedgEntryNotInvoiced,HasATOShippedNotInvoiced);

        OnPostSalesLineOnAfterPostItemTrackingLine(SalesHeader,SalesLine,WhseShip,WhseReceive,InvtPickPutaway);

        CASE Type OF
          Type::"G/L Account":
            PostGLAccICLine(SalesHeader,SalesLine,ICGenJnlLineNo);
          Type::Item:
            PostItemLine(SalesHeader,SalesLine,TempDropShptPostBuffer,TempPostedATOLink);
          Type::Resource:
            PostResJnlLine(SalesHeader,SalesLine,JobTaskSalesLine);
          Type::"Charge (Item)":
            PostItemChargeLine(SalesHeader,SalesLine);
        END;

        IF (Type >= Type::"G/L Account") AND ("Qty. to Invoice" <> 0) THEN BEGIN
          AdjustPrepmtAmountLCY(SalesHeader,SalesLine);
          FillInvoicePostingBuffer(SalesHeader,SalesLine,SalesLineACY,TempInvoicePostBuffer,InvoicePostBuffer);
          InsertPrepmtAdjInvPostingBuf(SalesHeader,SalesLine,TempInvoicePostBuffer,InvoicePostBuffer);

          //**4PS.sn
          IF SalesLine.RetentionAmount(1) <> 0 THEN
            FillRetentionPostingBuffer(SalesHeader,SalesLine,SalesLineACY,1);
          IF SalesLine.RetentionAmount(2) <> 0 THEN
            FillRetentionPostingBuffer(SalesHeader,SalesLine,SalesLineACY,2);
          //**4PS.en
        END;

        IsHandled := FALSE;
        OnPostSalesLineOnBeforeTestJobNo(SalesLine,IsHandled);
        IF NOT IsHandled THEN
        //IF NOT ("Document Type" IN ["Document Type"::Invoice,"Document Type"::"Credit Memo"]) THEN  //**4PS.o
          IF NOT ("Document Type" IN ["Document Type"::Order,"Document Type"::Invoice,"Document Type"::"Credit Memo"]) THEN  //**4PS.n
            TESTFIELD("Job No.",'');

        //**4PS.sn
        PostJobServicePlant(SalesHeader,SalesLine,InvoicePostBuffer);
        PostLoan(SalesHeader,SalesLine,InvoicePostBuffer);
        //**4PS.en

        IsHandled := FALSE;
        OnPostSalesLineOnBeforeInsertShipmentLine(
          SalesHeader,SalesLine,IsHandled,SalesLineACY,GenJnlLineDocType,GenJnlLineDocNo,GenJnlLineExtDocNo);
        IF NOT IsHandled THEN
          IF (SalesShptHeader."No." <> '') AND ("Shipment No." = '') AND
             NOT RoundingLineInserted AND NOT "Prepayment Line"
             AND AdditionalCheckOnQtyOk(SalesLine,TRUE) //**4PS.n C015652
          THEN
            InsertShipmentLine(SalesHeader,SalesShptHeader,SalesLine,CostBaseAmount,TempServiceItem2,TempServiceItemComp2);

        IsHandled := FALSE;
        OnPostSalesLineOnBeforeInsertReturnReceiptLine(SalesHeader,SalesLine,IsHandled);
        IF (ReturnRcptHeader."No." <> '') AND ("Return Receipt No." = '') AND
           NOT RoundingLineInserted
        THEN
          InsertReturnReceiptLine(ReturnRcptHeader,SalesLine,CostBaseAmount);

        IsHandled := FALSE;

        //**4PS.sn
        IF InvoiceOrderNotPostedInvoice THEN
          DelayInsertNotPostedSaleInvLin(SalesLine,SavedQtyToinvoice);  //**4PS change C041808
        //**4PS.en

        IF SalesHeader.Invoice THEN
          IF SalesHeader."Document Type" IN [SalesHeader."Document Type"::Order,SalesHeader."Document Type"::Invoice] THEN BEGIN
            OnPostSalesLineOnBeforeInsertInvoiceLine(SalesHeader,SalesLine,IsHandled);
            IF NOT IsHandled THEN BEGIN
              SalesInvLine.InitFromSalesLine(SalesInvHeader,xSalesLine);
              ItemJnlPostLine.CollectValueEntryRelation(TempValueEntryRelation,SalesInvLine.RowID1);
              IF "Document Type" = "Document Type"::Order THEN BEGIN
                SalesInvLine."Order No." := "Document No.";
                SalesInvLine."Order Line No." := "Line No.";
              END ELSE
                IF SalesShptLine.GET("Shipment No.","Shipment Line No.") THEN BEGIN
                  SalesInvLine."Order No." := SalesShptLine."Order No.";
                  SalesInvLine."Order Line No." := SalesShptLine."Order Line No.";
                END;
              OnBeforeSalesInvLineInsert(SalesInvLine,SalesInvHeader,xSalesLine,SuppressCommit);
              SalesInvLine.INSERT(TRUE);
              OnAfterSalesInvLineInsert(
                SalesInvLine,SalesInvHeader,xSalesLine,ItemLedgShptEntryNo,WhseShip,WhseReceive,SuppressCommit,
                SalesHeader,TempItemChargeAssgntSales);

              //**4PS.sn
              InsertNSItemTrackingRelation(xSalesLine,SalesInvLine.RowID1);
              //**4PS.en

              CreatePostedDeferralScheduleFromSalesDoc(xSalesLine,SalesInvLine.GetDocumentType,
                SalesInvHeader."No.",SalesInvLine."Line No.",SalesInvHeader."Posting Date");
            END;
          END ELSE BEGIN
            OnPostSalesLineOnBeforeInsertCrMemoLine(SalesHeader,SalesLine,IsHandled);
            IF NOT IsHandled THEN BEGIN
              SalesCrMemoLine.InitFromSalesLine(SalesCrMemoHeader,xSalesLine);
              ItemJnlPostLine.CollectValueEntryRelation(TempValueEntryRelation,SalesCrMemoLine.RowID1);
              IF "Document Type" = "Document Type"::"Return Order" THEN BEGIN
                SalesCrMemoLine."Order No." := "Document No.";
                SalesCrMemoLine."Order Line No." := "Line No.";
              END;
              OnBeforeSalesCrMemoLineInsert(SalesCrMemoLine,SalesCrMemoHeader,xSalesLine,SuppressCommit);
              SalesCrMemoLine.INSERT(TRUE);
              OnAfterSalesCrMemoLineInsert(
                SalesCrMemoLine,SalesCrMemoHeader,SalesHeader,xSalesLine,TempItemChargeAssgntSales,SuppressCommit);
              //**4PS.sn
              InsertNSItemTrackingRelation(xSalesLine,SalesCrMemoLine.RowID1);
              //**4PS.en

              CreatePostedDeferralScheduleFromSalesDoc(xSalesLine,SalesCrMemoLine.GetDocumentType,
                SalesCrMemoHeader."No.",SalesCrMemoLine."Line No.",SalesCrMemoHeader."Posting Date");
            END;
          END;

        //**4PS.sn
        IF SalesHeader.Invoice THEN
          SetLedgerEntryProcessed(xSalesLine);
        //**4PS.en
      END;

      OnAfterPostSalesLine(SalesHeader,SalesLine,SuppressCommit);
    END;

    LOCAL PROCEDURE PostGLAndCustomer@164(SalesHeader@1000 : Record 36;VAR TempInvoicePostBuffer@1001 : TEMPORARY Record 49;VAR CustLedgEntry@1002 : Record 21;ReferenceNo@1090000 : Code[20];TotalROT@1101285000 : Decimal;TotalRUT@1101285001 : Decimal);
    VAR
      IsHandled@1003 : Boolean;
      CrRestrictionAmt@1100525001 : Decimal;
      CrRestrictionVATAmt@1100525000 : Decimal;
    BEGIN
      OnBeforePostGLAndCustomer(SalesHeader,TempInvoicePostBuffer,CustLedgEntry,SuppressCommit,PreviewMode,GenJnlPostLine,IsHandled);
      IF IsHandled THEN
        EXIT;

      WITH SalesHeader DO BEGIN
        PostRetentionPostingBuffer(SalesHeader); //**4PS.n

        // Post sales and VAT to G/L entries from posting buffer
      //PostInvoicePostBuffer(SalesHeader,TempInvoicePostBuffer); //**4PS.o
        PostInvoicePostBuffer(SalesHeader,TempInvoicePostBuffer,CrRestrictionAmt,CrRestrictionVATAmt); //**4PS.n

        //**4PS.sn
        IF (ChargePlantToOwnProj(SalesHeader) OR ChargeJobOrderToOwnPlant(SalesHeader) OR ChargePlantToOwnServOrder(SalesHeader) OR ChargeSOToJobPlantLoc(SalesHeader) OR
            InternalChargePlantOnLoc(SalesHeader,'') OR ChargeSOToPlantItem(SalesHeader)) AND
            (NOT ChargeSOToCustomerPlantLoc(SalesHeader))
        THEN BEGIN
          IF ChargePlantToOwnProj(SalesHeader) THEN BEGIN
            TempJobJnlLine.RESET;
            IF TempJobJnlLine.FIND('-') THEN
              REPEAT
                JobJnlPostLine.RUN(TempJobJnlLine);
                TempJobJnlLine.DELETE;
              UNTIL TempJobJnlLine.NEXT = 0;
          END;
        END ELSE BEGIN
        //**4PS.en

          // Post customer entry
          IF GUIALLOWED AND NOT HideProgressWindow THEN
            Window.UPDATE(4,1);

          UpdateBAmountOnPostedHeaders(SalesHeader); //**4PS.n C040380

          PostCustomerEntry(
            SalesHeader,TotalSalesLine,TotalSalesLineLCY,GenJnlLineDocType,GenJnlLineDocNo,GenJnlLineExtDocNo,SrcCode,
            //CrRestrictionAmt,CrRestrictionVATAmt); //**4PS.n C016276
            CrRestrictionAmt,CrRestrictionVATAmt,
            ReferenceNo,  //NAVFI
            TotalROT,TotalRUT); //RFC188 //**4PS.n C016276

          IF NOT PlantTransportInternalCust THEN  //**4PS.n C021883
            UpdateSalesHeader(CustLedgEntry);

          // Balancing account
          IF "Bal. Account No." <> '' THEN BEGIN
            IF GUIALLOWED AND NOT HideProgressWindow THEN
              Window.UPDATE(5,1);
            PostBalancingEntry(
              SalesHeader,TotalSalesLine,TotalSalesLineLCY,GenJnlLineDocType,GenJnlLineDocNo,GenJnlLineExtDocNo,SrcCode);
          END;
        END;  //**4PS.n
      END;

      OnAfterPostGLAndCustomer(SalesHeader,GenJnlPostLine,TotalSalesLine,TotalSalesLineLCY,SuppressCommit);
    END;

    LOCAL PROCEDURE PostGLAccICLine@160(SalesHeader@1000 : Record 36;SalesLine@1003 : Record 37;VAR ICGenJnlLineNo@1002 : Integer);
    VAR
      GLAcc@1001 : Record 15;
    BEGIN
      IF (SalesLine."No." <> '') AND NOT SalesLine."System-Created Entry" THEN BEGIN
        GLAcc.GET(SalesLine."No.");
        GLAcc.TESTFIELD("Direct Posting",TRUE);
        IF (SalesLine."IC Partner Code" <> '') AND SalesHeader.Invoice THEN
          InsertICGenJnlLine(SalesHeader,xSalesLine,ICGenJnlLineNo);
      END;
    END;

    LOCAL PROCEDURE PostItemLine@170(SalesHeader@1000 : Record 36;VAR SalesLine@1001 : Record 37;VAR TempDropShptPostBuffer@1002 : TEMPORARY Record 223;VAR TempPostedATOLink@1003 : TEMPORARY Record 914);
    VAR
      DummyTrackingSpecification@1004 : Record 336;
      SalesLineToShip@1007 : Record 37;
      QtyToInvoice@1005 : Decimal;
      QtyToInvoiceBase@1006 : Decimal;
    BEGIN
      ItemLedgShptEntryNo := 0;
      QtyToInvoice := RemQtyToBeInvoiced;
      QtyToInvoiceBase := RemQtyToBeInvoicedBase;

      WITH SalesHeader DO BEGIN
        IF (SalesLine."Qty. to Ship" <> 0) AND (SalesLine."Purch. Order Line No." <> 0) THEN BEGIN
          TempDropShptPostBuffer."Order No." := SalesLine."Purchase Order No.";
          TempDropShptPostBuffer."Order Line No." := SalesLine."Purch. Order Line No.";
          TempDropShptPostBuffer.Quantity := -SalesLine."Qty. to Ship";
          TempDropShptPostBuffer."Quantity (Base)" := -SalesLine."Qty. to Ship (Base)";
          TempDropShptPostBuffer."Item Shpt. Entry No." :=
            PostAssocItemJnlLine(SalesHeader,SalesLine,TempDropShptPostBuffer.Quantity,TempDropShptPostBuffer."Quantity (Base)");
          TempDropShptPostBuffer.INSERT;
          SalesLine."Appl.-to Item Entry" := TempDropShptPostBuffer."Item Shpt. Entry No.";
        END;

        CLEAR(TempPostedATOLink);
        TempPostedATOLink.SETRANGE("Order No.",SalesLine."Document No.");
        TempPostedATOLink.SETRANGE("Order Line No.",SalesLine."Line No.");
        IF TempPostedATOLink.FINDFIRST THEN
          PostATOAssocItemJnlLine(SalesHeader,SalesLine,TempPostedATOLink,QtyToInvoice,QtyToInvoiceBase);

        IF QtyToInvoice <> 0 THEN
          ItemLedgShptEntryNo :=
            PostItemJnlLine(
              SalesHeader,SalesLine,
              QtyToInvoice,QtyToInvoiceBase,
              QtyToInvoice,QtyToInvoiceBase,
              0,'',DummyTrackingSpecification,FALSE);

        // Invoice discount amount is also included in expected sales amount posted for shipment or return receipt.
        MakeSalesLineToShip(SalesLineToShip,SalesLine);

        IF SalesLineToShip.IsCreditDocType THEN BEGIN
          IF ABS(SalesLineToShip."Return Qty. to Receive") > ABS(QtyToInvoice) THEN
            ItemLedgShptEntryNo :=
              PostItemJnlLine(
                SalesHeader,SalesLineToShip,
                SalesLineToShip."Return Qty. to Receive" - QtyToInvoice,
                SalesLineToShip."Return Qty. to Receive (Base)" - QtyToInvoiceBase,
                0,0,0,'',DummyTrackingSpecification,FALSE);
        END ELSE BEGIN
          IF ABS(SalesLineToShip."Qty. to Ship") > ABS(QtyToInvoice) + ABS(TempPostedATOLink."Assembled Quantity") THEN
            ItemLedgShptEntryNo :=
              PostItemJnlLine(
                SalesHeader,SalesLineToShip,
                SalesLineToShip."Qty. to Ship" - TempPostedATOLink."Assembled Quantity" - QtyToInvoice,
                SalesLineToShip."Qty. to Ship (Base)" - TempPostedATOLink."Assembled Quantity (Base)" - QtyToInvoiceBase,
                0,0,0,'',DummyTrackingSpecification,FALSE);
        END;
      END;
    END;

    LOCAL PROCEDURE PostItemChargeLine@172(SalesHeader@1001 : Record 36;SalesLine@1002 : Record 37);
    VAR
      SalesLineBackup@1000 : Record 37;
    BEGIN
      IF NOT (SalesHeader.Invoice AND (SalesLine."Qty. to Invoice" <> 0)) THEN
        EXIT;

      ItemJnlRollRndg := TRUE;
      SalesLineBackup.COPY(SalesLine);
      IF FindTempItemChargeAssgntSales(SalesLineBackup."Line No.") THEN
        REPEAT
          CASE TempItemChargeAssgntSales."Applies-to Doc. Type" OF
            TempItemChargeAssgntSales."Applies-to Doc. Type"::Shipment:
              BEGIN
                PostItemChargePerShpt(SalesHeader,SalesLineBackup);
                TempItemChargeAssgntSales.MARK(TRUE);
              END;
            TempItemChargeAssgntSales."Applies-to Doc. Type"::"Return Receipt":
              BEGIN
                PostItemChargePerRetRcpt(SalesHeader,SalesLineBackup);
                TempItemChargeAssgntSales.MARK(TRUE);
              END;
            TempItemChargeAssgntSales."Applies-to Doc. Type"::Order,
            TempItemChargeAssgntSales."Applies-to Doc. Type"::Invoice,
            TempItemChargeAssgntSales."Applies-to Doc. Type"::"Return Order",
            TempItemChargeAssgntSales."Applies-to Doc. Type"::"Credit Memo":
              CheckItemCharge(TempItemChargeAssgntSales);
          END;
        UNTIL TempItemChargeAssgntSales.NEXT = 0;
    END;

    LOCAL PROCEDURE PostItemTrackingLine@162(SalesHeader@1000 : Record 36;SalesLine@1001 : Record 37;VAR TempItemLedgEntryNotInvoiced@1004 : TEMPORARY Record 32;HasATOShippedNotInvoiced@1005 : Boolean);
    VAR
      TempTrackingSpecification@1003 : TEMPORARY Record 336;
      TrackingSpecificationExists@1002 : Boolean;
    BEGIN
      IF SalesLine."Prepayment Line" THEN
        EXIT;

      IF SalesHeader.Invoice THEN
        IF SalesLine."Qty. to Invoice" = 0 THEN
          TrackingSpecificationExists := FALSE
        ELSE
          TrackingSpecificationExists :=
            ReserveSalesLine.RetrieveInvoiceSpecification(SalesLine,TempTrackingSpecification);

      PostItemTracking(
        SalesHeader,SalesLine,TrackingSpecificationExists,TempTrackingSpecification,
        TempItemLedgEntryNotInvoiced,HasATOShippedNotInvoiced);

      IF TrackingSpecificationExists THEN
        SaveInvoiceSpecification(TempTrackingSpecification);
    END;

    LOCAL PROCEDURE PostItemJnlLine@2(SalesHeader@1017 : Record 36;SalesLine@1000 : Record 37;QtyToBeShipped@1001 : Decimal;QtyToBeShippedBase@1002 : Decimal;QtyToBeInvoiced@1003 : Decimal;QtyToBeInvoicedBase@1004 : Decimal;ItemLedgShptEntryNo@1005 : Integer;ItemChargeNo@1006 : Code[20];TrackingSpecification@1009 : Record 336;IsATO@1007 : Boolean) : Integer;
    VAR
      ItemJnlLine@1010 : Record 83;
      TempWhseJnlLine@1012 : TEMPORARY Record 7311;
      TempWhseTrackingSpecification@1008 : TEMPORARY Record 336;
      OriginalItemJnlLine@1013 : Record 83;
      CurrExchRate@1015 : Record 330;
      PostWhseJnlLine@1011 : Boolean;
      InvDiscAmountPerShippedQty@1016 : Decimal;
      IsHandled@1014 : Boolean;
    BEGIN
      IsHandled := FALSE;
      OnBeforePostItemJnlLine(
        SalesHeader,SalesLine,QtyToBeShipped,QtyToBeShippedBase,QtyToBeInvoiced,QtyToBeInvoicedBase,
        ItemLedgShptEntryNo,ItemChargeNo,TrackingSpecification,IsATO,SuppressCommit,IsHandled);
      IF IsHandled THEN
        EXIT;

      IF NOT ItemJnlRollRndg THEN BEGIN
        RemAmt := 0;
        RemDiscAmt := 0;
      END;

      WITH ItemJnlLine DO BEGIN
        INIT;
        CopyFromSalesHeader(SalesHeader);
        CopyFromSalesLine(SalesLine);
        "Country/Region Code" := GetCountryCode(SalesLine,SalesHeader);

        CopyTrackingFromSpec(TrackingSpecification);
        "Item Shpt. Entry No." := ItemLedgShptEntryNo;

        Quantity := -QtyToBeShipped;
        "Quantity (Base)" := -QtyToBeShippedBase;
        "Invoiced Quantity" := -QtyToBeInvoiced;
        "Invoiced Qty. (Base)" := -QtyToBeInvoicedBase;

        PostItemJnlLineCopyDocumentFields(ItemJnlLine,SalesHeader,SalesLine,QtyToBeShipped,QtyToBeInvoiced);

        IF QtyToBeInvoiced <> 0 THEN
          "Invoice No." := GenJnlLineDocNo;

        "Assemble to Order" := IsATO;
        IF "Assemble to Order" THEN
          "Applies-to Entry" := SalesLine.FindOpenATOEntry('','')
        ELSE
          "Applies-to Entry" := SalesLine."Appl.-to Item Entry";

        IF ItemChargeNo <> '' THEN BEGIN
          "Item Charge No." := ItemChargeNo;
          SalesLine."Qty. to Invoice" := QtyToBeInvoiced;
        END ELSE
          "Applies-from Entry" := SalesLine."Appl.-from Item Entry";

        IF QtyToBeInvoiced <> 0 THEN BEGIN
          Amount := -(SalesLine.Amount * (QtyToBeInvoiced / SalesLine."Qty. to Invoice") - RemAmt);
          IF SalesHeader."Prices Including VAT" THEN
            "Discount Amount" :=
              -((SalesLine."Line Discount Amount" + SalesLine."Inv. Discount Amount") /
                (1 + SalesLine."VAT %" / 100) * (QtyToBeInvoiced / SalesLine."Qty. to Invoice") - RemDiscAmt)
          ELSE
            "Discount Amount" :=
              -((SalesLine."Line Discount Amount" + SalesLine."Inv. Discount Amount") *
                (QtyToBeInvoiced / SalesLine."Qty. to Invoice") - RemDiscAmt);
          RemAmt := Amount - ROUND(Amount);
          RemDiscAmt := "Discount Amount" - ROUND("Discount Amount");
          Amount := ROUND(Amount);
          "Discount Amount" := ROUND("Discount Amount");
        END ELSE BEGIN
          InvDiscAmountPerShippedQty := ABS(SalesLine."Inv. Discount Amount") * QtyToBeShipped / SalesLine.Quantity;
          Amount := QtyToBeShipped * SalesLine."Unit Price";
          IF SalesHeader."Prices Including VAT" THEN
            Amount :=
              -((Amount * (1 - SalesLine."Line Discount %" / 100) - InvDiscAmountPerShippedQty) /
                (1 + SalesLine."VAT %" / 100) - RemAmt)
          ELSE
            Amount :=
              -(Amount * (1 - SalesLine."Line Discount %" / 100) - InvDiscAmountPerShippedQty - RemAmt);
          RemAmt := Amount - ROUND(Amount);
          IF SalesHeader."Currency Code" <> '' THEN
            Amount :=
              ROUND(
                CurrExchRate.ExchangeAmtFCYToLCY(
                  0, '', //**4PS.n
                  SalesHeader."Posting Date",SalesHeader."Currency Code",
                //Amount,SalesHeader."Currency Factor")) //**4PS.o
                  Amount,SalesHeader."Currency Factor",TRUE)) //**4PS.n
          ELSE
            Amount := ROUND(Amount);
        END;

        IF NOT JobContractLine THEN BEGIN
          PostItemJnlLineBeforePost(ItemJnlLine,SalesLine,TempWhseJnlLine,PostWhseJnlLine,QtyToBeShippedBase);

          OriginalItemJnlLine := ItemJnlLine;
          IF NOT IsItemJnlPostLineHandled(ItemJnlLine,SalesLine,SalesHeader) THEN
            ItemJnlPostLine.RunWithCheck(ItemJnlLine);

          IF IsATO THEN
            PostItemJnlLineTracking(
              SalesLine,TempWhseTrackingSpecification,PostWhseJnlLine,QtyToBeInvoiced,TempATOTrackingSpecification)
          ELSE
            PostItemJnlLineTracking(SalesLine,TempWhseTrackingSpecification,PostWhseJnlLine,QtyToBeInvoiced,TempHandlingSpecification);

          IsHandled := FALSE;
          OnPostItemJnlLineOnBeforePostItemJnlLineWhseLine(
            ItemJnlLine,TempWhseJnlLine,TempWhseTrackingSpecification,TempTrackingSpecification,IsHandled);
          IF NOT IsHandled THEN
            PostItemJnlLineWhseLine(TempWhseJnlLine,TempWhseTrackingSpecification);

          OnAfterPostItemJnlLineWhseLine(SalesLine,ItemLedgShptEntryNo,WhseShip,WhseReceive,SuppressCommit);

          IF (SalesLine.Type = SalesLine.Type::Item) AND SalesHeader.Invoice THEN
            PostItemJnlLineItemCharges(SalesHeader,SalesLine,OriginalItemJnlLine,"Item Shpt. Entry No.");
        END;

        OnAfterPostItemJnlLine(ItemJnlLine,SalesLine,SalesHeader,ItemJnlPostLine);

        EXIT("Item Shpt. Entry No.");
      END;
    END;

    LOCAL PROCEDURE PostItemJnlLineCopyDocumentFields@322(VAR ItemJnlLine@1000 : Record 83;SalesHeader@1001 : Record 36;SalesLine@1002 : Record 37;QtyToBeShipped@1003 : Decimal;QtyToBeInvoiced@1004 : Decimal);
    BEGIN
      WITH ItemJnlLine DO
        IF QtyToBeShipped = 0 THEN
          IF SalesLine.IsCreditDocType THEN
            CopyDocumentFields(
              "Document Type"::"Sales Credit Memo",GenJnlLineDocNo,GenJnlLineExtDocNo,SrcCode,SalesHeader."Posting No. Series")
          ELSE
            CopyDocumentFields(
              "Document Type"::"Sales Invoice",GenJnlLineDocNo,GenJnlLineExtDocNo,SrcCode,SalesHeader."Posting No. Series")
        ELSE BEGIN
          IF SalesLine.IsCreditDocType THEN
            CopyDocumentFields(
              "Document Type"::"Sales Return Receipt",
              ReturnRcptHeader."No.",ReturnRcptHeader."External Document No.",SrcCode,ReturnRcptHeader."No. Series")
          ELSE
            CopyDocumentFields(
              "Document Type"::"Sales Shipment",SalesShptHeader."No.",SalesShptHeader."External Document No.",SrcCode,
              SalesShptHeader."No. Series");
          IF QtyToBeInvoiced <> 0 THEN BEGIN
            IF "Document No." = '' THEN
              IF SalesLine."Document Type" = SalesLine."Document Type"::"Credit Memo" THEN
                CopyDocumentFields(
                  "Document Type"::"Sales Credit Memo",GenJnlLineDocNo,GenJnlLineExtDocNo,SrcCode,SalesHeader."Posting No. Series")
              ELSE
                CopyDocumentFields(
                  "Document Type"::"Sales Invoice",GenJnlLineDocNo,GenJnlLineExtDocNo,SrcCode,SalesHeader."Posting No. Series");
            "Posting No. Series" := SalesHeader."Posting No. Series";
          END;
        END;

      OnPostItemJnlLineOnAfterCopyDocumentFields(ItemJnlLine,SalesLine,TempWhseRcptHeader,TempWhseShptHeader);
    END;

    LOCAL PROCEDURE PostItemJnlLineItemCharges@165(SalesHeader@1000 : Record 36;SalesLine@1001 : Record 37;VAR OriginalItemJnlLine@1003 : Record 83;ItemShptEntryNo@1004 : Integer);
    VAR
      ItemChargeSalesLine@1002 : Record 37;
    BEGIN
      WITH SalesLine DO BEGIN
        ClearItemChargeAssgntFilter;
        TempItemChargeAssgntSales.SETCURRENTKEY(
          "Applies-to Doc. Type","Applies-to Doc. No.","Applies-to Doc. Line No.");
        TempItemChargeAssgntSales.SETRANGE("Applies-to Doc. Type","Document Type");
        TempItemChargeAssgntSales.SETRANGE("Applies-to Doc. No.","Document No.");
        TempItemChargeAssgntSales.SETRANGE("Applies-to Doc. Line No.","Line No.");
        IF TempItemChargeAssgntSales.FINDSET THEN
          REPEAT
            TESTFIELD("Allow Item Charge Assignment");
            GetItemChargeLine(SalesHeader,ItemChargeSalesLine);
            ItemChargeSalesLine.CALCFIELDS("Qty. Assigned");
            IF (ItemChargeSalesLine."Qty. to Invoice" <> 0) OR
               (ABS(ItemChargeSalesLine."Qty. Assigned") < ABS(ItemChargeSalesLine."Quantity Invoiced"))
            THEN BEGIN
              OriginalItemJnlLine."Item Shpt. Entry No." := ItemShptEntryNo;
              PostItemChargePerOrder(SalesHeader,SalesLine,OriginalItemJnlLine,ItemChargeSalesLine);
              TempItemChargeAssgntSales.MARK(TRUE);
            END;
          UNTIL TempItemChargeAssgntSales.NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE PostItemJnlLineTracking@166(SalesLine@1000 : Record 37;VAR TempWhseTrackingSpecification@1002 : TEMPORARY Record 336;PostWhseJnlLine@1001 : Boolean;QtyToBeInvoiced@1003 : Decimal;VAR TempTrackingSpec@1004 : TEMPORARY Record 336);
    BEGIN
      IF ItemJnlPostLine.CollectTrackingSpecification(TempTrackingSpec) THEN
        IF TempTrackingSpec.FINDSET THEN
          REPEAT
            TempTrackingSpecification := TempTrackingSpec;
            TempTrackingSpecification.SetSourceFromSalesLine(SalesLine);
            IF TempTrackingSpecification.INSERT THEN;
            IF QtyToBeInvoiced <> 0 THEN BEGIN
              TempTrackingSpecificationInv := TempTrackingSpecification;
              IF TempTrackingSpecificationInv.INSERT THEN;
            END;
            IF PostWhseJnlLine THEN BEGIN
              TempWhseTrackingSpecification := TempTrackingSpecification;
              IF TempWhseTrackingSpecification.INSERT THEN;
            END;
          UNTIL TempTrackingSpec.NEXT = 0;
    END;

    LOCAL PROCEDURE PostItemJnlLineWhseLine@173(VAR TempWhseJnlLine@1000 : TEMPORARY Record 7311;VAR TempWhseTrackingSpecification@1001 : TEMPORARY Record 336);
    VAR
      TempWhseJnlLine2@1002 : TEMPORARY Record 7311;
    BEGIN
      ItemTrackingMgt.SplitWhseJnlLine(TempWhseJnlLine,TempWhseJnlLine2,TempWhseTrackingSpecification,FALSE);
      IF TempWhseJnlLine2.FINDSET THEN
        REPEAT
          WhseJnlPostLine.RUN(TempWhseJnlLine2);
        UNTIL TempWhseJnlLine2.NEXT = 0;
      TempWhseTrackingSpecification.DELETEALL;
    END;

    LOCAL PROCEDURE PostItemJnlLineBeforePost@280(VAR ItemJnlLine@1000 : Record 83;SalesLine@1001 : Record 37;VAR TempWhseJnlLine@1002 : TEMPORARY Record 7311;VAR PostWhseJnlLine@1004 : Boolean;QtyToBeShippedBase@1005 : Decimal);
    VAR
      CheckApplFromItemEntry@1003 : Boolean;
    BEGIN
      WITH ItemJnlLine DO BEGIN
        IF SalesSetup."Exact Cost Reversing Mandatory" AND (SalesLine.Type = SalesLine.Type::Item) THEN
          IF SalesLine.IsCreditDocType THEN
            CheckApplFromItemEntry := SalesLine.Quantity > 0
          ELSE
            CheckApplFromItemEntry := SalesLine.Quantity < 0;

        IF (SalesLine."Location Code" <> '') AND (SalesLine.Type = SalesLine.Type::Item) AND (Quantity <> 0) THEN
          IF ShouldPostWhseJnlLine(SalesLine) THEN BEGIN
            CreateWhseJnlLine(ItemJnlLine,SalesLine,TempWhseJnlLine);
            PostWhseJnlLine := TRUE;
          END;

        OnPostItemJnlLineOnBeforeTransferReservToItemJnlLine(SalesLine,ItemJnlLine);

        IF QtyToBeShippedBase <> 0 THEN BEGIN
          IF SalesLine.IsCreditDocType THEN
            ReserveSalesLine.TransferSalesLineToItemJnlLine(SalesLine,ItemJnlLine,QtyToBeShippedBase,CheckApplFromItemEntry,FALSE)
          ELSE
            TransferReservToItemJnlLine(
              SalesLine,ItemJnlLine,-QtyToBeShippedBase,TempTrackingSpecification,CheckApplFromItemEntry);

          IF CheckApplFromItemEntry AND SalesLine.IsInventoriableItem THEN
            SalesLine.TESTFIELD("Appl.-from Item Entry");
        END;
      END;

      OnAfterPostItemJnlLineBeforePost(ItemJnlLine,SalesLine);
    END;

    LOCAL PROCEDURE ShouldPostWhseJnlLine@73(SalesLine@1000 : Record 37) Result : Boolean;
    VAR
      IsHandled@1001 : Boolean;
    BEGIN
      OnBeforeShouldPostWhseJnlLine(SalesLine,Result,IsHandled);
      IF IsHandled THEN
        EXIT(Result);

      WITH SalesLine DO BEGIN
        GetLocation("Location Code");
        IF (("Document Type" IN ["Document Type"::Invoice,"Document Type"::"Credit Memo"]) AND
            Location."Directed Put-away and Pick") OR
           (Location."Bin Mandatory" AND NOT (WhseShip OR WhseReceive OR InvtPickPutaway OR "Drop Shipment"))
        THEN
          EXIT(TRUE);
      END;
      EXIT(FALSE);
    END;

    LOCAL PROCEDURE PostItemChargePerOrder@5801(SalesHeader@1012 : Record 36;SalesLine@1013 : Record 37;ItemJnlLine2@1001 : Record 83;ItemChargeSalesLine@1002 : Record 37);
    VAR
      NonDistrItemJnlLine@1000 : Record 83;
      CurrExchRate@1003 : Record 330;
      QtyToInvoice@1004 : Decimal;
      Factor@1005 : Decimal;
      OriginalAmt@1007 : Decimal;
      OriginalDiscountAmt@1009 : Decimal;
      OriginalQty@1010 : Decimal;
      SignFactor@1006 : Integer;
      TotalChargeAmt2@1008 : Decimal;
      TotalChargeAmtLCY2@1011 : Decimal;
      IsHandled@1014 : Boolean;
    BEGIN
      OnBeforePostItemChargePerOrder(SalesHeader,SalesLine,ItemJnlLine2,ItemChargeSalesLine,SuppressCommit);

      IsHandled := FALSE;
      OnPostItemChargePerOrderOnBeforeTestJobNo(SalesLine,IsHandled);
      IF NOT IsHandled THEN
        SalesLine.TESTFIELD("Job No.",'');
      SalesLine.TESTFIELD("Allow Item Charge Assignment",TRUE);

      WITH TempItemChargeAssgntSales DO BEGIN
        ItemJnlLine2."Document No." := GenJnlLineDocNo;
        ItemJnlLine2."External Document No." := GenJnlLineExtDocNo;
        ItemJnlLine2."Item Charge No." := "Item Charge No.";
        ItemJnlLine2.Description := ItemChargeSalesLine.Description;
        ItemJnlLine2."Description 2" := ItemChargeSalesLine."Description 2";  //**4PS.n
        ItemJnlLine2."Unit of Measure Code" := '';
        ItemJnlLine2."Qty. per Unit of Measure" := 1;
        ItemJnlLine2."Applies-from Entry" := 0;
        IF "Document Type" IN ["Document Type"::"Return Order","Document Type"::"Credit Memo"] THEN
          QtyToInvoice :=
            CalcQtyToInvoice(SalesLine."Return Qty. to Receive (Base)",SalesLine."Qty. to Invoice (Base)")
        ELSE
          QtyToInvoice :=
            CalcQtyToInvoice(SalesLine."Qty. to Ship (Base)",SalesLine."Qty. to Invoice (Base)");
        IF ItemJnlLine2."Invoiced Quantity" = 0 THEN BEGIN
          ItemJnlLine2."Invoiced Quantity" := ItemJnlLine2.Quantity;
          ItemJnlLine2."Invoiced Qty. (Base)" := ItemJnlLine2."Quantity (Base)";
        END;
        ItemJnlLine2."Document Line No." := ItemChargeSalesLine."Line No.";

        ItemJnlLine2.Amount := "Amount to Assign" * ItemJnlLine2."Invoiced Qty. (Base)" / QtyToInvoice;
        IF "Document Type" IN ["Document Type"::"Return Order","Document Type"::"Credit Memo"] THEN
          ItemJnlLine2.Amount := -ItemJnlLine2.Amount;
        ItemJnlLine2."Unit Cost (ACY)" :=
          ROUND(ItemJnlLine2.Amount / ItemJnlLine2."Invoiced Qty. (Base)",
            Currency."Unit-Amount Rounding Precision");

        TotalChargeAmt2 := TotalChargeAmt2 + ItemJnlLine2.Amount;
        IF SalesHeader."Currency Code" <> '' THEN
          ItemJnlLine2.Amount :=
            CurrExchRate.ExchangeAmtFCYToLCY(
              0, '', //**4PS.n
        //    UseDate,SalesHeader."Currency Code",TotalChargeAmt2 + TotalSalesLine.Amount,SalesHeader."Currency Factor") - //**4PS.o
              UseDate,SalesHeader."Currency Code",TotalChargeAmt2 + TotalSalesLine.Amount,SalesHeader."Currency Factor",TRUE) - //**4PS.n
            TotalChargeAmtLCY2 - TotalSalesLineLCY.Amount
        ELSE
          ItemJnlLine2.Amount := TotalChargeAmt2 - TotalChargeAmtLCY2;

        TotalChargeAmtLCY2 := TotalChargeAmtLCY2 + ItemJnlLine2.Amount;
        ItemJnlLine2."Unit Cost" := ROUND(
            ItemJnlLine2.Amount / ItemJnlLine2."Invoiced Qty. (Base)",GLSetup."Unit-Amount Rounding Precision");
        ItemJnlLine2."Applies-to Entry" := ItemJnlLine2."Item Shpt. Entry No.";

        IF SalesHeader."Currency Code" <> '' THEN
          ItemJnlLine2."Discount Amount" := ROUND(
              CurrExchRate.ExchangeAmtFCYToLCY(
                0, '', //**4PS.n
                UseDate,SalesHeader."Currency Code",
                ItemChargeSalesLine."Inv. Discount Amount" * ItemJnlLine2."Invoiced Qty. (Base)" /
                ItemChargeSalesLine."Quantity (Base)" * "Qty. to Assign" / QtyToInvoice,
              //SalesHeader."Currency Factor"),GLSetup."Amount Rounding Precision") //**4PS.o
                SalesHeader."Currency Factor",TRUE),GLSetup."Amount Rounding Precision") //**4PS.n
        ELSE
          ItemJnlLine2."Discount Amount" := ROUND(
              ItemChargeSalesLine."Inv. Discount Amount" * ItemJnlLine2."Invoiced Qty. (Base)" /
              ItemChargeSalesLine."Quantity (Base)" * "Qty. to Assign" / QtyToInvoice,
              GLSetup."Amount Rounding Precision");

        IF SalesLine.IsCreditDocType THEN
          ItemJnlLine2."Discount Amount" := -ItemJnlLine2."Discount Amount";
        ItemJnlLine2."Shortcut Dimension 1 Code" := ItemChargeSalesLine."Shortcut Dimension 1 Code";
        ItemJnlLine2."Shortcut Dimension 2 Code" := ItemChargeSalesLine."Shortcut Dimension 2 Code";
        ItemJnlLine2."Dimension Set ID" := ItemChargeSalesLine."Dimension Set ID";
        ItemJnlLine2."Gen. Prod. Posting Group" := ItemChargeSalesLine."Gen. Prod. Posting Group";

        ItemJnlLine2."Cost Component" := ItemChargeSalesLine."Cost Component";  //**4PS.n

        OnPostItemChargePerOrderOnAfterCopyToItemJnlLine(
          ItemJnlLine2,ItemChargeSalesLine,GLSetup,QtyToInvoice,TempItemChargeAssgntSales);
      END;

      WITH TempTrackingSpecificationInv DO BEGIN
        RESET;
        SETRANGE("Source Type",DATABASE::"Sales Line");
        SETRANGE("Source ID",TempItemChargeAssgntSales."Applies-to Doc. No.");
        SETRANGE("Source Ref. No.",TempItemChargeAssgntSales."Applies-to Doc. Line No.");
        IF ISEMPTY THEN
          ItemJnlPostLine.RunWithCheck(ItemJnlLine2)
        ELSE BEGIN
          FINDSET;
          NonDistrItemJnlLine := ItemJnlLine2;
          OriginalAmt := NonDistrItemJnlLine.Amount;
          OriginalDiscountAmt := NonDistrItemJnlLine."Discount Amount";
          OriginalQty := NonDistrItemJnlLine."Quantity (Base)";
          IF ("Quantity (Base)" / OriginalQty) > 0 THEN
            SignFactor := 1
          ELSE
            SignFactor := -1;
          REPEAT
            Factor := "Quantity (Base)" / OriginalQty * SignFactor;
            IF ABS("Quantity (Base)") < ABS(NonDistrItemJnlLine."Quantity (Base)") THEN BEGIN
              ItemJnlLine2."Quantity (Base)" := -"Quantity (Base)";
              ItemJnlLine2."Invoiced Qty. (Base)" := ItemJnlLine2."Quantity (Base)";
              ItemJnlLine2.Amount :=
                ROUND(OriginalAmt * Factor,GLSetup."Amount Rounding Precision");
              ItemJnlLine2."Discount Amount" :=
                ROUND(OriginalDiscountAmt * Factor,GLSetup."Amount Rounding Precision");
              ItemJnlLine2."Unit Cost" :=
                ROUND(ItemJnlLine2.Amount / ItemJnlLine2."Invoiced Qty. (Base)",
                  GLSetup."Unit-Amount Rounding Precision") * SignFactor;
              ItemJnlLine2."Item Shpt. Entry No." := "Item Ledger Entry No.";
              ItemJnlLine2."Applies-to Entry" := "Item Ledger Entry No.";
              ItemJnlLine2.CopyTrackingFromSpec(TempTrackingSpecificationInv);
              ItemJnlPostLine.RunWithCheck(ItemJnlLine2);
              ItemJnlLine2."Location Code" := NonDistrItemJnlLine."Location Code";
              NonDistrItemJnlLine."Quantity (Base)" -= ItemJnlLine2."Quantity (Base)";
              NonDistrItemJnlLine.Amount -= ItemJnlLine2.Amount;
              NonDistrItemJnlLine."Discount Amount" -= ItemJnlLine2."Discount Amount";
            END ELSE BEGIN // the last time
              NonDistrItemJnlLine."Quantity (Base)" := -"Quantity (Base)";
              NonDistrItemJnlLine."Invoiced Qty. (Base)" := -"Quantity (Base)";
              NonDistrItemJnlLine."Unit Cost" :=
                ROUND(NonDistrItemJnlLine.Amount / NonDistrItemJnlLine."Invoiced Qty. (Base)",
                  GLSetup."Unit-Amount Rounding Precision");
              NonDistrItemJnlLine."Item Shpt. Entry No." := "Item Ledger Entry No.";
              NonDistrItemJnlLine."Applies-to Entry" := "Item Ledger Entry No.";
              NonDistrItemJnlLine.CopyTrackingFromSpec(TempTrackingSpecificationInv);
              ItemJnlPostLine.RunWithCheck(NonDistrItemJnlLine);
              NonDistrItemJnlLine."Location Code" := ItemJnlLine2."Location Code";
            END;
          UNTIL NEXT = 0;
        END;
      END;
    END;

    LOCAL PROCEDURE PostItemChargePerShpt@5807(SalesHeader@1001 : Record 36;VAR SalesLine@1000 : Record 37);
    VAR
      SalesShptLine@1003 : Record 111;
      TempItemLedgEntry@1010 : TEMPORARY Record 32;
      ItemTrackingMgt@1009 : Codeunit 6500;
      DistributeCharge@1011 : Boolean;
      IsHandled@1002 : Boolean;
    BEGIN
      IF NOT SalesShptLine.GET(
           TempItemChargeAssgntSales."Applies-to Doc. No.",TempItemChargeAssgntSales."Applies-to Doc. Line No.")
      THEN
        ERROR(ShipmentLinesDeletedErr);

      IsHandled := FALSE;
      OnPostItemChargePerShptOnBeforeTestJobNo(SalesShptLine,IsHandled);
      IF NOT IsHandled THEN
        SalesShptLine.TESTFIELD("Job No.",'');

      IF SalesShptLine."Item Shpt. Entry No." <> 0 THEN
        DistributeCharge :=
          CostCalcMgt.SplitItemLedgerEntriesExist(
            TempItemLedgEntry,-SalesShptLine."Quantity (Base)",SalesShptLine."Item Shpt. Entry No.")
      ELSE BEGIN
        DistributeCharge := TRUE;
        IF NOT ItemTrackingMgt.CollectItemEntryRelation(TempItemLedgEntry,
             DATABASE::"Sales Shipment Line",0,SalesShptLine."Document No.",
             '',0,SalesShptLine."Line No.",-SalesShptLine."Quantity (Base)")
        THEN
          ERROR(RelatedItemLedgEntriesNotFoundErr);
      END;

      IF DistributeCharge THEN
        PostDistributeItemCharge(
          SalesHeader,SalesLine,TempItemLedgEntry,SalesShptLine."Quantity (Base)",
          TempItemChargeAssgntSales."Qty. to Assign",TempItemChargeAssgntSales."Amount to Assign")
      ELSE
        PostItemCharge(SalesHeader,SalesLine,
          SalesShptLine."Item Shpt. Entry No.",SalesShptLine."Quantity (Base)",
          TempItemChargeAssgntSales."Amount to Assign",
          TempItemChargeAssgntSales."Qty. to Assign");
    END;

    LOCAL PROCEDURE PostItemChargePerRetRcpt@5810(SalesHeader@1001 : Record 36;VAR SalesLine@1000 : Record 37);
    VAR
      ReturnRcptLine@1002 : Record 6661;
      TempItemLedgEntry@1010 : TEMPORARY Record 32;
      ItemTrackingMgt@1009 : Codeunit 6500;
      DistributeCharge@1011 : Boolean;
      IsHandled@1003 : Boolean;
    BEGIN
      IF NOT ReturnRcptLine.GET(
           TempItemChargeAssgntSales."Applies-to Doc. No.",TempItemChargeAssgntSales."Applies-to Doc. Line No.")
      THEN
        ERROR(ShipmentLinesDeletedErr);

      IsHandled := FALSE;
      OnPostItemChargePerRetRcptOnBeforeTestFieldJobNo(ReturnRcptLine,IsHandled);
      IF NOT IsHandled THEN
        ReturnRcptLine.TESTFIELD("Job No.",'');

      IF ReturnRcptLine."Item Rcpt. Entry No." <> 0 THEN
        DistributeCharge :=
          CostCalcMgt.SplitItemLedgerEntriesExist(
            TempItemLedgEntry,ReturnRcptLine."Quantity (Base)",ReturnRcptLine."Item Rcpt. Entry No.")
      ELSE BEGIN
        DistributeCharge := TRUE;
        IF NOT ItemTrackingMgt.CollectItemEntryRelation(TempItemLedgEntry,
             DATABASE::"Return Receipt Line",0,ReturnRcptLine."Document No.",
             '',0,ReturnRcptLine."Line No.",ReturnRcptLine."Quantity (Base)")
        THEN
          ERROR(RelatedItemLedgEntriesNotFoundErr);
      END;

      IF DistributeCharge THEN
        PostDistributeItemCharge(
          SalesHeader,SalesLine,TempItemLedgEntry,ReturnRcptLine."Quantity (Base)",
          TempItemChargeAssgntSales."Qty. to Assign",TempItemChargeAssgntSales."Amount to Assign")
      ELSE
        PostItemCharge(SalesHeader,SalesLine,
          ReturnRcptLine."Item Rcpt. Entry No.",ReturnRcptLine."Quantity (Base)",
          TempItemChargeAssgntSales."Amount to Assign",
          TempItemChargeAssgntSales."Qty. to Assign")
    END;

    LOCAL PROCEDURE PostDistributeItemCharge@181(SalesHeader@1000 : Record 36;SalesLine@1001 : Record 37;VAR TempItemLedgEntry@1002 : TEMPORARY Record 32;NonDistrQuantity@1003 : Decimal;NonDistrQtyToAssign@1004 : Decimal;NonDistrAmountToAssign@1005 : Decimal);
    VAR
      Factor@1006 : Decimal;
      QtyToAssign@1007 : Decimal;
      AmountToAssign@1008 : Decimal;
    BEGIN
      IF TempItemLedgEntry.FINDSET THEN
        REPEAT
          Factor := ABS(TempItemLedgEntry.Quantity / NonDistrQuantity);
          QtyToAssign := NonDistrQtyToAssign * Factor;
          AmountToAssign := ROUND(NonDistrAmountToAssign * Factor,GLSetup."Amount Rounding Precision");
          IF Factor < 1 THEN BEGIN
            PostItemCharge(SalesHeader,SalesLine,
              TempItemLedgEntry."Entry No.",-TempItemLedgEntry.Quantity,
              AmountToAssign,QtyToAssign);
            NonDistrQuantity := NonDistrQuantity + TempItemLedgEntry.Quantity;
            NonDistrQtyToAssign := NonDistrQtyToAssign - QtyToAssign;
            NonDistrAmountToAssign := NonDistrAmountToAssign - AmountToAssign;
          END ELSE // the last time
            PostItemCharge(SalesHeader,SalesLine,
              TempItemLedgEntry."Entry No.",-TempItemLedgEntry.Quantity,
              NonDistrAmountToAssign,NonDistrQtyToAssign);
        UNTIL TempItemLedgEntry.NEXT = 0
      ELSE
        ERROR(RelatedItemLedgEntriesNotFoundErr);
    END;

    LOCAL PROCEDURE PostAssocItemJnlLine@3(SalesHeader@1002 : Record 36;SalesLine@1003 : Record 37;QtyToBeShipped@1000 : Decimal;QtyToBeShippedBase@1001 : Decimal) : Integer;
    VAR
      ItemJnlLine@1008 : Record 83;
      TempHandlingSpecification2@1005 : TEMPORARY Record 336;
      ItemEntryRelation@1004 : Record 6507;
      PurchOrderHeader@1007 : Record 38;
      PurchOrderLine@1006 : Record 39;
      IsHandled@1009 : Boolean;
    BEGIN
      PurchOrderHeader.GET(
        PurchOrderHeader."Document Type"::Order,SalesLine."Purchase Order No.");
      PurchOrderLine.GET(
        PurchOrderLine."Document Type"::Order,SalesLine."Purchase Order No.",SalesLine."Purch. Order Line No.");

      InitAssocItemJnlLine(ItemJnlLine,PurchOrderHeader,PurchOrderLine,SalesHeader,QtyToBeShipped,QtyToBeShippedBase);

      IsHandled := FALSE;
      OnPostAssocItemJnlLineOnBeforePost(ItemJnlLine,PurchOrderLine,IsHandled);
      IF (PurchOrderLine."Job No." = '') OR IsHandled THEN BEGIN
        TransferReservFromPurchLine(PurchOrderLine,ItemJnlLine,SalesLine,QtyToBeShippedBase);
        OnBeforePostAssocItemJnlLine(ItemJnlLine,PurchOrderLine,SuppressCommit,SalesLine);
        ItemJnlPostLine.RunWithCheck(ItemJnlLine);

        // Handle Item Tracking
        IF ItemJnlPostLine.CollectTrackingSpecification(TempHandlingSpecification2) THEN BEGIN
          IF TempHandlingSpecification2.FINDSET THEN
            REPEAT
              TempTrackingSpecification := TempHandlingSpecification2;
              TempTrackingSpecification.SetSourceFromPurchLine(PurchOrderLine);
              IF TempTrackingSpecification.INSERT THEN;
              ItemEntryRelation.InitFromTrackingSpec(TempHandlingSpecification2);
              ItemEntryRelation.SetSource(DATABASE::"Purch. Rcpt. Line",0,PurchOrderHeader."Receiving No.",PurchOrderLine."Line No.");
              ItemEntryRelation.SetOrderInfo(PurchOrderLine."Document No.",PurchOrderLine."Line No.");
              ItemEntryRelation.INSERT;
            UNTIL TempHandlingSpecification2.NEXT = 0;
          EXIT(0);
        END;
      END;

      EXIT(ItemJnlLine."Item Shpt. Entry No.");
    END;

    LOCAL PROCEDURE InitAssocItemJnlLine@279(VAR ItemJnlLine@1000 : Record 83;PurchOrderHeader@1001 : Record 38;PurchOrderLine@1003 : Record 39;SalesHeader@1002 : Record 36;QtyToBeShipped@1004 : Decimal;QtyToBeShippedBase@1005 : Decimal);
    BEGIN
      OnBeforeInitAssocItemJnlLine(ItemJnlLine,PurchOrderHeader,PurchOrderLine,SalesHeader);

      WITH ItemJnlLine DO BEGIN
        INIT;
        "Entry Type" := "Entry Type"::Purchase;
        CopyDocumentFields(
          "Document Type"::"Purchase Receipt",PurchOrderHeader."Receiving No.",PurchOrderHeader."No.",SrcCode,
          PurchOrderHeader."Posting No. Series");

        CopyFromPurchHeader(PurchOrderHeader);
        "Posting Date" := SalesHeader."Posting Date";
        "Document Date" := SalesHeader."Document Date";
        CopyFromPurchLine(PurchOrderLine);

        Quantity := QtyToBeShipped;
        "Quantity (Base)" := QtyToBeShippedBase;
        "Invoiced Quantity" := 0;
        "Invoiced Qty. (Base)" := 0;
        "Source Currency Code" := SalesHeader."Currency Code";
        Amount := ROUND(PurchOrderLine.Amount * QtyToBeShipped / PurchOrderLine.Quantity);
        "Discount Amount" := PurchOrderLine."Line Discount Amount";

        "Applies-to Entry" := 0;
      END;

      OnAfterInitAssocItemJnlLine(ItemJnlLine,PurchOrderHeader,PurchOrderLine,SalesHeader);
    END;

    LOCAL PROCEDURE ReleaseSalesDocument@19(VAR SalesHeader@1000 : Record 36);
    VAR
      SalesHeaderCopy@1001 : Record 36;
      TempAsmHeader@1005 : TEMPORARY Record 900;
      ReleaseSalesDocument@1006 : Codeunit 414;
      LinesWereModified@1007 : Boolean;
      SavedStatus@1004 : Option;
    BEGIN
      WITH SalesHeader DO BEGIN
        IF NOT (Status = Status::Open) OR (Status = Status::"Pending Prepayment") THEN
          EXIT;

        SalesHeaderCopy := SalesHeader;
        SavedStatus := Status;
        GetOpenLinkedATOs(TempAsmHeader);
        OnBeforeReleaseSalesDoc(SalesHeader);
        LinesWereModified := ReleaseSalesDocument.ReleaseSalesHeader(SalesHeader,PreviewMode);
        IF LinesWereModified THEN
          RefreshTempLines(SalesHeader,TempSalesLineGlobal);
        TESTFIELD(Status,Status::Released);
        Status := SavedStatus;
        RestoreSalesHeader(SalesHeader,SalesHeaderCopy);
        ReopenAsmOrders(TempAsmHeader);
        OnAfterReleaseSalesDoc(SalesHeader);
        IF NOT (PreviewMode OR SuppressCommit) THEN BEGIN
          MODIFY;
          COMMIT;
        END;
        Status := Status::Released;
      END;
    END;

    LOCAL PROCEDURE TestSalesLine@147(SalesHeader@1001 : Record 36;SalesLine@1000 : Record 37);
    VAR
      DummyTrackingSpecification@1002 : Record 336;
      IsHandled@1005 : Boolean;
    BEGIN
      IsHandled := FALSE;
      OnBeforeTestSalesLine(SalesHeader,SalesLine,SuppressCommit,IsHandled);
      IF IsHandled THEN
        EXIT;

      WITH SalesLine DO BEGIN
        CASE Type OF
          Type::Item:
            DummyTrackingSpecification.CheckItemTrackingQuantity(
              DATABASE::"Sales Line","Document Type","Document No.","Line No.",
              "Qty. to Ship (Base)","Qty. to Invoice (Base)",SalesHeader.Ship,SalesHeader.Invoice);
          Type::"Charge (Item)":
            TestSalesLineItemCharge(SalesLine);
          Type::"Fixed Asset":
            TestSalesLineFixedAsset(SalesLine)
          ELSE
            TestSalesLineOthers(SalesLine);
        END;
        TestSalesLineJob(SalesLine);

        IF Type = Type::Item THEN
          DummyTrackingSpecification.CheckItemTrackingQuantity(
            DATABASE::"Sales Line","Document Type","Document No.","Line No.",
            "Qty. to Ship (Base)","Qty. to Invoice (Base)",SalesHeader.Ship,SalesHeader.Invoice);

        CASE "Document Type" OF
          "Document Type"::Order:
            TESTFIELD("Return Qty. to Receive",0);
          "Document Type"::Invoice:
            BEGIN
              //**4PS.sn
              IF NOT (SalesHeader."Sales Document Type" IN
                [SalesHeader."Sales Document Type"::"Sales Logistics Separated",SalesHeader."Sales Document Type"::RentalContract]) THEN
              BEGIN
              //**4PS.en
                IF "Shipment No." = '' THEN
                  TESTFIELD("Qty. to Ship",Quantity);
                TESTFIELD("Return Qty. to Receive",0);
                TESTFIELD("Qty. to Invoice",Quantity);
              END; //**4PS.n
            END;
          "Document Type"::"Return Order":
            TESTFIELD("Qty. to Ship",0);
          "Document Type"::"Credit Memo":
            BEGIN
      //**4PS.so
      //        IF "Return Receipt No." = '' THEN
      //          TESTFIELD("Return Qty. to Receive",Quantity);
      //        TESTFIELD("Qty. to Ship",0);
      //**4PS.eo
              TESTFIELD("Qty. to Invoice",Quantity);
            END;
        END;

        OnAfterTestSalesLine(SalesHeader,SalesLine,WhseShip,WhseReceive,SuppressCommit);
      END;
    END;

    LOCAL PROCEDURE TestSalesLineItemCharge@312(SalesLine@1000 : Record 37);
    VAR
      IsHandled@1001 : Boolean;
    BEGIN
      IsHandled := FALSE;
      OnBeforeTestSalesLineItemCharge(SalesLine,IsHandled);
      IF IsHandled THEN
        EXIT;

      WITH SalesLine DO BEGIN
        TESTFIELD(Amount);
        TESTFIELD("Job No.",'');
        TESTFIELD("Job Contract Entry No.",0);
      END;
    END;

    LOCAL PROCEDURE TestSalesLineFixedAsset@314(SalesLine@1000 : Record 37);
    VAR
      FixedAsset@1001 : Record 5600;
      DeprBook@1002 : Record 5611;
      IsHandled@1003 : Boolean;
    BEGIN
      IsHandled := FALSE;
      OnBeforeTestSalesLineFixedAsset(SalesLine,IsHandled);
      IF IsHandled THEN
        EXIT;

      WITH SalesLine DO BEGIN
        TESTFIELD("Job No.",'');
        TESTFIELD("Depreciation Book Code");
        DeprBook.GET("Depreciation Book Code");
        DeprBook.TESTFIELD("G/L Integration - Disposal",TRUE);
        FixedAsset.GET("No.");
        FixedAsset.TESTFIELD("Budgeted Asset",FALSE);
      END;
    END;

    LOCAL PROCEDURE TestSalesLineJob@311(SalesLine@1002 : Record 37);
    VAR
      IsHandled@1000 : Boolean;
    BEGIN
      IsHandled := FALSE;
      OnBeforeTestSalesLineJob(SalesLine,IsHandled);
      IF IsHandled THEN
        EXIT;

      WITH SalesLine DO
      //**4PS.so No limits for Jobs in other Document Types
      //IF NOT ("Document Type" IN ["Document Type"::Invoice,"Document Type"::"Credit Memo"]) THEN
      //  TESTFIELD("Job No.",'');
      //**4PS.eo
    END;

    LOCAL PROCEDURE TestSalesLineOthers@315(SalesLine@1000 : Record 37);
    VAR
      IsHandled@1001 : Boolean;
    BEGIN
      IsHandled := FALSE;
      OnBeforeTestSalesLineOthers(SalesLine,IsHandled);
      IF IsHandled THEN
        EXIT;

      WITH SalesLine DO BEGIN
        TESTFIELD("Depreciation Book Code",'');
        TESTFIELD("Depr. until FA Posting Date",FALSE);
        TESTFIELD("FA Posting Date",0D);
        TESTFIELD("Duplicate in Depreciation Book",'');
        TESTFIELD("Use Duplication List",FALSE);
      END;
    END;

    LOCAL PROCEDURE TestUpdatedSalesLine@444(SalesHeader@1100525001 : Record 36;SalesLine@1000 : Record 37);
    BEGIN
      WITH SalesLine DO BEGIN
        IF "Drop Shipment" THEN BEGIN
          IF Type <> Type::Item THEN
            TESTFIELD("Drop Shipment",FALSE);
          IF ("Qty. to Ship" <> 0) AND ("Purch. Order Line No." = 0) THEN
            ERROR(DropShipmentErr,"Line No.");
        END;

        IF Quantity = 0 THEN
          TESTFIELD(Amount,0)
        ELSE BEGIN
          TESTFIELD("No.");
          TESTFIELD(Type);
          //**4PS.sn
          IF NOT "Project Invoice" AND NOT "Service Invoice" AND
              NOT SalesHeader."Plant Invoice" AND NOT SalesHeader."Rental Unit Invoice" AND
              ("Job No." = '') AND ("Service Order No." = '') THEN
          BEGIN
          //**4PS.en
            TESTFIELD("Gen. Bus. Posting Group");
            TESTFIELD("Gen. Prod. Posting Group");
          END; //**4PS.n
        END;
      END;
    END;

    LOCAL PROCEDURE UpdatePostingNos@154(VAR SalesHeader@1000 : Record 36) ModifyHeader : Boolean;
    VAR
      NoSeriesMgt@1001 : Codeunit 396;
      IsHandled@1002 : Boolean;
    BEGIN
      OnBeforeUpdatePostingNos(SalesHeader,NoSeriesMgt,SuppressCommit,ModifyHeader);
      WITH SalesHeader DO BEGIN
        IsHandled := FALSE;
        OnBeforeUpdateShippingNo(SalesHeader,WhseShip,WhseReceive,InvtPickPutaway,PreviewMode,ModifyHeader,IsHandled);
        IF NOT IsHandled THEN
          IF Ship AND ("Shipping No." = '') THEN
            IF ("Document Type" = "Document Type"::Order) OR
               (("Document Type" = "Document Type"::Invoice) AND SalesSetup."Shipment on Invoice")
            THEN
              IF NOT PreviewMode THEN BEGIN
                TESTFIELD("Shipping No. Series");
                "Shipping No." := NoSeriesMgt.GetNextNo("Shipping No. Series","Posting Date",TRUE);
                ModifyHeader := TRUE;
              END ELSE
                "Shipping No." := PostingPreviewNoTok;

        IF Receive AND ("Return Receipt No." = '') THEN
          //**4PS.sn
          IF ("Document Type" = "Document Type"::"Return Order") OR
             (("Document Type" = "Document Type"::"Credit Memo") AND SalesSetup."Return Receipt on Credit Memo")
          THEN
          //**4PS.en
            IF NOT PreviewMode THEN BEGIN
              TESTFIELD("Return Receipt No. Series");
              "Return Receipt No." := NoSeriesMgt.GetNextNo("Return Receipt No. Series","Posting Date",TRUE);
              ModifyHeader := TRUE;
            END ELSE
              "Return Receipt No." := PostingPreviewNoTok;

        IsHandled := FALSE;
        OnBeforeUpdatePostingNo(SalesHeader,PreviewMode,ModifyHeader,IsHandled);
        IF NOT IsHandled THEN
          IF Invoice AND ("Posting No." = '') THEN BEGIN
            IF ("No. Series" <> '') OR
               ("Document Type" IN ["Document Type"::Order,"Document Type"::"Return Order"])
            THEN
              TESTFIELD("Posting No. Series");
            IF ("No. Series" <> "Posting No. Series") OR
               ("Document Type" IN ["Document Type"::Order,"Document Type"::"Return Order"])
            THEN BEGIN
              IF NOT PreviewMode THEN BEGIN
                "Posting No." := NoSeriesMgt.GetNextNo("Posting No. Series","Posting Date",TRUE);
                ModifyHeader := TRUE;
              END ELSE
                "Posting No." := PostingPreviewNoTok;
            END;
          END;
      END;

      OnAfterUpdatePostingNos(SalesHeader,NoSeriesMgt,SuppressCommit);
    END;

    LOCAL PROCEDURE UpdateAssocOrder@4(VAR TempDropShptPostBuffer@1001 : TEMPORARY Record 223);
    VAR
      PurchOrderHeader@1003 : Record 38;
      PurchOrderLine@1002 : Record 39;
      ReservePurchLine@1000 : Codeunit 99000834;
    BEGIN
      TempDropShptPostBuffer.RESET;
      IF TempDropShptPostBuffer.ISEMPTY THEN
        EXIT;
      CLEAR(PurchOrderHeader);
      TempDropShptPostBuffer.FINDSET;
      REPEAT
        IF PurchOrderHeader."No." <> TempDropShptPostBuffer."Order No." THEN BEGIN
          PurchOrderHeader.GET(PurchOrderHeader."Document Type"::Order,TempDropShptPostBuffer."Order No.");
          PurchOrderHeader."Last Receiving No." := PurchOrderHeader."Receiving No.";
          PurchOrderHeader."Receiving No." := '';
          PurchOrderHeader.MODIFY;
          ReservePurchLine.UpdateItemTrackingAfterPosting(PurchOrderHeader);
        END;
        PurchOrderLine.GET(
          PurchOrderLine."Document Type"::Order,
          TempDropShptPostBuffer."Order No.",TempDropShptPostBuffer."Order Line No.");
        PurchOrderLine."Quantity Received" := PurchOrderLine."Quantity Received" + TempDropShptPostBuffer.Quantity;
        PurchOrderLine."Qty. Received (Base)" := PurchOrderLine."Qty. Received (Base)" + TempDropShptPostBuffer."Quantity (Base)";
        PurchOrderLine.InitOutstanding;
        PurchOrderLine.ClearQtyIfBlank;
        PurchOrderLine.InitQtyToReceive;
        OnUpdateAssocOrderOnBeforeModifyPurchLine(PurchOrderLine,TempDropShptPostBuffer);
        //**4PS.sn
        PurchOrderLine."Modified by" := USERID; //DP00469
        PurchOrderLine."Last Date Modified" := TODAY;//DP00469
        //**4PS.en
        PurchOrderLine.MODIFY;
        OnUpdateAssocOrderOnAfterModifyPurchLine(PurchOrderLine,TempDropShptPostBuffer);
      UNTIL TempDropShptPostBuffer.NEXT = 0;
      TempDropShptPostBuffer.DELETEALL;
    END;

    LOCAL PROCEDURE UpdateAssocLines@5(VAR SalesOrderLine@1000 : Record 37);
    VAR
      PurchOrderLine@1001 : Record 39;
      IsHandled@1002 : Boolean;
    BEGIN
      IsHandled := FALSE;
      OnBeforeUpdateAssocLines(SalesOrderLine,IsHandled);
      IF IsHandled THEN
        EXIT;

      PurchOrderLine.GET(
        PurchOrderLine."Document Type"::Order,
        SalesOrderLine."Purchase Order No.",SalesOrderLine."Purch. Order Line No.");
      PurchOrderLine."Sales Order No." := '';
      PurchOrderLine."Sales Order Line No." := 0;
      //**4PS.sn
      PurchOrderLine."Modified by" := USERID; //DP00469
      PurchOrderLine."Last Date Modified" := TODAY;//DP00469
      //**4PS.en
      PurchOrderLine.MODIFY;
      SalesOrderLine."Purchase Order No." := '';
      SalesOrderLine."Purch. Order Line No." := 0;
    END;

    LOCAL PROCEDURE UpdateAssosOrderPostingNos@157(SalesHeader@1000 : Record 36) DropShipment : Boolean;
    VAR
      TempSalesLine@1001 : TEMPORARY Record 37;
      PurchOrderHeader@1005 : Record 38;
      NoSeriesMgt@1002 : Codeunit 396;
      ReleasePurchaseDocument@1003 : Codeunit 415;
    BEGIN
      WITH SalesHeader DO BEGIN
        ResetTempLines(TempSalesLine);
        TempSalesLine.SETFILTER("Purch. Order Line No.",'<>0');
        DropShipment := NOT TempSalesLine.ISEMPTY;

        TempSalesLine.SETFILTER("Qty. to Ship",'<>0');
        IF DropShipment AND Ship THEN
          IF TempSalesLine.FINDSET THEN
            REPEAT
              IF PurchOrderHeader."No." <> TempSalesLine."Purchase Order No." THEN BEGIN
                PurchOrderHeader.GET(PurchOrderHeader."Document Type"::Order,TempSalesLine."Purchase Order No.");
                PurchOrderHeader.TESTFIELD("Pay-to Vendor No.");
                PurchOrderHeader.Receive := TRUE;
                ReleasePurchaseDocument.ReleasePurchaseHeader(PurchOrderHeader,PreviewMode);
                IF PurchOrderHeader."Receiving No." = '' THEN BEGIN
                  PurchOrderHeader.TESTFIELD("Receiving No. Series");
                  PurchOrderHeader."Receiving No." :=
                    NoSeriesMgt.GetNextNo(PurchOrderHeader."Receiving No. Series","Posting Date",TRUE);
                  PurchOrderHeader.MODIFY;
                END;
              END;
            UNTIL TempSalesLine.NEXT = 0;

        EXIT(DropShipment);
      END;
    END;

    LOCAL PROCEDURE UpdateAfterPosting@155(SalesHeader@1001 : Record 36);
    VAR
      TempSalesLine@1000 : TEMPORARY Record 37;
    BEGIN
      WITH TempSalesLine DO BEGIN
        ResetTempLines(TempSalesLine);
        SETFILTER("Qty. to Assemble to Order",'<>0');
        IF FINDSET THEN
          REPEAT
            FinalizePostATO(TempSalesLine);
          UNTIL NEXT = 0;

        ResetTempLines(TempSalesLine);
        SETFILTER("Blanket Order Line No.",'<>0');
        IF FINDSET THEN
          REPEAT
            UpdateBlanketOrderLine(TempSalesLine,SalesHeader.Ship,SalesHeader.Receive,SalesHeader.Invoice);
          UNTIL NEXT = 0;
      END;

      OnAfterUpdateAfterPosting(SalesHeader,TempSalesLine);
    END;

    LOCAL PROCEDURE UpdateLastPostingNos@167(VAR SalesHeader@1000 : Record 36);
    BEGIN
      WITH SalesHeader DO BEGIN
        IF Ship THEN BEGIN
          "Last Shipping No." := "Shipping No.";
          "Shipping No." := '';
        END;
        IF Invoice THEN BEGIN
          "Last Posting No." := "Posting No.";
          "Posting No." := '';
        END;
        IF Receive THEN BEGIN
          "Last Return Receipt No." := "Return Receipt No.";
          "Return Receipt No." := '';
        END;
      END;
    END;

    LOCAL PROCEDURE UpdateSalesLineBeforePost@137(SalesHeader@1000 : Record 36;VAR SalesLine@1001 : Record 37);
    BEGIN
      OnBeforeUpdateSalesLineBeforePost(SalesLine,SalesHeader,WhseShip,WhseReceive,RoundingLineInserted,SuppressCommit);

      WITH SalesLine DO BEGIN
        IF NOT (SalesHeader.Ship OR RoundingLineInserted) THEN BEGIN
          "Qty. to Ship" := 0;
          "Qty. to Ship (Base)" := 0;
        END;
        IF NOT (SalesHeader.Receive OR RoundingLineInserted) THEN BEGIN
          "Return Qty. to Receive" := 0;
          "Return Qty. to Receive (Base)" := 0;
        END;

        JobContractLine := FALSE;
        IF (Type = Type::Item) OR (Type = Type::"G/L Account") OR (Type = Type::" ") THEN
          IF "Job Contract Entry No." > 0 THEN
            PostJobContractLine(SalesHeader,SalesLine);
        IF Type = Type::Resource THEN
          JobTaskSalesLine := SalesLine;

        IF (SalesHeader."Document Type" = SalesHeader."Document Type"::Invoice) AND ("Shipment No." <> '') THEN BEGIN
          "Quantity Shipped" := Quantity;
          "Qty. Shipped (Base)" := "Quantity (Base)";
          "Qty. to Ship" := 0;
          "Qty. to Ship (Base)" := 0;
        END;

        IF (SalesHeader."Document Type" = SalesHeader."Document Type"::"Credit Memo") AND ("Return Receipt No." <> '') THEN BEGIN
          "Return Qty. Received" := Quantity;
          "Return Qty. Received (Base)" := "Quantity (Base)";
          "Return Qty. to Receive" := 0;
          "Return Qty. to Receive (Base)" := 0;
        END;

        IF SalesHeader.Invoice THEN BEGIN
          IF "Document Type" <> "Document Type"::"Credit Memo" THEN //**4PS.n
            IF ABS("Qty. to Invoice") > ABS(MaxQtyToInvoice) THEN
              InitQtyToInvoice;
        END ELSE BEGIN
          "Qty. to Invoice" := 0;
          "Qty. to Invoice (Base)" := 0;
        END;

        IF (Type = Type::Item) AND ("No." <> '') THEN BEGIN
          GetItem(SalesLine);
          IF (Item."Costing Method" = Item."Costing Method"::Standard) AND NOT IsShipment THEN
            GetUnitCost;
        END;
      END;

      OnAfterUpdateSalesLineBeforePost(SalesLine,SalesHeader,WhseShip,WhseReceive,SuppressCommit);
    END;

    LOCAL PROCEDURE UpdateWhseDocuments@163(SalesHeader@1000 : Record 36);
    BEGIN
      IF WhseReceive THEN BEGIN
        WhsePostRcpt.PostUpdateWhseDocuments(WhseRcptHeader);
        TempWhseRcptHeader.DELETE;
      END;
      IF WhseShip THEN BEGIN
        WhsePostShpt.PostUpdateWhseDocuments(WhseShptHeader);
        TempWhseShptHeader.DELETE;
      END;

      OnAfterUpdateWhseDocuments(SalesHeader,WhseShip,WhseReceive,WhseShptHeader,WhseRcptHeader);
    END;

    LOCAL PROCEDURE DeleteAfterPosting@159(VAR SalesHeader@1000 : Record 36);
    VAR
      SalesCommentLine@1001 : Record 44;
      SalesLine@1003 : Record 37;
      TempSalesLine@1004 : TEMPORARY Record 37;
      WarehouseRequest@1002 : Record 5765;
      CustInvoiceDisc@1005 : Record 19;
      SkipDelete@1006 : Boolean;
      SalesOfferAmount@1100525000 : Record 11012786;
      SalesHeaderExtension@1100525001 : Record 11071868;
      ProjInstalmRec@1100285100 : Record 11012018;
      AmountToInvoice@1100285101 : Decimal;
    BEGIN
      OnBeforeDeleteAfterPosting(SalesHeader,SalesInvHeader,SalesCrMemoHeader,SkipDelete,SuppressCommit);
      IF SkipDelete THEN
        EXIT;

      WITH SalesHeader DO BEGIN
        IF HASLINKS THEN
          DELETELINKS;
        DELETE;
        ReserveSalesLine.DeleteInvoiceSpecFromHeader(SalesHeader);
        DeleteATOLinks(SalesHeader);
        ResetTempLines(TempSalesLine);
        IF TempSalesLine.FINDFIRST THEN
          REPEAT
            IF TempSalesLine."Deferral Code" <> '' THEN
              DeferralUtilities.RemoveOrSetDeferralSchedule(
                '',DeferralUtilities.GetSalesDeferralDocType,'','',TempSalesLine."Document Type",
                TempSalesLine."Document No.",TempSalesLine."Line No.",0,0D,TempSalesLine.Description,'',TRUE);
            IF TempSalesLine.HASLINKS THEN
              TempSalesLine.DELETELINKS;
          UNTIL TempSalesLine.NEXT = 0;

        //>>170829,pure275173
        IF "Installment Invoice" AND ("Document Type" <> "Document Type"::Invoice) THEN BEGIN
          SalesLine.SETRANGE("Document Type","Document Type");
          SalesLine.SETRANGE("Document No.","No.");
          SalesLine.SETRANGE("Copy of Document",TRUE);//pure277047
          IF SalesLine.FINDSET THEN REPEAT
            IF ProjInstalmRec.GET(SalesLine."Job No.",SalesLine."Sell-to Customer No.",SalesLine."Plot No.",SalesLine."Installment No.") THEN BEGIN
              ProjInstalmRec.SetSuspendAmountCheck;
              AmountToInvoice := ProjInstalmRec."Amount to Invoice" + (SalesLine.Amount - SalesLine."Withheld Amount");
              ProjInstalmRec.VALIDATE("Amount to Invoice", AmountToInvoice);
              IF (ProjInstalmRec.Points > 0) AND (ProjInstalmRec."Installment Amount" <> 0) THEN
                ProjInstalmRec."Points to be invoiced" := ROUND(ProjInstalmRec."Invoice Price" / ProjInstalmRec."Installment Amount" * ProjInstalmRec.Points , 1);
              ProjInstalmRec.MODIFY;
            END;
          UNTIL SalesLine.NEXT  = 0;
          SalesLine.SETRANGE("Copy of Document");//pure277047
        END;
        //<<170829

        SalesLine.SETRANGE("Document Type","Document Type");
        SalesLine.SETRANGE("Document No.","No.");
        OnBeforeSalesLineDeleteAll(SalesLine,SuppressCommit);
        SalesLine.DELETEALL;
        IF IdentityManagement.IsInvAppId AND CustInvoiceDisc.GET("Invoice Disc. Code") THEN
          CustInvoiceDisc.DELETE; // Cleanup of autogenerated cust. invoice discounts

        DeleteItemChargeAssgnt(SalesHeader);
        SalesCommentLine.DeleteComments("Document Type","No.");
        WarehouseRequest.DeleteRequest(DATABASE::"Sales Line","Document Type","No.");

        //**4PS.sn
        IF ("Document Type" IN ["Document Type"::Invoice, "Document Type"::"Credit Memo"]) AND
           ("Sales Document Type" = "Sales Document Type"::"Sales Logistics Separated")
        THEN
          IF SalesOfferAmount.GET("Document Type", "No.", 0) THEN
            SalesOfferAmount.DELETE;

        SalesHeaderExtension.RESET;
        SalesHeaderExtension.SETRANGE("Document Type", "Document Type");
        SalesHeaderExtension.SETRANGE("Document No.", "No.");
        SalesHeaderExtension.DELETEALL;
        //**4PS.en
      END;

      OnAfterDeleteAfterPosting(SalesHeader,SalesInvHeader,SalesCrMemoHeader,SuppressCommit);
    END;

    LOCAL PROCEDURE FinalizePosting@156(VAR SalesHeader@1000 : Record 36;EverythingInvoiced@1001 : Boolean;VAR TempDropShptPostBuffer@1002 : TEMPORARY Record 223);
    VAR
      TempSalesLine@1005 : TEMPORARY Record 37;
      GenJnlPostPreview@1006 : Codeunit 19;
      ICInboxOutboxMgt@1003 : Codeunit 427;
      WhseSalesRelease@1004 : Codeunit 5771;
      ArchiveManagement@1007 : Codeunit 5063;
      IsHandled@1008 : Boolean;
      DocumentLinkManagement@1100525002 : Codeunit 11012401;
      SourceLink@1100525001 : RecordRef;
      TargetLink@1100525000 : RecordRef;
    BEGIN
      OnBeforeFinalizePosting(SalesHeader,TempSalesLineGlobal,EverythingInvoiced,SuppressCommit,GenJnlPostLine);

      WITH SalesHeader DO BEGIN
        IF ("Document Type" IN ["Document Type"::Order,"Document Type"::"Return Order"]) AND
         //(NOT EverythingInvoiced)  //**4PS.o
           ((NOT EverythingInvoiced) OR (EverythingInvoiced AND StandardSalesOrder(SalesHeader) ))  //**4PS.n
        THEN BEGIN
          //**4PS.sn
          IF EverythingInvoiced AND StandardSalesOrder(SalesHeader) THEN
            Status := Status::Closed;
          //**4PS.en
          MODIFY;
          InsertTrackingSpecification(SalesHeader);
          PostUpdateOrderLine(SalesHeader);
          UpdateAssocOrder(TempDropShptPostBuffer);
          UpdateWhseDocuments(SalesHeader);
          WhseSalesRelease.Release(SalesHeader);
          UpdateItemChargeAssgnt;
        END ELSE BEGIN
          CASE "Document Type" OF
            "Document Type"::Invoice:
              BEGIN
                PostUpdateInvoiceLine;
                InsertTrackingSpecification(SalesHeader);
              END;
            "Document Type"::"Credit Memo":
              BEGIN
                PostUpdateReturnReceiptLine;
                InsertTrackingSpecification(SalesHeader);
              END;
            ELSE BEGIN
              UpdateAssocOrder(TempDropShptPostBuffer);
              IF DropShipOrder THEN
                InsertTrackingSpecification(SalesHeader);

              ResetTempLines(TempSalesLine);
              TempSalesLine.SETFILTER("Purch. Order Line No.",'<>0');
              IF TempSalesLine.FINDSET THEN
                REPEAT
                  UpdateAssocLines(TempSalesLine);
                  TempSalesLine.MODIFY;
                UNTIL TempSalesLine.NEXT = 0;

              ResetTempLines(TempSalesLine);
              TempSalesLine.SETFILTER("Prepayment %",'<>0');
              IF TempSalesLine.FINDSET THEN
                REPEAT
                  DecrementPrepmtAmtInvLCY(
                    TempSalesLine,TempSalesLine."Prepmt. Amount Inv. (LCY)",TempSalesLine."Prepmt. VAT Amount Inv. (LCY)");
                  TempSalesLine.MODIFY;
                UNTIL TempSalesLine.NEXT = 0;
            END;
          END;
          UpdateAfterPosting(SalesHeader);
          UpdateEmailParameters(SalesHeader);
          UpdateWhseDocuments(SalesHeader);
          ArchiveManagement.AutoArchiveSalesDocument(SalesHeader);
          ApprovalsMgmt.DeleteApprovalEntries(RECORDID);
          IF NOT PreviewMode THEN
            DeleteAfterPosting(SalesHeader);
        END;

        //**4PS.sn
        IF ReplaceDocLink THEN BEGIN
          SourceLink.GETTABLE(SalesHeader);
          IF "Document Type" IN ["Document Type"::Order, "Document Type"::Invoice] THEN
            TargetLink.GETTABLE(SalesInvHeader)
          ELSE
            TargetLink.GETTABLE(SalesCrMemoHeader);
          IF "Document Type" = "Document Type"::Order THEN
            DocumentLinkManagement.CopyDocLinks(SourceLink, TargetLink)
          ELSE
            DocumentLinkManagement.ReplaceDocLink(SourceLink, TargetLink);
          DocumentLinkManagement.ReplaceDocRelation(SourceLink, TargetLink);
        END;

        IF InvoiceOrderNotPostedInvoice THEN
          ProcInsertNotPostSalesInvLines(SalesHeader);
        //**4PS.en

        InsertValueEntryRelation;

        OnAfterFinalizePostingOnBeforeCommit(
          SalesHeader,SalesShptHeader,SalesInvHeader,SalesCrMemoHeader,ReturnRcptHeader,GenJnlPostLine,SuppressCommit,PreviewMode);

        IF PreviewMode THEN BEGIN
          Window.CLOSE;
          GenJnlPostPreview.ThrowError;
        END;
        IF NOT (InvtPickPutaway OR SuppressCommit) THEN
          COMMIT;

        Window.CLOSE;

        IsHandled := FALSE;
        OnFinalizePostingOnBeforeCreateOutboxSalesTrans(SalesHeader,IsHandled);
        IF NOT IsHandled THEN
          IF Invoice AND ("Bill-to IC Partner Code" <> '') THEN
            IF "Document Type" IN ["Document Type"::Order,"Document Type"::Invoice] THEN
              ICInboxOutboxMgt.CreateOutboxSalesInvTrans(SalesInvHeader)
            ELSE
              ICInboxOutboxMgt.CreateOutboxSalesCrMemoTrans(SalesCrMemoHeader);

        AddPDFDocumentQueue(SalesHeader); //**4PS.n

        OnAfterFinalizePosting(
          SalesHeader,SalesShptHeader,SalesInvHeader,SalesCrMemoHeader,ReturnRcptHeader,
          GenJnlPostLine,SuppressCommit,PreviewMode);

        ClearPostBuffers;
      END;
    END;

    LOCAL PROCEDURE FillInvoicePostingBuffer@5804(SalesHeader@1011 : Record 36;SalesLine@1000 : Record 37;SalesLineACY@1001 : Record 37;VAR TempInvoicePostBuffer@1013 : TEMPORARY Record 49;VAR InvoicePostBuffer@1012 : Record 49);
    VAR
      GenPostingSetup@1006 : Record 252;
      TotalVAT@1005 : Decimal;
      TotalVATACY@1004 : Decimal;
      TotalAmount@1003 : Decimal;
      TotalAmountACY@1002 : Decimal;
      AmtToDefer@1007 : Decimal;
      AmtToDeferACY@1008 : Decimal;
      TotalVATBase@1015 : Decimal;
      TotalVATBaseACY@1014 : Decimal;
      DeferralAccount@1009 : Code[20];
      SalesAccount@1010 : Code[20];
    BEGIN
      GenPostingSetup.GET(SalesLine."Gen. Bus. Posting Group",SalesLine."Gen. Prod. Posting Group");

      InvoicePostBuffer.PrepareSales(SalesLine);

      //**4PS.sn
      IF ChargeSOToJobPlantLoc(SalesHeader) THEN
        InvoicePostBuffer."Service Order No." := '';

      InvoicePostBuffer.Description := SalesLineACY.Description;
      InvoicePostBuffer."Description 2" := SalesLineACY."Description 2";
      IF CheckSalesLineBuyBackItemPO(SalesLine) THEN
        InvoicePostBuffer."Buy-Back Item (Plant Order)" := TRUE;
      //**4PS.en

      TotalVAT := SalesLine."Amount Including VAT" - SalesLine.Amount;
      TotalVATACY := SalesLineACY."Amount Including VAT" - SalesLineACY.Amount;
      TotalAmount := SalesLine.Amount;
      TotalAmountACY := SalesLineACY.Amount;
      TotalVATBase := SalesLine."VAT Base Amount";
      TotalVATBaseACY := SalesLineACY."VAT Base Amount";

      OnAfterInvoicePostingBufferAssignAmounts(SalesLine,TotalAmount,TotalAmountACY);

      IF SalesLine."Deferral Code" <> '' THEN
        GetAmountsForDeferral(SalesLine,AmtToDefer,AmtToDeferACY,DeferralAccount)
      ELSE BEGIN
        AmtToDefer := 0;
        AmtToDeferACY := 0;
        DeferralAccount := '';
      END;

      IF SalesSetup."Discount Posting" IN
         [SalesSetup."Discount Posting"::"Invoice Discounts",SalesSetup."Discount Posting"::"All Discounts"]
      THEN BEGIN
        CalcInvoiceDiscountPosting(SalesHeader,SalesLine,SalesLineACY,InvoicePostBuffer);
        IF (InvoicePostBuffer.Amount <> 0) OR (InvoicePostBuffer."Amount (ACY)" <> 0) THEN BEGIN
          InvoicePostBuffer.SetAccount(
            GenPostingSetup.GetSalesInvDiscAccount,TotalVAT,TotalVATACY,TotalAmount,TotalAmountACY);
          InvoicePostBuffer.UpdateVATBase(TotalVATBase,TotalVATBaseACY);
          UpdateInvoicePostBuffer(TempInvoicePostBuffer,InvoicePostBuffer,TRUE);
        END;
      END;

      IF SalesSetup."Discount Posting" IN
         [SalesSetup."Discount Posting"::"Line Discounts",SalesSetup."Discount Posting"::"All Discounts"]
      THEN BEGIN
        CalcLineDiscountPosting(SalesHeader,SalesLine,SalesLineACY,InvoicePostBuffer);
        IF (InvoicePostBuffer.Amount <> 0) OR (InvoicePostBuffer."Amount (ACY)" <> 0) THEN BEGIN
          InvoicePostBuffer.SetAccount(
            GenPostingSetup.GetSalesLineDiscAccount,TotalVAT,TotalVATACY,TotalAmount,TotalAmountACY);
          InvoicePostBuffer.UpdateVATBase(TotalVATBase,TotalVATBaseACY);
          UpdateInvoicePostBuffer(TempInvoicePostBuffer,InvoicePostBuffer,TRUE);
        END;
      END;

      OnFillInvoicePostingBufferOnBeforeDeferrals(SalesLine,TotalAmount,TotalAmountACY,UseDate);
      DeferralUtilities.AdjustTotalAmountForDeferralsNoBase(
        SalesLine."Deferral Code",AmtToDefer,AmtToDeferACY,TotalAmount,TotalAmountACY);

      OnBeforeInvoicePostingBufferSetAmounts(
        SalesLine,TempInvoicePostBuffer,InvoicePostBuffer,
        TotalVAT,TotalVATACY,TotalAmount,TotalAmountACY,TotalVATBase,TotalVATBaseACY);

      InvoicePostBuffer.SetAmounts(
        TotalVAT,TotalVATACY,TotalAmount,TotalAmountACY,SalesLine."VAT Difference",TotalVATBase,TotalVATBaseACY);

      OnAfterInvoicePostingBufferSetAmounts(InvoicePostBuffer,SalesLine);

      IF (SalesLine.Type = SalesLine.Type::"G/L Account") OR (SalesLine.Type = SalesLine.Type::"Fixed Asset") THEN
        SalesAccount := SalesLine."No."
      ELSE
        IF SalesLine.IsCreditDocType THEN
          SalesAccount := GenPostingSetup.GetSalesCrMemoAccount
        ELSE
          SalesAccount := GenPostingSetup.GetSalesAccount;

      InvoicePostBuffer.SetAccount(SalesAccount,TotalVAT,TotalVATACY,TotalAmount,TotalAmountACY);
      InvoicePostBuffer.UpdateVATBase(TotalVATBase,TotalVATBaseACY);

      InvoicePostBuffer."Auto. Acc. Group" := SalesLine."Auto. Acc. Group";  //NAVSE

      //**4PS.sn
      IF ChargeJobOrderToPlant(SalesHeader) OR ChargeSOToJobPlantLoc(SalesHeader) OR ChargeSOToPlantItem(SalesHeader) THEN BEGIN //DP00195
        InvoicePostBuffer.Amount := -InvoicePostBuffer.Amount;
        InvoicePostBuffer."VAT Base Amount" := -InvoicePostBuffer."VAT Base Amount";
        InvoicePostBuffer."VAT Amount" := -InvoicePostBuffer."VAT Amount";
        InvoicePostBuffer."Amount (ACY)" := -InvoicePostBuffer."Amount (ACY)";
      END;
      //**4PS.en
      InvoicePostBuffer."Auto. Acc. Group" := SalesLine."Auto. Acc. Group";  //NAVSE

      InvoicePostBuffer."Deferral Code" := SalesLine."Deferral Code";
      OnAfterFillInvoicePostBuffer(InvoicePostBuffer,SalesLine,TempInvoicePostBuffer,SuppressCommit);
      UpdateInvoicePostBuffer(TempInvoicePostBuffer,InvoicePostBuffer,FALSE);

      OnFillInvoicePostingBufferOnAfterUpdateInvoicePostBuffer(SalesHeader,SalesLine,InvoicePostBuffer,TempInvoicePostBuffer);

      IF SalesLine."Deferral Code" <> '' THEN BEGIN
        OnBeforeFillDeferralPostingBuffer(
          SalesLine,InvoicePostBuffer,TempInvoicePostBuffer,UseDate,InvDefLineNo,DeferralLineNo,SuppressCommit);
        FillDeferralPostingBuffer(SalesHeader,SalesLine,InvoicePostBuffer,AmtToDefer,AmtToDeferACY,DeferralAccount,SalesAccount);
        OnAfterFillDeferralPostingBuffer(
          SalesLine,InvoicePostBuffer,TempInvoicePostBuffer,UseDate,InvDefLineNo,DeferralLineNo,SuppressCommit);
      END;
    END;

    LOCAL PROCEDURE UpdateInvoicePostBuffer@6(VAR TempInvoicePostBuffer@1004 : TEMPORARY Record 49;InvoicePostBuffer@1003 : Record 49;ForceGLAccountType@1000 : Boolean);
    VAR
      RestoreFAType@1002 : Boolean;
    BEGIN
      IF InvoicePostBuffer.Type = InvoicePostBuffer.Type::"Fixed Asset" THEN BEGIN
        FALineNo := FALineNo + 1;
        InvoicePostBuffer."Fixed Asset Line No." := FALineNo;
        IF ForceGLAccountType THEN BEGIN
          RestoreFAType := TRUE;
          InvoicePostBuffer.Type := InvoicePostBuffer.Type::"G/L Account";
        END;
      END;

      TempInvoicePostBuffer.Update(InvoicePostBuffer,InvDefLineNo,DeferralLineNo);

      IF RestoreFAType THEN
        TempInvoicePostBuffer.Type := TempInvoicePostBuffer.Type::"Fixed Asset";
    END;

    LOCAL PROCEDURE InsertPrepmtAdjInvPostingBuf@80(SalesHeader@1003 : Record 36;PrepmtSalesLine@1000 : Record 37;VAR TempInvoicePostBuffer@1005 : TEMPORARY Record 49;InvoicePostBuffer@1004 : Record 49);
    VAR
      SalesPostPrepayments@1002 : Codeunit 442;
      AdjAmount@1001 : Decimal;
    BEGIN
      WITH PrepmtSalesLine DO
        IF "Prepayment Line" THEN
          IF "Prepmt. Amount Inv. (LCY)" <> 0 THEN BEGIN
            AdjAmount := -"Prepmt. Amount Inv. (LCY)";
            InvoicePostBuffer.FillPrepmtAdjBuffer(TempInvoicePostBuffer,InvoicePostBuffer,
              "No.",AdjAmount,SalesHeader."Currency Code" = '');
            InvoicePostBuffer.FillPrepmtAdjBuffer(TempInvoicePostBuffer,InvoicePostBuffer,
              SalesPostPrepayments.GetCorrBalAccNo(SalesHeader,AdjAmount > 0),
              -AdjAmount,SalesHeader."Currency Code" = '');
          END ELSE
            IF ("Prepayment %" = 100) AND ("Prepmt. VAT Amount Inv. (LCY)" <> 0) THEN
              InvoicePostBuffer.FillPrepmtAdjBuffer(TempInvoicePostBuffer,InvoicePostBuffer,
                SalesPostPrepayments.GetInvRoundingAccNo(SalesHeader."Customer Posting Group"),
                "Prepmt. VAT Amount Inv. (LCY)",SalesHeader."Currency Code" = '');
    END;

    LOCAL PROCEDURE GetCurrency@17(CurrencyCode@1000 : Code[10]);
    BEGIN
      IF CurrencyCode = '' THEN
        Currency.InitRoundingPrecision
      ELSE BEGIN
        Currency.GET(CurrencyCode);
        Currency.TESTFIELD("Amount Rounding Precision");
      END;
    END;

    LOCAL PROCEDURE DivideAmount@8(SalesHeader@1004 : Record 36;VAR SalesLine@1005 : Record 37;QtyType@1000 : 'General,Invoicing,Shipping';SalesLineQty@1001 : Decimal;VAR TempVATAmountLine@1002 : TEMPORARY Record 290;VAR TempVATAmountLineRemainder@1003 : TEMPORARY Record 290);
    VAR
      OriginalDeferralAmount@1006 : Decimal;
    BEGIN
      IF RoundingLineInserted AND (RoundingLineNo = SalesLine."Line No.") THEN
        EXIT;

      OnBeforeDivideAmount(SalesHeader,SalesLine,QtyType,SalesLineQty,TempVATAmountLine,TempVATAmountLineRemainder);

      WITH SalesLine DO
      //IF (SalesLineQty = 0) OR ("Unit Price" = 0) THEN BEGIN //**4PS.o
      //**4PS.sn
        IF (SalesLineQty = 0) OR ("Unit Price" = 0) OR
           ((SalesHeader."Document Type" = SalesHeader."Document Type"::Quote) AND
            (SalesHeader."Sales Document Type" = SalesHeader."Sales Document Type"::"Sales Logistics Separated") AND
            ("Alternative No." <> SalesHeader."Elected Alternative No.")) THEN
        BEGIN
      //**4PS.en
          "Line Amount" := 0;
          "Line Discount Amount" := 0;
          "Inv. Discount Amount" := 0;
          "VAT Base Amount" := 0;
          Amount := 0;
          "Amount Including VAT" := 0;
        END ELSE BEGIN
          OriginalDeferralAmount := GetDeferralAmount;
        //TempVATAmountLine.GET("VAT Identifier","VAT Calculation Type","Tax Group Code",FALSE,"Line Amount" >= 0); //**4PS.o
          TempVATAmountLine.GET("VAT Identifier","VAT Calculation Type","Tax Group Code",FALSE,FALSE); //**4PS.n
          IF "VAT Calculation Type" = "VAT Calculation Type"::"Sales Tax" THEN
            "VAT %" := TempVATAmountLine."VAT %";
          TempVATAmountLineRemainder := TempVATAmountLine;
          IF NOT TempVATAmountLineRemainder.FIND THEN BEGIN
            TempVATAmountLineRemainder.INIT;
            TempVATAmountLineRemainder.INSERT;
          END;
          //**4PS.sn
          IF ((SalesHeader."Document Type" = SalesHeader."Document Type"::Quote) AND
              (SalesHeader."Sales Document Type" = SalesHeader."Sales Document Type"::"Sales Logistics Separated") AND
              ("Alternative No." <> SalesHeader."Elected Alternative No.") OR SalesLine.Optional)
          THEN
            "Line Amount" := 0
          ELSE
          //**4PS.en
            "Line Amount" := GetLineAmountToHandleInclPrepmt(SalesLineQty) + GetPrepmtDiffToLineAmount(SalesLine);
          "Line Amount" := "Line Amount" - RetentionAmount(0); //**4PS.n
          IF SalesLineQty <> Quantity THEN
            "Line Discount Amount" :=
              ROUND("Line Discount Amount" * SalesLineQty / Quantity,Currency."Amount Rounding Precision");

          IF "Allow Invoice Disc." AND (TempVATAmountLine."Inv. Disc. Base Amount" <> 0) THEN
            IF QtyType = QtyType::Invoicing THEN
              "Inv. Discount Amount" := "Inv. Disc. Amount to Invoice"
            ELSE BEGIN
              TempVATAmountLineRemainder."Invoice Discount Amount" :=
                TempVATAmountLineRemainder."Invoice Discount Amount" +
                TempVATAmountLine."Invoice Discount Amount" * "Line Amount" /
                TempVATAmountLine."Inv. Disc. Base Amount";
              "Inv. Discount Amount" :=
                ROUND(
                  TempVATAmountLineRemainder."Invoice Discount Amount",Currency."Amount Rounding Precision");
              TempVATAmountLineRemainder."Invoice Discount Amount" :=
                TempVATAmountLineRemainder."Invoice Discount Amount" - "Inv. Discount Amount";
            END;

          IF SalesHeader."Prices Including VAT" THEN BEGIN
            IF NOT "Manually VAT Posting" THEN BEGIN //**4PS.n
              IF (TempVATAmountLine.CalcLineAmount = 0) OR ("Line Amount" = 0) THEN BEGIN
                TempVATAmountLineRemainder."VAT Amount" := 0;
                TempVATAmountLineRemainder."Amount Including VAT" := 0;
              END ELSE BEGIN
                TempVATAmountLineRemainder."VAT Amount" +=
                  TempVATAmountLine."VAT Amount" * CalcLineAmount / TempVATAmountLine.CalcLineAmount;
                TempVATAmountLineRemainder."Amount Including VAT" +=
                  TempVATAmountLine."Amount Including VAT" * CalcLineAmount / TempVATAmountLine.CalcLineAmount;
              END;
              IF "Line Discount %" <> 100 THEN
                "Amount Including VAT" :=
                  ROUND(TempVATAmountLineRemainder."Amount Including VAT",Currency."Amount Rounding Precision")
              ELSE
                "Amount Including VAT" := 0;
            END; //**4PS.n
            Amount :=
              ROUND("Amount Including VAT",Currency."Amount Rounding Precision") -
              ROUND(TempVATAmountLineRemainder."VAT Amount",Currency."Amount Rounding Precision");
            "VAT Base Amount" :=
              ROUND(
                Amount * (1 - SalesHeader."VAT Base Discount %" / 100),Currency."Amount Rounding Precision");
            TempVATAmountLineRemainder."Amount Including VAT" :=
              TempVATAmountLineRemainder."Amount Including VAT" - "Amount Including VAT";
            TempVATAmountLineRemainder."VAT Amount" :=
              TempVATAmountLineRemainder."VAT Amount" - "Amount Including VAT" + Amount;
          END ELSE
            IF "VAT Calculation Type" = "VAT Calculation Type"::"Full VAT" THEN BEGIN
              IF "Line Discount %" <> 100 THEN
                "Amount Including VAT" := CalcLineAmount
              ELSE
                "Amount Including VAT" := 0;
              Amount := 0;
              "VAT Base Amount" := 0;
            END ELSE BEGIN
              Amount := CalcLineAmount;
              "VAT Base Amount" :=
                ROUND(
                  Amount * (1 - SalesHeader."VAT Base Discount %" / 100),Currency."Amount Rounding Precision");
              IF NOT "Manually VAT Posting" THEN BEGIN //**4PS.n
                IF TempVATAmountLine."VAT Base" = 0 THEN
                  TempVATAmountLineRemainder."VAT Amount" := 0
                ELSE
                  TempVATAmountLineRemainder."VAT Amount" +=
                    TempVATAmountLine."VAT Amount" * CalcLineAmount / TempVATAmountLine.CalcLineAmount;
                IF "Line Discount %" <> 100 THEN
                  "Amount Including VAT" :=
                    Amount + ROUND(TempVATAmountLineRemainder."VAT Amount",Currency."Amount Rounding Precision")
                ELSE
                  "Amount Including VAT" := 0;
                TempVATAmountLineRemainder."VAT Amount" :=
                  TempVATAmountLineRemainder."VAT Amount" - "Amount Including VAT" + Amount;
              END; //**4PS.n
            END;

          TempVATAmountLineRemainder.MODIFY;
          IF "Deferral Code" <> '' THEN
            CalcDeferralAmounts(SalesHeader,SalesLine,OriginalDeferralAmount);
        END;

      OnAfterDivideAmount(SalesHeader,SalesLine,QtyType,SalesLineQty,TempVATAmountLine,TempVATAmountLineRemainder);
    END;

    LOCAL PROCEDURE RoundAmount@9(SalesHeader@1003 : Record 36;VAR SalesLine@1004 : Record 37;SalesLineQty@1000 : Decimal);
    VAR
      CurrExchRate@1002 : Record 330;
      NoVAT@1001 : Boolean;
      ProjectNo@1100528200 : Code[20];
    BEGIN
      OnBeforeRoundAmount(SalesHeader,SalesLine,SalesLineQty);

      WITH SalesLine DO BEGIN
        IncrAmount(SalesHeader,SalesLine,TotalSalesLine);
        Increment(TotalSalesLine."Net Weight",ROUND(SalesLineQty * "Net Weight",UOMMgt.WeightRndPrecision));
        Increment(TotalSalesLine."Gross Weight",ROUND(SalesLineQty * "Gross Weight",UOMMgt.WeightRndPrecision));
        Increment(TotalSalesLine."Unit Volume",ROUND(SalesLineQty * "Unit Volume",UOMMgt.CubageRndPrecision));
        Increment(TotalSalesLine.Quantity,SalesLineQty);
        IF "Units per Parcel" > 0 THEN
          Increment(
            TotalSalesLine."Units per Parcel",
            ROUND(SalesLineQty / "Units per Parcel",1,'>'));

        xSalesLine := SalesLine;
        SalesLineACY := SalesLine;

        IF SalesHeader."Currency Code" <> '' THEN BEGIN
          IF SalesHeader."Posting Date" = 0D THEN
            UseDate := WORKDATE
          ELSE
            UseDate := SalesHeader."Posting Date";

          //**4PS.sn
          IF ("Currency Code" <> '') AND ("Job No." <> '') THEN
            ProjectNo := "Job No.";
          //**4PS.sn

          NoVAT := Amount = "Amount Including VAT";
          "Amount Including VAT" :=
            ROUND(
              CurrExchRate.ExchangeAmtFCYToLCY(
                1,ProjectNo, //**4PS.n
                UseDate,SalesHeader."Currency Code",
      //        TotalSalesLine."Amount Including VAT",SalesHeader."Currency Factor")) - //**4PS.o
                TotalSalesLine."Amount Including VAT",SalesHeader."Currency Factor",TRUE)) - //**4PS.n
            TotalSalesLineLCY."Amount Including VAT";
          IF NoVAT THEN
            Amount := "Amount Including VAT"
          ELSE
            Amount :=
              ROUND(
                CurrExchRate.ExchangeAmtFCYToLCY(
                  1,ProjectNo, //**4PS.n
                  UseDate,SalesHeader."Currency Code",
      //          TotalSalesLine.Amount,SalesHeader."Currency Factor")) - //**4PS.o
                  TotalSalesLine.Amount,SalesHeader."Currency Factor",TRUE)) - //**4PS.n
              TotalSalesLineLCY.Amount;
          "Line Amount" :=
            ROUND(
              CurrExchRate.ExchangeAmtFCYToLCY(
                1,ProjectNo, //**4PS.n
                UseDate,SalesHeader."Currency Code",
      //        TotalSalesLine."Line Amount",SalesHeader."Currency Factor")) - //**4PS.o
                TotalSalesLine."Line Amount",SalesHeader."Currency Factor",TRUE)) - //**4PS.n
            TotalSalesLineLCY."Line Amount";
          "Line Discount Amount" :=
            ROUND(
              CurrExchRate.ExchangeAmtFCYToLCY(
                1,ProjectNo, //**4PS.n
                UseDate,SalesHeader."Currency Code",
      //        TotalSalesLine."Line Discount Amount",SalesHeader."Currency Factor")) - //**4PS.o
                TotalSalesLine."Line Discount Amount",SalesHeader."Currency Factor",TRUE)) - //**4PS.n
            TotalSalesLineLCY."Line Discount Amount";
          "Inv. Discount Amount" :=
            ROUND(
              CurrExchRate.ExchangeAmtFCYToLCY(
                1,ProjectNo, //**4PS.n
                UseDate,SalesHeader."Currency Code",
      //        TotalSalesLine."Inv. Discount Amount",SalesHeader."Currency Factor")) - //**4PS.o
                TotalSalesLine."Inv. Discount Amount",SalesHeader."Currency Factor",TRUE)) - //**4PS.n
            TotalSalesLineLCY."Inv. Discount Amount";
          "VAT Difference" :=
            ROUND(
              CurrExchRate.ExchangeAmtFCYToLCY(
                1,ProjectNo, //**4PS.n
                UseDate,SalesHeader."Currency Code",
      //        TotalSalesLine."VAT Difference",SalesHeader."Currency Factor")) - //**4PS.o
                TotalSalesLine."VAT Difference",SalesHeader."Currency Factor",TRUE)) - //**4PS.n
            TotalSalesLineLCY."VAT Difference";
          "VAT Base Amount" :=
            ROUND(
              CurrExchRate.ExchangeAmtFCYToLCY(
                1,ProjectNo, //**4PS.n
                UseDate,SalesHeader."Currency Code",
      //        TotalSalesLine."VAT Base Amount",SalesHeader."Currency Factor")) - //**4PS.o
                TotalSalesLine."VAT Base Amount",SalesHeader."Currency Factor",TRUE)) - //**4PS.n
            TotalSalesLineLCY."VAT Base Amount";
        END;

        OnRoundAmountOnBeforeIncrAmount(SalesHeader,SalesLine,SalesLineQty,TotalSalesLine,TotalSalesLineLCY);

        IncrAmount(SalesHeader,SalesLine,TotalSalesLineLCY);
        Increment(TotalSalesLineLCY."Unit Cost (LCY)",ROUND(SalesLineQty * "Unit Cost (LCY)"));
      END;

      OnAfterRoundAmount(SalesHeader,SalesLine,SalesLineQty);
    END;

    [External]
    PROCEDURE ReverseAmount@10(VAR SalesLine@1000 : Record 37);
    BEGIN
      WITH SalesLine DO BEGIN
        "Qty. to Ship" := -"Qty. to Ship";
        "Qty. to Ship (Base)" := -"Qty. to Ship (Base)";
        "Return Qty. to Receive" := -"Return Qty. to Receive";
        "Return Qty. to Receive (Base)" := -"Return Qty. to Receive (Base)";
        "Qty. to Invoice" := -"Qty. to Invoice";
        "Qty. to Invoice (Base)" := -"Qty. to Invoice (Base)";
        "Line Amount" := -"Line Amount";
        Amount := -Amount;
        "Amount (LCY)" := - "Amount (LCY)"; //**4PS.n
        "VAT Base Amount" := -"VAT Base Amount";
        "VAT Difference" := -"VAT Difference";
        "Amount Including VAT" := -"Amount Including VAT";
        "Line Discount Amount" := -"Line Discount Amount";
        "Inv. Discount Amount" := -"Inv. Discount Amount";
        OnAfterReverseAmount(SalesLine);
      END;
    END;

    LOCAL PROCEDURE InvoiceRounding@12(SalesHeader@1003 : Record 36;VAR SalesLine@1005 : Record 37;UseTempData@1000 : Boolean;BiggestLineNo@1004 : Integer);
    VAR
      CustPostingGr@1002 : Record 92;
      InvoiceRoundingAmount@1001 : Decimal;
    BEGIN
      Currency.TESTFIELD("Invoice Rounding Precision");
      InvoiceRoundingAmount :=
        -ROUND(
          TotalSalesLine."Amount Including VAT" -
          ROUND(
            TotalSalesLine."Amount Including VAT",Currency."Invoice Rounding Precision",Currency.InvoiceRoundingDirection),
          Currency."Amount Rounding Precision");

      OnBeforeInvoiceRoundingAmount(
        SalesHeader,TotalSalesLine."Amount Including VAT",UseTempData,InvoiceRoundingAmount,SuppressCommit,TotalSalesLine);
      IF InvoiceRoundingAmount <> 0 THEN BEGIN
        CustPostingGr.GET(SalesHeader."Customer Posting Group");
        WITH SalesLine DO BEGIN
          INIT;
          BiggestLineNo := BiggestLineNo + 10000;
          "System-Created Entry" := TRUE;
          IF UseTempData THEN BEGIN
            "Line No." := 0;
            Type := Type::"G/L Account";
            SetHideValidationDialog(TRUE);
          END ELSE BEGIN
            "Line No." := BiggestLineNo;
      //>>4PSSE, 2013-01-16, 140926 IME-204
            Type := Type::"G/L Account";
            IF NOT SalesHeader."Project Invoice" THEN
      //<<4PSSE
              VALIDATE(Type,Type::"G/L Account");
          END;
          VALIDATE("No.",CustPostingGr.GetInvRoundingAccount);
      //>>4PSSE
          GLAcc.GET("No.");
          Description := GLAcc.Name;
      //<<4PSSE

          VALIDATE(Quantity,1);
          IF IsCreditDocType THEN
            VALIDATE("Return Qty. to Receive",Quantity)
          ELSE
            VALIDATE("Qty. to Ship",Quantity);
          IF SalesHeader."Prices Including VAT" THEN
            VALIDATE("Unit Price",InvoiceRoundingAmount)
          ELSE
            VALIDATE(
              "Unit Price",
              ROUND(
                InvoiceRoundingAmount /
                (1 + (1 - SalesHeader."VAT Base Discount %" / 100) * "VAT %" / 100),
                Currency."Amount Rounding Precision"));
          VALIDATE("Amount Including VAT",InvoiceRoundingAmount);
          "Line No." := BiggestLineNo;
          LastLineRetrieved := FALSE;
          RoundingLineInserted := TRUE;
          RoundingLineNo := "Line No.";
          // PEB0019
          "Charge Type" := "Charge Type"::Rounding;
          // 0019
        END;
      END;

      OnAfterInvoiceRoundingAmount(SalesHeader,SalesLine,TotalSalesLine,UseTempData,InvoiceRoundingAmount,SuppressCommit);
    END;

    LOCAL PROCEDURE IncrAmount@13(SalesHeader@1001 : Record 36;SalesLine@1002 : Record 37;VAR TotalSalesLine@1000 : Record 37);
    BEGIN
      WITH SalesLine DO BEGIN
        IF SalesHeader."Prices Including VAT" OR
           ("VAT Calculation Type" <> "VAT Calculation Type"::"Full VAT")
        THEN
          Increment(TotalSalesLine."Line Amount","Line Amount");
        Increment(TotalSalesLine.Amount,Amount);
        Increment(TotalSalesLine."VAT Base Amount","VAT Base Amount");
        Increment(TotalSalesLine."VAT Difference","VAT Difference");
        Increment(TotalSalesLine."Amount Including VAT","Amount Including VAT");
        Increment(TotalSalesLine."Line Discount Amount","Line Discount Amount");
        Increment(TotalSalesLine."Inv. Discount Amount","Inv. Discount Amount");
        Increment(TotalSalesLine."Inv. Disc. Amount to Invoice","Inv. Disc. Amount to Invoice");
        Increment(TotalSalesLine."Prepmt. Line Amount","Prepmt. Line Amount");
        Increment(TotalSalesLine."Prepmt. Amt. Inv.","Prepmt. Amt. Inv.");
        Increment(TotalSalesLine."Prepmt Amt to Deduct","Prepmt Amt to Deduct");
        Increment(TotalSalesLine."Prepmt Amt Deducted","Prepmt Amt Deducted");
        Increment(TotalSalesLine."Prepayment VAT Difference","Prepayment VAT Difference");
        Increment(TotalSalesLine."Prepmt VAT Diff. to Deduct","Prepmt VAT Diff. to Deduct");
        Increment(TotalSalesLine."Prepmt VAT Diff. Deducted","Prepmt VAT Diff. Deducted");
        OnAfterIncrAmount(TotalSalesLine,SalesLine,SalesHeader);
      END;
    END;

    LOCAL PROCEDURE Increment@14(VAR Number@1000 : Decimal;Number2@1001 : Decimal);
    BEGIN
      Number := Number + Number2;
    END;

    [External]
    PROCEDURE GetSalesLines@16(VAR SalesHeader@1000 : Record 36;VAR NewSalesLine@1001 : Record 37;QtyType@1002 : 'General,Invoicing,Shipping');
    VAR
      TotalAdjCostLCY@1005 : Decimal;
    BEGIN
      FillTempLines(SalesHeader,TempSalesLineGlobal);
      IF QtyType = QtyType::Invoicing THEN
        CreatePrepaymentLines(SalesHeader,FALSE);
      SumSalesLines2(SalesHeader,NewSalesLine,TempSalesLineGlobal,QtyType,TRUE,FALSE,TotalAdjCostLCY);
    END;

    [External]
    PROCEDURE GetSalesLinesTemp@33(VAR SalesHeader@1000 : Record 36;VAR NewSalesLine@1001 : Record 37;VAR OldSalesLine@1002 : Record 37;QtyType@1003 : 'General,Invoicing,Shipping');
    VAR
      TotalAdjCostLCY@1005 : Decimal;
    BEGIN
      OldSalesLine.SetSalesHeader(SalesHeader);
      SumSalesLines2(SalesHeader,NewSalesLine,OldSalesLine,QtyType,TRUE,FALSE,TotalAdjCostLCY);
    END;

    [External]
    PROCEDURE SumSalesLines@15(VAR NewSalesHeader@1000 : Record 36;QtyType@1001 : 'General,Invoicing,Shipping';VAR NewTotalSalesLine@1002 : Record 37;VAR NewTotalSalesLineLCY@1003 : Record 37;VAR VATAmount@1004 : Decimal;VAR VATAmountText@1005 : Text[30];VAR ProfitLCY@1006 : Decimal;VAR ProfitPct@1007 : Decimal;VAR TotalAdjCostLCY@1010 : Decimal);
    VAR
      OldSalesLine@1008 : Record 37;
    BEGIN
      SumSalesLinesTemp(
        NewSalesHeader,OldSalesLine,QtyType,NewTotalSalesLine,NewTotalSalesLineLCY,
        VATAmount,VATAmountText,ProfitLCY,ProfitPct,TotalAdjCostLCY);
    END;

    [External]
    PROCEDURE SumSalesLinesTemp@25(VAR SalesHeader@1000 : Record 36;VAR OldSalesLine@1001 : Record 37;QtyType@1002 : 'General,Invoicing,Shipping';VAR NewTotalSalesLine@1003 : Record 37;VAR NewTotalSalesLineLCY@1004 : Record 37;VAR VATAmount@1005 : Decimal;VAR VATAmountText@1006 : Text[30];VAR ProfitLCY@1007 : Decimal;VAR ProfitPct@1008 : Decimal;VAR TotalAdjCostLCY@1011 : Decimal);
    VAR
      SalesLine@1009 : Record 37;
    BEGIN
      WITH SalesHeader DO BEGIN
        SumSalesLines2(SalesHeader,SalesLine,OldSalesLine,QtyType,FALSE,TRUE,TotalAdjCostLCY);
        ProfitLCY := TotalSalesLineLCY.Amount - TotalSalesLineLCY."Unit Cost (LCY)";
        IF TotalSalesLineLCY.Amount = 0 THEN
          ProfitPct := 0
        ELSE
          ProfitPct := ROUND(ProfitLCY / TotalSalesLineLCY.Amount * 100,0.1);
        VATAmount := TotalSalesLine."Amount Including VAT" - TotalSalesLine.Amount;
        IF TotalSalesLine."VAT %" = 0 THEN
          VATAmountText := VATAmountTxt
        ELSE
          VATAmountText := STRSUBSTNO(VATRateTxt,TotalSalesLine."VAT %");
        NewTotalSalesLine := TotalSalesLine;
        NewTotalSalesLineLCY := TotalSalesLineLCY;
      END;
    END;

    LOCAL PROCEDURE SumSalesLines2@11(SalesHeader@1011 : Record 36;VAR NewSalesLine@1000 : Record 37;VAR OldSalesLine@1001 : Record 37;QtyType@1002 : 'General,Invoicing,Shipping';InsertSalesLine@1003 : Boolean;CalcAdCostLCY@1008 : Boolean;VAR TotalAdjCostLCY@1006 : Decimal);
    VAR
      SalesLine@1012 : Record 37;
      TempVATAmountLine@1010 : TEMPORARY Record 290;
      TempVATAmountLineRemainder@1009 : TEMPORARY Record 290;
      SalesLineQty@1004 : Decimal;
      AdjCostLCY@1007 : Decimal;
      BiggestLineNo@1005 : Integer;
      IsHandled@1013 : Boolean;
    BEGIN
      TotalAdjCostLCY := 0;
      TempVATAmountLineRemainder.DELETEALL;
      OldSalesLine.CalcVATAmountLines(QtyType,SalesHeader,OldSalesLine,TempVATAmountLine);
      WITH SalesHeader DO BEGIN
        GetGLSetup;
        SalesSetup.GET;
        GetCurrency("Currency Code");
        OldSalesLine.SETRANGE("Document Type","Document Type");
        OldSalesLine.SETRANGE("Document No.","No.");
        OnSumSalesLines2SetFilter(OldSalesLine,SalesHeader,InsertSalesLine);
        RoundingLineInserted := FALSE;
        IF OldSalesLine.FINDSET THEN
          REPEAT
            IF NOT RoundingLineInserted THEN
              SalesLine := OldSalesLine;
            CASE QtyType OF
              QtyType::General:
                SalesLineQty := SalesLine.Quantity;
              QtyType::Invoicing:
                SalesLineQty := SalesLine."Qty. to Invoice";
              QtyType::Shipping:
                BEGIN
                  IF IsCreditDocType THEN
                    SalesLineQty := SalesLine."Return Qty. to Receive"
                  ELSE
                    SalesLineQty := SalesLine."Qty. to Ship";
                END;
            END;
            IsHandled := FALSE;
            OnSumSalesLines2OnBeforeDivideAmount(OldSalesLine,IsHandled);
            IF NOT IsHandled THEN
              DivideAmount(SalesHeader,SalesLine,QtyType,SalesLineQty,TempVATAmountLine,TempVATAmountLineRemainder);
            SalesLine.Quantity := SalesLineQty;
            IF SalesLineQty <> 0 THEN BEGIN
              IF (SalesLine.Amount <> 0) AND NOT RoundingLineInserted THEN
                IF TotalSalesLine.Amount = 0 THEN
                  TotalSalesLine."VAT %" := SalesLine."VAT %"
                ELSE
                  IF TotalSalesLine."VAT %" <> SalesLine."VAT %" THEN
                    TotalSalesLine."VAT %" := 0;
              RoundAmount(SalesHeader,SalesLine,SalesLineQty);

              IF (QtyType IN [QtyType::General,QtyType::Invoicing]) AND
                 NOT InsertSalesLine AND CalcAdCostLCY
              THEN BEGIN
                AdjCostLCY := CostCalcMgt.CalcSalesLineCostLCY(SalesLine,QtyType);
                TotalAdjCostLCY := TotalAdjCostLCY + GetSalesLineAdjCostLCY(SalesLine,QtyType,AdjCostLCY);
              END;

              SalesLine := xSalesLine;
            END;
            IF InsertSalesLine THEN BEGIN
              NewSalesLine := SalesLine;
              NewSalesLine.INSERT;
            END;
            IF RoundingLineInserted THEN
              LastLineRetrieved := TRUE
            ELSE BEGIN
              BiggestLineNo := MAX(BiggestLineNo,OldSalesLine."Line No.");
              LastLineRetrieved := OldSalesLine.NEXT = 0;
              IF LastLineRetrieved AND SalesSetup."Invoice Rounding" THEN
                InvoiceRounding(SalesHeader,SalesLine,TRUE,BiggestLineNo);
            END;
          UNTIL LastLineRetrieved;
      END;
    END;

    LOCAL PROCEDURE GetSalesLineAdjCostLCY@48(SalesLine2@1000 : Record 37;QtyType@1002 : 'General,Invoicing,Shipping';AdjCostLCY@1001 : Decimal) : Decimal;
    BEGIN
      WITH SalesLine2 DO BEGIN
        IF "Document Type" IN ["Document Type"::Order,"Document Type"::Invoice] THEN
          AdjCostLCY := -AdjCostLCY;

        CASE TRUE OF
          "Shipment No." <> '',"Return Receipt No." <> '':
            EXIT(AdjCostLCY);
          QtyType = QtyType::General:
            EXIT(ROUND("Outstanding Quantity" * "Unit Cost (LCY)") + AdjCostLCY);
          "Document Type" IN ["Document Type"::Order,"Document Type"::Invoice]:
            BEGIN
              IF "Qty. to Invoice" > "Qty. to Ship" THEN
                EXIT(ROUND("Qty. to Ship" * "Unit Cost (LCY)") + AdjCostLCY);
              EXIT(ROUND("Qty. to Invoice" * "Unit Cost (LCY)"));
            END;
          IsCreditDocType:
            BEGIN
              IF "Qty. to Invoice" > "Return Qty. to Receive" THEN
                EXIT(ROUND("Return Qty. to Receive" * "Unit Cost (LCY)") + AdjCostLCY);
              EXIT(ROUND("Qty. to Invoice" * "Unit Cost (LCY)"));
            END;
        END;
      END;
    END;

    [External]
    PROCEDURE UpdateBlanketOrderLine@21(SalesLine@1000 : Record 37;Ship@1001 : Boolean;Receive@1006 : Boolean;Invoice@1002 : Boolean);
    VAR
      BlanketOrderSalesLine@1003 : Record 37;
      xBlanketOrderSalesLine@1007 : Record 37;
      ModifyLine@1004 : Boolean;
      Sign@1005 : Decimal;
      IsHandled@1008 : Boolean;
    BEGIN
      IsHandled := FALSE;
      OnBeforeUpdateBlanketOrderLine(SalesLine,Ship,Receive,Invoice,IsHandled);
      IF IsHandled THEN
        EXIT;

      IF (SalesLine."Blanket Order No." <> '') AND (SalesLine."Blanket Order Line No." <> 0) AND
         ((Ship AND (SalesLine."Qty. to Ship" <> 0)) OR
          (Receive AND (SalesLine."Return Qty. to Receive" <> 0)) OR
          (Invoice AND (SalesLine."Qty. to Invoice" <> 0)))
      THEN
        IF BlanketOrderSalesLine.GET(
             BlanketOrderSalesLine."Document Type"::"Blanket Order",SalesLine."Blanket Order No.",
             SalesLine."Blanket Order Line No.")
        THEN BEGIN
          BlanketOrderSalesLine.TESTFIELD(Type,SalesLine.Type);
          BlanketOrderSalesLine.TESTFIELD("No.",SalesLine."No.");
          BlanketOrderSalesLine.TESTFIELD("Sell-to Customer No.",SalesLine."Sell-to Customer No.");

          ModifyLine := FALSE;
          CASE SalesLine."Document Type" OF
            SalesLine."Document Type"::Order,
            SalesLine."Document Type"::Invoice:
              Sign := 1;
            SalesLine."Document Type"::"Return Order",
            SalesLine."Document Type"::"Credit Memo":
              Sign := -1;
          END;
          IF Ship AND (SalesLine."Shipment No." = '') THEN BEGIN
            xBlanketOrderSalesLine := BlanketOrderSalesLine;

            IF BlanketOrderSalesLine."Qty. per Unit of Measure" = SalesLine."Qty. per Unit of Measure" THEN
              BlanketOrderSalesLine."Quantity Shipped" += Sign * SalesLine."Qty. to Ship"
            ELSE
              BlanketOrderSalesLine."Quantity Shipped" +=
                Sign *
                ROUND(
                  (SalesLine."Qty. per Unit of Measure" /
                   BlanketOrderSalesLine."Qty. per Unit of Measure") * SalesLine."Qty. to Ship",
                  UOMMgt.QtyRndPrecision);
            BlanketOrderSalesLine."Qty. Shipped (Base)" += Sign * SalesLine."Qty. to Ship (Base)";
            ModifyLine := TRUE;

            AsmPost.UpdateBlanketATO(xBlanketOrderSalesLine,BlanketOrderSalesLine);
          END;
          IF Receive AND (SalesLine."Return Receipt No." = '') THEN BEGIN
            IF BlanketOrderSalesLine."Qty. per Unit of Measure" =
               SalesLine."Qty. per Unit of Measure"
            THEN
              BlanketOrderSalesLine."Quantity Shipped" += Sign * SalesLine."Return Qty. to Receive"
            ELSE
              BlanketOrderSalesLine."Quantity Shipped" +=
                Sign *
                ROUND(
                  (SalesLine."Qty. per Unit of Measure" /
                   BlanketOrderSalesLine."Qty. per Unit of Measure") * SalesLine."Return Qty. to Receive",
                  UOMMgt.QtyRndPrecision);
            BlanketOrderSalesLine."Qty. Shipped (Base)" += Sign * SalesLine."Return Qty. to Receive (Base)";
            ModifyLine := TRUE;
          END;
          IF Invoice THEN BEGIN
            IF BlanketOrderSalesLine."Qty. per Unit of Measure" =
               SalesLine."Qty. per Unit of Measure"
            THEN
              BlanketOrderSalesLine."Quantity Invoiced" += Sign * SalesLine."Qty. to Invoice"
            ELSE
              BlanketOrderSalesLine."Quantity Invoiced" +=
                Sign *
                ROUND(
                  (SalesLine."Qty. per Unit of Measure" /
                   BlanketOrderSalesLine."Qty. per Unit of Measure") * SalesLine."Qty. to Invoice",
                  UOMMgt.QtyRndPrecision);
            BlanketOrderSalesLine."Qty. Invoiced (Base)" += Sign * SalesLine."Qty. to Invoice (Base)";
            ModifyLine := TRUE;
          END;

          IF ModifyLine THEN BEGIN
            OnUpdateBlanketOrderLineOnBeforeInitOutstanding(BlanketOrderSalesLine,SalesLine);
            BlanketOrderSalesLine.InitOutstanding;

            IsHandled := FALSE;
            OnUpdateBlanketOrderLineOnBeforeCheck(BlanketOrderSalesLine,SalesLine,IsHandled);
            IF NOT IsHandled THEN BEGIN
              IF (BlanketOrderSalesLine.Quantity * BlanketOrderSalesLine."Quantity Shipped" < 0) OR
                 (ABS(BlanketOrderSalesLine.Quantity) < ABS(BlanketOrderSalesLine."Quantity Shipped"))
              THEN
                BlanketOrderSalesLine.FIELDERROR(
                  "Quantity Shipped",STRSUBSTNO(BlanketOrderQuantityGreaterThanErr,BlanketOrderSalesLine.FIELDCAPTION(Quantity)));
              IF (BlanketOrderSalesLine."Quantity (Base)" * BlanketOrderSalesLine."Qty. Shipped (Base)" < 0) OR
                 (ABS(BlanketOrderSalesLine."Quantity (Base)") < ABS(BlanketOrderSalesLine."Qty. Shipped (Base)"))
              THEN
                BlanketOrderSalesLine.FIELDERROR(
                  "Qty. Shipped (Base)",
                  STRSUBSTNO(BlanketOrderQuantityGreaterThanErr,BlanketOrderSalesLine.FIELDCAPTION("Quantity (Base)")));
              BlanketOrderSalesLine.CALCFIELDS("Reserved Qty. (Base)");
              IF ABS(BlanketOrderSalesLine."Outstanding Qty. (Base)") < ABS(BlanketOrderSalesLine."Reserved Qty. (Base)") THEN
                BlanketOrderSalesLine.FIELDERROR(
                  "Reserved Qty. (Base)",BlanketOrderQuantityReducedErr);
            END;

            BlanketOrderSalesLine."Qty. to Invoice" :=
              BlanketOrderSalesLine.Quantity - BlanketOrderSalesLine."Quantity Invoiced";
            BlanketOrderSalesLine."Qty. to Ship" :=
              BlanketOrderSalesLine.Quantity - BlanketOrderSalesLine."Quantity Shipped";
            BlanketOrderSalesLine."Qty. to Invoice (Base)" :=
              BlanketOrderSalesLine."Quantity (Base)" - BlanketOrderSalesLine."Qty. Invoiced (Base)";
            BlanketOrderSalesLine."Qty. to Ship (Base)" :=
              BlanketOrderSalesLine."Quantity (Base)" - BlanketOrderSalesLine."Qty. Shipped (Base)";

            OnBeforeBlanketOrderSalesLineModify(BlanketOrderSalesLine,SalesLine);
            BlanketOrderSalesLine.MODIFY;
            OnAfterUpdateBlanketOrderLine(BlanketOrderSalesLine,SalesLine,Ship,Receive,Invoice);
          END;
        END;
    END;

    LOCAL PROCEDURE RunGenJnlPostLine@23(VAR GenJnlLine@1000 : Record 81) : Integer;
    BEGIN
      EXIT(GenJnlPostLine.RunWithCheck(GenJnlLine));
    END;

    LOCAL PROCEDURE DeleteItemChargeAssgnt@5803(SalesHeader@1001 : Record 36);
    VAR
      ItemChargeAssgntSales@1000 : Record 5809;
    BEGIN
      ItemChargeAssgntSales.SETRANGE("Document Type",SalesHeader."Document Type");
      ItemChargeAssgntSales.SETRANGE("Document No.",SalesHeader."No.");
      IF NOT ItemChargeAssgntSales.ISEMPTY THEN
        ItemChargeAssgntSales.DELETEALL;
    END;

    LOCAL PROCEDURE UpdateItemChargeAssgnt@5808();
    VAR
      ItemChargeAssgntSales@1000 : Record 5809;
    BEGIN
      WITH TempItemChargeAssgntSales DO BEGIN
        ClearItemChargeAssgntFilter;
        MARKEDONLY(TRUE);
        IF FINDSET THEN
          REPEAT
            ItemChargeAssgntSales.GET("Document Type","Document No.","Document Line No.","Line No.");
            ItemChargeAssgntSales."Qty. Assigned" :=
              ItemChargeAssgntSales."Qty. Assigned" + "Qty. to Assign";
            ItemChargeAssgntSales."Qty. to Assign" := 0;
            ItemChargeAssgntSales."Amount to Assign" := 0;
            ItemChargeAssgntSales.MODIFY;
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE UpdateSalesOrderChargeAssgnt@5814(SalesOrderInvLine@1000 : Record 37;SalesOrderLine@1001 : Record 37);
    VAR
      SalesOrderLine2@1002 : Record 37;
      SalesOrderInvLine2@1003 : Record 37;
      SalesShptLine@1004 : Record 111;
      ReturnRcptLine@1005 : Record 6661;
    BEGIN
      WITH SalesOrderInvLine DO BEGIN
        ClearItemChargeAssgntFilter;
        TempItemChargeAssgntSales.SETRANGE("Document Type","Document Type");
        TempItemChargeAssgntSales.SETRANGE("Document No.","Document No.");
        TempItemChargeAssgntSales.SETRANGE("Document Line No.","Line No.");
        TempItemChargeAssgntSales.MARKEDONLY(TRUE);
        IF TempItemChargeAssgntSales.FINDSET THEN
          REPEAT
            IF TempItemChargeAssgntSales."Applies-to Doc. Type" = "Document Type" THEN BEGIN
              SalesOrderInvLine2.GET(
                TempItemChargeAssgntSales."Applies-to Doc. Type",
                TempItemChargeAssgntSales."Applies-to Doc. No.",
                TempItemChargeAssgntSales."Applies-to Doc. Line No.");
              IF SalesOrderLine."Document Type" = SalesOrderLine."Document Type"::Order THEN BEGIN
                IF NOT
                   SalesShptLine.GET(SalesOrderInvLine2."Shipment No.",SalesOrderInvLine2."Shipment Line No.")
                THEN
                  ERROR(ShipmentLinesDeletedErr);
                SalesOrderLine2.GET(
                  SalesOrderLine2."Document Type"::Order,
                  SalesShptLine."Order No.",SalesShptLine."Order Line No.");
              END ELSE BEGIN
                IF NOT
                   ReturnRcptLine.GET(SalesOrderInvLine2."Return Receipt No.",SalesOrderInvLine2."Return Receipt Line No.")
                THEN
                  ERROR(ReturnReceiptLinesDeletedErr);
                SalesOrderLine2.GET(
                  SalesOrderLine2."Document Type"::"Return Order",
                  ReturnRcptLine."Return Order No.",ReturnRcptLine."Return Order Line No.");
              END;
              UpdateSalesChargeAssgntLines(
                SalesOrderLine,
                SalesOrderLine2."Document Type",
                SalesOrderLine2."Document No.",
                SalesOrderLine2."Line No.",
                TempItemChargeAssgntSales."Qty. to Assign");
            END ELSE
              UpdateSalesChargeAssgntLines(
                SalesOrderLine,
                TempItemChargeAssgntSales."Applies-to Doc. Type",
                TempItemChargeAssgntSales."Applies-to Doc. No.",
                TempItemChargeAssgntSales."Applies-to Doc. Line No.",
                TempItemChargeAssgntSales."Qty. to Assign");
          UNTIL TempItemChargeAssgntSales.NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE UpdateSalesChargeAssgntLines@5813(SalesOrderLine@1000 : Record 37;ApplToDocType@1001 : Option;ApplToDocNo@1002 : Code[20];ApplToDocLineNo@1003 : Integer;QtyToAssign@1004 : Decimal);
    VAR
      ItemChargeAssgntSales@1005 : Record 5809;
      TempItemChargeAssgntSales2@1007 : Record 5809;
      LastLineNo@1006 : Integer;
      TotalToAssign@1008 : Decimal;
    BEGIN
      ItemChargeAssgntSales.SETRANGE("Document Type",SalesOrderLine."Document Type");
      ItemChargeAssgntSales.SETRANGE("Document No.",SalesOrderLine."Document No.");
      ItemChargeAssgntSales.SETRANGE("Document Line No.",SalesOrderLine."Line No.");
      ItemChargeAssgntSales.SETRANGE("Applies-to Doc. Type",ApplToDocType);
      ItemChargeAssgntSales.SETRANGE("Applies-to Doc. No.",ApplToDocNo);
      ItemChargeAssgntSales.SETRANGE("Applies-to Doc. Line No.",ApplToDocLineNo);
      IF ItemChargeAssgntSales.FINDFIRST THEN BEGIN
        ItemChargeAssgntSales."Qty. Assigned" := ItemChargeAssgntSales."Qty. Assigned" + QtyToAssign;
        ItemChargeAssgntSales."Qty. to Assign" := 0;
        ItemChargeAssgntSales."Amount to Assign" := 0;
        ItemChargeAssgntSales.MODIFY;
      END ELSE BEGIN
        ItemChargeAssgntSales.SETRANGE("Applies-to Doc. Type");
        ItemChargeAssgntSales.SETRANGE("Applies-to Doc. No.");
        ItemChargeAssgntSales.SETRANGE("Applies-to Doc. Line No.");
        ItemChargeAssgntSales.CALCSUMS("Qty. to Assign");

        // calculate total qty. to assign of the invoice charge line
        TempItemChargeAssgntSales2.SETRANGE("Document Type",TempItemChargeAssgntSales."Document Type");
        TempItemChargeAssgntSales2.SETRANGE("Document No.",TempItemChargeAssgntSales."Document No.");
        TempItemChargeAssgntSales2.SETRANGE("Document Line No.",TempItemChargeAssgntSales."Document Line No.");
        TempItemChargeAssgntSales2.CALCSUMS("Qty. to Assign");

        TotalToAssign := ItemChargeAssgntSales."Qty. to Assign" +
          TempItemChargeAssgntSales2."Qty. to Assign";

        IF ItemChargeAssgntSales.FINDLAST THEN
          LastLineNo := ItemChargeAssgntSales."Line No.";

        IF SalesOrderLine.Quantity < TotalToAssign THEN
          REPEAT
            TotalToAssign := TotalToAssign - ItemChargeAssgntSales."Qty. to Assign";
            ItemChargeAssgntSales."Qty. to Assign" := 0;
            ItemChargeAssgntSales."Amount to Assign" := 0;
            ItemChargeAssgntSales.MODIFY;
          UNTIL (ItemChargeAssgntSales.NEXT(-1) = 0) OR
                (TotalToAssign = SalesOrderLine.Quantity);

        InsertAssocOrderCharge(
          SalesOrderLine,
          ApplToDocType,
          ApplToDocNo,
          ApplToDocLineNo,
          LastLineNo,
          TempItemChargeAssgntSales."Applies-to Doc. Line Amount");
      END;
    END;

    LOCAL PROCEDURE InsertAssocOrderCharge@45(SalesOrderLine@1000 : Record 37;ApplToDocType@1001 : Option;ApplToDocNo@1002 : Code[20];ApplToDocLineNo@1003 : Integer;LastLineNo@1004 : Integer;ApplToDocLineAmt@1005 : Decimal);
    VAR
      NewItemChargeAssgntSales@1006 : Record 5809;
    BEGIN
      WITH NewItemChargeAssgntSales DO BEGIN
        INIT;
        "Document Type" := SalesOrderLine."Document Type";
        "Document No." := SalesOrderLine."Document No.";
        "Document Line No." := SalesOrderLine."Line No.";
        "Line No." := LastLineNo + 10000;
        "Item Charge No." := TempItemChargeAssgntSales."Item Charge No.";
        "Item No." := TempItemChargeAssgntSales."Item No.";
        "Qty. Assigned" := TempItemChargeAssgntSales."Qty. to Assign";
        "Qty. to Assign" := 0;
        "Amount to Assign" := 0;
        Description := TempItemChargeAssgntSales.Description;
        "Unit Cost" := TempItemChargeAssgntSales."Unit Cost";
        "Applies-to Doc. Type" := ApplToDocType;
        "Applies-to Doc. No." := ApplToDocNo;
        "Applies-to Doc. Line No." := ApplToDocLineNo;
        "Applies-to Doc. Line Amount" := ApplToDocLineAmt;
        INSERT;
      END;
    END;

    LOCAL PROCEDURE CopyAndCheckItemCharge@5806(SalesHeader@1000 : Record 36);
    VAR
      TempSalesLine@1001 : TEMPORARY Record 37;
      SalesLine@1002 : Record 37;
      InvoiceEverything@1004 : Boolean;
      AssignError@1005 : Boolean;
      QtyNeeded@1003 : Decimal;
    BEGIN
      TempItemChargeAssgntSales.RESET;
      TempItemChargeAssgntSales.DELETEALL;

      // Check for max qty posting
      WITH TempSalesLine DO BEGIN
        ResetTempLines(TempSalesLine);
        SETRANGE(Type,Type::"Charge (Item)");
        IF ISEMPTY THEN
          EXIT;

        ItemChargeAssgntSales.RESET;
        ItemChargeAssgntSales.SETRANGE("Document Type","Document Type");
        ItemChargeAssgntSales.SETRANGE("Document No.","Document No.");
        ItemChargeAssgntSales.SETFILTER("Qty. to Assign",'<>0');
        IF ItemChargeAssgntSales.FINDSET THEN
          REPEAT
            TempItemChargeAssgntSales.INIT;
            TempItemChargeAssgntSales := ItemChargeAssgntSales;
            TempItemChargeAssgntSales.INSERT;
          UNTIL ItemChargeAssgntSales.NEXT = 0;

        SETFILTER("Qty. to Invoice",'<>0');
        IF FINDSET THEN
          REPEAT
            OnCopyAndCheckItemChargeOnBeforeLoop(TempSalesLine,SalesHeader);
            TESTFIELD("Job No.",'');
            TESTFIELD("Job Contract Entry No.",0);
            IF ("Qty. to Ship" + "Return Qty. to Receive" <> 0) AND
               ((SalesHeader.Ship OR SalesHeader.Receive) OR
                (ABS("Qty. to Invoice") >
                 ABS("Qty. Shipped Not Invoiced" + "Qty. to Ship") +
                 ABS("Ret. Qty. Rcd. Not Invd.(Base)" + "Return Qty. to Receive")))
            THEN
              TESTFIELD("Line Amount");

            IF NOT SalesHeader.Ship THEN
              "Qty. to Ship" := 0;
            IF NOT SalesHeader.Receive THEN
              "Return Qty. to Receive" := 0;
            IF ABS("Qty. to Invoice") >
               ABS("Quantity Shipped" + "Qty. to Ship" + "Return Qty. Received" + "Return Qty. to Receive" - "Quantity Invoiced")
            THEN
              "Qty. to Invoice" :=
                "Quantity Shipped" + "Qty. to Ship" + "Return Qty. Received" + "Return Qty. to Receive" - "Quantity Invoiced";

            CALCFIELDS("Qty. to Assign","Qty. Assigned");
            IF ABS("Qty. to Assign" + "Qty. Assigned") > ABS("Qty. to Invoice" + "Quantity Invoiced") THEN
              ERROR(CannotAssignMoreErr,
                "Qty. to Invoice" + "Quantity Invoiced" - "Qty. Assigned",
                FIELDCAPTION("Document Type"),"Document Type",
                FIELDCAPTION("Document No."),"Document No.",
                FIELDCAPTION("Line No."),"Line No.");
            IF Quantity = "Qty. to Invoice" + "Quantity Invoiced" THEN BEGIN
              IF "Qty. to Assign" <> 0 THEN
                IF Quantity = "Quantity Invoiced" THEN BEGIN
                  TempItemChargeAssgntSales.SETRANGE("Document Line No.","Line No.");
                  TempItemChargeAssgntSales.SETRANGE("Applies-to Doc. Type","Document Type");
                  IF TempItemChargeAssgntSales.FINDSET THEN
                    REPEAT
                      SalesLine.GET(
                        TempItemChargeAssgntSales."Applies-to Doc. Type",
                        TempItemChargeAssgntSales."Applies-to Doc. No.",
                        TempItemChargeAssgntSales."Applies-to Doc. Line No.");
                      IF SalesLine.Quantity = SalesLine."Quantity Invoiced" THEN
                        ERROR(CannotAssignInvoicedErr,SalesLine.TABLECAPTION,
                          SalesLine.FIELDCAPTION("Document Type"),SalesLine."Document Type",
                          SalesLine.FIELDCAPTION("Document No."),SalesLine."Document No.",
                          SalesLine.FIELDCAPTION("Line No."),SalesLine."Line No.");
                    UNTIL TempItemChargeAssgntSales.NEXT = 0;
                END;
              IF Quantity <> "Qty. to Assign" + "Qty. Assigned" THEN
                AssignError := TRUE;
            END;

            IF ("Qty. to Assign" + "Qty. Assigned") < ("Qty. to Invoice" + "Quantity Invoiced") THEN
              ERROR(MustAssignItemChargeErr,"No.");

            // check if all ILEs exist
            QtyNeeded := "Qty. to Assign";
            TempItemChargeAssgntSales.SETRANGE("Document Line No.","Line No.");
            IF TempItemChargeAssgntSales.FINDSET THEN
              REPEAT
                IF (TempItemChargeAssgntSales."Applies-to Doc. Type" <> "Document Type") OR
                   (TempItemChargeAssgntSales."Applies-to Doc. No." <> "Document No.")
                THEN
                  QtyNeeded := QtyNeeded - TempItemChargeAssgntSales."Qty. to Assign"
                ELSE BEGIN
                  SalesLine.GET(
                    TempItemChargeAssgntSales."Applies-to Doc. Type",
                    TempItemChargeAssgntSales."Applies-to Doc. No.",
                    TempItemChargeAssgntSales."Applies-to Doc. Line No.");
                  IF ItemLedgerEntryExist(SalesLine,SalesHeader.Ship OR SalesHeader.Receive) THEN
                    QtyNeeded := QtyNeeded - TempItemChargeAssgntSales."Qty. to Assign";
                END;
              UNTIL TempItemChargeAssgntSales.NEXT = 0;

            IF QtyNeeded > 0 THEN
              ERROR(CannotInvoiceItemChargeErr,"No.");
          UNTIL NEXT = 0;

        // Check saleslines
        IF AssignError THEN
          IF SalesHeader."Document Type" IN
             [SalesHeader."Document Type"::Invoice,SalesHeader."Document Type"::"Credit Memo"]
          THEN
            InvoiceEverything := TRUE
          ELSE BEGIN
            RESET;
            SETFILTER(Type,'%1|%2',Type::Item,Type::"Charge (Item)");
            IF FINDSET THEN
              REPEAT
                IF SalesHeader.Ship OR SalesHeader.Receive THEN
                  InvoiceEverything :=
                    Quantity = "Qty. to Invoice" + "Quantity Invoiced"
                ELSE
                  InvoiceEverything :=
                    (Quantity = "Qty. to Invoice" + "Quantity Invoiced") AND
                    ("Qty. to Invoice" =
                     "Qty. Shipped Not Invoiced" + "Ret. Qty. Rcd. Not Invd.(Base)");
              UNTIL (NEXT = 0) OR (NOT InvoiceEverything);
          END;

        IF InvoiceEverything AND AssignError THEN
          ERROR(MustAssignErr);
      END;
    END;

    LOCAL PROCEDURE ClearItemChargeAssgntFilter@27();
    BEGIN
      TempItemChargeAssgntSales.SETRANGE("Document Line No.");
      TempItemChargeAssgntSales.SETRANGE("Applies-to Doc. Type");
      TempItemChargeAssgntSales.SETRANGE("Applies-to Doc. No.");
      TempItemChargeAssgntSales.SETRANGE("Applies-to Doc. Line No.");
      TempItemChargeAssgntSales.MARKEDONLY(FALSE);
    END;

    LOCAL PROCEDURE GetItemChargeLine@5809(SalesHeader@1005 : Record 36;VAR ItemChargeSalesLine@1000 : Record 37);
    VAR
      SalesShptLine@1001 : Record 111;
      ReturnReceiptLine@1003 : Record 6661;
      QtyShippedNotInvd@1002 : Decimal;
      QtyReceivedNotInvd@1004 : Decimal;
    BEGIN
      WITH TempItemChargeAssgntSales DO
        IF (ItemChargeSalesLine."Document Type" <> "Document Type") OR
           (ItemChargeSalesLine."Document No." <> "Document No.") OR
           (ItemChargeSalesLine."Line No." <> "Document Line No.")
        THEN BEGIN
          ItemChargeSalesLine.GET("Document Type","Document No.","Document Line No.");
          IF NOT SalesHeader.Ship THEN
            ItemChargeSalesLine."Qty. to Ship" := 0;
          IF NOT SalesHeader.Receive THEN
            ItemChargeSalesLine."Return Qty. to Receive" := 0;
          IF ItemChargeSalesLine."Shipment No." <> '' THEN BEGIN
            SalesShptLine.GET(ItemChargeSalesLine."Shipment No.",ItemChargeSalesLine."Shipment Line No.");
            QtyShippedNotInvd := "Qty. to Assign" - "Qty. Assigned";
          END ELSE
            QtyShippedNotInvd := ItemChargeSalesLine."Quantity Shipped";
          IF ItemChargeSalesLine."Return Receipt No." <> '' THEN BEGIN
            ReturnReceiptLine.GET(ItemChargeSalesLine."Return Receipt No.",ItemChargeSalesLine."Return Receipt Line No.");
            QtyReceivedNotInvd := "Qty. to Assign" - "Qty. Assigned";
          END ELSE
            QtyReceivedNotInvd := ItemChargeSalesLine."Return Qty. Received";
          IF ABS(ItemChargeSalesLine."Qty. to Invoice") >
             ABS(QtyShippedNotInvd + ItemChargeSalesLine."Qty. to Ship" +
               QtyReceivedNotInvd + ItemChargeSalesLine."Return Qty. to Receive" -
               ItemChargeSalesLine."Quantity Invoiced")
          THEN
            ItemChargeSalesLine."Qty. to Invoice" :=
              QtyShippedNotInvd + ItemChargeSalesLine."Qty. to Ship" +
              QtyReceivedNotInvd + ItemChargeSalesLine."Return Qty. to Receive" -
              ItemChargeSalesLine."Quantity Invoiced";
        END;
    END;

    LOCAL PROCEDURE CalcQtyToInvoice@24(QtyToHandle@1000 : Decimal;QtyToInvoice@1001 : Decimal) : Decimal;
    BEGIN
      IF ABS(QtyToHandle) > ABS(QtyToInvoice) THEN
        EXIT(-QtyToHandle);

      EXIT(-QtyToInvoice);
    END;

    LOCAL PROCEDURE CheckWarehouse@7301(VAR TempItemSalesLine@1000 : TEMPORARY Record 37);
    VAR
      WhseValidateSourceLine@1003 : Codeunit 5777;
      ShowError@1002 : Boolean;
    BEGIN
      WITH TempItemSalesLine DO BEGIN
        SETRANGE(Type,Type::Item);
        SETRANGE("Drop Shipment",FALSE);
        IF FINDSET THEN
          REPEAT
            GetLocation("Location Code");
            CASE "Document Type" OF
              "Document Type"::Order:
                IF ((Location."Require Receive" OR Location."Require Put-away") AND (Quantity < 0)) OR
                   ((Location."Require Shipment" OR Location."Require Pick") AND (Quantity >= 0))
                THEN BEGIN
                  IF Location."Directed Put-away and Pick" THEN
                    ShowError := TRUE
                  ELSE
                    IF WhseValidateSourceLine.WhseLinesExist(
                         DATABASE::"Sales Line","Document Type","Document No.","Line No.",0,Quantity)
                    THEN
                      ShowError := TRUE;
                END;
              "Document Type"::"Return Order":
                IF ((Location."Require Receive" OR Location."Require Put-away") AND (Quantity >= 0)) OR
                   ((Location."Require Shipment" OR Location."Require Pick") AND (Quantity < 0))
                THEN BEGIN
                  IF Location."Directed Put-away and Pick" THEN
                    ShowError := TRUE
                  ELSE
                    IF WhseValidateSourceLine.WhseLinesExist(
                         DATABASE::"Sales Line","Document Type","Document No.","Line No.",0,Quantity)
                    THEN
                      ShowError := TRUE;
                END;
              "Document Type"::Invoice,"Document Type"::"Credit Memo":
                IF Location."Directed Put-away and Pick" THEN
                  Location.TESTFIELD("Adjustment Bin Code");
            END;
            IF ShowError THEN
              ERROR(
                WarehouseRequiredErr,
                FIELDCAPTION("Document Type"),"Document Type",
                FIELDCAPTION("Document No."),"Document No.",
                FIELDCAPTION("Line No."),"Line No.");
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE CreateWhseJnlLine@7302(ItemJnlLine@1000 : Record 83;SalesLine@1001 : Record 37;VAR TempWhseJnlLine@1002 : TEMPORARY Record 7311);
    VAR
      WhseMgt@1003 : Codeunit 5775;
      WMSMgt@1004 : Codeunit 7302;
    BEGIN
      WITH SalesLine DO BEGIN
        WMSMgt.CheckAdjmtBin(Location,ItemJnlLine.Quantity,TRUE);
        WMSMgt.CreateWhseJnlLine(ItemJnlLine,0,TempWhseJnlLine,FALSE);
        TempWhseJnlLine."Source Type" := DATABASE::"Sales Line";
        TempWhseJnlLine."Source Subtype" := "Document Type";
        TempWhseJnlLine."Source Code" := SrcCode;
        TempWhseJnlLine."Source Document" := WhseMgt.GetSourceDocument(TempWhseJnlLine."Source Type",TempWhseJnlLine."Source Subtype");
        TempWhseJnlLine."Source No." := "Document No.";
        TempWhseJnlLine."Source Line No." := "Line No.";
        CASE "Document Type" OF
          "Document Type"::Order:
            TempWhseJnlLine."Reference Document" :=
              TempWhseJnlLine."Reference Document"::"Posted Shipment";
          "Document Type"::Invoice:
            TempWhseJnlLine."Reference Document" :=
              TempWhseJnlLine."Reference Document"::"Posted S. Inv.";
          "Document Type"::"Credit Memo":
            TempWhseJnlLine."Reference Document" :=
              TempWhseJnlLine."Reference Document"::"Posted S. Cr. Memo";
          "Document Type"::"Return Order":
            TempWhseJnlLine."Reference Document" :=
              TempWhseJnlLine."Reference Document"::"Posted Rtrn. Shipment";
        END;
        TempWhseJnlLine."Reference No." := ItemJnlLine."Document No.";
      END;
    END;

    LOCAL PROCEDURE WhseHandlingRequired@7307(SalesLine@1001 : Record 37) : Boolean;
    VAR
      WhseSetup@1000 : Record 5769;
      IsHandled@1002 : Boolean;
      Required@1003 : Boolean;
    BEGIN
      IsHandled := FALSE;
      OnBeforeWhseHandlingRequired(SalesLine,Required,IsHandled);
      IF IsHandled THEN
        EXIT(Required);

      IF (SalesLine.Type = SalesLine.Type::Item) AND (NOT SalesLine."Drop Shipment") THEN BEGIN
        IF SalesLine."Location Code" = '' THEN BEGIN
          WhseSetup.GET;
          IF SalesLine."Document Type" = SalesLine."Document Type"::"Return Order" THEN
            EXIT(WhseSetup."Require Receive");

          EXIT(WhseSetup."Require Shipment");
        END;

        GetLocation(SalesLine."Location Code");
        IF SalesLine."Document Type" = SalesLine."Document Type"::"Return Order" THEN
          EXIT(Location."Require Receive");

        EXIT(Location."Require Shipment");
      END;
      EXIT(FALSE);
    END;

    LOCAL PROCEDURE GetLocation@7300(LocationCode@1000 : Code[10]);
    BEGIN
      IF LocationCode = '' THEN
        Location.GetLocationSetup(LocationCode,Location)
      ELSE
        IF Location.Code <> LocationCode THEN
          Location.GET(LocationCode);
    END;

    LOCAL PROCEDURE InsertShptEntryRelation@38(VAR SalesShptLine@1002 : Record 111) : Integer;
    VAR
      ItemEntryRelation@1001 : Record 6507;
    BEGIN
      TempHandlingSpecification.CopySpecification(TempTrackingSpecificationInv);
      TempHandlingSpecification.CopySpecification(TempATOTrackingSpecification);
      TempHandlingSpecification.RESET;
      IF TempHandlingSpecification.FINDSET THEN BEGIN
        REPEAT
          ItemEntryRelation.InitFromTrackingSpec(TempHandlingSpecification);
          ItemEntryRelation.TransferFieldsSalesShptLine(SalesShptLine);
          ItemEntryRelation.INSERT;
        UNTIL TempHandlingSpecification.NEXT = 0;
        TempHandlingSpecification.DELETEALL;
        EXIT(0);
      END;
      EXIT(ItemLedgShptEntryNo);
    END;

    LOCAL PROCEDURE InsertReturnEntryRelation@39(VAR ReturnRcptLine@1002 : Record 6661) : Integer;
    VAR
      ItemEntryRelation@1001 : Record 6507;
    BEGIN
      TempHandlingSpecification.CopySpecification(TempTrackingSpecificationInv);
      TempHandlingSpecification.CopySpecification(TempATOTrackingSpecification);
      TempHandlingSpecification.RESET;
      IF TempHandlingSpecification.FINDSET THEN BEGIN
        REPEAT
          ItemEntryRelation.InitFromTrackingSpec(TempHandlingSpecification);
          ItemEntryRelation.TransferFieldsReturnRcptLine(ReturnRcptLine);
          ItemEntryRelation.INSERT;
        UNTIL TempHandlingSpecification.NEXT = 0;
        TempHandlingSpecification.DELETEALL;
        EXIT(0);
      END;
      EXIT(ItemLedgShptEntryNo);
    END;

    LOCAL PROCEDURE CheckTrackingSpecification@46(SalesHeader@1002 : Record 36;VAR TempItemSalesLine@1019 : TEMPORARY Record 37);
    VAR
      ReservationEntry@1001 : Record 337;
      ItemTrackingCode@1009 : Record 6502;
      ItemJnlLine@1006 : Record 83;
      CreateReservEntry@1004 : Codeunit 99000830;
      ItemTrackingManagement@1015 : Codeunit 6500;
      ErrorFieldCaption@1018 : Text[250];
      SignFactor@1005 : Integer;
      SalesLineQtyToHandle@1023 : Decimal;
      TrackingQtyToHandle@1003 : Decimal;
      Inbound@1010 : Boolean;
      SNRequired@1011 : Boolean;
      LotRequired@1012 : Boolean;
      SNInfoRequired@1013 : Boolean;
      LotInfoRequired@1014 : Boolean;
      CheckSalesLine@1008 : Boolean;
    BEGIN
      // if a SalesLine is posted with ItemTracking then tracked quantity must be equal to posted quantity
      IF NOT (SalesHeader."Document Type" IN
              [SalesHeader."Document Type"::Order,SalesHeader."Document Type"::"Return Order"])
      THEN
        EXIT;

      TrackingQtyToHandle := 0;

      WITH TempItemSalesLine DO BEGIN
        SETRANGE(Type,Type::Item);
        IF SalesHeader.Ship THEN BEGIN
          SETFILTER("Quantity Shipped",'<>%1',0);
          ErrorFieldCaption := FIELDCAPTION("Qty. to Ship");
        END ELSE BEGIN
          SETFILTER("Return Qty. Received",'<>%1',0);
          ErrorFieldCaption := FIELDCAPTION("Return Qty. to Receive");
        END;

        IF FINDSET THEN BEGIN
          ReservationEntry."Source Type" := DATABASE::"Sales Line";
          ReservationEntry."Source Subtype" := SalesHeader."Document Type";
          SignFactor := CreateReservEntry.SignFactor(ReservationEntry);
          REPEAT
            // Only Item where no SerialNo or LotNo is required
            GetItem(TempItemSalesLine);
            IF Item."Item Tracking Code" <> '' THEN BEGIN
              Inbound := (Quantity * SignFactor) > 0;
              ItemTrackingCode.Code := Item."Item Tracking Code";
              ItemTrackingManagement.GetItemTrackingSettings(ItemTrackingCode,
                ItemJnlLine."Entry Type"::Sale,Inbound,
                SNRequired,LotRequired,SNInfoRequired,LotInfoRequired);
              CheckSalesLine := NOT SNRequired AND NOT LotRequired;
              IF CheckSalesLine THEN
                CheckSalesLine := CheckTrackingExists(TempItemSalesLine);
            END ELSE
              CheckSalesLine := FALSE;

            TrackingQtyToHandle := 0;

            IF CheckSalesLine THEN BEGIN
              TrackingQtyToHandle := GetTrackingQuantities(TempItemSalesLine) * SignFactor;
              IF SalesHeader.Ship THEN
                SalesLineQtyToHandle := "Qty. to Ship (Base)"
              ELSE
                SalesLineQtyToHandle := "Return Qty. to Receive (Base)";
              IF TrackingQtyToHandle <> SalesLineQtyToHandle THEN
              //ERROR(ItemTrackQuantityMismatchErr,ErrorFieldCaption); //**4PS.o DP00121
                ERROR(ItemTrackQuantityMismatchErr,ErrorFieldCaption,TempItemSalesLine."No."); //**4PS.n DP00121
            END;
          UNTIL NEXT = 0;
        END;

        //**4PS.sn DP00121
        SETRANGE(Type,Type::"G/L Account");
        SETFILTER("Item No.", '<>%1', '');
        IF SalesHeader.Ship THEN
          ErrorFieldCaption := FIELDCAPTION("Qty. to Ship")
        ELSE
          ErrorFieldCaption := FIELDCAPTION("Return Qty. to Receive");

        IF FINDSET THEN BEGIN
          ReservationEntry."Source Type" := DATABASE::"Sales Line";
          ReservationEntry."Source Subtype" := SalesHeader."Document Type";
          SignFactor := CreateReservEntry.SignFactor(ReservationEntry);
          REPEAT
            // Only Item where no SerialNo or LotNo is required
            Item.GET("Item No.");
            IF Item."Item Tracking Code" <> '' THEN BEGIN
              Inbound := (Quantity * SignFactor) > 0;
              ItemTrackingCode.Code := Item."Item Tracking Code";
              ItemTrackingManagement.GetItemTrackingSettings(ItemTrackingCode,
                ItemJnlLine."Entry Type"::Sale,Inbound,
                SNRequired,LotRequired,SNInfoRequired,LotInfoRequired);
              CheckSalesLine := NOT SNRequired AND NOT LotRequired;
              IF CheckSalesLine THEN
                CheckSalesLine := CheckTrackingExists(TempItemSalesLine);
            END ELSE
              CheckSalesLine := FALSE;

            TrackingQtyToHandle := 0;

            IF CheckSalesLine THEN BEGIN
              TrackingQtyToHandle := GetTrackingQuantities(TempItemSalesLine) * SignFactor;
              IF SalesHeader.Ship THEN
                SalesLineQtyToHandle := "Qty. to Ship (Base)"
              ELSE
                SalesLineQtyToHandle := "Return Qty. to Receive (Base)";
              IF TrackingQtyToHandle <> SalesLineQtyToHandle THEN
                ERROR(STRSUBSTNO(ItemTrackQuantityMismatchErr,ErrorFieldCaption,TempItemSalesLine."Item No."));
            END;
          UNTIL NEXT = 0;
        END;
        SETRANGE(Type);
        SETRANGE("Item No.");
        //**4PS.en

        IF SalesHeader.Ship THEN
          SETRANGE("Quantity Shipped")
        ELSE
          SETRANGE("Return Qty. Received");
      END;
    END;

    LOCAL PROCEDURE CheckTrackingExists@168(SalesLine@1000 : Record 37) : Boolean;
    BEGIN
      EXIT(
        ItemTrackingMgt.ItemTrackingExistsOnDocumentLine(
          DATABASE::"Sales Line",SalesLine."Document Type",SalesLine."Document No.",SalesLine."Line No."));
    END;

    LOCAL PROCEDURE GetTrackingQuantities@47(SalesLine@1000 : Record 37) : Decimal;
    BEGIN
      EXIT(
        ItemTrackingMgt.CalcQtyToHandleForTrackedQtyOnDocumentLine(
          DATABASE::"Sales Line",SalesLine."Document Type",SalesLine."Document No.",SalesLine."Line No."));
    END;

    LOCAL PROCEDURE SaveInvoiceSpecification@37(VAR TempInvoicingSpecification@1000 : TEMPORARY Record 336);
    BEGIN
      TempInvoicingSpecification.RESET;
      IF TempInvoicingSpecification.FINDSET THEN BEGIN
        REPEAT
          TempInvoicingSpecification."Quantity Invoiced (Base)" += TempInvoicingSpecification."Quantity actual Handled (Base)";
          TempInvoicingSpecification."Quantity actual Handled (Base)" := 0;
          TempTrackingSpecification := TempInvoicingSpecification;
          TempTrackingSpecification."Buffer Status" := TempTrackingSpecification."Buffer Status"::MODIFY;
          IF NOT TempTrackingSpecification.INSERT THEN BEGIN
            TempTrackingSpecification.GET(TempInvoicingSpecification."Entry No.");
            TempTrackingSpecification."Qty. to Invoice (Base)" += TempInvoicingSpecification."Qty. to Invoice (Base)";
            TempTrackingSpecification."Quantity Invoiced (Base)" += TempInvoicingSpecification."Qty. to Invoice (Base)";
            TempTrackingSpecification."Qty. to Invoice" += TempInvoicingSpecification."Qty. to Invoice";
            TempTrackingSpecification.MODIFY;
          END;
        UNTIL TempInvoicingSpecification.NEXT = 0;
        TempInvoicingSpecification.DELETEALL;
      END;
    END;

    LOCAL PROCEDURE InsertTrackingSpecification@35(SalesHeader@1001 : Record 36);
    BEGIN
      TempTrackingSpecification.RESET;
      IF NOT TempTrackingSpecification.ISEMPTY THEN BEGIN
        TempTrackingSpecification.InsertSpecification;
        ReserveSalesLine.UpdateItemTrackingAfterPosting(SalesHeader);
      END;
    END;

    LOCAL PROCEDURE InsertValueEntryRelation@40();
    VAR
      ValueEntryRelation@1000 : Record 6508;
    BEGIN
      TempValueEntryRelation.RESET;
      IF TempValueEntryRelation.FINDSET THEN BEGIN
        REPEAT
          ValueEntryRelation := TempValueEntryRelation;
          ValueEntryRelation.INSERT;
        UNTIL TempValueEntryRelation.NEXT = 0;
        TempValueEntryRelation.DELETEALL;
      END;
    END;

    LOCAL PROCEDURE SetPaymentInstructions@1515(SalesHeader@1001 : Record 36);
    VAR
      O365PaymentInstructions@1002 : Record 2155;
      TempBlob@1003 : TEMPORARY Record 99008535;
    BEGIN
      IF NOT O365PaymentInstructions.GET(SalesHeader."Payment Instructions Id") THEN
        EXIT;

      O365PaymentInstructions.CopyInstructionsInCurrentLanguageToBlob(TempBlob);
      SalesInvHeader."Payment Instructions" := TempBlob.Blob;
      SalesInvHeader."Payment Instructions Name" := O365PaymentInstructions.GetNameInCurrentLanguage;
    END;

    LOCAL PROCEDURE PostItemCharge@42(SalesHeader@1010 : Record 36;VAR SalesLine@1005 : Record 37;ItemEntryNo@1004 : Integer;QuantityBase@1003 : Decimal;AmountToAssign@1002 : Decimal;QtyToAssign@1001 : Decimal);
    VAR
      DummyTrackingSpecification@1000 : Record 336;
      SalesLineToPost@1006 : Record 37;
      CurrExchRate@1007 : Record 330;
    BEGIN
      WITH TempItemChargeAssgntSales DO BEGIN
        SalesLineToPost := SalesLine;
        SalesLineToPost."No." := "Item No.";
        SalesLineToPost."Appl.-to Item Entry" := ItemEntryNo;
        IF NOT ("Document Type" IN ["Document Type"::"Return Order","Document Type"::"Credit Memo"]) THEN
          SalesLineToPost.Amount := -AmountToAssign
        ELSE
          SalesLineToPost.Amount := AmountToAssign;

        IF SalesLineToPost."Currency Code" <> '' THEN
          SalesLineToPost."Unit Cost" := ROUND(
              SalesLineToPost.Amount / QuantityBase,Currency."Unit-Amount Rounding Precision")
        ELSE
          SalesLineToPost."Unit Cost" := ROUND(
              SalesLineToPost.Amount / QuantityBase,GLSetup."Unit-Amount Rounding Precision");
        TotalChargeAmt := TotalChargeAmt + SalesLineToPost.Amount;

        IF SalesHeader."Currency Code" <> '' THEN
          SalesLineToPost.Amount :=
            CurrExchRate.ExchangeAmtFCYToLCY(
              0, '', //**4PS.n
      //      UseDate,SalesHeader."Currency Code",TotalChargeAmt,SalesHeader."Currency Factor"); //**4PS.o
              UseDate,SalesHeader."Currency Code",TotalChargeAmt,SalesHeader."Currency Factor",TRUE); //**4PS.n
        SalesLineToPost."Inv. Discount Amount" := ROUND(
            SalesLine."Inv. Discount Amount" / SalesLine.Quantity * QtyToAssign,
            GLSetup."Amount Rounding Precision");
        SalesLineToPost."Line Discount Amount" := ROUND(
            SalesLine."Line Discount Amount" / SalesLine.Quantity * QtyToAssign,
            GLSetup."Amount Rounding Precision");
        SalesLineToPost."Line Amount" := ROUND(
            SalesLine."Line Amount" / SalesLine.Quantity * QtyToAssign,
            GLSetup."Amount Rounding Precision");
        SalesLine."Inv. Discount Amount" := SalesLine."Inv. Discount Amount" - SalesLineToPost."Inv. Discount Amount";
        SalesLine."Line Discount Amount" := SalesLine."Line Discount Amount" - SalesLineToPost."Line Discount Amount";
        SalesLine."Line Amount" := SalesLine."Line Amount" - SalesLineToPost."Line Amount";
        SalesLine.Quantity := SalesLine.Quantity - QtyToAssign;
        SalesLineToPost.Amount := ROUND(SalesLineToPost.Amount,GLSetup."Amount Rounding Precision") - TotalChargeAmtLCY;
        IF SalesHeader."Currency Code" <> '' THEN
          TotalChargeAmtLCY := TotalChargeAmtLCY + SalesLineToPost.Amount;
        SalesLineToPost."Unit Cost (LCY)" := ROUND(
            SalesLineToPost.Amount / QuantityBase,GLSetup."Unit-Amount Rounding Precision");
        UpdateSalesLineDimSetIDFromAppliedEntry(SalesLineToPost,SalesLine);
        SalesLineToPost."Line No." := "Document Line No.";

        OnPostItemChargeOnBeforePostItemJnlLine(SalesLineToPost,SalesLine,QtyToAssign);

        PostItemJnlLine(
          SalesHeader,SalesLineToPost,0,0,-QuantityBase,-QuantityBase,
          SalesLineToPost."Appl.-to Item Entry","Item Charge No.",DummyTrackingSpecification,FALSE);
      END;
    END;

    LOCAL PROCEDURE SaveTempWhseSplitSpec@31(VAR SalesLine3@1000 : Record 37;VAR TempSrcTrackingSpec@1001 : TEMPORARY Record 336);
    BEGIN
      TempWhseSplitSpecification.RESET;
      TempWhseSplitSpecification.DELETEALL;
      IF TempSrcTrackingSpec.FINDSET THEN
        REPEAT
          TempWhseSplitSpecification := TempSrcTrackingSpec;
          TempWhseSplitSpecification.SetSource(
            DATABASE::"Sales Line",SalesLine3."Document Type",SalesLine3."Document No.",SalesLine3."Line No.",'',0);
          TempWhseSplitSpecification.INSERT;
        UNTIL TempSrcTrackingSpec.NEXT = 0;
    END;

    LOCAL PROCEDURE TransferReservToItemJnlLine@32(VAR SalesOrderLine@1000 : Record 37;VAR ItemJnlLine@1001 : Record 83;QtyToBeShippedBase@1002 : Decimal;VAR TempTrackingSpecification2@1003 : TEMPORARY Record 336;VAR CheckApplFromItemEntry@1004 : Boolean);
    VAR
      RemainingQuantity@1005 : Decimal;
    BEGIN
      // Handle Item Tracking and reservations, also on drop shipment
      IF QtyToBeShippedBase = 0 THEN
        EXIT;

      CLEAR(ReserveSalesLine);
      IF NOT SalesOrderLine."Drop Shipment" THEN
        IF NOT HasSpecificTracking(SalesOrderLine."No.") AND HasInvtPickLine(SalesOrderLine) THEN
          ReserveSalesLine.TransferSalesLineToItemJnlLine(
            SalesOrderLine,ItemJnlLine,QtyToBeShippedBase,CheckApplFromItemEntry,TRUE)
        ELSE
          ReserveSalesLine.TransferSalesLineToItemJnlLine(
            SalesOrderLine,ItemJnlLine,QtyToBeShippedBase,CheckApplFromItemEntry,FALSE)
      ELSE BEGIN
        ReserveSalesLine.SetApplySpecificItemTracking(TRUE);
        TempTrackingSpecification2.RESET;
        TempTrackingSpecification2.SetSourceFilter(
          DATABASE::"Purchase Line",1,SalesOrderLine."Purchase Order No.",SalesOrderLine."Purch. Order Line No.",FALSE);
        TempTrackingSpecification2.SetSourceFilter2('',0);
        IF TempTrackingSpecification2.ISEMPTY THEN
          ReserveSalesLine.TransferSalesLineToItemJnlLine(
            SalesOrderLine,ItemJnlLine,QtyToBeShippedBase,CheckApplFromItemEntry,FALSE)
        ELSE BEGIN
          ReserveSalesLine.SetOverruleItemTracking(TRUE);
          ReserveSalesLine.SetItemTrkgAlreadyOverruled(ItemTrkgAlreadyOverruled);
          TempTrackingSpecification2.FINDSET;
          IF TempTrackingSpecification2."Quantity (Base)" / QtyToBeShippedBase < 0 THEN
            ERROR(ItemTrackingWrongSignErr);
          REPEAT
            ItemJnlLine.CopyTrackingFromSpec(TempTrackingSpecification2);
            ItemJnlLine."Applies-to Entry" := TempTrackingSpecification2."Item Ledger Entry No.";
            RemainingQuantity :=
              ReserveSalesLine.TransferSalesLineToItemJnlLine(
                SalesOrderLine,ItemJnlLine,TempTrackingSpecification2."Quantity (Base)",CheckApplFromItemEntry,FALSE);
            IF RemainingQuantity <> 0 THEN
              ERROR(ItemTrackingMismatchErr);
          UNTIL TempTrackingSpecification2.NEXT = 0;
          ItemJnlLine.ClearTracking;
          ItemJnlLine."Applies-to Entry" := 0;
        END;
      END;
    END;

    LOCAL PROCEDURE TransferReservFromPurchLine@41(VAR PurchOrderLine@1000 : Record 39;VAR ItemJnlLine@1001 : Record 83;SalesLine@1008 : Record 37;QtyToBeShippedBase@1002 : Decimal);
    VAR
      ReservEntry@1004 : Record 337;
      TempTrackingSpecification2@1005 : TEMPORARY Record 336;
      ReservePurchLine@1003 : Codeunit 99000834;
      RemainingQuantity@1006 : Decimal;
      CheckApplToItemEntry@1007 : Boolean;
    BEGIN
      // Handle Item Tracking on Drop Shipment
      ItemTrkgAlreadyOverruled := FALSE;
      IF QtyToBeShippedBase = 0 THEN
        EXIT;

      ReservEntry.SetSourceFilter(
        DATABASE::"Sales Line",SalesLine."Document Type",SalesLine."Document No.",SalesLine."Line No.",TRUE);
      ReservEntry.SetSourceFilter2('',0);
      ReservEntry.SETFILTER("Qty. to Handle (Base)",'<>0');
      IF NOT ReservEntry.ISEMPTY THEN
        ItemTrackingMgt.SumUpItemTracking(ReservEntry,TempTrackingSpecification2,FALSE,TRUE);
      TempTrackingSpecification2.SETFILTER("Qty. to Handle (Base)",'<>0');
      IF TempTrackingSpecification2.ISEMPTY THEN BEGIN
        ReserveSalesLine.SetApplySpecificItemTracking(TRUE);
        ReservePurchLine.TransferPurchLineToItemJnlLine(
          PurchOrderLine,ItemJnlLine,QtyToBeShippedBase,CheckApplToItemEntry)
      END ELSE BEGIN
        ReservePurchLine.SetOverruleItemTracking(TRUE);
        ItemTrkgAlreadyOverruled := TRUE;
        TempTrackingSpecification2.FINDSET;
        IF -TempTrackingSpecification2."Quantity (Base)" / QtyToBeShippedBase < 0 THEN
          ERROR(ItemTrackingWrongSignErr);
        IF ReservePurchLine.ReservEntryExist(PurchOrderLine) THEN
          REPEAT
            ItemJnlLine.CopyTrackingFromSpec(TempTrackingSpecification2);
            RemainingQuantity :=
              ReservePurchLine.TransferPurchLineToItemJnlLine(
                PurchOrderLine,ItemJnlLine,
                -TempTrackingSpecification2."Qty. to Handle (Base)",CheckApplToItemEntry);
            IF RemainingQuantity <> 0 THEN
              ERROR(ItemTrackingMismatchErr);
          UNTIL TempTrackingSpecification2.NEXT = 0;
        ItemJnlLine.ClearTracking;
        ItemJnlLine."Applies-to Entry" := 0;
      END;
    END;

    [External]
    PROCEDURE SetWhseRcptHeader@43(VAR WhseRcptHeader2@1000 : Record 7316);
    BEGIN
      WhseRcptHeader := WhseRcptHeader2;
      TempWhseRcptHeader := WhseRcptHeader;
      TempWhseRcptHeader.INSERT;
    END;

    [External]
    PROCEDURE SetWhseShptHeader@44(VAR WhseShptHeader2@1000 : Record 7320);
    BEGIN
      WhseShptHeader := WhseShptHeader2;
      TempWhseShptHeader := WhseShptHeader;
      TempWhseShptHeader.INSERT;
    END;

    LOCAL PROCEDURE GetItem@49(SalesLine@1000 : Record 37);
    BEGIN
      WITH SalesLine DO BEGIN
        TESTFIELD(Type,Type::Item);
        TESTFIELD("No.");
        IF "No." <> Item."No." THEN
          Item.GET("No.");
      END;
    END;

    LOCAL PROCEDURE CreatePrepaymentLines@51(SalesHeader@1003 : Record 36;CompleteFunctionality@1009 : Boolean);
    VAR
      GLAcc@1002 : Record 15;
      TempSalesLine@1000 : TEMPORARY Record 37;
      TempExtTextLine@1012 : TEMPORARY Record 280;
      GenPostingSetup@1005 : Record 252;
      TempPrepmtSalesLine@1004 : TEMPORARY Record 37;
      TransferExtText@1011 : Codeunit 378;
      NextLineNo@1001 : Integer;
      Fraction@1008 : Decimal;
      VATDifference@1015 : Decimal;
      TempLineFound@1010 : Boolean;
      PrepmtAmtToDeduct@1016 : Decimal;
      IsHandled@1006 : Boolean;
    BEGIN
      IsHandled := FALSE;
      OnBeforeCreatePrepaymentLines(SalesHeader,TempPrepmtSalesLine,CompleteFunctionality,IsHandled);
      IF IsHandled THEN
        EXIT;

      GetGLSetup;
      WITH TempSalesLine DO BEGIN
        FillTempLines(SalesHeader,TempSalesLineGlobal);
        ResetTempLines(TempSalesLine);
        IF NOT FINDLAST THEN
          EXIT;
        NextLineNo := "Line No." + 10000;
        SETFILTER(Quantity,'>0');
        SETFILTER("Qty. to Invoice",'>0');
        TempPrepmtSalesLine.SetHasBeenShown;
        IF FINDSET THEN BEGIN
          IF CompleteFunctionality AND ("Document Type" = "Document Type"::Invoice) THEN
            TestGetShipmentPPmtAmtToDeduct;
          REPEAT
            IF CompleteFunctionality THEN
              IF SalesHeader."Document Type" <> SalesHeader."Document Type"::Invoice THEN BEGIN
                IF NOT SalesHeader.Ship AND ("Qty. to Invoice" = Quantity - "Quantity Invoiced") THEN
                  IF "Qty. Shipped Not Invoiced" < "Qty. to Invoice" THEN
                    VALIDATE("Qty. to Invoice","Qty. Shipped Not Invoiced");
                Fraction := ("Qty. to Invoice" + "Quantity Invoiced") / Quantity;

                IF "Prepayment %" <> 100 THEN
                  CASE TRUE OF
                    ("Prepmt Amt to Deduct" <> 0) AND
                    ("Prepmt Amt to Deduct" > ROUND(Fraction * "Line Amount",Currency."Amount Rounding Precision")):
                      FIELDERROR(
                        "Prepmt Amt to Deduct",
                        STRSUBSTNO(CannotBeGreaterThanErr,
                          ROUND(Fraction * "Line Amount",Currency."Amount Rounding Precision")));
                    ("Prepmt. Amt. Inv." <> 0) AND
                    (ROUND((1 - Fraction) * "Line Amount",Currency."Amount Rounding Precision") <
                     ROUND(
                       ROUND(
      //                 ROUND("Unit Price" * (Quantity - "Quantity Invoiced" - "Qty. to Invoice"), //**4PS.o
                         ROUND("Unit Price" * (Quantity - "Quantity Invoiced" - "Qty. to Invoice") * DimensionalFactor, //**4PS.n
                           Currency."Amount Rounding Precision") *
                         (1 - ("Line Discount %" / 100)),Currency."Amount Rounding Precision") *
                       "Prepayment %" / 100,Currency."Amount Rounding Precision")):
                      FIELDERROR(
                        "Prepmt Amt to Deduct",
                        STRSUBSTNO(CannotBeSmallerThanErr,
                          ROUND(
                            "Prepmt. Amt. Inv." - "Prepmt Amt Deducted" - (1 - Fraction) * "Line Amount",
                            Currency."Amount Rounding Precision")));
                  END;
              END;
            IF "Prepmt Amt to Deduct" <> 0 THEN BEGIN
              IF ("Gen. Bus. Posting Group" <> GenPostingSetup."Gen. Bus. Posting Group") OR
                 ("Gen. Prod. Posting Group" <> GenPostingSetup."Gen. Prod. Posting Group")
              THEN
                GenPostingSetup.GET("Gen. Bus. Posting Group","Gen. Prod. Posting Group");
              GLAcc.GET(GenPostingSetup.GetSalesPrepmtAccount);
              TempLineFound := FALSE;
              IF SalesHeader."Compress Prepayment" THEN BEGIN
                TempPrepmtSalesLine.SETRANGE("No.",GLAcc."No.");
                TempPrepmtSalesLine.SETRANGE("Dimension Set ID","Dimension Set ID");
                TempLineFound := TempPrepmtSalesLine.FINDFIRST;
              END;
              IF TempLineFound THEN BEGIN
                PrepmtAmtToDeduct :=
                  TempPrepmtSalesLine."Prepmt Amt to Deduct" +
                  InsertedPrepmtVATBaseToDeduct(
                    SalesHeader,TempSalesLine,TempPrepmtSalesLine."Line No.",TempPrepmtSalesLine."Unit Price");
                VATDifference := TempPrepmtSalesLine."VAT Difference";
                TempPrepmtSalesLine.VALIDATE(
                  "Unit Price",TempPrepmtSalesLine."Unit Price" + "Prepmt Amt to Deduct");
                TempPrepmtSalesLine.VALIDATE("VAT Difference",VATDifference - "Prepmt VAT Diff. to Deduct");
                TempPrepmtSalesLine."Prepmt Amt to Deduct" := PrepmtAmtToDeduct;
                IF "Prepayment %" < TempPrepmtSalesLine."Prepayment %" THEN
                  TempPrepmtSalesLine."Prepayment %" := "Prepayment %";
                OnBeforeTempPrepmtSalesLineModify(TempPrepmtSalesLine,TempSalesLine,SalesHeader,CompleteFunctionality);
                TempPrepmtSalesLine.MODIFY;
              END ELSE BEGIN
                TempPrepmtSalesLine.INIT;
                TempPrepmtSalesLine."Document Type" := SalesHeader."Document Type";
                TempPrepmtSalesLine."Document No." := SalesHeader."No.";
                TempPrepmtSalesLine."Line No." := 0;
                TempPrepmtSalesLine."System-Created Entry" := TRUE;
                IF CompleteFunctionality THEN
                  TempPrepmtSalesLine.VALIDATE(Type,TempPrepmtSalesLine.Type::"G/L Account")
                ELSE
                  TempPrepmtSalesLine.Type := TempPrepmtSalesLine.Type::"G/L Account";
                TempPrepmtSalesLine.VALIDATE("No.",GenPostingSetup."Sales Prepayments Account");
                TempPrepmtSalesLine.VALIDATE(Quantity,-1);
                TempPrepmtSalesLine."Qty. to Ship" := TempPrepmtSalesLine.Quantity;
                TempPrepmtSalesLine."Qty. to Invoice" := TempPrepmtSalesLine.Quantity;
                PrepmtAmtToDeduct := InsertedPrepmtVATBaseToDeduct(SalesHeader,TempSalesLine,NextLineNo,0);
                TempPrepmtSalesLine.VALIDATE("Unit Price","Prepmt Amt to Deduct");
                TempPrepmtSalesLine.VALIDATE("VAT Difference",-"Prepmt VAT Diff. to Deduct");
                TempPrepmtSalesLine."Prepmt Amt to Deduct" := PrepmtAmtToDeduct;
                TempPrepmtSalesLine."Prepayment %" := "Prepayment %";
                TempPrepmtSalesLine."Prepayment Line" := TRUE;
                TempPrepmtSalesLine."Shortcut Dimension 1 Code" := "Shortcut Dimension 1 Code";
                TempPrepmtSalesLine."Shortcut Dimension 2 Code" := "Shortcut Dimension 2 Code";
                TempPrepmtSalesLine."Dimension Set ID" := "Dimension Set ID";
                TempPrepmtSalesLine."Line No." := NextLineNo;
                NextLineNo := NextLineNo + 10000;
                OnBeforeTempPrepmtSalesLineInsert(TempPrepmtSalesLine,TempSalesLine,SalesHeader,CompleteFunctionality);
                TempPrepmtSalesLine.INSERT;

                TransferExtText.PrepmtGetAnyExtText(
                  TempPrepmtSalesLine."No.",DATABASE::"Sales Invoice Line",
                  SalesHeader."Document Date",SalesHeader."Language Code",TempExtTextLine);
                IF TempExtTextLine.FIND('-') THEN
                  REPEAT
                    TempPrepmtSalesLine.INIT;
                    TempPrepmtSalesLine.Description := TempExtTextLine.Text;
                    TempPrepmtSalesLine."System-Created Entry" := TRUE;
                    TempPrepmtSalesLine."Prepayment Line" := TRUE;
                    TempPrepmtSalesLine."Line No." := NextLineNo;
                    NextLineNo := NextLineNo + 10000;
                    TempPrepmtSalesLine.INSERT;
                  UNTIL TempExtTextLine.NEXT = 0;
              END;
            END;
          UNTIL NEXT = 0
        END;
      END;
      DividePrepmtAmountLCY(TempPrepmtSalesLine,SalesHeader);
      IF TempPrepmtSalesLine.FINDSET THEN
        REPEAT
          TempSalesLineGlobal := TempPrepmtSalesLine;
          TempSalesLineGlobal.INSERT;
        UNTIL TempPrepmtSalesLine.NEXT = 0;
    END;

    LOCAL PROCEDURE InsertedPrepmtVATBaseToDeduct@82(SalesHeader@1004 : Record 36;SalesLine@1000 : Record 37;PrepmtLineNo@1001 : Integer;TotalPrepmtAmtToDeduct@1002 : Decimal) : Decimal;
    VAR
      PrepmtVATBaseToDeduct@1003 : Decimal;
    BEGIN
      WITH SalesLine DO BEGIN
        IF SalesHeader."Prices Including VAT" THEN
          PrepmtVATBaseToDeduct :=
            ROUND(
              (TotalPrepmtAmtToDeduct + "Prepmt Amt to Deduct") / (1 + "Prepayment VAT %" / 100),
              Currency."Amount Rounding Precision") -
            ROUND(
              TotalPrepmtAmtToDeduct / (1 + "Prepayment VAT %" / 100),
              Currency."Amount Rounding Precision")
        ELSE
          PrepmtVATBaseToDeduct := "Prepmt Amt to Deduct";
      END;
      WITH TempPrepmtDeductLCYSalesLine DO BEGIN
        TempPrepmtDeductLCYSalesLine := SalesLine;
        IF "Document Type" = "Document Type"::Order THEN
          "Qty. to Invoice" := GetQtyToInvoice(SalesLine,SalesHeader.Ship)
        ELSE
          GetLineDataFromOrder(TempPrepmtDeductLCYSalesLine);
        IF ("Prepmt Amt to Deduct" = 0) OR ("Document Type" = "Document Type"::Invoice) THEN
          CalcPrepaymentToDeduct;
        "Line Amount" := GetLineAmountToHandleInclPrepmt("Qty. to Invoice");
        "Attached to Line No." := PrepmtLineNo;
        "VAT Base Amount" := PrepmtVATBaseToDeduct;
        INSERT;
      END;

      OnAfterInsertedPrepmtVATBaseToDeduct(
        SalesHeader,SalesLine,PrepmtLineNo,TotalPrepmtAmtToDeduct,TempPrepmtDeductLCYSalesLine,PrepmtVATBaseToDeduct);

      EXIT(PrepmtVATBaseToDeduct);
    END;

    LOCAL PROCEDURE DividePrepmtAmountLCY@83(VAR PrepmtSalesLine@1000 : Record 37;SalesHeader@1006 : Record 36);
    VAR
      CurrExchRate@1001 : Record 330;
      ActualCurrencyFactor@1002 : Decimal;
    BEGIN
      WITH PrepmtSalesLine DO BEGIN
        RESET;
        SETFILTER(Type,'<>%1',Type::" ");
        IF FINDSET THEN
          REPEAT
            IF SalesHeader."Currency Code" <> '' THEN
              ActualCurrencyFactor :=
                ROUND(
                  CurrExchRate.ExchangeAmtFCYToLCY(
                    0, '', //**4PS.n
                    SalesHeader."Posting Date",
                    SalesHeader."Currency Code",
                    "Prepmt Amt to Deduct",
                  //SalesHeader."Currency Factor")) / //**4PS.o
                    SalesHeader."Currency Factor",TRUE)) /  //**4PS.n
                "Prepmt Amt to Deduct"
            ELSE
              ActualCurrencyFactor := 1;

            UpdatePrepmtAmountInvBuf("Line No.",ActualCurrencyFactor);
          UNTIL NEXT = 0;
        RESET;
      END;
    END;

    LOCAL PROCEDURE UpdatePrepmtAmountInvBuf@92(PrepmtSalesLineNo@1000 : Integer;CurrencyFactor@1004 : Decimal);
    VAR
      PrepmtAmtRemainder@1002 : Decimal;
    BEGIN
      WITH TempPrepmtDeductLCYSalesLine DO BEGIN
        RESET;
        SETRANGE("Attached to Line No.",PrepmtSalesLineNo);
        IF FINDSET(TRUE) THEN
          REPEAT
            "Prepmt. Amount Inv. (LCY)" :=
              CalcRoundedAmount(CurrencyFactor * "VAT Base Amount",PrepmtAmtRemainder);
            MODIFY;
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE AdjustPrepmtAmountLCY@84(SalesHeader@1006 : Record 36;VAR PrepmtSalesLine@1000 : Record 37);
    VAR
      SalesLine@1005 : Record 37;
      SalesInvoiceLine@1013 : Record 37;
      DeductionFactor@1001 : Decimal;
      PrepmtVATPart@1009 : Decimal;
      PrepmtVATAmtRemainder@1010 : Decimal;
      TotalRoundingAmount@1011 : ARRAY [2] OF Decimal;
      TotalPrepmtAmount@1002 : ARRAY [2] OF Decimal;
      FinalInvoice@1003 : Boolean;
      PricesInclVATRoundingAmount@1004 : ARRAY [2] OF Decimal;
    BEGIN
      IF PrepmtSalesLine."Prepayment Line" THEN BEGIN
        PrepmtVATPart :=
          (PrepmtSalesLine."Amount Including VAT" - PrepmtSalesLine.Amount) / PrepmtSalesLine."Unit Price";

        WITH TempPrepmtDeductLCYSalesLine DO BEGIN
          RESET;
          SETRANGE("Attached to Line No.",PrepmtSalesLine."Line No.");
          IF FINDSET(TRUE) THEN BEGIN
            FinalInvoice := IsFinalInvoice;
            REPEAT
              SalesLine := TempPrepmtDeductLCYSalesLine;
              SalesLine.FIND;
              IF "Document Type" = "Document Type"::Invoice THEN BEGIN
                SalesInvoiceLine := SalesLine;
                GetSalesOrderLine(SalesLine,SalesInvoiceLine);
                SalesLine."Qty. to Invoice" := SalesInvoiceLine."Qty. to Invoice";
              END;
              IF SalesLine."Qty. to Invoice" <> "Qty. to Invoice" THEN
                SalesLine."Prepmt Amt to Deduct" := CalcPrepmtAmtToDeduct(SalesLine,SalesHeader.Ship);
              DeductionFactor :=
                SalesLine."Prepmt Amt to Deduct" /
                (SalesLine."Prepmt. Amt. Inv." - SalesLine."Prepmt Amt Deducted");

              "Prepmt. VAT Amount Inv. (LCY)" :=
                CalcRoundedAmount(SalesLine."Prepmt Amt to Deduct" * PrepmtVATPart,PrepmtVATAmtRemainder);
              IF ("Prepayment %" <> 100) OR IsFinalInvoice OR ("Currency Code" <> '') THEN
                CalcPrepmtRoundingAmounts(TempPrepmtDeductLCYSalesLine,SalesLine,DeductionFactor,TotalRoundingAmount);
              MODIFY;

              IF SalesHeader."Prices Including VAT" THEN
                IF (("Prepayment %" <> 100) OR IsFinalInvoice) AND (DeductionFactor = 1) THEN BEGIN
                  PricesInclVATRoundingAmount[1] := TotalRoundingAmount[1];
                  PricesInclVATRoundingAmount[2] := TotalRoundingAmount[2];
                END;

              IF "VAT Calculation Type" <> "VAT Calculation Type"::"Full VAT" THEN
                TotalPrepmtAmount[1] += "Prepmt. Amount Inv. (LCY)";
              TotalPrepmtAmount[2] += "Prepmt. VAT Amount Inv. (LCY)";
              FinalInvoice := FinalInvoice AND IsFinalInvoice;
            UNTIL NEXT = 0;
          END;
        END;

        UpdatePrepmtSalesLineWithRounding(
          PrepmtSalesLine,TotalRoundingAmount,TotalPrepmtAmount,
          FinalInvoice,PricesInclVATRoundingAmount);
      END;
    END;

    LOCAL PROCEDURE CalcPrepmtAmtToDeduct@93(SalesLine@1000 : Record 37;Ship@1001 : Boolean) : Decimal;
    BEGIN
      WITH SalesLine DO BEGIN
        "Qty. to Invoice" := GetQtyToInvoice(SalesLine,Ship);
        CalcPrepaymentToDeduct;
        EXIT("Prepmt Amt to Deduct");
      END;
    END;

    LOCAL PROCEDURE GetQtyToInvoice@100(SalesLine@1000 : Record 37;Ship@1002 : Boolean) : Decimal;
    VAR
      AllowedQtyToInvoice@1001 : Decimal;
    BEGIN
      WITH SalesLine DO BEGIN
        AllowedQtyToInvoice := "Qty. Shipped Not Invoiced";
        IF Ship THEN
          AllowedQtyToInvoice := AllowedQtyToInvoice + "Qty. to Ship";
        IF "Qty. to Invoice" > AllowedQtyToInvoice THEN
          EXIT(AllowedQtyToInvoice);
        EXIT("Qty. to Invoice");
      END;
    END;

    LOCAL PROCEDURE GetLineDataFromOrder@94(VAR SalesLine@1000 : Record 37);
    VAR
      SalesShptLine@1001 : Record 111;
      SalesOrderLine@1002 : Record 37;
    BEGIN
      WITH SalesLine DO BEGIN
        SalesShptLine.GET("Shipment No.","Shipment Line No.");
        SalesOrderLine.GET("Document Type"::Order,SalesShptLine."Order No.",SalesShptLine."Order Line No.");

        Quantity := SalesOrderLine.Quantity;
        "Qty. Shipped Not Invoiced" := SalesOrderLine."Qty. Shipped Not Invoiced";
        "Quantity Invoiced" := SalesOrderLine."Quantity Invoiced";
        "Prepmt Amt Deducted" := SalesOrderLine."Prepmt Amt Deducted";
        "Prepmt. Amt. Inv." := SalesOrderLine."Prepmt. Amt. Inv.";
        "Line Discount Amount" := SalesOrderLine."Line Discount Amount";
      END;
    END;

    LOCAL PROCEDURE CalcPrepmtRoundingAmounts@79(VAR PrepmtSalesLineBuf@1000 : Record 37;SalesLine@1003 : Record 37;DeductionFactor@1001 : Decimal;VAR TotalRoundingAmount@1002 : ARRAY [2] OF Decimal);
    VAR
      RoundingAmount@1004 : ARRAY [2] OF Decimal;
    BEGIN
      WITH PrepmtSalesLineBuf DO BEGIN
        IF "VAT Calculation Type" <> "VAT Calculation Type"::"Full VAT" THEN BEGIN
          RoundingAmount[1] :=
            "Prepmt. Amount Inv. (LCY)" - ROUND(DeductionFactor * SalesLine."Prepmt. Amount Inv. (LCY)");
          "Prepmt. Amount Inv. (LCY)" := "Prepmt. Amount Inv. (LCY)" - RoundingAmount[1];
          TotalRoundingAmount[1] += RoundingAmount[1];
        END;
        RoundingAmount[2] :=
          "Prepmt. VAT Amount Inv. (LCY)" - ROUND(DeductionFactor * SalesLine."Prepmt. VAT Amount Inv. (LCY)");
        "Prepmt. VAT Amount Inv. (LCY)" := "Prepmt. VAT Amount Inv. (LCY)" - RoundingAmount[2];
        TotalRoundingAmount[2] += RoundingAmount[2];
      END;
    END;

    LOCAL PROCEDURE UpdatePrepmtSalesLineWithRounding@89(VAR PrepmtSalesLine@1002 : Record 37;TotalRoundingAmount@1001 : ARRAY [2] OF Decimal;TotalPrepmtAmount@1000 : ARRAY [2] OF Decimal;FinalInvoice@1005 : Boolean;PricesInclVATRoundingAmount@1006 : ARRAY [2] OF Decimal);
    VAR
      NewAmountIncludingVAT@1003 : Decimal;
      Prepmt100PctVATRoundingAmt@1004 : Decimal;
      AmountRoundingPrecision@1007 : Decimal;
    BEGIN
      OnBeforeUpdatePrepmtSalesLineWithRounding(
        PrepmtSalesLine,TotalRoundingAmount,TotalPrepmtAmount,FinalInvoice,PricesInclVATRoundingAmount,
        TotalSalesLine,TotalSalesLineLCY);

      WITH PrepmtSalesLine DO BEGIN
        NewAmountIncludingVAT := TotalPrepmtAmount[1] + TotalPrepmtAmount[2] + TotalRoundingAmount[1] + TotalRoundingAmount[2];
        IF "Prepayment %" = 100 THEN
          TotalRoundingAmount[1] += "Amount Including VAT" - NewAmountIncludingVAT;
        AmountRoundingPrecision :=
          GetAmountRoundingPrecisionInLCY("Document Type","Document No.","Currency Code");

        IF (ABS(TotalRoundingAmount[1]) <= AmountRoundingPrecision) AND
           (ABS(TotalRoundingAmount[2]) <= AmountRoundingPrecision)
        THEN BEGIN
          IF "Prepayment %" = 100 THEN
            Prepmt100PctVATRoundingAmt := TotalRoundingAmount[1];
          TotalRoundingAmount[1] := 0;
        END;
        "Prepmt. Amount Inv. (LCY)" := TotalRoundingAmount[1];
        Amount := TotalPrepmtAmount[1] + TotalRoundingAmount[1];

        IF (PricesInclVATRoundingAmount[1] <> 0) AND (TotalRoundingAmount[1] = 0) THEN BEGIN
          IF ("Prepayment %" = 100) AND FinalInvoice AND
             (Amount + TotalPrepmtAmount[2] = "Amount Including VAT")
          THEN
            Prepmt100PctVATRoundingAmt := 0;
          PricesInclVATRoundingAmount[1] := 0;
        END;

        IF ((TotalRoundingAmount[2] <> 0) OR FinalInvoice) AND (TotalRoundingAmount[1] = 0) THEN BEGIN
          IF ("Prepayment %" = 100) AND ("Prepmt. Amount Inv. (LCY)" = 0) THEN
            Prepmt100PctVATRoundingAmt += TotalRoundingAmount[2];
          IF ("Prepayment %" = 100) OR FinalInvoice THEN
            TotalRoundingAmount[2] := 0;
        END;

        IF (PricesInclVATRoundingAmount[2] <> 0) AND (TotalRoundingAmount[2] = 0) THEN BEGIN
          IF ABS(Prepmt100PctVATRoundingAmt) <= AmountRoundingPrecision THEN
            Prepmt100PctVATRoundingAmt := 0;
          PricesInclVATRoundingAmount[2] := 0;
        END;

        "Prepmt. VAT Amount Inv. (LCY)" := TotalRoundingAmount[2] + Prepmt100PctVATRoundingAmt;
        NewAmountIncludingVAT := Amount + TotalPrepmtAmount[2] + TotalRoundingAmount[2];
        IF (PricesInclVATRoundingAmount[1] = 0) AND (PricesInclVATRoundingAmount[2] = 0) OR
           ("Currency Code" <> '') AND FinalInvoice
        THEN
          Increment(
            TotalSalesLineLCY."Amount Including VAT",
            "Amount Including VAT" - NewAmountIncludingVAT - Prepmt100PctVATRoundingAmt);
        IF "Currency Code" = '' THEN
          TotalSalesLine."Amount Including VAT" := TotalSalesLineLCY."Amount Including VAT";
        "Amount Including VAT" := NewAmountIncludingVAT;

        IF FinalInvoice AND (TotalSalesLine.Amount = 0) AND (TotalSalesLine."Amount Including VAT" <> 0) AND
           (ABS(TotalSalesLine."Amount Including VAT") <= Currency."Amount Rounding Precision")
        THEN BEGIN
          "Amount Including VAT" += TotalSalesLineLCY."Amount Including VAT";
          TotalSalesLine."Amount Including VAT" := 0;
          TotalSalesLineLCY."Amount Including VAT" := 0;
        END;
      END;

      OnAfterUpdatePrepmtSalesLineWithRounding(
        PrepmtSalesLine,TotalRoundingAmount,TotalPrepmtAmount,FinalInvoice,PricesInclVATRoundingAmount,
        TotalSalesLine,TotalSalesLineLCY);
    END;

    LOCAL PROCEDURE CalcRoundedAmount@91(Amount@1000 : Decimal;VAR Remainder@1001 : Decimal) : Decimal;
    VAR
      AmountRnded@1002 : Decimal;
    BEGIN
      Amount := Amount + Remainder;
      AmountRnded := ROUND(Amount,GLSetup."Amount Rounding Precision");
      Remainder := Amount - AmountRnded;
      EXIT(AmountRnded);
    END;

    LOCAL PROCEDURE GetSalesOrderLine@85(VAR SalesOrderLine@1000 : Record 37;SalesLine@1001 : Record 37);
    VAR
      SalesShptLine@1002 : Record 111;
    BEGIN
      SalesShptLine.GET(SalesLine."Shipment No.",SalesLine."Shipment Line No.");
      SalesOrderLine.GET(
        SalesOrderLine."Document Type"::Order,
        SalesShptLine."Order No.",SalesShptLine."Order Line No.");
      SalesOrderLine."Prepmt Amt to Deduct" := SalesLine."Prepmt Amt to Deduct";
    END;

    LOCAL PROCEDURE DecrementPrepmtAmtInvLCY@86(SalesLine@1000 : Record 37;VAR PrepmtAmountInvLCY@1001 : Decimal;VAR PrepmtVATAmountInvLCY@1002 : Decimal);
    BEGIN
      TempPrepmtDeductLCYSalesLine.RESET;
      TempPrepmtDeductLCYSalesLine := SalesLine;
      IF TempPrepmtDeductLCYSalesLine.FIND THEN BEGIN
        PrepmtAmountInvLCY := PrepmtAmountInvLCY - TempPrepmtDeductLCYSalesLine."Prepmt. Amount Inv. (LCY)";
        PrepmtVATAmountInvLCY := PrepmtVATAmountInvLCY - TempPrepmtDeductLCYSalesLine."Prepmt. VAT Amount Inv. (LCY)";
      END;
    END;

    LOCAL PROCEDURE AdjustFinalInvWith100PctPrepmt@97(VAR CombinedSalesLine@1000 : Record 37);
    VAR
      DiffToLineDiscAmt@1001 : Decimal;
    BEGIN
      WITH TempPrepmtDeductLCYSalesLine DO BEGIN
        RESET;
        SETRANGE("Prepayment %",100);
        IF FINDSET(TRUE) THEN
          REPEAT
            IF IsFinalInvoice THEN BEGIN
              DiffToLineDiscAmt := "Prepmt Amt to Deduct" - "Line Amount";
              IF "Document Type" = "Document Type"::Order THEN
                DiffToLineDiscAmt := DiffToLineDiscAmt * Quantity / "Qty. to Invoice";
              IF DiffToLineDiscAmt <> 0 THEN BEGIN
                CombinedSalesLine.GET("Document Type","Document No.","Line No.");
                "Line Discount Amount" := CombinedSalesLine."Line Discount Amount" - DiffToLineDiscAmt;
                MODIFY;
              END;
            END;
          UNTIL NEXT = 0;
        RESET;
      END;
    END;

    LOCAL PROCEDURE GetPrepmtDiffToLineAmount@98(SalesLine@1000 : Record 37) : Decimal;
    BEGIN
      WITH TempPrepmtDeductLCYSalesLine DO
        IF SalesLine."Prepayment %" = 100 THEN
          IF GET(SalesLine."Document Type",SalesLine."Document No.",SalesLine."Line No.") THEN
            EXIT("Prepmt Amt to Deduct" + "Inv. Discount Amount" - "Line Amount");
      EXIT(0);
    END;

    LOCAL PROCEDURE PostJobContractLine@54(SalesHeader@1001 : Record 36;SalesLine@1000 : Record 37);
    VAR
      IsHandled@1002 : Boolean;
    BEGIN
      IsHandled := FALSE;
      OnBeforePostJobContractLine(SalesHeader,SalesLine,IsHandled);
      IF IsHandled THEN
        EXIT;

      IF SalesLine."Job Contract Entry No." = 0 THEN
        EXIT;
      IF (SalesHeader."Document Type" <> SalesHeader."Document Type"::Invoice) AND
         (SalesHeader."Document Type" <> SalesHeader."Document Type"::"Credit Memo")
      THEN
        SalesLine.TESTFIELD("Job Contract Entry No.",0);

      SalesLine.TESTFIELD("Job No.");
      SalesLine.TESTFIELD("Job Task No.");

      IF SalesHeader."Document Type" = SalesHeader."Document Type"::Invoice THEN
        SalesLine."Document No." := SalesInvHeader."No.";
      IF SalesHeader."Document Type" = SalesHeader."Document Type"::"Credit Memo" THEN
        SalesLine."Document No." := SalesCrMemoHeader."No.";
      JobContractLine := TRUE;
      JobPostLine.PostInvoiceContractLine(SalesHeader,SalesLine);
    END;

    LOCAL PROCEDURE InsertICGenJnlLine@150(SalesHeader@1005 : Record 36;SalesLine@1000 : Record 37;VAR ICGenJnlLineNo@1006 : Integer);
    VAR
      ICGLAccount@1001 : Record 410;
      Vend@1002 : Record 23;
      ICPartner@1003 : Record 413;
      CurrExchRate@1004 : Record 330;
      GenJnlLine@1007 : Record 81;
    BEGIN
      SalesHeader.TESTFIELD("Sell-to IC Partner Code",'');
      SalesHeader.TESTFIELD("Bill-to IC Partner Code",'');
      SalesLine.TESTFIELD("IC Partner Ref. Type",SalesLine."IC Partner Ref. Type"::"G/L Account");
      ICGLAccount.GET(SalesLine."IC Partner Reference");
      ICGenJnlLineNo := ICGenJnlLineNo + 1;

      WITH TempICGenJnlLine DO BEGIN
        InitNewLine(
          SalesHeader."Posting Date",SalesHeader."Document Date",SalesHeader."Posting Description",
          SalesLine."Shortcut Dimension 1 Code",SalesLine."Shortcut Dimension 2 Code",SalesLine."Dimension Set ID",
          SalesHeader."Reason Code");
        "Line No." := ICGenJnlLineNo;

        CopyDocumentFields(GenJnlLineDocType,GenJnlLineDocNo,GenJnlLineExtDocNo,SrcCode,SalesHeader."Posting No. Series");

        VALIDATE("Account Type","Account Type"::"IC Partner");
        VALIDATE("Account No.",SalesLine."IC Partner Code");
        "Source Currency Code" := SalesHeader."Currency Code";
        "Source Currency Amount" := Amount;
        Correction := SalesHeader.Correction;
        "Country/Region Code" := SalesHeader."VAT Country/Region Code";
        "Source Type" := GenJnlLine."Source Type"::Customer;
        "Source No." := SalesHeader."Bill-to Customer No.";
        "Source Line No." := SalesLine."Line No.";
        VALIDATE("Bal. Account Type","Bal. Account Type"::"G/L Account");
        VALIDATE("Bal. Account No.",SalesLine."No.");
        "Shortcut Dimension 1 Code" := SalesLine."Shortcut Dimension 1 Code";
        "Shortcut Dimension 2 Code" := SalesLine."Shortcut Dimension 2 Code";
        "Dimension Set ID" := SalesLine."Dimension Set ID";

        Vend.SETRANGE("IC Partner Code",SalesLine."IC Partner Code");
        IF Vend.FINDFIRST THEN BEGIN
          VALIDATE("Bal. Gen. Bus. Posting Group",Vend."Gen. Bus. Posting Group");
          VALIDATE("Bal. VAT Bus. Posting Group",Vend."VAT Bus. Posting Group");
        END;
        VALIDATE("Bal. VAT Prod. Posting Group",SalesLine."VAT Prod. Posting Group");
        "IC Partner Code" := SalesLine."IC Partner Code";
        "IC Partner G/L Acc. No." := SalesLine."IC Partner Reference";
        "IC Direction" := "IC Direction"::Outgoing;
        ICPartner.GET(SalesLine."IC Partner Code");
        IF ICPartner."Cost Distribution in LCY" AND (SalesLine."Currency Code" <> '') THEN BEGIN
          "Currency Code" := '';
          "Currency Factor" := 0;
          Currency.GET(SalesLine."Currency Code");
          IF SalesHeader.IsCreditDocType THEN
            Amount :=
              ROUND(
                CurrExchRate.ExchangeAmtFCYToLCY(
                  0, '', //**4PS.n
                  SalesHeader."Posting Date",SalesLine."Currency Code",
        //        SalesLine.Amount,SalesHeader."Currency Factor")) //**4PS.o
                  SalesLine.Amount,SalesHeader."Currency Factor",TRUE)) //**4PS.n
          ELSE
            Amount :=
              -ROUND(
                CurrExchRate.ExchangeAmtFCYToLCY(
                  0, '', //**4PS.n
                  SalesHeader."Posting Date",SalesLine."Currency Code",
        //        SalesLine.Amount,SalesHeader."Currency Factor")) //**4PS.o
                  SalesLine.Amount,SalesHeader."Currency Factor",TRUE)) //**4PS.n
        END ELSE BEGIN
          Currency.InitRoundingPrecision;
          "Currency Code" := SalesHeader."Currency Code";
          "Currency Factor" := SalesHeader."Currency Factor";
          IF SalesHeader.IsCreditDocType THEN
            Amount := SalesLine.Amount
          ELSE
            Amount := -SalesLine.Amount;
        END;
        IF "Bal. VAT %" <> 0 THEN
          Amount := ROUND(Amount * (1 + "Bal. VAT %" / 100),Currency."Amount Rounding Precision");
        VALIDATE(Amount);
        OnBeforeInsertICGenJnlLine(TempICGenJnlLine,SalesHeader,SalesLine,SuppressCommit);
        INSERT;
      END;
    END;

    LOCAL PROCEDURE PostICGenJnl@151();
    VAR
      ICInOutBoxMgt@1001 : Codeunit 427;
      ICOutboxExport@1002 : Codeunit 431;
      ICTransactionNo@1000 : Integer;
    BEGIN
      TempICGenJnlLine.RESET;
      TempICGenJnlLine.SETFILTER(Amount,'<>%1',0);
      IF TempICGenJnlLine.FIND('-') THEN
        REPEAT
          ICTransactionNo := ICInOutBoxMgt.CreateOutboxJnlTransaction(TempICGenJnlLine,FALSE);
          ICInOutBoxMgt.CreateOutboxJnlLine(ICTransactionNo,1,TempICGenJnlLine);
          ICOutboxExport.ProcessAutoSendOutboxTransactionNo(ICTransactionNo);
          GenJnlPostLine.RunWithCheck(TempICGenJnlLine);
        UNTIL TempICGenJnlLine.NEXT = 0;
    END;

    LOCAL PROCEDURE TestGetShipmentPPmtAmtToDeduct@29();
    VAR
      TempSalesLine@1004 : TEMPORARY Record 37;
      TempShippedSalesLine@1003 : TEMPORARY Record 37;
      TempTotalSalesLine@1007 : TEMPORARY Record 37;
      TempSalesShptLine@1009 : TEMPORARY Record 111;
      SalesShptLine@1002 : Record 111;
      SalesOrderLine@1000 : Record 37;
      MaxAmtToDeduct@1001 : Decimal;
    BEGIN
      WITH TempSalesLine DO BEGIN
        ResetTempLines(TempSalesLine);
        SETFILTER(Quantity,'>0');
        SETFILTER("Qty. to Invoice",'>0');
        SETFILTER("Shipment No.",'<>%1','');
        SETFILTER("Prepmt Amt to Deduct",'<>0');
        IF ISEMPTY THEN
          EXIT;

        SETRANGE("Prepmt Amt to Deduct");
        IF FINDSET THEN
          REPEAT
            IF SalesShptLine.GET("Shipment No.","Shipment Line No.") THEN BEGIN
              TempShippedSalesLine := TempSalesLine;
              TempShippedSalesLine.INSERT;
              TempSalesShptLine := SalesShptLine;
              IF TempSalesShptLine.INSERT THEN;

              IF NOT TempTotalSalesLine.GET("Document Type"::Order,SalesShptLine."Order No.",SalesShptLine."Order Line No.") THEN BEGIN
                TempTotalSalesLine.INIT;
                TempTotalSalesLine."Document Type" := "Document Type"::Order;
                TempTotalSalesLine."Document No." := SalesShptLine."Order No.";
                TempTotalSalesLine."Line No." := SalesShptLine."Order Line No.";
                TempTotalSalesLine.INSERT;
              END;
              TempTotalSalesLine."Qty. to Invoice" := TempTotalSalesLine."Qty. to Invoice" + "Qty. to Invoice";
              TempTotalSalesLine."Prepmt Amt to Deduct" := TempTotalSalesLine."Prepmt Amt to Deduct" + "Prepmt Amt to Deduct";
              AdjustInvLineWith100PctPrepmt(TempSalesLine,TempTotalSalesLine);
              TempTotalSalesLine.MODIFY;
            END;
          UNTIL NEXT = 0;

        IF TempShippedSalesLine.FINDSET THEN
          REPEAT
            IF TempSalesShptLine.GET(TempShippedSalesLine."Shipment No.",TempShippedSalesLine."Shipment Line No.") THEN
              IF SalesOrderLine.GET(
                   TempShippedSalesLine."Document Type"::Order,TempSalesShptLine."Order No.",TempSalesShptLine."Order Line No.")
              THEN
                IF TempTotalSalesLine.GET(
                     TempShippedSalesLine."Document Type"::Order,TempSalesShptLine."Order No.",TempSalesShptLine."Order Line No.")
                THEN BEGIN
                  MaxAmtToDeduct := SalesOrderLine."Prepmt. Amt. Inv." - SalesOrderLine."Prepmt Amt Deducted";

                  IF TempTotalSalesLine."Prepmt Amt to Deduct" > MaxAmtToDeduct THEN
                    ERROR(PrepAmountToDeductToBigErr,FIELDCAPTION("Prepmt Amt to Deduct"),MaxAmtToDeduct);

                  IF (TempTotalSalesLine."Qty. to Invoice" = SalesOrderLine.Quantity - SalesOrderLine."Quantity Invoiced") AND
                     (TempTotalSalesLine."Prepmt Amt to Deduct" <> MaxAmtToDeduct)
                  THEN
                    ERROR(PrepAmountToDeductToSmallErr,FIELDCAPTION("Prepmt Amt to Deduct"),MaxAmtToDeduct);
                END;
          UNTIL TempShippedSalesLine.NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE AdjustInvLineWith100PctPrepmt@99(VAR SalesInvoiceLine@1000 : Record 37;VAR TempTotalSalesLine@1001 : TEMPORARY Record 37);
    VAR
      SalesOrderLine@1003 : Record 37;
      DiffAmtToDeduct@1002 : Decimal;
    BEGIN
      IF SalesInvoiceLine."Prepayment %" = 100 THEN BEGIN
        SalesOrderLine := TempTotalSalesLine;
        SalesOrderLine.FIND;
        IF TempTotalSalesLine."Qty. to Invoice" = SalesOrderLine.Quantity - SalesOrderLine."Quantity Invoiced" THEN BEGIN
          DiffAmtToDeduct :=
            SalesOrderLine."Prepmt. Amt. Inv." - SalesOrderLine."Prepmt Amt Deducted" - TempTotalSalesLine."Prepmt Amt to Deduct";
          IF DiffAmtToDeduct <> 0 THEN BEGIN
            SalesInvoiceLine."Prepmt Amt to Deduct" := SalesInvoiceLine."Prepmt Amt to Deduct" + DiffAmtToDeduct;
            SalesInvoiceLine."Line Amount" := SalesInvoiceLine."Prepmt Amt to Deduct";
            SalesInvoiceLine."Line Discount Amount" := SalesInvoiceLine."Line Discount Amount" - DiffAmtToDeduct;
            ModifyTempLine(SalesInvoiceLine);
            TempTotalSalesLine."Prepmt Amt to Deduct" := TempTotalSalesLine."Prepmt Amt to Deduct" + DiffAmtToDeduct;
          END;
        END;
      END;
    END;

    [External]
    PROCEDURE ArchiveUnpostedOrder@56(SalesHeader@1001 : Record 36);
    VAR
      SalesLine@1002 : Record 37;
      ArchiveManagement@1000 : Codeunit 5063;
      IsHandled@1003 : Boolean;
    BEGIN
      IsHandled := FALSE;
      OnBeforeArchiveUnpostedOrder(SalesHeader,IsHandled);
      IF IsHandled THEN
        EXIT;

      SalesSetup.GET;
      IF NOT (SalesHeader."Document Type" IN [SalesHeader."Document Type"::Order,SalesHeader."Document Type"::"Return Order"]) THEN
        EXIT;

      SalesSetup.GET;
      IF (SalesHeader."Document Type" = SalesHeader."Document Type"::Order) AND NOT SalesSetup."Archive Orders" THEN
        EXIT;
      IF (SalesHeader."Document Type" = SalesHeader."Document Type"::"Return Order") AND NOT SalesSetup."Archive Return Orders" THEN
        EXIT;

      SalesLine.RESET;
      SalesLine.SETRANGE("Document Type",SalesHeader."Document Type");
      SalesLine.SETRANGE("Document No.",SalesHeader."No.");
      SalesLine.SETFILTER(Quantity,'<>0');
      IF SalesHeader."Document Type" = SalesHeader."Document Type"::Order THEN
        SalesLine.SETFILTER("Qty. to Ship",'<>0')
      ELSE
        SalesLine.SETFILTER("Return Qty. to Receive",'<>0');
      IF NOT SalesLine.ISEMPTY AND NOT PreviewMode THEN BEGIN
        RoundDeferralsForArchive(SalesHeader,SalesLine);
        ArchiveManagement.ArchSalesDocumentNoConfirm(SalesHeader);
      END;
    END;

    LOCAL PROCEDURE SynchBOMSerialNo@1204(VAR ServItemTmp3@1200 : TEMPORARY Record 5940;VAR ServItemTmpCmp3@1201 : TEMPORARY Record 5941);
    VAR
      ItemLedgEntry@1000 : Record 32;
      ItemLedgEntry2@1001 : Record 32;
      TempSalesShipMntLine@1002 : TEMPORARY Record 111;
      ServItemTmpCmp4@1003 : TEMPORARY Record 5941;
      ServItemCompLocal@1004 : Record 5941;
      TempItemLedgEntry2@1008 : TEMPORARY Record 32;
      ChildCount@1005 : Integer;
      EndLoop@1006 : Boolean;
    BEGIN
      IF NOT ServItemTmpCmp3.FIND('-') THEN
        EXIT;

      IF NOT ServItemTmp3.FIND('-') THEN
        EXIT;

      TempSalesShipMntLine.DELETEALL;
      REPEAT
        CLEAR(TempSalesShipMntLine);
        TempSalesShipMntLine."Document No." := ServItemTmp3."Sales/Serv. Shpt. Document No.";
        TempSalesShipMntLine."Line No." := ServItemTmp3."Sales/Serv. Shpt. Line No.";
        IF TempSalesShipMntLine.INSERT THEN;
      UNTIL ServItemTmp3.NEXT = 0;

      IF NOT TempSalesShipMntLine.FIND('-') THEN
        EXIT;

      ServItemTmp3.SETCURRENTKEY("Sales/Serv. Shpt. Document No.","Sales/Serv. Shpt. Line No.");
      CLEAR(ItemLedgEntry);
      ItemLedgEntry.SETCURRENTKEY("Document No.","Document Type","Document Line No.");

      REPEAT
        ChildCount := 0;
        ServItemTmpCmp4.DELETEALL;
        ServItemTmp3.SETRANGE("Sales/Serv. Shpt. Document No.",TempSalesShipMntLine."Document No.");
        ServItemTmp3.SETRANGE("Sales/Serv. Shpt. Line No.",TempSalesShipMntLine."Line No.");
        IF ServItemTmp3.FIND('-') THEN
          REPEAT
            ServItemTmpCmp3.SETRANGE(Active,TRUE);
            ServItemTmpCmp3.SETRANGE("Parent Service Item No.",ServItemTmp3."No.");
            IF ServItemTmpCmp3.FIND('-') THEN
              REPEAT
                ChildCount += 1;
                ServItemTmpCmp4 := ServItemTmpCmp3;
                ServItemTmpCmp4.INSERT;
              UNTIL ServItemTmpCmp3.NEXT = 0;
          UNTIL ServItemTmp3.NEXT = 0;
        ItemLedgEntry.SETRANGE("Document No.",TempSalesShipMntLine."Document No.");
        ItemLedgEntry.SETRANGE("Document Type",ItemLedgEntry."Document Type"::"Sales Shipment");
        ItemLedgEntry.SETRANGE("Document Line No.",TempSalesShipMntLine."Line No.");
        IF ItemLedgEntry.FINDFIRST AND ServItemTmpCmp4.FIND('-') THEN BEGIN
          CLEAR(ItemLedgEntry2);
          ItemLedgEntry2.GET(ItemLedgEntry."Entry No.");
          EndLoop := FALSE;
          REPEAT
            IF ItemLedgEntry2."Item No." = ServItemTmpCmp4."No." THEN
              EndLoop := TRUE
            ELSE
              IF ItemLedgEntry2.NEXT = 0 THEN
                EndLoop := TRUE;
          UNTIL EndLoop;
          ItemLedgEntry2.SETRANGE("Entry No.",ItemLedgEntry2."Entry No.",ItemLedgEntry2."Entry No." + ChildCount - 1);
          IF ItemLedgEntry2.FINDSET THEN
            REPEAT
              TempItemLedgEntry2 := ItemLedgEntry2;
              TempItemLedgEntry2.INSERT;
            UNTIL ItemLedgEntry2.NEXT = 0;
          REPEAT
            IF ServItemCompLocal.GET(
                 ServItemTmpCmp4.Active,
                 ServItemTmpCmp4."Parent Service Item No.",
                 ServItemTmpCmp4."Line No.")
            THEN BEGIN
              TempItemLedgEntry2.SETRANGE("Item No.",ServItemCompLocal."No.");
              IF TempItemLedgEntry2.FINDFIRST THEN BEGIN
                ServItemCompLocal."Serial No." := TempItemLedgEntry2."Serial No.";
                ServItemCompLocal.MODIFY;
                TempItemLedgEntry2.DELETE;
              END;
            END;
          UNTIL ServItemTmpCmp4.NEXT = 0;
        END;
      UNTIL TempSalesShipMntLine.NEXT = 0;
    END;

    LOCAL PROCEDURE GetGLSetup@60();
    BEGIN
      IF NOT GLSetupRead THEN
        GLSetup.GET;
      GLSetupRead := TRUE;
    END;

    LOCAL PROCEDURE LockTables@58(VAR SalesHeader@1003 : Record 36);
    VAR
      SalesLine@1000 : Record 37;
      PurchOrderHeader@1002 : Record 38;
      PurchOrderLine@1001 : Record 39;
    BEGIN
      OnBeforeLockTables(SalesHeader,PreviewMode,SuppressCommit);

      SalesLine.LOCKTABLE;
      ItemChargeAssgntSales.LOCKTABLE;
      PurchOrderLine.LOCKTABLE;
      PurchOrderHeader.LOCKTABLE;
      GetGLSetup;
      IF NOT GLSetup.OptimGLEntLockForMultiuserEnv THEN BEGIN
        GLEntry.LOCKTABLE;
        IF GLEntry.FINDLAST THEN;
      END;
    END;

    LOCAL PROCEDURE PostCustomerEntry@101(VAR SalesHeader@1000 : Record 36;TotalSalesLine2@1005 : Record 37;TotalSalesLineLCY2@1006 : Record 37;DocType@1002 : Option;DocNo@1003 : Code[20];ExtDocNo@1004 : Code[35];SourceCode@1007 : Code[10];CrRestrictionAmt@1100525000 : Decimal;CrRestrictionVATAmt@1100525001 : Decimal;ReferenceNo@1090000 : Code[20];TotalROT@1008 : Decimal;TotalRUT@1101285000 : Decimal);
    VAR
      GenJnlLine@1001 : Record 81;
    BEGIN
      WITH GenJnlLine DO BEGIN
        InitNewLine(
          SalesHeader."Posting Date",SalesHeader."Document Date",SalesHeader."Posting Description",
          SalesHeader."Shortcut Dimension 1 Code",SalesHeader."Shortcut Dimension 2 Code",
          SalesHeader."Dimension Set ID",SalesHeader."Reason Code");

        CopyDocumentFields(DocType,DocNo,ExtDocNo,SourceCode,'');
        //**4PS.sn
        IF PlantTransportInternalCust THEN BEGIN
          PlantSetup.GET;
          "Account Type" := "Account Type"::"G/L Account";
          "Account No." := PlantSetup."Internal Bal. Account Cost";
        END ELSE BEGIN
        //**4PS.en
          "Account Type" := "Account Type"::Customer;
          "Account No." := SalesHeader."Bill-to Customer No.";
        END; //**4PS.n
        CopyFromSalesHeader(SalesHeader);
        SetCurrencyFactor(SalesHeader."Currency Code",SalesHeader."Currency Factor");

        "System-Created Entry" := TRUE;

        CopyFromSalesHeaderApplyTo(SalesHeader);
        CopyFromSalesHeaderPayment(SalesHeader);

        Amount := -TotalSalesLine2."Amount Including VAT";
        "Source Currency Amount" := -TotalSalesLine2."Amount Including VAT";
        "Amount (LCY)" := -TotalSalesLineLCY2."Amount Including VAT";
        "Sales/Purch. (LCY)" := -TotalSalesLineLCY2.Amount;
        "Profit (LCY)" := -(TotalSalesLineLCY2.Amount - TotalSalesLineLCY2."Unit Cost (LCY)");
        "Inv. Discount (LCY)" := -TotalSalesLineLCY2."Inv. Discount Amount";
        GenJnlLineExt.InitGetLine(GenJnlLine);//4PSSE
        GenJnlLineExt."Reference No." := ReferenceNumber;  //NAVFI
        GenJnlLineExt.SaveUpdateLine(GenJnlLine);//4PSSE

        //**4PS.sn
        IF PlantTransportInternalCust THEN BEGIN
          "Pmt. Discount Date" := 0D;
          "Payment Discount %" := 0;
          "Pmt. Discount Date 2" := 0D;
          "Payment Discount % 2" := 0;
          "Pmt. Discount Date 3" := 0D;
          "Payment Discount % 3" := 0;
        END;

        IF SalesHeader."Document Type" IN [SalesHeader."Document Type"::Order,SalesHeader."Document Type"::Invoice] THEN BEGIN
          "Labor Amount (Subcontracting)" := SalesInvHeader."Labor Amount (Subcontracting)";
          "Blocked Amount (Subcontracting" := SalesInvHeader."Blocked Amount (Subcontracting";
        END ELSE BEGIN
          "Labor Amount (Subcontracting)" := SalesCrMemoHeader."Labor Amount (Subcontracting)";
          "Blocked Amount (Subcontracting" := SalesCrMemoHeader."Blocked Amount (Subcontracting";
        END;
        VALIDATE("Credit Restriction Amount", CrRestrictionAmt);
        VALIDATE("Credit Restriction VAT Amount", CrRestrictionVATAmt);
        //**4PS.en

        OnBeforePostCustomerEntry(GenJnlLine,SalesHeader,TotalSalesLine2,TotalSalesLineLCY2,SuppressCommit,PreviewMode);

        // 4PSESE.I012 140410 NEW CALCULATION FOR ROT AMOUNT <<
        IF (SalesHeader."ROT/RUT reduction") THEN BEGIN
          "Amount ROT" := TotalROT;
          "Amount RUT" := TotalRUT; //RFC188
        END;
        // 4PSESE.I012 140410 NEW CALCULATION FOR ROT AMOUNT >>

        GenJnlPostLine.SetCustLegEntryProjectNo(SalesHeader."Job No.");  //**4PS.n C-019159  Note: Fill "Job No." in GenJnlLine not allowed
        GenJnlPostLine.RunWithCheck(GenJnlLine);
        GenJnlPostLine.SetCustLegEntryProjectNo('');  //**4PS.n C-019159
        OnAfterPostCustomerEntry(GenJnlLine,SalesHeader,TotalSalesLine2,TotalSalesLineLCY2,SuppressCommit,GenJnlPostLine);

      END;
    END;

    LOCAL PROCEDURE UpdateSalesHeader@102(VAR CustLedgerEntry@1000 : Record 21);
    VAR
      GenJnlLine@1001 : Record 81;
    BEGIN
      CASE GenJnlLineDocType OF
        GenJnlLine."Document Type"::Invoice:
          BEGIN
            FindCustLedgEntry(GenJnlLineDocType,GenJnlLineDocNo,CustLedgerEntry);
            SalesInvHeader."Cust. Ledger Entry No." := CustLedgerEntry."Entry No.";
            SalesInvHeader.MODIFY;
          END;
        GenJnlLine."Document Type"::"Credit Memo":
          BEGIN
            FindCustLedgEntry(GenJnlLineDocType,GenJnlLineDocNo,CustLedgerEntry);
            SalesCrMemoHeader."Cust. Ledger Entry No." := CustLedgerEntry."Entry No.";
            SalesCrMemoHeader.MODIFY;
          END;
      END;

      OnAfterUpdateSalesHeader(CustLedgerEntry,SalesInvHeader,SalesCrMemoHeader,GenJnlLineDocType);
    END;

    LOCAL PROCEDURE MakeSalesLineToShip@273(VAR SalesLineToShip@1000 : Record 37;SalesLineInvoiced@1001 : Record 37);
    VAR
      TempSalesLine@1002 : TEMPORARY Record 37;
    BEGIN
      ResetTempLines(TempSalesLine);
      TempSalesLine := SalesLineInvoiced;
      TempSalesLine.FIND;

      SalesLineToShip := SalesLineInvoiced;
      SalesLineToShip."Inv. Discount Amount" := TempSalesLine."Inv. Discount Amount";
    END;

    LOCAL PROCEDURE MAX@55(number1@1000 : Integer;number2@1001 : Integer) : Integer;
    BEGIN
      IF number1 > number2 THEN
        EXIT(number1);
      EXIT(number2);
    END;

    LOCAL PROCEDURE PostBalancingEntry@63(SalesHeader@1014 : Record 36;TotalSalesLine2@1013 : Record 37;TotalSalesLineLCY2@1011 : Record 37;DocType@1009 : Option;DocNo@1008 : Code[20];ExtDocNo@1007 : Code[35];SourceCode@1006 : Code[10]);
    VAR
      CustLedgEntry@1002 : Record 21;
      GenJnlLine@1001 : Record 81;
      EntryFound@1000 : Boolean;
    BEGIN
      EntryFound := FALSE;
      OnPostBalancingEntryOnBeforeFindCustLedgEntry(
        SalesHeader,TotalSalesLine2,DocType,DocNo,ExtDocNo,CustLedgEntry,EntryFound);
      IF NOT EntryFound THEN
        FindCustLedgEntry(DocType,DocNo,CustLedgEntry);

      WITH GenJnlLine DO BEGIN
        InitNewLine(
          SalesHeader."Posting Date",SalesHeader."Document Date",SalesHeader."Posting Description",
          SalesHeader."Shortcut Dimension 1 Code",SalesHeader."Shortcut Dimension 2 Code",
          SalesHeader."Dimension Set ID",SalesHeader."Reason Code");

        CopyDocumentFields(0,DocNo,ExtDocNo,SourceCode,'');
        "Account Type" := "Account Type"::Customer;
        "Account No." := SalesHeader."Bill-to Customer No.";
        CopyFromSalesHeader(SalesHeader);
        SetCurrencyFactor(SalesHeader."Currency Code",SalesHeader."Currency Factor");

        IF SalesHeader.IsCreditDocType THEN
          "Document Type" := "Document Type"::Refund
        ELSE
          "Document Type" := "Document Type"::Payment;

        SetApplyToDocNo(SalesHeader,GenJnlLine,DocType,DocNo);

        Amount := TotalSalesLine2."Amount Including VAT" + CustLedgEntry."Remaining Pmt. Disc. Possible";
        "Source Currency Amount" := Amount;
        CustLedgEntry.CALCFIELDS(Amount);
        IF CustLedgEntry.Amount = 0 THEN
          "Amount (LCY)" := TotalSalesLineLCY2."Amount Including VAT"
        ELSE
          "Amount (LCY)" :=
            TotalSalesLineLCY2."Amount Including VAT" +
            ROUND(CustLedgEntry."Remaining Pmt. Disc. Possible" / CustLedgEntry."Adjusted Currency Factor");
        "Allow Zero-Amount Posting" := TRUE;

        OnBeforePostBalancingEntry(GenJnlLine,SalesHeader,TotalSalesLine2,TotalSalesLineLCY2,SuppressCommit,PreviewMode);
        GenJnlPostLine.RunWithCheck(GenJnlLine);
        OnAfterPostBalancingEntry(GenJnlLine,SalesHeader,TotalSalesLine2,TotalSalesLineLCY2,SuppressCommit,GenJnlPostLine);
      END;
    END;

    LOCAL PROCEDURE SetApplyToDocNo@57(SalesHeader@1000 : Record 36;VAR GenJnlLine@1001 : Record 81;DocType@1002 : Option;DocNo@1003 : Code[20]);
    BEGIN
      WITH GenJnlLine DO BEGIN
        IF SalesHeader."Bal. Account Type" = SalesHeader."Bal. Account Type"::"Bank Account" THEN
          "Bal. Account Type" := "Bal. Account Type"::"Bank Account";
        "Bal. Account No." := SalesHeader."Bal. Account No.";
        "Applies-to Doc. Type" := DocType;
        "Applies-to Doc. No." := DocNo;
      END;

      OnAfterSetApplyToDocNo(GenJnlLine,SalesHeader);
    END;

    LOCAL PROCEDURE FindCustLedgEntry@71(DocType@1003 : Option;DocNo@1002 : Code[20];VAR CustLedgEntry@1000 : Record 21);
    BEGIN
      CustLedgEntry.SETRANGE("Document Type",DocType);
      CustLedgEntry.SETRANGE("Document No.",DocNo);
      CustLedgEntry.FINDLAST;
    END;

    LOCAL PROCEDURE ItemLedgerEntryExist@7(SalesLine2@1000 : Record 37;ShipOrReceive@1002 : Boolean) : Boolean;
    VAR
      HasItemLedgerEntry@1001 : Boolean;
    BEGIN
      IF ShipOrReceive THEN
        // item ledger entry will be created during posting in this transaction
        HasItemLedgerEntry :=
          ((SalesLine2."Qty. to Ship" + SalesLine2."Quantity Shipped") <> 0) OR
          ((SalesLine2."Qty. to Invoice" + SalesLine2."Quantity Invoiced") <> 0) OR
          ((SalesLine2."Return Qty. to Receive" + SalesLine2."Return Qty. Received") <> 0)
      ELSE
        // item ledger entry must already exist
        HasItemLedgerEntry :=
          (SalesLine2."Quantity Shipped" <> 0) OR
          (SalesLine2."Return Qty. Received" <> 0);

      EXIT(HasItemLedgerEntry);
    END;

    LOCAL PROCEDURE CheckPostRestrictions@115(SalesHeader@1000 : Record 36);
    VAR
      Contact@1001 : Record 5050;
    BEGIN
      WITH SalesHeader DO BEGIN
        IF NOT PreviewMode THEN
          OnCheckSalesPostRestrictions;

        CheckCustBlockage(SalesHeader,"Sell-to Customer No.",TRUE);
        ValidateSalesPersonOnSalesHeader(SalesHeader,TRUE,TRUE);

        IF "Bill-to Customer No." <> "Sell-to Customer No." THEN
          CheckCustBlockage(SalesHeader,"Bill-to Customer No.",FALSE);

        IF "Sell-to Contact No." <> '' THEN
          IF Contact.GET("Sell-to Contact No.") THEN
            Contact.CheckIfPrivacyBlocked(TRUE);
        IF "Bill-to Contact No." <> '' THEN
          IF Contact.GET("Bill-to Contact No.") THEN
            Contact.CheckIfPrivacyBlocked(TRUE);
      END;
    END;

    LOCAL PROCEDURE CheckCustBlockage@1029(SalesHeader@1000 : Record 36;CustCode@1011 : Code[20];ExecuteDocCheck@1012 : Boolean);
    VAR
      Cust@1039 : Record 18;
      TempSalesLine@1001 : TEMPORARY Record 37;
    BEGIN
      //**4PS.sn
      IF ChargePlantToProject(SalesHeader) OR ChargeJobOrderToPlant(SalesHeader) OR ChargePlantToServOrder(SalesHeader) THEN
        EXIT; //No customer involved
      IF InternalChargePlantOnLoc(SalesHeader,'') THEN  //DP00815
        EXIT; //No customer involved
      //**4PS.en
      WITH SalesHeader DO BEGIN
        Cust.GET(CustCode);
        IF Receive THEN
          Cust.CheckBlockedCustOnDocs(Cust,"Document Type",FALSE,TRUE)
        ELSE BEGIN
          //IF Ship AND CheckDocumentType(SalesHeader,ExecuteDocCheck) THEN BEGIN  //**4PS.o
          //**4PS.sn
          IF Ship AND CheckDocumentType(SalesHeader,ExecuteDocCheck) AND
            (NOT "Project Invoice") AND (NOT "Service Invoice") AND (NOT "Plant Invoice")
          THEN BEGIN
          //**4PS.en
            ResetTempLines(TempSalesLine);
            TempSalesLine.SETFILTER("Qty. to Ship",'<>0');
            TempSalesLine.SETRANGE("Shipment No.",'');
            IF NOT TempSalesLine.ISEMPTY THEN
              Cust.CheckBlockedCustOnDocs(Cust,"Document Type",TRUE,TRUE);
          END ELSE
            Cust.CheckBlockedCustOnDocs(Cust,"Document Type",FALSE,TRUE);
        END;
      END;
    END;

    LOCAL PROCEDURE CheckDocumentType@1030(SalesHeader@1000 : Record 36;ExecuteDocCheck@1031 : Boolean) : Boolean;
    BEGIN
      WITH SalesHeader DO
        IF ExecuteDocCheck THEN
          EXIT(
            ("Document Type" = "Document Type"::Order) OR
            (("Document Type" = "Document Type"::Invoice) AND SalesSetup."Shipment on Invoice"));
      EXIT(TRUE);
    END;

    LOCAL PROCEDURE UpdateWonOpportunities@66(VAR SalesHeader@1000 : Record 36);
    VAR
      Opp@1001 : Record 5092;
      OpportunityEntry@1002 : Record 5093;
    BEGIN
      WITH SalesHeader DO
        IF "Document Type" = "Document Type"::Order THEN BEGIN
          Opp.RESET;
          Opp.SETCURRENTKEY("Sales Document Type","Sales Document No.");
          Opp.SETRANGE("Sales Document Type",Opp."Sales Document Type"::Order);
          Opp.SETRANGE("Sales Document No.","No.");
          Opp.SETRANGE(Status,Opp.Status::Won);
          IF Opp.FINDFIRST THEN BEGIN
            Opp."Sales Document Type" := Opp."Sales Document Type"::"Posted Invoice";
            Opp."Sales Document No." := SalesInvHeader."No.";
            Opp.MODIFY;
            OpportunityEntry.RESET;
            OpportunityEntry.SETCURRENTKEY(Active,"Opportunity No.");
            OpportunityEntry.SETRANGE(Active,TRUE);
            OpportunityEntry.SETRANGE("Opportunity No.",Opp."No.");
            IF OpportunityEntry.FINDFIRST THEN BEGIN
              OpportunityEntry."Calcd. Current Value (LCY)" := OpportunityEntry.GetSalesDocValue(SalesHeader);
              OpportunityEntry.MODIFY;
            END;
          END;
        END;
    END;

    LOCAL PROCEDURE UpdateQtyToBeInvoicedForShipment@90(VAR QtyToBeInvoiced@1000 : Decimal;VAR QtyToBeInvoicedBase@1001 : Decimal;TrackingSpecificationExists@1002 : Boolean;HasATOShippedNotInvoiced@1003 : Boolean;SalesLine@1007 : Record 37;SalesShptLine@1006 : Record 111;InvoicingTrackingSpecification@1004 : Record 336;ItemLedgEntryNotInvoiced@1005 : Record 32);
    BEGIN
      IF TrackingSpecificationExists THEN BEGIN
        QtyToBeInvoiced := InvoicingTrackingSpecification."Qty. to Invoice";
        QtyToBeInvoicedBase := InvoicingTrackingSpecification."Qty. to Invoice (Base)";
      END ELSE
        IF HasATOShippedNotInvoiced THEN BEGIN
          QtyToBeInvoicedBase := ItemLedgEntryNotInvoiced.Quantity - ItemLedgEntryNotInvoiced."Invoiced Quantity";
          IF ABS(QtyToBeInvoicedBase) > ABS(RemQtyToBeInvoicedBase) THEN
            QtyToBeInvoicedBase := RemQtyToBeInvoicedBase - SalesLine."Qty. to Ship (Base)";
          QtyToBeInvoiced := ROUND(QtyToBeInvoicedBase / SalesShptLine."Qty. per Unit of Measure",UOMMgt.QtyRndPrecision);
        END ELSE BEGIN
          QtyToBeInvoiced := RemQtyToBeInvoiced - SalesLine."Qty. to Ship";
          QtyToBeInvoicedBase := RemQtyToBeInvoicedBase - SalesLine."Qty. to Ship (Base)";
        END;

      IF ABS(QtyToBeInvoiced) > ABS(SalesShptLine.Quantity - SalesShptLine."Quantity Invoiced") THEN BEGIN
        QtyToBeInvoiced := -(SalesShptLine.Quantity - SalesShptLine."Quantity Invoiced");
        QtyToBeInvoicedBase := -(SalesShptLine."Quantity (Base)" - SalesShptLine."Qty. Invoiced (Base)");
      END;
    END;

    LOCAL PROCEDURE UpdateQtyToBeInvoicedForReturnReceipt@201(VAR QtyToBeInvoiced@1002 : Decimal;VAR QtyToBeInvoicedBase@1001 : Decimal;TrackingSpecificationExists@1000 : Boolean;SalesLine@1004 : Record 37;ReturnReceiptLine@1003 : Record 6661;InvoicingTrackingSpecification@1005 : Record 336);
    BEGIN
      IF TrackingSpecificationExists THEN BEGIN
        QtyToBeInvoiced := InvoicingTrackingSpecification."Qty. to Invoice";
        QtyToBeInvoicedBase := InvoicingTrackingSpecification."Qty. to Invoice (Base)";
      END ELSE BEGIN
        QtyToBeInvoiced := RemQtyToBeInvoiced - SalesLine."Return Qty. to Receive";
        QtyToBeInvoicedBase := RemQtyToBeInvoicedBase - SalesLine."Return Qty. to Receive (Base)";
      END;
      IF ABS(QtyToBeInvoiced) >
         ABS(ReturnReceiptLine.Quantity - ReturnReceiptLine."Quantity Invoiced")
      THEN BEGIN
        QtyToBeInvoiced := ReturnReceiptLine.Quantity - ReturnReceiptLine."Quantity Invoiced";
        QtyToBeInvoicedBase := ReturnReceiptLine."Quantity (Base)" - ReturnReceiptLine."Qty. Invoiced (Base)";
      END;
    END;

    LOCAL PROCEDURE UpdateRemainingQtyToBeInvoiced@125(SalesShptLine@1000 : Record 111;VAR RemQtyToInvoiceCurrLine@1001 : Decimal;VAR RemQtyToInvoiceCurrLineBase@1002 : Decimal);
    BEGIN
      RemQtyToInvoiceCurrLine := -SalesShptLine.Quantity + SalesShptLine."Quantity Invoiced";
      RemQtyToInvoiceCurrLineBase := -SalesShptLine."Quantity (Base)" + SalesShptLine."Qty. Invoiced (Base)";
      IF RemQtyToInvoiceCurrLine < RemQtyToBeInvoiced THEN BEGIN
        RemQtyToInvoiceCurrLine := RemQtyToBeInvoiced;
        RemQtyToInvoiceCurrLineBase := RemQtyToBeInvoicedBase;
      END;
    END;

    LOCAL PROCEDURE IsEndLoopForShippedNotInvoiced@96(RemQtyToBeInvoiced@1004 : Decimal;TrackingSpecificationExists@1001 : Boolean;VAR HasATOShippedNotInvoiced@1000 : Boolean;VAR SalesShptLine@1006 : Record 111;VAR InvoicingTrackingSpecification@1002 : Record 336;VAR ItemLedgEntryNotInvoiced@1003 : Record 32;SalesLine@1005 : Record 37) : Boolean;
    BEGIN
      IF TrackingSpecificationExists THEN
        EXIT((InvoicingTrackingSpecification.NEXT = 0) OR (RemQtyToBeInvoiced = 0));

      IF HasATOShippedNotInvoiced THEN BEGIN
        HasATOShippedNotInvoiced := ItemLedgEntryNotInvoiced.NEXT <> 0;
        IF NOT HasATOShippedNotInvoiced THEN
          EXIT(NOT SalesShptLine.FINDSET OR (ABS(RemQtyToBeInvoiced) <= ABS(SalesLine."Qty. to Ship")));
        EXIT(ABS(RemQtyToBeInvoiced) <= ABS(SalesLine."Qty. to Ship"));
      END;

      EXIT((SalesShptLine.NEXT = 0) OR (ABS(RemQtyToBeInvoiced) <= ABS(SalesLine."Qty. to Ship")));
    END;

    [External]
    PROCEDURE SetItemEntryRelation@87(VAR ItemEntryRelation@1000 : Record 6507;VAR SalesShptLine@1001 : Record 111;VAR InvoicingTrackingSpecification@1004 : Record 336;VAR ItemLedgEntryNotInvoiced@1005 : Record 32;TrackingSpecificationExists@1002 : Boolean;HasATOShippedNotInvoiced@1003 : Boolean);
    BEGIN
      IF TrackingSpecificationExists THEN BEGIN
        ItemEntryRelation.GET(InvoicingTrackingSpecification."Item Ledger Entry No.");
        SalesShptLine.GET(ItemEntryRelation."Source ID",ItemEntryRelation."Source Ref. No.");
      END ELSE
        IF HasATOShippedNotInvoiced THEN BEGIN
          ItemEntryRelation."Item Entry No." := ItemLedgEntryNotInvoiced."Entry No.";
          SalesShptLine.GET(ItemLedgEntryNotInvoiced."Document No.",ItemLedgEntryNotInvoiced."Document Line No.");
        END ELSE
          ItemEntryRelation."Item Entry No." := SalesShptLine."Item Shpt. Entry No.";
    END;

    LOCAL PROCEDURE PostATOAssocItemJnlLine@76(SalesHeader@1004 : Record 36;SalesLine@1003 : Record 37;VAR PostedATOLink@1000 : Record 914;VAR RemQtyToBeInvoiced@1002 : Decimal;VAR RemQtyToBeInvoicedBase@1001 : Decimal);
    VAR
      DummyTrackingSpecification@1005 : Record 336;
    BEGIN
      WITH PostedATOLink DO BEGIN
        DummyTrackingSpecification.INIT;
        IF SalesLine."Document Type" = SalesLine."Document Type"::Order THEN BEGIN
          "Assembled Quantity" := -"Assembled Quantity";
          "Assembled Quantity (Base)" := -"Assembled Quantity (Base)";
          IF ABS(RemQtyToBeInvoiced) >= ABS("Assembled Quantity") THEN BEGIN
            ItemLedgShptEntryNo :=
              PostItemJnlLine(
                SalesHeader,SalesLine,
                "Assembled Quantity","Assembled Quantity (Base)",
                "Assembled Quantity","Assembled Quantity (Base)",
                0,'',DummyTrackingSpecification,TRUE);
            RemQtyToBeInvoiced -= "Assembled Quantity";
            RemQtyToBeInvoicedBase -= "Assembled Quantity (Base)";
          END ELSE BEGIN
            IF RemQtyToBeInvoiced <> 0 THEN
              ItemLedgShptEntryNo :=
                PostItemJnlLine(
                  SalesHeader,SalesLine,
                  RemQtyToBeInvoiced,
                  RemQtyToBeInvoicedBase,
                  RemQtyToBeInvoiced,
                  RemQtyToBeInvoicedBase,
                  0,'',DummyTrackingSpecification,TRUE);

            ItemLedgShptEntryNo :=
              PostItemJnlLine(
                SalesHeader,SalesLine,
                "Assembled Quantity" - RemQtyToBeInvoiced,
                "Assembled Quantity (Base)" - RemQtyToBeInvoicedBase,
                0,0,
                0,'',DummyTrackingSpecification,TRUE);

            RemQtyToBeInvoiced := 0;
            RemQtyToBeInvoicedBase := 0;
          END;
        END;
      END;
    END;

    LOCAL PROCEDURE GetOpenLinkedATOs@72(VAR TempAsmHeader@1000 : TEMPORARY Record 900);
    VAR
      TempSalesLine@1002 : TEMPORARY Record 37;
      AsmHeader@1001 : Record 900;
    BEGIN
      WITH TempSalesLine DO BEGIN
        ResetTempLines(TempSalesLine);
        IF FINDSET THEN
          REPEAT
            IF AsmToOrderExists(AsmHeader) THEN
              IF AsmHeader.Status = AsmHeader.Status::Open THEN BEGIN
                TempAsmHeader.TRANSFERFIELDS(AsmHeader);
                TempAsmHeader.INSERT;
              END;
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE ReopenAsmOrders@69(VAR TempAsmHeader@1002 : TEMPORARY Record 900);
    VAR
      AsmHeader@1001 : Record 900;
    BEGIN
      IF TempAsmHeader.FIND('-') THEN
        REPEAT
          AsmHeader.GET(TempAsmHeader."Document Type",TempAsmHeader."No.");
          AsmHeader.Status := AsmHeader.Status::Open;
          AsmHeader.MODIFY;
        UNTIL TempAsmHeader.NEXT = 0;
    END;

    LOCAL PROCEDURE InitPostATO@53(SalesHeader@1002 : Record 36;VAR SalesLine@1000 : Record 37);
    VAR
      AsmHeader@1001 : Record 900;
      Window@1003 : Dialog;
    BEGIN
      IF SalesLine.AsmToOrderExists(AsmHeader) THEN BEGIN
        IF NOT HideProgressWindow THEN BEGIN
          Window.OPEN(AssemblyCheckProgressMsg);
          Window.UPDATE(1,
            STRSUBSTNO('%1 %2 %3 %4',
              SalesLine."Document Type",SalesLine."Document No.",SalesLine.FIELDCAPTION("Line No."),SalesLine."Line No."));
          Window.UPDATE(2,STRSUBSTNO('%1 %2',AsmHeader."Document Type",AsmHeader."No."));
        END;

        SalesLine.CheckAsmToOrder(AsmHeader);
        IF NOT HasQtyToAsm(SalesLine,AsmHeader) THEN
          EXIT;

        AsmPost.SetPostingDate(TRUE,SalesHeader."Posting Date");
        AsmPost.InitPostATO(AsmHeader);

        Window.CLOSE;
      END;
    END;

    LOCAL PROCEDURE InitPostATOs@179(SalesHeader@1001 : Record 36);
    VAR
      TempSalesLine@1000 : TEMPORARY Record 37;
    BEGIN
      WITH TempSalesLine DO BEGIN
        FindNotShippedLines(SalesHeader,TempSalesLine);
        SETFILTER("Qty. to Assemble to Order",'<>0');
        IF FINDSET THEN
          REPEAT
            InitPostATO(SalesHeader,TempSalesLine);
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE PostATO@59(SalesHeader@1005 : Record 36;VAR SalesLine@1000 : Record 37;VAR TempPostedATOLink@1004 : TEMPORARY Record 914);
    VAR
      AsmHeader@1001 : Record 900;
      PostedATOLink@1002 : Record 914;
      Window@1003 : Dialog;
    BEGIN
      IF SalesLine.AsmToOrderExists(AsmHeader) THEN BEGIN
        IF NOT HideProgressWindow THEN BEGIN
          Window.OPEN(AssemblyPostProgressMsg);
          Window.UPDATE(1,
            STRSUBSTNO('%1 %2 %3 %4',
              SalesLine."Document Type",SalesLine."Document No.",SalesLine.FIELDCAPTION("Line No."),SalesLine."Line No."));
          Window.UPDATE(2,STRSUBSTNO('%1 %2',AsmHeader."Document Type",AsmHeader."No."));
        END;

        SalesLine.CheckAsmToOrder(AsmHeader);
        IF NOT HasQtyToAsm(SalesLine,AsmHeader) THEN
          EXIT;
        IF AsmHeader."Remaining Quantity (Base)" = 0 THEN
          EXIT;

        PostedATOLink.INIT;
        PostedATOLink."Assembly Document Type" := PostedATOLink."Assembly Document Type"::Assembly;
        PostedATOLink."Assembly Document No." := AsmHeader."Posting No.";
        PostedATOLink."Document Type" := PostedATOLink."Document Type"::"Sales Shipment";
        PostedATOLink."Document No." := SalesHeader."Shipping No.";
        PostedATOLink."Document Line No." := SalesLine."Line No.";

        PostedATOLink."Assembly Order No." := AsmHeader."No.";
        PostedATOLink."Order No." := SalesLine."Document No.";
        PostedATOLink."Order Line No." := SalesLine."Line No.";

        PostedATOLink."Assembled Quantity" := AsmHeader."Quantity to Assemble";
        PostedATOLink."Assembled Quantity (Base)" := AsmHeader."Quantity to Assemble (Base)";

        OnPostATOOnBeforePostedATOLinkInsert(PostedATOLink);
        PostedATOLink.INSERT;

        TempPostedATOLink := PostedATOLink;
        TempPostedATOLink.INSERT;

        AsmPost.PostATO(AsmHeader,ItemJnlPostLine,ResJnlPostLine,WhseJnlPostLine);

        Window.CLOSE;
      END;
    END;

    LOCAL PROCEDURE FinalizePostATO@61(VAR SalesLine@1000 : Record 37);
    VAR
      ATOLink@1002 : Record 904;
      AsmHeader@1003 : Record 900;
      Window@1001 : Dialog;
    BEGIN
      IF SalesLine.AsmToOrderExists(AsmHeader) THEN BEGIN
        IF NOT HideProgressWindow THEN BEGIN
          Window.OPEN(AssemblyFinalizeProgressMsg);
          Window.UPDATE(1,
            STRSUBSTNO('%1 %2 %3 %4',
              SalesLine."Document Type",SalesLine."Document No.",SalesLine.FIELDCAPTION("Line No."),SalesLine."Line No."));
          Window.UPDATE(2,STRSUBSTNO('%1 %2',AsmHeader."Document Type",AsmHeader."No."));
        END;

        SalesLine.CheckAsmToOrder(AsmHeader);
        AsmHeader.TESTFIELD("Remaining Quantity (Base)",0);
        AsmPost.FinalizePostATO(AsmHeader);
        ATOLink.GET(AsmHeader."Document Type",AsmHeader."No.");
        ATOLink.DELETE;

        Window.CLOSE;
      END;
    END;

    LOCAL PROCEDURE CheckATOLink@78(SalesLine@1000 : Record 37);
    VAR
      AsmHeader@1001 : Record 900;
    BEGIN
      IF SalesLine."Qty. to Asm. to Order (Base)" = 0 THEN
        EXIT;
      IF SalesLine.AsmToOrderExists(AsmHeader) THEN
        SalesLine.CheckAsmToOrder(AsmHeader);
    END;

    LOCAL PROCEDURE DeleteATOLinks@67(SalesHeader@1000 : Record 36);
    VAR
      ATOLink@1001 : Record 904;
    BEGIN
      WITH ATOLink DO BEGIN
        SETCURRENTKEY(Type,"Document Type","Document No.");
        SETRANGE(Type,Type::Sale);
        SETRANGE("Document Type",SalesHeader."Document Type");
        SETRANGE("Document No.",SalesHeader."No.");
        IF NOT ISEMPTY THEN
          DELETEALL;
      END;
    END;

    LOCAL PROCEDURE HasQtyToAsm@68(SalesLine@1000 : Record 37;AsmHeader@1001 : Record 900) : Boolean;
    BEGIN
      IF SalesLine."Qty. to Asm. to Order (Base)" = 0 THEN
        EXIT(FALSE);
      IF SalesLine."Qty. to Ship (Base)" = 0 THEN
        EXIT(FALSE);
      IF AsmHeader."Quantity to Assemble (Base)" = 0 THEN
        EXIT(FALSE);
      EXIT(TRUE);
    END;

    LOCAL PROCEDURE GetATOItemLedgEntriesNotInvoiced@77(SalesLine@1000 : Record 37;VAR ItemLedgEntryNotInvoiced@1001 : Record 32) : Boolean;
    VAR
      PostedATOLink@1002 : Record 914;
      ItemLedgEntry@1003 : Record 32;
    BEGIN
      ItemLedgEntryNotInvoiced.RESET;
      ItemLedgEntryNotInvoiced.DELETEALL;
      IF PostedATOLink.FindLinksFromSalesLine(SalesLine) THEN
        REPEAT
          ItemLedgEntry.SETCURRENTKEY("Document No.","Document Type","Document Line No.");
          ItemLedgEntry.SETRANGE("Document Type",ItemLedgEntry."Document Type"::"Sales Shipment");
          ItemLedgEntry.SETRANGE("Document No.",PostedATOLink."Document No.");
          ItemLedgEntry.SETRANGE("Document Line No.",PostedATOLink."Document Line No.");
          ItemLedgEntry.SETRANGE("Assemble to Order",TRUE);
          ItemLedgEntry.SETRANGE("Completely Invoiced",FALSE);
          IF ItemLedgEntry.FINDSET THEN
            REPEAT
              IF ItemLedgEntry.Quantity <> ItemLedgEntry."Invoiced Quantity" THEN BEGIN
                ItemLedgEntryNotInvoiced := ItemLedgEntry;
                ItemLedgEntryNotInvoiced.INSERT;
              END;
            UNTIL ItemLedgEntry.NEXT = 0;
        UNTIL PostedATOLink.NEXT = 0;

      EXIT(ItemLedgEntryNotInvoiced.FINDSET);
    END;

    [External]
    PROCEDURE SetWhseJnlRegisterCU@26(VAR WhseJnlRegisterLine@1000 : Codeunit 7301);
    BEGIN
      WhseJnlPostLine := WhseJnlRegisterLine;
    END;

    LOCAL PROCEDURE PostWhseShptLines@74(VAR WhseShptLine2@1000 : Record 7321;SalesShptLine2@1004 : Record 111;VAR SalesLine2@1007 : Record 37);
    VAR
      ATOWhseShptLine@1002 : Record 7321;
      NonATOWhseShptLine@1001 : Record 7321;
      ATOLineFound@1005 : Boolean;
      NonATOLineFound@1003 : Boolean;
      TotalSalesShptLineQty@1006 : Decimal;
    BEGIN
      WhseShptLine2.GetATOAndNonATOLines(ATOWhseShptLine,NonATOWhseShptLine,ATOLineFound,NonATOLineFound);
      IF ATOLineFound THEN
        TotalSalesShptLineQty += ATOWhseShptLine."Qty. to Ship";
      IF NonATOLineFound THEN
        TotalSalesShptLineQty += NonATOWhseShptLine."Qty. to Ship";
      SalesShptLine2.TESTFIELD(Quantity,TotalSalesShptLineQty);

      SaveTempWhseSplitSpec(SalesLine2,TempATOTrackingSpecification);
      WhsePostShpt.SetWhseJnlRegisterCU(WhseJnlPostLine);
      IF ATOLineFound AND (ATOWhseShptLine."Qty. to Ship (Base)" > 0) THEN
        WhsePostShpt.CreatePostedShptLine(
          ATOWhseShptLine,PostedWhseShptHeader,PostedWhseShptLine,TempWhseSplitSpecification);

      SaveTempWhseSplitSpec(SalesLine2,TempHandlingSpecification);
      IF NonATOLineFound AND (NonATOWhseShptLine."Qty. to Ship (Base)" > 0) THEN
        WhsePostShpt.CreatePostedShptLine(
          NonATOWhseShptLine,PostedWhseShptHeader,PostedWhseShptLine,TempWhseSplitSpecification);
    END;

    LOCAL PROCEDURE GetCountryCode@75(SalesLine@1000 : Record 37;SalesHeader@1001 : Record 36) : Code[10];
    VAR
      SalesShipmentHeader@1003 : Record 110;
      CountryRegionCode@1004 : Code[10];
      IsHandled@1002 : Boolean;
    BEGIN
      IsHandled := FALSE;
      OnBeforeGetCountryCode(SalesHeader,SalesLine,CountryRegionCode,IsHandled);
      IF IsHandled THEN
        EXIT(CountryRegionCode);

      IF SalesLine."Shipment No." <> '' THEN BEGIN
        SalesShipmentHeader.GET(SalesLine."Shipment No.");
        EXIT(
          GetCountryRegionCode(
            SalesLine."Sell-to Customer No.",
            SalesShipmentHeader."Ship-to Code",
            SalesShipmentHeader."Sell-to Country/Region Code"));
      END;
      EXIT(
        GetCountryRegionCode(
          SalesLine."Sell-to Customer No.",
          SalesHeader."Ship-to Code",
          SalesHeader."Sell-to Country/Region Code"));
    END;

    LOCAL PROCEDURE GetCountryRegionCode@103(CustNo@1001 : Code[20];ShipToCode@1002 : Code[10];SellToCountryRegionCode@1003 : Code[10]) : Code[10];
    VAR
      ShipToAddress@1000 : Record 222;
    BEGIN
      IF ShipToCode <> '' THEN BEGIN
        ShipToAddress.GET(CustNo,ShipToCode);
        EXIT(ShipToAddress."Country/Region Code");
      END;
      EXIT(SellToCountryRegionCode);
    END;

    LOCAL PROCEDURE UpdateIncomingDocument@95(IncomingDocNo@1000 : Integer;PostingDate@1002 : Date;GenJnlLineDocNo@1003 : Code[20]);
    VAR
      IncomingDocument@1001 : Record 130;
    BEGIN
      IncomingDocument.UpdateIncomingDocumentFromPosting(IncomingDocNo,PostingDate,GenJnlLineDocNo);
    END;

    LOCAL PROCEDURE CheckItemCharge@88(ItemChargeAssgntSales@1000 : Record 5809);
    VAR
      SalesLineForCharge@1001 : Record 37;
    BEGIN
      WITH ItemChargeAssgntSales DO
        CASE "Applies-to Doc. Type" OF
          "Applies-to Doc. Type"::Order,
          "Applies-to Doc. Type"::Invoice:
            IF SalesLineForCharge.GET(
                 "Applies-to Doc. Type",
                 "Applies-to Doc. No.",
                 "Applies-to Doc. Line No.")
            THEN
              IF (SalesLineForCharge."Quantity (Base)" = SalesLineForCharge."Qty. Shipped (Base)") AND
                 (SalesLineForCharge."Qty. Shipped Not Invd. (Base)" = 0)
              THEN
                ERROR(ReassignItemChargeErr);
          "Applies-to Doc. Type"::"Return Order",
          "Applies-to Doc. Type"::"Credit Memo":
            IF SalesLineForCharge.GET(
                 "Applies-to Doc. Type",
                 "Applies-to Doc. No.",
                 "Applies-to Doc. Line No.")
            THEN
              IF (SalesLineForCharge."Quantity (Base)" = SalesLineForCharge."Return Qty. Received (Base)") AND
                 (SalesLineForCharge."Ret. Qty. Rcd. Not Invd.(Base)" = 0)
              THEN
                ERROR(ReassignItemChargeErr);
        END;
    END;

    LOCAL PROCEDURE CheckItemReservDisruption@104(SalesLine@1001 : Record 37);
    VAR
      ConfirmManagement@1002 : Codeunit 27;
      AvailableQty@1000 : Decimal;
    BEGIN
      WITH SalesLine DO BEGIN
        IF NOT ("Document Type" IN ["Document Type"::Order,"Document Type"::Invoice]) OR
           (Type <> Type::Item) OR NOT ("Qty. to Ship (Base)" > 0)
        THEN
          EXIT;
        IF ("Job Contract Entry No." <> 0) OR
           Nonstock OR "Special Order" OR "Drop Shipment" OR
           IsNonInventoriableItem OR FullQtyIsForAsmToOrder OR
           TempSKU.GET("Location Code","No.","Variant Code") // Warn against item
        THEN
          EXIT;

        Item.SETFILTER("Location Filter","Location Code");
        Item.SETFILTER("Variant Filter","Variant Code");
        Item.CALCFIELDS("Reserved Qty. on Inventory","Net Change");
        CALCFIELDS("Reserved Qty. (Base)");
        AvailableQty := Item."Net Change" - (Item."Reserved Qty. on Inventory" - "Reserved Qty. (Base)");

        IF (Item."Reserved Qty. on Inventory" > 0) AND
           (AvailableQty < "Qty. to Ship (Base)") AND
           (Item."Reserved Qty. on Inventory" > "Reserved Qty. (Base)")
        THEN BEGIN
          InsertTempSKU("Location Code","No.","Variant Code");
          IF NOT ConfirmManagement.ConfirmProcess(
               STRSUBSTNO(
                 ReservationDisruptedQst,FIELDCAPTION("No."),Item."No.",FIELDCAPTION("Location Code"),
                 "Location Code",FIELDCAPTION("Variant Code"),"Variant Code"),TRUE)
          THEN
            ERROR('');
        END;
      END;
    END;

    LOCAL PROCEDURE InsertTempSKU@106(LocationCode@1000 : Code[10];ItemNo@1001 : Code[20];VariantCode@1002 : Code[10]);
    BEGIN
      WITH TempSKU DO BEGIN
        INIT;
        "Location Code" := LocationCode;
        "Item No." := ItemNo;
        "Variant Code" := VariantCode;
        INSERT;
      END;
    END;

    [External]
    PROCEDURE InitProgressWindow@105(SalesHeader@1000 : Record 36);
    BEGIN
      IF SalesHeader.Invoice THEN
        Window.OPEN(
          '#1#################################\\' +
          PostingLinesMsg +
          PostingSalesAndVATMsg +
          PostingCustomersMsg +
          PostingBalAccountMsg)
      ELSE
        Window.OPEN(
          '#1#################################\\' +
          PostingLines2Msg);

      Window.UPDATE(1,STRSUBSTNO('%1 %2',SalesHeader."Document Type",SalesHeader."No."));
    END;

    LOCAL PROCEDURE CheckCertificateOfSupplyStatus@188(SalesShptHeader@1001 : Record 110;SalesShptLine@1000 : Record 111);
    VAR
      CertificateOfSupply@1002 : Record 780;
      VATPostingSetup@1003 : Record 325;
    BEGIN
      IF SalesShptLine.Quantity <> 0 THEN
        IF VATPostingSetup.GET(SalesShptHeader."VAT Bus. Posting Group",SalesShptLine."VAT Prod. Posting Group") AND
           VATPostingSetup."Certificate of Supply Required"
        THEN BEGIN
          CertificateOfSupply.InitFromSales(SalesShptHeader);
          CertificateOfSupply.SetRequired(SalesShptHeader."No.");
        END;
    END;

    LOCAL PROCEDURE HasSpecificTracking@107(ItemNo@1000 : Code[20]) : Boolean;
    VAR
      Item@1001 : Record 27;
      ItemTrackingCode@1002 : Record 6502;
    BEGIN
      Item.GET(ItemNo);
      IF Item."Item Tracking Code" <> '' THEN BEGIN
        ItemTrackingCode.GET(Item."Item Tracking Code");
        EXIT(ItemTrackingCode."SN Specific Tracking" OR ItemTrackingCode."Lot Specific Tracking");
      END;
    END;

    LOCAL PROCEDURE HasInvtPickLine@108(SalesLine@1000 : Record 37) : Boolean;
    VAR
      WhseActivityLine@1001 : Record 5767;
    BEGIN
      WITH WhseActivityLine DO BEGIN
        SETRANGE("Activity Type","Activity Type"::"Invt. Pick");
        SETRANGE("Source Type",DATABASE::"Sales Line");
        SETRANGE("Source Subtype",SalesLine."Document Type");
        SETRANGE("Source No.",SalesLine."Document No.");
        SETRANGE("Source Line No.",SalesLine."Line No.");
        EXIT(NOT ISEMPTY);
      END;
    END;

    LOCAL PROCEDURE InsertPostedHeaders@139(VAR SalesHeader@1000 : Record 36;VAR ReferenceNo@1090000 : Code[20];VAR TotalROT@1101285001 : Decimal;VAR TotalRUT@1101285000 : Decimal);
    VAR
      SalesShptLine@1001 : Record 111;
      PurchRcptLine@1003 : Record 121;
      GenJnlLine@1002 : Record 81;
      PostingPreviewEventHandler@1004 : Codeunit 20;
      IsHandled@1005 : Boolean;
    BEGIN
      OnBeforeInsertPostedHeaders(SalesHeader,TempWhseShptHeader,TempWhseRcptHeader);
      IF PreviewMode THEN
        PostingPreviewEventHandler.PreventCommit;
      WITH SalesHeader DO BEGIN
        // Insert shipment header
        IF Ship THEN BEGIN
          IF ("Document Type" = "Document Type"::Order) OR
             (("Document Type" = "Document Type"::Invoice) AND SalesSetup."Shipment on Invoice")
          THEN BEGIN
            IF DropShipOrder THEN BEGIN
              PurchRcptHeader.LOCKTABLE;
              PurchRcptLine.LOCKTABLE;
              SalesShptHeader.LOCKTABLE;
              SalesShptLine.LOCKTABLE;
            END;
            InsertShipmentHeader(SalesHeader,SalesShptHeader);
          END;

      //**4PS.so No Support for Service Item Management
      //    ServItemMgt.CopyReservationEntry(SalesHeader);
      //    IF ("Document Type" = "Document Type"::Invoice) AND
      //       (NOT SalesSetup."Shipment on Invoice")
      //    THEN
      //      ServItemMgt.CreateServItemOnSalesInvoice(SalesHeader);
      //**4PS.so
        END;

      //  ServItemMgt.DeleteServItemOnSaleCreditMemo(SalesHeader); //**4PS.o

        // Insert return receipt header
        IF Receive THEN
          IF ("Document Type" = "Document Type"::"Return Order") OR
             (("Document Type" = "Document Type"::"Credit Memo") AND SalesSetup."Return Receipt on Credit Memo")
          THEN
            InsertReturnReceiptHeader(SalesHeader,ReturnRcptHeader);

        //**4PS.sn
        IF InvoiceOrderNotPostedInvoice THEN
          InsertNotPostedSalesInvoice(SalesHeader);
        //**4PS.en

        TotalROT := 0;  //4PSSE
        TotalRUT := 0; //RFC188
        IsHandled := FALSE;
        OnInsertPostedHeadersOnBeforeInsertInvoiceHeader(SalesHeader,IsHandled);
        IF NOT IsHandled THEN
          // Insert invoice header or credit memo header
          IF Invoice THEN
            IF "Document Type" IN ["Document Type"::Order,"Document Type"::Invoice] THEN BEGIN
              //InsertInvoiceHeader(SalesHeader,SalesInvHeader);
              InsertInvoiceHeader(SalesHeader,SalesInvHeader,TotalROT,TotalRUT);
              ReplaceDocLink := TRUE; //**4PS.n
              GenJnlLineDocType := GenJnlLine."Document Type"::Invoice;
              GenJnlLineDocNo := SalesInvHeader."No.";
              GenJnlLineExtDocNo := SalesInvHeader."External Document No.";
              ReferenceNo := SalesInvHeader."Reference No.";  //NAVFI
            END ELSE BEGIN // Credit Memo
              //InsertCrMemoHeader(SalesHeader,SalesCrMemoHeader);
              InsertCrMemoHeader(SalesHeader,SalesCrMemoHeader,TotalROT,TotalRUT);
              ReplaceDocLink := TRUE; //**4PS.n
              GenJnlLineDocType := GenJnlLine."Document Type"::"Credit Memo";
              GenJnlLineDocNo := SalesCrMemoHeader."No.";
              GenJnlLineExtDocNo := SalesCrMemoHeader."External Document No.";
            END;
      END;
    END;

    LOCAL PROCEDURE InsertShipmentHeader@110(VAR SalesHeader@1000 : Record 36;VAR SalesShptHeader@1001 : Record 110);
    VAR
      SalesCommentLine@1002 : Record 44;
      RecordLinkManagement@1003 : Codeunit 447;
      SalesHeaderExtension@1100525000 : Record 11071868;
    BEGIN
      WITH SalesHeader DO BEGIN
        SalesShptHeader.INIT;
        CALCFIELDS("Work Description");
        SalesShptHeader.TRANSFERFIELDS(SalesHeader);

        //**4PS.sn
        SalesHeaderExtension.GetSalesHeadExtension("Document Type", "No.");
        SalesShptHeader."E-Mail (Shipments)" := SalesHeaderExtension."E-Mail (Shipments)";
        SalesShptHeader."Shipment per E-Mail" := SalesHeaderExtension."Shipment per E-Mail";
        //**4PS.en

        SalesShptHeader."No." := "Shipping No.";
        IF "Document Type" = "Document Type"::Order THEN BEGIN
          SalesShptHeader."Order No. Series" := "No. Series";
          SalesShptHeader."Order No." := "No.";
          IF SalesSetup."Ext. Doc. No. Mandatory" THEN
            TESTFIELD("External Document No.");
        END;
        SalesShptHeader."Source Code" := SrcCode;
        SalesShptHeader."User ID" := USERID;
        SalesShptHeader."No. Printed" := 0;
        OnBeforeSalesShptHeaderInsert(SalesShptHeader,SalesHeader,SuppressCommit);
        SalesShptHeader.INSERT(TRUE);
        OnAfterSalesShptHeaderInsert(SalesShptHeader,SalesHeader,SuppressCommit);

        ApprovalsMgmt.PostApprovalEntries(RECORDID,SalesShptHeader.RECORDID,SalesShptHeader."No.");

        IF SalesSetup."Copy Comments Order to Shpt." THEN BEGIN
          SalesCommentLine.CopyComments(
            "Document Type",SalesCommentLine."Document Type"::Shipment,"No.",SalesShptHeader."No.");
          RecordLinkManagement.CopyLinks(SalesHeader,SalesShptHeader);
        END;
        IF WhseShip THEN BEGIN
          WhseShptHeader.GET(TempWhseShptHeader."No.");
          OnBeforeCreatePostedWhseShptHeader(PostedWhseShptHeader,WhseShptHeader,SalesHeader);
          WhsePostShpt.CreatePostedShptHeader(PostedWhseShptHeader,WhseShptHeader,"Shipping No.","Posting Date");
        END;
        IF WhseReceive THEN BEGIN
          WhseRcptHeader.GET(TempWhseRcptHeader."No.");
          OnBeforeCreatePostedWhseRcptHeader(PostedWhseRcptHeader,WhseRcptHeader,SalesHeader);
          WhsePostRcpt.CreatePostedRcptHeader(PostedWhseRcptHeader,WhseRcptHeader,"Shipping No.","Posting Date");
        END;
      END;
    END;

    LOCAL PROCEDURE InsertReturnReceiptHeader@113(VAR SalesHeader@1000 : Record 36;VAR ReturnRcptHeader@1001 : Record 6660);
    VAR
      SalesCommentLine@1002 : Record 44;
      RecordLinkManagement@1003 : Codeunit 447;
      IsHandled@1004 : Boolean;
    BEGIN
      OnBeforeInsertReturnReceiptHeader(SalesHeader,ReturnRcptHeader,IsHandled,SuppressCommit);

      WITH SalesHeader DO BEGIN
        IF NOT IsHandled THEN BEGIN
          ReturnRcptHeader.INIT;
          ReturnRcptHeader.TRANSFERFIELDS(SalesHeader);
          ReturnRcptHeader."No." := "Return Receipt No.";
          IF "Document Type" = "Document Type"::"Return Order" THEN BEGIN
            ReturnRcptHeader."Return Order No. Series" := "No. Series";
            ReturnRcptHeader."Return Order No." := "No.";
            IF SalesSetup."Ext. Doc. No. Mandatory" THEN
              TESTFIELD("External Document No.");
          END;
          ReturnRcptHeader."No. Series" := "Return Receipt No. Series";
          ReturnRcptHeader."Source Code" := SrcCode;
          ReturnRcptHeader."User ID" := USERID;
          ReturnRcptHeader."No. Printed" := 0;
          OnBeforeReturnRcptHeaderInsert(ReturnRcptHeader,SalesHeader,SuppressCommit);
          ReturnRcptHeader.INSERT(TRUE);
          OnAfterReturnRcptHeaderInsert(ReturnRcptHeader,SalesHeader,SuppressCommit);

          ApprovalsMgmt.PostApprovalEntries(RECORDID,ReturnRcptHeader.RECORDID,ReturnRcptHeader."No.");

          IF SalesSetup."Copy Cmts Ret.Ord. to Ret.Rcpt" THEN BEGIN
            SalesCommentLine.CopyComments(
              "Document Type",SalesCommentLine."Document Type"::"Posted Return Receipt","No.",ReturnRcptHeader."No.");
            RecordLinkManagement.CopyLinks(SalesHeader,ReturnRcptHeader);
          END;
        END;

        IF WhseReceive THEN BEGIN
          WhseRcptHeader.GET(TempWhseRcptHeader."No.");
          OnBeforeCreatePostedWhseRcptHeader(PostedWhseRcptHeader,WhseRcptHeader,SalesHeader);
          WhsePostRcpt.CreatePostedRcptHeader(PostedWhseRcptHeader,WhseRcptHeader,"Return Receipt No.","Posting Date");
        END;
        IF WhseShip THEN BEGIN
          WhseShptHeader.GET(TempWhseShptHeader."No.");
          OnBeforeCreatePostedWhseShptHeader(PostedWhseShptHeader,WhseShptHeader,SalesHeader);
          WhsePostShpt.CreatePostedShptHeader(PostedWhseShptHeader,WhseShptHeader,"Return Receipt No.","Posting Date");
        END;
      END;
    END;

    LOCAL PROCEDURE InsertInvoiceHeader@116(VAR SalesHeader@1000 : Record 36;VAR SalesInvHeader@1001 : Record 112;VAR TotalROT@1100285500 : Decimal;VAR TotalRUT@1101285001 : Decimal);
    VAR
      SalesCommentLine@1002 : Record 44;
      RecordLinkManagement@1003 : Codeunit 447;
      SegManagement@1004 : Codeunit 5051;
      BankNosCheck@1090000 : Codeunit 11126182;
      ReferenceNo@1090001 : Code[20];
      SalesOfferAmount@1100485003 : Record 11012786;
      SalesHeaderExtension@1100525000 : Record 11071868;
      ROTInformation@1100285504 : Record 11128101;
      Invoice_ROTInformation@1100285503 : Record 11128101;
      SEUtils@1101285000 : Codeunit 11128000;
    BEGIN
      WITH SalesHeader DO BEGIN
        SalesInvHeader.INIT;
        CALCFIELDS("Work Description");
        SalesInvHeader.TRANSFERFIELDS(SalesHeader);

        SalesInvHeader."No." := "Posting No.";
        IF "Document Type" = "Document Type"::Order THEN BEGIN
          IF SalesSetup."Ext. Doc. No. Mandatory" THEN
            TESTFIELD("External Document No.");
          SalesInvHeader."Pre-Assigned No. Series" := '';
          SalesInvHeader."Order No. Series" := "No. Series";
          SalesInvHeader."Order No." := "No.";
          //>>NAVFI
          GetGLSetup;
          IF GLSetup."Finnish localization active" AND (NOT PreviewMode) THEN
            ReferenceNo := BankNosCheck.CreateSalesInvReference (SalesInvHeader."No.","Bill-to Customer No.");
          //<<NAVFI
        END ELSE BEGIN
          IF "Posting No." = '' THEN
            SalesInvHeader."No." := "No.";
          SalesInvHeader."Pre-Assigned No. Series" := "No. Series";
          SalesInvHeader."Pre-Assigned No." := "No.";

          //**4PS.sn
          SalesInvHeader."Order No." := "Related Sales Order No.";
          IF SetRentalUnitInvoice THEN BEGIN
            SalesInvHeader."Rental Unit Invoice" := TRUE;
            SalesInvHeader."Job No." := RentalUnitProjectNo;
          END;
          //**4PS.en
          //>>NAVFI
          GetGLSetup;
          IF GLSetup."Finnish localization active" THEN
            ReferenceNo := BankNosCheck.CreateSalesInvReference ("No.","Bill-to Customer No.");
          //<<NAVFI

        END;
        IF GUIALLOWED AND NOT HideProgressWindow THEN
          Window.UPDATE(1,STRSUBSTNO(InvoiceNoMsg,"Document Type","No.",SalesInvHeader."No."));

        // 4PSE *** 141007 ITERO.MH <<
        IF (SalesSetup."External Doc. No. as Pmt. Ref") THEN BEGIN
           IF (STRLEN(DELCHR(SalesInvHeader."No.", '=', '0123456789')) = 0) THEN  // Can only create ocr from number fields
              SalesInvHeader."External Document No." := SEUtils.makeOCR10ref(SalesInvHeader."No.",TRUE); //IME502
        END;
        // 4PSE *** 141007 ITERO.MH >>

        //**4PS.sn
        SalesHeaderExtension.GetSalesHeadExtension("Document Type", "No.");
        SalesInvHeader."E-Mail (Invoices)" := SalesHeaderExtension."E-Mail (Invoices)";
        SalesInvHeader."Electronic Invoicing" := SalesHeaderExtension."Electronic Invoicing";
        SalesInvHeader."Combine E-Mail Attachments" := SalesHeaderExtension."Combine E-Mail Attachments";
        //**4PS.en
        // *** 4PSSE.I012 *** 130711 <<
        IF ("ROT/RUT reduction") THEN BEGIN
          TotalROT := 0; // 140416
          TotalRUT := 0;  //RFC188
          ROTInformation.RESET();
          ROTInformation.SETRANGE(Type, ROTInformation.Type::Invoice);
          ROTInformation.SETRANGE("Invoice No.", "No.");
          IF (ROTInformation.FINDSET(TRUE)) THEN REPEAT
            //>> 160304 ITERO.SB Extension lines only mandatory then using electronic rot-file
            // 150320 <<
            IF SalesSetup."ROTRUT Application No."<>0 THEN BEGIN
              ROTInformation.CALCFIELDS("Extension Lines");
              ROTInformation.TESTFIELD("Extension Lines"); // Extension Lines Mandatory before posting
            END;
            // 150320 >>
            //<<
            ROTInformation.TESTFIELD("Personal No."); // 140813 ITERO.MH
            // Change the invoice to "Posted Invoice" and add invoice no.
            //>>RFC188
            //TotalROT += ROTInformation.Amount;
            CASE ROTInformation."Application Type" OF
              ROTInformation."Application Type"::ROT: TotalROT += ROTInformation.Amount;
              ROTInformation."Application Type"::RUT: TotalRUT += ROTInformation.Amount;
            END;
            //<<RFC188
            Invoice_ROTInformation := ROTInformation;
            Invoice_ROTInformation.Type := ROTInformation.Type::"Posted Invoice";
            Invoice_ROTInformation."Invoice No." := SalesInvHeader."No.";
            Invoice_ROTInformation.INSERT(); // 140411 Create a "Posted Invoice" ROT-info Line
            Invoice_ROTInformation.CopyExtendedROTInformation(ROTInformation); // 150320
          UNTIL ROTInformation.NEXT = 0;
          ROTInformation.DELETEALL(TRUE); // 140411 Delete the old "Invoice" Rot Information line  150320 Added Trigger TRUE
        END;
        // *** 4PSSE.I012 *** 130711 >>
        SalesInvHeader."Source Code" := SrcCode;
        SalesInvHeader."Reference No." := ReferenceNo;  //NAVFI
        SalesInvHeader."User ID" := USERID;
        SalesInvHeader."No. Printed" := 0;
        SetPaymentInstructions(SalesHeader);
        OnBeforeSalesInvHeaderInsert(SalesInvHeader,SalesHeader,SuppressCommit);
        SalesInvHeader.INSERT(TRUE);
        OnAfterSalesInvHeaderInsert(SalesInvHeader,SalesHeader,SuppressCommit);

        UpdateWonOpportunities(SalesHeader);
        SegManagement.CreateCampaignEntryOnSalesInvoicePosting(SalesInvHeader);

        //**4PS.sn
        IF "Sales Document Type" = "Sales Document Type"::"Sales Logistics Separated" THEN
          IF SalesOfferAmount.GET("Document Type", "No.", 0) THEN BEGIN
            SalesOfferAmount."Document Type" := SalesOfferAmount."Document Type"::"Posted Invoice";
            SalesOfferAmount."Document No." := SalesInvHeader."No.";
            SalesOfferAmount.INSERT;
          END;
        //**4PS.en

        ApprovalsMgmt.PostApprovalEntries(RECORDID,SalesInvHeader.RECORDID,SalesInvHeader."No.");

        IF SalesSetup."Copy Comments Order to Invoice" THEN BEGIN
          SalesCommentLine.CopyComments(
            "Document Type",SalesCommentLine."Document Type"::"Posted Invoice","No.",SalesInvHeader."No.");
          RecordLinkManagement.CopyLinks(SalesHeader,SalesInvHeader);
        END;
      END;
    END;

    LOCAL PROCEDURE InsertCrMemoHeader@118(VAR SalesHeader@1000 : Record 36;VAR SalesCrMemoHeader@1001 : Record 114;VAR TotalROT@1100285500 : Decimal;VAR TotalRUT@1101285001 : Decimal);
    VAR
      SalesCommentLine@1002 : Record 44;
      RecordLinkManagement@1003 : Codeunit 447;
      SalesHeaderExtension@1100525000 : Record 11071868;
      ROTInformation@1100285502 : Record 11128101;
      Invoice_ROTInformation@1100285501 : Record 11128101;
      SEUtils@1101285000 : Codeunit 11128000;
    BEGIN
      WITH SalesHeader DO BEGIN
        SalesCrMemoHeader.INIT;
        CALCFIELDS("Work Description");
        SalesCrMemoHeader.TRANSFERFIELDS(SalesHeader);
        SalesCrMemoHeader."Inserted By" := SalesHeader."Inserted By"; //**4PS.n
        IF "Document Type" = "Document Type"::"Return Order" THEN BEGIN
          SalesCrMemoHeader."No." := "Posting No.";
          IF SalesSetup."Ext. Doc. No. Mandatory" THEN
            TESTFIELD("External Document No.");
          SalesCrMemoHeader."Pre-Assigned No. Series" := '';
          SalesCrMemoHeader."Return Order No. Series" := "No. Series";
          SalesCrMemoHeader."Return Order No." := "No.";
          IF GUIALLOWED AND NOT HideProgressWindow THEN
            Window.UPDATE(1,STRSUBSTNO(CreditMemoNoMsg,"Document Type","No.",SalesCrMemoHeader."No."));
        END ELSE BEGIN
          SalesCrMemoHeader."Pre-Assigned No. Series" := "No. Series";
          SalesCrMemoHeader."Pre-Assigned No." := "No.";

          //**4PS.sn
          FillSalesCrMemoHeadReturnOrder(SalesCrMemoHeader,SalesHeader); //C016332
          IF SetRentalUnitInvoice THEN BEGIN
            SalesCrMemoHeader."Rental Unit Invoice" := TRUE;
            SalesCrMemoHeader."Job No." := RentalUnitProjectNo;
          END;
          //**4PS.sn

          IF "Posting No." <> '' THEN BEGIN
            SalesCrMemoHeader."No." := "Posting No.";
            IF GUIALLOWED AND NOT HideProgressWindow THEN
              Window.UPDATE(1,STRSUBSTNO(CreditMemoNoMsg,"Document Type","No.",SalesCrMemoHeader."No."));
          END;
        END;
        // 4PSE IME219 *** 141015 ITERO.MH <<
        IF (SalesSetup."External Doc. No. as Pmt. Ref") THEN BEGIN
           IF (STRLEN(DELCHR(SalesCrMemoHeader."No.", '=', '0123456789')) = 0) THEN  // Can only create ocr from number fields
              SalesCrMemoHeader."External Document No." := SEUtils.makeOCR10ref(SalesCrMemoHeader."No.",TRUE);
        END;
        // 4PSE IME219 *** 141015 ITERO.MH >>

        // I012 141008 <<
        IF ("ROT/RUT reduction") THEN BEGIN
          TotalROT := 0;
          TotalRUT := 0;  //RFC188
          ROTInformation.RESET();
          ROTInformation.SETRANGE(Type, ROTInformation.Type::"Posted Invoice");
          ROTInformation.SETRANGE("Invoice No.", "Applies-to Doc. No.");
          IF (ROTInformation.FINDSET(FALSE)) THEN REPEAT
            //>>RFC188
            //TotalROT += ROTInformation.Amount;
            CASE ROTInformation."Application Type" OF
              ROTInformation."Application Type"::ROT: TotalROT += ROTInformation.Amount;
              ROTInformation."Application Type"::RUT: TotalRUT += ROTInformation.Amount;
            END;
            //<<RFC188
          UNTIL ROTInformation.NEXT = 0;
        END;
        // I012 141008 >>
        //**4PS.sn
        SalesHeaderExtension.GetSalesHeadExtension("Document Type", "No.");
        SalesCrMemoHeader."E-Mail (Invoices)" := SalesHeaderExtension."E-Mail (Invoices)";
        SalesCrMemoHeader."Electronic Invoicing" := SalesHeaderExtension."Electronic Invoicing";
        SalesCrMemoHeader."Combine E-Mail Attachments" := SalesHeaderExtension."Combine E-Mail Attachments";
        //**4PS.en
        SalesCrMemoHeader."Source Code" := SrcCode;
        SalesCrMemoHeader."User ID" := USERID;
        SalesCrMemoHeader."No. Printed" := 0;
        OnBeforeSalesCrMemoHeaderInsert(SalesCrMemoHeader,SalesHeader,SuppressCommit);
        SalesCrMemoHeader.INSERT(TRUE);
        OnAfterSalesCrMemoHeaderInsert(SalesCrMemoHeader,SalesHeader,SuppressCommit);

        ApprovalsMgmt.PostApprovalEntries(RECORDID,SalesCrMemoHeader.RECORDID,SalesCrMemoHeader."No.");

        IF SalesSetup."Copy Cmts Ret.Ord. to Cr. Memo" THEN BEGIN
          SalesCommentLine.CopyComments(
            "Document Type",SalesCommentLine."Document Type"::"Posted Credit Memo","No.",SalesCrMemoHeader."No.");
          RecordLinkManagement.CopyLinks(SalesHeader,SalesCrMemoHeader);
        END;
      END;
    END;

    LOCAL PROCEDURE InsertPurchRcptHeader@274(VAR PurchaseHeader@1000 : Record 38;VAR SalesHeader@1002 : Record 36;VAR PurchRcptHeader@1001 : Record 120);
    BEGIN
      WITH PurchRcptHeader DO BEGIN
        INIT;
        TRANSFERFIELDS(PurchaseHeader);
        "No." := PurchaseHeader."Receiving No.";
        "Order No." := PurchaseHeader."No.";
        "Posting Date" := SalesHeader."Posting Date";
        "Document Date" := SalesHeader."Document Date";
        "No. Printed" := 0;
        OnBeforePurchRcptHeaderInsert(PurchRcptHeader,PurchaseHeader,SalesHeader,SuppressCommit);
        INSERT;
        OnAfterPurchRcptHeaderInsert(PurchRcptHeader,PurchaseHeader,SalesHeader,SuppressCommit);
      END;
    END;

    LOCAL PROCEDURE InsertPurchRcptLine@277(PurchRcptHeader@1000 : Record 120;PurchOrderLine@1002 : Record 39;DropShptPostBuffer@1003 : Record 223);
    VAR
      PurchRcptLine@1001 : Record 121;
    BEGIN
      WITH PurchRcptLine DO BEGIN
        INIT;
        TRANSFERFIELDS(PurchOrderLine);
        "Posting Date" := PurchRcptHeader."Posting Date";
        "Document No." := PurchRcptHeader."No.";
        Quantity := DropShptPostBuffer.Quantity;
        "Quantity (Base)" := DropShptPostBuffer."Quantity (Base)";
        "Quantity Invoiced" := 0;
        "Qty. Invoiced (Base)" := 0;
        "Order No." := PurchOrderLine."Document No.";
        "Order Line No." := PurchOrderLine."Line No.";
        "Qty. Rcd. Not Invoiced" := Quantity - "Quantity Invoiced";
        IF Quantity <> 0 THEN BEGIN
          "Item Rcpt. Entry No." := DropShptPostBuffer."Item Shpt. Entry No.";
          "Item Charge Base Amount" := PurchOrderLine."Line Amount"
        END;
        OnBeforePurchRcptLineInsert(PurchRcptLine,PurchRcptHeader,PurchOrderLine,DropShptPostBuffer,SuppressCommit);
        INSERT;
        OnAfterPurchRcptLineInsert(PurchRcptLine,PurchRcptHeader,PurchOrderLine,DropShptPostBuffer,SuppressCommit);
      END;
    END;

    LOCAL PROCEDURE InsertShipmentLine@143(SalesHeader@1008 : Record 36;SalesShptHeader@1000 : Record 110;SalesLine@1001 : Record 37;CostBaseAmount@1003 : Decimal;VAR TempServiceItem2@1013 : TEMPORARY Record 5940;VAR TempServiceItemComp2@1009 : TEMPORARY Record 5941);
    VAR
      SalesShptLine@1004 : Record 111;
      WhseShptLine@1005 : Record 7321;
      WhseRcptLine@1006 : Record 7317;
    BEGIN
      SalesShptLine.InitFromSalesLine(SalesShptHeader,xSalesLine);
      SalesShptLine."Quantity Invoiced" := -RemQtyToBeInvoiced;
      SalesShptLine."Qty. Invoiced (Base)" := -RemQtyToBeInvoicedBase;
      SalesShptLine."Qty. Shipped Not Invoiced" := SalesShptLine.Quantity - SalesShptLine."Quantity Invoiced";

      IF (SalesLine.Type = SalesLine.Type::Item) AND (SalesLine."Qty. to Ship" <> 0) THEN BEGIN
        IF WhseShip THEN
          IF WhseShptLine.GetWhseShptLine(
               WhseShptHeader."No.",DATABASE::"Sales Line",SalesLine."Document Type",SalesLine."Document No.",SalesLine."Line No.")
          THEN
            PostWhseShptLines(WhseShptLine,SalesShptLine,SalesLine);

        IF WhseReceive THEN
          IF WhseRcptLine.GetWhseRcptLine(
               WhseRcptHeader."No.",DATABASE::"Sales Line",SalesLine."Document Type",SalesLine."Document No.",SalesLine."Line No.")
          THEN BEGIN
            WhseRcptLine.TESTFIELD("Qty. to Receive",-SalesShptLine.Quantity);
            SaveTempWhseSplitSpec(SalesLine,TempHandlingSpecification);
            WhsePostRcpt.CreatePostedRcptLine(
              WhseRcptLine,PostedWhseRcptHeader,PostedWhseRcptLine,TempWhseSplitSpecification);
          END;

        SalesShptLine."Item Shpt. Entry No." :=
          InsertShptEntryRelation(SalesShptLine); // ItemLedgShptEntryNo
        SalesShptLine."Item Charge Base Amount" :=
          ROUND(CostBaseAmount / SalesLine.Quantity * SalesShptLine.Quantity);
      END;
      //>>NAVNO
      IF GLSetup."Norwegian Localization Active" THEN
        SalesShptLine."Qty. Remaining" := xSalesLine.Quantity - xSalesLine."Quantity Shipped" - xSalesLine."Qty. to Ship";  //NAVNO
      //<<NAVNO
      OnBeforeSalesShptLineInsert(
        SalesShptLine,SalesShptHeader,SalesLine,SuppressCommit,PostedWhseShptLine,SalesHeader,WhseShip,WhseReceive,
        ItemLedgShptEntryNo);
      SalesShptLine.INSERT(TRUE);
      OnAfterSalesShptLineInsert(
        SalesShptLine,SalesLine,ItemLedgShptEntryNo,WhseShip,WhseReceive,SuppressCommit,SalesInvHeader);

      CheckCertificateOfSupplyStatus(SalesShptHeader,SalesShptLine);

      OnInvoiceSalesShptLine(SalesShptLine,SalesInvHeader."No.",xSalesLine."Line No.",xSalesLine."Qty. to Invoice",SuppressCommit);

      //**4PS.so No Support for Service Item Management
      // ServItemMgt.CreateServItemOnSalesLineShpt(SalesHeader,xSalesLine,SalesShptLine);
      // IF SalesLine."BOM Item No." <> '' THEN BEGIN
      // ServItemMgt.ReturnServItemComp(TempServiceItem1,TempServiceItemComp1);
      // IF TempServiceItem1.FINDSET THEN
      //  REPEAT
      //    TempServiceItem2 := TempServiceItem1;
      //    IF TempServiceItem2.INSERT THEN;
      //  UNTIL TempServiceItem1.NEXT = 0;
      // IF TempServiceItemComp1.FINDSET THEN
      //  REPEAT
      //    TempServiceItemComp2 := TempServiceItemComp1;
      //    IF TempServiceItemComp2.INSERT THEN;
      //  UNTIL TempServiceItemComp1.NEXT = 0;
      // END;
      //**4PS.eo

      //**4PS.sn DP00121
      IF xSalesLine."Qty. to Ship" <> 0 THEN
        PostNSItemTracking(SalesHeader,xSalesLine,SalesShptLine);
      //**4PS.en
    END;

    LOCAL PROCEDURE InsertReturnReceiptLine@146(ReturnRcptHeader@1000 : Record 6660;SalesLine@1001 : Record 37;CostBaseAmount@1003 : Decimal);
    VAR
      ReturnRcptLine@1004 : Record 6661;
      WhseShptLine@1006 : Record 7321;
      WhseRcptLine@1005 : Record 7317;
    BEGIN
      OnBeforeInsertReturnReceiptLine(SalesLine,ReturnRcptLine,RemQtyToBeInvoiced,RemQtyToBeInvoicedBase);
      ReturnRcptLine.InitFromSalesLine(ReturnRcptHeader,xSalesLine);
      ReturnRcptLine."Quantity Invoiced" := RemQtyToBeInvoiced;
      ReturnRcptLine."Qty. Invoiced (Base)" := RemQtyToBeInvoicedBase;
      ReturnRcptLine."Return Qty. Rcd. Not Invd." := ReturnRcptLine.Quantity - ReturnRcptLine."Quantity Invoiced";

      IF (SalesLine.Type = SalesLine.Type::Item) AND (SalesLine."Return Qty. to Receive" <> 0) THEN BEGIN
        IF WhseReceive THEN
          IF WhseRcptLine.GetWhseRcptLine(
               WhseRcptHeader."No.",DATABASE::"Sales Line",SalesLine."Document Type",SalesLine."Document No.",SalesLine."Line No.")
          THEN BEGIN
            WhseRcptLine.TESTFIELD("Qty. to Receive",ReturnRcptLine.Quantity);
            SaveTempWhseSplitSpec(SalesLine,TempHandlingSpecification);
            WhsePostRcpt.CreatePostedRcptLine(
              WhseRcptLine,PostedWhseRcptHeader,PostedWhseRcptLine,TempWhseSplitSpecification);
          END;

        IF WhseShip THEN
          IF WhseShptLine.GetWhseShptLine(
               WhseShptHeader."No.",DATABASE::"Sales Line",SalesLine."Document Type",SalesLine."Document No.",SalesLine."Line No.")
          THEN BEGIN
            WhseShptLine.TESTFIELD("Qty. to Ship",-ReturnRcptLine.Quantity);
            SaveTempWhseSplitSpec(SalesLine,TempHandlingSpecification);
            WhsePostShpt.SetWhseJnlRegisterCU(WhseJnlPostLine);
            WhsePostShpt.CreatePostedShptLine(
              WhseShptLine,PostedWhseShptHeader,PostedWhseShptLine,TempWhseSplitSpecification);
          END;

        ReturnRcptLine."Item Rcpt. Entry No." :=
          InsertReturnEntryRelation(ReturnRcptLine); // ItemLedgShptEntryNo;
        ReturnRcptLine."Item Charge Base Amount" :=
          ROUND(CostBaseAmount / SalesLine.Quantity * ReturnRcptLine.Quantity);
      END;
      OnBeforeReturnRcptLineInsert(ReturnRcptLine,ReturnRcptHeader,SalesLine,SuppressCommit);
      ReturnRcptLine.INSERT(TRUE);
      OnAfterReturnRcptLineInsert(
        ReturnRcptLine,ReturnRcptHeader,SalesLine,ItemLedgShptEntryNo,WhseShip,WhseReceive,SuppressCommit,SalesCrMemoHeader);
    END;

    LOCAL PROCEDURE CheckICPartnerBlocked@20(SalesHeader@1000 : Record 36);
    VAR
      ICPartner@1001 : Record 413;
    BEGIN
      WITH SalesHeader DO BEGIN
        IF "Sell-to IC Partner Code" <> '' THEN
          IF ICPartner.GET("Sell-to IC Partner Code") THEN
            ICPartner.TESTFIELD(Blocked,FALSE);
        IF "Bill-to IC Partner Code" <> '' THEN
          IF ICPartner.GET("Bill-to IC Partner Code") THEN
            ICPartner.TESTFIELD(Blocked,FALSE);
      END;
    END;

    LOCAL PROCEDURE SendICDocument@109(VAR SalesHeader@1000 : Record 36;VAR ModifyHeader@1001 : Boolean);
    VAR
      ICInboxOutboxMgt@1002 : Codeunit 427;
      IsHandled@1003 : Boolean;
    BEGIN
      IsHandled := FALSE;
      OnBeforeSendICDocument(SalesHeader,ModifyHeader,IsHandled);
      IF IsHandled THEN
        EXIT;

      WITH SalesHeader DO
        IF "Send IC Document" AND ("IC Status" = "IC Status"::New) AND ("IC Direction" = "IC Direction"::Outgoing) AND
           ("Document Type" IN ["Document Type"::Order,"Document Type"::"Return Order"])
        THEN BEGIN
          ICInboxOutboxMgt.SendSalesDoc(SalesHeader,TRUE);
          "IC Status" := "IC Status"::Pending;
          ModifyHeader := TRUE;
        END;
    END;

    LOCAL PROCEDURE UpdateHandledICInboxTransaction@111(SalesHeader@1000 : Record 36);
    VAR
      HandledICInboxTrans@1001 : Record 420;
      Customer@1002 : Record 18;
      IsHandled@1003 : Boolean;
    BEGIN
      IsHandled := FALSE;
      OnBeforeUpdateHandledICInboxTransaction(SalesHeader,IsHandled);
      IF IsHandled THEN
        EXIT;

      WITH SalesHeader DO
        IF "IC Direction" = "IC Direction"::Incoming THEN BEGIN
          HandledICInboxTrans.SETRANGE("Document No.","External Document No.");
          Customer.GET("Sell-to Customer No.");
          HandledICInboxTrans.SETRANGE("IC Partner Code",Customer."IC Partner Code");
          HandledICInboxTrans.LOCKTABLE;
          IF HandledICInboxTrans.FINDFIRST THEN BEGIN
            HandledICInboxTrans.Status := HandledICInboxTrans.Status::Posted;
            HandledICInboxTrans.MODIFY;
          END;
        END;
    END;

    [External]
    PROCEDURE GetPostedDocumentRecord@222(SalesHeader@1000 : Record 36;VAR PostedSalesDocumentVariant@1001 : Variant);
    VAR
      SalesInvHeader@1007 : Record 112;
      SalesCrMemoHeader@1006 : Record 114;
      IsHandled@1002 : Boolean;
    BEGIN
      WITH SalesHeader DO
        CASE "Document Type" OF
          "Document Type"::Order:
            IF Invoice THEN BEGIN
              SalesInvHeader.GET("Last Posting No.");
              SalesInvHeader.SETRECFILTER;
              PostedSalesDocumentVariant := SalesInvHeader;
            END;
          "Document Type"::Invoice:
            BEGIN
              IF "Last Posting No." = '' THEN
                SalesInvHeader.GET("No.")
              ELSE
                SalesInvHeader.GET("Last Posting No.");

              SalesInvHeader.SETRECFILTER;
              PostedSalesDocumentVariant := SalesInvHeader;
            END;
          "Document Type"::"Credit Memo":
            BEGIN
              IF "Last Posting No." = '' THEN
                SalesCrMemoHeader.GET("No.")
              ELSE
                SalesCrMemoHeader.GET("Last Posting No.");
              SalesCrMemoHeader.SETRECFILTER;
              PostedSalesDocumentVariant := SalesCrMemoHeader;
            END;
          "Document Type"::"Return Order":
            IF Invoice THEN BEGIN
              IF "Last Posting No." = '' THEN
                SalesCrMemoHeader.GET("No.")
              ELSE
                SalesCrMemoHeader.GET("Last Posting No.");
              SalesCrMemoHeader.SETRECFILTER;
              PostedSalesDocumentVariant := SalesCrMemoHeader;
            END;
          ELSE BEGIN
            IsHandled := FALSE;
            OnGetPostedDocumentRecordElseCase(SalesHeader,PostedSalesDocumentVariant,IsHandled);
            IF NOT IsHandled THEN
              ERROR(NotSupportedDocumentTypeErr,"Document Type");
          END;
        END;
    END;

    [Internal]
    PROCEDURE SendPostedDocumentRecord@223(SalesHeader@1000 : Record 36;VAR DocumentSendingProfile@1001 : Record 60);
    VAR
      SalesInvHeader@1007 : Record 112;
      SalesCrMemoHeader@1006 : Record 114;
      SalesShipmentHeader@1002 : Record 110;
      OfficeManagement@1003 : Codeunit 1630;
      ConfirmManagement@1004 : Codeunit 27;
      IsHandled@1005 : Boolean;
    BEGIN
      WITH SalesHeader DO
        CASE "Document Type" OF
          "Document Type"::Order:
            BEGIN
              OnSendSalesDocument(Invoice AND Ship,SuppressCommit);
              IF Invoice THEN BEGIN
                SalesInvHeader.GET("Last Posting No.");
                SalesInvHeader.SETRECFILTER;
                SalesInvHeader.SendProfile(DocumentSendingProfile);
              END;
              IF Ship AND Invoice AND NOT OfficeManagement.IsAvailable THEN
                IF NOT ConfirmManagement.ConfirmProcess(DownloadShipmentAlsoQst,TRUE) THEN
                  EXIT;
              IF Ship THEN BEGIN
                SalesShipmentHeader.GET("Last Shipping No.");
                SalesShipmentHeader.SETRECFILTER;
                SalesShipmentHeader.SendProfile(DocumentSendingProfile);
              END;
            END;
          "Document Type"::Invoice:
            BEGIN
              IF "Last Posting No." = '' THEN
                SalesInvHeader.GET("No.")
              ELSE
                SalesInvHeader.GET("Last Posting No.");

              SalesInvHeader.SETRECFILTER;
              SalesInvHeader.SendProfile(DocumentSendingProfile);
            END;
          "Document Type"::"Credit Memo":
            BEGIN
              IF "Last Posting No." = '' THEN
                SalesCrMemoHeader.GET("No.")
              ELSE
                SalesCrMemoHeader.GET("Last Posting No.");
              SalesCrMemoHeader.SETRECFILTER;
              SalesCrMemoHeader.SendProfile(DocumentSendingProfile);
            END;
          "Document Type"::"Return Order":
            IF Invoice THEN BEGIN
              IF "Last Posting No." = '' THEN
                SalesCrMemoHeader.GET("No.")
              ELSE
                SalesCrMemoHeader.GET("Last Posting No.");
              SalesCrMemoHeader.SETRECFILTER;
              SalesCrMemoHeader.SendProfile(DocumentSendingProfile);
            END;
          ELSE BEGIN
            IsHandled := FALSE;
            OnSendPostedDocumentRecordElseCase(SalesHeader,DocumentSendingProfile,IsHandled);
            IF NOT IsHandled THEN
              ERROR(NotSupportedDocumentTypeErr,"Document Type");
          END;
        END;
    END;

    LOCAL PROCEDURE MakeInventoryAdjustment@112();
    VAR
      InvtSetup@1000 : Record 313;
      InvtAdjmt@1001 : Codeunit 5895;
    BEGIN
      InvtSetup.GET;
      IF InvtSetup."Automatic Cost Adjustment" <>
         InvtSetup."Automatic Cost Adjustment"::Never
      THEN BEGIN
        InvtAdjmt.SetProperties(TRUE,InvtSetup."Automatic Cost Posting");
        InvtAdjmt.SetJobUpdateProperties(TRUE);
        InvtAdjmt.MakeMultiLevelAdjmt;
      END;
    END;

    LOCAL PROCEDURE FindNotShippedLines@30(SalesHeader@1000 : Record 36;VAR TempSalesLine@1001 : TEMPORARY Record 37);
    BEGIN
      WITH TempSalesLine DO BEGIN
        ResetTempLines(TempSalesLine);
        SETFILTER(Quantity,'<>0');
        IF SalesHeader."Document Type" = SalesHeader."Document Type"::Order THEN
          SETFILTER("Qty. to Ship",'<>0');
        SETRANGE("Shipment No.",'');
      END;
    END;

    LOCAL PROCEDURE CheckTrackingAndWarehouseForShip@114(SalesHeader@1004 : Record 36) Ship : Boolean;
    VAR
      TempSalesLine@1000 : TEMPORARY Record 37;
    BEGIN
      WITH TempSalesLine DO BEGIN
        FindNotShippedLines(SalesHeader,TempSalesLine);
        Ship := FINDFIRST;
        WhseShip := TempWhseShptHeader.FINDFIRST;
        WhseReceive := TempWhseRcptHeader.FINDFIRST;
        OnCheckTrackingAndWarehouseForShipOnBeforeCheck(SalesHeader,TempWhseShptHeader,TempWhseRcptHeader,Ship,TempSalesLine);
        IF Ship THEN BEGIN
          CheckTrackingSpecification(SalesHeader,TempSalesLine);
          IF NOT (WhseShip OR WhseReceive OR InvtPickPutaway) THEN
            CheckWarehouse(TempSalesLine);
        END;
        OnAfterCheckTrackingAndWarehouseForShip(SalesHeader,Ship,SuppressCommit,TempWhseShptHeader,TempWhseRcptHeader,TempSalesLine);
        EXIT(Ship);
      END;
    END;

    LOCAL PROCEDURE CheckTrackingAndWarehouseForReceive@117(SalesHeader@1004 : Record 36) Receive : Boolean;
    VAR
      TempSalesLine@1000 : TEMPORARY Record 37;
    BEGIN
      WITH TempSalesLine DO BEGIN
        ResetTempLines(TempSalesLine);
        SETFILTER(Quantity,'<>0');
        SETFILTER("Return Qty. to Receive",'<>0');
        SETRANGE("Return Receipt No.",'');
        Receive := FINDFIRST;
        WhseShip := TempWhseShptHeader.FINDFIRST;
        WhseReceive := TempWhseRcptHeader.FINDFIRST;
        OnCheckTrackingAndWarehouseForReceiveOnBeforeCheck(SalesHeader,TempWhseShptHeader,TempWhseRcptHeader,Receive);
        IF Receive THEN BEGIN
          CheckTrackingSpecification(SalesHeader,TempSalesLine);
          IF NOT (WhseReceive OR WhseShip OR InvtPickPutaway) THEN
            CheckWarehouse(TempSalesLine);
        END;
        OnAfterCheckTrackingAndWarehouseForReceive(SalesHeader,Receive,SuppressCommit,TempWhseShptHeader,TempWhseRcptHeader);
        EXIT(Receive);
      END;
    END;

    LOCAL PROCEDURE CheckIfInvPickExists@241(SalesHeader@1004 : Record 36) : Boolean;
    VAR
      TempSalesLine@1000 : TEMPORARY Record 37;
      WarehouseActivityLine@1001 : Record 5767;
    BEGIN
      WITH TempSalesLine DO BEGIN
        FindNotShippedLines(SalesHeader,TempSalesLine);
        IF ISEMPTY THEN
          EXIT(FALSE);
        FINDSET;
        REPEAT
          IF WarehouseActivityLine.ActivityExists(
               DATABASE::"Sales Line","Document Type","Document No.","Line No.",0,
               WarehouseActivityLine."Activity Type"::"Invt. Pick")
          THEN
            EXIT(TRUE);
        UNTIL NEXT = 0;
        EXIT(FALSE);
      END;
    END;

    LOCAL PROCEDURE CheckIfInvPutawayExists@240() : Boolean;
    VAR
      TempSalesLine@1000 : TEMPORARY Record 37;
      WarehouseActivityLine@1001 : Record 5767;
    BEGIN
      WITH TempSalesLine DO BEGIN
        ResetTempLines(TempSalesLine);
        SETFILTER(Quantity,'<>0');
        SETFILTER("Return Qty. to Receive",'<>0');
        SETRANGE("Return Receipt No.",'');
        IF ISEMPTY THEN
          EXIT(FALSE);
        FINDSET;
        REPEAT
          IF WarehouseActivityLine.ActivityExists(
               DATABASE::"Sales Line","Document Type","Document No.","Line No.",0,
               WarehouseActivityLine."Activity Type"::"Invt. Put-away")
          THEN
            EXIT(TRUE);
        UNTIL NEXT = 0;
        EXIT(FALSE);
      END;
    END;

    LOCAL PROCEDURE CalcInvoiceDiscountPosting@169(SalesHeader@1002 : Record 36;SalesLine@1001 : Record 37;SalesLineACY@1000 : Record 37;VAR InvoicePostBuffer@1003 : Record 49);
    BEGIN
      IF SalesLine."VAT Calculation Type" = SalesLine."VAT Calculation Type"::"Reverse Charge VAT" THEN
        InvoicePostBuffer.CalcDiscountNoVAT(-SalesLine."Inv. Discount Amount",-SalesLineACY."Inv. Discount Amount")
      ELSE
        InvoicePostBuffer.CalcDiscount(
          SalesHeader."Prices Including VAT",-SalesLine."Inv. Discount Amount",-SalesLineACY."Inv. Discount Amount");
    END;

    LOCAL PROCEDURE CalcLineDiscountPosting@81(SalesHeader@1003 : Record 36;SalesLine@1002 : Record 37;SalesLineACY@1001 : Record 37;VAR InvoicePostBuffer@1000 : Record 49);
    BEGIN
      IF SalesLine."VAT Calculation Type" = SalesLine."VAT Calculation Type"::"Reverse Charge VAT" THEN
        InvoicePostBuffer.CalcDiscountNoVAT(-SalesLine."Line Discount Amount",-SalesLineACY."Line Discount Amount")
      ELSE
        InvoicePostBuffer.CalcDiscount(
          SalesHeader."Prices Including VAT",-SalesLine."Line Discount Amount",-SalesLineACY."Line Discount Amount");
    END;

    LOCAL PROCEDURE FindTempItemChargeAssgntSales@119(SalesLineNo@1000 : Integer) : Boolean;
    BEGIN
      ClearItemChargeAssgntFilter;
      TempItemChargeAssgntSales.SETCURRENTKEY("Applies-to Doc. Type");
      TempItemChargeAssgntSales.SETRANGE("Document Line No.",SalesLineNo);
      EXIT(TempItemChargeAssgntSales.FINDSET);
    END;

    LOCAL PROCEDURE UpdateInvoicedQtyOnShipmentLine@120(VAR SalesShptLine@1000 : Record 111;QtyToBeInvoiced@1001 : Decimal;QtyToBeInvoicedBase@1002 : Decimal);
    BEGIN
      WITH SalesShptLine DO BEGIN
        "Quantity Invoiced" := "Quantity Invoiced" - QtyToBeInvoiced;
        "Qty. Invoiced (Base)" := "Qty. Invoiced (Base)" - QtyToBeInvoicedBase;
        "Qty. Shipped Not Invoiced" := Quantity - "Quantity Invoiced";
        MODIFY;
      END;
    END;

    [External]
    PROCEDURE SetPreviewMode@121(NewPreviewMode@1000 : Boolean);
    BEGIN
      PreviewMode := NewPreviewMode;
    END;

    LOCAL PROCEDURE PostDropOrderShipment@144(VAR SalesHeader@1001 : Record 36;VAR TempDropShptPostBuffer@1004 : TEMPORARY Record 223);
    VAR
      PurchSetup@1000 : Record 312;
      PurchCommentLine@1002 : Record 43;
      PurchOrderHeader@1006 : Record 38;
      PurchOrderLine@1005 : Record 39;
      RecordLinkManagement@1003 : Codeunit 447;
    BEGIN
      OnBeforePostDropOrderShipment(SalesHeader,TempDropShptPostBuffer);

      ArchivePurchaseOrders(TempDropShptPostBuffer);
      WITH SalesHeader DO
        IF TempDropShptPostBuffer.FINDSET THEN BEGIN
          PurchSetup.GET;
          REPEAT
            PurchOrderHeader.GET(PurchOrderHeader."Document Type"::Order,TempDropShptPostBuffer."Order No.");
            InsertPurchRcptHeader(PurchOrderHeader,SalesHeader,PurchRcptHeader);
            ApprovalsMgmt.PostApprovalEntries(RECORDID,PurchRcptHeader.RECORDID,PurchRcptHeader."No.");
            IF PurchSetup."Copy Comments Order to Receipt" THEN BEGIN
              PurchCommentLine.CopyComments(
                PurchOrderHeader."Document Type",PurchCommentLine."Document Type"::Receipt,
                PurchOrderHeader."No.",PurchRcptHeader."No.");
              RecordLinkManagement.CopyLinks(PurchOrderHeader,PurchRcptHeader);
            END;
            TempDropShptPostBuffer.SETRANGE("Order No.",TempDropShptPostBuffer."Order No.");
            REPEAT
              PurchOrderLine.GET(
                PurchOrderLine."Document Type"::Order,
                TempDropShptPostBuffer."Order No.",TempDropShptPostBuffer."Order Line No.");
              InsertPurchRcptLine(PurchRcptHeader,PurchOrderLine,TempDropShptPostBuffer);

              PurchOrderLine.CreatePurchOrderControl(FALSE); //**4PS.n

              PurchPost.UpdateBlanketOrderLine(PurchOrderLine,TRUE,FALSE,FALSE);
            UNTIL TempDropShptPostBuffer.NEXT = 0;
            TempDropShptPostBuffer.SETRANGE("Order No.");
            OnAfterInsertDropOrderPurchRcptHeader(PurchRcptHeader);
          UNTIL TempDropShptPostBuffer.NEXT = 0;
        END;
    END;

    LOCAL PROCEDURE PostInvoicePostBuffer@140(SalesHeader@1000 : Record 36;VAR TempInvoicePostBuffer@1004 : TEMPORARY Record 49;VAR CrRestrictionAmt@1100525001 : Decimal;VAR CrRestrictionVATAmt@1100525000 : Decimal);
    VAR
      LineCount@1002 : Integer;
      GLEntryNo@1001 : Integer;
    BEGIN
      OnBeforePostInvoicePostBuffer(SalesHeader,TempInvoicePostBuffer,TotalSalesLine,TotalSalesLineLCY);

      LineCount := 0;
      IF TempInvoicePostBuffer.FIND('+') THEN
        REPEAT
          LineCount := LineCount + 1;
          IF GUIALLOWED AND NOT HideProgressWindow THEN
            Window.UPDATE(3,LineCount);

        //GLEntryNo := PostInvoicePostBufferLine(SalesHeader,TempInvoicePostBuffer); //**4PS.o
          GLEntryNo := PostInvoicePostBufferLine(SalesHeader,TempInvoicePostBuffer,CrRestrictionAmt,CrRestrictionVATAmt); //**4PS.n

          IF (TempInvoicePostBuffer."Job No." <> '') AND
             (TempInvoicePostBuffer.Type = TempInvoicePostBuffer.Type::"G/L Account")
          THEN
            JobPostLine.PostSalesGLAccounts(TempInvoicePostBuffer,GLEntryNo);

        UNTIL TempInvoicePostBuffer.NEXT(-1) = 0;

      TempInvoicePostBuffer.DELETEALL;
    END;

    LOCAL PROCEDURE PostInvoicePostBufferLine@158(SalesHeader@1000 : Record 36;InvoicePostBuffer@1001 : Record 49;VAR CrRestrictionAmt@1100525000 : Decimal;VAR CrRestrictionVATAmt@1100525001 : Decimal) GLEntryNo : Integer;
    VAR
      GenJnlLine@1002 : Record 81;
    BEGIN
      WITH GenJnlLine DO BEGIN
        InitNewLine(
          SalesHeader."Posting Date",SalesHeader."Document Date",SalesHeader."Posting Description",
          InvoicePostBuffer."Global Dimension 1 Code",InvoicePostBuffer."Global Dimension 2 Code",
          InvoicePostBuffer."Dimension Set ID",SalesHeader."Reason Code");

        GenJnlLineExt.InitGetLine(GenJnlLine);//4PSSE
        GenJnlLineExt."Reference No." := ReferenceNumber;  //NAVFI
        GenJnlLineExt.SaveUpdateLine(GenJnlLine);//4PSSE

        CopyDocumentFields(GenJnlLineDocType,GenJnlLineDocNo,GenJnlLineExtDocNo,SrcCode,'');

        CopyFromSalesHeader(SalesHeader);

        CopyFromInvoicePostBuffer(InvoicePostBuffer);
        IF InvoicePostBuffer.Type <> InvoicePostBuffer.Type::"Prepmt. Exch. Rate Difference" THEN
          "Gen. Posting Type" := "Gen. Posting Type"::Sale;
        IF InvoicePostBuffer.Type = InvoicePostBuffer.Type::"Fixed Asset" THEN BEGIN
          "FA Posting Type" := "FA Posting Type"::Disposal;
          CopyFromInvoicePostBufferFA(InvoicePostBuffer);
        END;

      //NTR Start
        GenJnlLine."Auto. Acc. Group" := InvoicePostBuffer."Auto. Acc. Group";  //NAVSE,NAVFI
        GenJnlLine."Periodic Template Code" := InvoicePostBuffer."Periodic Template Code";
        GenJnlLine."Periodic Starting Date" := InvoicePostBuffer."Periodic Starting Date";
      //NTR End

        //**4PS.sn
        IF InvoicePostBuffer."Applies-to Retention ID" <> 0 THEN BEGIN
          "Retention Entry Type" := "Retention Entry Type"::Sales;
          "Retention Entry Document Type" := "Retention Entry Document Type"::Closure;
          "Applies-to Retention ID" := InvoicePostBuffer."Applies-to Retention ID";
          "Skip WIP Check" := TRUE;
        END;
        IF InvoicePostBuffer."Buy-Back Item (Plant Order)" THEN
          CheckBuyBackGenPostTypPurchase(GenJnlLine);
        "Credit Restriction" := SalesHeader."Credit Restriction";
        VALIDATE("Credit Restriction %", SalesHeader."Credit Restriction %");
        "Credit Restriction Date" := SalesHeader."Credit Restriction Date";
        "Advance Payment" := InvoicePostBuffer."Advance Payment";
        CrRestrictionAmt += -GenJnlLine."Credit Restriction Amount";
        CrRestrictionVATAmt += -GenJnlLine."Credit Restriction VAT Amount";
        //**4PS.en

        OnBeforePostInvPostBuffer(GenJnlLine,InvoicePostBuffer,SalesHeader,SuppressCommit,GenJnlPostLine,PreviewMode);
        GLEntryNo := RunGenJnlPostLine(GenJnlLine);
        OnAfterPostInvPostBuffer(GenJnlLine,InvoicePostBuffer,SalesHeader,GLEntryNo,SuppressCommit,GenJnlPostLine);
      END;
    END;

    LOCAL PROCEDURE PostItemTracking@152(SalesHeader@1000 : Record 36;SalesLine@1002 : Record 37;TrackingSpecificationExists@1004 : Boolean;VAR TempTrackingSpecification@1005 : TEMPORARY Record 336;VAR TempItemLedgEntryNotInvoiced@1009 : TEMPORARY Record 32;HasATOShippedNotInvoiced@1012 : Boolean);
    VAR
      QtyToInvoiceBaseInTrackingSpec@1014 : Decimal;
    BEGIN
      WITH SalesHeader DO BEGIN
        IF TrackingSpecificationExists THEN BEGIN
          TempTrackingSpecification.CALCSUMS("Qty. to Invoice (Base)");
          QtyToInvoiceBaseInTrackingSpec := TempTrackingSpecification."Qty. to Invoice (Base)";
          IF NOT TempTrackingSpecification.FINDFIRST THEN
            TempTrackingSpecification.INIT;
        END;

        IF SalesLine.IsCreditDocType THEN BEGIN
          IF (ABS(RemQtyToBeInvoiced) > ABS(SalesLine."Return Qty. to Receive")) OR
             (ABS(RemQtyToBeInvoiced) >= ABS(QtyToInvoiceBaseInTrackingSpec)) AND (QtyToInvoiceBaseInTrackingSpec <> 0)
          THEN
            PostItemTrackingForReceipt(
              SalesHeader,SalesLine,TrackingSpecificationExists,TempTrackingSpecification);

          IF ABS(RemQtyToBeInvoiced) > ABS(SalesLine."Return Qty. to Receive") THEN BEGIN
            //**4PS.so
            //IF "Document Type" = "Document Type"::"Credit Memo" THEN
            //  ERROR(InvoiceGreaterThanReturnReceiptErr,SalesLine."Return Receipt No.");
            //**4PS.eo
            IF "Document Type" <> "Document Type"::"Credit Memo" THEN //**4PS.n
              ERROR(ReturnReceiptLinesDeletedErr);
          END;
        END ELSE BEGIN
          IF (ABS(RemQtyToBeInvoiced) > ABS(SalesLine."Qty. to Ship")) OR
             (ABS(RemQtyToBeInvoiced) >= ABS(QtyToInvoiceBaseInTrackingSpec)) AND (QtyToInvoiceBaseInTrackingSpec <> 0)
          THEN
            PostItemTrackingForShipment(
              SalesHeader,SalesLine,TrackingSpecificationExists,TempTrackingSpecification,
              TempItemLedgEntryNotInvoiced,HasATOShippedNotInvoiced);

          IF ABS(RemQtyToBeInvoiced) > ABS(SalesLine."Qty. to Ship") THEN BEGIN
            IF "Document Type" = "Document Type"::Invoice THEN
              ERROR(QuantityToInvoiceGreaterErr,SalesLine."Shipment No.");
            ERROR(ShipmentLinesDeletedErr);
          END;
        END;
      END;
    END;

    LOCAL PROCEDURE PostItemTrackingForReceipt@253(SalesHeader@1000 : Record 36;SalesLine@1010 : Record 37;TrackingSpecificationExists@1014 : Boolean;VAR TempTrackingSpecification@1013 : TEMPORARY Record 336);
    VAR
      ItemEntryRelation@1009 : Record 6507;
      ReturnRcptLine@1008 : Record 6661;
      SalesShptLine@1007 : Record 111;
      EndLoop@1006 : Boolean;
      QtyToBeInvoiced@1003 : Decimal;
      QtyToBeInvoicedBase@1002 : Decimal;
    BEGIN
      WITH SalesHeader DO BEGIN
        EndLoop := FALSE;
        ReturnRcptLine.RESET;
        CASE "Document Type" OF
          "Document Type"::"Return Order":
            BEGIN
              ReturnRcptLine.SETCURRENTKEY("Return Order No.","Return Order Line No.");
              ReturnRcptLine.SETRANGE("Return Order No.",SalesLine."Document No.");
              ReturnRcptLine.SETRANGE("Return Order Line No.",SalesLine."Line No.");
            END;
          "Document Type"::"Credit Memo":
            BEGIN
              ReturnRcptLine.SETRANGE("Document No.",SalesLine."Return Receipt No.");
              ReturnRcptLine.SETRANGE("Line No.",SalesLine."Return Receipt Line No.");
            END;
        END;
        ReturnRcptLine.SETFILTER("Return Qty. Rcd. Not Invd.",'<>0');
        OnPostItemTrackingForReceiptOnAfterSetFilters(ReturnRcptLine,SalesHeader,SalesLine);
        IF ReturnRcptLine.FIND('-') THEN BEGIN
          ItemJnlRollRndg := TRUE;
          REPEAT
            IF TrackingSpecificationExists THEN BEGIN  // Item Tracking
              ItemEntryRelation.GET(TempTrackingSpecification."Item Ledger Entry No.");
              ReturnRcptLine.GET(ItemEntryRelation."Source ID",ItemEntryRelation."Source Ref. No.");
            END ELSE
              ItemEntryRelation."Item Entry No." := ReturnRcptLine."Item Rcpt. Entry No.";
            ReturnRcptLine.TESTFIELD("Sell-to Customer No.",SalesLine."Sell-to Customer No.");
            ReturnRcptLine.TESTFIELD(Type,SalesLine.Type);
            ReturnRcptLine.TESTFIELD("No.",SalesLine."No.");
            ReturnRcptLine.TESTFIELD("Gen. Bus. Posting Group",SalesLine."Gen. Bus. Posting Group");
            ReturnRcptLine.TESTFIELD("Gen. Prod. Posting Group",SalesLine."Gen. Prod. Posting Group");
            ReturnRcptLine.TESTFIELD("Job No.",SalesLine."Job No.");
            ReturnRcptLine.TESTFIELD("Unit of Measure Code",SalesLine."Unit of Measure Code");
            ReturnRcptLine.TESTFIELD("Variant Code",SalesLine."Variant Code");
            IF SalesLine."Qty. to Invoice" * ReturnRcptLine.Quantity < 0 THEN
              SalesLine.FIELDERROR("Qty. to Invoice",ReturnReceiptSameSignErr);
            UpdateQtyToBeInvoicedForReturnReceipt(
              QtyToBeInvoiced,QtyToBeInvoicedBase,
              TrackingSpecificationExists,SalesLine,ReturnRcptLine,TempTrackingSpecification);

            IF TrackingSpecificationExists THEN BEGIN
              TempTrackingSpecification."Quantity actual Handled (Base)" := QtyToBeInvoicedBase;
              TempTrackingSpecification.MODIFY;
            END;

            IF TrackingSpecificationExists THEN
              ItemTrackingMgt.AdjustQuantityRounding(
                RemQtyToBeInvoiced,QtyToBeInvoiced,
                RemQtyToBeInvoicedBase,QtyToBeInvoicedBase);

            RemQtyToBeInvoiced := RemQtyToBeInvoiced - QtyToBeInvoiced;
            RemQtyToBeInvoicedBase := RemQtyToBeInvoicedBase - QtyToBeInvoicedBase;
            ReturnRcptLine."Quantity Invoiced" :=
              ReturnRcptLine."Quantity Invoiced" + QtyToBeInvoiced;
            ReturnRcptLine."Qty. Invoiced (Base)" :=
              ReturnRcptLine."Qty. Invoiced (Base)" + QtyToBeInvoicedBase;
            ReturnRcptLine."Return Qty. Rcd. Not Invd." :=
              ReturnRcptLine.Quantity - ReturnRcptLine."Quantity Invoiced";

            OnPostItemTrackingForReceiptOnBeforeReturnRcptLineModify(SalesHeader,ReturnRcptLine);
            ReturnRcptLine.MODIFY;

            OnBeforePostItemTrackingReturnRcpt(
              SalesInvHeader,SalesShptLine,TempTrackingSpecification,TrackingSpecificationExists,
              SalesCrMemoHeader,ReturnRcptLine,SalesLine,QtyToBeInvoiced,QtyToBeInvoicedBase);

            IF PostItemTrackingForReceiptCondition(SalesLine,ReturnRcptLine) THEN
              PostItemJnlLine(
                SalesHeader,SalesLine,0,0,QtyToBeInvoiced,QtyToBeInvoicedBase,
                ItemEntryRelation."Item Entry No.",'',TempTrackingSpecification,FALSE);

            OnAfterPostItemTrackingReturnRcpt(
              SalesInvHeader,SalesShptLine,TempTrackingSpecification,TrackingSpecificationExists,
              SalesCrMemoHeader,ReturnRcptLine,SalesLine,QtyToBeInvoiced,QtyToBeInvoicedBase);

            IF TrackingSpecificationExists THEN
              EndLoop := (TempTrackingSpecification.NEXT = 0) OR (RemQtyToBeInvoiced = 0)
            ELSE
              EndLoop :=
                (ReturnRcptLine.NEXT = 0) OR (ABS(RemQtyToBeInvoiced) <= ABS(SalesLine."Return Qty. to Receive"));
          UNTIL EndLoop;
        //**4PS.so
        //END ELSE
        //  ERROR(
        //    ReturnReceiptInvoicedErr,
        //    SalesLine."Return Receipt Line No.",SalesLine."Return Receipt No.");
        //**4PS.eo
        END; //**4PS.n
      END;
    END;

    LOCAL PROCEDURE PostItemTrackingForReceiptCondition@287(SalesLine@1001 : Record 37;ReturnRcptLine@1002 : Record 6661) : Boolean;
    VAR
      Condition@1000 : Boolean;
    BEGIN
      Condition := SalesLine.Type = SalesLine.Type::Item;
      OnBeforePostItemTrackingForReceiptCondition(SalesLine,ReturnRcptLine,Condition);
      EXIT(Condition);
    END;

    LOCAL PROCEDURE PostItemTrackingForShipment@254(SalesHeader@1005 : Record 36;SalesLine@1004 : Record 37;TrackingSpecificationExists@1003 : Boolean;VAR TempTrackingSpecification@1002 : TEMPORARY Record 336;VAR TempItemLedgEntryNotInvoiced@1001 : TEMPORARY Record 32;HasATOShippedNotInvoiced@1000 : Boolean);
    VAR
      ItemEntryRelation@1014 : Record 6507;
      SalesShptLine@1012 : Record 111;
      RemQtyToInvoiceCurrLine@1010 : Decimal;
      RemQtyToInvoiceCurrLineBase@1009 : Decimal;
      QtyToBeInvoiced@1008 : Decimal;
      QtyToBeInvoicedBase@1007 : Decimal;
    BEGIN
      WITH SalesHeader DO BEGIN
        SalesShptLine.RESET;
        CASE "Document Type" OF
          "Document Type"::Order:
            BEGIN
              SalesShptLine.SETCURRENTKEY("Order No.","Order Line No.");
              SalesShptLine.SETRANGE("Order No.",SalesLine."Document No.");
              SalesShptLine.SETRANGE("Order Line No.",SalesLine."Line No.");
            END;
          "Document Type"::Invoice:
            BEGIN
              SalesShptLine.SETRANGE("Document No.",SalesLine."Shipment No.");
              SalesShptLine.SETRANGE("Line No.",SalesLine."Shipment Line No.");
            END;
        END;

        IF NOT TrackingSpecificationExists THEN
          HasATOShippedNotInvoiced := GetATOItemLedgEntriesNotInvoiced(SalesLine,TempItemLedgEntryNotInvoiced);

        SalesShptLine.SETFILTER("Qty. Shipped Not Invoiced",'<>0');
        IF SalesShptLine.FINDFIRST THEN BEGIN
          ItemJnlRollRndg := TRUE;
          REPEAT
            SetItemEntryRelation(
              ItemEntryRelation,SalesShptLine,
              TempTrackingSpecification,TempItemLedgEntryNotInvoiced,
              TrackingSpecificationExists,HasATOShippedNotInvoiced);

            UpdateRemainingQtyToBeInvoiced(SalesShptLine,RemQtyToInvoiceCurrLine,RemQtyToInvoiceCurrLineBase);

            SalesShptLine.TESTFIELD("Sell-to Customer No.",SalesLine."Sell-to Customer No.");
            SalesShptLine.TESTFIELD(Type,SalesLine.Type);
            SalesShptLine.TESTFIELD("No.",SalesLine."No.");
            SalesShptLine.TESTFIELD("Gen. Bus. Posting Group",SalesLine."Gen. Bus. Posting Group");
            SalesShptLine.TESTFIELD("Gen. Prod. Posting Group",SalesLine."Gen. Prod. Posting Group");
            SalesShptLine.TESTFIELD("Job No.",SalesLine."Job No.");
            SalesShptLine.TESTFIELD("Unit of Measure Code",SalesLine."Unit of Measure Code");
            SalesShptLine.TESTFIELD("Variant Code",SalesLine."Variant Code");
            IF -SalesLine."Qty. to Invoice" * SalesShptLine.Quantity < 0 THEN
              SalesLine.FIELDERROR("Qty. to Invoice",ShipmentSameSignErr);

            UpdateQtyToBeInvoicedForShipment(
              QtyToBeInvoiced,QtyToBeInvoicedBase,
              TrackingSpecificationExists,HasATOShippedNotInvoiced,
              SalesLine,SalesShptLine,
              TempTrackingSpecification,TempItemLedgEntryNotInvoiced);

            IF TrackingSpecificationExists THEN BEGIN
              TempTrackingSpecification."Quantity actual Handled (Base)" := QtyToBeInvoicedBase;
              TempTrackingSpecification.MODIFY;
            END;

            IF TrackingSpecificationExists OR HasATOShippedNotInvoiced THEN
              ItemTrackingMgt.AdjustQuantityRounding(
                RemQtyToInvoiceCurrLine,QtyToBeInvoiced,
                RemQtyToInvoiceCurrLineBase,QtyToBeInvoicedBase);

            RemQtyToBeInvoiced := RemQtyToBeInvoiced - QtyToBeInvoiced;
            RemQtyToBeInvoicedBase := RemQtyToBeInvoicedBase - QtyToBeInvoicedBase;
            OnBeforeUpdateInvoicedQtyOnShipmentLine(SalesShptLine,SalesLine,SalesHeader,SalesInvHeader,SuppressCommit);
            UpdateInvoicedQtyOnShipmentLine(SalesShptLine,QtyToBeInvoiced,QtyToBeInvoicedBase);
            OnInvoiceSalesShptLine(SalesShptLine,SalesInvHeader."No.",SalesLine."Line No.",-QtyToBeInvoiced,SuppressCommit);

            OnBeforePostItemTrackingForShipment(
              SalesInvHeader,SalesShptLine,TempTrackingSpecification,TrackingSpecificationExists,SalesLine,
              QtyToBeInvoiced,QtyToBeInvoicedBase);

            IF PostItemTrackingForShipmentCondition(SalesLine,SalesShptLine) THEN
              PostItemJnlLine(
                SalesHeader,SalesLine,0,0,QtyToBeInvoiced,QtyToBeInvoicedBase,
                ItemEntryRelation."Item Entry No.",'',TempTrackingSpecification,FALSE);

            OnAfterPostItemTrackingForShipment(
              SalesInvHeader,SalesShptLine,TempTrackingSpecification,TrackingSpecificationExists,SalesLine,
              QtyToBeInvoiced,QtyToBeInvoicedBase);
          UNTIL IsEndLoopForShippedNotInvoiced(
                  RemQtyToBeInvoiced,TrackingSpecificationExists,HasATOShippedNotInvoiced,
                  SalesShptLine,TempTrackingSpecification,TempItemLedgEntryNotInvoiced,SalesLine);
        END ELSE
          ERROR(
            ShipmentInvoiceErr,SalesLine."Shipment Line No.",SalesLine."Shipment No.");
      END;
    END;

    LOCAL PROCEDURE PostItemTrackingForShipmentCondition@293(SalesLine@1001 : Record 37;SalesShptLine@1002 : Record 111) : Boolean;
    VAR
      Condition@1000 : Boolean;
    BEGIN
      Condition := SalesLine.Type = SalesLine.Type::Item;
      OnBeforePostItemTrackingForShipmentCondition(SalesLine,SalesShptLine,Condition);
      EXIT(Condition);
    END;

    LOCAL PROCEDURE PostUpdateOrderLine@149(SalesHeader@1000 : Record 36);
    VAR
      TempSalesLine@1001 : TEMPORARY Record 37;
    BEGIN
      OnBeforePostUpdateOrderLine(SalesHeader,TempSalesLineGlobal,SuppressCommit);

      ResetTempLines(TempSalesLine);
      WITH TempSalesLine DO BEGIN
        SETRANGE("Prepayment Line",FALSE);
        SETFILTER(Quantity,'<>0');
        IF FINDSET THEN
          REPEAT
            OnPostUpdateOrderLineOnBeforeInitTempSalesLineQuantities(SalesHeader,TempSalesLine);
            IF SalesHeader.Ship THEN BEGIN
              "Quantity Shipped" += "Qty. to Ship";
              "Qty. Shipped (Base)" += "Qty. to Ship (Base)";
            END;
            IF SalesHeader.Receive THEN BEGIN
              "Return Qty. Received" += "Return Qty. to Receive";
              "Return Qty. Received (Base)" += "Return Qty. to Receive (Base)";
            END;
            IF SalesHeader.Invoice THEN BEGIN
              IF "Document Type" = "Document Type"::Order THEN BEGIN
                IF ABS("Quantity Invoiced" + "Qty. to Invoice") > ABS("Quantity Shipped") THEN BEGIN
                  VALIDATE("Qty. to Invoice","Quantity Shipped" - "Quantity Invoiced");
                  "Qty. to Invoice (Base)" := "Qty. Shipped (Base)" - "Qty. Invoiced (Base)";
                END
              END ELSE
                IF ABS("Quantity Invoiced" + "Qty. to Invoice") > ABS("Return Qty. Received") THEN BEGIN
                  VALIDATE("Qty. to Invoice","Return Qty. Received" - "Quantity Invoiced");
                  "Qty. to Invoice (Base)" := "Return Qty. Received (Base)" - "Qty. Invoiced (Base)";
                END;

              "Quantity Invoiced" += "Qty. to Invoice";
              "Qty. Invoiced (Base)" += "Qty. to Invoice (Base)";
              IF "Qty. to Invoice" <> 0 THEN BEGIN
                "Prepmt Amt Deducted" += "Prepmt Amt to Deduct";
                "Prepmt VAT Diff. Deducted" += "Prepmt VAT Diff. to Deduct";
                DecrementPrepmtAmtInvLCY(
                  TempSalesLine,"Prepmt. Amount Inv. (LCY)","Prepmt. VAT Amount Inv. (LCY)");
                "Prepmt Amt to Deduct" := "Prepmt. Amt. Inv." - "Prepmt Amt Deducted";
                "Prepmt VAT Diff. to Deduct" := 0;
              END;
            END;

            UpdateBlanketOrderLine(TempSalesLine,SalesHeader.Ship,SalesHeader.Receive,SalesHeader.Invoice);

            OnPostUpdateOrderLineOnBeforeInitOutstanding(SalesHeader,TempSalesLine);

            InitOutstanding;
            CheckATOLink(TempSalesLine);
            IF WhseHandlingRequired(TempSalesLine) OR
               (SalesSetup."Default Quantity to Ship" = SalesSetup."Default Quantity to Ship"::Blank)
            THEN BEGIN
              IF "Document Type" = "Document Type"::"Return Order" THEN BEGIN
                "Return Qty. to Receive" := 0;
                "Return Qty. to Receive (Base)" := 0;
              END ELSE BEGIN
                "Qty. to Ship" := 0;
                "Qty. to Ship (Base)" := 0;
              END;
              InitQtyToInvoice;
            END ELSE BEGIN
              IF "Document Type" = "Document Type"::"Return Order" THEN
                InitQtyToReceive
              ELSE
                InitQtyToShip2;
            END;

            IF ("Purch. Order Line No." <> 0) AND (Quantity = "Quantity Invoiced") THEN
              UpdateAssocLines(TempSalesLine);
            SetDefaultQuantity;
            OnBeforePostUpdateOrderLineModifyTempLine(TempSalesLine,WhseShip,WhseReceive,SuppressCommit);
            ModifyTempLine(TempSalesLine);
            OnAfterPostUpdateOrderLineModifyTempLine(TempSalesLine,WhseShip,WhseReceive,SuppressCommit);
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE PostUpdateInvoiceLine@141();
    VAR
      SalesOrderLine@1001 : Record 37;
      SalesShptLine@1002 : Record 111;
      TempSalesLine@1000 : TEMPORARY Record 37;
      TempSalesOrderHeader@1003 : TEMPORARY Record 36;
      CRMSalesDocumentPostingMgt@1004 : Codeunit 5346;
    BEGIN
      ResetTempLines(TempSalesLine);
      WITH TempSalesLine DO BEGIN
        SETFILTER("Shipment No.",'<>%1','');
        SETFILTER(Type,'<>%1',Type::" ");
        IF FINDSET THEN
          REPEAT
            SalesShptLine.GET("Shipment No.","Shipment Line No.");
            SalesOrderLine.GET(
              SalesOrderLine."Document Type"::Order,
              SalesShptLine."Order No.",SalesShptLine."Order Line No.");
            IF Type = Type::"Charge (Item)" THEN
              UpdateSalesOrderChargeAssgnt(TempSalesLine,SalesOrderLine);
            SalesOrderLine."Quantity Invoiced" += "Qty. to Invoice";
            SalesOrderLine."Qty. Invoiced (Base)" += "Qty. to Invoice (Base)";
            IF ABS(SalesOrderLine."Quantity Invoiced") > ABS(SalesOrderLine."Quantity Shipped") THEN
              ERROR(InvoiceMoreThanShippedErr,SalesOrderLine."Document No.");
            SalesOrderLine.InitQtyToInvoice;
            IF SalesOrderLine."Prepayment %" <> 0 THEN BEGIN
              SalesOrderLine."Prepmt Amt Deducted" += "Prepmt Amt to Deduct";
              SalesOrderLine."Prepmt VAT Diff. Deducted" += "Prepmt VAT Diff. to Deduct";
              DecrementPrepmtAmtInvLCY(
                TempSalesLine,SalesOrderLine."Prepmt. Amount Inv. (LCY)",SalesOrderLine."Prepmt. VAT Amount Inv. (LCY)");
              SalesOrderLine."Prepmt Amt to Deduct" :=
                SalesOrderLine."Prepmt. Amt. Inv." - SalesOrderLine."Prepmt Amt Deducted";
              SalesOrderLine."Prepmt VAT Diff. to Deduct" := 0;
            END;
            SalesOrderLine.InitOutstanding;
            SalesOrderLine.MODIFY;
            IF NOT TempSalesOrderHeader.GET(SalesOrderLine."Document Type",SalesOrderLine."Document No.") THEN BEGIN
              TempSalesOrderHeader."Document Type" := SalesOrderLine."Document Type";
              TempSalesOrderHeader."No." := SalesOrderLine."Document No.";
              TempSalesOrderHeader.INSERT;
            END;

            CloseStandardSalesOrder(SalesOrderLine);  //**4PS.n
          UNTIL NEXT = 0;
        CRMSalesDocumentPostingMgt.CheckShippedOrders(TempSalesOrderHeader);
      END;
    END;

    LOCAL PROCEDURE PostUpdateReturnReceiptLine@142();
    VAR
      SalesOrderLine@1002 : Record 37;
      ReturnRcptLine@1000 : Record 6661;
      TempSalesLine@1001 : TEMPORARY Record 37;
    BEGIN
      ResetTempLines(TempSalesLine);
      WITH TempSalesLine DO BEGIN
        SETFILTER("Return Receipt No.",'<>%1','');
        SETFILTER(Type,'<>%1',Type::" ");
        IF FINDSET THEN
          REPEAT
            ReturnRcptLine.GET("Return Receipt No.","Return Receipt Line No.");
            SalesOrderLine.GET(
              SalesOrderLine."Document Type"::"Return Order",
              ReturnRcptLine."Return Order No.",ReturnRcptLine."Return Order Line No.");
            IF Type = Type::"Charge (Item)" THEN
              UpdateSalesOrderChargeAssgnt(TempSalesLine,SalesOrderLine);
            SalesOrderLine."Quantity Invoiced" += "Qty. to Invoice";
            SalesOrderLine."Qty. Invoiced (Base)" += "Qty. to Invoice (Base)";
            IF ABS(SalesOrderLine."Quantity Invoiced") > ABS(SalesOrderLine."Return Qty. Received") THEN
              ERROR(InvoiceMoreThanReceivedErr,SalesOrderLine."Document No.");
            SalesOrderLine.InitQtyToInvoice;
            SalesOrderLine.InitOutstanding;
            SalesOrderLine.MODIFY;
            CloseStandardSalesOrder(SalesOrderLine);  //**4PS.n
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE FillDeferralPostingBuffer@123(SalesHeader@1008 : Record 36;SalesLine@1000 : Record 37;InvoicePostBuffer@1009 : Record 49;RemainAmtToDefer@1001 : Decimal;RemainAmtToDeferACY@1002 : Decimal;DeferralAccount@1003 : Code[20];SalesAccount@1004 : Code[20]);
    VAR
      DeferralTemplate@1007 : Record 1700;
    BEGIN
      DeferralTemplate.GET(SalesLine."Deferral Code");

      IF TempDeferralHeader.GET(DeferralUtilities.GetSalesDeferralDocType,'','',
           SalesLine."Document Type",SalesLine."Document No.",SalesLine."Line No.")
      THEN BEGIN
        IF TempDeferralHeader."Amount to Defer" <> 0 THEN BEGIN
          DeferralUtilities.FilterDeferralLines(
            TempDeferralLine,DeferralUtilities.GetSalesDeferralDocType,'','',
            SalesLine."Document Type",SalesLine."Document No.",SalesLine."Line No.");

          // Remainder\Initial deferral pair
          DeferralPostBuffer.PrepareSales(SalesLine,GenJnlLineDocNo);
          DeferralPostBuffer."Posting Date" := SalesHeader."Posting Date";
          DeferralPostBuffer.Description := SalesHeader."Posting Description";
          DeferralPostBuffer."Period Description" := DeferralTemplate."Period Description";
          DeferralPostBuffer."Deferral Line No." := InvDefLineNo;
          DeferralPostBuffer.PrepareInitialPair(
            InvoicePostBuffer,RemainAmtToDefer,RemainAmtToDeferACY,SalesAccount,DeferralAccount);
          DeferralPostBuffer.Update(DeferralPostBuffer,InvoicePostBuffer);
          IF (RemainAmtToDefer <> 0) OR (RemainAmtToDeferACY <> 0) THEN BEGIN
            DeferralPostBuffer.PrepareRemainderSales(
              SalesLine,RemainAmtToDefer,RemainAmtToDeferACY,SalesAccount,DeferralAccount,InvDefLineNo);
            DeferralPostBuffer.Update(DeferralPostBuffer,InvoicePostBuffer);
          END;

          // Add the deferral lines for each period to the deferral posting buffer merging when they are the same
          IF TempDeferralLine.FINDSET THEN
            REPEAT
              IF (TempDeferralLine."Amount (LCY)" <> 0) OR (TempDeferralLine.Amount <> 0) THEN BEGIN
                DeferralPostBuffer.PrepareSales(SalesLine,GenJnlLineDocNo);
                DeferralPostBuffer.InitFromDeferralLine(TempDeferralLine);
                IF NOT SalesLine.IsCreditDocType THEN
                  DeferralPostBuffer.ReverseAmounts;
                DeferralPostBuffer."G/L Account" := SalesAccount;
                DeferralPostBuffer."Deferral Account" := DeferralAccount;
                DeferralPostBuffer."Period Description" := DeferralTemplate."Period Description";
                DeferralPostBuffer."Deferral Line No." := InvDefLineNo;
                DeferralPostBuffer.Update(DeferralPostBuffer,InvoicePostBuffer);
              END ELSE
                ERROR(ZeroDeferralAmtErr,SalesLine."No.",SalesLine."Deferral Code");

            UNTIL TempDeferralLine.NEXT = 0

          ELSE
            ERROR(NoDeferralScheduleErr,SalesLine."No.",SalesLine."Deferral Code");
        END ELSE
          ERROR(NoDeferralScheduleErr,SalesLine."No.",SalesLine."Deferral Code")
      END ELSE
        ERROR(NoDeferralScheduleErr,SalesLine."No.",SalesLine."Deferral Code");
    END;

    LOCAL PROCEDURE RoundDeferralsForArchive@126(SalesHeader@1000 : Record 36;VAR SalesLine@1001 : Record 37);
    VAR
      ArchiveManagement@1005 : Codeunit 5063;
    BEGIN
      ArchiveManagement.RoundSalesDeferralsForArchive(SalesHeader,SalesLine);
    END;

    LOCAL PROCEDURE GetAmountsForDeferral@127(SalesLine@1001 : Record 37;VAR AmtToDefer@1002 : Decimal;VAR AmtToDeferACY@1003 : Decimal;VAR DeferralAccount@1004 : Code[20]);
    VAR
      DeferralTemplate@1005 : Record 1700;
    BEGIN
      DeferralTemplate.GET(SalesLine."Deferral Code");
      DeferralTemplate.TESTFIELD("Deferral Account");
      DeferralAccount := DeferralTemplate."Deferral Account";

      IF TempDeferralHeader.GET(DeferralUtilities.GetSalesDeferralDocType,'','',
           SalesLine."Document Type",SalesLine."Document No.",SalesLine."Line No.")
      THEN BEGIN
        AmtToDeferACY := TempDeferralHeader."Amount to Defer";
        AmtToDefer := TempDeferralHeader."Amount to Defer (LCY)";
      END;

      IF NOT SalesLine.IsCreditDocType THEN BEGIN
        AmtToDefer := -AmtToDefer;
        AmtToDeferACY := -AmtToDeferACY;
      END;
    END;

    LOCAL PROCEDURE CheckMandatoryHeaderFields@128(VAR SalesHeader@1000 : Record 36);
    BEGIN
      SalesHeader.TESTFIELD("Document Type");
      //**4PS.sn
      IF SalesHeader.Status = SalesHeader.Status::Closed THEN
        SalesHeader.FIELDERROR(Status);
      IF ChargePlantToProject(SalesHeader) OR ChargeJobOrderToPlant(SalesHeader) THEN BEGIN
        Project.CHANGECOMPANY(SalesHeader."Company Name");
        Project.GET(SalesHeader."Job No.");
      END ELSE BEGIN
        IF ChargePlantToServOrder(SalesHeader) OR ChargeSOToJobPlantLoc(SalesHeader) THEN BEGIN
          ServiceOrder.CHANGECOMPANY(SalesHeader."Company Name");
          ServiceOrder.GET(SalesHeader."Service Order No.");
        END ELSE BEGIN
          IF NOT InternalChargePlantOnLoc(SalesHeader,'') THEN BEGIN
      //**4PS.en
            SalesHeader.TESTFIELD("Sell-to Customer No.");
            SalesHeader.TESTFIELD("Bill-to Customer No.");
      //**4PS.sn
          END;
        END;
      END;
      //**4PS.en
      SalesHeader.TESTFIELD("Posting Date");
      SalesHeader.TESTFIELD("Document Date");

      OnAfterCheckMandatoryFields(SalesHeader,SuppressCommit);
    END;

    LOCAL PROCEDURE ClearPostBuffers@132();
    BEGIN
      //**4PS.sn
      CLEAR(PlantJnlPostLine);
      CLEAR(LoanJnlPostLine);
      //**4PS.en
      CLEAR(WhsePostRcpt);
      CLEAR(WhsePostShpt);
      CLEAR(GenJnlPostLine);
      CLEAR(ResJnlPostLine);
      CLEAR(JobPostLine);
      CLEAR(ItemJnlPostLine);
      CLEAR(WhseJnlPostLine);
    END;

    [External]
    PROCEDURE SetPostingFlags@138(VAR SalesHeader@1000 : Record 36);
    BEGIN
      WITH SalesHeader DO BEGIN
        CASE "Document Type" OF
          "Document Type"::Order:
            Receive := FALSE;
          "Document Type"::Invoice:
            BEGIN
              Ship := TRUE;
              Invoice := TRUE;
              Receive := FALSE;
            END;
          "Document Type"::"Return Order":
            Ship := FALSE;
          "Document Type"::"Credit Memo":
            BEGIN
              Ship := FALSE;
              Invoice := TRUE;
              Receive := TRUE;
            END;
        END;
        IF ("Document Type" <> "Document Type"::"Invoice Proposal") AND (NOT InvoiceOrderNotPostedInvoice) THEN  //**4PS.n
          IF NOT (Ship OR Invoice OR Receive) THEN
            ERROR(ShipInvoiceReceiveErr);
      END;
    END;

    [External]
    PROCEDURE SetSuppressCommit@210(NewSuppressCommit@1000 : Boolean);
    BEGIN
      SuppressCommit := NewSuppressCommit;
    END;

    LOCAL PROCEDURE ClearAllVariables@270();
    BEGIN
      CLEARALL;
      TempSalesLineGlobal.DELETEALL;
      TempItemChargeAssgntSales.DELETEALL;
      TempHandlingSpecification.DELETEALL;
      TempATOTrackingSpecification.DELETEALL;
      TempTrackingSpecification.DELETEALL;
      TempTrackingSpecificationInv.DELETEALL;
      TempWhseSplitSpecification.DELETEALL;
      TempValueEntryRelation.DELETEALL;
      TempICGenJnlLine.DELETEALL;
      TempPrepmtDeductLCYSalesLine.DELETEALL;
      TempSKU.DELETEALL;
      TempDeferralHeader.DELETEALL;
      TempDeferralLine.DELETEALL;
    END;

    LOCAL PROCEDURE CheckAssosOrderLines@50(SalesHeader@1000 : Record 36);
    VAR
      SalesLine@1001 : Record 37;
      PurchaseOrderLine@1002 : Record 39;
      PurchaseHeader@1004 : Record 38;
      TempPurchaseHeader@1006 : TEMPORARY Record 38;
      TempPurchaseLine@1003 : TEMPORARY Record 39;
      CheckDimensions@1005 : Codeunit 481;
    BEGIN
      WITH SalesHeader DO BEGIN
        SalesLine.RESET;
        SalesLine.SETRANGE("Document Type","Document Type");
        SalesLine.SETRANGE("Document No.","No.");
        SalesLine.SETFILTER("Purch. Order Line No.",'<>0');
        IF SalesLine.FINDSET THEN
          REPEAT
            PurchaseOrderLine.GET(
              PurchaseOrderLine."Document Type"::Order,SalesLine."Purchase Order No.",SalesLine."Purch. Order Line No.");
            TempPurchaseLine := PurchaseOrderLine;
            TempPurchaseLine.INSERT;

            TempPurchaseHeader."Document Type" := TempPurchaseHeader."Document Type"::Order;
            TempPurchaseHeader."No." := SalesLine."Purchase Order No.";
            IF TempPurchaseHeader.INSERT THEN;
          UNTIL SalesLine.NEXT = 0;
      END;

      IF TempPurchaseHeader.FINDSET THEN
        REPEAT
          PurchaseHeader.GET(PurchaseHeader."Document Type"::Order,TempPurchaseHeader."No.");
          TempPurchaseLine.SETRANGE("Document No.",TempPurchaseHeader."No.");
          CheckDimensions.CheckPurchDim(PurchaseHeader,TempPurchaseLine);
        UNTIL TempPurchaseHeader.NEXT = 0;
    END;

    LOCAL PROCEDURE PostResJnlLine@136(VAR SalesHeader@1000 : Record 36;VAR SalesLine@1002 : Record 37;VAR JobTaskSalesLine@1003 : Record 37);
    VAR
      ResJnlLine@1001 : Record 207;
    BEGIN
      IF SalesLine."Qty. to Invoice" = 0 THEN
        EXIT;

      WITH ResJnlLine DO BEGIN
        INIT;
        CopyFromSalesHeader(SalesHeader);
        CopyDocumentFields(GenJnlLineDocNo,GenJnlLineExtDocNo,SrcCode,SalesHeader."Posting No. Series");
        CopyFromSalesLine(SalesLine);

        ResJnlPostLine.RunWithCheck(ResJnlLine);
        IF JobTaskSalesLine."Job Contract Entry No." > 0 THEN
          PostJobContractLine(SalesHeader,JobTaskSalesLine);
      END;

      OnAfterPostResJnlLine(SalesHeader,SalesLine,JobTaskSalesLine,ResJnlLine);
    END;

    LOCAL PROCEDURE ValidatePostingAndDocumentDate@199(VAR SalesHeader@1000 : Record 36);
    VAR
      BatchProcessingMgt@1002 : Codeunit 1380;
      BatchPostParameterTypes@1003 : Codeunit 1370;
      PostingDate@1007 : Date;
      ModifyHeader@1001 : Boolean;
      PostingDateExists@1006 : Boolean;
      ReplacePostingDate@1005 : Boolean;
      ReplaceDocumentDate@1004 : Boolean;
      DocumentDate@1100525001 : Date;
    BEGIN
      OnBeforeValidatePostingAndDocumentDate(SalesHeader,SuppressCommit);

      DocumentDate := SalesHeader."Document Date"; //**4PS.n

      PostingDateExists :=
        BatchProcessingMgt.GetParameterBoolean(SalesHeader.RECORDID,BatchPostParameterTypes.ReplacePostingDate,ReplacePostingDate) AND
        BatchProcessingMgt.GetParameterBoolean(
          SalesHeader.RECORDID,BatchPostParameterTypes.ReplaceDocumentDate,ReplaceDocumentDate) AND
        BatchProcessingMgt.GetParameterDate(SalesHeader.RECORDID,BatchPostParameterTypes.PostingDate,PostingDate);

      IF PostingDateExists AND (ReplacePostingDate OR (SalesHeader."Posting Date" = 0D)) THEN BEGIN
        SalesHeader."Posting Date" := PostingDate;
        SalesHeader.SynchronizeAsmHeader;
      //SalesHeader.VALIDATE("Currency Code"); //**4PS.o
        ModifyHeader := TRUE;
      END;

      IF PostingDateExists AND (ReplaceDocumentDate OR (SalesHeader."Document Date" = 0D)) THEN BEGIN
        SalesHeader.VALIDATE("Document Date",PostingDate);
        ModifyHeader := TRUE;
      END;

      //**4PS.sn
      // Check restore the Doc.Date, in table 'Sales Header'(36) because in the 'On Validate' of the field 'Posting Date'
      // a validate is done on the 'Doc.Date' (filled with new posting date).
      IF PostingDateExists AND ReplacePostingDate AND (NOT (ReplaceDocumentDate OR (SalesHeader."Document Date" = 0D))) THEN BEGIN
        SalesHeader.VALIDATE("Document Date",DocumentDate);
        ModifyHeader := TRUE;
      END;
      //**4PS.en

      IF ModifyHeader THEN
        SalesHeader.MODIFY;

      OnAfterValidatePostingAndDocumentDate(SalesHeader,SuppressCommit,PreviewMode);
    END;

    LOCAL PROCEDURE UpdateSalesLineDimSetIDFromAppliedEntry@62(VAR SalesLineToPost@1000 : Record 37;SalesLine@1001 : Record 37);
    VAR
      ItemLedgEntry@1002 : Record 32;
      DimensionMgt@1003 : Codeunit 408;
      DimSetID@1004 : ARRAY [10] OF Integer;
    BEGIN
      DimSetID[1] := SalesLine."Dimension Set ID";
      WITH SalesLineToPost DO BEGIN
        IF "Appl.-to Item Entry" <> 0 THEN BEGIN
          ItemLedgEntry.GET("Appl.-to Item Entry");
          DimSetID[2] := ItemLedgEntry."Dimension Set ID";
        END;
        "Dimension Set ID" :=
          DimensionMgt.GetCombinedDimensionSetID(DimSetID,"Shortcut Dimension 1 Code","Shortcut Dimension 2 Code");
      END;
    END;

    LOCAL PROCEDURE CalcDeferralAmounts@64(SalesHeader@1000 : Record 36;SalesLine@1003 : Record 37;OriginalDeferralAmount@1002 : Decimal);
    VAR
      DeferralHeader@1004 : Record 1701;
      DeferralLine@1005 : Record 1702;
      CurrExchRate@1006 : Record 330;
      TotalAmountLCY@1009 : Decimal;
      TotalAmount@1010 : Decimal;
      TotalDeferralCount@1007 : Integer;
      DeferralCount@1008 : Integer;
      UseDate@1001 : Date;
    BEGIN
      // Populate temp and calculate the LCY amounts for posting
      IF SalesHeader."Posting Date" = 0D THEN
        UseDate := WORKDATE
      ELSE
        UseDate := SalesHeader."Posting Date";

      IF DeferralHeader.GET(
           DeferralUtilities.GetSalesDeferralDocType,'','',SalesLine."Document Type",SalesLine."Document No.",SalesLine."Line No.")
      THEN BEGIN
        TempDeferralHeader := DeferralHeader;
        IF SalesLine.Quantity <> SalesLine."Qty. to Invoice" THEN
          TempDeferralHeader."Amount to Defer" :=
            ROUND(TempDeferralHeader."Amount to Defer" *
              SalesLine.GetDeferralAmount / OriginalDeferralAmount,Currency."Amount Rounding Precision");
        TempDeferralHeader."Amount to Defer (LCY)" :=
          ROUND(
            CurrExchRate.ExchangeAmtFCYToLCY(
              0, '', //**4PS.n
              UseDate,SalesHeader."Currency Code",
      //      TempDeferralHeader."Amount to Defer",SalesHeader."Currency Factor")); //**4PS.o
              TempDeferralHeader."Amount to Defer",SalesHeader."Currency Factor",TRUE)); //**4PS.n
        TempDeferralHeader.INSERT;

        WITH DeferralLine DO BEGIN
          DeferralUtilities.FilterDeferralLines(
            DeferralLine,DeferralHeader."Deferral Doc. Type",
            DeferralHeader."Gen. Jnl. Template Name",DeferralHeader."Gen. Jnl. Batch Name",
            DeferralHeader."Document Type",DeferralHeader."Document No.",DeferralHeader."Line No.");
          IF FINDSET THEN BEGIN
            TotalDeferralCount := COUNT;
            REPEAT
              DeferralCount := DeferralCount + 1;
              TempDeferralLine.INIT;
              TempDeferralLine := DeferralLine;

              IF DeferralCount = TotalDeferralCount THEN BEGIN
                TempDeferralLine.Amount := TempDeferralHeader."Amount to Defer" - TotalAmount;
                TempDeferralLine."Amount (LCY)" := TempDeferralHeader."Amount to Defer (LCY)" - TotalAmountLCY;
              END ELSE BEGIN
                IF SalesLine.Quantity <> SalesLine."Qty. to Invoice" THEN
                  TempDeferralLine.Amount :=
                    ROUND(TempDeferralLine.Amount *
                      SalesLine.GetDeferralAmount / OriginalDeferralAmount,Currency."Amount Rounding Precision");

                TempDeferralLine."Amount (LCY)" :=
                  ROUND(
                    CurrExchRate.ExchangeAmtFCYToLCY(
                      0, '', //**4PS.n
                      UseDate,SalesHeader."Currency Code",
      //               TempDeferralLine.Amount,SalesHeader."Currency Factor")); //**4PS.o
                      TempDeferralLine.Amount,SalesHeader."Currency Factor",TRUE)); //**4PS.n
                TotalAmount := TotalAmount + TempDeferralLine.Amount;
                TotalAmountLCY := TotalAmountLCY + TempDeferralLine."Amount (LCY)";
              END;

              OnBeforeTempDeferralLineInsert(TempDeferralLine,DeferralLine,SalesLine,DeferralCount,TotalDeferralCount);
              TempDeferralLine.INSERT;
            UNTIL NEXT = 0;
          END;
        END;
      END;
    END;

    LOCAL PROCEDURE CreatePostedDeferralScheduleFromSalesDoc@65(SalesLine@1008 : Record 37;NewDocumentType@1007 : Integer;NewDocumentNo@1003 : Code[20];NewLineNo@1002 : Integer;PostingDate@1000 : Date);
    VAR
      PostedDeferralHeader@1006 : Record 1704;
      PostedDeferralLine@1005 : Record 1705;
      DeferralTemplate@1004 : Record 1700;
      DeferralAccount@1001 : Code[20];
    BEGIN
      IF SalesLine."Deferral Code" = '' THEN
        EXIT;

      IF DeferralTemplate.GET(SalesLine."Deferral Code") THEN
        DeferralAccount := DeferralTemplate."Deferral Account";

      IF TempDeferralHeader.GET(
           DeferralUtilities.GetSalesDeferralDocType,'','',SalesLine."Document Type",SalesLine."Document No.",SalesLine."Line No.")
      THEN BEGIN
        PostedDeferralHeader.InitFromDeferralHeader(TempDeferralHeader,'','',
          NewDocumentType,NewDocumentNo,NewLineNo,DeferralAccount,SalesLine."Sell-to Customer No.",PostingDate);
        DeferralUtilities.FilterDeferralLines(
          TempDeferralLine,DeferralUtilities.GetSalesDeferralDocType,'','',
          SalesLine."Document Type",SalesLine."Document No.",SalesLine."Line No.");
        IF TempDeferralLine.FINDSET THEN
          REPEAT
            PostedDeferralLine.InitFromDeferralLine(
              TempDeferralLine,'','',NewDocumentType,NewDocumentNo,NewLineNo,DeferralAccount);
          UNTIL TempDeferralLine.NEXT = 0;
      END;

      OnAfterCreatePostedDeferralScheduleFromSalesDoc(SalesLine,PostedDeferralHeader);
    END;

    LOCAL PROCEDURE GetAmountRoundingPrecisionInLCY@122(DocType@1002 : Option;DocNo@1003 : Code[20];CurrencyCode@1000 : Code[10]) AmountRoundingPrecision : Decimal;
    VAR
      SalesHeader@1001 : Record 36;
    BEGIN
      IF CurrencyCode = '' THEN
        EXIT(GLSetup."Amount Rounding Precision");
      SalesHeader.GET(DocType,DocNo);
      AmountRoundingPrecision := Currency."Amount Rounding Precision" / SalesHeader."Currency Factor";
      IF AmountRoundingPrecision < GLSetup."Amount Rounding Precision" THEN
        EXIT(GLSetup."Amount Rounding Precision");
      EXIT(AmountRoundingPrecision);
    END;

    LOCAL PROCEDURE UpdateEmailParameters@197(SalesHeader@1000 : Record 36);
    VAR
      FindEmailParameter@1001 : Record 9510;
      RenameEmailParameter@1003 : Record 9510;
    BEGIN
      IF SalesHeader."Last Posting No." = '' THEN
        EXIT;
      FindEmailParameter.SETRANGE("Document No",SalesHeader."No.");
      FindEmailParameter.SETRANGE("Document Type",SalesHeader."Document Type");
      IF FindEmailParameter.FINDSET THEN
        REPEAT
          RenameEmailParameter.COPY(FindEmailParameter);
          RenameEmailParameter.RENAME(
            SalesHeader."Last Posting No.",FindEmailParameter."Document Type",FindEmailParameter."Parameter Type");
        UNTIL FindEmailParameter.NEXT = 0;
    END;

    LOCAL PROCEDURE ArchivePurchaseOrders@200(VAR TempDropShptPostBuffer@1000 : TEMPORARY Record 223);
    VAR
      PurchOrderHeader@1002 : Record 38;
      PurchOrderLine@1001 : Record 39;
    BEGIN
      IF TempDropShptPostBuffer.FINDSET THEN BEGIN
        REPEAT
          PurchOrderHeader.GET(PurchOrderHeader."Document Type"::Order,TempDropShptPostBuffer."Order No.");
          TempDropShptPostBuffer.SETRANGE("Order No.",TempDropShptPostBuffer."Order No.");
          REPEAT
            PurchOrderLine.GET(
              PurchOrderLine."Document Type"::Order,
              TempDropShptPostBuffer."Order No.",TempDropShptPostBuffer."Order Line No.");
            PurchOrderLine."Qty. to Receive" := TempDropShptPostBuffer.Quantity;
            PurchOrderLine."Qty. to Receive (Base)" := TempDropShptPostBuffer."Quantity (Base)";
            PurchOrderLine.MODIFY;
          UNTIL TempDropShptPostBuffer.NEXT = 0;
          PurchPost.ArchiveUnpostedOrder(PurchOrderHeader);
          TempDropShptPostBuffer.SETRANGE("Order No.");
        UNTIL TempDropShptPostBuffer.NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE IsItemJnlPostLineHandled@283(VAR ItemJnlLine@1000 : Record 83;VAR SalesLine@1001 : Record 37;VAR SalesHeader@1002 : Record 36) IsHandled : Boolean;
    BEGIN
      IsHandled := FALSE;
      OnBeforeItemJnlPostLine(ItemJnlLine,SalesLine,SalesHeader,SuppressCommit,IsHandled);
      EXIT(IsHandled);
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePostLines@215(VAR SalesLine@1000 : Record 37;SalesHeader@1001 : Record 36;CommitIsSuppressed@1002 : Boolean;PreviewMode@1003 : Boolean);
    BEGIN
    END;

    [Integration(TRUE)]
    LOCAL PROCEDURE OnBeforePostSalesDoc@133(VAR SalesHeader@1000 : Record 36;CommitIsSuppressed@1001 : Boolean;PreviewMode@1002 : Boolean;VAR HideProgressWindow@1003 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePostCommitSalesDoc@134(VAR SalesHeader@1000 : Record 36;VAR GenJnlPostLine@1003 : Codeunit 12;PreviewMode@1001 : Boolean;VAR ModifyHeader@1002 : Boolean;VAR CommitIsSuppressed@1004 : Boolean;VAR TempSalesLineGlobal@1005 : TEMPORARY Record 37);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterCheckSalesDoc@1(VAR SalesHeader@1000 : Record 36;CommitIsSuppressed@1001 : Boolean;WhseShip@1002 : Boolean;WhseReceive@1003 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterCheckAndUpdate@261(VAR SalesHeader@1000 : Record 36;CommitIsSuppressed@1001 : Boolean;PreviewMode@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterCheckTrackingAndWarehouseForReceive@220(VAR SalesHeader@1001 : Record 36;VAR Receive@1000 : Boolean;CommitIsSuppressed@1002 : Boolean;VAR TempWhseShptHeader@1003 : TEMPORARY Record 7320;VAR TempWhseRcptHeader@1004 : TEMPORARY Record 7316);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterCheckTrackingAndWarehouseForShip@212(VAR SalesHeader@1000 : Record 36;VAR Ship@1001 : Boolean;CommitIsSuppressed@1002 : Boolean;VAR TempWhseShptHeader@1004 : TEMPORARY Record 7320;VAR TempWhseRcptHeader@1003 : TEMPORARY Record 7316;VAR TempSalesLine@1005 : TEMPORARY Record 37);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterCreatePostedDeferralScheduleFromSalesDoc@375(VAR SalesLine@1000 : Record 37;VAR PostedDeferralHeader@1001 : Record 1704);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterDeleteAfterPosting@129(SalesHeader@1000 : Record 36;SalesInvoiceHeader@1001 : Record 112;SalesCrMemoHeader@1002 : Record 114;CommitIsSuppressed@1003 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterFillInvoicePostBuffer@208(VAR InvoicePostBuffer@1000 : Record 49;SalesLine@1001 : Record 37;VAR TempInvoicePostBuffer@1003 : TEMPORARY Record 49;CommitIsSuppressed@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterFillDeferralPostingBuffer@349(VAR SalesLine@1001 : Record 37;VAR InvoicePostBuffer@1002 : Record 49;VAR TempInvoicePostBuffer@1003 : TEMPORARY Record 49;UseDate@1006 : Date;InvDefLineNo@1005 : Integer;DeferralLineNo@1004 : Integer;CommitIsSuppressed@1000 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterInvoicePostingBufferAssignAmounts@378(SalesLine@1000 : Record 37;VAR TotalAmount@1001 : Decimal;VAR TotalAmountLCY@1002 : Decimal);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterInvoicePostingBufferSetAmounts@367(VAR InvoicePostBuffer@1000 : Record 49;SalesLine@1001 : Record 37);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterIncrAmount@231(VAR TotalSalesLine@1000 : Record 37;SalesLine@1001 : Record 37;SalesHeader@1002 : Record 36);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterInitAssocItemJnlLine@282(VAR ItemJournalLine@1000 : Record 83;PurchaseHeader@1001 : Record 38;PurchaseLine@1002 : Record 39;SalesHeader@1003 : Record 36);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterInvoiceRoundingAmount@262(SalesHeader@1000 : Record 36;VAR SalesLine@1001 : Record 37;VAR TotalSalesLine@1002 : Record 37;UseTempData@1003 : Boolean;InvoiceRoundingAmount@1004 : Decimal;CommitIsSuppressed@1005 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterInsertDropOrderPurchRcptHeader@286(VAR PurchRcptHeader@1000 : Record 120);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterInsertedPrepmtVATBaseToDeduct@271(SalesHeader@1000 : Record 36;SalesLine@1001 : Record 37;PrepmtLineNo@1002 : Integer;TotalPrepmtAmtToDeduct@1003 : Decimal;VAR TempPrepmtDeductLCYSalesLine@1004 : TEMPORARY Record 37;VAR PrepmtVATBaseToDeduct@1005 : Decimal);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterPostSalesDoc@135(VAR SalesHeader@1001 : Record 36;VAR GenJnlPostLine@1000 : Codeunit 12;SalesShptHdrNo@1002 : Code[20];RetRcpHdrNo@1003 : Code[20];SalesInvHdrNo@1004 : Code[20];SalesCrMemoHdrNo@1005 : Code[20];CommitIsSuppressed@1006 : Boolean;InvtPickPutaway@1007 : Boolean);
    BEGIN
    END;

    [Integration(DEFAULT,TRUE)]
    LOCAL PROCEDURE OnAfterPostSalesDocDropShipment@239(PurchRcptNo@1000 : Code[20];CommitIsSuppressed@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterPostCustomerEntry@226(VAR GenJnlLine@1003 : Record 81;VAR SalesHeader@1000 : Record 36;VAR TotalSalesLine@1001 : Record 37;VAR TotalSalesLineLCY@1002 : Record 37;CommitIsSuppressed@1004 : Boolean;VAR GenJnlPostLine@1005 : Codeunit 12);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterPostBalancingEntry@204(VAR GenJnlLine@1000 : Record 81;VAR SalesHeader@1003 : Record 36;VAR TotalSalesLine@1002 : Record 37;VAR TotalSalesLineLCY@1001 : Record 37;CommitIsSuppressed@1004 : Boolean;VAR GenJnlPostLine@1005 : Codeunit 12);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterPostInvPostBuffer@205(VAR GenJnlLine@1000 : Record 81;VAR InvoicePostBuffer@1001 : Record 49;VAR SalesHeader@1003 : Record 36;GLEntryNo@1002 : Integer;CommitIsSuppressed@1004 : Boolean;VAR GenJnlPostLine@1005 : Codeunit 12);
    BEGIN
    END;

    [Integration(TRUE)]
    LOCAL PROCEDURE OnAfterPostItemJnlLine@491(VAR ItemJournalLine@1000 : Record 83;SalesLine@1001 : Record 37;SalesHeader@1002 : Record 36;VAR ItemJnlPostLine@1003 : Codeunit 22);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterPostSalesLines@221(VAR SalesHeader@1000 : Record 36;VAR SalesShipmentHeader@1001 : Record 110;VAR SalesInvoiceHeader@1002 : Record 112;VAR SalesCrMemoHeader@1003 : Record 114;VAR ReturnReceiptHeader@1004 : Record 6660;WhseShip@1005 : Boolean;WhseReceive@1006 : Boolean;VAR SalesLinesProcessed@1007 : Boolean;CommitIsSuppressed@1008 : Boolean;EverythingInvoiced@1009 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterPostSalesLine@224(VAR SalesHeader@1000 : Record 36;VAR SalesLine@1001 : Record 37;CommitIsSuppressed@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterUpdatePostingNos@22(VAR SalesHeader@1000 : Record 36;VAR NoSeriesMgt@1001 : Codeunit 396;CommitIsSuppressed@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterCheckMandatoryFields@195(VAR SalesHeader@1000 : Record 36;CommitIsSuppressed@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterSalesInvHeaderInsert@207(VAR SalesInvHeader@1000 : Record 112;SalesHeader@1001 : Record 36;CommitIsSuppressed@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterSalesInvLineInsert@174(VAR SalesInvLine@1000 : Record 113;SalesInvHeader@1002 : Record 112;SalesLine@1001 : Record 37;ItemLedgShptEntryNo@1003 : Integer;WhseShip@1004 : Boolean;WhseReceive@1005 : Boolean;CommitIsSuppressed@1006 : Boolean;VAR SalesHeader@1007 : Record 36;VAR TempItemChargeAssgntSales@1008 : TEMPORARY Record 5809);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterSalesCrMemoHeaderInsert@203(VAR SalesCrMemoHeader@1001 : Record 114;SalesHeader@1000 : Record 36;CommitIsSuppressed@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterSalesCrMemoLineInsert@182(VAR SalesCrMemoLine@1000 : Record 115;SalesCrMemoHeader@1002 : Record 114;VAR SalesHeader@1003 : Record 36;SalesLine@1001 : Record 37;VAR TempItemChargeAssgntSales@1005 : TEMPORARY Record 5809;CommitIsSuppressed@1004 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterSalesShptHeaderInsert@234(VAR SalesShipmentHeader@1000 : Record 110;SalesHeader@1001 : Record 36;SuppressCommit@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterSalesShptLineInsert@209(VAR SalesShipmentLine@1000 : Record 111;SalesLine@1001 : Record 37;ItemShptLedEntryNo@1005 : Integer;WhseShip@1004 : Boolean;WhseReceive@1003 : Boolean;CommitIsSuppressed@1002 : Boolean;SalesInvoiceHeader@1006 : Record 112);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterPurchRcptHeaderInsert@276(VAR PurchRcptHeader@1000 : Record 120;PurchaseHeader@1001 : Record 38;SalesHeader@1002 : Record 36;CommitIsSuppressed@1003 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterPurchRcptLineInsert@281(VAR PurchRcptLine@1000 : Record 121;PurchRcptHeader@1001 : Record 120;PurchOrderLine@1002 : Record 39;DropShptPostBuffer@1003 : Record 223;CommitIsSuppressed@1004 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterReturnRcptHeaderInsert@236(VAR ReturnReceiptHeader@1000 : Record 6660;SalesHeader@1001 : Record 36;SuppressCommit@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterReturnRcptLineInsert@206(VAR ReturnRcptLine@1002 : Record 6661;ReturnRcptHeader@1001 : Record 6660;SalesLine@1000 : Record 37;ItemShptLedEntryNo@1003 : Integer;WhseShip@1004 : Boolean;WhseReceive@1005 : Boolean;CommitIsSuppressed@1006 : Boolean;SalesCrMemoHeader@1007 : Record 114);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterFinalizePosting@196(VAR SalesHeader@1000 : Record 36;VAR SalesShipmentHeader@1001 : Record 110;VAR SalesInvoiceHeader@1002 : Record 112;VAR SalesCrMemoHeader@1003 : Record 114;VAR ReturnReceiptHeader@1004 : Record 6660;VAR GenJnlPostLine@1005 : Codeunit 12;CommitIsSuppressed@1006 : Boolean;PreviewMode@1007 : Boolean);
    BEGIN
    END;

    [Integration(DEFAULT,TRUE)]
    LOCAL PROCEDURE OnAfterFinalizePostingOnBeforeCommit@251(VAR SalesHeader@1000 : Record 36;VAR SalesShipmentHeader@1001 : Record 110;VAR SalesInvoiceHeader@1002 : Record 112;VAR SalesCrMemoHeader@1003 : Record 114;VAR ReturnReceiptHeader@1004 : Record 6660;VAR GenJnlPostLine@1005 : Codeunit 12;CommitIsSuppressed@1006 : Boolean;PreviewMode@1007 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterResetTempLines@230(VAR TempSalesLineLocal@1000 : TEMPORARY Record 37);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterRestoreSalesHeader@309(VAR SalesHeader@1000 : Record 36;SalesHeaderCopy@1001 : Record 36);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterUpdateAfterPosting@305(VAR SalesHeader@1000 : Record 36;VAR TempSalesLine@1001 : TEMPORARY Record 37);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterUpdateSalesHeader@304(VAR CustLedgerEntry@1000 : Record 21;VAR SalesInvoiceHeader@1001 : Record 112;VAR SalesCrMemoHeader@1002 : Record 114;GenJnlLineDocType@1003 : Integer);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterUpdateSalesLineBeforePost@297(VAR SalesLine@1000 : Record 37;VAR SalesHeader@1001 : Record 36;WhseShip@1002 : Boolean;WhseReceive@1003 : Boolean;CommitIsSuppressed@1005 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeArchiveUnpostedOrder@489(VAR SalesHeader@1000 : Record 36;VAR IsHandled@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeCreatePostedWhseRcptHeader@294(VAR PostedWhseReceiptHeader@1000 : Record 7318;WarehouseReceiptHeader@1001 : Record 7316;SalesHeader@1002 : Record 36);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeCreatePrepaymentLines@323(SalesHeader@1000 : Record 36;VAR TempPrepmtSalesLine@1001 : TEMPORARY Record 37;CompleteFunctionality@1002 : Boolean;VAR IsHandled@1003 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeBlanketOrderSalesLineModify@296(VAR BlanketOrderSalesLine@1000 : Record 37;SalesLine@1001 : Record 37);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeCreatePostedWhseShptHeader@291(VAR PostedWhseShipmentHeader@1000 : Record 7322;WarehouseShipmentHeader@1001 : Record 7320;SalesHeader@1002 : Record 36);
    BEGIN
    END;

    [Integration(DEFAULT,TRUE)]
    LOCAL PROCEDURE OnBeforeFinalizePosting@228(VAR SalesHeader@1000 : Record 36;VAR TempSalesLineGlobal@1001 : TEMPORARY Record 37;VAR EverythingInvoiced@1002 : Boolean;SuppressCommit@1003 : Boolean;VAR GenJnlPostLine@1004 : Codeunit 12);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeInitAssocItemJnlLine@389(VAR ItemJournalLine@1000 : Record 83;PurchaseHeader@1001 : Record 38;PurchaseLine@1002 : Record 39;SalesHeader@1003 : Record 36);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeInsertICGenJnlLine@198(VAR ICGenJournalLine@1000 : Record 81;SalesHeader@1001 : Record 36;SalesLine@1002 : Record 37;CommitIsSuppressed@1003 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeInsertPostedHeaders@298(VAR SalesHeader@1000 : Record 36;VAR TempWarehouseShipmentHeader@1002 : TEMPORARY Record 7320;VAR TempWarehouseReceiptHeader@1001 : TEMPORARY Record 7316);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeInsertReturnReceiptHeader@237(SalesHeader@1000 : Record 36;VAR ReturnReceiptHeader@1001 : Record 6660;VAR Handled@1002 : Boolean;CommitIsSuppressed@1003 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeInvoiceRoundingAmount@211(SalesHeader@1000 : Record 36;TotalAmountIncludingVAT@1001 : Decimal;UseTempData@1002 : Boolean;VAR InvoiceRoundingAmount@1003 : Decimal;CommitIsSuppressed@1004 : Boolean;VAR TotalSalesLine@1005 : Record 37);
    BEGIN
    END;

    [Integration(DEFAULT,TRUE)]
    LOCAL PROCEDURE OnBeforeItemJnlPostLine@227(VAR ItemJournalLine@1000 : Record 83;SalesLine@1001 : Record 37;SalesHeader@1002 : Record 36;CommitIsSuppressed@1003 : Boolean;VAR IsHandled@1004 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeLockTables@177(VAR SalesHeader@1000 : Record 36;PreviewMode@1001 : Boolean;CommitIsSuppressed@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeSalesLineDeleteAll@213(VAR SalesLine@1000 : Record 37;CommitIsSuppressed@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeSalesShptHeaderInsert@183(VAR SalesShptHeader@1001 : Record 110;SalesHeader@1000 : Record 36;CommitIsSuppressed@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeSalesShptLineInsert@192(VAR SalesShptLine@1001 : Record 111;SalesShptHeader@1002 : Record 110;SalesLine@1000 : Record 37;CommitIsSuppressed@1003 : Boolean;PostedWhseShipmentLine@1004 : Record 7323;SalesHeader@1005 : Record 36;WhseShip@1006 : Boolean;WhseReceive@1007 : Boolean;ItemLedgShptEntryNo@1008 : Integer);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeSalesInvHeaderInsert@185(VAR SalesInvHeader@1001 : Record 112;SalesHeader@1000 : Record 36;CommitIsSuppressed@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeSalesInvLineInsert@189(VAR SalesInvLine@1001 : Record 113;SalesInvHeader@1000 : Record 112;SalesLine@1002 : Record 37;CommitIsSuppressed@1003 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeSalesCrMemoHeaderInsert@187(VAR SalesCrMemoHeader@1001 : Record 114;SalesHeader@1000 : Record 36;CommitIsSuppressed@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeSalesCrMemoLineInsert@190(VAR SalesCrMemoLine@1001 : Record 115;SalesCrMemoHeader@1000 : Record 114;SalesLine@1002 : Record 37;CommitIsSuppressed@1003 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePurchRcptHeaderInsert@275(VAR PurchRcptHeader@1000 : Record 120;PurchaseHeader@1001 : Record 38;SalesHeader@1002 : Record 36;CommitIsSuppressed@1003 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePurchRcptLineInsert@278(VAR PurchRcptLine@1000 : Record 121;PurchRcptHeader@1001 : Record 120;PurchOrderLine@1002 : Record 39;DropShptPostBuffer@1003 : Record 223;CommitIsSuppressed@1004 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeReturnRcptHeaderInsert@186(VAR ReturnRcptHeader@1001 : Record 6660;SalesHeader@1000 : Record 36;CommitIsSuppressed@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeReturnRcptLineInsert@191(VAR ReturnRcptLine@1001 : Record 6661;ReturnRcptHeader@1002 : Record 6660;SalesLine@1000 : Record 37;CommitIsSuppressed@1003 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePostCustomerEntry@193(VAR GenJnlLine@1003 : Record 81;VAR SalesHeader@1000 : Record 36;VAR TotalSalesLine@1001 : Record 37;VAR TotalSalesLineLCY@1002 : Record 37;CommitIsSuppressed@1004 : Boolean;PreviewMode@1005 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePostBalancingEntry@194(VAR GenJnlLine@1000 : Record 81;SalesHeader@1003 : Record 36;VAR TotalSalesLine@1002 : Record 37;VAR TotalSalesLineLCY@1001 : Record 37;CommitIsSuppressed@1004 : Boolean;PreviewMode@1005 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePostInvPostBuffer@148(VAR GenJnlLine@1000 : Record 81;VAR InvoicePostBuffer@1001 : Record 49;VAR SalesHeader@1003 : Record 36;CommitIsSuppressed@1002 : Boolean;VAR GenJnlPostLine@1004 : Codeunit 12;PreviewMode@1005 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePostInvoicePostBuffer@409(SalesHeader@1000 : Record 36;VAR TempInvoicePostBuffer@1001 : TEMPORARY Record 49;VAR TotalSalesLine@1002 : Record 37;VAR TotalSalesLineLCY@1003 : Record 37);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePostJobContractLine@391(SalesHeader@1000 : Record 36;SalesLine@1001 : Record 37;VAR IsHandled@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePostAssocItemJnlLine@238(VAR ItemJournalLine@1000 : Record 83;VAR PurchaseLine@1001 : Record 39;CommitIsSuppressed@1002 : Boolean;VAR SalesLine@1003 : Record 37);
    BEGIN
    END;

    [Integration(TRUE,TRUE)]
    LOCAL PROCEDURE OnBeforePostItemJnlLine@243(SalesHeader@1009 : Record 36;VAR SalesLine@1008 : Record 37;VAR QtyToBeShipped@1007 : Decimal;VAR QtyToBeShippedBase@1006 : Decimal;VAR QtyToBeInvoiced@1005 : Decimal;VAR QtyToBeInvoicedBase@1004 : Decimal;VAR ItemLedgShptEntryNo@1003 : Integer;VAR ItemChargeNo@1002 : Code[20];VAR TrackingSpecification@1001 : Record 336;VAR IsATO@1000 : Boolean;CommitIsSuppressed@1010 : Boolean;VAR IsHandled@1011 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePostItemChargePerOrder@242(VAR SalesHeader@1003 : Record 36;VAR SalesLine@1002 : Record 37;VAR ItemJnlLine2@1001 : Record 83;VAR ItemChargeSalesLine@1000 : Record 37;CommitIsSuppressed@1004 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeUpdatePostingNos@338(VAR SalesHeader@1000 : Record 36;VAR NoSeriesMgt@1001 : Codeunit 396;CommitIsSuppressed@1002 : Boolean;VAR ModifyHeader@1003 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterPostItemJnlLineBeforePost@303(VAR ItemJournalLine@1000 : Record 83;SalesLine@1001 : Record 37);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterPostItemJnlLineWhseLine@1006(SalesLine@1000 : Record 37;ItemLedgEntryNo@1001 : Integer;WhseShip@1002 : Boolean;WhseReceive@1003 : Boolean;CommitIsSuppressed@1004 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterPostItemTrackingReturnRcpt@250(VAR SalesInvoiceHeader@1000 : Record 112;VAR SalesShipmentLine@1001 : Record 111;VAR TempTrackingSpecification@1002 : TEMPORARY Record 336;VAR TrackingSpecificationExists@1003 : Boolean;VAR SalesCrMemoHeader@1004 : Record 114;VAR ReturnReceiptLine@1005 : Record 6661;SalesLine@1006 : Record 37;QtyToBeInvoiced@1007 : Decimal;QtyToBeInvoicedBase@1008 : Decimal);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterPostItemTrackingForShipment@52(VAR SalesInvoiceHeader@1008 : Record 112;VAR SalesShipmentLine@1007 : Record 111;VAR TempTrackingSpecification@1006 : TEMPORARY Record 336;VAR TrackingSpecificationExists@1005 : Boolean;SalesLine@1002 : Record 37;QtyToBeInvoiced@1001 : Decimal;QtyToBeInvoicedBase@1000 : Decimal);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterTestSalesLine@1009(SalesHeader@1004 : Record 36;SalesLine@1000 : Record 37;WhseShip@1001 : Boolean;WhseReceive@1002 : Boolean;CommitIsSuppressed@1003 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterPostUpdateOrderLineModifyTempLine@1010(SalesLine@1000 : Record 37;WhseShip@1001 : Boolean;WhseReceive@1002 : Boolean;CommitIsSuppressed@1003 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterPostGLAndCustomer@218(VAR SalesHeader@1000 : Record 36;VAR GenJnlPostLine@1001 : Codeunit 12;TotalSalesLine@1003 : Record 37;TotalSalesLineLCY@1004 : Record 37;CommitIsSuppressed@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterPostResJnlLine@347(SalesHeader@1000 : Record 36;SalesLine@1002 : Record 37;JobTaskSalesLine@1003 : Record 37;ResJnlLine@1004 : Record 207);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterReverseAmount@244(VAR SalesLine@1000 : Record 37);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterSetApplyToDocNo@124(VAR GenJournalLine@1000 : Record 81;SalesHeader@1001 : Record 36);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterDivideAmount@256(SalesHeader@1005 : Record 36;VAR SalesLine@1004 : Record 37;QtyType@1003 : 'General,Invoicing,Shipping';SalesLineQty@1002 : Decimal;VAR TempVATAmountLine@1001 : TEMPORARY Record 290;VAR TempVATAmountLineRemainder@1000 : TEMPORARY Record 290);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterRoundAmount@257(SalesHeader@1002 : Record 36;VAR SalesLine@1001 : Record 37;SalesLineQty@1000 : Decimal);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterUpdateBlanketOrderLine@334(VAR BlanketOrderSalesLine@1000 : Record 37;SalesLine@1001 : Record 37;Ship@1002 : Boolean;Receive@1003 : Boolean;Invoice@1004 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterUpdatePrepmtSalesLineWithRounding@259(VAR PrepmtSalesLine@1004 : Record 37;TotalRoundingAmount@1003 : ARRAY [2] OF Decimal;TotalPrepmtAmount@1002 : ARRAY [2] OF Decimal;FinalInvoice@1001 : Boolean;PricesInclVATRoundingAmount@1000 : ARRAY [2] OF Decimal;VAR TotalSalesLine@1005 : Record 37;VAR TotalSalesLineLCY@1006 : Record 37);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterUpdateWhseDocuments@302(SalesHeader@1000 : Record 36;WhseShip@1001 : Boolean;WhseReceive@1002 : Boolean;WhseShptHeader@1003 : Record 7320;WhseRcptHeader@1004 : Record 7316);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterReleaseSalesDoc@269(VAR SalesHeader@1000 : Record 36);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnAfterValidatePostingAndDocumentDate@290(VAR SalesHeader@1000 : Record 36;CommitIsSuppressed@1001 : Boolean;PreviewMode@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeDivideAmount@252(SalesHeader@1005 : Record 36;VAR SalesLine@1004 : Record 37;QtyType@1003 : 'General,Invoicing,Shipping';VAR SalesLineQty@1002 : Decimal;VAR TempVATAmountLine@1001 : TEMPORARY Record 290;VAR TempVATAmountLineRemainder@1000 : TEMPORARY Record 290);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeInvoicePostingBufferSetAmounts@328(SalesLine@1000 : Record 37;VAR TempInvoicePostBuffer@1001 : TEMPORARY Record 49;VAR InvoicePostBuffer@1002 : Record 49;VAR TotalVAT@1010 : Decimal;VAR TotalVATACY@1009 : Decimal;VAR TotalAmount@1008 : Decimal;VAR TotalAmountACY@1007 : Decimal;VAR TotalVATBase@1004 : Decimal;VAR TotalVATBaseACY@1003 : Decimal);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeRoundAmount@255(VAR SalesHeader@1002 : Record 36;VAR SalesLine@1001 : Record 37;SalesLineQty@1000 : Decimal);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePostDropOrderShipment@327(VAR SalesHeader@1000 : Record 36;VAR TempDropShptPostBuffer@1001 : TEMPORARY Record 223);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePostGLAndCustomer@202(VAR SalesHeader@1000 : Record 36;VAR TempInvoicePostBuffer@1001 : TEMPORARY Record 49;VAR CustLedgerEntry@1002 : Record 21;CommitIsSuppressed@1003 : Boolean;PreviewMode@1004 : Boolean;VAR GenJnlPostLine@1005 : Codeunit 12;VAR IsHandled@1006 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePostItemTrackingReturnRcpt@339(VAR SalesInvoiceHeader@1000 : Record 112;VAR SalesShipmentLine@1001 : Record 111;VAR TempTrackingSpecification@1002 : TEMPORARY Record 336;VAR TrackingSpecificationExists@1003 : Boolean;VAR SalesCrMemoHeader@1004 : Record 114;VAR ReturnReceiptLine@1005 : Record 6661;SalesLine@1006 : Record 37;QtyToBeInvoiced@1007 : Decimal;QtyToBeInvoicedBase@1008 : Decimal);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePostItemTrackingForShipment@336(VAR SalesInvoiceHeader@1008 : Record 112;VAR SalesShipmentLine@1007 : Record 111;VAR TempTrackingSpecification@1006 : TEMPORARY Record 336;VAR TrackingSpecificationExists@1005 : Boolean;SalesLine@1002 : Record 37;QtyToBeInvoiced@1001 : Decimal;QtyToBeInvoicedBase@1000 : Decimal);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePostUpdateOrderLine@263(SalesHeader@1000 : Record 36;VAR TempSalesLineGlobal@1001 : TEMPORARY Record 37;CommitIsSuppressed@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePostUpdateOrderLineModifyTempLine@171(VAR TempSalesLine@1000 : TEMPORARY Record 37;WhseShip@1001 : Boolean;WhseReceive@1002 : Boolean;CommitIsSuppressed@1003 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeValidatePostingAndDocumentDate@214(VAR SalesHeader@1000 : Record 36;CommitIsSuppressed@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeUpdateInvoicedQtyOnShipmentLine@216(VAR SalesShipmentLine@1002 : Record 111;SalesLine@1001 : Record 37;SalesHeader@1000 : Record 36;SalesInvoiceHeader@1003 : Record 112;CommitIsSuppressed@1004 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeSendICDocument@331(VAR SalesHeader@1000 : Record 36;VAR ModifyHeader@1001 : Boolean;VAR IsHandled@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeTestSalesLine@130(VAR SalesHeader@1000 : Record 36;VAR SalesLine@1001 : Record 37;CommitIsSuppressed@1002 : Boolean;VAR IsHandled@1003 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeTestSalesLineFixedAsset@320(SalesLine@1000 : Record 37;VAR IsHandled@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeTestSalesLineItemCharge@319(SalesLine@1000 : Record 37;VAR IsHandled@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeTestSalesLineJob@313(SalesLine@1000 : Record 37;VAR SkipTestJobNo@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeTestSalesLineOthers@316(SalesLine@1000 : Record 37;VAR SkipTestJobNo@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeTempDeferralLineInsert@306(VAR TempDeferralLine@1000 : TEMPORARY Record 1702;DeferralLine@1001 : Record 1702;SalesLine@1002 : Record 37;VAR DeferralCount@1003 : Integer;VAR TotalDeferralCount@1004 : Integer);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeTempPrepmtSalesLineInsert@260(VAR TempPrepmtSalesLine@1000 : TEMPORARY Record 37;VAR TempSalesLine@1001 : TEMPORARY Record 37;SalesHeader@1002 : Record 36;CompleteFunctionality@1003 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeTempPrepmtSalesLineModify@258(VAR TempPrepmtSalesLine@1000 : TEMPORARY Record 37;VAR TempSalesLine@1001 : TEMPORARY Record 37;SalesHeader@1002 : Record 36;CompleteFunctionality@1003 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeReleaseSalesDoc@265(VAR SalesHeader@1000 : Record 36);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeUpdateAssocLines@289(VAR SalesOrderLine@1000 : Record 37;VAR IsHandled@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeUpdateBlanketOrderLine@333(SalesLine@1003 : Record 37;Ship@1002 : Boolean;Receive@1001 : Boolean;Invoice@1000 : Boolean;VAR IsHandled@1004 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeUpdateHandledICInboxTransaction@335(VAR SalesHeader@1000 : Record 36;VAR IsHandled@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeUpdatePostingNo@342(VAR SalesHeader@1000 : Record 36;PreviewMode@1001 : Boolean;VAR ModifyHeader@1002 : Boolean;VAR IsHandled@1003 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeUpdatePrepmtSalesLineWithRounding@268(VAR PrepmtSalesLine@1004 : Record 37;TotalRoundingAmount@1003 : ARRAY [2] OF Decimal;TotalPrepmtAmount@1002 : ARRAY [2] OF Decimal;FinalInvoice@1001 : Boolean;PricesInclVATRoundingAmount@1000 : ARRAY [2] OF Decimal;VAR TotalSalesLine@1005 : Record 37;VAR TotalSalesLineLCY@1006 : Record 37);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeUpdateSalesLineBeforePost@295(VAR SalesLine@1000 : Record 37;VAR SalesHeader@1001 : Record 36;WhseShip@1002 : Boolean;WhseReceive@1003 : Boolean;RoundingLineInserted@1004 : Boolean;CommitIsSuppressed@1005 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeUpdateShippingNo@299(VAR SalesHeader@1000 : Record 36;WhseShip@1001 : Boolean;WhseReceive@1002 : Boolean;InvtPickPutaway@1003 : Boolean;PreviewMode@1004 : Boolean;VAR ModifyHeader@1005 : Boolean;VAR IsHandled@1006 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeWhseHandlingRequired@332(SalesLine@1000 : Record 37;VAR Required@1001 : Boolean;VAR IsHandled@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnInvoiceSalesShptLine@217(SalesShipmentLine@1000 : Record 111;InvoiceNo@1001 : Code[20];InvoiceLineNo@1002 : Integer;QtyToInvoice@1003 : Decimal;CommitIsSuppressed@1004 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnSendSalesDocument@70(ShipAndInvoice@1000 : Boolean;CommitIsSuppressed@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeDeleteAfterPosting@219(VAR SalesHeader@1000 : Record 36;VAR SalesInvoiceHeader@1001 : Record 112;VAR SalesCrMemoHeader@1002 : Record 114;VAR SkipDelete@1003 : Boolean;CommitIsSuppressed@1004 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnFillInvoicePostingBufferOnBeforeDeferrals@229(VAR SalesLine@1000 : Record 37;VAR TotalAmount@1001 : Decimal;VAR TotalAmountACY@1002 : Decimal;UseDate@1003 : Date);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeFillDeferralPostingBuffer@225(VAR SalesLine@1002 : Record 37;VAR TempInvoicePostBuffer@1001 : TEMPORARY Record 49;VAR InvoicePostBuffer@1000 : Record 49;UseDate@1003 : Date;InvDefLineNo@1004 : Integer;DeferralLineNo@1005 : Integer;CommitIsSuppressed@1006 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeGetCountryCode@264(SalesHeader@1000 : Record 36;SalesLine@1001 : Record 37;VAR CountryRegionCode@1003 : Code[10];VAR IsHandled@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeInsertReturnReceiptLine@345(SalesLine@1000 : Record 37;ReturnRcptLine@1001 : Record 6661;VAR RemQtyToBeInvoiced@1002 : Decimal;VAR RemQtyToBeInvoicedBase@1003 : Decimal);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePostItemTrackingForReceiptCondition@288(SalesLine@1000 : Record 37;ReturnRcptLine@1002 : Record 6661;VAR Condition@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforePostItemTrackingForShipmentCondition@292(SalesLine@1000 : Record 37;SalesShptLine@1002 : Record 111;VAR Condition@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnBeforeShouldPostWhseJnlLine@344(SalesLine@1000 : Record 37;VAR Result@1001 : Boolean;VAR IsHandled@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnCalcInvDiscountSetFilter@233(VAR SalesLine@1000 : Record 37;SalesHeader@1001 : Record 36);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnCopyAndCheckItemChargeOnBeforeLoop@394(VAR TempSalesLine@1000 : TEMPORARY Record 37;SalesHeader@1001 : Record 36);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnCopyToTempLinesOnAfterSetFilters@175(VAR SalesLine@1000 : Record 37;SalesHeader@1001 : Record 36);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnInsertPostedHeadersOnBeforeInsertInvoiceHeader@343(SalesHeader@1000 : Record 36;VAR IsHandled@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnSumSalesLines2OnBeforeDivideAmount@326(VAR OldSalesLine@1000 : Record 37;VAR IsHandled@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnSumSalesLines2SetFilter@235(VAR SalesLine@1001 : Record 37;SalesHeader@1000 : Record 36;InsertSalesLine@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnPostSalesLineOnAfterTestUpdatedSalesLine@247(VAR SalesLine@1000 : Record 37;VAR EverythingInvoiced@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnPostUpdateOrderLineOnBeforeInitOutstanding@307(VAR SalesHeader@1000 : Record 36;VAR TempSalesLine@1001 : TEMPORARY Record 37);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnPostUpdateOrderLineOnBeforeInitTempSalesLineQuantities@245(VAR SalesHeader@1000 : Record 36;VAR TempSalesLine@1001 : TEMPORARY Record 37);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnCheckAndUpdateOnBeforeCalcInvDiscount@176(VAR SalesHeader@1000 : Record 36;WarehouseReceiptHeader@1001 : Record 7316;WarehouseShipmentHeader@1002 : Record 7320;WhseReceive@1003 : Boolean;WhseShip@1004 : Boolean;VAR RefreshNeeded@1005 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnCheckTrackingAndWarehouseForShipOnBeforeCheck@248(VAR SalesHeader@1000 : Record 36;VAR TempWhseShipmentHeader@1001 : TEMPORARY Record 7320;VAR TempWhseReceiptHeader@1002 : TEMPORARY Record 7316;VAR Ship@1003 : Boolean;VAR TempSalesLine@1004 : TEMPORARY Record 37);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnCheckTrackingAndWarehouseForReceiveOnBeforeCheck@246(VAR SalesHeader@1000 : Record 36;VAR TempWhseShipmentHeader@1001 : TEMPORARY Record 7320;VAR TempWhseReceiptHeader@1002 : TEMPORARY Record 7316;VAR Receive@1003 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnFillInvoicePostingBufferOnAfterUpdateInvoicePostBuffer@300(SalesHeader@1000 : Record 36;SalesLine@1001 : Record 37;VAR InvoicePostBuffer@1002 : Record 49;VAR TempInvoicePostBuffer@1003 : TEMPORARY Record 49);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnFinalizePostingOnBeforeCreateOutboxSalesTrans@346(VAR SalesHeader@1000 : Record 36;VAR IsHandled@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnPostAssocItemJnlLineOnBeforePost@321(VAR ItemJournalLine@1000 : Record 83;PurchOrderLine@1001 : Record 39;VAR IsHandled@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnPostATOOnBeforePostedATOLinkInsert@340(VAR PostedATOLink@1000 : Record 914);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnPostBalancingEntryOnBeforeFindCustLedgEntry@308(SalesHeader@1000 : Record 36;SalesLine@1001 : Record 37;DocType@1004 : Option;DocNo@1003 : Code[20];ExtDocNo@1002 : Code[35];VAR CustLedgerEntry@1005 : Record 21;VAR EntryFound@1006 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnPostItemJnlLineOnAfterCopyDocumentFields@34(VAR ItemJournalLine@1000 : Record 83;SalesLine@1001 : Record 37;WarehouseReceiptHeader@1002 : Record 7316;WarehouseShipmentHeader@1003 : Record 7320);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnPostItemJnlLineOnBeforePostItemJnlLineWhseLine@348(VAR ItemJnlLine@1000 : Record 83;VAR TempWhseJnlLine@1001 : TEMPORARY Record 7311;VAR TempWhseTrackingSpecification@1008 : TEMPORARY Record 336;VAR TempTrackingSpecification@1139 : TEMPORARY Record 336;VAR IsHandled@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnPostItemJnlLineOnBeforeTransferReservToItemJnlLine@249(SalesLine@1000 : Record 37;ItemJnlLine@1001 : Record 83);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnPostItemChargeOnBeforePostItemJnlLine@490(VAR SalesLineToPost@1000 : Record 37;VAR SalesLine@1001 : Record 37;QtyToAssign@1002 : Decimal);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnPostItemChargePerOrderOnAfterCopyToItemJnlLine@266(VAR ItemJournalLine@1000 : Record 83;VAR SalesLine@1001 : Record 37;GeneralLedgerSetup@1002 : Record 98;QtyToInvoice@1003 : Decimal;VAR TempItemChargeAssignmentSales@1004 : TEMPORARY Record 5809);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnPostItemChargePerOrderOnBeforeTestJobNo@317(SalesLine@1000 : Record 37;VAR SkipTestJobNo@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnPostItemChargePerShptOnBeforeTestJobNo@318(SalesShipmentLine@1000 : Record 111;VAR SkipTestJobNo@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnPostItemChargePerRetRcptOnBeforeTestFieldJobNo@351(ReturnReceiptLine@1000 : Record 6661;VAR IsHandled@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnPostItemTrackingForReceiptOnAfterSetFilters@494(VAR ReturnReceiptLine@1000 : Record 6661;SalesHeader@1002 : Record 36;SalesLine@1001 : Record 37);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnPostSalesLineOnBeforeInsertCrMemoLine@285(SalesHeader@1002 : Record 36;SalesLine@1001 : Record 37;VAR IsHandled@1000 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnPostSalesLineOnBeforeInsertInvoiceLine@267(SalesHeader@1000 : Record 36;SalesLine@1001 : Record 37;VAR IsHandled@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnPostSalesLineOnBeforeInsertReturnReceiptLine@178(SalesHeader@1002 : Record 36;SalesLine@1000 : Record 37;VAR IsHandled@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnPostSalesLineOnBeforeInsertShipmentLine@352(SalesHeader@1002 : Record 36;SalesLine@1000 : Record 37;VAR IsHandled@1001 : Boolean;SalesLineACY@1003 : Record 37;DocType@1004 : Option;DocNo@1005 : Code[20];ExtDocNo@1006 : Code[35]);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnPostSalesLineOnAfterSetEverythingInvoiced@390(SalesLine@1000 : Record 37;VAR EverythingInvoiced@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnPostSalesLineOnBeforeTestJobNo@350(SalesLine@1000 : Record 37;VAR IsHandled@1001 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnPostSalesLineOnAfterPostItemTrackingLine@301(VAR SalesHeader@1000 : Record 36;VAR SalesLine@1001 : Record 37;WhseShip@1002 : Boolean;WhseReceive@1003 : Boolean;InvtPickPutaway@1004 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnPostSalesLineOnBeforePostItemTrackingLine@337(VAR SalesHeader@1000 : Record 36;VAR SalesLine@1001 : Record 37;WhseShip@1002 : Boolean;WhseReceive@1003 : Boolean;InvtPickPutaway@1004 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnRoundAmountOnBeforeIncrAmount@272(SalesHeader@1000 : Record 36;VAR SalesLine@1001 : Record 37;SalesLineQty@1002 : Decimal;VAR TotalSalesLine@1003 : Record 37;VAR TotalSalesLineLCY@1004 : Record 37);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnRunOnBeforeFinalizePosting@371(VAR SalesHeader@1000 : Record 36;VAR SalesShipmentHeader@1001 : Record 110;VAR SalesInvoiceHeader@1002 : Record 112;VAR SalesCrMemoHeader@1003 : Record 114;VAR ReturnReceiptHeader@1004 : Record 6660;VAR GenJnlPostLine@1005 : Codeunit 12;CommitIsSuppressed@1006 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnGetPostedDocumentRecordElseCase@325(SalesHeader@1000 : Record 36;VAR PostedSalesDocumentVariant@1001 : Variant;VAR IsHandled@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnPostItemTrackingForReceiptOnBeforeReturnRcptLineModify@341(SalesHeader@1000 : Record 36;VAR ReturnRcptLine@1008 : Record 6661);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnSendPostedDocumentRecordElseCase@324(SalesHeader@1000 : Record 36;VAR DocumentSendingProfile@1001 : Record 60;VAR IsHandled@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnUpdateAssocOrderOnAfterModifyPurchLine@330(VAR PurchOrderLine@1000 : Record 39;VAR TempDropShptPostBuffer@1001 : TEMPORARY Record 223);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnUpdateAssocOrderOnBeforeModifyPurchLine@329(VAR PurchOrderLine@1000 : Record 39;VAR TempDropShptPostBuffer@1001 : TEMPORARY Record 223);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnUpdateBlanketOrderLineOnBeforeCheck@310(VAR BlanketOrderSalesLine@1001 : Record 37;SalesLine@1000 : Record 37;VAR IsHandled@1002 : Boolean);
    BEGIN
    END;

    [Integration]
    LOCAL PROCEDURE OnUpdateBlanketOrderLineOnBeforeInitOutstanding@284(VAR BlanketOrderSalesLine@1000 : Record 37;SalesLine@1001 : Record 37);
    BEGIN
    END;

    LOCAL PROCEDURE PostJobServicePlant@1100525025(SalesHeader@1100525000 : Record 36;SalesLine@1100525002 : Record 37;InvoicePostBuffer@1100525008 : Record 49);
    VAR
      CustPostingGr@1100525001 : Record 92;
      JobJnlLine@1100525003 : Record 11072008;
      ServJnlLine@1100525009 : Record 11012820;
      ProjType@1100525007 : Record 11012009;
      DummyJobJnlLine@1100525011 : Record 11072008;
      DummyServJnlLine@1100525010 : Record 11012820;
      DimVal@1100525006 : Record 349;
      DimMgt@1100525004 : Codeunit 408;
      PostJobJnl@1100529400 : Boolean;
      PlantPosted@1100525005 : Boolean;
    BEGIN
      //**4PS
      JobLedgEntryNo := 0;
      ServLedgEntryNo := 0;
      AccountNoServEntry := '';
      WITH SalesHeader DO BEGIN
        IF ((NOT "Plant Invoice") AND (NOT SalesLine.IsPlantService))
           OR ChargePlantToOwnProj(SalesHeader)
           OR ChargeJobOrderToOwnPlant(SalesHeader)
           OR ChargeSOToJobPlantLoc(SalesHeader)
        THEN
          PostJobJnl := TRUE;
        IF (SalesLine.ReleaseRetention AND (SalesLine."Line Discount Amount" + SalesLine."Inv. Discount Amount" = 0)) THEN
          PostJobJnl := FALSE;

        IF PostJobJnl THEN BEGIN

          IF (SalesLine."Job No." <> '') AND (SalesLine."Qty. to Invoice" <> 0) THEN BEGIN
            // Post job entry
            JobJnlLine.INIT;
            JobJnlLine."Posting Date" := "Posting Date";
            JobJnlLine."Document Date" := "Document Date";
            JobJnlLine."Country/Region Code" := "VAT Country/Region Code";
            JobJnlLine."Reason Code" := "Reason Code";
            JobJnlLine."Job No." := SalesLine."Job No.";
            JobJnlLine."No." := SalesLine."No.";
            JobJnlLine."Variant Code" := SalesLine."Variant Code";
            Project.GET(SalesLine."Job No.");
            IF Project."Posting Element Mandatory" THEN
              SalesLine.TESTFIELD(Element);
            SalesLine.TESTFIELD("Shortcut Dimension 2 Code");
            IF ChargePlantToOwnProj(SalesHeader) OR ChargeJobOrderToOwnPlant(SalesHeader) OR ChargeSOToJobPlantLoc(SalesHeader) THEN BEGIN
              JobSetUp.GET;
              DimMgt.GetDimValueRec(2,SalesLine."Shortcut Dimension 2 Code",DimVal,TRUE,SalesLine."Job No.");
              JobJnlLine."No." := ProjType.GetWipAcc(Project."Project Type",
                                                     DimVal."Cost Type",
                                                     Project."Project Status",
                                                     JobSetUp."Provisions at Closure",
                                                     COMPANYNAME,
                                                     DimVal."Cost Type",'',
                                                     SalesHeader."Sell-to Customer No.");
              IF ChargeSOToJobPlantLoc(SalesHeader) THEN BEGIN
                AccountNoServEntry := JobJnlLine."No.";
                JobJnlLine."No." := SalesLine."No.";
              END;
            END;
            JobJnlLine.Element := SalesLine.Element;
            JobJnlLine."Extension Contract" := SalesLine."Extension Contract";
            JobJnlLine."Employee No." := SalesLine."Employee No.";
            JobJnlLine.Description := SalesLine.Description;
            JobJnlLine."Description 2" := SalesLine."Description 2";
            JobJnlLine."Unit of Measure Code" := SalesLine."Unit of Measure Code";
            JobJnlLine."Location Code" := SalesLine."Location Code";
            JobJnlLine."Posting Group" := SalesLine."Posting Group";
            JobJnlLine."Dimension Set ID" := SalesLine."Dimension Set ID";
            IF (NOT "Plant Invoice") OR ChargeSOToJobPlantLoc(SalesHeader) THEN BEGIN
              JobJnlLine."Shortcut Dimension 1 Code" := SalesLine."Shortcut Dimension 1 Code";
              DimMgt.ValidateShortcutDimValues(1,JobJnlLine."Shortcut Dimension 1 Code",JobJnlLine."Dimension Set ID");
            END;
            JobJnlLine."Shortcut Dimension 2 Code" := SalesLine."Shortcut Dimension 2 Code";
            IF (SalesLine."Cost Object Cost Plus Line" <> '') AND ChargeSOToJobPlantLoc(SalesHeader) THEN BEGIN
              JobJnlLine."Shortcut Dimension 2 Code" := SalesLine."Cost Object Cost Plus Line";
              DimMgt.ValidateShortcutDimValues(2,JobJnlLine."Shortcut Dimension 2 Code",JobJnlLine."Dimension Set ID");
            END;
            JobJnlLine."Work Type Code" := SalesLine."Work Type Code";
            JobJnlLine."Gen. Bus. Posting Group" := SalesLine."Gen. Bus. Posting Group";
            JobJnlLine."Gen. Prod. Posting Group" := SalesLine."Gen. Prod. Posting Group";
            JobJnlLine."Transaction Type" := SalesLine."Transaction Type";
            JobJnlLine."Transport Method" := SalesLine."Transport Method";
            JobJnlLine."Entry/Exit Point" := SalesLine."Exit Point";
            JobJnlLine.Area := SalesLine.Area;
            JobJnlLine."Transaction Specification" := SalesLine."Transaction Specification";
            JobJnlLine."Document No." := GenJnlLineDocNo;
            JobJnlLine."Document Line No." := SalesLine."Line No.";
            JobJnlLine."External Document No." := GenJnlLineExtDocNo;
            JobJnlLine.Type := 3 - SalesLine.Type;

            IF "Plant Invoice" THEN BEGIN
              PlantSetup.GET;
              JobJnlLine."Entry Type" := JobJnlLine."Entry Type"::Usage;
              IF SalesLine."Number of Time Units" = 0 THEN BEGIN
                JobJnlLine.Quantity := ROUND(SalesLine."Qty. to Invoice");
                JobJnlLine."Quantity (Base)" := ROUND(SalesLine."Qty. to Invoice (Base)");
              END ELSE BEGIN
                JobJnlLine.Quantity := ROUND(SalesLine."Qty. to Invoice" * SalesLine."Number of Time Units");
                JobJnlLine."Quantity (Base)" := ROUND(SalesLine."Qty. to Invoice (Base)" * SalesLine."Number of Time Units");
              END;
              JobJnlLine.Quantity := -JobJnlLine.Quantity;
              JobJnlLine."Total Cost (LCY)" := -SalesLine."Amount (LCY)";
              JobJnlLine.Quantity := ABS(JobJnlLine.Quantity);
              IF JobJnlLine."Total Cost (LCY)" < 0 THEN
                JobJnlLine.Quantity := -JobJnlLine.Quantity;
              JobJnlLine."Rental Period" := SalesLine."Rental Period";
              IF PlantSetup."Invoice Hours by Day" THEN
                JobJnlLine."Execution Date" := SalesLine."Shipment Date";
            END ELSE BEGIN
              JobJnlLine."Entry Type" := JobJnlLine."Entry Type"::Sale;
              JobJnlLine.Quantity := -SalesLine."Qty. to Invoice";
              JobJnlLine."Quantity (Base)" := -SalesLine."Qty. to Invoice (Base)";
              IF SalesLine."Currency Code" <> '' THEN BEGIN
                JobJnlLine."Total Price (LCY)" := -SalesLine."Amount (LCY)" - InvoicePostBuffer."Retention Amount";
                JobJnlLine."Total Price" := -SalesLineACY.Amount - InvoicePostBuffer."Retention Amount (ACY)";
              END ELSE BEGIN
                JobJnlLine."Total Price (LCY)" := -SalesLine.Amount - InvoicePostBuffer."Retention Amount";
              END;
              //
              DimMgt.GetDimValueRec(2,SalesLine."Shortcut Dimension 2 Code",DimVal,FALSE,'');
              IF DimVal."Cost Type" <> DimVal."Cost Type"::Revenue THEN BEGIN
                JobSetUp.GET;
                IF JobSetUp."Fill Allowed Cost" = JobSetUp."Fill Allowed Cost"::"No restriction" THEN BEGIN
                  JobJnlLine."Entry Type" := JobJnlLine."Entry Type"::Usage;
                  JobJnlLine."Total Cost (LCY)" := - JobJnlLine."Total Price (LCY)";
                  JobJnlLine."Total Cost" := - JobJnlLine."Total Price";
                  JobJnlLine.Quantity := ABS(JobJnlLine.Quantity);
                  IF JobJnlLine."Total Cost (LCY)" < 0 THEN
                    JobJnlLine.Quantity := -JobJnlLine.Quantity;
                  JobJnlLine."Total Price (LCY)" := 0;
                  JobJnlLine."Total Price" := 0;
                END;
              END;
              //
            END;

            JobJnlLine."Source Code" := SrcCode;
            JobJnlLine."Posting No. Series" := "Posting No. Series";
            JobJnlLine."Source Currency Code" := "Currency Code";
            JobJnlLine."Qty. per Unit of Measure" := SalesLine."Qty. per Unit of Measure";
            JobJnlLine."Plant Invoice" := SalesLine."Plant Invoice";
            IF "Plant Invoice" AND NOT ChargeSOToJobPlantLoc(SalesHeader) THEN
              JobJnlLine."Source Currency Total Cost" := -SalesLineACY."Amount (LCY)"
            ELSE
              JobJnlLine."Source Currency Total Price" := -SalesLineACY.Amount;

            JobJnlLine."Project Invoice" := SalesLine."Project Invoice";
            JobJnlLine."Installment Invoice" := SalesLine."Installment Invoice";
            JobJnlLine.Principal := SalesLine."Sell-to Customer No.";
            JobJnlLine."Installment No." := SalesLine."Installment No.";
            JobJnlLine."Installment Motivation" := SalesLine."Installment Motivation";
            JobJnlLine."Plot No." := SalesLine."Plot No.";
            JobJnlLine."Failure No." := SalesLine."Failure No.";
            JobJnlLine."Commision No." := SalesLine."Commission No.";
            JobJnlLine."Settl.Sheet No." := SalesLine."Settl.Sheet No.";
            JobJnlLine."Cost Plus Line No." := SalesLine."Cost Plus Line No.";
            IF SalesHeader."Customer Posting Group" <> '' THEN
              CustPostingGr.GET(SalesHeader."Customer Posting Group")
            ELSE
              CustPostingGr.INIT;
            JobJnlLine."WIP Balance Account" := CustPostingGr."Receivables Account";
            JobJnlLine.Chargeable := FALSE;
            JobJnlLine."Service Order No." := SalesLine."Service Order No.";
            JobJnlLine."Service Contract No." := SalesLine."Service Contract No.";
            JobJnlLine."Service Location No." := SalesLine."Service Location No.";
            JobJnlLine."Item No." := SalesLine."Item No.";
            JobJnlLine."Basic Item" := SalesLine."Basic Item";
            JobJnlLine."Trade Item" := SalesLine."Trade Item";
            JobJnlLine."Vendor (Trade Item)" := SalesLine."Vendor (Trade Item)";
            JobJnlLine.Manufacturer := SalesLine.Manufacturer;
            JobJnlLine."Rental Unit" := SalesLine."Rental Unit";
            JobJnlLine."Rental Period" := SalesLine."Rental Period";
            JobJnlLine."Cost Entry No. Project Ledger":= SalesLine."Cost Entry No. Project Ledger";
            JobJnlLine."Cost Component" := SalesLine."Cost Component";
            JobJnlLine."Removal Contribution" := SalesLine."Removal Contribution";
            JobJnlLine."Country/Region of Origin/Dest." := SalesHeader."Country of Origin";
            JobJnlLine."Tariff No." := SalesLine."Tariff No.";
            JobJnlLine."Net Weight" := SalesLine."Net Weight";
            JobJnlLine."Original Cost Type" := JobJnlLine."Original Cost Type"::" ";
            IF SalesLine."Cost Object Cost Plus Line" <> '' THEN
              JobJnlLine."Original Cost Type" := SalesLine."Cost Type Cost Plus Line" + 1;
            JobJnlLine."Advance Payment" := SalesLine."Advance Payment";

            IF "Plant Invoice" AND NOT ChargeSOToJobPlantLoc(SalesHeader) THEN BEGIN
              //Plant dimensions are posted, now retrieve project dimensions
              //JobJnlLine.VALIDATE("Job No."); //this activates function CreateDim which fills tempdimbuffer2
              //* Note: Not anymore validate job, there Total Cost become zero, direct here CreateDim
              JobJnlLine.CreateDim(
                DATABASE::Job,JobJnlLine."Job No.",
                DimMgt.TypeToTableID2(JobJnlLine.Type),JobJnlLine."No.",
                DATABASE::"Service Order",JobJnlLine."Service Order No.",
                DATABASE::"Resource Group",JobJnlLine."Resource Group No.",
                DATABASE::Location,"Location Code");
              JobJnlLine."Shortcut Dimension 2 Code" := SalesLine."Shortcut Dimension 2 Code";
              DimMgt.ValidateShortcutDimValues(2,JobJnlLine."Shortcut Dimension 2 Code",JobJnlLine."Dimension Set ID");
            END;

            IF NOT CompressPlantEntries(SalesHeader,JobJnlLine,TRUE) THEN BEGIN
              JobJnlPostLine.RunWithCheck(JobJnlLine);
              JobLedgEntryNo := JobJnlPostLine.GetJobLedgEntryNo;
            END;

            IF ChargeSOToJobPlantLoc(SalesHeader) THEN  BEGIN
              JobJnlLine."Total Price (LCY)" := JobJnlLine."Total Cost (LCY)";
              JobJnlLine."Total Cost (LCY)" := 0;
              JobJnlLine."Shortcut Dimension 2 Code" := SalesLine."Shortcut Dimension 2 Code";
              DimMgt.ValidateShortcutDimValues(2,JobJnlLine."Shortcut Dimension 2 Code",JobJnlLine."Dimension Set ID");
            END;

            PostWipJobOrderPlant(SalesHeader,JobJnlLine);
            PostWipProjectPlant(SalesHeader,SalesLine,JobJnlLine);
            PostComplWipProjectPlant(SalesHeader,SalesLine,JobJnlLine);
            PostComplRevenueFixedPriceProj(SalesHeader,JobJnlLine);
            PostSurcharge(SalesHeader,SalesLine,JobJnlLine,DummyServJnlLine,0);
          END;
        END;

        PlantPosted := FALSE;
        IF ((SalesLine.IsPlantService) AND (SalesLine."Qty. to Invoice" <> 0))
           AND NOT (ChargeSOToCustomerPlantLoc(SalesHeader) OR ChargeSOToJobPlantLoc(SalesHeader)) THEN BEGIN
          ServiceOrder.GET("Service Order No.");
          IF ServiceOrder.IsPlantServiceOrder THEN BEGIN
            ServiceOrder.TESTFIELD("Plant Type");
            ServiceOrder.TESTFIELD("Cost Component Plant");
            PlantSetup.GET;
            IF (ServiceOrder."Cost Component Plant" = PlantSetup."Cost Component Acquisition") OR
               (ServiceOrder."Cost Component Plant" = PlantSetup."Cost Component Rent")
            THEN
              ServiceOrder.FIELDERROR("Cost Component Plant");
            IF ChargeSOToCustomerPlantLoc(SalesHeader) OR ChargeSOToPlantItem(SalesHeader) THEN BEGIN
              ServJnlLine.INIT;
              ServJnlLine."Shortcut Dimension 1 Code" := SalesLine."Shortcut Dimension 1 Code";
              ServJnlLine."Shortcut Dimension 2 Code" := SalesLine."Shortcut Dimension 2 Code";
              ServJnlLine.VALIDATE("Service Order No.", SalesLine."Service Order No.");
              ServJnlLine."Dimension Set ID" := SalesLine."Dimension Set ID";
              ServJnlLine.VALIDATE("Total Cost (LCY)", -SalesLine.Amount);
              PostWipServicePlant(SalesHeader,SalesLine,ServJnlLine);
            END;
            PostPlant(SalesHeader,SalesLine,TRUE,FALSE);
            PlantPosted := TRUE;
          END;
        END ELSE BEGIN
          IF ("Project Invoice") AND (SalesLine."Job No." <> '') THEN BEGIN
            Project.GET(SalesLine."Job No.");
            IF Project."Small Project" AND (Project."Plant Job Order") THEN BEGIN
              Project.TESTFIELD("Plant Type");
              Project.TESTFIELD("Cost Component Plant");
              PlantSetup.GET;
              IF (Project."Cost Component Plant" = PlantSetup."Cost Component Acquisition") OR
                 (Project."Cost Component Plant" = PlantSetup."Cost Component Rent")
              THEN
                Project.FIELDERROR("Cost Component Plant");
              PostPlant(SalesHeader,SalesLine,TRUE,FALSE);
              PlantPosted := TRUE;
            END;
          END;
        END;

        IF "Plant Invoice" AND (NOT PlantTransportInternalCust) AND
           (SalesLine."Job No." = '') AND (SalesLine."Plant Location" = '') AND
           (SalesLine."Plant Invoice Origin" = SalesLine."Plant Invoice Origin"::"Transport Order") AND
           (SalesLine."Relate to" IN [SalesLine."Relate to"::Transport, SalesLine."Relate to"::"Load/Unload"])
        THEN BEGIN
          PlantTransportInternalCust := TRUE;
          PlantSetup.GET;
          PlantSetup.TESTFIELD("Internal Bal. Account Cost");
        END;

        IF "Plant Invoice" AND (SalesLine.Type = SalesLine.Type::"G/L Account") AND (NOT SalesLine.IsPlantService) THEN BEGIN
          PostPlant(SalesHeader,SalesLine,FALSE,FALSE);
          PostInternalChargePlantOnLoc(SalesHeader,SalesLine);
        END;
        IF SalesLine.ResourceRequestInvoice AND (SalesLine.Type = SalesLine.Type::"G/L Account") AND (SalesLine."Plant Type" <> '') THEN
          PostPlant(SalesHeader,SalesLine,FALSE,FALSE);
        IF ((SalesLine."Service Order No." <> '') OR
            (SalesLine."Service Contract No." <> '')) AND
            (SalesLine."Qty. to Invoice" <> 0)
        THEN BEGIN
          IF ((NOT "Plant Invoice") OR ChargePlantToOwnServOrder(SalesHeader) OR ChargeSOToCustomerPlantLoc(SalesHeader)) THEN BEGIN
            PostService(SalesHeader,SalesLine,ServJnlLine);
            PostWipServicePlant(SalesHeader,SalesLine,ServJnlLine);
            PostComplWipServicePlant(SalesHeader,SalesLine,ServJnlLine);
            IF SalesLine."PB Install. Collect. Over. No." = '' THEN BEGIN
              PostComplRevenueFixedPriceServ(SalesHeader,SalesLine,ServJnlLine);
              PostSurcharge(SalesHeader,SalesLine,DummyJobJnlLine,ServJnlLine,1);
            END;
          END;
        END;

        IF "Rental Unit Invoice" OR ResourceRequestInvoice OR
           ("Sales Document Type" IN ["Sales Document Type"::"Sales Logistics Separated","Sales Document Type"::RentalContract])
        THEN
          UpdateInvoiceNosSource(SalesHeader,SalesLine,TRUE,GenJnlLineDocNo);
      END;
    END;

    LOCAL PROCEDURE ChargeJobOrderToPlant@1100485021(SalesHeader@1100525000 : Record 36) : Boolean;
    BEGIN
      //**4PS
      IF SalesHeader."Job No." <> '' THEN
        IF SalesHeader."Project Invoice" THEN
          IF Project.GET(SalesHeader."Job No.") THEN
            IF (Project."Small Project" AND Project."Plant Job Order") THEN
              EXIT(TRUE);

      EXIT(FALSE);
    END;

    LOCAL PROCEDURE ChargeJobOrderToOwnPlant@1100485022(SalesHeader@1100525000 : Record 36) : Boolean;
    BEGIN
      //**4PS
      EXIT(ChargeJobOrderToPlant(SalesHeader) AND ((SalesHeader."Company Name" = '') OR (SalesHeader."Company Name" = COMPANYNAME)));
    END;

    LOCAL PROCEDURE ChargePlantToProject@5817(SalesHeader@1100525000 : Record 36) : Boolean;
    BEGIN
      //**4PS
      EXIT(SalesHeader."Plant Invoice" AND (SalesHeader."Job No." <> ''));
    END;

    LOCAL PROCEDURE ChargePlantToOwnProj@5821(SalesHeader@1100525000 : Record 36) : Boolean;
    BEGIN
      //**4PS
      EXIT(ChargePlantToProject(SalesHeader) AND ((SalesHeader."Company Name" = '') OR (SalesHeader."Company Name" = COMPANYNAME)) AND
        NOT ChargeSOToPlantItem(SalesHeader)); //DP00195
    END;

    LOCAL PROCEDURE ChargePlantToServOrder@1100525009(SalesHeader@1100525000 : Record 36) : Boolean;
    BEGIN
      //**4PS
      EXIT(SalesHeader."Plant Invoice" AND (SalesHeader."Service Order No." <> '') AND NOT ChargeSOToCustomerPlantLoc(SalesHeader));//DP00195
    END;

    LOCAL PROCEDURE ChargePlantToOwnServOrder@1100525007(SalesHeader@1100525000 : Record 36) : Boolean;
    BEGIN
      //**4PS
      EXIT(ChargePlantToServOrder(SalesHeader) AND ((SalesHeader."Company Name" = '') OR (SalesHeader."Company Name" = COMPANYNAME)));
    END;

    LOCAL PROCEDURE ChargeSOToPlantItem@1100529900(SalesHeader@1100525000 : Record 36) : Boolean;
    VAR
      ServiceOrder@1100529900 : Record 11012823;
    BEGIN
      //**4PS DP00195
      IF SalesHeader."Service Order No." <> '' THEN
        IF ServiceOrder.GET(SalesHeader."Service Order No.") THEN
          IF ServiceOrder.IsPlantServiceOrder AND (NOT SalesHeader."Plant Invoice") AND (NOT SalesHeader."Service Invoice") THEN
            EXIT(TRUE);
      EXIT(FALSE);
    END;

    LOCAL PROCEDURE ChargeSOToJobPlantLoc@1100529901(SalesHeader@1100525000 : Record 36) : Boolean;
    VAR
      ServiceOrder@1100529900 : Record 11012823;
    BEGIN
      //**4PS DP00195
      IF SalesHeader."Service Order No." <> '' THEN
        IF SalesHeader."Plant Invoice" THEN
          IF SalesHeader."Job No." <> '' THEN
            IF ServiceOrder.GET(SalesHeader."Service Order No.") THEN
              IF ServiceOrder.IsPlantServiceOrder THEN
                IF PlantInvoiceIsCreateByService(SalesHeader) THEN  //C022679
                  EXIT(TRUE);
      EXIT(FALSE);
    END;

    LOCAL PROCEDURE ChargeSOToCustomerPlantLoc@1100529902(SalesHeader@1100525000 : Record 36) : Boolean;
    VAR
      ServiceOrder@1100529900 : Record 11012823;
    BEGIN
      //**4PS DP00195
      IF SalesHeader."Service Order No." <> '' THEN
        IF SalesHeader."Plant Invoice" THEN
          IF SalesHeader."Job No." = '' THEN
            IF ServiceOrder.GET(SalesHeader."Service Order No.") THEN
              IF ServiceOrder.IsPlantServiceOrder THEN
                IF PlantInvoiceIsCreateByService(SalesHeader) THEN  //C022679
                  EXIT(TRUE);
      EXIT(FALSE);
    END;

    LOCAL PROCEDURE InternalChargePlantOnLoc@1100529000(SalesHeader@1100525000 : Record 36;PlantLoc@1100529002 : Code[20]) : Boolean;
    VAR
      SalesLine@1100529000 : Record 37;
      PlantLocation@1100529001 : Record 11012554;
    BEGIN
      //**4PS DP00815
      IF SalesHeader."Plant Invoice" AND (SalesHeader."Sell-to Customer No." = '') AND
        (SalesHeader."Job No." = '') AND (SalesHeader."Service Order No." = '') AND
        ((SalesHeader."Company Name" = '') OR (SalesHeader."Company Name" = COMPANYNAME))
      THEN BEGIN
        IF PlantLoc = '' THEN BEGIN
          SalesLine.SETRANGE("Document Type", SalesHeader."Document Type");
          SalesLine.SETRANGE("Document No.", SalesHeader."No.");
          SalesLine.SETFILTER("Plant Location", '<>%1', '');
          IF SalesLine.FINDFIRST THEN
            PlantLoc := SalesLine."Plant Location";
        END;
        IF PlantLoc <> '' THEN BEGIN
          IF PlantLocation.GET(PlantLoc) THEN
            EXIT(PlantLocation."Plant Type" <> '');
        END;
      END;
      EXIT(FALSE);
    END;

    LOCAL PROCEDURE PlantInvoiceIsCreateByService@1100525014(SalesHeader@1100525001 : Record 36) : Boolean;
    VAR
      SalesLine2@1100525000 : Record 37;
    BEGIN
      //**4PS
      IF NOT SalesHeader."Plant Invoice" THEN
        EXIT(FALSE);
      SalesLine2.SETRANGE("Document Type", SalesHeader."Document Type");
      SalesLine2.SETRANGE("Document No.", SalesHeader."No.");
      SalesLine2.SETRANGE(IsPlantService, TRUE);
      EXIT(NOT SalesLine2.ISEMPTY);
    END;

    LOCAL PROCEDURE CompressPlantEntries@5819(SalesHeader@1100525000 : Record 36;IJobJnlLineRec@1100485000 : Record 11072008;IPostMode@1100485001 : Boolean) : Boolean;
    VAR
      CompanyData@1100525001 : Record 11020674;
      LineNo@11012000 : Integer;
    BEGIN
      //**4PS
      //* If 'PostMode' then add record to tmp-table, otherwise only check if compress is applicable.
      //* Necessary because this function is called twice at surcharges, with the result that
      //* double job entries of surcharges were in tmp-table.

      IF NOT ChargePlantToOwnProj(SalesHeader) THEN
        EXIT(FALSE);

      IF CompanyData.GET(COMPANYNAME) THEN;
      IF NOT CompanyData."Compr. Proj.Ledg. Plant Entr." THEN
        EXIT(FALSE);

      IF IPostMode THEN BEGIN
        TempJobJnlLine.SETRANGE("No.",IJobJnlLineRec."No.");
        TempJobJnlLine.SETRANGE("Posting Group",IJobJnlLineRec."Posting Group");
        TempJobJnlLine.SETRANGE("Gen. Prod. Posting Group",IJobJnlLineRec."Gen. Prod. Posting Group");
        TempJobJnlLine.SETRANGE("Gen. Bus. Posting Group",IJobJnlLineRec."Gen. Bus. Posting Group");
        TempJobJnlLine.SETRANGE("Dimension Set ID",IJobJnlLineRec."Dimension Set ID");
        IF TempJobJnlLine.FIND('-') THEN BEGIN
          TempJobJnlLine."Total Cost (LCY)" += IJobJnlLineRec."Total Cost (LCY)";
          TempJobJnlLine."Source Currency Total Cost" += IJobJnlLineRec."Source Currency Total Cost";
          TempJobJnlLine.MODIFY;
        END ELSE BEGIN
          TempJobJnlLine.RESET;
          IF TempJobJnlLine.FIND('+') THEN
            LineNo := TempJobJnlLine."Line No." + 1
          ELSE
            LineNo := 1;
          TempJobJnlLine.TRANSFERFIELDS(IJobJnlLineRec);
          TempJobJnlLine."Line No." := LineNo;
          TempJobJnlLine.Description := STRSUBSTNO(Text11012001,
            SalesHeader.FIELDCAPTION("Rental Period to Date"), SalesHeader."Rental Period to Date");
          TempJobJnlLine.Quantity := 0;
          TempJobJnlLine."Unit of Measure Code" := '';
          TempJobJnlLine.INSERT;
        END;
      END;

      EXIT(TRUE);
    END;

    LOCAL PROCEDURE PostWipJobOrderPlant@1100485023(SalesHeader@1100525000 : Record 36;JobJnlLine@1100525002 : Record 11072008);
    VAR
      GLAcc@1100525001 : Record 15;
      ProjectType@1100525005 : Record 11012009;
      DimVal@1100525004 : Record 349;
      DimMgt@1100525003 : Codeunit 408;
    BEGIN
      //**4PS
      IF NOT (ChargeJobOrderToOwnPlant(SalesHeader) OR ChargeSOToJobPlantLoc(SalesHeader)) OR (JobJnlLine."Total Price (LCY)" = 0) THEN //DP00195
        EXIT;

      //Name 'Surcharge' is 'WIP'

      DimMgt.GetDimValueRec(2,JobJnlLine."Shortcut Dimension 2 Code",DimVal,TRUE,JobJnlLine."Job No.");
      JobSetUp.GET;
      Project.GET(JobJnlLine."Job No.");

      CLEAR(TempSurchargePostingBuffer[1]);
      TempSurchargePostingBuffer[1]."Origin Type" := TempSurchargePostingBuffer[1]."Origin Type"::Project;
      TempSurchargePostingBuffer[1]."G/L Account" := ProjectType.GetWipAcc(Project."Project Type",
                                                                           DimVal."Cost Type",
                                                                           Project."Project Status",
                                                                           JobSetUp."Provisions at Closure",
                                                                           COMPANYNAME,
                                                                           DimVal."Cost Type",'',
                                                                           SalesHeader."Sell-to Customer No.");
      TempSurchargePostingBuffer[1]."Global Dimension 1 Code" := JobJnlLine."Shortcut Dimension 1 Code";
      TempSurchargePostingBuffer[1]."Global Dimension 2 Code" := JobJnlLine."Shortcut Dimension 2 Code";
      TempSurchargePostingBuffer[1]."Dimension Set ID" := JobJnlLine."Dimension Set ID";
      IF NOT ChargeSOToJobPlantLoc(SalesHeader) THEN
        TempSurchargePostingBuffer[1]."Job No." := JobJnlLine."Job No.";
      TempSurchargePostingBuffer[1].Element := JobJnlLine.Element;
      TempSurchargePostingBuffer[1]."Bal. Account No." := TempSurchargePostingBuffer[1].Element; // Because element not in key
      TempSurchargePostingBuffer[1]."Service Order No." := JobJnlLine."Service Order No.";
      TempSurchargePostingBuffer[1]."Service Contract No." := JobJnlLine."Service Contract No.";
      GLAcc.GET(TempSurchargePostingBuffer[1]."G/L Account");
      TempSurchargePostingBuffer[1].Description := GLAcc.Name;
      TempSurchargePostingBuffer[1].Amount := -JobJnlLine."Total Price (LCY)";
      TempSurchargePostingBuffer[1]."Cost Component" := JobJnlLine."Cost Component";  //** 03-06-2010 call 19568

      UpdateSurchargeBuffer;
    END;

    LOCAL PROCEDURE PostWipProjectPlant@1210190010(SalesHeader@1100525000 : Record 36;SalesLine@1100529600 : Record 37;JobJnlLine@1100525002 : Record 11072008);
    VAR
      GLAcc@1100525001 : Record 15;
      ProjectType@1100525005 : Record 11012009;
      DimVal@1100525004 : Record 349;
      DimMgt@1100525003 : Codeunit 408;
    BEGIN
      //**4PS
      IF NOT (ChargePlantToOwnProj(SalesHeader) OR ChargeSOToJobPlantLoc(SalesHeader)) OR (SalesLine."Amount Including VAT" = 0) THEN //DP00195
        EXIT;

      //Name 'Surcharge' is 'WIP'
      CLEAR(TempSurchargePostingBuffer[1]);
      DimMgt.GetDimValueRec(2,JobJnlLine."Shortcut Dimension 2 Code",DimVal,TRUE,JobJnlLine."Job No.");
      JobSetUp.GET;
      Project.GET(JobJnlLine."Job No.");
      TempSurchargePostingBuffer[1]."G/L Account" := ProjectType.GetWipAcc(Project."Project Type",
                                                                           DimVal."Cost Type",
                                                                           Project."Project Status",
                                                                           JobSetUp."Provisions at Closure",
                                                                           COMPANYNAME,
                                                                           DimVal."Cost Type",'',
                                                                           SalesHeader."Sell-to Customer No.");
      TempSurchargePostingBuffer[1]."Global Dimension 1 Code" := JobJnlLine."Shortcut Dimension 1 Code";
      TempSurchargePostingBuffer[1]."Global Dimension 2 Code" := JobJnlLine."Shortcut Dimension 2 Code";
      TempSurchargePostingBuffer[1]."Dimension Set ID" := JobJnlLine."Dimension Set ID";
      TempSurchargePostingBuffer[1]."Job No." := JobJnlLine."Job No.";
      TempSurchargePostingBuffer[1].Element := JobJnlLine.Element;
      TempSurchargePostingBuffer[1]."Bal. Account No." := TempSurchargePostingBuffer[1].Element; // because element not in key
      TempSurchargePostingBuffer[1]."Service Order No." := JobJnlLine."Service Order No.";
      TempSurchargePostingBuffer[1]."Service Contract No." := JobJnlLine."Service Contract No.";
      GLAcc.GET(TempSurchargePostingBuffer[1]."G/L Account");
      TempSurchargePostingBuffer[1].Description := GLAcc.Name;
      TempSurchargePostingBuffer[1].Amount := -SalesLine."Amount Including VAT";
      TempSurchargePostingBuffer[1]."Cost Component" := JobJnlLine."Cost Component";  //** 03-06-2010 call 19568

      TempSurchargePostingBuffer[1]."Origin Type" := TempSurchargePostingBuffer[1]."Origin Type"::Project;

      UpdateSurchargeBuffer;
    END;

    LOCAL PROCEDURE PostWipServicePlant@1100525010(SalesHeader@1100525000 : Record 36;SalesLine@1100525005 : Record 37;ServJnlLine@1100525002 : Record 11012820);
    VAR
      GLAcc@1100525001 : Record 15;
      ServiceType@1100525006 : Record 11012814;
      DimVal@1100525004 : Record 349;
      DimMgt@1100525003 : Codeunit 408;
    BEGIN
      //**4PS
      IF NOT (ChargePlantToOwnServOrder(SalesHeader) OR ChargeSOToPlantItem(SalesHeader)) OR (SalesLine."Amount Including VAT" = 0) THEN //DP00195
        EXIT;

      //Name 'Surcharge' is 'WIP'
      CLEAR(TempSurchargePostingBuffer[1]);
      DimMgt.GetDimValueRec(2,ServJnlLine."Shortcut Dimension 2 Code",DimVal,TRUE,'');
      ServiceOrder.GET(ServJnlLine."Service Order No.");
      IF SalesLine."Additional Cost (Service)" THEN
        ServiceType.Code := ServiceOrder."Service Type (Other)"
      ELSE
        ServiceType.Code := ServiceOrder."Service Type";
      ServiceType.GET(ServiceType.Code);
      TempSurchargePostingBuffer[1]."G/L Account" := ServiceType.GetWipAcc(ServiceType.Code,
                                                                       DimVal."Cost Type",
                                                                       COMPANYNAME,
                                                                       DimVal."Cost Type",
                                                                       '',
                                                                       SalesHeader."Sell-to Customer No.");
      TempSurchargePostingBuffer[1]."Global Dimension 1 Code" := ServJnlLine."Shortcut Dimension 1 Code";
      TempSurchargePostingBuffer[1]."Global Dimension 2 Code" := ServJnlLine."Shortcut Dimension 2 Code";
      TempSurchargePostingBuffer[1]."Dimension Set ID" := ServJnlLine."Dimension Set ID";
      TempSurchargePostingBuffer[1]."Job No." := ServJnlLine."Project No.";
      TempSurchargePostingBuffer[1]."Service Order No." := ServJnlLine."Service Order No.";
      TempSurchargePostingBuffer[1]."Service Contract No." := ServJnlLine."Service Contract No.";
      GLAcc.GET(TempSurchargePostingBuffer[1]."G/L Account");
      TempSurchargePostingBuffer[1].Description := GLAcc.Name;
      //DP00195 sn.
      IF ChargeSOToPlantItem(SalesHeader) OR ChargeSOToCustomerPlantLoc(SalesHeader)  THEN
        TempSurchargePostingBuffer[1].Amount := SalesLine."Amount Including VAT"
      ELSE //DP00195 en.
        TempSurchargePostingBuffer[1].Amount := -SalesLine."Amount Including VAT";

      TempSurchargePostingBuffer[1]."Origin Type" := TempSurchargePostingBuffer[1]."Origin Type"::Service;

      UpdateSurchargeBuffer;
    END;

    LOCAL PROCEDURE PostInternalChargePlantOnLoc@1100529001(SalesHeader@1100525001 : Record 36;SalesLine@1100525000 : Record 37);
    VAR
      PlantLocation@1100529001 : Record 11012554;
      PlantType@1100529003 : Record 11012551;
      PlantNumber@1100529005 : Record 11012552;
      PlantCostCompPostingSetup@1100529004 : Record 11012570;
      SalesLine2@1100529002 : Record 37;
      GLAcc@1100525002 : Record 15;
      ExternalPlant@1100529006 : Boolean;
    BEGIN
      //**4PS DP00815
      IF NOT InternalChargePlantOnLoc(SalesHeader,SalesLine."Plant Location") THEN
        EXIT;

      PlantSetup.GET;
      PlantSetup.TESTFIELD("Cost Component Internal Charge");
      PlantLocation.GET(SalesLine."Plant Location");
      PlantType.GET(PlantLocation."Plant Type");
      ExternalPlant := PlantType.External;
      IF PlantLocation."Plant No." <> '' THEN BEGIN
        PlantNumber.GET(PlantLocation."Plant Type", PlantLocation."Plant No.");
        ExternalPlant := PlantNumber.External;
      END;
      GetPlantCostCompPostingSetup(PlantType, PlantNumber, PlantCostCompPostingSetup, ExternalPlant);
      PlantCostCompPostingSetup.TESTFIELD("Plant Cost Account");

      SalesLine2 := SalesLine;
      SalesLine2."No." := PlantCostCompPostingSetup."Plant Cost Account";
      SalesLine2."Plant Type" := PlantLocation."Plant Type";
      SalesLine2."Plant No." := PlantLocation."Plant No.";
      SalesLine2."Qty. to Invoice" := -1; //Then in Plant Ledger the quantity will be 1
      SalesLine2."Number of Time Units" := 0;  //May not have influence on the occupation
      IF PlantLocation."Internal Charge Plant Entry as" = PlantLocation."Internal Charge Plant Entry as"::NegRevenue THEN
        PostPlant(SalesHeader,SalesLine2,FALSE,TRUE)
      ELSE
        PostPlant(SalesHeader,SalesLine2,TRUE,TRUE);

      //Note: Table(Rec) Name is 'Surcharge', here used for 'Internal Charge'
      CLEAR(TempSurchargePostingBuffer[1]);
      TempSurchargePostingBuffer[1]."G/L Account" := PlantCostCompPostingSetup."Plant Cost Account";
      TempSurchargePostingBuffer[1]."Global Dimension 1 Code" := SalesLine."Shortcut Dimension 1 Code";
      TempSurchargePostingBuffer[1]."Global Dimension 2 Code" := SalesLine."Shortcut Dimension 2 Code";
      TempSurchargePostingBuffer[1]."Dimension Set ID" := SalesLine."Dimension Set ID";
      GLAcc.GET(TempSurchargePostingBuffer[1]."G/L Account");
      TempSurchargePostingBuffer[1].Description := GLAcc.Name;
      TempSurchargePostingBuffer[1].Amount := -SalesLine.Amount;
      TempSurchargePostingBuffer[1]."Origin Type" := TempSurchargePostingBuffer[1]."Origin Type"::Plant;
      UpdateSurchargeBuffer;
    END;

    LOCAL PROCEDURE PostInvoiceProposal@5820(SalesHeader@1100525000 : Record 36);
    VAR
      SalesLine@1100525001 : Record 37;
      SalesHeaderExtension@1100528600 : Record 11071868;
      SalesHeader2@1100525002 : Record 36;
      SalesLine2@1100525003 : Record 37;
      TempClientFolderName@1100528400 : Text;
      FullPDFFileName@1100528401 : Text;
      DocumentDescription@1100528402 : Text[50];
      ServiceContract@1100527550 : Record 11012812;
      NoSeriesManagement@1100527551 : Codeunit 396;
      ServiceType@1100527552 : Record 11012814;
    BEGIN
      //**4PS
      SalesHeaderExtension.GetSalesHeadExtension(SalesHeader."Document Type", SalesHeader."No.");
      IF SalesHeaderExtension."Compress Dyn. Inv. Prop. Lines" THEN BEGIN
        TempClientFolderName := SalesHeader.CreateTempClientFolderForPDF;
        SalesHeader.SaveInvoiceProposalAsPDF(TempClientFolderName, DocumentDescription, FullPDFFileName);
      END;

      SalesLine.LOCKTABLE;
      SalesLine.RESET;
      SalesLine.SETRANGE("Document Type",SalesHeader."Document Type");
      SalesLine.SETRANGE("Document No.",SalesHeader."No.");
      IF NOT SalesLine.FINDFIRST THEN
        ERROR(NothingToPostErr);

      SalesHeader.CALCFIELDS("Amount Including VAT");
      SalesHeader2 := SalesHeader;
      IF SalesHeader."Amount Including VAT" < 0 THEN BEGIN
        SalesHeader2."Document Type" := SalesHeader2."Document Type"::"Credit Memo";
        SalesHeader2."Due Date" := 0D;
        SalesHeader2."Pmt. Discount Date" := 0D;
        SalesHeader2."Payment Discount %" := 0;
        SalesHeader2."Pmt. Discount Date 2" := 0D;
        SalesHeader2."Payment Discount % 2" := 0;
        SalesHeader2."Pmt. Discount Date 3" := 0D;
        SalesHeader2."Payment Discount % 3" := 0;
      END ELSE
        SalesHeader2."Document Type" := SalesHeader2."Document Type"::Invoice;

      SalesHeader2."No." := '';
      IF ServiceContract.GET(SalesHeader."Service Contract No.") THEN
        IF ServiceContract."Service Type" <> '' THEN
          IF ServiceType.GET(ServiceContract."Service Type") THEN
            IF ServiceType."Sales Invoice Nos." <> '' THEN
              NoSeriesManagement.InitSeries(ServiceType."Sales Invoice Nos.", '', SalesHeader."Posting Date", SalesHeader2."No.", SalesHeader2."No. Series");
      SalesHeader2.VALIDATE("No.");
      SalesHeader2.INSERT(TRUE);
      //Fields filled for 2nd time because they can be modified during insert
      SalesHeader2.VALIDATE("Location Code",SalesHeader."Location Code");
      SalesHeader2."Shortcut Dimension 1 Code" := SalesHeader."Shortcut Dimension 1 Code";
      SalesHeader2."Shortcut Dimension 2 Code" := SalesHeader."Shortcut Dimension 2 Code";
      SalesHeader2."Dimension Set ID" := SalesHeader."Dimension Set ID";
      SalesHeader2."Calculate B Amounts based on" := SalesHeader."Calculate B Amounts based on";
      IF SalesHeader."Document Date" <> 0D THEN
        SalesHeader2.VALIDATE("Document Date", SalesHeader."Document Date");
      SalesHeader2.MODIFY;

      IF SalesHeaderExtension."Compress Dyn. Inv. Prop. Lines" THEN BEGIN
        SalesHeader2.AddProposalPDFToInvoice(DocumentDescription, FullPDFFileName);
        SalesHeader2.DeleteTempClientFolderForPDF(TempClientFolderName);
      END;

      REPEAT
        SalesLine2 := SalesLine;
        SalesLine2."Document Type" := SalesHeader2."Document Type";
        SalesLine2."Document No." := SalesHeader2."No.";
        IF (SalesHeader2."Document Type" = SalesHeader2."Document Type"::"Credit Memo") AND
           (SalesLine2.Type <> SalesLine2.Type::" ")
        THEN BEGIN
          IF SalesLine2."Number of Time Units" < 0 THEN BEGIN
            SalesLine2."Number of Time Units" := -SalesLine2."Number of Time Units";
            IF (SalesLine2."Line Amount" <> 0) OR ((SalesLine2."Line Discount %" <> 0) AND (SalesLine2."Unit Price" <> 0)) THEN  //C020103.c
              SalesLine2.VALIDATE("Line Amount", -SalesLine2."Line Amount");
          END ELSE BEGIN
            IF SalesLine2.Quantity < 0 THEN BEGIN
              IF (SalesLine2."Line Amount" <> 0) OR (SalesLine2."Line Discount %" <> 0) THEN  //C020103.c
                SalesLine2.VALIDATE(Quantity, -SalesLine2.Quantity)
              ELSE
                SalesLine2.Quantity := SalesLine2.Quantity;
            END ELSE BEGIN
              IF (SalesLine2."Unit Price" <> 0) THEN
                SalesLine2.VALIDATE("Unit Price", -SalesLine2."Unit Price");
            END;
          END;
          SalesLine2."Qty. to Ship" := 0;
          SalesLine2."Return Qty. to Receive" := SalesLine2.Quantity;
          SalesLine2."Return Qty. to Receive (Base)" := SalesLine2.Quantity;
        END;

        CopyExtDocRefPlantOrderToInvoice(SalesHeader2,SalesLine2);
        IF SalesHeaderExtension."Compress Dyn. Inv. Prop. Lines" THEN
          SalesLine2.AddToCompressedLines(SalesHeader)
        ELSE
          SalesLine2.INSERT;
        UpdateInvoiceNosSource(SalesHeader,SalesLine,FALSE,SalesHeader2."No.");
        SalesLine.DELETE;
      UNTIL SalesLine.NEXT = 0;

      SalesHeaderExtension.CopySalesHeadExtension(
        SalesHeader."Document Type", SalesHeader."No.", SalesHeader2."Document Type", SalesHeader2."No.");

      SalesHeaderExtension.SETRANGE("Document Type", SalesHeader."Document Type");
      SalesHeaderExtension.SETRANGE("Document No.", SalesHeader."No.");
      SalesHeaderExtension.DELETEALL;
      SalesHeader.DELETE;

      IF SalesHeaderExtension."Compress Dyn. Inv. Prop. Lines" THEN
        SalesHeader2.SendToPosting(CODEUNIT::"Sales-Post");

      COMMIT;

      IF SalesHeader."Plant Invoice" AND
         ((SalesHeader."Company Name" = '') OR (SalesHeader."Company Name" = COMPANYNAME))
      THEN BEGIN
        PlantSetup.GET;
        IF (PlantSetup."Direct post intern. plant inv." AND (SalesHeader."Sell-to Customer No." = '')) OR
           (PlantSetup."Direct post extern. plant inv." AND (SalesHeader."Sell-to Customer No." <> ''))
        THEN
          SalesHeader2.SendToPosting(CODEUNIT::"Sales-Post");
      END;
    END;

    LOCAL PROCEDURE UpdateInvoiceNosSource@5818(SalesHeader@1100525002 : Record 36;SalesLine@1100525003 : Record 37;Posted@11012000 : Boolean;NewInvNo@11012001 : Code[20]);
    VAR
      NewInvStatus@11012002 : ',Proposal,Temporary,Posted';
      OldInvStatus@11012003 : ',Proposal,Temporary,Posted';
      PlantInventoryRec@1100525004 : Record 11012555;
      PlantInventoryRec2@1100485000 : Record 11012555;
      PlantOrderRec@1100525005 : Record 11012556;
      PlantOrderRec2@1100485003 : Record 11012556;
      ExitOrderRec@1100525006 : Record 11012559;
      ExitOrderRec2@1100485002 : Record 11012559;
      ReturnLossOrderRec@1100525000 : Record 11012655;
      ReturnLossOrderRec2@1100525001 : Record 11012655;
      RentalCorrection@1100525007 : Record 11012565;
      RentalCorrection2@1100485001 : Record 11012565;
      PlantHourLineRec@1100525008 : Record 11012574;
      PlantHourLineRec2@1100485004 : Record 11012574;
      PostedPlantTransportOrder@1100485005 : Record 11020507;
      PostedPlantTransportOrder2@1100485006 : Record 11020507;
      PlantRentalAgrInvPeriod@1100529005 : Record 11229937;
      PlantRentalAgrInvPeriod2@1100529006 : Record 11229937;
      ExternalPlantRentInvoice@1100529009 : Record 11126149;
      ExtPlantRentInvoiceLine@1100529007 : Record 11126150;
      ExtPlantRentInvoiceLine2@1100529008 : Record 11126150;
      lvSalesRentalInvoiceLine@1100485007 : Record 11012788;
      lvSalesRentalInvoiceLine2@1100485008 : Record 11012788;
      SalesOrderHeader@1100485009 : Record 36;
      RentalPackage@1100529000 : Record 11012941;
      RentalPackage2@1100529002 : Record 11012941;
      RentalRateLine@1100529001 : Record 11012942;
      HistRentalPackage@1100529003 : Record 11229848;
      ResourceReqCollectiveList@1100529004 : Record 11124904;
      PlantLedgerEntry@1100529600 : Record 11012572;
      PlantLedgerEntry2@1100529601 : Record 11012572;
    BEGIN
      //**4PS
      IF Posted THEN BEGIN
        OldInvStatus := OldInvStatus::"Temporary";
        NewInvStatus := NewInvStatus::Posted;
      END ELSE BEGIN
        OldInvStatus := OldInvStatus::Proposal;
        NewInvStatus := NewInvStatus::"Temporary";
      END;

      WITH SalesHeader DO BEGIN
        IF "Plant Invoice" AND NOT ChargeSOToJobPlantLoc(SalesHeader) THEN BEGIN //DP00195
          CASE SalesLine."Plant Invoice Origin" OF
            SalesLine."Plant Invoice Origin"::"Plant Inventory":
              BEGIN
                PlantInventoryRec.RESET;
                PlantInventoryRec.SETCURRENTKEY("Invoice Status","Last Invoice No.","Last Invoice Line No.");
                PlantInventoryRec.SETRANGE("Last Invoice No.","No.");
                //PlantInventoryRec.SETRANGE("Last Invoice Line No.",SalesLine."Line No.");  //DP01614 Not a filter on Line No.!
                PlantInventoryRec.SETRANGE("Invoice Status",OldInvStatus);
                IF PlantInventoryRec.FINDSET(TRUE, TRUE) THEN
                  REPEAT
                    PlantInventoryRec2 := PlantInventoryRec;
                    PlantInventoryRec2."Last Invoice No." := NewInvNo;
                    PlantInventoryRec2."Invoice Status" := NewInvStatus;
                    PlantInventoryRec2.MODIFY;
                  UNTIL PlantInventoryRec.NEXT = 0;
              END;
            SalesLine."Plant Invoice Origin"::"Plant Order":
              BEGIN
                PlantOrderRec.RESET;
                PlantOrderRec.SETCURRENTKEY("From Location Invoice Status","From Location Invoice No.");
                PlantOrderRec.SETRANGE("From Location Invoice No.","No.");
                PlantOrderRec.SETRANGE("From Location Invoice Status",OldInvStatus);
                IF PlantOrderRec.FINDSET(TRUE, TRUE) THEN
                  REPEAT
                    PlantOrderRec2 := PlantOrderRec;
                    PlantOrderRec2."From Location Invoice No." := NewInvNo;
                    PlantOrderRec2."From Location Invoice Status" := NewInvStatus;
                    PlantOrderRec2.MODIFY;
                  UNTIL PlantOrderRec.NEXT = 0;

                PlantOrderRec.RESET;
                PlantOrderRec.SETCURRENTKEY("To Location Invoice Status","To Location Invoice No.");
                PlantOrderRec.SETRANGE("To Location Invoice No.","No.");
                PlantOrderRec.SETRANGE("To Location Invoice Status",OldInvStatus);
                IF PlantOrderRec.FINDSET(TRUE, TRUE) THEN
                  REPEAT
                    PlantOrderRec2 := PlantOrderRec;
                    PlantOrderRec2."To Location Invoice No." := NewInvNo;
                    PlantOrderRec2."To Location Invoice Status" := NewInvStatus;
                    PlantOrderRec2.MODIFY;
                  UNTIL PlantOrderRec.NEXT = 0;

                PlantOrderRec.RESET;
                PlantOrderRec.SETCURRENTKEY("Order Cost Invoice Status","Order Cost Invoice No.");
                PlantOrderRec.SETRANGE("Order Cost Invoice No.","No.");
                PlantOrderRec.SETRANGE("Order Cost Invoice Status",OldInvStatus);
                IF PlantOrderRec.FINDSET(TRUE, TRUE) THEN
                  REPEAT
                    PlantOrderRec2 := PlantOrderRec;
                    PlantOrderRec2."Order Cost Invoice No." := NewInvNo;
                    PlantOrderRec2."Order Cost Invoice Status" := NewInvStatus;
                    PlantOrderRec2.MODIFY;
                  UNTIL PlantOrderRec.NEXT = 0;

              END;
            SalesLine."Plant Invoice Origin"::"Exit Order":
              BEGIN
                ExitOrderRec.RESET;
                ExitOrderRec.SETCURRENTKEY("Invoice Status","Invoice No.");
                ExitOrderRec.SETRANGE("Invoice No.","No.");
                ExitOrderRec.SETRANGE("Invoice Status",OldInvStatus);
                IF ExitOrderRec.FINDSET(TRUE, TRUE) THEN
                  REPEAT
                    ExitOrderRec2 := ExitOrderRec;
                    ExitOrderRec2."Invoice No." := NewInvNo;
                    ExitOrderRec2."Invoice Status" := NewInvStatus;
                    ExitOrderRec2.MODIFY;
                  UNTIL ExitOrderRec.NEXT = 0;

              END;
            SalesLine."Plant Invoice Origin"::"Returned Loss":
              BEGIN
                ReturnLossOrderRec.RESET;
                ReturnLossOrderRec.SETCURRENTKEY("Invoice Status","Invoice No.");
                ReturnLossOrderRec.SETRANGE("Invoice No.","No.");
                ReturnLossOrderRec.SETRANGE("Invoice Status",OldInvStatus);
                IF ReturnLossOrderRec.FINDSET(TRUE,TRUE) THEN
                  REPEAT
                    ReturnLossOrderRec2 := ReturnLossOrderRec;
                    ReturnLossOrderRec2."Invoice No." := NewInvNo;
                    ReturnLossOrderRec2."Invoice Status" := NewInvStatus;
                    ReturnLossOrderRec2.MODIFY;
                  UNTIL ReturnLossOrderRec.NEXT = 0;

              END;
            SalesLine."Plant Invoice Origin"::"Rental Correction":
              BEGIN
                RentalCorrection.RESET;
                RentalCorrection.SETCURRENTKEY("Invoice Status Debit Location","Invoice No. Debit Location");
                RentalCorrection.SETRANGE("Invoice No. Debit Location","No.");
                RentalCorrection.SETRANGE("Invoice Status Debit Location",OldInvStatus);
                IF RentalCorrection.FINDSET(TRUE,TRUE) THEN
                  REPEAT
                    RentalCorrection2 := RentalCorrection;
                    RentalCorrection2."Invoice No. Debit Location" := NewInvNo;
                    RentalCorrection2."Invoice Status Debit Location" := NewInvStatus;
                    RentalCorrection2.MODIFY;
                  UNTIL RentalCorrection.NEXT = 0;

                RentalCorrection.RESET;
                RentalCorrection.SETCURRENTKEY("Invoice Status Credit Location","Invoice.No.Credit Location");
                RentalCorrection.SETRANGE("Invoice.No.Credit Location","No.");
                RentalCorrection.SETRANGE("Invoice Status Credit Location",OldInvStatus);
                IF RentalCorrection.FINDSET(TRUE,TRUE) THEN
                  REPEAT
                    RentalCorrection2 := RentalCorrection;
                    RentalCorrection2."Invoice.No.Credit Location" := NewInvNo;
                    RentalCorrection2."Invoice Status Credit Location" := NewInvStatus;
                    RentalCorrection2.MODIFY;
                  UNTIL RentalCorrection.NEXT = 0;
              END;
            SalesLine."Plant Invoice Origin"::"Plant Hours":
              BEGIN
                PlantHourLineRec.RESET;
                PlantHourLineRec.SETCURRENTKEY("Invoice Status","Invoice No.");
                PlantHourLineRec.SETRANGE("Invoice No.","No.");
                PlantHourLineRec.SETRANGE("Invoice Status",OldInvStatus);
                IF PlantHourLineRec.FINDSET(TRUE,TRUE) THEN
                  REPEAT
                    PlantHourLineRec2 := PlantHourLineRec;
                    PlantHourLineRec2."Invoice No." := NewInvNo;
                    PlantHourLineRec2."Invoice Status" := NewInvStatus;
                    PlantHourLineRec2.MODIFY;
                  UNTIL PlantHourLineRec.NEXT = 0;
              END;
            SalesLine."Plant Invoice Origin"::"Transport Order":
              BEGIN
                PostedPlantTransportOrder.RESET;
                PostedPlantTransportOrder.SETCURRENTKEY("From Location Invoice Status","From Location Invoice No.");
                PostedPlantTransportOrder.SETRANGE("From Location Invoice No.","No.");
                PostedPlantTransportOrder.SETRANGE("From Location Invoice Status",OldInvStatus);
                IF PostedPlantTransportOrder.FINDSET(TRUE,TRUE) THEN BEGIN
                  REPEAT
                    PostedPlantTransportOrder2 := PostedPlantTransportOrder;
                    PostedPlantTransportOrder2."From Location Invoice No." := NewInvNo;
                    PostedPlantTransportOrder2."From Location Invoice Status" := NewInvStatus;
                    PostedPlantTransportOrder2.FillStatusInvoiced(TRUE);
                    PostedPlantTransportOrder2.MODIFY;
                  UNTIL PostedPlantTransportOrder.NEXT = 0;
                END;
                PostedPlantTransportOrder.RESET;
                PostedPlantTransportOrder.SETCURRENTKEY("To Location Invoice Status","To Location Invoice No.");
                PostedPlantTransportOrder.SETRANGE("To Location Invoice No.","No.");
                PostedPlantTransportOrder.SETRANGE("To Location Invoice Status",OldInvStatus);
                IF PostedPlantTransportOrder.FINDSET(TRUE,TRUE) THEN BEGIN
                  REPEAT
                    PostedPlantTransportOrder2 := PostedPlantTransportOrder;
                    PostedPlantTransportOrder2."To Location Invoice No." := NewInvNo;
                    PostedPlantTransportOrder2."To Location Invoice Status" := NewInvStatus;
                    PostedPlantTransportOrder2.FillStatusInvoiced(TRUE);
                    PostedPlantTransportOrder2.MODIFY;
                  UNTIL PostedPlantTransportOrder.NEXT = 0;
                END;
                PostedPlantTransportOrder.RESET;
                PostedPlantTransportOrder.SETCURRENTKEY("Internal Invoice Status","Internal Invoice No.");
                PostedPlantTransportOrder.SETRANGE("Internal Invoice No.","No.");
                PostedPlantTransportOrder.SETRANGE("Internal Invoice Status",OldInvStatus);
                IF PostedPlantTransportOrder.FINDSET(TRUE,TRUE) THEN BEGIN
                  REPEAT
                    PostedPlantTransportOrder2 := PostedPlantTransportOrder;
                    PostedPlantTransportOrder2."Internal Invoice No." := NewInvNo;
                    PostedPlantTransportOrder2."Internal Invoice Status" := NewInvStatus;
                    PostedPlantTransportOrder2.FillStatusInvoiced(TRUE);
                    PostedPlantTransportOrder2.MODIFY;
                  UNTIL PostedPlantTransportOrder.NEXT = 0;
                END;
                PostedPlantTransportOrder.RESET;
                PostedPlantTransportOrder.SETCURRENTKEY("Project Invoice Status","Project Invoice No.");
                PostedPlantTransportOrder.SETRANGE("Project Invoice No.","No.");
                PostedPlantTransportOrder.SETRANGE("Project Invoice Status",OldInvStatus);
                IF PostedPlantTransportOrder.FINDSET(TRUE,TRUE) THEN BEGIN
                  REPEAT
                    PostedPlantTransportOrder2 := PostedPlantTransportOrder;
                    PostedPlantTransportOrder2."Project Invoice No." := NewInvNo;
                    PostedPlantTransportOrder2."Project Invoice Status" := NewInvStatus;
                    PostedPlantTransportOrder2.FillStatusInvoiced(TRUE);
                    PostedPlantTransportOrder2.MODIFY;
                  UNTIL PostedPlantTransportOrder.NEXT = 0;
                END;
              END;
            SalesLine."Plant Invoice Origin"::RentalAgreement :
              BEGIN
                PlantRentalAgrInvPeriod.RESET;
                PlantRentalAgrInvPeriod.SETCURRENTKEY("Invoice Status","Last Invoice No.");
                PlantRentalAgrInvPeriod.SETRANGE("Last Invoice No.","No.");
                PlantRentalAgrInvPeriod.SETRANGE("Invoice Status",OldInvStatus);
                IF PlantRentalAgrInvPeriod.FINDSET(TRUE, TRUE) THEN BEGIN
                  REPEAT
                    PlantRentalAgrInvPeriod2 := PlantRentalAgrInvPeriod;
                    PlantRentalAgrInvPeriod2."Last Invoice No." := NewInvNo;
                    PlantRentalAgrInvPeriod2."Invoice Status" := NewInvStatus;
                    PlantRentalAgrInvPeriod2.MODIFY;
                  UNTIL PlantRentalAgrInvPeriod.NEXT = 0;
                END;
              END;
            SalesLine."Plant Invoice Origin"::ExternalRentInvoice:
              BEGIN
                ExtPlantRentInvoiceLine.RESET;
                ExtPlantRentInvoiceLine.SETCURRENTKEY("Sales Invoice Status","Sales Invoice No.");
                ExtPlantRentInvoiceLine.SETRANGE("Sales Invoice No.","No.");
                ExtPlantRentInvoiceLine.SETRANGE("Sales Invoice Status",OldInvStatus);
                IF ExtPlantRentInvoiceLine.FINDSET(TRUE, TRUE) THEN BEGIN
                  REPEAT
                    ExtPlantRentInvoiceLine2 := ExtPlantRentInvoiceLine;
                    ExtPlantRentInvoiceLine2."Sales Invoice No." := NewInvNo;
                    ExtPlantRentInvoiceLine2."Sales Invoice Status" := NewInvStatus;
                    ExtPlantRentInvoiceLine2.MODIFY(FALSE);
                    IF NewInvStatus = NewInvStatus::Posted THEN
                      ExternalPlantRentInvoice.ExtPlantRentInvoiceCompletelyProcessed(ExtPlantRentInvoiceLine2."Vendor No.", ExtPlantRentInvoiceLine2."External Invoice No.");
                  UNTIL ExtPlantRentInvoiceLine.NEXT = 0;
                END;
              END;
            SalesLine."Plant Invoice Origin"::"Service Cost":
              BEGIN
                PlantLedgerEntry.SETCURRENTKEY("Invoice Status", "Invoice No.");
                PlantLedgerEntry.SETRANGE("Invoice No.", "No.");
                PlantLedgerEntry.SETRANGE("Invoice Status", OldInvStatus);
                IF PlantLedgerEntry.FINDSET(TRUE, TRUE) THEN
                  REPEAT
                    PlantLedgerEntry2 := PlantLedgerEntry;
                    PlantLedgerEntry2."Invoice No." := NewInvNo;
                    PlantLedgerEntry2."Invoice Status" := NewInvStatus;
                    PlantLedgerEntry2.MODIFY;
                  UNTIL PlantLedgerEntry.NEXT = 0;
              END;
          END;
        END;

        IF "Sales Document Type" = "Sales Document Type"::"Sales Logistics Separated" THEN BEGIN
          lvSalesRentalInvoiceLine.RESET;
          lvSalesRentalInvoiceLine.SETCURRENTKEY("Invoice Status","Last Invoice No.","Last Invoice Line No.");
          lvSalesRentalInvoiceLine.SETRANGE("Last Invoice No.","No.");
          lvSalesRentalInvoiceLine.SETRANGE("Last Invoice Line No.",SalesLine."Line No.");
          lvSalesRentalInvoiceLine.SETRANGE("Invoice Status",OldInvStatus);
          IF lvSalesRentalInvoiceLine.FINDSET(TRUE, TRUE) THEN
            REPEAT
              lvSalesRentalInvoiceLine2 := lvSalesRentalInvoiceLine;
              lvSalesRentalInvoiceLine2."Last Invoice No." := NewInvNo;
              lvSalesRentalInvoiceLine2."Invoice Status" := NewInvStatus;
              lvSalesRentalInvoiceLine2.MODIFY;
            UNTIL lvSalesRentalInvoiceLine.NEXT = 0;
        END;

        IF "Sales Document Type" = "Sales Document Type"::RentalContract THEN BEGIN
          IF ("Related Sales Order No." <> '') AND
             (SalesOrderHeader.GET("Document Type"::Order, "Related Sales Order No.")) AND
             (SalesOrderHeader."Rental Contract Invoice Status" = SalesOrderHeader."Rental Contract Invoice Status"::"Temporary")
          THEN BEGIN
            SalesOrderHeader."Rental Contract Invoice Status" := SalesOrderHeader."Rental Contract Invoice Status"::Invoiced;
            SalesOrderHeader.MODIFY;
          END;
        END;

        IF "Rental Unit Invoice" THEN BEGIN  //DP00617
          RentalPackage.SETCURRENTKEY("Invoice Status", "Last Invoice No.");
          RentalPackage.SETRANGE("Invoice Status", RentalPackage."Invoice Status"::"Temporary");
          RentalPackage.SETRANGE("Last Invoice No.", "No.");
          IF RentalPackage.FINDSET(TRUE, TRUE) THEN BEGIN
            REPEAT
              RentalPackage2 := RentalPackage;
              RentalPackage2."Last Invoice No." := NewInvNo;
              RentalPackage2."Invoice Status" := RentalPackage2."Invoice Status"::Posted;
              RentalPackage2.MODIFY;
              //
              RentalRateLine.SETRANGE("Project No.", RentalPackage."Project No.");
              RentalRateLine.SETRANGE("Rental Unit", RentalPackage."Rental Unit");
              RentalRateLine.SETRANGE("Starting Date Package", RentalPackage."Starting Date");
              RentalRateLine.SETRANGE("Last Invoice No.", "No.");
              RentalRateLine.SETRANGE("Invoice Status", RentalRateLine."Invoice Status"::"Temporary");
              IF RentalRateLine.FINDSET(TRUE, FALSE) THEN BEGIN
                REPEAT
                  RentalRateLine."Last Invoice No." := NewInvNo;
                  RentalRateLine."Invoice Status" := RentalRateLine."Invoice Status"::Posted;
                  RentalRateLine.MODIFY;
                UNTIL RentalRateLine.NEXT = 0;
              END;
              //
              HistRentalPackage.SETRANGE("Project No.", RentalPackage."Project No.");
              HistRentalPackage.SETRANGE("Rental Unit", RentalPackage."Rental Unit");
              HistRentalPackage.SETRANGE("Starting Date", RentalPackage."Starting Date");
              HistRentalPackage.SETRANGE("Invoice Status", HistRentalPackage."Invoice Status"::"Temporary");
              HistRentalPackage.SETRANGE("Invoice No.", "No.");
              IF HistRentalPackage.FINDSET(TRUE, FALSE) THEN BEGIN
                REPEAT
                  HistRentalPackage."Invoice No." := NewInvNo;
                  HistRentalPackage."Invoice Status" := HistRentalPackage."Invoice Status"::Posted;
                  HistRentalPackage.MODIFY;
                UNTIL HistRentalPackage.NEXT = 0;
              END;
            UNTIL RentalPackage.NEXT = 0;
          END;
        END;

        IF ResourceRequestInvoice THEN BEGIN
          ResourceReqCollectiveList.SETRANGE("No.", "Collective List No. (Res.Req.)");
          ResourceReqCollectiveList.SETRANGE("Invoice No.", "No.");
          ResourceReqCollectiveList.SETRANGE("Invoice Status", ResourceReqCollectiveList."Invoice Status"::"Temporary");
          IF ResourceReqCollectiveList.FINDFIRST THEN BEGIN
            ResourceReqCollectiveList."Invoice No." := NewInvNo;
            ResourceReqCollectiveList."Invoice Status" := ResourceReqCollectiveList."Invoice Status"::Posted;
            ResourceReqCollectiveList.MODIFY;
          END;
        END;
      END;
    END;

    LOCAL PROCEDURE UpdateSurchargeBuffer@5815();
    BEGIN
      //**4PS
      TempSurchargePostingBuffer[2] := TempSurchargePostingBuffer[1];
      IF TempSurchargePostingBuffer[2].FIND THEN BEGIN
        TempSurchargePostingBuffer[2].Amount :=
          TempSurchargePostingBuffer[2].Amount + TempSurchargePostingBuffer[1].Amount;
        TempSurchargePostingBuffer[2].MODIFY;
      END ELSE
        TempSurchargePostingBuffer[1].INSERT;
    END;

    LOCAL PROCEDURE PostSurcharge@1210190012(SalesHeader@1100525002 : Record 36;SalesLine@1100525001 : Record 37;JobJnlLine@1100525004 : Record 11072008;ServJnlLine@1100525003 : Record 11012820;Origin@1210190001 : 'Project,Service');
    VAR
      GenJnlLine@1100525005 : Record 81;
      PostingMgt@1100525000 : Codeunit 11012360;
    BEGIN
      //**4PS
      PostingMgt.SetPostingFromSalesLine(Origin,SalesLine,SalesHeader,JobJnlLine,ServJnlLine,GenJnlLine,GenJnlLineDocNo);
      PostingMgt.BufferSurcharges(
        Origin,GenJnlLine,JobJnlLine,ServJnlLine,JobJnlPostLine,ServJnlPostLine,TempSurchargePostingBuffer,TempComplWIPPostingBuffer);
    END;

    LOCAL PROCEDURE PostService@1210190001(SalesHeader@1100525004 : Record 36;SalesLine@1100525003 : Record 37;VAR ServJnlLine@1100525000 : Record 11012820);
    VAR
      ServiceContractCtrlPeriod@1100528603 : Record 11071746;
      ServiceContractCtrlPeriod2@1100528611 : Record 11071746;
      Currency@1100528612 : Record 4;
      ServiceType@1100525002 : Record 11012814;
      DimVal@1100525006 : Record 349;
      OriginalServiceJournalLine@1100528614 : Record 11012820;
      ServiceContract@1100529601 : Record 11012812;
      DimMgt@1100525005 : Codeunit 408;
      MaintenanceSalesAndCostMgt@1100529600 : Codeunit 11012827;
      OriginalTotalRevenue@1100528600 : Decimal;
      NewRevenue@1100528601 : Decimal;
      NewRoundRevenue@1100529604 : Decimal;
      RemRevenue@1100529605 : Decimal;
      NewTotalRevenue@1100528602 : Decimal;
      InvoiceFromDate@1100528606 : Date;
      InvoiceUntilDate@1100528605 : Date;
      TotalInvoiceNoOfDays@1100528609 : Integer;
      CurrPeriodNoOfDays@1100529602 : Integer;
    BEGIN
      //**4PS
      IF SalesLine."PB Install. Collect. Over. No." <> '' THEN
        IF CreateServiceLedgersByPBInstallmentOverviewLines(SalesHeader, SalesLine, ServJnlLine) THEN
          EXIT;

      ServJnlLine.INIT;
      ServJnlLine."Service Contract No." := SalesLine."Service Contract No.";
      ServJnlLine."Installment No." := SalesLine."Installment No.";
      ServJnlLine."Installment Line No." := SalesLine."Installment Line No.";
      ServJnlLine."Customer No." := SalesLine."Bill-to Customer No.";
      ServJnlLine.VALIDATE("Service Order No.", SalesLine."Service Order No.");
      ServJnlLine."Service Location No." := SalesLine."Service Location No.";
      IF SalesLine."Document Type" = SalesLine."Document Type"::"Credit Memo" THEN
        ServJnlLine."Document Type" := ServJnlLine."Document Type"::"Sales Credit Memo"
      ELSE
        ServJnlLine."Document Type" := ServJnlLine."Document Type"::"Sales Invoice";
      IF SalesHeader."Plant Invoice" THEN        //* Must be empty, otherwise the cost plus can not be create from the
        ServJnlLine."Document Type" := ServJnlLine."Document Type"::" ";  //service entry (so it can not be invoiced).
      ServJnlLine."Document No." := GenJnlLineDocNo;  //db, 23-09-03
      ServJnlLine."G/L Account" := SalesLine."No.";
      ServJnlLine."Posting Date" := SalesHeader."Posting Date";
      ServJnlLine."Shortcut Dimension 1 Code" := SalesLine."Shortcut Dimension 1 Code";
      ServJnlLine."Shortcut Dimension 2 Code" := SalesLine."Shortcut Dimension 2 Code";
      ServJnlLine."Dimension Set ID" := SalesLine."Dimension Set ID";
      ServJnlLine."Cost Component" := SalesLine."Cost Component";
      ServJnlLine."Currency Code" := SalesLine."Currency Code"; // dp00116.n
      IF (ChargePlantToOwnServOrder(SalesHeader) OR ChargeSOToPlantItem(SalesHeader)) AND NOT ChargeSOToJobPlantLoc(SalesHeader) THEN BEGIN //DP00195
        ServiceOrder.GET(ServJnlLine."Service Order No.");
        IF SalesLine."Additional Cost (Service)" THEN BEGIN
          ServiceType.Code := ServiceOrder."Service Type (Other)";
          ServJnlLine."Shortcut Dimension 1 Code" := ServiceOrder."Department Code (Other)"; //**4PS.mg, 06-02-13: C005640
        END ELSE BEGIN
          ServiceType.Code := ServiceOrder."Service Type";
          ServJnlLine."Shortcut Dimension 1 Code" := ServiceOrder."Global Dimension 1 Code"; //**4PS.mg, 06-02-13: C005640
        END;
        ServiceType.GET(ServiceType.Code);
        DimMgt.GetDimValueRec(2,SalesLine."Shortcut Dimension 2 Code",DimVal,TRUE,'');
        ServJnlLine."G/L Account" := ServiceType.GetWipAcc(ServiceType.Code, DimVal."Cost Type", COMPANYNAME, DimVal."Cost Type", '', SalesHeader."Sell-to Customer No.");
      END;
      IF AccountNoServEntry <> '' THEN BEGIN
        IF ChargeSOToJobPlantLoc(SalesHeader) THEN
          ServJnlLine."G/L Account" := AccountNoServEntry;
      END;

      ServJnlLine.Description := SalesLine.Description;
      ServJnlLine."Description 2" := SalesLine."Description 2";  //**4PS01.n
      ServJnlLine."Unit of Measure Code" := SalesLine."Unit of Measure Code";

      IF (NOT SalesHeader."Plant Invoice") OR ChargeSOToCustomerPlantLoc(SalesHeader) OR ChargeSOToJobPlantLoc(SalesHeader) THEN BEGIN //DP00195
        ServJnlLine."Entry Type" := ServJnlLine."Entry Type"::Sale; //C022170
        //db.sn, 01-07-09
        ServJnlLine.Quantity := -SalesLine."Qty. to Invoice";
        ServJnlLine.VALIDATE("Total Revenue (LCY)", -SalesLine.Amount); //mg.c, 02-08-13: C008886
        //IF SalesLine."Plant Invoice" AND SalesLine.IsPlantService AND (NOT ChargeSOToJobPlantLoc) THEN BEGIN
        //  ServJnlLine.Quantity := SalesLine."Qty. to Invoice";
        //  ServJnlLine.VALIDATE("Total Revenue (LCY)", SalesLine.Amount);
        //END;
        ServJnlLine.VALIDATE("Sales Price (LCY)", SalesLine."Sales Price (FCY)");
        IF ServJnlLine."Sales Price (LCY)" = 0 THEN
          IF ServJnlLine.Quantity = 0 THEN
            ServJnlLine.VALIDATE("Sales Price (LCY)", ServJnlLine."Total Revenue (LCY)")
          ELSE
            ServJnlLine.VALIDATE("Sales Price (LCY)", ServJnlLine."Total Revenue (LCY)" / ServJnlLine.Quantity);
        //db.en, 01-07-09
      END ELSE BEGIN
        ServJnlLine."Entry Type" := ServJnlLine."Entry Type"::Usage; //C022170
        IF SalesLine."Number of Time Units" = 0 THEN BEGIN
          ServJnlLine.Quantity := ROUND(SalesLine."Qty. to Invoice");
        END ELSE BEGIN
          ServJnlLine.Quantity := ROUND(SalesLine."Qty. to Invoice" * SalesLine."Number of Time Units");
        END;
        ServJnlLine.Quantity := -ServJnlLine.Quantity;
        ServJnlLine.VALIDATE("Total Cost (LCY)", -SalesLine.Amount); //mg.c, 02-08-13: C008886
        ServJnlLine.Quantity := ABS(ServJnlLine.Quantity);
        IF ServJnlLine."Total Cost (LCY)" < 0 THEN
          ServJnlLine.Quantity := -ServJnlLine.Quantity;
        ServJnlLine.VALIDATE("Unit Cost (LCY)", SalesLine."Unit Cost (LCY)");
        IF ServJnlLine."Unit Cost (LCY)" = 0 THEN
          IF (ServJnlLine.Quantity <> 0) THEN
            ServJnlLine.VALIDATE("Unit Cost (LCY)", ServJnlLine."Total Cost (LCY)" / ServJnlLine.Quantity)
          ELSE
            ServJnlLine.VALIDATE("Unit Cost (LCY)", ServJnlLine."Total Cost (LCY)");
        IF (ServJnlLine.Quantity < 0) AND (ServJnlLine."Unit Cost (LCY)" < 0) AND ( ServJnlLine."Total Cost (LCY)" < 0) THEN
          ServJnlLine.Quantity := -ServJnlLine.Quantity;
        ServJnlLine."Plant Invoice" := SalesLine."Plant Invoice";
        ServJnlLine."Rental Period" := SalesLine."Rental Period";
      END;
      ServJnlLine."Reason Code" := SalesHeader."Reason Code";
      ServJnlLine."Source Code" := SrcCode;
      ServJnlLine."Service Invoice" := SalesLine."Service Invoice";
      ServJnlLine."Item No." := SalesLine."Item No.";
      ServJnlLine."Basic Item" := SalesLine."Basic Item";
      ServJnlLine."Trade Item" := SalesLine."Trade Item";
      ServJnlLine."Vendor (Trade Item)" := SalesLine."Vendor (Trade Item)";
      ServJnlLine.Manufacturer := SalesLine.Manufacturer;
      ServJnlLine."Project No." := SalesLine."Job No.";
      ServJnlLine."Cost Plus Line No." := SalesLine."Cost Plus Line No.";
      ServJnlLine."Additional Cost" := SalesLine."Additional Cost (Service)";  //db, 24-11-05
      ServJnlLine."Removal Contribution" := SalesLine."Removal Contribution";  //db, 18-09-06
      ServJnlLine."Original Cost Type" := ServJnlLine."Original Cost Type"::" ";
      IF SalesLine."Cost Object Cost Plus Line" <> '' THEN
        ServJnlLine."Original Cost Type" := SalesLine."Cost Type Cost Plus Line" + 1;  //db, 06-10-06
      ServJnlLine."Cost Entry No. Service Ledger":= SalesLine."Cost Entry No. Service Ledger";
      ServJnlLine."Country/Region Code" := SalesHeader."VAT Country/Region Code";                   //**4PS05.sn
      ServJnlLine."Country/Region of Origin/Dest." := SalesHeader."Country of Origin";
      ServJnlLine."Net Weight" := SalesLine."Net Weight";
      ServJnlLine."Tariff No." := SalesLine."Tariff No.";
      ServJnlLine."Transaction Type" := SalesLine."Transaction Type";
      ServJnlLine."Transport Method" := SalesLine."Transport Method";
      ServJnlLine."Entry/Exit Point" := SalesLine."Exit Point";
      ServJnlLine.Area := SalesLine.Area;                                             //**4PS05.en
      ServJnlLine."Collective List No." := SalesLine."Collective List No.";
      ServJnlLine."Coll.-List SC Inv. Line No." := SalesLine."Coll.-List SC Inv. Line No.";
      ServJnlLine."Service Control Period Date" := SalesLine."Service Control Period Date";
      IF (ServJnlLine."Service Contract No." <> '') AND (ServJnlLine."Service Order No." = '') AND (ServJnlLine."Service Control Period Date" = 0D) THEN
        ServJnlLine."Service Control Period Date" := ServJnlLine."Posting Date";
      ServJnlLine."PB Install. Collect. Over. No." := SalesLine."PB Install. Collect. Over. No.";
      IF SalesLine."Skip Revenue Division" THEN
        ServJnlLine."Service Category" := SalesLine."Service Category";

      //Split installment revenue into control periods to ease out revenue
      OriginalServiceJournalLine := ServJnlLine;
      IF GetServiceControlPeriod(ServJnlLine, SalesLine, ServiceContract, ServiceContractCtrlPeriod, InvoiceFromDate, InvoiceUntilDate) THEN BEGIN
        TotalInvoiceNoOfDays := MaintenanceSalesAndCostMgt.NoOfDaysInterval(ServiceContract, InvoiceFromDate, InvoiceUntilDate);
        Currency.InitRoundingPrecision;
        OriginalTotalRevenue := ROUND(ServJnlLine."Total Revenue (LCY)", Currency."Amount Rounding Precision");

        REPEAT
          CurrPeriodNoOfDays := MaintenanceSalesAndCostMgt.DetermineNoOfDays(ServiceContract,
            InvoiceFromDate, InvoiceUntilDate, ServiceContractCtrlPeriod."Starting Date", ServiceContractCtrlPeriod."Ending Date");
          NewRevenue := OriginalTotalRevenue * CurrPeriodNoOfDays / TotalInvoiceNoOfDays - RemRevenue;
          NewRoundRevenue := ROUND(NewRevenue, Currency."Amount Rounding Precision");
          RemRevenue := NewRoundRevenue - NewRevenue;
          NewTotalRevenue += NewRoundRevenue;
          ServiceContractCtrlPeriod2.COPY(ServiceContractCtrlPeriod);
          IF ServiceContractCtrlPeriod2.NEXT = 0 THEN
            IF OriginalTotalRevenue - NewTotalRevenue <> 0 THEN
              NewRoundRevenue += OriginalTotalRevenue - NewTotalRevenue;
          IF NewRoundRevenue <> 0 THEN BEGIN
            IF (ServiceContract."Invoice Type" = ServiceContract."Invoice Type"::Dynamic) AND (ServiceContract."Dynamic Invoice Type" = ServiceContract."Dynamic Invoice Type"::Days) THEN
              ServJnlLine.Quantity := CurrPeriodNoOfDays;
            ServJnlLine.VALIDATE("Total Revenue (LCY)", NewRoundRevenue);
            ServJnlLine.VALIDATE("Sales Price (LCY)", ServJnlLine."Total Revenue (LCY)" / ServJnlLine.Quantity);
            IF ServiceContractCtrlPeriod."Date Finished" = 0D THEN
              ServJnlLine."Service Control Period Date" := ServiceContractCtrlPeriod."Ending Date"
            ELSE
              ServJnlLine."Service Control Period Date" := OriginalServiceJournalLine."Service Control Period Date";
            SplitRevenues(SalesLine."Skip Revenue Division", ServJnlLine, ServiceContractCtrlPeriod."Ending Date");
          END;
        UNTIL ServiceContractCtrlPeriod.NEXT = 0;
      END ELSE
        SplitRevenues(SalesLine."Skip Revenue Division", ServJnlLine, ServJnlLine."Service Control Period Date");

      ServLedgEntryNo := ServJnlPostLine.GetServLedgEntryNo; //DP00121
      ServJnlLine := OriginalServiceJournalLine;
    END;

    LOCAL PROCEDURE SplitRevenues@1100529602(SkipRevenueDivision@1100529600 : Boolean;VAR LocServiceJournalLine@1100529602 : Record 11012820;LocPeriodEndingDate@1100529601 : Date);
    BEGIN
      //**4PS
      IF NOT SkipRevenueDivision THEN BEGIN
        IF NOT SplitRevenueByServiceCategories(LocServiceJournalLine, LocPeriodEndingDate) THEN
          IF NOT SplitRevenueBySourceType(LocServiceJournalLine, LocPeriodEndingDate) THEN
            ServJnlPostLine.RunWithCheck(LocServiceJournalLine);
        EXIT;
      END;

      IF LocServiceJournalLine."Service Category" = '' THEN BEGIN
        IF NOT SplitRevenueBySourceType(LocServiceJournalLine, LocPeriodEndingDate) THEN
          ServJnlPostLine.RunWithCheck(LocServiceJournalLine);
      END ELSE BEGIN
        IF NOT SplitRevenueByServiceCategoriesBySourceType(LocServiceJournalLine, LocPeriodEndingDate) THEN
          ServJnlPostLine.RunWithCheck(LocServiceJournalLine);
      END;
    END;

    LOCAL PROCEDURE SplitRevenueByServiceCategories@1100528602(VAR ServJnlLine@1100525000 : Record 11012820;IPeriodEndingDate@1100528607 : Date) IsSplit : Boolean;
    VAR
      ServiceContract@1100528602 : Record 11012812;
      ServiceCategory@1100528600 : Record 11071985;
      ServiceCategory2@1100528608 : Record 11071985;
      Currency@1100528609 : Record 4;
      OriginalTotalRevenue@1100528603 : Decimal;
      NewTotalRevenue@1100528605 : Decimal;
      NewRevenue@1100528604 : Decimal;
    BEGIN
      //**4PS
      IF ServJnlLine."Service Order No." <> '' THEN
        EXIT;
      IF NOT ServiceContract.GET(ServJnlLine."Service Contract No.") THEN
        EXIT;
      IF NOT (ServiceContract."Budget Based on" IN [ServiceContract."Budget Based on"::Category, ServiceContract."Budget Based on"::"Category + Maintenance Scheme"]) THEN
        EXIT;
      ServiceCategory.SETRANGE("Service Contract No.", ServJnlLine."Service Contract No.");
      IF NOT ServiceCategory.FINDSET THEN
        EXIT;
      OriginalTotalRevenue := ServJnlLine."Total Revenue (LCY)";
      Currency.InitRoundingPrecision;
      REPEAT
        NewRevenue :=
          ROUND(OriginalTotalRevenue * ServiceContract.GetCategoryDivisionPercentage(ServiceCategory.Code, IPeriodEndingDate) / 100,
            Currency."Amount Rounding Precision");
        NewTotalRevenue += NewRevenue;
        ServiceCategory2.COPY(ServiceCategory);
        IF ServiceCategory2.NEXT = 0 THEN
          IF OriginalTotalRevenue - NewTotalRevenue <> 0 THEN
            NewRevenue += OriginalTotalRevenue - NewTotalRevenue;  // add rounding remainder
        IF NewRevenue <> 0 THEN BEGIN
          ServJnlLine.VALIDATE("Total Revenue (LCY)", NewRevenue);
          ServJnlLine.VALIDATE("Sales Price (LCY)", ServJnlLine."Total Revenue (LCY)" / ServJnlLine.Quantity);
          ServJnlLine."Service Category" := ServiceCategory.Code;
          IF NOT SplitRevenueByServiceCategoriesBySourceType(ServJnlLine,IPeriodEndingDate) THEN
            ServJnlPostLine.RunWithCheck(ServJnlLine);
          IsSplit := TRUE;
        END;
      UNTIL ServiceCategory.NEXT = 0;
    END;

    LOCAL PROCEDURE SplitRevenueByServiceCategoriesBySourceType@1100528605(VAR ServJnlLine@1100525000 : Record 11012820;IPeriodEndingDate@1100528600 : Date) : Boolean;
    VAR
      ServiceContract@1100528601 : Record 11012812;
      Currency@1100528605 : Record 4;
      OriginalTotalRevenue@1100528604 : Decimal;
      NewRevenue@1100528602 : Decimal;
    BEGIN
      //**4PS
      IF NOT ServiceContract.GET(ServJnlLine."Service Contract No.") THEN
        EXIT;
      IF NOT (ServiceContract."Budget Based on" IN [ServiceContract."Budget Based on"::Category, ServiceContract."Budget Based on"::"Category + Maintenance Scheme"]) THEN
        EXIT;
      IF ServJnlLine."Service Category" = '' THEN
        EXIT;
      OriginalTotalRevenue := ServJnlLine."Total Revenue (LCY)";
      Currency.InitRoundingPrecision;
      IF ServiceContract.GetCategoryDivisionPercentageShareCalls(ServJnlLine."Service Category", IPeriodEndingDate) = 0 THEN
        EXIT;
      NewRevenue :=
        ROUND(OriginalTotalRevenue * ServiceContract.GetCategoryDivisionPercentageShareCalls(ServJnlLine."Service Category", IPeriodEndingDate) / 100,
          Currency."Amount Rounding Precision");
      IF NewRevenue <> 0 THEN BEGIN
        ServJnlLine.VALIDATE("Total Revenue (LCY)", NewRevenue);
        ServJnlLine.VALIDATE("Sales Price (LCY)", ServJnlLine."Total Revenue (LCY)" / ServJnlLine.Quantity);
        ServJnlLine."Source Type" := ServJnlLine."Source Type"::Call;
        ServJnlPostLine.RunWithCheck(ServJnlLine);

        IF OriginalTotalRevenue - NewRevenue <> 0 THEN BEGIN
          ServJnlLine.VALIDATE("Total Revenue (LCY)", OriginalTotalRevenue - NewRevenue);
          ServJnlLine.VALIDATE("Sales Price (LCY)", ServJnlLine."Total Revenue (LCY)" / ServJnlLine.Quantity);
          ServJnlLine."Source Type" := ServJnlLine."Source Type"::Contract;
          ServJnlPostLine.RunWithCheck(ServJnlLine);
        END;
        ServJnlLine."Source Type" := ServJnlLine."Source Type"::" ";
        EXIT(TRUE);
      END;
    END;

    LOCAL PROCEDURE SplitRevenueBySourceType@1100528604(VAR ServJnlLine@1100525000 : Record 11012820;IPeriodEndingDate@1100528600 : Date) : Boolean;
    VAR
      ServiceContract@1100528601 : Record 11012812;
      OriginalTotalRevenue@1100528602 : Decimal;
      NewRevenue@1100528603 : Decimal;
    BEGIN
      //**4PS
      IF NOT ServiceContract.GET(ServJnlLine."Service Contract No.") THEN
        EXIT;
      IF ServiceContract."Budget Based on" <> ServiceContract."Budget Based on"::"Maintenance Scheme" THEN
        EXIT;
      OriginalTotalRevenue := ServJnlLine."Total Revenue (LCY)";
      Currency.InitRoundingPrecision;
      IF ServiceContract.GetPercentageShareCalls(IPeriodEndingDate) = 0 THEN
        EXIT;
      NewRevenue :=
        ROUND(OriginalTotalRevenue * ServiceContract.GetPercentageShareCalls(IPeriodEndingDate) / 100,
          Currency."Amount Rounding Precision");
      IF NewRevenue <> 0 THEN BEGIN
        ServJnlLine.VALIDATE("Total Revenue (LCY)", NewRevenue);
        ServJnlLine.VALIDATE("Sales Price (LCY)", ServJnlLine."Total Revenue (LCY)" / ServJnlLine.Quantity);
        ServJnlLine."Source Type" := ServJnlLine."Source Type"::Call;
        ServJnlPostLine.RunWithCheck(ServJnlLine);

        IF OriginalTotalRevenue - NewRevenue <> 0 THEN BEGIN
          ServJnlLine.VALIDATE("Total Revenue (LCY)", OriginalTotalRevenue - NewRevenue);
          ServJnlLine.VALIDATE("Sales Price (LCY)", ServJnlLine."Total Revenue (LCY)" / ServJnlLine.Quantity);
          ServJnlLine."Source Type" := ServJnlLine."Source Type"::Contract;
          ServJnlPostLine.RunWithCheck(ServJnlLine);
        END;
        ServJnlLine."Source Type" := ServJnlLine."Source Type"::" ";
        EXIT(TRUE);
      END;
    END;

    LOCAL PROCEDURE PostPlant@11012001(SalesHeader@1100525002 : Record 36;SalesLine@1100525001 : Record 37;PostAsPlantCost@1100485000 : Boolean;InternalChargePlant@1100529000 : Boolean);
    VAR
      PlantTypeRec@1210190000 : Record 11012551;
      PlantLocation@1100525004 : Record 11012554;
      PlantLedgerEntry@1100525003 : Record 11012572;
      PlantServiceOrder@1100525000 : Boolean;
    BEGIN
      //**4PS
      IF (SalesLine."Plant Location" = '') OR (NOT PlantLocation.GET(SalesLine."Plant Location")) THEN
        PlantLocation.INIT;

      PlantLedgerEntry.INIT;
      IF (SalesHeader."Company Name" <> COMPANYNAME) AND (SalesHeader."Company Name" <> '')  THEN
        PlantLedgerEntry."Company Name" := SalesHeader."Company Name";
      IF SalesLine."Job No." <> '' THEN BEGIN
        PlantLedgerEntry."Project No." := SalesLine."Job No.";
        IF SalesLine.Element <> '' THEN
          PlantLedgerEntry.Element := SalesLine.Element;
      END;
      IF SalesLine."Service Order No." <> '' THEN
        PlantLedgerEntry."Service Order No." := SalesLine."Service Order No.";
      PlantLedgerEntry."Customer No." := SalesHeader."Sell-to Customer No.";
      PlantLedgerEntry."Document No." := GenJnlLineDocNo;
      PlantLedgerEntry."Posting Date" := SalesHeader."Posting Date";
      PlantLedgerEntry."Document Date" := SalesHeader."Document Date";
      PlantLedgerEntry."Account No." := SalesLine."No.";
      PlantLedgerEntry.Quantity := -SalesLine."Qty. to Invoice";
      PlantLedgerEntry."Number of Time Units" := SalesLine."Number of Time Units";  //C009123.n
      IF (NOT PostAsPlantCost) THEN BEGIN
        IF InternalChargePlant THEN BEGIN  //DP00815
          PlantLedgerEntry."Total Price" := SalesLine.Amount;
          PlantLedgerEntry."Unit Amount" := PlantLedgerEntry."Total Price";
        END ELSE BEGIN
          PlantLedgerEntry."Unit Amount" := SalesLine."Unit Price";
          PlantLedgerEntry."Total Price" := -SalesLine.Amount;
        END;
        PlantLedgerEntry."Plant Type" := SalesLine."Plant Type";
        PlantLedgerEntry."Plant No." := SalesLine."Plant No.";
        PlantLedgerEntry."Plant Location" := SalesLine."Plant Location";
        PlantLedgerEntry."Relate to" := SalesLine."Relate to";
        //C009123.sn
        IF (SalesLine."Relate to" = SalesLine."Relate to"::Rental) THEN BEGIN
          IF (SalesLine."Document Type" = SalesLine."Document Type"::"Credit Memo") AND
             (PlantLedgerEntry.Quantity < 0) AND (PlantLedgerEntry."Number of Time Units" > 0)
          THEN BEGIN  //Only Time Units for Rental/Rental Correction
            PlantLedgerEntry.Quantity := -PlantLedgerEntry.Quantity;
            IF PlantLedgerEntry."Unit Amount" < 0 THEN
              PlantLedgerEntry."Unit Amount" := -PlantLedgerEntry."Unit Amount"
            ELSE
              PlantLedgerEntry."Number of Time Units" := -PlantLedgerEntry."Number of Time Units";
          END;
        END ELSE BEGIN
          //C022785
          IF (PlantLedgerEntry."Number of Time Units" = 0) AND
             (((PlantLedgerEntry.Quantity < 0) AND (PlantLedgerEntry."Unit Amount" < 0) AND (PlantLedgerEntry."Total Price" > 0)) OR
              ((PlantLedgerEntry.Quantity > 0) AND (PlantLedgerEntry."Unit Amount" < 0) AND (PlantLedgerEntry."Total Price" < 0)))
          THEN BEGIN
            PlantLedgerEntry.Quantity := -PlantLedgerEntry.Quantity;
            PlantLedgerEntry."Unit Amount" := -PlantLedgerEntry."Unit Amount";
          END;
        END;
        //C009123.en
        //IF (NOT SalesHeader."Plant Invoice") AND (PlantLedgerEntry."Relate to" = 0) THEN  //*C003125.n (T001118)
        //  PlantLedgerEntry."Relate to" := PlantLedgerEntry."Relate to"::"Sundry Costs";
        PlantLedgerEntry."Gen. Bus. Posting Group" := SalesLine."Gen. Bus. Posting Group";
      END ELSE BEGIN
        IF InternalChargePlant THEN BEGIN  //DP00815
          PlantSetup.GET;
          PlantLedgerEntry."Total Cost" := -SalesLine.Amount;
          PlantLedgerEntry."Direct Unit Cost" := PlantLedgerEntry."Total Cost";
          PlantLedgerEntry."Plant Type" := SalesLine."Plant Type";
          PlantLedgerEntry."Plant No." := SalesLine."Plant No.";
          PlantLedgerEntry."Cost Component" := PlantSetup."Cost Component Internal Charge";
          PlantLedgerEntry."Relate to" := 0;
        END ELSE BEGIN
          PlantLedgerEntry."Direct Unit Cost" := SalesLine."Unit Price";
          PlantLedgerEntry."Total Cost" := -SalesLine.Amount;
        END;
        PlantLedgerEntry."Unit Cost" := PlantLedgerEntry."Direct Unit Cost";
        IF NOT InternalChargePlant THEN BEGIN  //DP00815.n
          //DP00195.sn
          PlantServiceOrder := FALSE;
          IF ServiceOrder.GET(SalesLine."Service Order No.") THEN
            IF ServiceOrder.IsPlantServiceOrder AND (SalesLine."Service Order No." <> '') THEN
              PlantServiceOrder := TRUE;
          IF PlantServiceOrder THEN BEGIN
            PlantLedgerEntry."Cost Component" := ServiceOrder."Cost Component Plant";
            PlantLedgerEntry."Plant Location" := SalesLine."Plant Location";
            PlantLedgerEntry."Plant Type" := SalesLine."Plant Type";
            PlantLedgerEntry."Plant No." := SalesLine."Plant No.";
          END ELSE BEGIN
            PlantLedgerEntry."Plant Type" := Project."Plant Type";
            PlantLedgerEntry."Plant No." := Project."Plant No.";
            PlantLedgerEntry."Cost Component" := Project."Cost Component Plant";
            PlantLedgerEntry."Plant Location" := Project."Plant Location";
          END;
          //DP00195.en
          PlantLedgerEntry."Relate to" := PlantLedgerEntry."Relate to"::"Job Order";
        END;
      END;
      PlantLedgerEntry."Plant Invoice Origin" := SalesLine."Plant Invoice Origin";
      PlantLedgerEntry.Description := SalesLine.Description;
      PlantLedgerEntry."Description 2" := SalesLine."Description 2";  //**4PS01.n
      PlantLedgerEntry."Employee No." := SalesLine."Employee No.";
      PlantLedgerEntry."Unit of Measure Code" := SalesLine."Unit of Measure Code";
      PlantLedgerEntry."Department Code" := SalesLine."Shortcut Dimension 1 Code";
      PlantLedgerEntry."Cost Object" := SalesLine."Shortcut Dimension 2 Code";
      PlantLedgerEntry."Dimension Set ID" := SalesLine."Dimension Set ID";
      PlantLedgerEntry."Source Code" := SrcCode;
      PlantLedgerEntry."Reason Code" := SalesHeader."Reason Code";
      PlantLedgerEntry."Country/Region Code" := SalesHeader."VAT Country/Region Code";
      PlantLedgerEntry."Territory Code" := PlantLocation."Territory Code";
      //PlantLedgerEntry."Plant Posting Group" := SalesLine."Posting Group";  //*27818.o
      PlantLedgerEntry."No. Series" := SalesHeader."No. Series";
      PlantLedgerEntry."Rate Code" := SalesLine."Plant Rate Code";
      //PlantLedgerEntry."Number of Time Units" := SalesLine."Number of Time Units";  //C009123.o
      PlantLedgerEntry."Rate Type" := SalesLine."Rate Type";
      IF SalesLine."Arrival Order Type" <> SalesLine."Arrival Order Type"::"Transport Order" THEN BEGIN
        PlantLedgerEntry."Arrival Order Type" := SalesLine."Arrival Order Type";
        PlantLedgerEntry."Arrival Order" := SalesLine."Arrival Order";
      END ELSE BEGIN
        PlantLedgerEntry."Transport Order No." := SalesLine."Arrival Order";
      END;
      IF SalesLine."Removal Order Type" <> SalesLine."Removal Order Type"::"Transport Order" THEN BEGIN
        PlantLedgerEntry."Removal Order Type" := SalesLine."Removal Order Type";
        PlantLedgerEntry."Removal Order" := SalesLine."Removal Order";
      END ELSE BEGIN
        PlantLedgerEntry."Transport Order No." := SalesLine."Removal Order";
      END;
      PlantLedgerEntry."Rental Period" := SalesLine."Rental Period";
      //*27818.sn
      IF PlantLedgerEntry."Plant Type" <> '' THEN BEGIN
        IF PlantTypeRec.GET(PlantLedgerEntry."Plant Type") THEN
          PlantLedgerEntry."Plant Posting Group" := PlantTypeRec.PlantPostingGrp(PlantLedgerEntry."Plant No.", '', '');
      END;
      //*27818.en

      PlantJnlPostLine.RUN(PlantLedgerEntry);

      IF (NOT InternalChargePlant) AND (NOT SalesLine.ResourceRequestInvoice)  THEN BEGIN  //DP00815.n
        IF NOT PostAsPlantCost THEN
          PostPlantRentalRateComponents(SalesHeader,SalesLine,PlantLedgerEntry,PlantLocation);
        IF SalesHeader."Plant Invoice" THEN
          UpdateInvoiceNosSource(SalesHeader,SalesLine,TRUE,GenJnlLineDocNo);
      END;
    END;

    LOCAL PROCEDURE PostPlantRentalRateComponents@1100485000(SalesHeader@1100525003 : Record 36;SalesLine@1100525000 : Record 37;PlantLedgerEntry@1100525001 : Record 11012572;PlantLocation@1100525002 : Record 11012554);
    VAR
      PlantNumber@1100529000 : Record 11012552;
      lvRateCompPostingRec@1100485007 : Record 11020500;
      lvRateCompEntryRec@1100485008 : Record 11020501;
      lvRateRec@1100485000 : Record 11012567;
      lvRateCodeRec@1100485009 : Record 11020502;
      lvTmpRateCompRec@1100485006 : TEMPORARY Record 11012584;
      lvSearchRateCU@1100485001 : Codeunit 11012567;
      lvRefDate@1100485004 : Date;
      lvRentalType@1100485002 : Option;
      lvPos@1100485005 : Integer;
      lvAmount@1100485003 : Decimal;
      lvSalesLineAmount@1100485010 : Decimal;
    BEGIN
      //**4PS
      // It is only allowed to create 'G/L Entries' and 'Plant Rate Component Entries', so be sure that no other entries
      // (VAT, Customer, Plant, Project, etc.) created. Because this extra entries should not be counted twice.

      WITH SalesLine DO BEGIN
        IF ("Plant Type" = '') THEN
          EXIT;
        CASE "Relate to" OF
          "Relate to"::Rental:
            BEGIN
              IF NOT ("Plant Invoice Origin" IN
                ["Plant Invoice Origin"::"Plant Inventory", "Plant Invoice Origin"::"Rental Correction", "Plant Invoice Origin"::RentalAgreement])
              THEN
                EXIT;
              lvRentalType := lvRateRec."Rental Type"::Rental;
            END;
          "Relate to"::"Plant Hours":
            BEGIN
              IF NOT ("Plant Invoice Origin" = "Plant Invoice Origin"::"Plant Hours") THEN
                EXIT;
              IF ("Plant Rate Code" <> '') THEN BEGIN
                IF lvRateCodeRec.ReadPlantRateCode("Plant Location", "Plant Rate Code", '') THEN BEGIN
                  IF (lvRateCodeRec."Hour Rate from" = lvRateCodeRec."Hour Rate from"::Employee) THEN
                    EXIT;
                END;
              END;
              lvRentalType := lvRateRec."Rental Type"::"Plant Hours";
            END;
          ELSE
            EXIT;
        END;

        PlantSetup.GET;
        IF (NOT PlantSetup."Post Rent by Rate Component") THEN
          EXIT;
        IF ("Plant No." <> '') AND ("Plant No." <> '0') THEN BEGIN
          IF PlantNumber.GET("Plant Type", "Plant No.") THEN BEGIN
            IF PlantNumber."No Rate Component Posting" THEN
              EXIT;
          END;
        END;


        lvSalesLineAmount := -SalesLine.Amount;  //* 'Sales line amount' is negative, for that reason * -1

        lvRateCompPostingRec.SETCURRENTKEY("Plant Posting Group Code", "Gen. Bus. Posting Group", "Rate Component");
        //lvRateCompPostingRec.SETRANGE("Plant Posting Group Code", "Posting Group");  //*27818.o
        lvRateCompPostingRec.SETRANGE("Plant Posting Group Code", PlantLedgerEntry."Plant Posting Group");  //*27818.n
        lvRateCompPostingRec.SETRANGE("Gen. Bus. Posting Group", PlantLocation."Gen. Bus. Posting Group");  //* Is read in PostPlant
        IF lvRateCompPostingRec.FINDSET THEN BEGIN
          lvRefDate := SalesHeader."Posting Date";
          lvPos := STRPOS("Rental Period", '..');
          IF (lvPos > 0) AND (STRLEN("Rental Period") > (lvPos+2)) THEN BEGIN
            IF NOT EVALUATE(lvRefDate, COPYSTR("Rental Period", (lvPos+2))) THEN
              lvRefDate := SalesHeader."Posting Date";
          END;
          IF lvSearchRateCU.FindRentalRateRateComponents(
            "Plant Location","Plant Type","Plant No.",lvRefDate,lvRentalType,lvSalesLineAmount,SalesLine,TRUE,lvTmpRateCompRec)
          THEN BEGIN
            REPEAT
              IF lvTmpRateCompRec.GET(lvRateCompPostingRec."Rate Component") THEN BEGIN
                IF (PlantSetup."Type Division of Rate Comp." <> PlantSetup."Type Division of Rate Comp."::DiffOnResult) THEN
                  lvAmount := lvSalesLineAmount * (lvTmpRateCompRec.Percentage / 100)
                ELSE
                  lvAmount := lvTmpRateCompRec.Percentage;  //*For this method, this is the amount
                IF lvAmount <> 0 THEN BEGIN
                  lvRateCompPostingRec.TESTFIELD("Account No.");
                  lvRateCompPostingRec.TESTFIELD("Bal. Account No.");

                  TempGenJnlRateCompBuffer.RESET;
                  TempGenJnlRateCompBuffer.SETRANGE("Journal Template Name", lvRateCompPostingRec."Rate Component");
                  TempGenJnlRateCompBuffer.SETRANGE("Journal Batch Name", '');
                  TempGenJnlRateCompBuffer.SETRANGE("Account No.", lvRateCompPostingRec."Account No.");
                  TempGenJnlRateCompBuffer.SETRANGE("Bal. Account No.", lvRateCompPostingRec."Bal. Account No.");
                  TempGenJnlRateCompBuffer.SETRANGE("Shortcut Dimension 1 Code", "Shortcut Dimension 1 Code");
                  IF TempGenJnlRateCompBuffer.FIND('-') THEN BEGIN
                    TempGenJnlRateCompBuffer.Amount := TempGenJnlRateCompBuffer.Amount + lvAmount;
                    TempGenJnlRateCompBuffer.MODIFY;
                  END ELSE BEGIN
                    TempGenJnlRateCompBuffer.INIT;
                    TempGenJnlRateCompBuffer."Journal Template Name" := lvRateCompPostingRec."Rate Component";
                    TempGenJnlRateCompBuffer."Journal Batch Name" := '';
                    TempGenJnlRateCompBuffer."Line No." := NextLineNoGLRateCompBuf;
                    TempGenJnlRateCompBuffer."Account No." := lvRateCompPostingRec."Account No.";
                    TempGenJnlRateCompBuffer."Bal. Account No." := lvRateCompPostingRec."Bal. Account No.";
                    TempGenJnlRateCompBuffer."Shortcut Dimension 1 Code" := "Shortcut Dimension 1 Code";
                    //* "Shortcut Dimension 2 Code" leave empty, this limits the number of entries
                    TempGenJnlRateCompBuffer.Description := lvTmpRateCompRec.Description;
                    TempGenJnlRateCompBuffer.Amount := lvAmount;
                    TempGenJnlRateCompBuffer.INSERT;
                    NextLineNoGLRateCompBuf := NextLineNoGLRateCompBuf + 1;
                  END;

                  lvRateCompEntryRec.INIT;
                  lvRateCompEntryRec."Document No." := GenJnlLineDocNo;
                  lvRateCompEntryRec."Document Date" := SalesHeader."Document Date";
                  lvRateCompEntryRec."Posting Date" := SalesHeader."Posting Date";
                  lvRateCompEntryRec."Rate Component" := lvRateCompPostingRec."Rate Component";
                  lvRateCompEntryRec."Plant Type" := "Plant Type";
                  lvRateCompEntryRec."Plant No." := "Plant No.";
                  lvRateCompEntryRec."Rate Code" := "Plant Rate Code";
                  lvRateCompEntryRec.Description := PlantLedgerEntry.Description;
                  lvRateCompEntryRec.Amount := lvAmount;
                  lvRateCompEntryRec."Department Code" := "Shortcut Dimension 1 Code";
                  lvRateCompEntryRec."Cost Object" := "Shortcut Dimension 2 Code";
                  lvRateCompEntryRec."Dimension Set ID" := "Dimension Set ID";
                  lvRateCompEntryRec."Gen. Bus. Posting Group" := "Gen. Bus. Posting Group";
                  lvRateCompEntryRec."Plant Posting Group" := PlantLedgerEntry."Plant Posting Group";
                  lvRateCompEntryRec."Relate to" := "Relate to";
                  lvRateCompEntryRec."Plant Invoice Origin" := "Plant Invoice Origin";
                  lvRateCompEntryRec."Plant Ledger Entry No." := PlantLedgerEntry."Entry No.";
                  PlantRateComponentPostLine.RUN(lvRateCompEntryRec);
                END;
              END;
            UNTIL lvRateCompPostingRec.NEXT = 0;
          END;
        END;
      END;
    END;

    LOCAL PROCEDURE PostPlantRateComponentBuffer@1100485012(SalesHeader@1100525001 : Record 36);
    VAR
      GenJnlLine@1100525000 : Record 81;
      lvGLAccRec@1100485003 : Record 15;
      lvTmpBufferRec@1100485001 : TEMPORARY Record 81;
      DimMgt@1100525002 : Codeunit 408;
      lvI@1100485000 : Integer;
      lvNextLineNo@1100485002 : Integer;
    BEGIN
      //**4PS
      lvNextLineNo := 1;
      lvTmpBufferRec.RESET;
      lvTmpBufferRec.DELETEALL;

      WITH TempGenJnlRateCompBuffer DO BEGIN
        FOR lvI := 1 TO 2 DO BEGIN
          IF lvI = 2 THEN BEGIN
            lvTmpBufferRec.RESET;
            IF lvTmpBufferRec.FIND('-') THEN BEGIN
              REPEAT
                INIT;
                "Journal Template Name" := lvTmpBufferRec."Journal Template Name";
                "Journal Batch Name" := lvTmpBufferRec."Journal Batch Name";
                "Line No." := lvTmpBufferRec."Line No.";
                "Account No." := lvTmpBufferRec."Account No.";
                Description := lvTmpBufferRec.Description;
                "Shortcut Dimension 1 Code" := lvTmpBufferRec."Shortcut Dimension 1 Code";
                Amount := -lvTmpBufferRec.Amount;
                INSERT;
              UNTIL lvTmpBufferRec.NEXT = 0;
            END;
          END;

          RESET;
          IF FIND('-') THEN BEGIN
            REPEAT
              GenJnlLine.INIT;
              GenJnlLine."Document Type" := GenJnlLineDocType;
              GenJnlLine."Document No." := GenJnlLineDocNo;
              GenJnlLine."Document Date" := SalesHeader."Document Date";
              GenJnlLine."Posting Date" := SalesHeader."Posting Date";
              GenJnlLine."Account Type" := GenJnlLine."Account Type"::"G/L Account";
              GenJnlLine."Account No." := "Account No.";
              GenJnlLine."Shortcut Dimension 1 Code" := "Shortcut Dimension 1 Code";
              DimMgt.ValidateShortcutDimValues(1,"Shortcut Dimension 1 Code",GenJnlLine."Dimension Set ID");
              GenJnlLine.Description := Description;
              GenJnlLine.Amount := Amount;
              GenJnlLine.VALIDATE(Amount);
              GenJnlLine."Origin Type" := GenJnlLine."Origin Type"::Plant;
              GenJnlLine."Source Code" := SrcCode;
              GenJnlLine."Reason Code":= SalesHeader."Reason Code";
              GenJnlLine."System-Created Entry" := TRUE;
              GenJnlPostLine.RunWithCheck(GenJnlLine);

              IF lvI = 1 THEN BEGIN
                lvTmpBufferRec.RESET;
                lvTmpBufferRec.SETRANGE("Journal Template Name", '');
                lvTmpBufferRec.SETRANGE("Journal Batch Name", '');
                lvTmpBufferRec.SETRANGE("Account No.", "Bal. Account No.");
                lvTmpBufferRec.SETRANGE("Shortcut Dimension 1 Code", "Shortcut Dimension 1 Code");
                IF lvTmpBufferRec.FIND('-') THEN BEGIN
                  lvTmpBufferRec.Amount := lvTmpBufferRec.Amount + GenJnlLine.Amount;
                  lvTmpBufferRec.MODIFY;
                END ELSE BEGIN
                  lvTmpBufferRec.INIT;
                  lvTmpBufferRec."Journal Template Name" := '';
                  lvTmpBufferRec."Journal Batch Name" := '';
                  lvTmpBufferRec."Line No." := lvNextLineNo;
                  lvTmpBufferRec."Account No." := "Bal. Account No.";
                  IF lvGLAccRec.GET(lvTmpBufferRec."Account No.") THEN
                    lvTmpBufferRec.Description := lvGLAccRec.Name;
                  lvTmpBufferRec."Shortcut Dimension 1 Code" := "Shortcut Dimension 1 Code";
                  lvTmpBufferRec.Amount := GenJnlLine.Amount;
                  lvTmpBufferRec.INSERT;
                  lvNextLineNo := lvNextLineNo + 1;
                END;
              END;
            UNTIL NEXT = 0;
            DELETEALL;
          END;
        END;
      END;
    END;

    PROCEDURE PostInvoiceProposalviaIC@1210190002(lSalesHeadRec@1210190000 : Record 36) Posted@1210190001 : Boolean;
    VAR
      SalesHeader@1100525002 : Record 36;
      SalesLine@1100525005 : Record 37;
      IntercompanyRelation@1100525003 : Record 11012057;
      IntercompanyEntry@1100525006 : Record 11012058;
      OrigGenJnlLine@1100525007 : Record 81;
      GenJnlLine@1100525000 : Record 81;
      SalesHeader2@1100525008 : Record 36;
      NoSeriesMgt@1100525001 : Codeunit 396;
      CreditMemoBln@1100525004 : Boolean;
    BEGIN
      //**4PS
      //* Plant Invoice Proposal via IC only possible for propasals with a project or service order. Plant location with
      //* company filled only if linked to project or /serviceorder (or employee but then 'empl-loc' that is not invoiced).
      SalesHeader.COPY(lSalesHeadRec);

      IntercompanyRelation.GET(COMPANYNAME,SalesHeader."Company Name");

      GLSetup.GET;
      SourceCodeSetup.GET;
      SrcCode := SourceCodeSetup."Plant Invoice";

      SalesSetup.GET;

      SalesHeader.CALCFIELDS("Amount Including VAT");
      IF SalesHeader."Amount Including VAT" >= 0 THEN BEGIN
        SalesSetup.TESTFIELD("Posted Internal Plant Invoices");
        NoSeriesMgt.InitSeries(SalesSetup."Posted Internal Plant Invoices",' ',TODAY,GenJnlLineDocNo,NoSeriesCde);
        InsertSalesInvoiceHeaderFromIC(SalesHeader);
        CreditMemoBln := FALSE;
      END ELSE BEGIN
        SalesSetup.TESTFIELD("Posted Int. Plant Credit Memos");
        NoSeriesMgt.InitSeries(SalesSetup."Posted Int. Plant Credit Memos",' ',TODAY,GenJnlLineDocNo,NoSeriesCde);
        InsertSalesCrMemHeaderFromIC(SalesHeader);
        CreditMemoBln := TRUE;
      END;

      SalesLine.SETRANGE("Document Type",SalesLine."Document Type"::"Invoice Proposal");
      SalesLine.SETRANGE("Document No.",SalesHeader."No.");

      IF SalesLine.FINDSET THEN BEGIN
        TempSurchargePostingBuffer[1].DELETEALL;
        TempComplWIPPostingBuffer[1].DELETEALL;

        REPEAT
          PostICEntry(SalesHeader,SalesLine,IntercompanyRelation,IntercompanyEntry);
          PostGLEntry(SalesHeader,SalesLine,IntercompanyRelation,OrigGenJnlLine);
          PostSurchargeICPlant(SalesHeader,SalesLine,IntercompanyEntry);
          IF NOT CreditMemoBln THEN
            InsertSalesInvoiceLinesFromIC(SalesLine)
          ELSE
            InsertSalesCrMemLinesFromIC(SalesLine);

          UpdateInvoiceNosSource(SalesHeader,SalesLine,FALSE,GenJnlLineDocNo);

          IF TempSurchargePostingBuffer[1].FIND('+') THEN
            REPEAT
              GenJnlLine.INIT;
              GenJnlLine."Source Code" := SrcCode;
              GenJnlLine."Reason Code":= OrigGenJnlLine."Reason Code";
              GenJnlLine."Account Type" := GenJnlLine."Account Type"::"G/L Account";

              IF TempSurchargePostingBuffer[1]."Job No." <> '' THEN
                GenJnlLine."Account No." := IntercompanyRelation.GetICAccountOfCurrentCompany
              ELSE
                GenJnlLine."Account No." := TempSurchargePostingBuffer[1]."G/L Account";

              GenJnlLine."Posting Date" := OrigGenJnlLine."Posting Date";
              GenJnlLine."Document Type" := GenJnlLineDocType;
              GenJnlLine."Document No." := GenJnlLineDocNo;
              GenJnlLine."System-Created Entry" := TRUE;
              GenJnlLine."Document Date" := OrigGenJnlLine."Document Date";
              GenJnlLine.Description := TempSurchargePostingBuffer[1].Description;
              GenJnlLine."Description 2" := TempSurchargePostingBuffer[1]."Description 2";  //**4PS01.n
              //* Field TempSurchargePostingBuffer[1]."Bal. Account No." never filled. Field is now used for Element
              //* because element not in key. So do not fill "Bal. Account No." here.
              //GenJnlLine."Bal. Account No." := TempSurchargePostingBuffer[1]."Bal. Account No.";
              GenJnlLine.Amount := TempSurchargePostingBuffer[1].Amount;
              GenJnlLine.VALIDATE(Amount);
              GenJnlLine."Shortcut Dimension 1 Code" := TempSurchargePostingBuffer[1]."Global Dimension 1 Code";
              GenJnlLine."Shortcut Dimension 2 Code" := TempSurchargePostingBuffer[1]."Global Dimension 2 Code";
              GenJnlLine."Dimension Set ID" := TempSurchargePostingBuffer[1]."Dimension Set ID";
              GenJnlLine."Cost Component" := TempSurchargePostingBuffer[1]."Cost Component";
              GenJnlLine."Origin Type" := TempSurchargePostingBuffer[1]."Origin Type";
              GenJnlLine."Interest Date" := OrigGenJnlLine."Interest Date";
              GenJnlLine."Alternative Bill-to Address" := OrigGenJnlLine."Alternative Bill-to Address";
              //Call C006064 n  FIELD "Buy-Back Item (Plant Order)" USED FOR OTHER PURPOSE
              GenJnlLine."Skip WIP Check" := TempSurchargePostingBuffer[1]."Buy-Back Item (Plant Order)";

              RunGenJnlPostLine(GenJnlLine);

              IF (TempSurchargePostingBuffer[1]."Job No." <> '') OR (TempSurchargePostingBuffer[1]."Service Order No." <> '') THEN
                PostICEntrySurcharge(SalesHeader,SalesLine,IntercompanyRelation);

            UNTIL TempSurchargePostingBuffer[1].NEXT(-1) = 0;

          TempSurchargePostingBuffer[1].DELETEALL;

          IF TempComplWIPPostingBuffer[1].FIND('-') THEN BEGIN
            REPEAT
              GenJnlLine.INIT;
              GenJnlLine."Source Code" := SrcCode;
              GenJnlLine."Reason Code":= OrigGenJnlLine."Reason Code";
              GenJnlLine."Account Type" := GenJnlLine."Account Type"::"G/L Account";
              GenJnlLine."Account No." := TempComplWIPPostingBuffer[1]."G/L Account";
              GenJnlLine."Posting Date" := OrigGenJnlLine."Posting Date";
              GenJnlLine."Document Type" := GenJnlLineDocType;
              GenJnlLine."Document No." := GenJnlLineDocNo;
              GenJnlLine."System-Created Entry" := TRUE;
              GenJnlLine."Document Date" := OrigGenJnlLine."Document Date";
              GenJnlLine.Description := TempComplWIPPostingBuffer[1].Description;
              GenJnlLine."Description 2" := TempComplWIPPostingBuffer[1]."Description 2";  //**4PS01.n
              IF TempComplWIPPostingBuffer[1].Element = '' THEN //**4PS.n C024228
                GenJnlLine."Bal. Account No." := TempComplWIPPostingBuffer[1]."Bal. Account No.";
              GenJnlLine.Amount := TempComplWIPPostingBuffer[1].Amount;
              GenJnlLine.VALIDATE(Amount);
              GenJnlLine."Shortcut Dimension 1 Code" := TempComplWIPPostingBuffer[1]."Global Dimension 1 Code";
              GenJnlLine."Shortcut Dimension 2 Code" := TempComplWIPPostingBuffer[1]."Global Dimension 2 Code";
              GenJnlLine."Dimension Set ID" := TempComplWIPPostingBuffer[1]."Dimension Set ID";
              //GenJnlLine."Closed Project No." := TempComplWIPPostingBuffer[1]."Job No.";
              //GenJnlLine."Closed Service Order No." := TempComplWIPPostingBuffer[1]."Service Order No.";
              //GenJnlLine."Closed Service Contract No." := TempComplWIPPostingBuffer[1]."Service Contract No.";
              GenJnlLine."Origin Type" := TempComplWIPPostingBuffer[1]."Origin Type";
              RunGenJnlPostLine(GenJnlLine);

            UNTIL TempComplWIPPostingBuffer[1].NEXT = 0;
            TempComplWIPPostingBuffer[1].DELETEALL;
          END;
        //**4PS.en

        UNTIL SalesLine.NEXT = 0;
      END;

      SalesHeader2.COPY(SalesHeader);

      SalesHeader."No." := GenJnlLineDocNo;
      IF SalesLine.FINDSET THEN BEGIN
        REPEAT
          //IF (SalesLine.Type <> SalesLine.Type::" ") THEN BEGIN  //DP00847.o
          IF (SalesLine.Type <> SalesLine.Type::" ") AND (NOT (SalesLine."Plant Invoice" AND SalesLine.IsPlantService)) THEN BEGIN  //DP00847.n
            SalesLine."Qty. to Invoice" := -SalesLine."Qty. to Invoice";  // Necessary because this is done again in 'PostPlant'.
            SalesLine.Amount := -SalesLine.Amount;                        // Original amount is needed for invoice proposal!
            PostPlant(SalesHeader,SalesLine,FALSE,FALSE);
          END;
        UNTIL SalesLine.NEXT = 0;
      END;

      PostPlantRateComponentBuffer(SalesHeader);

      SalesHeader2.DELETE;
      SalesLine.DELETEALL;

      EXIT(TRUE);
    END;

    LOCAL PROCEDURE PostICEntry@1210190005(SalesHeader@1100525007 : Record 36;SalesLine@1100525006 : Record 37;IntercompanyRelation@1100525013 : Record 11012057;VAR IntercompanyEntry@1100525008 : Record 11012058);
    VAR
      ICJobSetUp@1210190001 : Record 315;
      GLSetupReceivingCompany@1100525009 : Record 98;
      lvGenJnlLineRec@1100485000 : Record 81;
      lvPostingSetup@1100525001 : Record 11020565;
      CostObjectRelation@1100529001 : Record 11020243;
      ICRec@1100525002 : Record 11012057;
      DimVal@1100525000 : Record 349;
      ProjectType@1100525011 : Record 11012009;
      ServiceType@1100525012 : Record 11012814;
      lvVendorPostingGroup@1100525010 : Code[20];
      lvICHoursPosting@1100525003 : 'NotApplicable,ReceiverSide,Supplierside';
      DepartmentIC@1100525004 : Code[20];
      CostObject@1100529000 : Code[20];
      NewLineNo@1100525005 : Integer;
    BEGIN
      //**4PS
      IF (SalesLine.Type = SalesLine.Type::" ") THEN
        EXIT;

      WITH IntercompanyEntry DO BEGIN
        LOCKTABLE;
        IF FINDLAST THEN
          NewLineNo := "Line No." + 1
        ELSE
          NewLineNo := 1;

        INIT;
        "Line No." := NewLineNo;
        //DP00847.sn
        CostObject := SalesLine."Shortcut Dimension 2 Code";
        IF SalesLine."Plant Invoice" THEN BEGIN
          IF SalesLine.IsPlantService THEN BEGIN
            // If Plant invoice Proposal is created in Service (Addidional Cost SO)
            IF SalesLine."Cost Object Cost Plus Line" <> '' THEN
              CostObject := SalesLine."Cost Object Cost Plus Line";
            JobSetUp.GET;
            IF JobSetUp."Use C.Obj. Rel. S-P Int.Charge" THEN
              CostObject := CostObjectRelation.ConvertCostObject(CostObject, SalesHeader."Company Name");
          END ELSE BEGIN
            //DP001505.sn
            PlantSetup.GET;
            IF PlantSetup."Use Cost Object Relation" THEN
              CostObject := CostObjectRelation.ConvertCostObject(CostObject, SalesHeader."Company Name");
            //DP001505.en
          END;
        END;
        //DP00847.en

        GLSetupReceivingCompany.CHANGECOMPANY(SalesHeader."Company Name");
        GLSetupReceivingCompany.GET;
        DimVal.CHANGECOMPANY(SalesHeader."Company Name");
        DimVal.GET(GLSetupReceivingCompany."Global Dimension 2 Code", CostObject);  //DP00847.n

        IF (SalesHeader."Company Name" <> COMPANYNAME) AND (SalesHeader."Company Name" <> '') THEN BEGIN
          IF lvPostingSetup.GET(SrcCode, COMPANYNAME, SalesHeader."Company Name") THEN BEGIN
            IF (lvPostingSetup."Prod. Account Credit" <> '') AND
               (lvPostingSetup."Prod. Account Debit" <> '') THEN
            BEGIN
              ICRec.GET(COMPANYNAME, SalesHeader."Company Name");
              lvVendorPostingGroup := ICRec."Vendor Posting Group";
              "Use IC Vendor Posting Group" := TRUE;
            END;
          END;
        END;

        DepartmentIC := SalesLine."Shortcut Dimension 1 Code";  //* C-026090.n
        IF SalesLine."Job No." <> '' THEN BEGIN
          ICJobSetUp.CHANGECOMPANY(SalesHeader."Company Name");
          Project.CHANGECOMPANY(SalesHeader."Company Name");
          ProjectType.CHANGECOMPANY(SalesHeader."Company Name");
          ICJobSetUp.GET;
          Project.GET(SalesLine."Job No.");
          ProjectType.GET(Project."Project Type");
          DepartmentIC := Project."Global Dimension 1 Code";  //* C-026090.n

          "Bal. Account No." :=
            ProjectType.GetWipAccByPostingGrp(
              Project."Project Type",
              DimVal."Cost Type",
              Project."Project Status",
              ICJobSetUp."Provisions at Closure",
              SalesHeader."Company Name",
              DimVal."Cost Type",
              '',
              lvICHoursPosting::ReceiverSide,
              lvVendorPostingGroup,
              '');
        END ELSE BEGIN
          IF SalesLine."Service Order No." <> '' THEN BEGIN
            ServiceOrder.CHANGECOMPANY(SalesHeader."Company Name");
            ServiceType.CHANGECOMPANY(SalesHeader."Company Name");
            ServiceOrder.GET(SalesLine."Service Order No.");
            IF SalesLine."Additional Cost (Service)" THEN
              ServiceType.Code := ServiceOrder."Service Type (Other)"
            ELSE
              ServiceType.Code := ServiceOrder."Service Type";
            ServiceType.GET(ServiceType.Code);
            DepartmentIC := ServiceOrder."Global Dimension 1 Code";  //* C-026090.n

            "Bal. Account No." :=
              ServiceType.GetWipAccByPostingGrp(
                ServiceType.Code,
                DimVal."Cost Type",
                SalesHeader."Company Name",
                DimVal."Cost Type",
                '',
                lvICHoursPosting::ReceiverSide,
                lvVendorPostingGroup,
                '');
          END;
        END;

        "Post in Company" := SalesHeader."Company Name";
        "Supplying Company" := COMPANYNAME;
        "Receiving Company" := SalesHeader."Company Name";
        "Origin Salary Application" := FALSE;
        "Account No." := IntercompanyRelation."Receiving Company IC Account";
        Description := SalesLine.Description;
        "Description 2" := SalesLine."Description 2";
        "Project No." := SalesLine."Job No.";
        Element := SalesLine.Element;
        "Extension Contract" := SalesLine."Extension Contract";
        IF NOT (SalesLine."Plant Invoice" AND SalesLine.IsPlantService) THEN BEGIN
          //If Plant invoice Proposal created in Service (Add. Cost SO) SO of salesline in Orig-SO in current/suppl. company
          "Service Order No." := SalesLine."Service Order No.";
          "Service Contract No." := SalesLine."Service Contract No.";
          "Service Location No." := SalesLine."Service Location No.";
          "Additional Cost (Service)" := SalesLine."Additional Cost (Service)";
        END;
        "Employee No." := SalesLine."Employee No.";
        "Cost Object" := CostObject;
        "Cost Component" := SalesLine."Cost Component";
        "Global Dimension 1 Code" := DepartmentIC;
        Quantity := SalesLine.Quantity;
        "Unit of Measure Code"  := SalesLine."Unit of Measure Code";
        //DP02206.sn
        Amount := SalesLine."Amount Including VAT";
        IF Quantity <> 0 THEN
          Price := Amount / Quantity
        ELSE
          Price := Amount;
        //DP02206.en
        "Document No." := GenJnlLineDocNo;
        "Posting Date" := SalesHeader."Posting Date";
        "Interest Date" := SalesHeader."Interest Date";
        IF "Interest Date" = 0D THEN
          "Interest Date" := "Posting Date";
        //Type must be Purchase, because receiving company so exactly the opposite.
        "Gen. Posting Type" := "Gen. Posting Type"::Purchase;
        IF CheckSalesLineBuyBackItemPO(SalesLine) THEN BEGIN
          lvGenJnlLineRec."Account No." := SalesLine."No.";
          lvGenJnlLineRec."Gen. Posting Type" := lvGenJnlLineRec."Gen. Posting Type"::Sale;
          CheckBuyBackGenPostTypPurchase(lvGenJnlLineRec);
          IF lvGenJnlLineRec."Gen. Posting Type" = lvGenJnlLineRec."Gen. Posting Type"::Purchase THEN
            "Gen. Posting Type" := "Gen. Posting Type"::Sale;
        END;
        "Gen. Bus. Posting Group" := SalesLine."Gen. Bus. Posting Group";
        "Gen. Prod. Posting Group" := SalesLine."Gen. Prod. Posting Group";
        "VAT Bus. Posting Group" := SalesLine."VAT Bus. Posting Group";
        "VAT Prod. Posting Group" := SalesLine."VAT Prod. Posting Group";
        "Rental Period" := SalesLine."Rental Period";
        "Plant Invoice" := SalesHeader."Plant Invoice";
        "Rental Period to Date" := SalesHeader."Rental Period to Date";
        "Item No." := SalesLine."Item No.";
        "Basic Item" := SalesLine."Basic Item";
        "Trade Item" := SalesLine."Trade Item";
        Manufacturer := SalesLine.Manufacturer;
        "Vendor (Trade Item)" := SalesLine."Vendor (Trade Item)";

        TESTFIELD("Account No.");
        TESTFIELD("Bal. Account No.");
        IF ("Project No." <> '') OR ("Service Order No." <> '') THEN
          TESTFIELD("Cost Object");

        IF "Project No." <> '' THEN BEGIN
          CheckProjStatusReceivingComp;
          CheckProjElemBlockedRecComp;
        END;
        IF "Service Order No." <> '' THEN
          CheckServOrderStatusReceivComp;

        IF "Global Dimension 1 Code" <> '' THEN
          VALIDATE("Global Dimension 1 Code" );

        IF "Cost Object" <> '' THEN
          VALIDATE("Cost Object");

        AddICRelationDims(IntercompanyRelation);

        INSERT(TRUE);
        "Currency Code" := GLSetup.GetCurrencyCode(SalesLine."Currency Code");  //DP02206
        MODIFY;
      END;
    END;

    LOCAL PROCEDURE PostGLEntry@1210190004(SalesHeader@1100525001 : Record 36;SalesLine@1100525000 : Record 37;IntercompanyRelation@1100525003 : Record 11012057;VAR GenJnlLine@1100525002 : Record 81);
    VAR
      DummyServLine@1100525004 : Record 11012820;
    BEGIN
      //**4PS
      IF (SalesLine.Type = SalesLine.Type::" ") THEN
        EXIT;

      WITH GenJnlLine DO BEGIN
        INIT;
        "Document No." := GenJnlLineDocNo;
        "Reason Code" := SalesHeader."Reason Code";
        "Source Code" := SrcCode;
        "Account Type" := "Account Type"::"G/L Account";
        "System-Created Entry" := TRUE;

        "Posting Date" := SalesHeader."Posting Date";
        "Interest Date" := SalesHeader."Interest Date";
        //DP00847.sn
        IF SalesLine."Plant Invoice" AND SalesLine.IsPlantService THEN BEGIN
          // If Plant invoice Proposal created in Service (Add. Cost SO) SO of salesline is Orig-SO in current/suppl company.
          // Service Order Number needed if WIP-acc
          "Service Order No." := SalesLine."Service Order No.";
          GetServiceCategory;
          "Service Contract No." := SalesLine."Service Contract No.";
          "Service Location No." := SalesLine."Service Location No.";
          "Additional Cost (Service)" := SalesLine."Additional Cost (Service)";  //db, 24-11-05
        END;
        //DP00847.en
        "Plant Invoice" := SalesLine."Plant Invoice";
        "Account No." := SalesLine."No.";
         VALIDATE("Account No.");
        IF (IntercompanyRelation."Receiving Company" <> '') AND
           (IntercompanyRelation."Receiving Company" <> COMPANYNAME)
        THEN BEGIN
          "Receiving Company" := IntercompanyRelation."Receiving Company";
          "Intercompany Transaction" := TRUE;
        END;
        IF (IntercompanyRelation."Supplying Company" <> '') AND
           (IntercompanyRelation."Supplying Company" <> COMPANYNAME)
        THEN BEGIN
          "Supplying Company" := IntercompanyRelation."Supplying Company";
          "Intercompany Transaction" := TRUE;
        END;
        "Gen. Prod. Posting Group" := SalesLine."Gen. Prod. Posting Group";
        "Gen. Bus. Posting Group" := SalesLine."Gen. Bus. Posting Group";
        "VAT Prod. Posting Group" := SalesLine."VAT Prod. Posting Group";
        "VAT Bus. Posting Group" := SalesLine."VAT Bus. Posting Group";
        "VAT Calculation Type" := SalesLine."VAT Calculation Type";
        "Gen. Posting Type" := GenJnlLine."Gen. Posting Type"::Sale;
        IF CheckSalesLineBuyBackItemPO(SalesLine) THEN
          CheckBuyBackGenPostTypPurchase(GenJnlLine);
        "Bal. Account Type" :=  "Bal. Account Type"::"G/L Account";
        "Bal. Account No." := IntercompanyRelation.GetICAccountOfCurrentCompany;
        VALIDATE("Bal. Account No.");
        "Bal. Gen. Prod. Posting Group" := '';
        "Bal. Gen. Bus. Posting Group" := '';
        "Bal. VAT Prod. Posting Group" := '';
        "Bal. VAT Bus. Posting Group" := '';
        "Bal. Gen. Posting Type" := 0;
        Description := SalesLine.Description;
        "Description 2" := SalesLine."Description 2";  //**4PS01.n
        Amount := SalesLine."Amount Including VAT" * -1;
        "Posting No. Series" := NoSeriesCde;
        VALIDATE(Amount);
        "Alternative Bill-to Address" := SalesHeader."Alternative Bill-to Address";
        "Shortcut Dimension 1 Code" := SalesLine."Shortcut Dimension 1 Code";
        "Shortcut Dimension 2 Code" := SalesLine."Shortcut Dimension 2 Code";
        "Dimension Set ID" := SalesLine."Dimension Set ID";

        //T007402.sn
        IntercompanyRelation.AddICRelationDimsOfCurrentCompany("Dimension Set ID","Shortcut Dimension 1 Code","Shortcut Dimension 2 Code");
        //T007402.en

        GenJnlPostLine.RunWithCheck(GenJnlLine);

        IF (SalesHeader."Company Name" <> COMPANYNAME) AND
           (SalesHeader."Company Name" <> '')
        THEN
          PostComplWipProjectServPlantIC(SalesHeader,SalesLine,GenJnlLine);
      END;

      IF SalesLine."Plant Invoice" AND SalesLine.IsPlantService THEN  //DP00847
        PostService(SalesHeader,SalesLine,DummyServLine);
    END;

    LOCAL PROCEDURE PostSurchargeICPlant@1100525000(SalesHeader@1100525007 : Record 36;SalesLine@1100525004 : Record 37;IntercompanyEntry@1100525005 : Record 11012058);
    VAR
      ICRec@1100525000 : Record 11012057;
      lvPostingSetup@1100525003 : Record 11020565;
      DimVal@1100525006 : Record 349;
      SurchDimVal@1100525009 : Record 349;
      OverheadSurcharge@1100525008 : Record 11020208;
      JobJnlLine@1100525010 : Record 11072008;
      ServJnlLine@1100525012 : Record 11012820;
      DimMgt@1100525011 : Codeunit 408;
      lvType@1210190008 : Code[20];
      lvOrigDim1@1210190007 : Code[20];
      lvOrigDim2@1210190006 : Code[20];
      lvDim1@1210190005 : Code[20];
      lvDim2@1210190004 : Code[20];
      lvAccount@1210190003 : Code[20];
      lvDesc@1210190002 : Text[100];
      lvCostTotal@1210190001 : Decimal;
      lvcostComp@1100485001 : Code[20];
      lvTotSurchAmount@1100485002 : Decimal;
      Origin@1100525001 : 'Project,Service,Indirect,InterCompany';
      lvSourceType@1100525002 : 'Fixed,EmplOrFixed';
      DimSetID@1100409000 : Integer;
    BEGIN
      //**4PS
      //For IC postings the surcharges at supplying company should also be calculated and an IC posting created.
      //The surcharges will be posted as definied in the chart of accounts.
      IF (SalesLine.Type = SalesLine.Type::" ") THEN
        EXIT;

      IF IntercompanyEntry."Project No." <> '' THEN
        Origin := Origin::Project
      ELSE BEGIN
        IF (IntercompanyEntry."Service Order No." <> '') THEN
          Origin := Origin::Service
        ELSE
          EXIT;
      END;

      GLSetup.GET;

      ICRec.GET(COMPANYNAME, IntercompanyEntry."Receiving Company");

      CASE Origin OF
        Origin::Project:
          BEGIN
            Project.GET(IntercompanyEntry."Project No.");
            lvType := Project."Project Type";
            lvOrigDim1 := Project."Global Dimension 1 Code";
          END;
        Origin::Service:
          BEGIN
            ServiceOrder.GET(IntercompanyEntry."Service Order No.");
            IF IntercompanyEntry."Additional Cost (Service)" THEN
              lvType := ServiceOrder."Service Type (Other)"
            ELSE
              lvType := ServiceOrder."Service Type";
            lvOrigDim1 := ServiceOrder."Global Dimension 1 Code";
          END;
      END;

      lvOrigDim2 := IntercompanyEntry."Cost Object";
      DimVal.CHANGECOMPANY(SalesHeader."Company Name");
      DimVal.GET(GLSetup."Global Dimension 2 Code", lvOrigDim2);

      IF OverheadSurcharge.GetSurchargesIC(
        Origin::InterCompany, lvType, IntercompanyEntry."Project No.",
        FALSE, DimVal."Cost Type", DimVal.Code, '',
        lvOrigDim1, '', IntercompanyEntry."Cost Component",
        IntercompanyEntry."Posting Date",
        OverheadSurcharge, COMPANYNAME, lvSourceType::Fixed) THEN
      BEGIN
        REPEAT
          OverheadSurcharge.GetSurchargeDimVal(DimVal,SurchDimVal);
          OverheadSurcharge.TESTFIELD("Coverage Account");

          CASE Origin OF
            Origin::Project:
              BEGIN
                JobJnlLine."Job No." := IntercompanyEntry."Project No.";
                JobJnlLine."Total Cost (LCY)" := IntercompanyEntry.Amount;
                JobJnlLine.Quantity := IntercompanyEntry.Quantity;

                JobJnlLine.InitSurchargeIC(
                  JobJnlLine, DimVal, SurchDimVal, OverheadSurcharge, lvOrigDim1, lvType,
                  lvTotSurchAmount, IntercompanyEntry."Receiving Company");

                lvcostComp := JobJnlLine."Cost Component";
                lvDesc := JobJnlLine.Description;
                lvCostTotal := JobJnlLine."Total Cost (LCY)";
                lvAccount:= JobJnlLine."No.";

                lvDim1 := JobJnlLine."Shortcut Dimension 1 Code";
                lvDim2 := JobJnlLine."Shortcut Dimension 2 Code";
                JobJnlLine."Dimension Set ID" := SalesLine."Dimension Set ID";
                DimMgt.ValidateShortcutDimValues(1,lvDim1,JobJnlLine."Dimension Set ID");
                DimMgt.ValidateShortcutDimValues(2,lvDim2,JobJnlLine."Dimension Set ID");
                DimSetID := JobJnlLine."Dimension Set ID";
              END;
            Origin::Service:
              BEGIN
                ServJnlLine.VALIDATE("Service Order No.", IntercompanyEntry."Service Order No.");
                ServJnlLine."Total Cost (LCY)" := IntercompanyEntry.Amount;
                ServJnlLine.Quantity := IntercompanyEntry.Quantity;

                ServJnlLine.InitSurchargeIC(
                  ServJnlLine, DimVal, SurchDimVal, OverheadSurcharge, lvOrigDim1,
                  lvType, lvTotSurchAmount, IntercompanyEntry."Receiving Company");

                lvcostComp := ServJnlLine."Cost Component";
                lvDesc := ServJnlLine.Description;
                lvCostTotal := ServJnlLine."Total Cost (LCY)";
                lvAccount:= ServJnlLine."G/L Account";

                lvDim1 := ServJnlLine."Shortcut Dimension 1 Code";
                lvDim2 := ServJnlLine."Shortcut Dimension 2 Code";
                ServJnlLine."Dimension Set ID" := SalesLine."Dimension Set ID";
                DimMgt.ValidateShortcutDimValues(1,lvDim1,ServJnlLine."Dimension Set ID");
                DimMgt.ValidateShortcutDimValues(2,lvDim2,ServJnlLine."Dimension Set ID");
                DimSetID := ServJnlLine."Dimension Set ID";
              END;
          END;

          CLEAR(TempSurchargePostingBuffer[1]);

          //T007402.sn
          ICRec.AddICRelationDimsOfCurrentCompany(DimSetID,lvDim1,lvDim2);
          //T007402.en

          //Post Debit Line
          TempSurchargePostingBuffer[1]."Receiving Company" := IntercompanyEntry."Receiving Company";
          TempSurchargePostingBuffer[1]."G/L Account" := lvAccount;
          TempSurchargePostingBuffer[1]."Global Dimension 1 Code" := lvDim1;
          TempSurchargePostingBuffer[1]."Global Dimension 2 Code" := lvDim2;
          TempSurchargePostingBuffer[1]."Dimension Set ID" := DimSetID;

          TempSurchargePostingBuffer[1]."Cost Component" := lvcostComp;
          TempSurchargePostingBuffer[1]."Job No." := IntercompanyEntry."Project No.";
          IF (IntercompanyEntry."Project No." <> '') AND (OverheadSurcharge."Element Surcharge" <> '') THEN
            TempSurchargePostingBuffer[1].Element := OverheadSurcharge."Element Surcharge"
          ELSE
            TempSurchargePostingBuffer[1].Element := IntercompanyEntry.Element;
          TempSurchargePostingBuffer[1]."Bal. Account No." := TempSurchargePostingBuffer[1].Element; // Because element not in key
          TempSurchargePostingBuffer[1]."Service Order No." := IntercompanyEntry."Service Order No.";
          TempSurchargePostingBuffer[1]."Service Contract No." := IntercompanyEntry."Service Contract No.";
          TempSurchargePostingBuffer[1]."Service Order No." := IntercompanyEntry."Service Order No.";
          TempSurchargePostingBuffer[1].Description := lvDesc;
          TempSurchargePostingBuffer[1].Amount := lvCostTotal;
          CASE Origin OF
            Origin::Project:
              TempSurchargePostingBuffer[1]."Origin Type" := TempSurchargePostingBuffer[1]."Origin Type"::Project;
            Origin::Service:
              TempSurchargePostingBuffer[1]."Origin Type" := TempSurchargePostingBuffer[1]."Origin Type"::Service;
          END;
          TempSurchargePostingBuffer[1]."Tax Area Code" := IntercompanyEntry."Document No.";
          UpdateSurchargeBuffer;

          IF lvPostingSetup.GET(SrcCode, COMPANYNAME, IntercompanyEntry."Receiving Company") THEN BEGIN
            lvPostingSetup.TESTFIELD("Prod. Account Credit");
            lvPostingSetup.TESTFIELD("Prod. Account Debit");
            PostComplWIPSurchargeIC(lvPostingSetup."Prod. Account Credit", lvPostingSetup."Prod. Account Debit");
          END;

          //Post Credit Line
          TempSurchargePostingBuffer[1]."G/L Account" := OverheadSurcharge."Coverage Account";
          TempSurchargePostingBuffer[1]."Global Dimension 1 Code" := '';
          CASE OverheadSurcharge."Source Type Department" OF
            OverheadSurcharge."Source Type Department"::Employee:;
              //Impossible
            OverheadSurcharge."Source Type Department"::Job:
              TempSurchargePostingBuffer[1]."Global Dimension 1 Code" := lvDim1;
            OverheadSurcharge."Source Type Department"::Fixed:
              TempSurchargePostingBuffer[1]."Global Dimension 1 Code" := OverheadSurcharge."Coverage Department"
          END;
          TempSurchargePostingBuffer[1]."Global Dimension 2 Code" := lvDim2;
          TempSurchargePostingBuffer[1]."Dimension Set ID" := DimSetID;
          DimMgt.ValidateShortcutDimValues(1,TempSurchargePostingBuffer[1]."Global Dimension 1 Code",TempSurchargePostingBuffer[1]."Dimension Set ID");


          IF OverheadSurcharge."Compress Coverage Posting" THEN BEGIN
            TempSurchargePostingBuffer[1]."Cost Component" := '';
            TempSurchargePostingBuffer[1]."Job No." := '';
            TempSurchargePostingBuffer[1].Element := '';
            //TempSurchargePostingBuffer[1]."Bal. Account No." := TempSurchargePostingBuffer[1].Element; // Because element not in key
            TempSurchargePostingBuffer[1]."Service Order No." := '';
            TempSurchargePostingBuffer[1]."Service Contract No." := '';
          END ELSE BEGIN
            TempSurchargePostingBuffer[1]."Buy-Back Item (Plant Order)" := TRUE;   // FIELD USED FOR OTHER PURPOSE
          END;

          TempSurchargePostingBuffer[1].Amount := lvCostTotal * -1;
          TempSurchargePostingBuffer[1]."Origin Type" := TempSurchargePostingBuffer[1]."Origin Type"::" ";
          UpdateSurchargeBuffer;

        UNTIL OverheadSurcharge.NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE PostICEntrySurcharge@1100525006(SalesHeader@1100525006 : Record 36;SalesLine@1100525005 : Record 37;IntercompanyRelation@1100525012 : Record 11012057);
    VAR
      ICJobSetUp@1210190001 : Record 315;
      GLSetupReceivingCompany@1100525008 : Record 98;
      lvGenJnlLineRec@1100485000 : Record 81;
      IntercompanyEntry@1100525007 : Record 11012058;
      DimVal@1100525009 : Record 349;
      ProjectType@1100525010 : Record 11012009;
      ServiceType@1100525011 : Record 11012814;
      lvVendorPostingGroup@1100525002 : Code[20];
      ICRec@1100525001 : Record 11012057;
      lvICHoursPosting@1100525000 : 'NotApplicable,ReceiverSide,Supplierside';
      lvPostingSetup@1100525003 : Record 11020565;
      NewLineNo@1100525004 : Integer;
    BEGIN
      //**4PS
      IF (SalesLine.Type = SalesLine.Type::" ") THEN
        EXIT;

      WITH IntercompanyEntry DO BEGIN
        LOCKTABLE;
        IF FINDLAST THEN
          NewLineNo := "Line No." + 1
        ELSE
          NewLineNo := 1;

        INIT;
        "Line No." := NewLineNo;
        GLSetupReceivingCompany.CHANGECOMPANY(SalesHeader."Company Name");
        GLSetupReceivingCompany.GET;
        DimVal.CHANGECOMPANY(SalesHeader."Company Name");
        DimVal.GET(GLSetupReceivingCompany."Global Dimension 2 Code",SalesLine."Shortcut Dimension 2 Code");

        IF (SalesHeader."Company Name" <> COMPANYNAME) AND (SalesHeader."Company Name" <> '') THEN BEGIN
          IF lvPostingSetup.GET(SrcCode, COMPANYNAME, SalesHeader."Company Name") THEN BEGIN
            IF (lvPostingSetup."Prod. Account Credit" <> '') AND
               (lvPostingSetup."Prod. Account Debit" <> '')
            THEN BEGIN
              ICRec.GET(COMPANYNAME, SalesHeader."Company Name");
              lvVendorPostingGroup := ICRec."Vendor Posting Group";
              "Use IC Vendor Posting Group" := TRUE;
            END;
          END;
        END;

        IF TempSurchargePostingBuffer[1]."Job No." <> '' THEN BEGIN
          ICJobSetUp.CHANGECOMPANY(SalesHeader."Company Name");
          Project.CHANGECOMPANY(SalesHeader."Company Name");
          ProjectType.CHANGECOMPANY(SalesHeader."Company Name");
          ICJobSetUp.GET;
          Project.GET(SalesLine."Job No.");
          ProjectType.GET(Project."Project Type");

          "Bal. Account No." :=
            ProjectType.GetWipAccByPostingGrp(
              Project."Project Type",
              DimVal."Cost Type",
              Project."Project Status",
              ICJobSetUp."Provisions at Closure",
              SalesHeader."Company Name",
              DimVal."Cost Type",
              '',
              lvICHoursPosting::ReceiverSide,
              lvVendorPostingGroup,
              '');
        END ELSE BEGIN
          IF TempSurchargePostingBuffer[1]."Service Order No." <> '' THEN BEGIN
            ServiceOrder.CHANGECOMPANY(SalesHeader."Company Name");
            ServiceType.CHANGECOMPANY(SalesHeader."Company Name");
            ServiceOrder.GET(SalesLine."Service Order No.");
            IF SalesLine."Additional Cost (Service)" THEN
              ServiceType.Code := ServiceOrder."Service Type (Other)"
            ELSE
              ServiceType.Code := ServiceOrder."Service Type";
            ServiceType.GET(ServiceType.Code);

            "Bal. Account No." :=
              ServiceType.GetWipAccByPostingGrp(
                ServiceType.Code,
                DimVal."Cost Type",
                SalesHeader."Company Name",
                DimVal."Cost Type",
                '',
                lvICHoursPosting::ReceiverSide,
                lvVendorPostingGroup,
                '');
          END;
        END;

        "Account No." := IntercompanyRelation."Receiving Company IC Account";
        "Post in Company" := SalesHeader."Company Name";
        "Supplying Company" := COMPANYNAME;
        "Receiving Company" := SalesHeader."Company Name";
        "Origin Salary Application" := FALSE;

        Description := TempSurchargePostingBuffer[1].Description;
        "Description 2" := TempSurchargePostingBuffer[1]."Description 2";  //**4PS01.n
        "Project No." := SalesLine."Job No.";
        Element := SalesLine.Element;
        "Extension Contract" := SalesLine."Extension Contract";
        "Service Order No." := SalesLine."Service Order No.";
        "Service Contract No." := SalesLine."Service Contract No.";
        "Service Location No." := SalesLine."Service Location No.";
        "Additional Cost (Service)" := SalesLine."Additional Cost (Service)";  //db, 24-11-05
        "Employee No." := SalesLine."Employee No.";
        "Cost Object" := TempSurchargePostingBuffer[1]."Global Dimension 2 Code";
        "Cost Component" := TempSurchargePostingBuffer[1]."Cost Component";
        "Global Dimension 1 Code" := TempSurchargePostingBuffer[1]."Global Dimension 1 Code";
        "Dimension Set ID" := SalesLine."Dimension Set ID";    //DP00387 new

        Quantity := TempSurchargePostingBuffer[1].Quantity;
        "Unit of Measure Code"  := SalesLine."Unit of Measure Code";
        IF SalesLine.Quantity <> 0 THEN
          Price := TempSurchargePostingBuffer[1].Amount / SalesLine.Quantity
        ELSE
          Price := TempSurchargePostingBuffer[1].Amount;
        Amount := TempSurchargePostingBuffer[1].Amount;
        "Document No." := GenJnlLineDocNo;
        "Posting Date" := SalesHeader."Posting Date";
        "Interest Date" := SalesHeader."Interest Date";
        //Type must be Purchase, because receiving company so exactly the opposite.
        "Gen. Posting Type" := "Gen. Posting Type"::Purchase;
        IF CheckSalesLineBuyBackItemPO(SalesLine) THEN BEGIN
          lvGenJnlLineRec."Account No." := SalesLine."No.";
          lvGenJnlLineRec."Gen. Posting Type" := lvGenJnlLineRec."Gen. Posting Type"::Sale;
          CheckBuyBackGenPostTypPurchase(lvGenJnlLineRec);
          IF lvGenJnlLineRec."Gen. Posting Type" = lvGenJnlLineRec."Gen. Posting Type"::Purchase THEN
            "Gen. Posting Type" := "Gen. Posting Type"::Sale;
        END;
        "Gen. Bus. Posting Group" := SalesLine."Gen. Bus. Posting Group";
        "Gen. Prod. Posting Group" := SalesLine."Gen. Prod. Posting Group";
        "VAT Bus. Posting Group" := SalesLine."VAT Bus. Posting Group";
        "VAT Prod. Posting Group" := SalesLine."VAT Prod. Posting Group";
        "Rental Period" := SalesLine."Rental Period";
        "Plant Invoice" := SalesHeader."Plant Invoice";
        "Rental Period to Date" := SalesHeader."Rental Period to Date";
        "Item No." := SalesLine."Item No.";
        "Basic Item" := SalesLine."Basic Item";
        "Trade Item" := SalesLine."Trade Item";
        Manufacturer := SalesLine.Manufacturer;
        "Vendor (Trade Item)" := SalesLine."Vendor (Trade Item)";

        TESTFIELD("Account No.");
        TESTFIELD("Bal. Account No.");
        IF ("Project No." <> '') OR ("Service Order No." <> '') THEN
          TESTFIELD("Cost Object");

        IF "Project No." <> '' THEN BEGIN
          CheckProjStatusReceivingComp;
          CheckProjElemBlockedRecComp;
        END;
        IF "Service Order No." <> '' THEN
          CheckServOrderStatusReceivComp;

        Surcharge := TRUE;

        UpdateDimension(1); //** DP00387 new
        UpdateDimension(2); //** DP00387 new
        AddICRelationDims(IntercompanyRelation);

        INSERT(TRUE);
      END;
    END;

    LOCAL PROCEDURE PostComplWipProjectServPlantIC@1100525004(SalesHeader@1100525005 : Record 36;SalesLine@1100525000 : Record 37;GenJnlLine@1100525001 : Record 81);
    VAR
      lvPostingSetup@1100525002 : Record 11020565;
      ProjectType@1100525003 : Record 11012009;
      ServiceType@1100525004 : Record 11012814;
    BEGIN
      //**4PS
      //* For plant locations with a project or a serviceorder
      IF (SalesLine."Job No." = '') AND (SalesLine."Service Order No." = '') THEN
        EXIT;
      IF GenJnlLine.Amount = 0 THEN
        EXIT;

      IF (SalesLine."Job No." <> '') THEN BEGIN
        IF NOT ProjectType."Post Complementary Costs" THEN
          EXIT;
      END ELSE BEGIN
        IF (SalesLine."Service Order No." <> '') THEN BEGIN
          IF NOT ServiceType."Post Complementary Costs" THEN
            EXIT;
        END;
      END;
      IF NOT lvPostingSetup.GET(GenJnlLine."Source Code", COMPANYNAME, SalesHeader."Company Name") THEN
        EXIT;

      CLEAR(TempComplWIPPostingBuffer[1]);

      IF lvPostingSetup.GET(GenJnlLine."Source Code", COMPANYNAME, SalesHeader."Company Name") THEN BEGIN
        lvPostingSetup.TESTFIELD("Prod. Account Debit");
        TempComplWIPPostingBuffer[1]."G/L Account" := lvPostingSetup."Prod. Account Debit";

        lvPostingSetup.TESTFIELD("Prod. Account Credit");
        TempComplWIPPostingBuffer[1]."Bal. Account No." := lvPostingSetup."Prod. Account Credit";
      END;

      TempComplWIPPostingBuffer[1].Amount := GenJnlLine.Amount;
      TempComplWIPPostingBuffer[1].Description := SalesHeader."Posting Description";
      TempComplWIPPostingBuffer[1]."Job No." :=  SalesLine."Job No.";
      TempComplWIPPostingBuffer[1]."Service Order No." :=  SalesLine."Service Order No.";
      TempComplWIPPostingBuffer[1]."Service Contract No." :=  SalesLine."Service Contract No.";
      TempComplWIPPostingBuffer[1]."Global Dimension 1 Code" := GenJnlLine."Shortcut Dimension 1 Code";
      TempComplWIPPostingBuffer[1]."Global Dimension 2 Code" := GenJnlLine."Shortcut Dimension 2 Code";
      TempComplWIPPostingBuffer[1]."Dimension Set ID" := GenJnlLine."Dimension Set ID";

      UpdateComplWIPPostingBuffer;
    END;

    LOCAL PROCEDURE InsertSalesInvoiceHeaderFromIC@1210190008(SalesHeader@1100525000 : Record 36);
    BEGIN
      //**4PS
      SalesInvHeader.INIT;
      SalesInvHeader.TRANSFERFIELDS(SalesHeader);
      SalesInvHeader."No." := GenJnlLineDocNo;
      SalesInvHeader."No. Series" := NoSeriesCde;
      SalesInvHeader."Source Code" := SrcCode;
      SalesInvHeader."User ID" := USERID;
      SalesInvHeader."No. Printed" := 0;
      IF SalesInvHeader."Pre-Assigned No. Series" <> '' THEN
        SalesInvHeader."Pre-Assigned No." := SalesHeader."No.";
      SalesInvHeader.INSERT;
    END;

    LOCAL PROCEDURE InsertSalesCrMemHeaderFromIC@1210190009(SalesHeader@1100525000 : Record 36);
    BEGIN
      //**4PS
      SalesCrMemoHeader.INIT;
      SalesCrMemoHeader.TRANSFERFIELDS(SalesHeader);
      SalesCrMemoHeader."Inserted By" := SalesHeader."Inserted By";
      SalesCrMemoHeader."No." := GenJnlLineDocNo;
      SalesCrMemoHeader."No. Series" := NoSeriesCde;
      SalesCrMemoHeader."Source Code" := SrcCode;
      SalesCrMemoHeader."User ID" := USERID;
      SalesCrMemoHeader."No. Printed" := 0;
      IF SalesCrMemoHeader."Pre-Assigned No. Series" <> '' THEN
        SalesCrMemoHeader."Pre-Assigned No." := SalesHeader."No.";
      SalesCrMemoHeader.INSERT;
    END;

    LOCAL PROCEDURE InsertSalesInvoiceLinesFromIC@1210190006(SalesLine@1100525001 : Record 37);
    VAR
      SalesInvLine@1100525000 : Record 113;
    BEGIN
      //**4PS
      SalesInvLine.INIT;
      SalesInvLine.TRANSFERFIELDS(SalesLine);
      SalesInvLine."Document No." := SalesInvHeader."No.";
      SalesInvLine.INSERT;
    END;

    LOCAL PROCEDURE InsertSalesCrMemLinesFromIC@1210190003(SalesLine@1100525001 : Record 37);
    VAR
      SalesCrMemoLine@1100525000 : Record 115;
    BEGIN
      //**4PS
      IF (SalesLine.Type <> SalesLine.Type::" ") THEN BEGIN
        IF SalesLine."Number of Time Units" < 0 THEN BEGIN
          SalesLine."Number of Time Units" := -SalesLine."Number of Time Units";
          IF (SalesLine."Unit Price" <> 0) THEN  //*C-026092
            SalesLine.VALIDATE("Line Amount", -SalesLine."Line Amount");
        END ELSE BEGIN
          IF SalesLine.Quantity < 0 THEN
            SalesLine.VALIDATE(Quantity, -SalesLine.Quantity)
          ELSE
            SalesLine.VALIDATE("Unit Price", -SalesLine."Unit Price");
        END;
      END;

      SalesCrMemoLine.INIT;
      SalesCrMemoLine.TRANSFERFIELDS(SalesLine);
      SalesCrMemoLine."Document No." := SalesCrMemoHeader."No.";
      SalesCrMemoLine.INSERT;
    END;

    LOCAL PROCEDURE CheckManualRentalUnitInvoice@1210190007(SalesHeader@1100525000 : Record 36);
    VAR
      lvSalesLineRec@1210190000 : Record 37;
      lvRentalUnitRec@1210190001 : Record 11012940;
      lvText001@1210190002 : TextConst 'ENU=is not present;NOR=finnes ikke;SVE=finns inte';
    BEGIN
      //**4PS
      // All or none Rental Unit lines on a manual invoice (for a generated Rental Unit Invoice checks not needed).

      IF SalesHeader."Rental Unit Invoice" THEN
        EXIT;

      lvSalesLineRec.SETRANGE("Document Type", SalesHeader."Document Type");
      lvSalesLineRec.SETRANGE("Document No.", SalesHeader."No.");
      lvSalesLineRec.SETRANGE("Rental Unit Invoice", TRUE);
      IF NOT lvSalesLineRec.FINDFIRST THEN
        EXIT;

      SetRentalUnitInvoice := TRUE;
      RentalUnitProjectNo := lvSalesLineRec."Job No.";

      lvSalesLineRec.RESET;
      lvSalesLineRec.SETRANGE("Document Type", SalesHeader."Document Type");
      lvSalesLineRec.SETRANGE("Document No.", SalesHeader."No.");
      lvSalesLineRec.SETFILTER(Type, '<>%1', lvSalesLineRec.Type::" ");
      IF lvSalesLineRec.FINDSET THEN BEGIN
        REPEAT
          lvSalesLineRec.TESTFIELD("Rental Unit");
          lvRentalUnitRec.SETRANGE("Project No.", lvSalesLineRec."Job No.");
          lvRentalUnitRec.SETRANGE("Rental Unit", lvSalesLineRec."Rental Unit");
          IF NOT lvRentalUnitRec.FINDFIRST THEN
            lvSalesLineRec.FIELDERROR("Rental Unit",lvText001);
          lvSalesLineRec.TESTFIELD("Job No.", RentalUnitProjectNo);  // All Rental Unit invoice lines must have the same project
        UNTIL lvSalesLineRec.NEXT = 0;
      END;

      SalesHeader."Rental Unit Invoice" := TRUE;
    END;

    LOCAL PROCEDURE UpdateBAmountOnPostedHeaders@1100525021(SalesHeader@1100525000 : Record 36);
    VAR
      GenJnlLine@1100525001 : Record 81;
    BEGIN
      //**4PS C040380
      CASE GenJnlLineDocType OF
        GenJnlLine."Document Type"::Invoice:
          BEGIN
            CalcBAmountInvoice(SalesHeader,SalesInvHeader);
            SalesInvHeader.MODIFY;
          END;
        GenJnlLine."Document Type"::"Credit Memo":
          BEGIN
            CalcBAmountCrMemo(SalesCrMemoHeader);
            SalesCrMemoHeader.MODIFY;
          END;
      END;
    END;

    LOCAL PROCEDURE CalcBAmountInvoice@1210190013(SalesHeader@1100525000 : Record 36;VAR lSalesInvHeader@1210190011 : Record 112);
    VAR
      lSalesInvLine@1210190000 : Record 113;
      DimVal@1210190010 : Record 349;
      DimMgt@1100525001 : Codeunit 408;
      lInvAmntPerc@1210190009 : Decimal;
      lInvAmntLabor@1210190008 : Decimal;
    BEGIN
      //**4PS
      WITH lSalesInvHeader DO BEGIN
        "Labor Amount (Subcontracting)" := 0;
        "Blocked Amount (Subcontracting" := 0;
        IF ("Plant Invoice" AND NOT ChargeSOToJobPlantLoc(SalesHeader) AND NOT ChargeSOToCustomerPlantLoc(SalesHeader)) THEN  //DP00195
          EXIT;

        lSalesInvLine.SETRANGE("Document No.", "No.");
        lSalesInvLine.SETFILTER(Type,'<>%1',lSalesInvLine.Type::" ");
        lSalesInvLine.SETRANGE("VAT Calculation Type", lSalesInvLine."VAT Calculation Type"::"Reverse Charge VAT");
        IF lSalesInvLine.FINDSET THEN
          REPEAT
            //Determine Amounts
            lInvAmntPerc := 0;
            lInvAmntLabor := 0;
            IF "Installment Invoice" OR
               (NOT "Installment Invoice" AND
               ("Calculate B Amounts based on" = "Calculate B Amounts based on"::"Invoice Amount"))
            THEN
              lInvAmntPerc := lInvAmntPerc + lSalesInvLine."Amount Including VAT"
            ELSE
              IF (lSalesInvLine."Cost Plus Line No." <> 0) THEN BEGIN
                IF (lSalesInvLine."Cost Type Cost Plus Line" = lSalesInvLine."Cost Type Cost Plus Line"::Labor) THEN BEGIN
                  lInvAmntLabor := lInvAmntLabor + lSalesInvLine."Amount Including VAT";
                END ELSE BEGIN
                  IF (lSalesInvLine."Cost Type Cost Plus Line" = lSalesInvLine."Cost Type Cost Plus Line"::Revenue) THEN
                    lInvAmntPerc := lInvAmntPerc + lSalesInvLine."Amount Including VAT";
                END;
              END ELSE BEGIN
                IF lSalesInvLine."Shortcut Dimension 2 Code" <> '' THEN BEGIN
                  DimMgt.GetDimValueRec(2, lSalesInvLine."Shortcut Dimension 2 Code", DimVal, FALSE,'');
                  IF (DimVal."Cost Type" = DimVal."Cost Type"::Labor) THEN
                    lInvAmntLabor := lInvAmntLabor + lSalesInvLine."Amount Including VAT"
                  ELSE
                    IF (DimVal."Cost Type" = DimVal."Cost Type"::Revenue) THEN
                      lInvAmntPerc := lInvAmntPerc + lSalesInvLine."Amount Including VAT";
                END ELSE BEGIN
                  lInvAmntPerc := lInvAmntPerc + lSalesInvLine."Amount Including VAT";
                END;

              END;

            "Labor Amount (Subcontracting)" :=
              "Labor Amount (Subcontracting)" + (lInvAmntLabor + lInvAmntPerc * ("% Labor"/100));
            "Blocked Amount (Subcontracting" :=
              "Blocked Amount (Subcontracting" + ((lInvAmntLabor + lInvAmntPerc * ("% Labor"/100)) * "% to B Account"/100);

          UNTIL lSalesInvLine.NEXT = 0;

        "Labor Amount (Subcontracting)" := ROUND("Labor Amount (Subcontracting)");
        "Blocked Amount (Subcontracting" := ROUND("Blocked Amount (Subcontracting");
      END;
    END;

    LOCAL PROCEDURE CalcBAmountCrMemo@1100485001(VAR lSalesCrMemoHeader@1210190011 : Record 114);
    VAR
      lCrMemoLine@1210190000 : Record 115;
      DimVal@1210190010 : Record 349;
      DimMgt@1100525000 : Codeunit 408;
      lInvAmntPerc@1210190009 : Decimal;
      lInvAmntLabor@1210190008 : Decimal;
    BEGIN
      //**4PS
      WITH lSalesCrMemoHeader DO BEGIN
        "Labor Amount (Subcontracting)" := 0;
        "Blocked Amount (Subcontracting" := 0;

        IF "Plant Credit Memo" THEN
          EXIT;

        lCrMemoLine.SETRANGE("Document No.", "No.");
        lCrMemoLine.SETFILTER(Type,'<>%1',lCrMemoLine.Type::" ");
        lCrMemoLine.SETRANGE("VAT Calculation Type", lCrMemoLine."VAT Calculation Type"::"Reverse Charge VAT");
        IF lCrMemoLine.FINDSET THEN
          REPEAT
            //Determine Amounts
            lInvAmntPerc := 0;
            lInvAmntLabor := 0;
            IF "Installment Credit Memo" OR
               (NOT "Installment Credit Memo" AND
               ("Calculate B Amounts based on" = "Calculate B Amounts based on"::"Invoice Amount"))
            THEN
              lInvAmntPerc := lInvAmntPerc + lCrMemoLine."Amount Including VAT"
            ELSE
              IF (lCrMemoLine."Cost Plus Line No." <> 0) THEN BEGIN
                IF (lCrMemoLine."Cost Type Cost Plus Line" = lCrMemoLine."Cost Type Cost Plus Line"::Labor) THEN BEGIN
                  lInvAmntLabor := lInvAmntLabor + lCrMemoLine."Amount Including VAT";
                END ELSE BEGIN
                  IF (lCrMemoLine."Cost Type Cost Plus Line" = lCrMemoLine."Cost Type Cost Plus Line"::Revenue) THEN
                    lInvAmntPerc := lInvAmntPerc + lCrMemoLine."Amount Including VAT";
                END;
              END ELSE BEGIN
                IF lCrMemoLine."Shortcut Dimension 2 Code" <> '' THEN BEGIN
                  DimMgt.GetDimValueRec(2, lCrMemoLine."Shortcut Dimension 2 Code",DimVal, FALSE,'');
                  IF (DimVal."Cost Type" = DimVal."Cost Type"::Labor) THEN
                    lInvAmntLabor := lInvAmntLabor + lCrMemoLine."Amount Including VAT"
                  ELSE
                    IF (DimVal."Cost Type" = DimVal."Cost Type"::Revenue) THEN
                      lInvAmntPerc := lInvAmntPerc + lCrMemoLine."Amount Including VAT";
                END;
              END;

            "Labor Amount (Subcontracting)" :=
              "Labor Amount (Subcontracting)" + (lInvAmntLabor + lInvAmntPerc * ("% Labor"/100));
            "Blocked Amount (Subcontracting" :=
              "Blocked Amount (Subcontracting" + ((lInvAmntLabor + lInvAmntPerc * ("% Labor"/100)) * "% to B Account"/100);

          UNTIL lCrMemoLine.NEXT = 0;

        "Labor Amount (Subcontracting)" := ROUND("Labor Amount (Subcontracting)");
        "Blocked Amount (Subcontracting" := ROUND("Blocked Amount (Subcontracting");
      END;
    END;

    LOCAL PROCEDURE PostComplRevenueFixedPriceProj@1100485002(SalesHeader@1100525002 : Record 36;JobJnlLine@1100525000 : Record 11072008);
    VAR
      ProjectType@1100525001 : Record 11012009;
      LedgerbyProjTypeCustGr@1100529600 : Record 11229378;
    BEGIN
      //**4PS
      IF (JobJnlLine."Total Price (LCY)" = 0) OR JobJnlLine."Advance Payment" THEN
        EXIT;

      Project.GET(JobJnlLine."Job No.");

      Project.TESTFIELD("Project Type");
      ProjectType.GET(Project."Project Type");
      IF NOT ProjectType."Post Complementary Revenues" THEN
        EXIT;

      IF LedgerbyProjTypeCustGr.GET(ProjectType.Code, SalesHeader."Customer Posting Group") THEN BEGIN
        IF LedgerbyProjTypeCustGr."Bal. Account Compl. Revenues" <> '' THEN
          ProjectType."Bal. Account Compl. Revenues" := LedgerbyProjTypeCustGr."Bal. Account Compl. Revenues";
        IF LedgerbyProjTypeCustGr."Compl. Revenues Account" <> '' THEN
          ProjectType."Compl. Revenues Account" := LedgerbyProjTypeCustGr."Compl. Revenues Account";
      END;

      ProjectType.TESTFIELD("Bal. Account Compl. Revenues");
      ProjectType.TESTFIELD("Compl. Revenues Account");

      //Post Debit Line
      CLEAR(TempRequisitionPostingBuffer[1]);
      TempRequisitionPostingBuffer[1]."G/L Account" := ProjectType."Bal. Account Compl. Revenues";
      TempRequisitionPostingBuffer[1].Amount := JobJnlLine."Total Price (LCY)";
      TempRequisitionPostingBuffer[1].Description := SalesHeader."Posting Description";
      TempRequisitionPostingBuffer[1]."Global Dimension 1 Code" := JobJnlLine."Shortcut Dimension 1 Code";
      TempRequisitionPostingBuffer[1]."Global Dimension 2 Code" := JobJnlLine."Shortcut Dimension 2 Code";
      TempRequisitionPostingBuffer[1]."Dimension Set ID" := JobJnlLine."Dimension Set ID";
      UpdateRequisitionPostingBuffer;

      //Post Credit Line
      TempRequisitionPostingBuffer[1]."G/L Account" := ProjectType."Compl. Revenues Account";
      TempRequisitionPostingBuffer[1].Amount := -JobJnlLine."Total Price (LCY)";
      UpdateRequisitionPostingBuffer;
    END;

    LOCAL PROCEDURE PostComplRevenueFixedPriceServ@1100485008(SalesHeader@1100525003 : Record 36;SalesLine@1100525004 : Record 37;ServJnlLine@1100525002 : Record 11012820);
    VAR
      ServiceType@1100485002 : Record 11012814;
      ServiceContract@1100525005 : Record 11012812;
      LedgerbyServTypeCustGr@1100529600 : Record 11072322;
      ServiceCategory@1100529601 : Record 11071985;
      FixedPriceRevAcc@1100525001 : Code[20];
    BEGIN
      //**4PS
      IF ServJnlLine."Total Revenue (LCY)" = 0 THEN
        EXIT;

      IF SalesLine."Service Order No." <> '' THEN BEGIN
        ServiceOrder.GET(SalesLine."Service Order No.");
        ServiceOrder.TESTFIELD("Service Type");
        ServiceType.GET(ServiceOrder."Service Type");
      END ELSE BEGIN
        IF NOT ServiceCategory.GetServiceType(SalesLine."Service Contract No.", SalesLine."Service Category", FALSE, ServiceType) THEN BEGIN
          ServiceContract.GET(SalesLine."Service Contract No.");
          ServiceContract.TESTFIELD("Service Type");
          ServiceType.GET(ServiceContract."Service Type");
        END;
        ServiceOrder."Source Type" := ServiceOrder."Source Type"::Contract;
      END;

      IF NOT ServiceType."Post Complementary Revenues" THEN
        EXIT;

      IF LedgerbyServTypeCustGr.GET(ServiceType.Code, SalesHeader."Customer Posting Group") THEN BEGIN
        IF LedgerbyServTypeCustGr."Bal. Account Compl. Revenues" <> '' THEN
          ServiceType."Bal. Account Compl. Revenues" := LedgerbyServTypeCustGr."Bal. Account Compl. Revenues";
        IF LedgerbyServTypeCustGr."Compl. Revenues Acc. Call" <> '' THEN
          ServiceType."Compl. Revenues Acc. Call" := LedgerbyServTypeCustGr."Compl. Revenues Acc. Call";
        IF LedgerbyServTypeCustGr."Compl. Revenues Acc. Contract" <> '' THEN
          ServiceType."Compl. Revenues Acc. Contract" := LedgerbyServTypeCustGr."Compl. Revenues Acc. Contract";
        IF LedgerbyServTypeCustGr."Compl. Revenues Acc. Estimate" <> '' THEN
          ServiceType."Compl. Revenues Acc. Estimate":= LedgerbyServTypeCustGr."Compl. Revenues Acc. Estimate";
        IF LedgerbyServTypeCustGr."Compl. Revenues Acc. Other" <> '' THEN
          ServiceType."Compl. Revenues Acc. Other" := LedgerbyServTypeCustGr."Compl. Revenues Acc. Other";
      END;

      ServiceType.TESTFIELD("Bal. Account Compl. Revenues");
      CASE ServiceOrder."Source Type" OF
        ServiceOrder."Source Type"::Call:
          BEGIN
            ServiceType.TESTFIELD("Compl. Revenues Acc. Call");
            FixedPriceRevAcc := ServiceType."Compl. Revenues Acc. Call";
          END;
        ServiceOrder."Source Type"::Contract:
          BEGIN
            ServiceType.TESTFIELD("Compl. Revenues Acc. Contract");
            FixedPriceRevAcc := ServiceType."Compl. Revenues Acc. Contract";
          END;
        ServiceOrder."Source Type"::Estimate:
          BEGIN
            ServiceType.TESTFIELD("Compl. Revenues Acc. Estimate");
            FixedPriceRevAcc := ServiceType."Compl. Revenues Acc. Estimate";
          END;
        ServiceOrder."Source Type"::Direct:
          BEGIN
            ServiceType.TESTFIELD("Compl. Revenues Acc. Other");
            FixedPriceRevAcc := ServiceType."Compl. Revenues Acc. Other";
          END;
        ServiceOrder."Source Type"::Modification:
          BEGIN
            ServiceType.TESTFIELD("Compl. Revenues Acc. Other");
            FixedPriceRevAcc := ServiceType."Compl. Revenues Acc. Other";
          END;
        ServiceOrder."Source Type"::Replacement:
          BEGIN
            ServiceType.TESTFIELD("Compl. Revenues Acc. Other");
            FixedPriceRevAcc := ServiceType."Compl. Revenues Acc. Other";
          END;
      END;

      //Dimensions
      //Post Debit Line
      CLEAR(TempRequisitionPostingBuffer[1]);
      TempRequisitionPostingBuffer[1]."G/L Account" := ServiceType."Bal. Account Compl. Revenues";
      TempRequisitionPostingBuffer[1].Amount := ServJnlLine."Total Revenue (LCY)";
      TempRequisitionPostingBuffer[1].Description := SalesHeader."Posting Description";
      TempRequisitionPostingBuffer[1]."Global Dimension 1 Code" := ServJnlLine."Shortcut Dimension 1 Code";
      TempRequisitionPostingBuffer[1]."Global Dimension 2 Code" := ServJnlLine."Shortcut Dimension 2 Code";
      TempRequisitionPostingBuffer[1]."Dimension Set ID" := ServJnlLine."Dimension Set ID";
      UpdateRequisitionPostingBuffer;

      //Post Credit Line
      TempRequisitionPostingBuffer[1]."G/L Account" := FixedPriceRevAcc;
      TempRequisitionPostingBuffer[1].Amount := -ServJnlLine."Total Revenue (LCY)";
      UpdateRequisitionPostingBuffer;
    END;

    LOCAL PROCEDURE PostComplWipProjectPlant@1100485006(SalesHeader@1100525001 : Record 36;SalesLine@1100525002 : Record 37;JobJnlLine@1100525000 : Record 11072008);
    VAR
      ProjectType@1100525003 : Record 11012009;
      DimVal@1100525005 : Record 349;
      DimMgt@1100525004 : Codeunit 408;
    BEGIN
      //**4PS
      IF JobJnlLine."Total Cost (LCY)" = 0 THEN
        EXIT;

      Project.GET(SalesLine."Job No.");
      Project.TESTFIELD("Project Type");
      ProjectType.GET(Project."Project Type");
      IF NOT ProjectType."Post Complementary Costs" THEN
        EXIT;

      DimMgt.GetDimValueRec(2, SalesLine."Shortcut Dimension 2 Code", DimVal, TRUE, SalesLine."Job No.");

      //Post Debit Line
      CLEAR(TempComplWIPPostingBuffer[1]);
      TempComplWIPPostingBuffer[1]."Bal. Account No." := ProjectType.GetComplWIPCoverAcc(DimVal."Cost Type", '', SalesHeader."Customer Posting Group");
      TempComplWIPPostingBuffer[1].Amount := JobJnlLine."Total Cost (LCY)";
      TempComplWIPPostingBuffer[1].Description := SalesHeader."Posting Description";
      TempComplWIPPostingBuffer[1]."Job No." :=  SalesLine."Job No.";
      TempComplWIPPostingBuffer[1]."Global Dimension 1 Code" := JobJnlLine."Shortcut Dimension 1 Code";
      TempComplWIPPostingBuffer[1]."Global Dimension 2 Code" := JobJnlLine."Shortcut Dimension 2 Code";
      TempComplWIPPostingBuffer[1]."Dimension Set ID" := JobJnlLine."Dimension Set ID";

      //Post Credit Line
      TempComplWIPPostingBuffer[1]."G/L Account" := ProjectType.GetComplWipAcc(DimVal."Cost Type", '', SalesHeader."Customer Posting Group");
      UpdateComplWIPPostingBuffer;
    END;

    LOCAL PROCEDURE PostComplWipServicePlant@1100525011(SalesHeader@1100525002 : Record 36;SalesLine@1100525001 : Record 37;ServJnlLine@1100525000 : Record 11012820);
    VAR
      ServiceType@1100525003 : Record 11012814;
      DimVal@1100525005 : Record 349;
      DimMgt@1100525004 : Codeunit 408;
    BEGIN
      //**4PS
      IF ServJnlLine."Total Cost (LCY)" = 0 THEN
        EXIT;

      ServiceOrder.GET(SalesLine."Service Order No.");
      IF SalesLine."Additional Cost (Service)" THEN BEGIN
        ServiceOrder.TESTFIELD("Service Type (Other)");
        ServiceType.Code := ServiceOrder."Service Type (Other)";
      END ELSE BEGIN
        ServiceOrder.TESTFIELD("Service Type");
        ServiceType.Code := ServiceOrder."Service Type";
      END;
      ServiceType.GET(ServiceType.Code);
      IF NOT ServiceType."Post Complementary Costs" THEN
        EXIT;

      DimMgt.GetDimValueRec(2, SalesLine."Shortcut Dimension 2 Code", DimVal, TRUE, SalesLine."Job No.");

      //Post Debit Line
      CLEAR(TempComplWIPPostingBuffer[1]);
      TempComplWIPPostingBuffer[1]."Bal. Account No." := ServiceType.GetComplWIPCoverAcc(DimVal."Cost Type", '', SalesHeader."Customer Posting Group", ServiceOrder);
      TempComplWIPPostingBuffer[1].Amount := ServJnlLine."Total Cost (LCY)";
      TempComplWIPPostingBuffer[1].Description := SalesHeader."Posting Description";
      TempComplWIPPostingBuffer[1]."Service Order No." :=  SalesLine."Service Order No.";
      TempComplWIPPostingBuffer[1]."Service Contract No." :=  SalesLine."Service Contract No.";
      TempComplWIPPostingBuffer[1]."Global Dimension 1 Code" := ServJnlLine."Shortcut Dimension 1 Code";
      TempComplWIPPostingBuffer[1]."Global Dimension 2 Code" := ServJnlLine."Shortcut Dimension 2 Code";
      TempComplWIPPostingBuffer[1]."Dimension Set ID" := ServJnlLine."Dimension Set ID";

      //Post Credit Line
      TempComplWIPPostingBuffer[1]."G/L Account" := ServiceType.GetComplWipAcc(DimVal."Cost Type", '', SalesHeader."Customer Posting Group");
      UpdateComplWIPPostingBuffer;
    END;

    LOCAL PROCEDURE PostComplWIPSurchargeIC@1100525008(lvAccount@1100485001 : Code[20];lvBalanceAccount@1100525000 : Code[20]);
    BEGIN
      //**4PS
      //Starting point is 'normal surcharge' record

      IF TempSurchargePostingBuffer[1].Amount = 0 THEN
        EXIT;

      CLEAR(TempComplWIPPostingBuffer[1]);
      TempComplWIPPostingBuffer[1]."G/L Account" := lvAccount;
      TempComplWIPPostingBuffer[1]."Bal. Account No." := lvBalanceAccount;
      TempComplWIPPostingBuffer[1].Amount := TempSurchargePostingBuffer[1].Amount;
      TempComplWIPPostingBuffer[1].Description := TempSurchargePostingBuffer[1].Description;
      TempComplWIPPostingBuffer[1]."Job No." :=  TempSurchargePostingBuffer[1]."Job No.";
      TempComplWIPPostingBuffer[1]."Service Order No." := TempSurchargePostingBuffer[1]."Service Order No.";
      TempComplWIPPostingBuffer[1]."Service Contract No." := TempSurchargePostingBuffer[1]."Service Contract No.";
      TempComplWIPPostingBuffer[1]."Global Dimension 1 Code" := TempSurchargePostingBuffer[1]."Global Dimension 1 Code";
      TempComplWIPPostingBuffer[1]."Global Dimension 2 Code" := TempSurchargePostingBuffer[1]."Global Dimension 2 Code";
      TempComplWIPPostingBuffer[1]."Dimension Set ID" := TempSurchargePostingBuffer[1]."Dimension Set ID";

      UpdateComplWIPPostingBuffer;
    END;

    LOCAL PROCEDURE UpdateComplWIPPostingBuffer@1100485011();
    BEGIN
      //**4PS
      TempComplWIPPostingBuffer[2] := TempComplWIPPostingBuffer[1];
      IF TempComplWIPPostingBuffer[2].FIND THEN BEGIN
        TempComplWIPPostingBuffer[2].Amount :=
          TempComplWIPPostingBuffer[2].Amount + TempComplWIPPostingBuffer[1].Amount;    //**4PS-12385
        TempComplWIPPostingBuffer[2].MODIFY;
      END ELSE
        TempComplWIPPostingBuffer[1].INSERT;
    END;

    LOCAL PROCEDURE UpdateRequisitionPostingBuffer@1100485007();
    BEGIN
      //**4PS
      TempRequisitionPostingBuffer[2] := TempRequisitionPostingBuffer[1];
      IF TempRequisitionPostingBuffer[2].FIND THEN BEGIN
        TempRequisitionPostingBuffer[2].Amount :=
          TempRequisitionPostingBuffer[2].Amount + TempRequisitionPostingBuffer[1].Amount;
        TempRequisitionPostingBuffer[2].MODIFY;
      END ELSE
        TempRequisitionPostingBuffer[1].INSERT;
    END;

    LOCAL PROCEDURE SetLedgerEntryProcessed@1100485004(VAR iSalesLineRec@1100485000 : Record 37);
    VAR
      lvProjLedgEntRec@1100485001 : Record 11072005;
      lvHourLineRec@1100485002 : Record 11012085;
      lvProjCPRec@1100485003 : Record 11012019;
    BEGIN
      //**4PS
      IF lvProjCPRec.GET(iSalesLineRec."Job No.", iSalesLineRec."Sell-to Customer No.",
                          iSalesLineRec."Commission No.", iSalesLineRec."Settl.Sheet No." ,
                          iSalesLineRec."Cost Plus Line No.") THEN BEGIN
        IF lvProjCPRec.Processed THEN BEGIN
          IF lvProjCPRec."Entry No. Project Ledger" <> 0 THEN BEGIN
            IF lvProjLedgEntRec.GET(lvProjCPRec."Entry No. Project Ledger") THEN BEGIN
              lvProjLedgEntRec.Processed := lvProjCPRec.Processed;
              lvProjLedgEntRec.MODIFY;
            END;
          END ELSE BEGIN
            IF lvHourLineRec.GET(lvProjCPRec."Posted Hour Year", lvProjCPRec."Posted Hour Week", lvProjCPRec."Employee No.",
              lvProjCPRec."Posted Hour Line No.") THEN BEGIN
              lvHourLineRec.Processed := lvProjCPRec.Processed;
              lvHourLineRec.MODIFY;
            END;
          END;
        END;
      END;
    END;

    LOCAL PROCEDURE CheckSalesLineBuyBackItemPO@1100485003(VAR ISalesLineRec@1100485000 : Record 37) : Boolean;
    BEGIN
      //**4PS
      WITH ISalesLineRec DO BEGIN
        IF "Plant Invoice" AND
           ("Plant Invoice Origin" = "Plant Invoice Origin"::"Plant Order") AND
           ("Relate to" = "Relate to"::ItemBuyBack)
        THEN
          EXIT(TRUE);

        EXIT(FALSE);
      END;
    END;

    LOCAL PROCEDURE CheckBuyBackGenPostTypPurchase@1100485005(VAR GenJnlLine@1100485002 : Record 81);
    VAR
      lvAccRec@1100485001 : Record 15;
    BEGIN
      //**4PS
      //* It is only allowed to call this function if "Account No." and "Gen. Posting Type" of GenJnlLine are filled.
      IF lvAccRec.GET(GenJnlLine."Account No.") THEN
        IF lvAccRec."Gen. Posting Type" <> lvAccRec."Gen. Posting Type"::Sale THEN   //* Empty or Purchase
          GenJnlLine."Gen. Posting Type" := GenJnlLine."Gen. Posting Type"::Purchase;
    END;

    LOCAL PROCEDURE CheckQtyToInvoicePresent@1100525001(SalesHeader@1100525001 : Record 36);
    VAR
      SalesLine@1100525000 : Record 37;
    BEGIN
      //**4PS
      SalesLine.SETRANGE("Document Type", SalesHeader."Document Type");
      SalesLine.SETRANGE("Document No.", SalesHeader."No.");
      SalesLine.SETFILTER("Qty. to Invoice", '<>0');
      IF SalesLine.ISEMPTY THEN
        InvoiceOrderNotPostedInvoice := FALSE;
    END;

    LOCAL PROCEDURE InsertNotPostedSalesInvoice@1100525003(SalesHeader@1100525001 : Record 36);
    BEGIN
      //**4PS
      SalesHeadInvFromOrder.INIT;
      IF SalesHeader."Document Type" <> SalesHeader."Document Type"::"Return Order" THEN  //*27074
        SalesHeadInvFromOrder."Document Type" := SalesHeadInvFromOrder."Document Type"::Invoice
      ELSE
        SalesHeadInvFromOrder."Document Type" := SalesHeadInvFromOrder."Document Type"::"Credit Memo";

      SalesHeadInvFromOrder."No." := '';
      SalesHeadInvFromOrder.INSERT(TRUE);
      SalesHeadInvFromOrder.TESTFIELD("No.");
      SalesHeadInvFromOrder.VALIDATE("Sell-to Customer No.",  SalesHeader."Sell-to Customer No.");
      IF SalesHeader."Bill-to Customer No." <> '' THEN BEGIN
        //SalesHeadInvFromOrder.VALIDATE("Bill-to Customer No.", SalesHeader."Bill-to Customer No.");
        //C060992.sn
        //skip question if Bill-to on SalesHeader is another then Bill-to from Customer
        SalesHeadInvFromOrder."Bill-to Customer No." := SalesHeader."Bill-to Customer No.";
        SalesHeadInvFromOrder.VALIDATE("Bill-to Customer No.");
        //C060992.en
      END;
      IF SalesHeader."Document Type" <> SalesHeader."Document Type"::"Return Order" THEN  //*27074
        SalesHeadInvFromOrder.VALIDATE("Related Sales Order No.", SalesHeader."No.")
      ELSE
        SalesHeadInvFromOrder."Return Order No." := SalesHeader."No.";
      IF SalesHeadInvFromOrder."Currency Code" <> SalesHeader."Currency Code" THEN
        SalesHeadInvFromOrder.VALIDATE("Currency Code", SalesHeader."Currency Code");

      SalesHeadInvFromOrder."Sell-to Contact No." := SalesHeader."Sell-to Contact No.";
      SalesHeadInvFromOrder."Sell-to Customer Name" := SalesHeader."Sell-to Customer Name";
      SalesHeadInvFromOrder."Sell-to Customer Name 2" := SalesHeader."Sell-to Customer Name 2";
      SalesHeadInvFromOrder."Sell-to Address" := SalesHeader."Sell-to Address";
      SalesHeadInvFromOrder."Sell-to Address 2" := SalesHeader."Sell-to Address 2";
      SalesHeadInvFromOrder."Sell-to Post Code" := SalesHeader."Sell-to Post Code";
      SalesHeadInvFromOrder."Sell-to City" := SalesHeader."Sell-to City";
      SalesHeadInvFromOrder."Sell-to County" := SalesHeader."Sell-to County";
      SalesHeadInvFromOrder."Sell-to Country/Region Code" := SalesHeader."Sell-to Country/Region Code";
      SalesHeadInvFromOrder."Sell-to Contact" := SalesHeader."Sell-to Contact";
      SalesHeadInvFromOrder."Your Reference" := SalesHeader."Your Reference";
      SalesHeadInvFromOrder."Alternative Bill-to Address" := SalesHeader."Alternative Bill-to Address";
      SalesHeadInvFromOrder."Bill-to Contact No." := SalesHeader."Bill-to Contact No.";
      SalesHeadInvFromOrder."Bill-to Name" := SalesHeader."Bill-to Name";
      SalesHeadInvFromOrder."Bill-to Name 2" := SalesHeader."Bill-to Name 2";
      SalesHeadInvFromOrder."Bill-to Address" := SalesHeader."Bill-to Address";
      SalesHeadInvFromOrder."Bill-to Address 2" := SalesHeader."Bill-to Address 2";
      SalesHeadInvFromOrder."Bill-to Post Code" := SalesHeader."Bill-to Post Code";
      SalesHeadInvFromOrder."Bill-to City" := SalesHeader."Bill-to City";
      SalesHeadInvFromOrder."Bill-to County" := SalesHeader."Bill-to County";
      SalesHeadInvFromOrder."Bill-to Country/Region Code" := SalesHeader."Bill-to Country/Region Code";
      SalesHeadInvFromOrder."Bill-to Contact" := SalesHeader."Bill-to Contact";
      SalesHeadInvFromOrder."Ship-to Code" := SalesHeader."Ship-to Code";
      SalesHeadInvFromOrder."Ship-to Name" := SalesHeader."Ship-to Name";
      SalesHeadInvFromOrder."Ship-to Name 2" := SalesHeader."Ship-to Name 2";
      SalesHeadInvFromOrder."Ship-to Address" := SalesHeader."Ship-to Address";
      SalesHeadInvFromOrder."Ship-to Address 2" := SalesHeader."Ship-to Address 2";
      SalesHeadInvFromOrder."Ship-to Post Code" := SalesHeader."Ship-to Post Code";
      SalesHeadInvFromOrder."Ship-to City" := SalesHeader."Ship-to City";
      SalesHeadInvFromOrder."Ship-to County" := SalesHeader."Ship-to County";
      SalesHeadInvFromOrder."Ship-to Country/Region Code" := SalesHeader."Ship-to Country/Region Code";
      SalesHeadInvFromOrder."Ship-to Contact" := SalesHeader."Ship-to Contact";
      SalesHeadInvFromOrder."Salesperson Code" := SalesHeader."Salesperson Code";
      SalesHeadInvFromOrder."Shipment Method Code" := SalesHeader."Shipment Method Code";
      SalesHeadInvFromOrder."Shipping Agent Code" := SalesHeader."Shipping Agent Code";
      SalesHeadInvFromOrder."Invoice Disc. Code" := SalesHeader."Invoice Disc. Code";
      SalesHeadInvFromOrder."Shortcut Dimension 1 Code" := SalesHeader."Shortcut Dimension 1 Code";
      SalesHeadInvFromOrder."Shortcut Dimension 2 Code" := SalesHeader."Shortcut Dimension 2 Code";
      SalesHeadInvFromOrder."Dimension Set ID" := SalesHeader."Dimension Set ID";

      SalesHeadInvFromOrder.MODIFY(TRUE);
      SelectAndCopyDocumentRelations(SalesHeader."No.", SalesHeader."Sell-to Customer No.", SalesHeadInvFromOrder."No.");
    END;

    LOCAL PROCEDURE DelayInsertNotPostedSaleInvLin@1100525015(SalesLine@1100525000 : Record 37;SavedQtyToinvoice@1100525001 : Decimal);
    BEGIN
      //**4PS
      SalesLine."Qty. to Invoice" := SavedQtyToinvoice;  //**4PS n C041808

      IF NOT AdditionalCheckOnQtyOk(SalesLine, FALSE) THEN
        EXIT;

      TempSalesOrderLineForInv := SalesLine;
      TempSalesOrderLineForInv.INSERT;
    END;

    LOCAL PROCEDURE ProcInsertNotPostSalesInvLines@1100525016(SalesHeader@1100525000 : Record 36);
    BEGIN
      //**4PS  24767
      IF TempSalesOrderLineForInv.FINDSET THEN
        REPEAT
          InsertNotPostedSalesInvLine(SalesHeader,TempSalesOrderLineForInv);
        UNTIL TempSalesOrderLineForInv.NEXT = 0;
    END;

    LOCAL PROCEDURE InsertNotPostedSalesInvLine@1100525005(SalesHeader@1100525005 : Record 36;SalesLine@1100525004 : Record 37);
    VAR
      lvSalesLineInvRec@1100525000 : Record 37;
      lvSalesLineRec2@1100525002 : Record 37;
      lvSalesShptLineRec@1100525001 : Record 111;
      lvSalesShptLineRec2@1100525003 : Record 111;
      lvReturnReceiptLine@1210190000 : Record 6661;
      lvReturnReceiptLine2@1210190001 : Record 6661;
      lvNextLineNo@1100525008 : Integer;
      lvQtyToInvoice@1100525006 : Decimal;
      lvRestQtyToInvoice@1100525007 : Decimal;
      RestQtyPos@1100528200 : Boolean;
      ErrorFound@1100528201 : Boolean;
    BEGIN
      //**4PS
      IF SalesLine.Type = SalesLine.Type::" " THEN BEGIN  //* Copy all text lines
        lvSalesLineInvRec.SETRANGE("Document Type", SalesHeadInvFromOrder."Document Type");
        lvSalesLineInvRec.SETRANGE("Document No.", SalesHeadInvFromOrder."No.");
        IF lvSalesLineInvRec.FINDLAST THEN
          lvNextLineNo := lvSalesLineInvRec."Line No.";
        lvNextLineNo := lvNextLineNo + 10000;

        lvSalesLineInvRec.TRANSFERFIELDS(SalesLine);
        lvSalesLineInvRec."Document Type" := SalesHeadInvFromOrder."Document Type";
        lvSalesLineInvRec."Document No." := SalesHeadInvFromOrder."No.";
        lvSalesLineInvRec."Line No." := lvNextLineNo;
        lvSalesLineInvRec.INSERT;

        IF SalesSetup."Copy Comments Order to Invoice" THEN BEGIN
          CopySingleCommentLines(
            SalesHeader."Document Type", SalesHeadInvFromOrder."Document Type",
            SalesHeader."No.",SalesHeadInvFromOrder."No.",
            SalesLine."Line No.", lvSalesLineInvRec."Line No.");
        END;

        EXIT;
      END;

      lvRestQtyToInvoice := SalesLine."Qty. to Invoice";
      IF lvRestQtyToInvoice = 0 THEN
        EXIT;
      RestQtyPos := (lvRestQtyToInvoice >= 0);

      IF SalesLine."Document Type" <> SalesLine."Document Type"::"Return Order" THEN BEGIN  //*27074.n
        lvSalesShptLineRec.SETCURRENTKEY("Order No.", "Order Line No.");
        lvSalesShptLineRec.SETRANGE("Order No.", SalesLine."Document No.");
        lvSalesShptLineRec.SETRANGE("Order Line No.", SalesLine."Line No.");
        lvSalesShptLineRec.SETRANGE("Bill-to Customer No.",SalesHeader."Bill-to Customer No.");
        IF lvRestQtyToInvoice >= 0 THEN
          lvSalesShptLineRec.SETFILTER("Qty. Shipped Not Invoiced",'>0')
        ELSE
          lvSalesShptLineRec.SETFILTER("Qty. Shipped Not Invoiced",'<0');
        lvSalesShptLineRec.SETRANGE("Currency Code",SalesHeader."Currency Code");
        IF lvSalesShptLineRec.FINDSET(TRUE,FALSE) THEN BEGIN
          lvSalesLineInvRec.SETRANGE("Document Type", SalesHeadInvFromOrder."Document Type");
          lvSalesLineInvRec.SETRANGE("Document No.", SalesHeadInvFromOrder."No.");
          lvSalesLineInvRec."Document Type" := SalesHeadInvFromOrder."Document Type";
          lvSalesLineInvRec."Document No." := SalesHeadInvFromOrder."No.";
          //
          lvSalesLineRec2.SETCURRENTKEY("Document Type", "Shipment No.", "Shipment Line No.");
          lvSalesLineRec2.SETFILTER("Document Type", '%1|%2',
            lvSalesLineRec2."Document Type"::Invoice, lvSalesLineRec2."Document Type"::"Credit Memo");
          lvSalesLineRec2.SETFILTER("Document No.", '<>%1', SalesHeadInvFromOrder."No.");
          REPEAT
            lvSalesLineRec2.SETRANGE("Shipment No.", lvSalesShptLineRec."Document No.");
            lvSalesLineRec2.SETRANGE("Shipment Line No.", lvSalesShptLineRec."Line No.");
      //    IF lvSalesLineRec2.FINDFIRST THEN
            IF lvSalesLineRec2.FINDSET THEN BEGIN
              REPEAT
                lvRestQtyToInvoice := lvRestQtyToInvoice - lvSalesShptLineRec."Qty. Shipped Not Invoiced";
              UNTIL lvSalesLineRec2.NEXT = 0;
              IF RestQtyPos THEN
                ErrorFound := (lvRestQtyToInvoice <= 0)
              ELSE
                ErrorFound := (lvRestQtyToInvoice >= 0);
              IF ErrorFound THEN
                ERROR(Text11012003, lvSalesShptLineRec."Order No.", lvSalesShptLineRec."Order Line No.",
                LOWERCASE(lvSalesShptLineRec.TABLECAPTION),
                lvSalesLineRec2."Document Type", lvSalesLineRec2."Document No.", lvSalesLineRec2."Line No.");
            END ELSE BEGIN
              lvSalesShptLineRec2 := lvSalesShptLineRec;
              IF ABS(lvRestQtyToInvoice) > ABS(lvSalesShptLineRec2."Qty. Shipped Not Invoiced") THEN BEGIN
                lvQtyToInvoice := lvSalesShptLineRec2."Qty. Shipped Not Invoiced";
                lvRestQtyToInvoice := lvRestQtyToInvoice - lvSalesShptLineRec2."Qty. Shipped Not Invoiced";
              END ELSE BEGIN
                lvQtyToInvoice := lvRestQtyToInvoice;
                lvRestQtyToInvoice := 0;
              END;
              IF (lvQtyToInvoice <> 0) AND (lvSalesLineInvRec."Document Type" = lvSalesLineInvRec."Document Type"::"Credit Memo") THEN
                lvQtyToInvoice := -lvQtyToInvoice;
              lvSalesShptLineRec2.SetCreateNotPostedInvFromOrder(lvQtyToInvoice);
              lvSalesShptLineRec2.InsertInvLineFromShptLine(lvSalesLineInvRec, TRUE); //M28272 changed
            END;
          UNTIL (lvSalesShptLineRec.NEXT = 0) OR (lvRestQtyToInvoice = 0);
          IF lvRestQtyToInvoice <> 0 THEN
            SalesLine.FIELDERROR("Qty. to Invoice",
              STRSUBSTNO(Text11012002, lvSalesShptLineRec.TABLECAPTION,
              SalesLine."Qty. to Invoice"-lvRestQtyToInvoice, SalesLine."Qty. to Invoice"));
        END;
      //*27074.sn
      END ELSE BEGIN
        lvReturnReceiptLine.SETCURRENTKEY("Return Order No.", "Return Order Line No.");
        lvReturnReceiptLine.SETRANGE("Return Order No.", SalesLine."Document No.");
        lvReturnReceiptLine.SETRANGE("Return Order Line No.", SalesLine."Line No.");
        lvReturnReceiptLine.SETRANGE("Bill-to Customer No.",SalesHeader."Bill-to Customer No.");
        IF lvRestQtyToInvoice >= 0 THEN
          lvReturnReceiptLine.SETFILTER("Return Qty. Rcd. Not Invd.",'>0')
        ELSE
          lvReturnReceiptLine.SETFILTER("Return Qty. Rcd. Not Invd.",'<0');
        lvReturnReceiptLine.SETRANGE("Currency Code",SalesHeader."Currency Code");
        IF lvReturnReceiptLine.FINDSET(TRUE,FALSE) THEN BEGIN
          lvSalesLineInvRec.SETRANGE("Document Type", SalesHeadInvFromOrder."Document Type");
          lvSalesLineInvRec.SETRANGE("Document No.", SalesHeadInvFromOrder."No.");
          lvSalesLineInvRec."Document Type" := SalesHeadInvFromOrder."Document Type";
          lvSalesLineInvRec."Document No." := SalesHeadInvFromOrder."No.";
          //
          lvSalesLineRec2.SETFILTER("Document Type", '%1|%2',
            lvSalesLineRec2."Document Type"::Invoice, lvSalesLineRec2."Document Type"::"Credit Memo");
          lvSalesLineRec2.SETFILTER("Document No.", '<>%1', SalesHeadInvFromOrder."No.");
          REPEAT
            lvSalesLineRec2.SETRANGE("Return Receipt No.", lvReturnReceiptLine."Document No.");
            lvSalesLineRec2.SETRANGE("Return Receipt Line No.", lvReturnReceiptLine."Line No.");
            //IF lvSalesLineRec2.FINDFIRST THEN
            IF lvSalesLineRec2.FINDSET THEN BEGIN
              REPEAT
                lvRestQtyToInvoice := lvRestQtyToInvoice - lvReturnReceiptLine."Return Qty. Rcd. Not Invd.";
              UNTIL lvSalesLineRec2.NEXT = 0;
              IF RestQtyPos THEN
                ErrorFound := (lvRestQtyToInvoice <= 0)
              ELSE
                ErrorFound := (lvRestQtyToInvoice >= 0);
              IF ErrorFound THEN
                ERROR(Text11012003, lvReturnReceiptLine."Return Order No.", lvReturnReceiptLine."Return Order Line No.",
                 LOWERCASE(lvReturnReceiptLine.TABLECAPTION),
                 lvSalesLineRec2."Document Type", lvSalesLineRec2."Document No.", lvSalesLineRec2."Line No.");
            END ELSE BEGIN
              lvReturnReceiptLine2 := lvReturnReceiptLine;
              IF ABS(lvRestQtyToInvoice) > ABS(lvReturnReceiptLine2."Return Qty. Rcd. Not Invd.") THEN BEGIN
                lvQtyToInvoice := lvReturnReceiptLine2."Return Qty. Rcd. Not Invd.";
                lvRestQtyToInvoice := lvRestQtyToInvoice - lvReturnReceiptLine2."Return Qty. Rcd. Not Invd.";
              END ELSE BEGIN
                lvQtyToInvoice := lvRestQtyToInvoice;
                lvRestQtyToInvoice := 0;
              END;
              IF (lvQtyToInvoice <> 0) AND (lvSalesLineInvRec."Document Type" = lvSalesLineInvRec."Document Type"::Invoice) THEN
                lvQtyToInvoice := -lvQtyToInvoice;
              lvReturnReceiptLine2.SetCreateNotPostedInvFromOrder(lvQtyToInvoice);
              lvReturnReceiptLine2.InsertInvLineFromRetRcptLine(lvSalesLineInvRec, TRUE); //M28272 changed
            END;
          UNTIL (lvReturnReceiptLine.NEXT = 0) OR (lvRestQtyToInvoice = 0);
          IF lvRestQtyToInvoice <> 0 THEN
            SalesLine.FIELDERROR("Qty. to Invoice",
              STRSUBSTNO(Text11012002, lvReturnReceiptLine.TABLECAPTION,
              SalesLine."Qty. to Invoice"-lvRestQtyToInvoice, SalesLine."Qty. to Invoice"));
        END;
      END;
      //*27074.en
    END;

    LOCAL PROCEDURE StandardSalesOrder@1100525013(SalesHeadRec@1100525000 : Record 36) : Boolean;
    BEGIN
      //**4PS
      WITH SalesHeadRec DO BEGIN
        IF ("Document Type" IN ["Document Type"::Order, "Document Type"::"Return Order"]) AND
           ("Sales Document Type" = "Sales Document Type"::Standard)
        THEN
          EXIT(TRUE);
      END;
      EXIT(FALSE);
    END;

    LOCAL PROCEDURE CloseStandardSalesOrder@1100525012(SalesLineRec@1210190000 : Record 37);
    VAR
      SalesHeadRec@1210190001 : Record 36;
    BEGIN
      //**4PS
      IF NOT SalesHeadRec.GET(SalesLineRec."Document Type", SalesLineRec."Document No.") THEN
        EXIT;
      IF SalesHeadRec.Status = SalesHeadRec.Status::Closed THEN
        EXIT;
      IF NOT StandardSalesOrder(SalesHeadRec) THEN
        EXIT;

      SalesLineRec.RESET;
      SalesLineRec.SETRANGE("Document Type", SalesHeadRec."Document Type");
      SalesLineRec.SETRANGE("Document No.", SalesHeadRec."No.");
      IF SalesLineRec.FINDSET THEN BEGIN
        REPEAT
          IF NOT SalesLineRec.OrderLineCompletelyShippedAndInvoiced THEN
            EXIT;
        UNTIL SalesLineRec.NEXT = 0;
      END;

      SalesHeadRec.Status := SalesHeadRec.Status::Closed;
      SalesHeadRec.MODIFY;
    END;

    LOCAL PROCEDURE CopySingleCommentLines@1210190000(FromDocumentType@1000 : Integer;ToDocumentType@1001 : Integer;FromNumber@1002 : Code[20];ToNumber@1003 : Code[20];FromLineNo@1210190000 : Integer;ToLineNo@1210190001 : Integer);
    VAR
      SalesCommentLine@1100525000 : Record 44;
      SalesCommentLine2@1100525001 : Record 44;
    BEGIN
      //**4PS M28272 new
      SalesCommentLine.SETRANGE("Document Type",FromDocumentType);
      SalesCommentLine.SETRANGE("No.",FromNumber);
      SalesCommentLine.SETRANGE("Document Line No.",FromLineNo);

      IF SalesCommentLine.FINDSET THEN
        REPEAT
          SalesCommentLine2 := SalesCommentLine;
          SalesCommentLine2."Document Type" := ToDocumentType;
          SalesCommentLine2."No." := ToNumber;
          SalesCommentLine2."Document Line No." := ToLineNo;
          IF SalesCommentLine2.INSERT THEN;
        UNTIL SalesCommentLine.NEXT = 0;
    END;

    LOCAL PROCEDURE PostNSItemTracking@1100528601(SalesHeader@1100525002 : Record 36;SalesLine@1100525001 : Record 37;VAR SalesShptLine@1100525000 : Record 111);
    VAR
      NSReservationEntry@1100528604 : Record 11071900;
      NSItemTrackingCheck@1100528600 : Codeunit 11012353;
      QuantityProcessed@1100528501 : Decimal;
      IsFirstReservLine@1100528500 : Boolean;
      ErrorFieldCaption@1100409000 : Text[250];
    BEGIN
      //**4PS DP00121
      IF (SalesLine."Item No." = '') OR (SalesShptLine.Type <> SalesShptLine.Type::"G/L Account") THEN
        EXIT;

      IF NOT Item.GET(SalesLine."Item No.") THEN
        EXIT;

      IF Item."Item Tracking Code" = '' THEN
        EXIT;

      IF SalesHeader.Receive THEN
        ErrorFieldCaption := SalesLine.FIELDCAPTION("Qty. to Ship")
      ELSE
        ErrorFieldCaption := SalesLine.FIELDCAPTION("Return Qty. to Receive");

      NSReservationEntry.SETCURRENTKEY(
        "Source ID","Source Ref. No.","Source Type","Source Subtype");
      IF SalesShptLine."Order No." <> '' THEN BEGIN
        NSReservationEntry.SETRANGE("Source ID", SalesShptLine."Order No.");
        NSReservationEntry.SETRANGE("Source Ref. No.", SalesShptLine."Order Line No.");
      END ELSE BEGIN
        NSReservationEntry.SETRANGE("Source ID", SalesHeader."No.");
        NSReservationEntry.SETRANGE("Source Ref. No.", SalesLine."Line No.");
      END;
      NSReservationEntry.SETRANGE("Source Type", DATABASE::"Sales Line");
      NSReservationEntry.SETRANGE("Source Subtype", SalesHeader."Document Type"); //T003526

      IF SalesLine."Cost Plus Line No." <> 0 THEN BEGIN
        NSReservationEntry.DELETEALL;
        EXIT;
      END;

      IF NSReservationEntry.FINDSET(TRUE) THEN BEGIN
        IsFirstReservLine := TRUE;
        REPEAT
          IF (NSReservationEntry."Qty. to Handle (Base)" <> 0) AND
             ((NSReservationEntry."Serial No." <> '') OR (NSReservationEntry."Lot No." <> '')) THEN
          BEGIN
            NSItemTrackingCheck.CheckLine(
              NSReservationEntry, 0, SalesHeader."Document Date",
              -SalesShptLine."Quantity (Base)",IsFirstReservLine,
              ErrorFieldCaption);
            PostNSItemTrackingEntry(SalesHeader,SalesLine,NSReservationEntry,SalesShptLine);
            QuantityProcessed += NSReservationEntry."Qty. to Handle (Base)";
            IsFirstReservLine := FALSE;
            IF SalesHeader.Invoice THEN
              NSReservationEntry.MODIFY
            ELSE
              NSReservationEntry.DELETE;
          END;
        UNTIL NSReservationEntry.NEXT = 0;
      END;

      IF ABS(QuantityProcessed) <> ABS(SalesShptLine."Quantity (Base)") THEN
        ERROR(STRSUBSTNO(ItemTrackQuantityMismatchErr,SalesShptLine.FIELDCAPTION("Quantity (Base)"),SalesLine."Item No."));
    END;

    LOCAL PROCEDURE PostNSItemTrackingEntry@1100528603(SalesHeader@1100525002 : Record 36;SalesLine@1100525001 : Record 37;VAR NSReservationEntry@1100528600 : Record 11071900;VAR SalesShptLine@1100525000 : Record 111);
    VAR
      NSTrackingSpecification@1100528601 : Record 11071901;
      NSItemTrackingEntry@1100528604 : Record 11071902;
      NSItemTrackingEntryRelation@1100528603 : Record 11071903;
      NSItemApplnEntry@1100528606 : Record 11071904;
      EntryNo@1100528602 : Integer;
    BEGIN
      //**4PS DP00121
      WITH NSItemTrackingEntry DO BEGIN
        LOCKTABLE;
        IF FINDLAST THEN
          EntryNo := "Entry No." + 1
        ELSE
          EntryNo := 1;

        INIT;
        "Entry No." := EntryNo;
        "Item No." := SalesLine."Item No.";
        "Posting Date" := SalesHeader."Posting Date";
        "Entry Type" := "Entry Type"::Sale;
        "Location Code" := SalesShptLine."Location Code";
        "Document Type" := "Document Type"::"Sales Shipment";
        "Document No." := SalesShptLine."Document No.";
        "Document Line No." := SalesShptLine."Line No.";
        "Variant Code" := SalesShptLine."Variant Code";
        Open := TRUE;
        "Serial No." := NSReservationEntry."Serial No.";
        "Lot No." := NSReservationEntry."Lot No.";
        "Warranty Date Vendor" := NSReservationEntry."Warranty Date Vendor";
        "Warranty Code Vendor" := NSReservationEntry."Warranty Code Vendor";
        "Warranty Start Date Vendor" := NSReservationEntry."Warranty Start Date Vendor";
        "Warranty Period Vendor" := NSReservationEntry."Warranty Period Vendor";
        "Warranty Code Customer" := NSReservationEntry."Warranty Code Customer";
        "Warranty Start Date Customer" := NSReservationEntry."Warranty Start Date Customer";
        "Warranty Period Customer" := NSReservationEntry."Warranty Period Customer";
        "Warranty Date Customer" := NSReservationEntry."Warranty Date Customer";
        "Good Customs":= NSReservationEntry."Good Customs";
        "Shipment with T1" := NSReservationEntry."Shipment with T1";
        "Customs Destination Code" := NSReservationEntry."Customs Destination Code";
        "Expiration Date" := NSReservationEntry."Expiration Date";
        Quantity := NSReservationEntry."Qty. to Handle (Base)";
        "Remaining Quantity" := Quantity;
        Positive := ("Remaining Quantity" > 0);
        "Item Tracking":= ItemTrackingMgt.ItemTrackingOption(
          NSReservationEntry."Lot No.", NSReservationEntry."Serial No.");
        "Source Type":= "Source Type"::Customer;
        "Source No.":= SalesHeader."Sell-to Customer No.";
        "Project No." := SalesShptLine."Job No.";
        "Service Order No." := SalesLine."Service Order No.";

        //apply before insert cause applying data is added to NSItemTrackingEntry
        NSItemTrackingEntriesApply.ApplyNSItemTrackingEntry(NSItemTrackingEntry, Item."Item Tracking Code");
        INSERT;
      END;

      WITH NSTrackingSpecification DO BEGIN
        INIT;
        TRANSFERFIELDS(NSReservationEntry);
        "Entry No." := EntryNo;
        "Quantity Handled (Base)" := NSReservationEntry."Qty. to Handle (Base)";
        "Qty. to Handle (Base)" := 0;
        INSERT;
      END;

      WITH NSItemTrackingEntryRelation DO BEGIN
        INIT;
        "Item Tracking Entry No." := EntryNo;
        "Serial No." := NSReservationEntry."Serial No.";
        "Lot No." := NSReservationEntry."Lot No.";
        TransferFieldsSalesShptLine(SalesShptLine);
        INSERT;
      END;

      IF SalesHeader.Invoice AND (NSReservationEntry."Item Ledger Entry No." = 0) THEN
        NSReservationEntry."Item Ledger Entry No." := EntryNo; //T000815

      //Application
      IF NSItemTrackingEntry.Positive THEN
        EXIT;

      WITH NSItemApplnEntry DO BEGIN
        LOCKTABLE;
        IF FINDLAST THEN
          EntryNo := "Entry No." + 1
        ELSE
          EntryNo := 1;

        INIT;
        "Entry No." := EntryNo;
        "NS Item Tracking Entry No." := NSItemTrackingEntry."Entry No.";
        "Inbound Item Entry No." := 0;
        "Outbound Item Entry No." := NSItemTrackingEntry."Entry No.";
        Quantity := NSItemTrackingEntry.Quantity;
        "Posting Date" := NSItemTrackingEntry."Posting Date";
        "Creation Date" := CURRENTDATETIME;
        "Created By" := USERID;
        INSERT;
      END;
    END;

    LOCAL PROCEDURE InsertNSItemTrackingRelation@1100528500(SalesLine@1100528501 : Record 37;RowID@1100528503 : Text[100]);
    VAR
      NSReservationEntry@1100528502 : Record 11071900;
      NSItemTrackingRelation@1100528504 : Record 11071905;
    BEGIN
      //**4PS DP00121
      NSReservationEntry.SETCURRENTKEY(
        "Source ID","Source Ref. No.","Source Type","Source Subtype");
      NSReservationEntry.SETRANGE("Source ID", SalesLine."Document No.");
      NSReservationEntry.SETRANGE("Source Ref. No.", SalesLine."Line No.");
      NSReservationEntry.SETRANGE("Source Type", DATABASE::"Sales Line");
      NSReservationEntry.SETRANGE("Source Subtype", SalesLine."Document Type");
      IF NSReservationEntry.FINDSET(TRUE) THEN
        REPEAT
          IF NSReservationEntry."Item Ledger Entry No." <> 0 THEN BEGIN
            NSItemTrackingRelation."Item Tracking Entry No." := NSReservationEntry."Item Ledger Entry No.";
            NSItemTrackingRelation."Source RowId" := RowID;
            NSItemTrackingRelation."Project Ledger Entry No." := JobLedgEntryNo;
            NSItemTrackingRelation."Service Ledger Entry No." := ServLedgEntryNo;
            NSItemTrackingRelation.INSERT;
            NSReservationEntry.DELETE;
          END;
        UNTIL NSReservationEntry.NEXT = 0;
    END;

    LOCAL PROCEDURE AdditionalCheckOnQtyOk@1100409000(SalesLine2@1100528401 : Record 37;CheckQtyToShip@1100528400 : Boolean) : Boolean;
    VAR
      AttachedToSalesLine@1100409000 : Record 37;
    BEGIN
      //**4PS C015652
      IF CheckQtyToShip THEN BEGIN
        IF (SalesLine2."Qty. to Ship" <> 0) OR
           (SalesLine2."Return Qty. to Receive" <> 0) //C019971.n
        THEN
          EXIT(TRUE);
      END ELSE
        IF SalesLine2."Qty. to Invoice" <> 0 THEN
          EXIT(TRUE);

      IF SalesLine2.Type = SalesLine2.Type::" " THEN
        IF SalesLine2."Attached to Line No." > 0  THEN BEGIN
          AttachedToSalesLine.GET(SalesLine2."Document Type",SalesLine2."Document No.",SalesLine2."Attached to Line No." );
          IF AttachedToSalesLine.Type = AttachedToSalesLine.Type::" " THEN
            EXIT(TRUE);
          IF CheckQtyToShip THEN BEGIN
            IF (AttachedToSalesLine."Qty. to Ship" <> 0) OR
               (AttachedToSalesLine."Return Qty. to Receive" <> 0) //C019971.n
            THEN
              EXIT(TRUE);
          END ELSE
            IF AttachedToSalesLine."Qty. to Invoice" <> 0 THEN
              EXIT(TRUE);
        //C019732.sn
        END ELSE
          EXIT(TRUE);
        //C019732.en

      EXIT(FALSE);
    END;

    LOCAL PROCEDURE FillSalesCrMemoHeadReturnOrder@1100525018(VAR SalesCrMemoHead@1100525000 : Record 114;SalesHeader@1100525001 : Record 36);
    VAR
      SalesLine@1100525002 : Record 37;
      ReturnReceiptHead@1100525003 : Record 6660;
    BEGIN
      //**4PS C016332
      IF SalesCrMemoHead."Return Order No." <> '' THEN
        EXIT;
      IF SalesHeader."Document Type" <> SalesHeader."Document Type"::"Credit Memo" THEN
        EXIT;

      SalesLine.SETRANGE("Document Type", SalesHeader."Document Type");
      SalesLine.SETRANGE("Document No.", SalesHeader."No.");
      SalesLine.SETFILTER("Return Receipt No.", '<>%1', '');
      IF NOT SalesLine.FINDFIRST THEN
        EXIT;

      IF NOT ReturnReceiptHead.GET(SalesLine."Return Receipt No.") THEN
        EXIT;

      IF ReturnReceiptHead."Return Order No." <> '' THEN BEGIN
        SalesCrMemoHead."Return Order No." := ReturnReceiptHead."Return Order No.";
        SalesCrMemoHead."Return Order No. Series" := ReturnReceiptHead."Return Order No. Series";
      END;
    END;

    LOCAL PROCEDURE GetServiceControlPeriod@1100528600(LocServiceJournalLine@1100528600 : Record 11012820;LocSalesLine@1100529605 : Record 37;VAR ServiceContract@1100529601 : Record 11012812;VAR ServiceContractCtrlPeriod@1100529602 : Record 11071746;VAR InvoiceFromDate@1100529604 : Date;VAR InvoiceUntilDate@1100529603 : Date) : Boolean;
    VAR
      ContractInstallment@1100529600 : Record 11071707;
      ContractObject@1100529609 : Record 11071702;
      NegativeInvoiceInterval@1100529608 : DateFormula;
    BEGIN
      //**4PS
      IF LocServiceJournalLine."Service Contract No." = '' THEN
        EXIT(FALSE);
      IF NOT ServiceContract.GET(LocServiceJournalLine."Service Contract No.") THEN
        EXIT(FALSE);
      IF (LocServiceJournalLine."Installment Line No." = 0) AND (LocSalesLine."Object No." = '') THEN
        EXIT(FALSE);
      IF LocServiceJournalLine."Installment Line No." <> 0 THEN
        IF NOT ContractInstallment.GET(LocServiceJournalLine."Service Contract No.", LocServiceJournalLine."Installment Line No.") THEN
          EXIT(FALSE);
      IF LocSalesLine."Object No." <> '' THEN
        IF NOT ContractObject.GET(LocServiceJournalLine."Service Contract No.", LocSalesLine."Object No.") THEN
          EXIT(FALSE);

      IF (LocSalesLine."Invoice From" <> 0D) AND (LocSalesLine."Invoiced Until" <> 0D) THEN BEGIN
        InvoiceFromDate := LocSalesLine."Invoice From";
        InvoiceUntilDate  := LocSalesLine."Invoiced Until";
      END ELSE
        IF LocServiceJournalLine."Installment Line No." <> 0 THEN BEGIN
          IF FORMAT(ContractInstallment."Invoice Interval") = '' THEN
            EXIT(FALSE);

          CASE ContractInstallment."Invoice Period" OF
            ContractInstallment."Invoice Period"::Forehand:
              BEGIN
                InvoiceFromDate := LocServiceJournalLine."Service Control Period Date";
                InvoiceUntilDate := CALCDATE(ContractInstallment."Invoice Interval", InvoiceFromDate) - 1;
              END;
            ContractInstallment."Invoice Period"::Afterwards:
              BEGIN
                InvoiceUntilDate := LocServiceJournalLine."Service Control Period Date";
                ContractObject.NegateDateFormula(ContractInstallment."Invoice Interval", NegativeInvoiceInterval);
                InvoiceFromDate := CALCDATE(NegativeInvoiceInterval, InvoiceUntilDate) + 1;
              END;
          END;
        END;

      ServiceContractCtrlPeriod.UpdateControlPeriodsUntil(LocServiceJournalLine."Service Contract No.", InvoiceUntilDate, FALSE);

      ServiceContractCtrlPeriod.RESET;
      ServiceContractCtrlPeriod.SETRANGE("Service Contract No.", LocServiceJournalLine."Service Contract No.");
      ServiceContractCtrlPeriod.SETFILTER("Starting Date", '<=%1', InvoiceUntilDate);
      ServiceContractCtrlPeriod.SETFILTER("Ending Date", '>=%1', InvoiceFromDate);

      EXIT(ServiceContractCtrlPeriod.FINDSET);
    END;

    LOCAL PROCEDURE FillRetentionPostingBuffer@10009003(SalesHeader@1100525000 : Record 36;SalesLine@1000 : Record 37;SalesLineACY@1001 : Record 37;RetentionNo@1100528500 : Integer);
    BEGIN
      //**4PS
      WITH SalesLine DO BEGIN
        CLEAR(TempRetentionPostingBuffer[1]);
        TempRetentionPostingBuffer[1].Type := RetentionNo; //Type is used for separating retentions
        TempRetentionPostingBuffer[1]."Global Dimension 1 Code" := "Shortcut Dimension 1 Code";
        TempRetentionPostingBuffer[1]."Global Dimension 2 Code" := "Shortcut Dimension 2 Code";
        TempRetentionPostingBuffer[1]."Dimension Set ID" := "Dimension Set ID";
        TempRetentionPostingBuffer[1]."Cost Component" := "Cost Component";
        IF SalesHeader."Currency Code" = '' THEN
          TempRetentionPostingBuffer[1]."Retention Amount" := SalesLine.RetentionAmount(RetentionNo)
        ELSE BEGIN
          TempRetentionPostingBuffer[1]."Retention Amount" := SalesLine.RetentionAmountLCY(RetentionNo);
          TempRetentionPostingBuffer[1]."Retention Amount (ACY)" := SalesLine.RetentionAmount(RetentionNo);  // foreign currency
        END;
        IF "Document Type" <> "Document Type"::Invoice THEN BEGIN
          TempRetentionPostingBuffer[1]."Retention Amount" := - TempRetentionPostingBuffer[1]."Retention Amount";
          TempRetentionPostingBuffer[1]."Retention Amount (ACY)" := - TempRetentionPostingBuffer[1]."Retention Amount (ACY)";
        END;
        UpdRetentionPostingBuffer;
      END;
    END;

    LOCAL PROCEDURE UpdRetentionPostingBuffer@10009001();
    BEGIN
      //**4PS
      TempRetentionPostingBuffer[2] := TempRetentionPostingBuffer[1];
      IF TempRetentionPostingBuffer[2].FIND THEN BEGIN
        TempRetentionPostingBuffer[2]."Retention Amount" :=
          TempRetentionPostingBuffer[2]."Retention Amount" + TempRetentionPostingBuffer[1]."Retention Amount";
        TempRetentionPostingBuffer[2]."Retention Amount (ACY)" :=
          TempRetentionPostingBuffer[2]."Retention Amount (ACY)" + TempRetentionPostingBuffer[1]."Retention Amount (ACY)";
        TempRetentionPostingBuffer[2].MODIFY;
      END ELSE
        TempRetentionPostingBuffer[1].INSERT;
    END;

    LOCAL PROCEDURE PostRetentionPostingBuffer@10009000(SalesHeader@1100525003 : Record 36);
    VAR
      TempRetentionDimBuf@1000000001 : TEMPORARY Record 360;
      PaymentTerms@1210190001 : Record 3;
      CustPostingGr@1100525000 : Record 92;
      GLAcc@1100525001 : Record 15;
      GenJnlLine@1100525002 : Record 81;
      CurrencyExchangeRate@1100529500 : Record 330;
    BEGIN
      //**4PS
      IF TempRetentionPostingBuffer[1].FINDSET THEN
        REPEAT
          CustPostingGr.GET(SalesHeader."Customer Posting Group");
          CustPostingGr.TESTFIELD("Retention Suspense Acc.");

          GenJnlLine.INIT;
          GenJnlLine."Account Type" := GenJnlLine."Account Type"::"G/L Account";
          GenJnlLine."Account No." := CustPostingGr."Retention Suspense Acc.";

          IF SalesHeader."Applies-to Doc. Type" IN
            [SalesHeader."Applies-to Doc. Type"::Invoice,SalesHeader."Applies-to Doc. Type"::"Credit Memo"]
          THEN BEGIN
            //"Applies-to Doc. No." is not allowed to use due to TESTFIELD in CU 11
            GenJnlLine."Applies-to Doc. Type" := SalesHeader."Applies-to Doc. Type";
            GenJnlLine."Applies-to Ext. Doc. No." := SalesHeader."Applies-to Doc. No.";
          END;

          GenJnlLine."Gen. Posting Type" := 0; // None
          GenJnlLine."Gen. Bus. Posting Group" := '';
          GenJnlLine."Gen. Prod. Posting Group" := '';
          GenJnlLine."VAT Bus. Posting Group" := '';
          GenJnlLine."VAT Prod. Posting Group" := '';
          GenJnlLine."VAT Calculation Type" := GenJnlLine."VAT Calculation Type"::"Normal VAT";
          GenJnlLine."VAT Amount" := 0;

          GLAcc.GET(GenJnlLine."Account No.");

          GenJnlLine."Currency Code" := SalesHeader."Currency Code";
          GenJnlLine.Amount := TempRetentionPostingBuffer[1]."Retention Amount";
          GenJnlLine."Source Currency Code" := SalesHeader."Currency Code";
          GenJnlLine."Source Currency Amount" := TempRetentionPostingBuffer[1]."Retention Amount (ACY)";
          GenJnlLine."Amount (LCY)" := TempRetentionPostingBuffer[1]."Retention Amount";

          GenJnlLine."Skip WIP Check" := TRUE;

          IF SalesHeader."Currency Code" = '' THEN
            GenJnlLine."Currency Factor" := 1
          ELSE BEGIN
            GenJnlLine."Currency Factor" := SalesHeader."Currency Factor";
            IF GenJnlLine."Currency Factor" = CurrencyExchangeRate.ExchangeRate(1, SalesHeader."Job No.", SalesHeader."Posting Date", SalesHeader."Currency Code", TRUE) THEN
              IF CurrencyExchangeRate.HasFoundJobCurrExchRate THEN
                GenJnlLine."Exchange Rate From" := GenJnlLine."Exchange Rate From"::"Project Exchange Rate";
          END;

          IF ((GenJnlLine.Amount > 0) AND (NOT SalesHeader.Correction)) OR
             ((GenJnlLine.Amount < 0) AND SalesHeader.Correction)
          THEN BEGIN
            GenJnlLine."Debit Amount" := GenJnlLine.Amount;
            GenJnlLine."Credit Amount" := 0
          END ELSE BEGIN
            GenJnlLine."Debit Amount" := 0;
            GenJnlLine."Credit Amount" := -GenJnlLine.Amount;
          END;

          GenJnlLine."Posting Date" := SalesHeader."Posting Date";
          GenJnlLine."Document Date" := SalesHeader."Document Date";
          GenJnlLine."Due Date" := SalesHeader."Document Date";
          IF SalesHeader."Document Type" = SalesHeader."Document Type"::Invoice THEN BEGIN
            IF (TempRetentionPostingBuffer[1].Type <> 0) AND (SalesHeader."Document Date" <> 0D) THEN BEGIN
              IF (TempRetentionPostingBuffer[1].Type = 1) AND (SalesHeader."Retention Payment Terms Code" <> '') THEN BEGIN
                PaymentTerms.GET(SalesHeader."Retention Payment Terms Code");
                GenJnlLine."Due Date" := CALCDATE(PaymentTerms."Due Date Calculation",SalesHeader."Document Date");
              END;
              IF (TempRetentionPostingBuffer[1].Type = 2) AND (SalesHeader."Retention Payment Terms Code 2" <> '') THEN BEGIN
                PaymentTerms.GET(SalesHeader."Retention Payment Terms Code 2");
                GenJnlLine."Due Date" := CALCDATE(PaymentTerms."Due Date Calculation",SalesHeader."Document Date");
              END;
            END;
          END;

          GenJnlLine.Description := SalesHeader."Posting Description";
          GenJnlLine."Reason Code" := SalesHeader."Reason Code";
          GenJnlLine."Document Type" := GenJnlLineDocType;
          GenJnlLine."Document No." := GenJnlLineDocNo;
          GenJnlLine."External Document No." := GenJnlLineExtDocNo;
          GenJnlLine."System-Created Entry" := TRUE;
          GenJnlLine.Correction := SalesHeader.Correction;
          GenJnlLine.Quantity := 1;
          GenJnlLine."Source Code" := SrcCode;
          GenJnlLine."Sell-to/Buy-from No." := SalesHeader."Sell-to Customer No.";
          GenJnlLine."Source Type" := GenJnlLine."Source Type"::Customer;
          GenJnlLine."Source No." := SalesHeader."Bill-to Customer No.";
          GenJnlLine."Posting No. Series" := SalesHeader."Posting No. Series";

          IF TempRetentionPostingBuffer[1].Type <> 0 THEN BEGIN // RFC 337
            GenJnlLine."Job No." := SalesHeader."Job No.";
          END ELSE
            GenJnlLine."Closed Project No." := SalesHeader."Job No."; // RFC 337

          GenJnlLine."Shortcut Dimension 1 Code" := TempRetentionPostingBuffer[1]."Global Dimension 1 Code";
          GenJnlLine."Shortcut Dimension 2 Code" := TempRetentionPostingBuffer[1]."Global Dimension 2 Code";
          GenJnlLine."Dimension Set ID" := TempRetentionPostingBuffer[1]."Dimension Set ID";
          GenJnlLine."Cost Component" := TempRetentionPostingBuffer[1]."Cost Component";

          GenJnlLine."Retention Entry Type" := GenJnlLine."Retention Entry Type"::Sales;

          IF SalesHeader."Document Type" IN [SalesHeader."Document Type"::Order,SalesHeader."Document Type"::Invoice] THEN
            GenJnlLine."Retention Entry Document Type" := GenJnlLine."Retention Entry Document Type"::Invoice
          ELSE
            GenJnlLine."Retention Entry Document Type" := GenJnlLine."Retention Entry Document Type"::"Credit Memo";

          TempRetentionDimBuf.DELETEALL;
          GenJnlPostLine.RunWithCheck(GenJnlLine);

        UNTIL TempRetentionPostingBuffer[1].NEXT = 0;
    END;

    LOCAL PROCEDURE CheckRetention@1100525002(SalesHeader@1100525000 : Record 36);
    VAR
      SalesLine@1100525001 : Record 37;
      Cust@1100525002 : Record 18;
      CustPostingGr@1100525003 : Record 92;
    BEGIN
      //**4PS
      WITH SalesHeader DO BEGIN
        IF ("Bill-to Customer No." = '') THEN
          EXIT; //C034276.n
        IF ("Retention %" <> 0) OR ("Retention % 2" <> 0) THEN BEGIN
          SalesHeader.TESTFIELD("Bill-to Customer No.");
          Cust.GET(SalesHeader."Bill-to Customer No.");
          TESTFIELD("Prices Including VAT", FALSE);
        END;

        CustPostingGr.GET("Customer Posting Group");

        SalesLine.RESET;
        SalesLine.SETRANGE("Document Type","Document Type");
        SalesLine.SETRANGE("Document No.","No.");
        IF SalesLine.FIND('-') THEN
          REPEAT
            IF SalesLine.Type <> SalesLine.Type::" " THEN
              IF SalesLine.ReleaseRetention THEN BEGIN
                SalesLine.TESTFIELD("Applies-to Retention ID");
                CustPostingGr.TESTFIELD("Retention Suspense Acc.");
                SalesLine.TESTFIELD(Type, SalesLine.Type::"G/L Account");
                SalesLine.TESTFIELD("No.", CustPostingGr."Retention Suspense Acc.");
                SalesLine.TESTFIELD("Job No.");
                IF SalesLine."VAT Calculation Type" = SalesLine."VAT Calculation Type"::"Full VAT" THEN
                  SalesLine.FIELDERROR("VAT Calculation Type");
              END ELSE BEGIN
                IF ("Retention %" <> 0) OR ("Retention % 2" <> 0) THEN
                  IF (SalesLine."VAT Calculation Type" <> SalesLine."VAT Calculation Type"::"Full VAT") THEN
                    SalesLine.TESTFIELD("Job No.", "Job No.");
                IF (SalesLine."No." = CustPostingGr."Retention Suspense Acc.") AND
                    (CustPostingGr."Retention Suspense Acc." <> '')
                THEN
                  SalesLine.FIELDERROR("No.",
                    STRSUBSTNO(Text11012018,SalesLine.FIELDCAPTION("No."),CustPostingGr."Retention Suspense Acc."));
              END;
          UNTIL SalesLine.NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE CheckLogistics@1100525019(SalesHeader@1100525000 : Record 36);
    VAR
      SalesLine@1100525001 : Record 37;
    BEGIN
      //**4PS
      SalesLine.SETRANGE("Document Type",SalesHeader."Document Type");
      SalesLine.SETRANGE("Document No.",SalesHeader."No.");
      SalesLine.SETFILTER("Item No.",'<>%1', '');
      SalesLine.SETFILTER(Quantity,'<>0');
      IF SalesLine.FINDSET THEN
        REPEAT
          Item.GET(SalesLine."Item No.");
          IF Item."Logistics on Component Level" THEN
            ERROR(Text11012004,SalesLine."Item No.");
        UNTIL SalesLine.NEXT = 0;
    END;

    LOCAL PROCEDURE PostRequisitionPostingBuffer@1100525017(SalesHeader@1100525000 : Record 36);
    VAR
      GenJnlLine@1100525001 : Record 81;
    BEGIN
      //**4PS
      IF TempRequisitionPostingBuffer[1].FIND('-') THEN
        REPEAT
          GenJnlLine.INIT;
          GenJnlLine."Source Code" := SrcCode;
          GenJnlLine."Reason Code":= SalesHeader."Reason Code";
          GenJnlLine."Account Type" := GenJnlLine."Account Type"::"G/L Account";
          GenJnlLine."Account No." := TempRequisitionPostingBuffer[1]."G/L Account";
          GenJnlLine."Posting Date" := SalesHeader."Posting Date";
          GenJnlLine."Document Type" := GenJnlLineDocType;
          GenJnlLine."Document No." := GenJnlLineDocNo;
          GenJnlLine."System-Created Entry" := TRUE;
          GenJnlLine."Document Date" := SalesHeader."Document Date";
          GenJnlLine.Description := TempRequisitionPostingBuffer[1].Description;
          GenJnlLine."Description 2" := TempRequisitionPostingBuffer[1]."Description 2";  //**4PS01.n
          GenJnlLine."Bal. Account No." := TempRequisitionPostingBuffer[1]."Bal. Account No.";
          GenJnlLine.Amount := TempRequisitionPostingBuffer[1].Amount;
          GenJnlLine.VALIDATE(Amount);
          GenJnlLine."Shortcut Dimension 1 Code" := TempRequisitionPostingBuffer[1]."Global Dimension 1 Code";
          GenJnlLine."Shortcut Dimension 2 Code" := TempRequisitionPostingBuffer[1]."Global Dimension 2 Code";
          GenJnlLine."Dimension Set ID" := TempRequisitionPostingBuffer[1]."Dimension Set ID";
          GenJnlLine."Job No." := TempRequisitionPostingBuffer[1]."Job No.";
          GenJnlLine."Service Order No." := TempRequisitionPostingBuffer[1]."Service Order No.";
          GenJnlLine.GetServiceCategory;
          GenJnlLine."Service Contract No." := TempRequisitionPostingBuffer[1]."Service Contract No.";
          GenJnlLine."Origin Type" := TempRequisitionPostingBuffer[1]."Origin Type";
          RunGenJnlPostLine(GenJnlLine);
        UNTIL TempRequisitionPostingBuffer[1].NEXT = 0;
      TempRequisitionPostingBuffer[1].DELETEALL;
    END;

    LOCAL PROCEDURE CreateServiceLedgersByPBInstallmentOverviewLines@1100528606(SalesHeader@1100528602 : Record 36;SalesLine@1100528601 : Record 37;VAR ServJnlLine@1100528600 : Record 11012820) : Boolean;
    VAR
      Currency@1100528611 : Record 4;
      PBInstallCollectOverview@1100528604 : Record 11072319;
      PBInstallmentOverview@1100528605 : Record 11072317;
      PBInstallmentOverviewLine@1100528606 : Record 11072318;
      GenericTempTable@1100528607 : TEMPORARY Record 11020579;
      SUPProductionLine@1100528608 : Record 11071774;
      ServiceOrderCostPlusEntry@1100528609 : Record 11012825;
      JobJnlLine@1100528612 : Record 11072008;
      ServiceOrder@1100528613 : Record 11012823;
      PriceBookSurchargeSetLine@1100530700 : Record 11072316;
      TotalAmount@1100528610 : Decimal;
    BEGIN
      //**4PS
      //Sales.Line.Amount and Service Unit Price are already LCY
      Currency.InitRoundingPrecision;
      IF SalesLine."PB Install. Collect. Over. No." = '' THEN
        EXIT;
      IF NOT PBInstallCollectOverview.GET(SalesLine."PB Install. Collect. Over. No.") THEN
        EXIT;
      PBInstallmentOverview.SETRANGE("Install. Collect. Overview No.", PBInstallCollectOverview."No.");
      IF PBInstallmentOverview.FINDSET THEN BEGIN
        GenericTempTable.INSERT;
        REPEAT
          PBInstallmentOverviewLine.SETRANGE("Installment Overview No.", PBInstallmentOverview."No.");
          PBInstallmentOverviewLine.SETFILTER("Line Type", '%1|%2|%3',
            PBInstallmentOverviewLine."Line Type"::Initial,
            PBInstallmentOverviewLine."Line Type"::Uncoded,
            PBInstallmentOverviewLine."Line Type"::"Extra Declarations");
          IF PBInstallmentOverviewLine.FINDSET THEN
            REPEAT
              CASE PBInstallmentOverviewLine."Line Type" OF
                PBInstallmentOverviewLine."Line Type"::Initial,
                PBInstallmentOverviewLine."Line Type"::Uncoded:
                  BEGIN
                    SUPProductionLine.SETRANGE("Installment Overview No.", PBInstallmentOverviewLine."Installment Overview No.");
                    SUPProductionLine.SETRANGE("Installment Overview Line No.", PBInstallmentOverviewLine."Line No.");
                    IF SUPProductionLine.FINDSET THEN
                      REPEAT
                        IF NOT GenericTempTable.GET(SUPProductionLine."Service Order No.", '', '', '', '', '') THEN BEGIN
                          GenericTempTable.INIT;
                          GenericTempTable."Key Code1" := SUPProductionLine."Service Order No.";
                          GenericTempTable."Key Code2" := '';
                          GenericTempTable.INSERT;
                        END;
                        GenericTempTable.Dec1 -= SUPProductionLine.Production * PBInstallmentOverviewLine."Unit Price";
                        GenericTempTable.MODIFY;
                        IF ServiceOrder.GET(SUPProductionLine."Service Order No.") THEN
                          IF ServiceOrder."Service Category" <> '' THEN BEGIN
                            IF NOT GenericTempTable.GET('', ServiceOrder."Service Category", '', '', '', '') THEN BEGIN
                              GenericTempTable.INIT;
                              GenericTempTable."Key Code1" := '';
                              GenericTempTable."Key Code2" := ServiceOrder."Service Category";
                              GenericTempTable.INSERT;
                            END;
                            PriceBookSurchargeSetLine.SETRANGE("Price Book Code", PBInstallmentOverview."Price Book Code");
                            PriceBookSurchargeSetLine.SETRANGE("Price Book Index Date", PBInstallmentOverview."Price Book Index Date");
                            PriceBookSurchargeSetLine.SETRANGE("Surcharge Set Code", PBInstallmentOverviewLine."Surcharge Set Code");
                            IF PriceBookSurchargeSetLine.FINDSET THEN BEGIN
                              REPEAT
                                GenericTempTable.Dec1 -= SUPProductionLine.Production * PBInstallmentOverviewLine."Unit Price" * PriceBookSurchargeSetLine."Surcharge Percentage" / 100;
                              UNTIL PriceBookSurchargeSetLine.NEXT = 0;
                              GenericTempTable.Dec1 := ROUND(GenericTempTable.Dec1, Currency."Amount Rounding Precision");
                              GenericTempTable.MODIFY;
                            END;
                          END;
                      UNTIL SUPProductionLine.NEXT = 0;
                  END;
                PBInstallmentOverviewLine."Line Type"::"Extra Declarations":
                  BEGIN
                    ServiceOrderCostPlusEntry.SETRANGE("Installment Overview No.", PBInstallmentOverviewLine."Installment Overview No.");
                    ServiceOrderCostPlusEntry.SETRANGE("Installment Overview Line No.", PBInstallmentOverviewLine."Line No.");
                    IF ServiceOrderCostPlusEntry.FINDSET THEN
                      REPEAT
                        IF NOT GenericTempTable.GET(ServiceOrderCostPlusEntry."Service Order No.", '', '', '', '', '') THEN BEGIN
                          GenericTempTable.INIT;
                          GenericTempTable."Key Code1" := ServiceOrderCostPlusEntry."Service Order No.";
                          GenericTempTable."Key Code2" := '';
                          GenericTempTable.INSERT;
                        END;
                        GenericTempTable.Dec1 -= ServiceOrderCostPlusEntry.Quantity * PBInstallmentOverviewLine."Unit Price";
                        GenericTempTable.MODIFY;
                      UNTIL ServiceOrderCostPlusEntry.NEXT = 0;
                  END;
              END;
            UNTIL PBInstallmentOverviewLine.NEXT = 0;
        UNTIL PBInstallmentOverview.NEXT = 0;
      END;
      GenericTempTable.CALCSUMS(Dec1);
      TotalAmount := GenericTempTable.Dec1;
      IF GenericTempTable.GET('', '', '', '', '', '') THEN BEGIN
        //SalesLine.Amount is a negative value. Used for Administrative and Surcharge line types.
        GenericTempTable.Dec1 := SalesLine.Amount - TotalAmount;
        GenericTempTable.MODIFY;
      END;
      GenericTempTable.SETFILTER(Dec1, '<>%1', 0);
      IF GenericTempTable.FINDSET THEN
        REPEAT
          ServJnlLine.INIT;
          ServJnlLine."Service Contract No." := SalesLine."Service Contract No.";
          ServJnlLine."Customer No." := SalesLine."Bill-to Customer No.";
          ServJnlLine.VALIDATE("Service Order No.", GenericTempTable."Key Code1");
          IF ServJnlLine."Service Order No." <> '' THEN
            ServJnlLine."Service Location No." := SalesLine."Service Location No.";
          IF SalesLine."Document Type" = SalesLine."Document Type"::"Credit Memo" THEN
            ServJnlLine."Document Type" := ServJnlLine."Document Type"::"Sales Credit Memo"
          ELSE
            ServJnlLine."Document Type" := ServJnlLine."Document Type"::"Sales Invoice";
          ServJnlLine."Document No." := GenJnlLineDocNo;
          ServJnlLine."G/L Account" := SalesLine."No.";
          ServJnlLine."Posting Date" := SalesHeader."Posting Date";
          ServJnlLine."Shortcut Dimension 1 Code" := SalesLine."Shortcut Dimension 1 Code";
          ServJnlLine."Shortcut Dimension 2 Code" := SalesLine."Shortcut Dimension 2 Code";
          ServJnlLine."Dimension Set ID" := SalesLine."Dimension Set ID";
          ServJnlLine."Cost Component" := SalesLine."Cost Component";
          ServJnlLine."Currency Code" := SalesLine."Currency Code";
          ServJnlLine.Description := SalesLine.Description;
          ServJnlLine."Description 2" := SalesLine."Description 2";
          ServJnlLine."Unit of Measure Code" := SalesLine."Unit of Measure Code";
          ServJnlLine."Entry Type" := ServJnlLine."Entry Type"::Sale;
          ServJnlLine.Quantity := -SalesLine."Qty. to Invoice";
          ServJnlLine.VALIDATE("Total Revenue (LCY)", ROUND(-GenericTempTable.Dec1, Currency."Amount Rounding Precision"));
          IF ServJnlLine."Sales Price (LCY)" = 0 THEN
            IF ServJnlLine.Quantity = 0 THEN
              ServJnlLine.VALIDATE("Sales Price (LCY)", ServJnlLine."Total Revenue")
            ELSE
              ServJnlLine.VALIDATE("Sales Price (LCY)", ROUND(ServJnlLine."Total Revenue" / ServJnlLine.Quantity, Currency."Unit-Amount Rounding Precision"));
          ServJnlLine."Reason Code" := SalesHeader."Reason Code";
          ServJnlLine."Source Code" := SrcCode;
          ServJnlLine."Service Invoice" := SalesLine."Service Invoice";
          ServJnlLine."Additional Cost" := SalesLine."Additional Cost (Service)";
          ServJnlLine."Original Cost Type" := ServJnlLine."Original Cost Type"::" ";
          IF SalesLine."Cost Object Cost Plus Line" <> '' THEN
            ServJnlLine."Original Cost Type" := SalesLine."Cost Type Cost Plus Line" + 1;
          ServJnlLine."Cost Entry No. Service Ledger":= SalesLine."Cost Entry No. Service Ledger";
          ServJnlLine."Country/Region Code" := SalesHeader."VAT Country/Region Code";
          ServJnlLine."Country/Region of Origin/Dest." := SalesHeader."Country of Origin";
          ServJnlLine.Area := SalesLine.Area;
          ServJnlLine."Service Control Period Date" := SalesLine."Service Control Period Date";
          IF ServJnlLine."Service Control Period Date" = 0D THEN
            ServJnlLine."Service Control Period Date" := ServJnlLine."Posting Date";
          ServJnlLine."PB Install. Collect. Over. No." := SalesLine."PB Install. Collect. Over. No.";
          IF GenericTempTable."Key Code2" <> '' THEN
            ServJnlLine."Service Category" := GenericTempTable."Key Code2";
          ServJnlPostLine.RunWithCheck(ServJnlLine);
          PostSurcharge(SalesHeader, SalesLine, JobJnlLine, ServJnlLine, 1);
          PostComplRevenueFixedPriceServ(SalesHeader, SalesLine, ServJnlLine);
        UNTIL GenericTempTable.NEXT = 0;
      ServLedgEntryNo := ServJnlPostLine.GetServLedgEntryNo;
      EXIT(TRUE);
    END;

    LOCAL PROCEDURE AddPDFDocumentQueue@1100529612(SalesHeader@1100529600 : Record 36);
    VAR
      PDFDocumentQueue@1100529602 : Record 11229376;
    BEGIN
      //**4PS
      IF PreviewMode THEN
        EXIT;
      IF NOT SalesSetup."Create PDF Invoice on Posting" THEN
        EXIT;
      IF SalesInvHeader."No." = '' THEN
        EXIT;

      CASE SalesHeader."Document Type" OF
        SalesHeader."Document Type"::Invoice,
        SalesHeader."Document Type"::Order:
          BEGIN
            PDFDocumentQueue.INIT;
            PDFDocumentQueue."Document Type" := PDFDocumentQueue."Document Type"::"Posted Sales Invoice";
            PDFDocumentQueue."Document No." := SalesInvHeader."No.";
            PDFDocumentQueue.INSERT;
          END;
        SalesHeader."Document Type"::"Credit Memo":
          BEGIN
            PDFDocumentQueue.INIT;
            PDFDocumentQueue."Document Type" := PDFDocumentQueue."Document Type"::"Posted Sales Credit Memo";
            PDFDocumentQueue."Document No." := SalesCrMemoHeader."No.";
            PDFDocumentQueue.INSERT;
          END;
      END;
    END;

    LOCAL PROCEDURE GetPlantCostCompPostingSetup@1100529600(PlantType@1100529602 : Record 11012551;PlantNumber@1100529601 : Record 11012552;VAR PlantCostCompPostingSetup@1100529600 : Record 11012570;ExternalPlant@1100529603 : Boolean);
    BEGIN
      //**4PS
      IF ExternalPlant THEN BEGIN
        IF PlantNumber."Posting Group External" <> '' THEN
          IF PlantCostCompPostingSetup.GET(PlantNumber."Posting Group External", '', PlantSetup."Cost Component Internal Charge") THEN
            EXIT;
        PlantCostCompPostingSetup.GET(PlantType."Posting Group External", '', PlantSetup."Cost Component Internal Charge");
      END ELSE BEGIN
        IF PlantNumber."Posting Group Internal" <> '' THEN
          IF PlantCostCompPostingSetup.GET(PlantNumber."Posting Group Internal", '', PlantSetup."Cost Component Internal Charge") THEN
            EXIT;
        PlantCostCompPostingSetup.GET(PlantType."Posting Group Internal", '', PlantSetup."Cost Component Internal Charge");
      END;
    END;

    LOCAL PROCEDURE CopyExtDocRefPlantOrderToInvoice@1100529906(SalesHeader@1100529900 : Record 36;SalesLine@1100529901 : Record 37);
    VAR
      DocumentLinkManagement@1100529905 : Codeunit 11012401;
      RecRefFrom@1100529904 : RecordRef;
      RecRefTo@1100529903 : RecordRef;
      PlantOrder@1100529902 : Record 11012556;
    BEGIN
      IF (SalesLine."Arrival Order Type" = SalesLine."Arrival Order Type"::"Plant Order") AND
          (SalesLine."Arrival Order" <> '') THEN BEGIN
        PlantOrder.GET(SalesLine."Arrival Order");
        RecRefFrom.GETTABLE(PlantOrder);
        RecRefTo.GETTABLE(SalesHeader);
        DocumentLinkManagement.CopyDocLinks(RecRefFrom,RecRefTo);
      END;
    END;

    LOCAL PROCEDURE PostICServiceProject@1100529601(SalesHeader@1100529603 : Record 36;VAR SalesLine@1100529602 : Record 37);
    VAR
      IntercompanyRelation@1100529601 : Record 11012057;
      IntercompanyEntry@1100529600 : Record 11012058;
      LocSalesLine@1100529604 : Record 37;
    BEGIN
      //**4PS
      IF (NOT SalesHeader."Service Invoice") OR (SalesHeader."Company Name" = '') OR (SalesHeader."Company Name" = COMPANYNAME) THEN
        EXIT;
      IF (SalesLine."Job No." = '') OR (SalesLine."Qty. to Invoice" = 0) THEN
        EXIT;

      IF NOT IntercompanyRelation.GET(COMPANYNAME, SalesHeader."Company Name") THEN
        EXIT;
      LocSalesLine := SalesLine;
      LocSalesLine."Service Order No." := '';
      PostICEntry(SalesHeader, LocSalesLine, IntercompanyRelation, IntercompanyEntry);
      SalesLine."Job No." := '';
    END;

    LOCAL PROCEDURE PostLoan@1100528501(SalesHeader@1100528501 : Record 36;SalesLine@1100528500 : Record 37;InvoicePostBuffer@1100528504 : Record 49);
    VAR
      LoanLedgerEntry@1100528503 : Record 11229444;
    BEGIN
      //**4PS
      IF (SalesLine."Loan Code" = '') THEN
        EXIT;

      WITH LoanLedgerEntry DO BEGIN
        INIT;
        "Document No." := GenJnlLineDocNo;
        Type := Type::Sale;
        "Posting Date" := SalesHeader."Posting Date";
        "Document Date" := SalesHeader."Document Date";
        "Account No." := SalesLine."No.";
        "Loan Code" := SalesLine."Loan Code";
        "Loan Type" := SalesLine."Loan Type";
        Description := SalesLine.Description;
        Quantity := SalesLine."Qty. to Invoice";
        "Amount (LCY)" := InvoicePostBuffer.Amount;
        Amount := InvoicePostBuffer."Amount (ACY)";
        "Currency Code" := SalesLine."Currency Code";
        "Global Dimension 1 Code" := SalesLine."Shortcut Dimension 1 Code";
        "Global Dimension 2 Code" := SalesLine."Shortcut Dimension 2 Code";
        "Dimension Set ID" := SalesLine."Dimension Set ID";

        LoanJnlPostLine.RUN(LoanLedgerEntry);
      END;
    END;

    LOCAL PROCEDURE CheckIfDocumentTypeOrCategoryIsToBeLinkedToSalesInvoice@1100529503(DocumentProperties@1100529501 : Record 11012746;CustomerCode@1100529505 : Code[20]) : Boolean;
    VAR
      DocumentType@1100529502 : Record 11012405;
      DocumentCategory@1100529503 : Record 11012147;
      DocsToBeLinkedtoSlsInv@1100529506 : Record 11229792;
    BEGIN
      //**4PS
      IF DocumentProperties."Document Type" <> '' THEN
        IF DocumentType.GET(DocumentProperties."Document Type") THEN
          IF DocumentType."Attach to Document Relation" THEN BEGIN
            DocsToBeLinkedtoSlsInv.RESET;
            DocsToBeLinkedtoSlsInv.SETRANGE("Customer No.", CustomerCode);
            DocsToBeLinkedtoSlsInv.SETRANGE("Source Type", DocsToBeLinkedtoSlsInv."Source Type"::"Sales Order");
            DocsToBeLinkedtoSlsInv.SETRANGE("Document Type", DocumentProperties."Document Type");
            IF DocsToBeLinkedtoSlsInv.COUNT > 0 THEN
              EXIT(TRUE);
          END;

      IF DocumentProperties."Document Category" <> '' THEN
        IF DocumentCategory.GET(DocumentProperties."Document Category") THEN
          IF DocumentCategory."Attach to Document Relation" THEN BEGIN
            DocsToBeLinkedtoSlsInv.RESET;
            DocsToBeLinkedtoSlsInv.SETRANGE("Customer No.", CustomerCode);
            DocsToBeLinkedtoSlsInv.SETRANGE("Source Type", DocsToBeLinkedtoSlsInv."Source Type"::"Sales Order");
            DocsToBeLinkedtoSlsInv.SETRANGE("Document Category", DocumentProperties."Document Category");
            IF DocsToBeLinkedtoSlsInv.COUNT > 0 THEN
              EXIT(TRUE);
          END;
    END;

    LOCAL PROCEDURE SelectAndCopyDocumentRelations@1100529522(SalesHeaderNo@1100529501 : Code[20];CustomerNo@1100529504 : Code[20];SalesHeaderInvFromOrderNo@1100529505 : Code[20]);
    VAR
      DocumentRelationSource@1100529500 : Record 11012407;
      DocumentProperties@1100529502 : Record 11012746;
      DocumentRelationTarget@1100529503 : Record 11012407;
    BEGIN
      //**4PS
      DocumentRelationSource.SETRANGE("No.", SalesHeaderNo);
      DocumentRelationSource.SETRANGE("Document Type", DocumentRelationSource."Document Type"::"Sales Order");
      IF DocumentRelationSource.FINDSET THEN
        REPEAT
          DocumentProperties.GET(DocumentRelationSource."Related Document No.");
          IF (DocumentProperties."Document Type" = '') AND (DocumentProperties."Document Category" = '') THEN
            EXIT;
          IF CheckIfDocumentTypeOrCategoryIsToBeLinkedToSalesInvoice(DocumentProperties, CustomerNo) THEN BEGIN
            DocumentRelationTarget.INIT;
            DocumentRelationTarget.TRANSFERFIELDS(DocumentRelationSource);
            DocumentRelationTarget."Document Type" := DocumentRelationSource."Document Type"::"Sales Invoice";
            DocumentRelationTarget."No." := SalesHeaderInvFromOrderNo;
            DocumentRelationTarget.INSERT(TRUE);
          END;
        UNTIL DocumentRelationSource.NEXT = 0;
    END;

    BEGIN
    {

      FIXME.MERGE TableData 11072005=rm, add TableData 2000000068=rimd;

      130716 *** 4PSSE.I012 *** added code rot ROT-handeling
      130923 *** 4PSSE.I012 *** added code rot ROT-handeling
      140117 ITERO.MH 4PSSE.I012 Changed ROT-handerling to be controlled from Dimension value field "ROT"
      140121 ITERO.MH 4PSSE.I012 Added more function to get Dimension value field "ROT"
      140206 ITERO.MH 4PSSE.I012 Changed calculion of ROT Amount to account for Quote per person.
      140226 ITERO.DJ ENH020 adition to ROT calculation
      140325 ITERO.DJ ENH020 change of ROT from project -> principal
      140410 ITERO.MH 4PSSEI012 Major Change of ROT Calculation - moved to CreateInvoiceFromProject Report.
      140416 ITERO.MH 4PSSEI012 Correction of calculation of TotalRot
      140813 ITERO.MH Added check of Personal No. on Posting of ROT invoice
      141008 ITERO.MH I012 added calculation of ROT on Credit Memos
      140926 ITERO.DL IME-204 Invoice rounding on sales invoice
      141001 ITERO.MH IME201 Added OCR No to be created to Customer Ledger Entry as External Document No.
      141015 ITERO.MH IME219 Added OCR No also on Credit MEmo (IME219)
      150310 ITERO.MH IME-256 In InvoiceRounding Description := GLAcc.Name
      160304 ITERO.SB Extension lines only mandatory then using electronic rot-file (RAD-175)
      170405 ITERO.DL RFC188 enhance ROT-handling and extend with RUT
      170630 ITERO.DL pure270175, no ROT-amount printed -> no ROT in ledger
      170823 ITERO.FH pure274768 Changed function call function PostCustomerEntry. So ProjectNo i filled in Cust.Ledger Entry
      170829 ITERO.DL pure275173 withheld amount and re-invoicing
      170915 ITERO.DL pure277047 Installment - 'installment amount' get wrong value after credit
    }
    END.
  }
}

